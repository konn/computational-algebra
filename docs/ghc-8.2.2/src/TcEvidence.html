<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcEvidence.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- (c) The University of Glasgow 2006</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE CPP, DeriveDataTypeable #-}</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcEvidence</span> <span class='hs-layout'>(</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-comment'>-- HsWrapper</span>
<a name="line-8"></a>  <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-9"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpTyApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpEvApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpEvVarApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpTyLams</span><span class='hs-layout'>,</span>
<a name="line-10"></a>  <span class='hs-varid'>mkWpLams</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpLet</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpCastN</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpCastR</span><span class='hs-layout'>,</span> <span class='hs-varid'>collectHsWrapBinders</span><span class='hs-layout'>,</span>
<a name="line-11"></a>  <span class='hs-varid'>mkWpFun</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpFuns</span><span class='hs-layout'>,</span> <span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIdHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprHsWrapper</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>  <span class='hs-comment'>-- Evidence bindings</span>
<a name="line-14"></a>  <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-15"></a>  <span class='hs-conid'>EvBindMap</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyEvBindMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendEvBinds</span><span class='hs-layout'>,</span>
<a name="line-16"></a>  <span class='hs-varid'>lookupEvBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>evBindMapBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldEvBindMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyEvBindMap</span><span class='hs-layout'>,</span>
<a name="line-17"></a>  <span class='hs-conid'>EvBind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGivenEvBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWantedEvBind</span><span class='hs-layout'>,</span>
<a name="line-18"></a>  <span class='hs-varid'>sccEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>evBindVar</span><span class='hs-layout'>,</span>
<a name="line-19"></a>  <span class='hs-conid'>EvTerm</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEvCast</span><span class='hs-layout'>,</span> <span class='hs-varid'>evVarsOfTerm</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEvScSelectors</span><span class='hs-layout'>,</span>
<a name="line-20"></a>  <span class='hs-conid'>EvLit</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>evTermCoercion</span><span class='hs-layout'>,</span>
<a name="line-21"></a>  <span class='hs-conid'>EvCallStack</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-22"></a>  <span class='hs-conid'>EvTypeable</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-23"></a>
<a name="line-24"></a>  <span class='hs-comment'>-- TcCoercion</span>
<a name="line-25"></a>  <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercionR</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercionP</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionHole</span><span class='hs-layout'>,</span>
<a name="line-26"></a>  <span class='hs-conid'>Role</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>LeftOrRight</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pickLR</span><span class='hs-layout'>,</span>
<a name="line-27"></a>  <span class='hs-varid'>mkTcReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcNomReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcRepReflCo</span><span class='hs-layout'>,</span>
<a name="line-28"></a>  <span class='hs-varid'>mkTcTyConAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcFunCo</span><span class='hs-layout'>,</span>
<a name="line-29"></a>  <span class='hs-varid'>mkTcAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcUnbranchedAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcForAllCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcForAllCos</span><span class='hs-layout'>,</span>
<a name="line-30"></a>  <span class='hs-varid'>mkTcSymCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcTransCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcNthCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcLRCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcSubCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeTcSubCo</span><span class='hs-layout'>,</span>
<a name="line-31"></a>  <span class='hs-varid'>tcDowngradeRole</span><span class='hs-layout'>,</span>
<a name="line-32"></a>  <span class='hs-varid'>mkTcAxiomRuleCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcCoherenceLeftCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcCoherenceRightCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcPhantomCo</span><span class='hs-layout'>,</span>
<a name="line-33"></a>  <span class='hs-varid'>mkTcKindCo</span><span class='hs-layout'>,</span>
<a name="line-34"></a>  <span class='hs-varid'>tcCoercionKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfTcCo</span><span class='hs-layout'>,</span>
<a name="line-35"></a>  <span class='hs-varid'>mkTcCoVarCo</span><span class='hs-layout'>,</span>
<a name="line-36"></a>  <span class='hs-varid'>isTcReflCo</span><span class='hs-layout'>,</span>
<a name="line-37"></a>  <span class='hs-varid'>tcCoercionRole</span><span class='hs-layout'>,</span>
<a name="line-38"></a>  <span class='hs-varid'>unwrapIP</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapIP</span>
<a name="line-39"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-40"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span> <span class='hs-conid'>()</span>   <span class='hs-comment'>-- Instance OutputableBndr TyVar</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span><span class='hs-layout'>(</span> <span class='hs-conid'>Class</span> <span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>gopt</span><span class='hs-layout'>,</span> <span class='hs-conid'>GeneralFlag</span><span class='hs-layout'>(</span><span class='hs-conid'>Opt_PrintTypecheckerElaboration</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span><span class='hs-layout'>(</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-comment'>{-
<a name="line-68"></a>Note [TcCoercions]
<a name="line-69"></a>~~~~~~~~~~~~~~~~~~
<a name="line-70"></a>| TcCoercions are a hack used by the typechecker. Normally,
<a name="line-71"></a>Coercions have free variables of type (a ~# b): we call these
<a name="line-72"></a>CoVars. However, the type checker passes around equality evidence
<a name="line-73"></a>(boxed up) at type (a ~ b).
<a name="line-74"></a>
<a name="line-75"></a>An TcCoercion is simply a Coercion whose free variables have may be either
<a name="line-76"></a>boxed or unboxed. After we are done with typechecking the desugarer finds the
<a name="line-77"></a>boxed free variables, unboxes them, and creates a resulting real Coercion with
<a name="line-78"></a>kosher free variables.
<a name="line-79"></a>
<a name="line-80"></a>-}</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="TcCoercion"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcCoercion</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>
<a name="line-83"></a><a name="TcCoercionN"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcCoercionN</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionN</span>    <span class='hs-comment'>-- A Nominal          coercion ~N</span>
<a name="line-84"></a><a name="TcCoercionR"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcCoercionR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionR</span>    <span class='hs-comment'>-- A Representational coercion ~R</span>
<a name="line-85"></a><a name="TcCoercionP"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcCoercionP</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionP</span>    <span class='hs-comment'>-- a phantom coercion</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="mkTcReflCo"></a><span class='hs-definition'>mkTcReflCo</span>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-88"></a><a name="mkTcSymCo"></a><span class='hs-definition'>mkTcSymCo</span>              <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-89"></a><a name="mkTcTransCo"></a><span class='hs-definition'>mkTcTransCo</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-90"></a><a name="mkTcNomReflCo"></a><span class='hs-definition'>mkTcNomReflCo</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionN</span>
<a name="line-91"></a><a name="mkTcRepReflCo"></a><span class='hs-definition'>mkTcRepReflCo</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionR</span>
<a name="line-92"></a><a name="mkTcTyConAppCo"></a><span class='hs-definition'>mkTcTyConAppCo</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-93"></a><a name="mkTcAppCo"></a><span class='hs-definition'>mkTcAppCo</span>              <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-94"></a><a name="mkTcFunCo"></a><span class='hs-definition'>mkTcFunCo</span>              <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-95"></a><a name="mkTcAxInstCo"></a><span class='hs-definition'>mkTcAxInstCo</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span>
<a name="line-96"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-97"></a><a name="mkTcUnbranchedAxInstCo"></a><span class='hs-definition'>mkTcUnbranchedAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-98"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionR</span>
<a name="line-99"></a><a name="mkTcForAllCo"></a><span class='hs-definition'>mkTcForAllCo</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-100"></a><a name="mkTcForAllCos"></a><span class='hs-definition'>mkTcForAllCos</span>          <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-101"></a><a name="mkTcNthCo"></a><span class='hs-definition'>mkTcNthCo</span>              <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-102"></a><a name="mkTcLRCo"></a><span class='hs-definition'>mkTcLRCo</span>               <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-103"></a><a name="mkTcSubCo"></a><span class='hs-definition'>mkTcSubCo</span>              <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionR</span>
<a name="line-104"></a><a name="maybeTcSubCo"></a><span class='hs-definition'>maybeTcSubCo</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-105"></a><a name="tcDowngradeRole"></a><span class='hs-definition'>tcDowngradeRole</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-106"></a><a name="mkTcAxiomRuleCo"></a><span class='hs-definition'>mkTcAxiomRuleCo</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionR</span>
<a name="line-107"></a><a name="mkTcCoherenceLeftCo"></a><span class='hs-definition'>mkTcCoherenceLeftCo</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-108"></a><a name="mkTcCoherenceRightCo"></a><span class='hs-definition'>mkTcCoherenceRightCo</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-109"></a><a name="mkTcPhantomCo"></a><span class='hs-definition'>mkTcPhantomCo</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionP</span>
<a name="line-110"></a><a name="mkTcKindCo"></a><span class='hs-definition'>mkTcKindCo</span>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercionN</span>
<a name="line-111"></a><a name="mkTcCoVarCo"></a><span class='hs-definition'>mkTcCoVarCo</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="tcCoercionKind"></a><span class='hs-definition'>tcCoercionKind</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>TcType</span>
<a name="line-114"></a><a name="tcCoercionRole"></a><span class='hs-definition'>tcCoercionRole</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-115"></a><a name="coVarsOfTcCo"></a><span class='hs-definition'>coVarsOfTcCo</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyCoVarSet</span>
<a name="line-116"></a><a name="isTcReflCo"></a><span class='hs-definition'>isTcReflCo</span>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-definition'>mkTcReflCo</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span>
<a name="line-119"></a><span class='hs-definition'>mkTcSymCo</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span>
<a name="line-120"></a><span class='hs-definition'>mkTcTransCo</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTransCo</span>
<a name="line-121"></a><span class='hs-definition'>mkTcNomReflCo</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNomReflCo</span>
<a name="line-122"></a><span class='hs-definition'>mkTcRepReflCo</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRepReflCo</span>
<a name="line-123"></a><span class='hs-definition'>mkTcTyConAppCo</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span>
<a name="line-124"></a><span class='hs-definition'>mkTcAppCo</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span>
<a name="line-125"></a><span class='hs-definition'>mkTcFunCo</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span>
<a name="line-126"></a><span class='hs-definition'>mkTcAxInstCo</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstCo</span>
<a name="line-127"></a><span class='hs-definition'>mkTcUnbranchedAxInstCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span>
<a name="line-128"></a><span class='hs-definition'>mkTcForAllCo</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllCo</span>
<a name="line-129"></a><span class='hs-definition'>mkTcForAllCos</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllCos</span>
<a name="line-130"></a><span class='hs-definition'>mkTcNthCo</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span>
<a name="line-131"></a><span class='hs-definition'>mkTcLRCo</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLRCo</span>
<a name="line-132"></a><span class='hs-definition'>mkTcSubCo</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span>
<a name="line-133"></a><span class='hs-definition'>maybeTcSubCo</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeSubCo</span>
<a name="line-134"></a><span class='hs-definition'>tcDowngradeRole</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span>
<a name="line-135"></a><span class='hs-definition'>mkTcAxiomRuleCo</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxiomRuleCo</span>
<a name="line-136"></a><span class='hs-definition'>mkTcCoherenceLeftCo</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoherenceLeftCo</span>
<a name="line-137"></a><span class='hs-definition'>mkTcCoherenceRightCo</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoherenceRightCo</span>
<a name="line-138"></a><span class='hs-definition'>mkTcPhantomCo</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPhantomCo</span>
<a name="line-139"></a><span class='hs-definition'>mkTcKindCo</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindCo</span>
<a name="line-140"></a><span class='hs-definition'>mkTcCoVarCo</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVarCo</span>
<a name="line-141"></a>
<a name="line-142"></a><span class='hs-definition'>tcCoercionKind</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span>
<a name="line-143"></a><span class='hs-definition'>tcCoercionRole</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span>
<a name="line-144"></a><span class='hs-definition'>coVarsOfTcCo</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span>
<a name="line-145"></a><span class='hs-definition'>isTcReflCo</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isReflCo</span>
<a name="line-146"></a>
<a name="line-147"></a>
<a name="line-148"></a><span class='hs-comment'>{-
<a name="line-149"></a>%************************************************************************
<a name="line-150"></a>%*                                                                      *
<a name="line-151"></a>                  HsWrapper
<a name="line-152"></a>*                                                                      *
<a name="line-153"></a>************************************************************************
<a name="line-154"></a>-}</span>
<a name="line-155"></a>
<a name="line-156"></a><a name="HsWrapper"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>                      <span class='hs-comment'>-- The identity coercion</span>
<a name="line-158"></a>
<a name="line-159"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpCompose</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-160"></a>       <span class='hs-comment'>-- (wrap1 `WpCompose` wrap2)[e] = wrap1[ wrap2[ e ]]</span>
<a name="line-161"></a>       <span class='hs-comment'>--</span>
<a name="line-162"></a>       <span class='hs-comment'>-- Hence  (\a. []) `WpCompose` (\b. []) = (\a b. [])</span>
<a name="line-163"></a>       <span class='hs-comment'>-- But    ([] a)   `WpCompose` ([] b)   = ([] b a)</span>
<a name="line-164"></a>
<a name="line-165"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpFun</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-conid'>TcType</span> <span class='hs-conid'>SDoc</span>
<a name="line-166"></a>       <span class='hs-comment'>-- (WpFun wrap1 wrap2 t1)[e] = \(x:t1). wrap2[ e wrap1[x] ]</span>
<a name="line-167"></a>       <span class='hs-comment'>-- So note that if  wrap1 :: exp_arg &lt;= act_arg</span>
<a name="line-168"></a>       <span class='hs-comment'>--                  wrap2 :: act_res &lt;= exp_res</span>
<a name="line-169"></a>       <span class='hs-comment'>--           then   WpFun wrap1 wrap2 : (act_arg -&gt; arg_res) &lt;= (exp_arg -&gt; exp_res)</span>
<a name="line-170"></a>       <span class='hs-comment'>-- This isn't the same as for mkFunCo, but it has to be this way</span>
<a name="line-171"></a>       <span class='hs-comment'>-- because we can't use 'sym' to flip around these HsWrappers</span>
<a name="line-172"></a>       <span class='hs-comment'>-- The TcType is the "from" type of the first wrapper</span>
<a name="line-173"></a>       <span class='hs-comment'>-- The SDoc explains the circumstances under which we have created this</span>
<a name="line-174"></a>       <span class='hs-comment'>-- WpFun, in case we run afoul of levity polymorphism restrictions in</span>
<a name="line-175"></a>       <span class='hs-comment'>-- the desugarer. See Note [Levity polymorphism checking] in DsMonad</span>
<a name="line-176"></a>
<a name="line-177"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpCast</span> <span class='hs-conid'>TcCoercionR</span>        <span class='hs-comment'>-- A cast:  [] `cast` co</span>
<a name="line-178"></a>                              <span class='hs-comment'>-- Guaranteed not the identity coercion</span>
<a name="line-179"></a>                              <span class='hs-comment'>-- At role Representational</span>
<a name="line-180"></a>
<a name="line-181"></a>        <span class='hs-comment'>-- Evidence abstraction and application</span>
<a name="line-182"></a>        <span class='hs-comment'>-- (both dictionaries and coercions)</span>
<a name="line-183"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpEvLam</span> <span class='hs-conid'>EvVar</span>               <span class='hs-comment'>-- \d. []       the 'd' is an evidence variable</span>
<a name="line-184"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpEvApp</span> <span class='hs-conid'>EvTerm</span>              <span class='hs-comment'>-- [] d         the 'd' is evidence for a constraint</span>
<a name="line-185"></a>        <span class='hs-comment'>-- Kind and Type abstraction and application</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpTyLam</span> <span class='hs-conid'>TyVar</span>       <span class='hs-comment'>-- \a. []  the 'a' is a type/kind variable (not coercion var)</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-conid'>KindOrType</span>  <span class='hs-comment'>-- [] t    the 't' is a type (not coercion)</span>
<a name="line-188"></a>
<a name="line-189"></a>
<a name="line-190"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpLet</span> <span class='hs-conid'>TcEvBinds</span>             <span class='hs-comment'>-- Non-empty (or possibly non-empty) evidence bindings,</span>
<a name="line-191"></a>                                <span class='hs-comment'>-- so that the identity coercion is always exactly WpHole</span>
<a name="line-192"></a>
<a name="line-193"></a><a name="instance%20Data.Data%20HsWrapper"></a><span class='hs-comment'>-- Cannot derive Data instance because SDoc is not Data (it stores a function).</span>
<a name="line-194"></a><a name="instance%20Data.Data%20HsWrapper"></a><span class='hs-comment'>-- So we do it manually:</span>
<a name="line-195"></a><a name="instance%20Data.Data%20HsWrapper"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyword'>where</span>
<a name="line-196"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpHole</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpHole</span>
<a name="line-197"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCompose</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpCompose</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a1</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a2</span>
<a name="line-198"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpFun</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span> <span class='hs-varid'>a3</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-varid'>wpFunEmpty</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a1</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a2</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a3</span>
<a name="line-199"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpCast</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a1</span>
<a name="line-200"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpEvLam</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a1</span>
<a name="line-201"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpEvApp</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a1</span>
<a name="line-202"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpTyLam</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a1</span>
<a name="line-203"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a1</span>
<a name="line-204"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpLet</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpLet</span> <span class='hs-varop'>`k`</span> <span class='hs-varid'>a1</span>
<a name="line-205"></a>
<a name="line-206"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-varid'>constrIndex</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>of</span>
<a name="line-207"></a>                    <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>z</span> <span class='hs-conid'>WpHole</span>
<a name="line-208"></a>                    <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>z</span> <span class='hs-conid'>WpCompose</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-209"></a>                    <span class='hs-num'>3</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>z</span> <span class='hs-varid'>wpFunEmpty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-210"></a>                    <span class='hs-num'>4</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>z</span> <span class='hs-conid'>WpCast</span><span class='hs-layout'>)</span>
<a name="line-211"></a>                    <span class='hs-num'>5</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>z</span> <span class='hs-conid'>WpEvLam</span><span class='hs-layout'>)</span>
<a name="line-212"></a>                    <span class='hs-num'>6</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>z</span> <span class='hs-conid'>WpEvApp</span><span class='hs-layout'>)</span>
<a name="line-213"></a>                    <span class='hs-num'>7</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>z</span> <span class='hs-conid'>WpTyLam</span><span class='hs-layout'>)</span>
<a name="line-214"></a>                    <span class='hs-num'>8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>z</span> <span class='hs-conid'>WpTyApp</span><span class='hs-layout'>)</span>
<a name="line-215"></a>                    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>z</span> <span class='hs-conid'>WpLet</span><span class='hs-layout'>)</span>
<a name="line-216"></a>
<a name="line-217"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-conid'>WpHole</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wpHole_constr</span>
<a name="line-218"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCompose</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wpCompose_constr</span>
<a name="line-219"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpFun</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wpFun_constr</span>
<a name="line-220"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wpCast_constr</span>
<a name="line-221"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvLam</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wpEvLam_constr</span>
<a name="line-222"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvApp</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wpEvApp_constr</span>
<a name="line-223"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyLam</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wpTyLam_constr</span>
<a name="line-224"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wpTyApp_constr</span>
<a name="line-225"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpLet</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wpLet_constr</span>
<a name="line-226"></a>
<a name="line-227"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsWrapper_dataType</span>
<a name="line-228"></a>
<a name="line-229"></a><a name="hsWrapper_dataType"></a><span class='hs-definition'>hsWrapper_dataType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>DataType</span>
<a name="line-230"></a><span class='hs-definition'>hsWrapper_dataType</span>
<a name="line-231"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-varid'>mkDataType</span> <span class='hs-str'>"HsWrapper"</span>
<a name="line-232"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-varid'>wpHole_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpCompose_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpFun_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpCast_constr</span>
<a name="line-233"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>wpEvLam_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpEvApp_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpTyLam_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpTyApp_constr</span>
<a name="line-234"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>wpLet_constr</span><span class='hs-keyglyph'>]</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="wpHole_constr"></a><span class='hs-definition'>wpHole_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpCompose_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpFun_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpCast_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpEvLam_constr</span><span class='hs-layout'>,</span>
<a name="line-237"></a>  <span class='hs-varid'>wpEvApp_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpTyLam_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpTyApp_constr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wpLet_constr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Constr</span>
<a name="line-238"></a><span class='hs-definition'>wpHole_constr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrapperConstr</span> <span class='hs-str'>"WpHole"</span>
<a name="line-239"></a><a name="wpCompose_constr"></a><span class='hs-definition'>wpCompose_constr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrapperConstr</span> <span class='hs-str'>"WpCompose"</span>
<a name="line-240"></a><a name="wpFun_constr"></a><span class='hs-definition'>wpFun_constr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrapperConstr</span> <span class='hs-str'>"WpFun"</span>
<a name="line-241"></a><a name="wpCast_constr"></a><span class='hs-definition'>wpCast_constr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrapperConstr</span> <span class='hs-str'>"WpCast"</span>
<a name="line-242"></a><a name="wpEvLam_constr"></a><span class='hs-definition'>wpEvLam_constr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrapperConstr</span> <span class='hs-str'>"WpEvLam"</span>
<a name="line-243"></a><a name="wpEvApp_constr"></a><span class='hs-definition'>wpEvApp_constr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrapperConstr</span> <span class='hs-str'>"WpEvApp"</span>
<a name="line-244"></a><a name="wpTyLam_constr"></a><span class='hs-definition'>wpTyLam_constr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrapperConstr</span> <span class='hs-str'>"WpTyLam"</span>
<a name="line-245"></a><a name="wpTyApp_constr"></a><span class='hs-definition'>wpTyApp_constr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrapperConstr</span> <span class='hs-str'>"WpTyApp"</span>
<a name="line-246"></a><a name="wpLet_constr"></a><span class='hs-definition'>wpLet_constr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrapperConstr</span> <span class='hs-str'>"WpLet"</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="mkHsWrapperConstr"></a><span class='hs-definition'>mkHsWrapperConstr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Constr</span>
<a name="line-249"></a><span class='hs-definition'>mkHsWrapperConstr</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-varid'>mkConstr</span> <span class='hs-varid'>hsWrapper_dataType</span> <span class='hs-varid'>name</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Prefix</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="wpFunEmpty"></a><span class='hs-definition'>wpFunEmpty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-252"></a><span class='hs-definition'>wpFunEmpty</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpFun</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>empty</span>
<a name="line-253"></a>
<a name="line-254"></a><a name="%3c.%3e"></a><span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-255"></a><span class='hs-conid'>WpHole</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-256"></a><a name="c"></a><span class='hs-definition'>c</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-257"></a><a name="c1"></a><span class='hs-definition'>c1</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>c2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>`WpCompose`</span> <span class='hs-varid'>c2</span>
<a name="line-258"></a>
<a name="line-259"></a><a name="mkWpFun"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-260"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- the "from" type of the first wrapper</span>
<a name="line-261"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- either type of the second wrapper (used only when the</span>
<a name="line-262"></a>                     <span class='hs-comment'>-- second wrapper is the identity)</span>
<a name="line-263"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>      <span class='hs-comment'>-- what caused you to want a WpFun? Something like "When converting ..."</span>
<a name="line-264"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-265"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-conid'>WpHole</span>       <span class='hs-conid'>WpHole</span>       <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-266"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-conid'>WpHole</span>       <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcRepReflCo</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-267"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-conid'>WpHole</span>       <span class='hs-keyword'>_</span>  <span class='hs-varid'>t2</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcRepReflCo</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-268"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-269"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-varid'>co1</span>          <span class='hs-varid'>co2</span>          <span class='hs-varid'>t1</span> <span class='hs-keyword'>_</span>  <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpFun</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>d</span>
<a name="line-270"></a>
<a name="line-271"></a><a name="mkWpFuns"></a><span class='hs-comment'>-- | @mkWpFuns [(ty1, wrap1), (ty2, wrap2)] ty_res wrap_res@,</span>
<a name="line-272"></a><span class='hs-comment'>-- where @wrap1 :: ty1 "-&gt;" ty1'@ and @wrap2 :: ty2 "-&gt;" ty2'@,</span>
<a name="line-273"></a><span class='hs-comment'>-- @wrap3 :: ty3 "-&gt;" ty3'@ and @ty_res@ is /either/ @ty3@ or @ty3'@,</span>
<a name="line-274"></a><span class='hs-comment'>-- gives a wrapper @(ty1' -&gt; ty2' -&gt; ty3) "-&gt;" (ty1 -&gt; ty2 -&gt; ty3')@.</span>
<a name="line-275"></a><span class='hs-comment'>-- Notice that the result wrapper goes the other way round to all</span>
<a name="line-276"></a><span class='hs-comment'>-- the others. This is a result of sub-typing contravariance.</span>
<a name="line-277"></a><span class='hs-comment'>-- The SDoc is a description of what you were doing when you called mkWpFuns.</span>
<a name="line-278"></a><span class='hs-definition'>mkWpFuns</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-279"></a><span class='hs-definition'>mkWpFuns</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>res_wrap</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>res_wrap</span>
<a name="line-280"></a>  <span class='hs-keyword'>where</span>
<a name="line-281"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>res_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_wrap</span><span class='hs-layout'>)</span>
<a name="line-282"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_wrap</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>res_wrap</span>
<a name="line-283"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tail_wrap</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>res_wrap</span> <span class='hs-keyword'>in</span>
<a name="line-284"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>tail_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpFun</span> <span class='hs-varid'>arg_wrap</span> <span class='hs-varid'>tail_wrap</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>tail_ty</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-285"></a>
<a name="line-286"></a><a name="mkWpCastR"></a><span class='hs-definition'>mkWpCastR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercionR</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-287"></a><span class='hs-definition'>mkWpCastR</span> <span class='hs-varid'>co</span>
<a name="line-288"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-289"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span><span class='hs-varid'>tcCoercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-290"></a>                    <span class='hs-conid'>WpCast</span> <span class='hs-varid'>co</span>
<a name="line-291"></a>
<a name="line-292"></a><a name="mkWpCastN"></a><span class='hs-definition'>mkWpCastN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-293"></a><span class='hs-definition'>mkWpCastN</span> <span class='hs-varid'>co</span>
<a name="line-294"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-295"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span><span class='hs-varid'>tcCoercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-296"></a>                    <span class='hs-conid'>WpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-297"></a>    <span class='hs-comment'>-- The mkTcSubCo converts Nominal to Representational</span>
<a name="line-298"></a>
<a name="line-299"></a><a name="mkWpTyApps"></a><span class='hs-definition'>mkWpTyApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-300"></a><span class='hs-definition'>mkWpTyApps</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_app_fn</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>tys</span>
<a name="line-301"></a>
<a name="line-302"></a><a name="mkWpEvApps"></a><span class='hs-definition'>mkWpEvApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-303"></a><span class='hs-definition'>mkWpEvApps</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_app_fn</span> <span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>args</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="mkWpEvVarApps"></a><span class='hs-definition'>mkWpEvVarApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-306"></a><span class='hs-definition'>mkWpEvVarApps</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_app_fn</span> <span class='hs-conid'>WpEvApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>EvId</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-307"></a>
<a name="line-308"></a><a name="mkWpTyLams"></a><span class='hs-definition'>mkWpTyLams</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-309"></a><span class='hs-definition'>mkWpTyLams</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_lam_fn</span> <span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>ids</span>
<a name="line-310"></a>
<a name="line-311"></a><a name="mkWpLams"></a><span class='hs-definition'>mkWpLams</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-312"></a><span class='hs-definition'>mkWpLams</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_lam_fn</span> <span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>ids</span>
<a name="line-313"></a>
<a name="line-314"></a><a name="mkWpLet"></a><span class='hs-definition'>mkWpLet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-315"></a><span class='hs-comment'>-- This no-op is a quite a common case</span>
<a name="line-316"></a><span class='hs-definition'>mkWpLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-317"></a><span class='hs-definition'>mkWpLet</span> <span class='hs-varid'>ev_binds</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpLet</span> <span class='hs-varid'>ev_binds</span>
<a name="line-318"></a>
<a name="line-319"></a><a name="mk_co_lam_fn"></a><span class='hs-definition'>mk_co_lam_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-320"></a><span class='hs-definition'>mk_co_lam_fn</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyword'>as</span>
<a name="line-321"></a>
<a name="line-322"></a><a name="mk_co_app_fn"></a><span class='hs-definition'>mk_co_app_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-323"></a><span class='hs-comment'>-- For applications, the *first* argument must</span>
<a name="line-324"></a><span class='hs-comment'>-- come *last* in the composition sequence</span>
<a name="line-325"></a><span class='hs-definition'>mk_co_app_fn</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyword'>as</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="idHsWrapper"></a><span class='hs-definition'>idHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-328"></a><span class='hs-definition'>idHsWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-329"></a>
<a name="line-330"></a><a name="isIdHsWrapper"></a><span class='hs-definition'>isIdHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-331"></a><span class='hs-definition'>isIdHsWrapper</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-332"></a><span class='hs-definition'>isIdHsWrapper</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-333"></a>
<a name="line-334"></a><a name="collectHsWrapBinders"></a><span class='hs-definition'>collectHsWrapBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span>
<a name="line-335"></a><span class='hs-comment'>-- Collect the outer lambda binders of a HsWrapper,</span>
<a name="line-336"></a><span class='hs-comment'>-- stopping as soon as you get to a non-lambda binder</span>
<a name="line-337"></a><span class='hs-definition'>collectHsWrapBinders</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>wrap</span> <span class='hs-conid'>[]</span>
<a name="line-338"></a>  <span class='hs-keyword'>where</span>
<a name="line-339"></a>    <span class='hs-comment'>-- go w ws = collectHsWrapBinders (w &lt;.&gt; w1 &lt;.&gt; ... &lt;.&gt; wn)</span>
<a name="line-340"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsWrapper</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span>
<a name="line-341"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>       <span class='hs-varid'>wraps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_lam</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>gos</span> <span class='hs-varid'>wraps</span><span class='hs-layout'>)</span>
<a name="line-342"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>       <span class='hs-varid'>wraps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_lam</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>gos</span> <span class='hs-varid'>wraps</span><span class='hs-layout'>)</span>
<a name="line-343"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCompose</span> <span class='hs-varid'>w1</span> <span class='hs-varid'>w2</span><span class='hs-layout'>)</span> <span class='hs-varid'>wraps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>w1</span> <span class='hs-layout'>(</span><span class='hs-varid'>w2</span><span class='hs-conop'>:</span><span class='hs-varid'>wraps</span><span class='hs-layout'>)</span>
<a name="line-344"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>wrap</span>              <span class='hs-varid'>wraps</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldl</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>wraps</span><span class='hs-layout'>)</span>
<a name="line-345"></a>
<a name="line-346"></a>    <span class='hs-varid'>gos</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>WpHole</span><span class='hs-layout'>)</span>
<a name="line-347"></a>    <span class='hs-varid'>gos</span> <span class='hs-layout'>(</span><span class='hs-varid'>w</span><span class='hs-conop'>:</span><span class='hs-varid'>ws</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ws</span>
<a name="line-348"></a>
<a name="line-349"></a>    <span class='hs-varid'>add_lam</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>vs</span><span class='hs-layout'>,</span><span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-350"></a>
<a name="line-351"></a><span class='hs-comment'>{-
<a name="line-352"></a>************************************************************************
<a name="line-353"></a>*                                                                      *
<a name="line-354"></a>                  Evidence bindings
<a name="line-355"></a>*                                                                      *
<a name="line-356"></a>************************************************************************
<a name="line-357"></a>-}</span>
<a name="line-358"></a>
<a name="line-359"></a><a name="TcEvBinds"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcEvBinds</span>
<a name="line-360"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcEvBinds</span>           <span class='hs-comment'>-- Mutable evidence bindings</span>
<a name="line-361"></a>       <span class='hs-conid'>EvBindsVar</span>       <span class='hs-comment'>-- Mutable because they are updated "later"</span>
<a name="line-362"></a>                        <span class='hs-comment'>--    when an implication constraint is solved</span>
<a name="line-363"></a>
<a name="line-364"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvBinds</span>             <span class='hs-comment'>-- Immutable after zonking</span>
<a name="line-365"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-366"></a>
<a name="line-367"></a><a name="EvBindsVar"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-368"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-layout'>{</span>
<a name="line-369"></a>      <span class='hs-varid'>ebv_uniq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>,</span>
<a name="line-370"></a>         <span class='hs-comment'>-- The Unique is for debug printing only</span>
<a name="line-371"></a>
<a name="line-372"></a>      <span class='hs-varid'>ebv_binds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>EvBindMap</span><span class='hs-layout'>,</span>
<a name="line-373"></a>      <span class='hs-comment'>-- The main payload: the value-level evidence bindings</span>
<a name="line-374"></a>      <span class='hs-comment'>--     (dictionaries etc)</span>
<a name="line-375"></a>      <span class='hs-comment'>-- Some Given, some Wanted</span>
<a name="line-376"></a>
<a name="line-377"></a>      <span class='hs-varid'>ebv_tcvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-378"></a>      <span class='hs-comment'>-- The free coercion vars of the (rhss of) the coercion bindings</span>
<a name="line-379"></a>      <span class='hs-comment'>-- All of these are Wanted</span>
<a name="line-380"></a>      <span class='hs-comment'>--</span>
<a name="line-381"></a>      <span class='hs-comment'>-- Coercions don't actually have bindings</span>
<a name="line-382"></a>      <span class='hs-comment'>-- because we plug them in-place (via a mutable</span>
<a name="line-383"></a>      <span class='hs-comment'>-- variable); but we keep their free variables</span>
<a name="line-384"></a>      <span class='hs-comment'>-- so that we can report unused given constraints</span>
<a name="line-385"></a>      <span class='hs-comment'>-- See Note [Tracking redundant constraints] in TcSimplify</span>
<a name="line-386"></a>    <span class='hs-layout'>}</span>
<a name="line-387"></a>
<a name="line-388"></a><a name="instance%20Data.Data%20TcEvBinds"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyword'>where</span>
<a name="line-389"></a>  <span class='hs-comment'>-- Placeholder; we can't travers into TcEvBinds</span>
<a name="line-390"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"TcEvBinds"</span>
<a name="line-391"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-392"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"TcEvBinds"</span>
<a name="line-393"></a>
<a name="line-394"></a><a name="EvBindMap"></a><span class='hs-comment'>-----------------</span>
<a name="line-395"></a><a name="EvBindMap"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-396"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-layout'>{</span>
<a name="line-397"></a>       <span class='hs-varid'>ev_bind_varenv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DVarEnv</span> <span class='hs-conid'>EvBind</span>
<a name="line-398"></a>    <span class='hs-layout'>}</span>       <span class='hs-comment'>-- Map from evidence variables to evidence terms</span>
<a name="line-399"></a>            <span class='hs-comment'>-- We use @DVarEnv@ here to get deterministic ordering when we</span>
<a name="line-400"></a>            <span class='hs-comment'>-- turn it into a Bag.</span>
<a name="line-401"></a>            <span class='hs-comment'>-- If we don't do that, when we generate let bindings for</span>
<a name="line-402"></a>            <span class='hs-comment'>-- dictionaries in dsTcEvBinds they will be generated in random</span>
<a name="line-403"></a>            <span class='hs-comment'>-- order.</span>
<a name="line-404"></a>            <span class='hs-comment'>--</span>
<a name="line-405"></a>            <span class='hs-comment'>-- For example:</span>
<a name="line-406"></a>            <span class='hs-comment'>--</span>
<a name="line-407"></a>            <span class='hs-comment'>-- let $dEq = GHC.Classes.$fEqInt in</span>
<a name="line-408"></a>            <span class='hs-comment'>-- let $$dNum = GHC.Num.$fNumInt in ...</span>
<a name="line-409"></a>            <span class='hs-comment'>--</span>
<a name="line-410"></a>            <span class='hs-comment'>-- vs</span>
<a name="line-411"></a>            <span class='hs-comment'>--</span>
<a name="line-412"></a>            <span class='hs-comment'>-- let $dNum = GHC.Num.$fNumInt in</span>
<a name="line-413"></a>            <span class='hs-comment'>-- let $dEq = GHC.Classes.$fEqInt in ...</span>
<a name="line-414"></a>            <span class='hs-comment'>--</span>
<a name="line-415"></a>            <span class='hs-comment'>-- See Note [Deterministic UniqFM] in UniqDFM for explanation why</span>
<a name="line-416"></a>            <span class='hs-comment'>-- @UniqFM@ can lead to nondeterministic order.</span>
<a name="line-417"></a>
<a name="line-418"></a><a name="emptyEvBindMap"></a><span class='hs-definition'>emptyEvBindMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-419"></a><span class='hs-definition'>emptyEvBindMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_bind_varenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDVarEnv</span> <span class='hs-layout'>}</span>
<a name="line-420"></a>
<a name="line-421"></a><a name="extendEvBinds"></a><span class='hs-definition'>extendEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-422"></a><span class='hs-definition'>extendEvBinds</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>ev_bind</span>
<a name="line-423"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_bind_varenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_bind_varenv</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-424"></a>                                               <span class='hs-layout'>(</span><span class='hs-varid'>eb_lhs</span> <span class='hs-varid'>ev_bind</span><span class='hs-layout'>)</span>
<a name="line-425"></a>                                               <span class='hs-varid'>ev_bind</span> <span class='hs-layout'>}</span>
<a name="line-426"></a>
<a name="line-427"></a><a name="isEmptyEvBindMap"></a><span class='hs-definition'>isEmptyEvBindMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-428"></a><span class='hs-definition'>isEmptyEvBindMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyDVarEnv</span> <span class='hs-varid'>m</span>
<a name="line-429"></a>
<a name="line-430"></a><a name="lookupEvBind"></a><span class='hs-definition'>lookupEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EvBind</span>
<a name="line-431"></a><span class='hs-definition'>lookupEvBind</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_bind_varenv</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-432"></a>
<a name="line-433"></a><a name="evBindMapBinds"></a><span class='hs-definition'>evBindMapBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span>
<a name="line-434"></a><span class='hs-definition'>evBindMapBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldEvBindMap</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>emptyBag</span>
<a name="line-435"></a>
<a name="line-436"></a><a name="foldEvBindMap"></a><span class='hs-definition'>foldEvBindMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-437"></a><span class='hs-definition'>foldEvBindMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDVarEnv</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_bind_varenv</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-438"></a>
<a name="line-439"></a><a name="instance%20Outputable%20EvBindMap"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyword'>where</span>
<a name="line-440"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>m</span>
<a name="line-441"></a>
<a name="line-442"></a><a name="EvBind"></a><span class='hs-comment'>-----------------</span>
<a name="line-443"></a><a name="EvBind"></a><span class='hs-comment'>-- All evidence is bound by EvBinds; no side effects</span>
<a name="line-444"></a><a name="EvBind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvBind</span>
<a name="line-445"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span>
<a name="line-446"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span>
<a name="line-447"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>eb_is_given</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- True &lt;=&gt; given</span>
<a name="line-448"></a>                 <span class='hs-comment'>-- See Note [Tracking redundant constraints] in TcSimplify</span>
<a name="line-449"></a>    <span class='hs-layout'>}</span>
<a name="line-450"></a>
<a name="line-451"></a><a name="evBindVar"></a><span class='hs-definition'>evBindVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span>
<a name="line-452"></a><span class='hs-definition'>evBindVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eb_lhs</span>
<a name="line-453"></a>
<a name="line-454"></a><a name="mkWantedEvBind"></a><span class='hs-definition'>mkWantedEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBind</span>
<a name="line-455"></a><span class='hs-definition'>mkWantedEvBind</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_is_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span> <span class='hs-layout'>}</span>
<a name="line-456"></a>
<a name="line-457"></a>
<a name="line-458"></a><a name="mkGivenEvBind"></a><span class='hs-definition'>mkGivenEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBind</span>
<a name="line-459"></a><span class='hs-definition'>mkGivenEvBind</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_is_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span> <span class='hs-layout'>}</span>
<a name="line-460"></a>
<a name="line-461"></a><a name="EvTerm"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvTerm</span>
<a name="line-462"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-conid'>EvId</span>                    <span class='hs-comment'>-- Any sort of evidence Id, including coercions</span>
<a name="line-463"></a>
<a name="line-464"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCoercion</span> <span class='hs-conid'>TcCoercion</span>        <span class='hs-comment'>-- coercion bindings</span>
<a name="line-465"></a>                                 <span class='hs-comment'>-- See Note [Coercion evidence terms]</span>
<a name="line-466"></a>
<a name="line-467"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCast</span> <span class='hs-conid'>EvTerm</span> <span class='hs-conid'>TcCoercionR</span>    <span class='hs-comment'>-- d |&gt; co</span>
<a name="line-468"></a>
<a name="line-469"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvDFunApp</span> <span class='hs-conid'>DFunId</span>             <span class='hs-comment'>-- Dictionary instance application</span>
<a name="line-470"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span>
<a name="line-471"></a>
<a name="line-472"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvDelayedError</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>FastString</span>  <span class='hs-comment'>-- Used with Opt_DeferTypeErrors</span>
<a name="line-473"></a>                               <span class='hs-comment'>-- See Note [Deferring coercion errors to runtime]</span>
<a name="line-474"></a>                               <span class='hs-comment'>-- in TcSimplify</span>
<a name="line-475"></a>
<a name="line-476"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvSuperClass</span> <span class='hs-conid'>EvTerm</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- n'th superclass. Used for both equalities and</span>
<a name="line-477"></a>                                 <span class='hs-comment'>-- dictionaries, even though the former have no</span>
<a name="line-478"></a>                                 <span class='hs-comment'>-- selector Id.  We count up from _0_</span>
<a name="line-479"></a>
<a name="line-480"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvLit</span> <span class='hs-conid'>EvLit</span>       <span class='hs-comment'>-- Dictionary for KnownNat and KnownSymbol classes.</span>
<a name="line-481"></a>                      <span class='hs-comment'>-- Note [KnownNat &amp; KnownSymbol and EvLit]</span>
<a name="line-482"></a>
<a name="line-483"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCallStack</span> <span class='hs-conid'>EvCallStack</span>      <span class='hs-comment'>-- Dictionary for CallStack implicit parameters</span>
<a name="line-484"></a>
<a name="line-485"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTypeable</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>EvTypeable</span>   <span class='hs-comment'>-- Dictionary for (Typeable ty)</span>
<a name="line-486"></a>
<a name="line-487"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvSelector</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Selector id plus the types at which it</span>
<a name="line-488"></a>                                  <span class='hs-comment'>-- should be instantiated, used for HasField</span>
<a name="line-489"></a>                                  <span class='hs-comment'>-- dictionaries; see Note [HasField instances]</span>
<a name="line-490"></a>                                  <span class='hs-comment'>-- in TcInterface</span>
<a name="line-491"></a>
<a name="line-492"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-493"></a>
<a name="line-494"></a>
<a name="line-495"></a><a name="EvTypeable"></a><span class='hs-comment'>-- | Instructions on how to make a 'Typeable' dictionary.</span>
<a name="line-496"></a><a name="EvTypeable"></a><span class='hs-comment'>-- See Note [Typeable evidence terms]</span>
<a name="line-497"></a><a name="EvTypeable"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvTypeable</span>
<a name="line-498"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvTypeableTyCon</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span>
<a name="line-499"></a>    <span class='hs-comment'>-- ^ Dictionary for @Typeable T@ where @T@ is a type constructor with all of</span>
<a name="line-500"></a>    <span class='hs-comment'>-- its kind variables saturated. The @[EvTerm]@ is @Typeable@ evidence for</span>
<a name="line-501"></a>    <span class='hs-comment'>-- the applied kinds..</span>
<a name="line-502"></a>
<a name="line-503"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTypeableTyApp</span> <span class='hs-conid'>EvTerm</span> <span class='hs-conid'>EvTerm</span>
<a name="line-504"></a>    <span class='hs-comment'>-- ^ Dictionary for @Typeable (s t)@,</span>
<a name="line-505"></a>    <span class='hs-comment'>-- given a dictionaries for @s@ and @t@.</span>
<a name="line-506"></a>
<a name="line-507"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTypeableTrFun</span> <span class='hs-conid'>EvTerm</span> <span class='hs-conid'>EvTerm</span>
<a name="line-508"></a>    <span class='hs-comment'>-- ^ Dictionary for @Typeable (s -&gt; t)@,</span>
<a name="line-509"></a>    <span class='hs-comment'>-- given a dictionaries for @s@ and @t@.</span>
<a name="line-510"></a>
<a name="line-511"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTypeableTyLit</span> <span class='hs-conid'>EvTerm</span>
<a name="line-512"></a>    <span class='hs-comment'>-- ^ Dictionary for a type literal,</span>
<a name="line-513"></a>    <span class='hs-comment'>-- e.g. @Typeable "foo"@ or @Typeable 3@</span>
<a name="line-514"></a>    <span class='hs-comment'>-- The 'EvTerm' is evidence of, e.g., @KnownNat 3@</span>
<a name="line-515"></a>    <span class='hs-comment'>-- (see Trac #10348)</span>
<a name="line-516"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-517"></a>
<a name="line-518"></a><a name="EvLit"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvLit</span>
<a name="line-519"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvNum</span> <span class='hs-conid'>Integer</span>
<a name="line-520"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvStr</span> <span class='hs-conid'>FastString</span>
<a name="line-521"></a>    <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-522"></a>
<a name="line-523"></a><a name="EvCallStack"></a><span class='hs-comment'>-- | Evidence for @CallStack@ implicit parameters.</span>
<a name="line-524"></a><a name="EvCallStack"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvCallStack</span>
<a name="line-525"></a>  <span class='hs-comment'>-- See Note [Overview of implicit CallStacks]</span>
<a name="line-526"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvCsEmpty</span>
<a name="line-527"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCsPushCall</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RealSrcSpan</span> <span class='hs-conid'>EvTerm</span>
<a name="line-528"></a>    <span class='hs-comment'>-- ^ @EvCsPushCall name loc stk@ represents a call to @name@, occurring at</span>
<a name="line-529"></a>    <span class='hs-comment'>-- @loc@, in a calling context @stk@.</span>
<a name="line-530"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-531"></a>
<a name="line-532"></a><span class='hs-comment'>{-
<a name="line-533"></a>Note [Typeable evidence terms]
<a name="line-534"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-535"></a>The EvTypeable data type looks isomorphic to Type, but the EvTerms
<a name="line-536"></a>inside can be EvIds.  Eg
<a name="line-537"></a>    f :: forall a. Typeable a =&gt; a -&gt; TypeRep
<a name="line-538"></a>    f x = typeRep (undefined :: Proxy [a])
<a name="line-539"></a>Here for the (Typeable [a]) dictionary passed to typeRep we make
<a name="line-540"></a>evidence
<a name="line-541"></a>    dl :: Typeable [a] = EvTypeable [a]
<a name="line-542"></a>                            (EvTypeableTyApp (EvTypeableTyCon []) (EvId d))
<a name="line-543"></a>where
<a name="line-544"></a>    d :: Typable a
<a name="line-545"></a>is the lambda-bound dictionary passed into f.
<a name="line-546"></a>
<a name="line-547"></a>Note [Coercion evidence terms]
<a name="line-548"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-549"></a>A "coercion evidence term" takes one of these forms
<a name="line-550"></a>   co_tm ::= EvId v           where v :: t1 ~# t2
<a name="line-551"></a>           | EvCoercion co
<a name="line-552"></a>           | EvCast co_tm co
<a name="line-553"></a>
<a name="line-554"></a>We do quite often need to get a TcCoercion from an EvTerm; see
<a name="line-555"></a>'evTermCoercion'.
<a name="line-556"></a>
<a name="line-557"></a>INVARIANT: The evidence for any constraint with type (t1 ~# t2) is
<a name="line-558"></a>a coercion evidence term.  Consider for example
<a name="line-559"></a>    [G] d :: F Int a
<a name="line-560"></a>If we have
<a name="line-561"></a>    ax7 a :: F Int a ~ (a ~ Bool)
<a name="line-562"></a>then we do NOT generate the constraint
<a name="line-563"></a>    [G] (d |&gt; ax7 a) :: a ~ Bool
<a name="line-564"></a>because that does not satisfy the invariant (d is not a coercion variable).
<a name="line-565"></a>Instead we make a binding
<a name="line-566"></a>    g1 :: a~Bool = g |&gt; ax7 a
<a name="line-567"></a>and the constraint
<a name="line-568"></a>    [G] g1 :: a~Bool
<a name="line-569"></a>See Trac [7238] and Note [Bind new Givens immediately] in TcRnTypes
<a name="line-570"></a>
<a name="line-571"></a>Note [EvBinds/EvTerm]
<a name="line-572"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-573"></a>How evidence is created and updated. Bindings for dictionaries,
<a name="line-574"></a>and coercions and implicit parameters are carried around in TcEvBinds
<a name="line-575"></a>which during constraint generation and simplification is always of the
<a name="line-576"></a>form (TcEvBinds ref). After constraint simplification is finished it
<a name="line-577"></a>will be transformed to t an (EvBinds ev_bag).
<a name="line-578"></a>
<a name="line-579"></a>Evidence for coercions *SHOULD* be filled in using the TcEvBinds
<a name="line-580"></a>However, all EvVars that correspond to *wanted* coercion terms in
<a name="line-581"></a>an EvBind must be mutable variables so that they can be readily
<a name="line-582"></a>inlined (by zonking) after constraint simplification is finished.
<a name="line-583"></a>
<a name="line-584"></a>Conclusion: a new wanted coercion variable should be made mutable.
<a name="line-585"></a>[Notice though that evidence variables that bind coercion terms
<a name="line-586"></a> from super classes will be "given" and hence rigid]
<a name="line-587"></a>
<a name="line-588"></a>
<a name="line-589"></a>Note [KnownNat &amp; KnownSymbol and EvLit]
<a name="line-590"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-591"></a>A part of the type-level literals implementation are the classes
<a name="line-592"></a>"KnownNat" and "KnownSymbol", which provide a "smart" constructor for
<a name="line-593"></a>defining singleton values.  Here is the key stuff from GHC.TypeLits
<a name="line-594"></a>
<a name="line-595"></a>  class KnownNat (n :: Nat) where
<a name="line-596"></a>    natSing :: SNat n
<a name="line-597"></a>
<a name="line-598"></a>  newtype SNat (n :: Nat) = SNat Integer
<a name="line-599"></a>
<a name="line-600"></a>Conceptually, this class has infinitely many instances:
<a name="line-601"></a>
<a name="line-602"></a>  instance KnownNat 0       where natSing = SNat 0
<a name="line-603"></a>  instance KnownNat 1       where natSing = SNat 1
<a name="line-604"></a>  instance KnownNat 2       where natSing = SNat 2
<a name="line-605"></a>  ...
<a name="line-606"></a>
<a name="line-607"></a>In practice, we solve `KnownNat` predicates in the type-checker
<a name="line-608"></a>(see typecheck/TcInteract.hs) because we can't have infinitely many instances.
<a name="line-609"></a>The evidence (aka "dictionary") for `KnownNat` is of the form `EvLit (EvNum n)`.
<a name="line-610"></a>
<a name="line-611"></a>We make the following assumptions about dictionaries in GHC:
<a name="line-612"></a>  1. The "dictionary" for classes with a single method---like `KnownNat`---is
<a name="line-613"></a>     a newtype for the type of the method, so using a evidence amounts
<a name="line-614"></a>     to a coercion, and
<a name="line-615"></a>  2. Newtypes use the same representation as their definition types.
<a name="line-616"></a>
<a name="line-617"></a>So, the evidence for `KnownNat` is just a value of the representation type,
<a name="line-618"></a>wrapped in two newtype constructors: one to make it into a `SNat` value,
<a name="line-619"></a>and another to make it into a `KnownNat` dictionary.
<a name="line-620"></a>
<a name="line-621"></a>Also note that `natSing` and `SNat` are never actually exposed from the
<a name="line-622"></a>library---they are just an implementation detail.  Instead, users see
<a name="line-623"></a>a more convenient function, defined in terms of `natSing`:
<a name="line-624"></a>
<a name="line-625"></a>  natVal :: KnownNat n =&gt; proxy n -&gt; Integer
<a name="line-626"></a>
<a name="line-627"></a>The reason we don't use this directly in the class is that it is simpler
<a name="line-628"></a>and more efficient to pass around an integer rather than an entier function,
<a name="line-629"></a>especially when the `KnowNat` evidence is packaged up in an existential.
<a name="line-630"></a>
<a name="line-631"></a>The story for kind `Symbol` is analogous:
<a name="line-632"></a>  * class KnownSymbol
<a name="line-633"></a>  * newtype SSymbol
<a name="line-634"></a>  * Evidence: EvLit (EvStr n)
<a name="line-635"></a>
<a name="line-636"></a>
<a name="line-637"></a>Note [Overview of implicit CallStacks]
<a name="line-638"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-639"></a>(See https://ghc.haskell.org/trac/ghc/wiki/ExplicitCallStack/ImplicitLocations)
<a name="line-640"></a>
<a name="line-641"></a>The goal of CallStack evidence terms is to reify locations
<a name="line-642"></a>in the program source as runtime values, without any support
<a name="line-643"></a>from the RTS. We accomplish this by assigning a special meaning
<a name="line-644"></a>to constraints of type GHC.Stack.Types.HasCallStack, an alias
<a name="line-645"></a>
<a name="line-646"></a>  type HasCallStack = (?callStack :: CallStack)
<a name="line-647"></a>
<a name="line-648"></a>Implicit parameters of type GHC.Stack.Types.CallStack (the name is not
<a name="line-649"></a>important) are solved in three steps:
<a name="line-650"></a>
<a name="line-651"></a>1. Occurrences of CallStack IPs are solved directly from the given IP,
<a name="line-652"></a>   just like a regular IP. For example, the occurrence of `?stk` in
<a name="line-653"></a>
<a name="line-654"></a>     error :: (?stk :: CallStack) =&gt; String -&gt; a
<a name="line-655"></a>     error s = raise (ErrorCall (s ++ prettyCallStack ?stk))
<a name="line-656"></a>
<a name="line-657"></a>   will be solved for the `?stk` in `error`s context as before.
<a name="line-658"></a>
<a name="line-659"></a>2. In a function call, instead of simply passing the given IP, we first
<a name="line-660"></a>   append the current call-site to it. For example, consider a
<a name="line-661"></a>   call to the callstack-aware `error` above.
<a name="line-662"></a>
<a name="line-663"></a>     undefined :: (?stk :: CallStack) =&gt; a
<a name="line-664"></a>     undefined = error "undefined!"
<a name="line-665"></a>
<a name="line-666"></a>   Here we want to take the given `?stk` and append the current
<a name="line-667"></a>   call-site, before passing it to `error`. In essence, we want to
<a name="line-668"></a>   rewrite `error "undefined!"` to
<a name="line-669"></a>
<a name="line-670"></a>     let ?stk = pushCallStack &lt;error's location&gt; ?stk
<a name="line-671"></a>     in error "undefined!"
<a name="line-672"></a>
<a name="line-673"></a>   We achieve this effect by emitting a NEW wanted
<a name="line-674"></a>
<a name="line-675"></a>     [W] d :: IP "stk" CallStack
<a name="line-676"></a>
<a name="line-677"></a>   from which we build the evidence term
<a name="line-678"></a>
<a name="line-679"></a>     EvCsPushCall "error" &lt;error's location&gt; (EvId d)
<a name="line-680"></a>
<a name="line-681"></a>   that we use to solve the call to `error`. The new wanted `d` will
<a name="line-682"></a>   then be solved per rule (1), ie as a regular IP.
<a name="line-683"></a>
<a name="line-684"></a>   (see TcInteract.interactDict)
<a name="line-685"></a>
<a name="line-686"></a>3. We default any insoluble CallStacks to the empty CallStack. Suppose
<a name="line-687"></a>   `undefined` did not request a CallStack, ie
<a name="line-688"></a>
<a name="line-689"></a>     undefinedNoStk :: a
<a name="line-690"></a>     undefinedNoStk = error "undefined!"
<a name="line-691"></a>
<a name="line-692"></a>   Under the usual IP rules, the new wanted from rule (2) would be
<a name="line-693"></a>   insoluble as there's no given IP from which to solve it, so we
<a name="line-694"></a>   would get an "unbound implicit parameter" error.
<a name="line-695"></a>
<a name="line-696"></a>   We don't ever want to emit an insoluble CallStack IP, so we add a
<a name="line-697"></a>   defaulting pass to default any remaining wanted CallStacks to the
<a name="line-698"></a>   empty CallStack with the evidence term
<a name="line-699"></a>
<a name="line-700"></a>     EvCsEmpty
<a name="line-701"></a>
<a name="line-702"></a>   (see TcSimplify.simpl_top and TcSimplify.defaultCallStacks)
<a name="line-703"></a>
<a name="line-704"></a>This provides a lightweight mechanism for building up call-stacks
<a name="line-705"></a>explicitly, but is notably limited by the fact that the stack will
<a name="line-706"></a>stop at the first function whose type does not include a CallStack IP.
<a name="line-707"></a>For example, using the above definition of `undefined`:
<a name="line-708"></a>
<a name="line-709"></a>  head :: [a] -&gt; a
<a name="line-710"></a>  head []    = undefined
<a name="line-711"></a>  head (x:_) = x
<a name="line-712"></a>
<a name="line-713"></a>  g = head []
<a name="line-714"></a>
<a name="line-715"></a>the resulting CallStack will include the call to `undefined` in `head`
<a name="line-716"></a>and the call to `error` in `undefined`, but *not* the call to `head`
<a name="line-717"></a>in `g`, because `head` did not explicitly request a CallStack.
<a name="line-718"></a>
<a name="line-719"></a>
<a name="line-720"></a>Important Details:
<a name="line-721"></a>- GHC should NEVER report an insoluble CallStack constraint.
<a name="line-722"></a>
<a name="line-723"></a>- GHC should NEVER infer a CallStack constraint unless one was requested
<a name="line-724"></a>  with a partial type signature (See TcType.pickQuantifiablePreds).
<a name="line-725"></a>
<a name="line-726"></a>- A CallStack (defined in GHC.Stack.Types) is a [(String, SrcLoc)],
<a name="line-727"></a>  where the String is the name of the binder that is used at the
<a name="line-728"></a>  SrcLoc. SrcLoc is also defined in GHC.Stack.Types and contains the
<a name="line-729"></a>  package/module/file name, as well as the full source-span. Both
<a name="line-730"></a>  CallStack and SrcLoc are kept abstract so only GHC can construct new
<a name="line-731"></a>  values.
<a name="line-732"></a>
<a name="line-733"></a>- We will automatically solve any wanted CallStack regardless of the
<a name="line-734"></a>  name of the IP, i.e.
<a name="line-735"></a>
<a name="line-736"></a>    f = show (?stk :: CallStack)
<a name="line-737"></a>    g = show (?loc :: CallStack)
<a name="line-738"></a>
<a name="line-739"></a>  are both valid. However, we will only push new SrcLocs onto existing
<a name="line-740"></a>  CallStacks when the IP names match, e.g. in
<a name="line-741"></a>
<a name="line-742"></a>    head :: (?loc :: CallStack) =&gt; [a] -&gt; a
<a name="line-743"></a>    head [] = error (show (?stk :: CallStack))
<a name="line-744"></a>
<a name="line-745"></a>  the printed CallStack will NOT include head's call-site. This reflects the
<a name="line-746"></a>  standard scoping rules of implicit-parameters.
<a name="line-747"></a>
<a name="line-748"></a>- An EvCallStack term desugars to a CoreExpr of type `IP "some str" CallStack`.
<a name="line-749"></a>  The desugarer will need to unwrap the IP newtype before pushing a new
<a name="line-750"></a>  call-site onto a given stack (See DsBinds.dsEvCallStack)
<a name="line-751"></a>
<a name="line-752"></a>- When we emit a new wanted CallStack from rule (2) we set its origin to
<a name="line-753"></a>  `IPOccOrigin ip_name` instead of the original `OccurrenceOf func`
<a name="line-754"></a>  (see TcInteract.interactDict).
<a name="line-755"></a>
<a name="line-756"></a>  This is a bit shady, but is how we ensure that the new wanted is
<a name="line-757"></a>  solved like a regular IP.
<a name="line-758"></a>
<a name="line-759"></a>-}</span>
<a name="line-760"></a>
<a name="line-761"></a><a name="mkEvCast"></a><span class='hs-definition'>mkEvCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-762"></a><span class='hs-definition'>mkEvCast</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>lco</span>
<a name="line-763"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span><span class='hs-varid'>tcCoercionRole</span> <span class='hs-varid'>lco</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Coercion of wrong role passed to mkEvCast:"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>lco</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-764"></a>    <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>lco</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span>
<a name="line-765"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvCast</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>lco</span>
<a name="line-766"></a>
<a name="line-767"></a><a name="mkEvScSelectors"></a><span class='hs-definition'>mkEvScSelectors</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-768"></a><span class='hs-definition'>mkEvScSelectors</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-769"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_pr</span> <span class='hs-layout'>(</span><span class='hs-varid'>immSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-770"></a>  <span class='hs-keyword'>where</span>
<a name="line-771"></a>    <span class='hs-varid'>mk_pr</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-772"></a>
<a name="line-773"></a><a name="emptyTcEvBinds"></a><span class='hs-definition'>emptyTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span>
<a name="line-774"></a><span class='hs-definition'>emptyTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBinds</span> <span class='hs-varid'>emptyBag</span>
<a name="line-775"></a>
<a name="line-776"></a><a name="isEmptyTcEvBinds"></a><span class='hs-definition'>isEmptyTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-777"></a><span class='hs-definition'>isEmptyTcEvBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>b</span>
<a name="line-778"></a><span class='hs-definition'>isEmptyTcEvBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"isEmptyTcEvBinds"</span>
<a name="line-779"></a>
<a name="line-780"></a>
<a name="line-781"></a><a name="evTermCoercion"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-782"></a><span class='hs-comment'>-- Applied only to EvTerms of type (s~t)</span>
<a name="line-783"></a><span class='hs-comment'>-- See Note [Coercion evidence terms]</span>
<a name="line-784"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>v</span>
<a name="line-785"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-786"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>evTermCoercion</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-787"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"evTermCoercion"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-788"></a>
<a name="line-789"></a><a name="evVarsOfTerm"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-790"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span>
<a name="line-791"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-792"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>evs</span>
<a name="line-793"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>v</span>
<a name="line-794"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>tm</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-795"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDelayedError</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-796"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvLit</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-797"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCallStack</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfCallStack</span> <span class='hs-varid'>cs</span>
<a name="line-798"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTypeable</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTypeable</span> <span class='hs-varid'>ev</span>
<a name="line-799"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSelector</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>evs</span>
<a name="line-800"></a>
<a name="line-801"></a><a name="evVarsOfTerms"></a><span class='hs-definition'>evVarsOfTerms</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-802"></a><span class='hs-definition'>evVarsOfTerms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>evVarsOfTerm</span>
<a name="line-803"></a>
<a name="line-804"></a><a name="sccEvBinds"></a><span class='hs-comment'>-- | Do SCC analysis on a bag of 'EvBind's.</span>
<a name="line-805"></a><span class='hs-definition'>sccEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>EvBind</span><span class='hs-keyglyph'>]</span>
<a name="line-806"></a><span class='hs-definition'>sccEvBinds</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stronglyConnCompFromEdgedVerticesUniq</span> <span class='hs-varid'>edges</span>
<a name="line-807"></a>  <span class='hs-keyword'>where</span>
<a name="line-808"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-809"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mk_node</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>bs</span>
<a name="line-810"></a>
<a name="line-811"></a>    <span class='hs-varid'>mk_node</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-812"></a>    <span class='hs-varid'>mk_node</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>term</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-813"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>term</span> <span class='hs-varop'>`unionVarSet`</span>
<a name="line-814"></a>                                <span class='hs-varid'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-815"></a>      <span class='hs-comment'>-- It's OK to use nonDetEltsUniqSet here as stronglyConnCompFromEdgedVertices</span>
<a name="line-816"></a>      <span class='hs-comment'>-- is still deterministic even if the edges are in nondeterministic order</span>
<a name="line-817"></a>      <span class='hs-comment'>-- as explained in Note [Deterministic SCC] in Digraph.</span>
<a name="line-818"></a>
<a name="line-819"></a><a name="evVarsOfCallStack"></a><span class='hs-definition'>evVarsOfCallStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvCallStack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-820"></a><span class='hs-definition'>evVarsOfCallStack</span> <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cs</span> <span class='hs-keyword'>of</span>
<a name="line-821"></a>  <span class='hs-conid'>EvCsEmpty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-822"></a>  <span class='hs-conid'>EvCsPushCall</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>tm</span>
<a name="line-823"></a>
<a name="line-824"></a><a name="evVarsOfTypeable"></a><span class='hs-definition'>evVarsOfTypeable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTypeable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-825"></a><span class='hs-definition'>evVarsOfTypeable</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span>
<a name="line-826"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ev</span> <span class='hs-keyword'>of</span>
<a name="line-827"></a>    <span class='hs-conid'>EvTypeableTyCon</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>e</span>
<a name="line-828"></a>    <span class='hs-conid'>EvTypeableTyApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>evVarsOfTerms</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e1</span><span class='hs-layout'>,</span><span class='hs-varid'>e2</span><span class='hs-keyglyph'>]</span>
<a name="line-829"></a>    <span class='hs-conid'>EvTypeableTrFun</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>evVarsOfTerms</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e1</span><span class='hs-layout'>,</span><span class='hs-varid'>e2</span><span class='hs-keyglyph'>]</span>
<a name="line-830"></a>    <span class='hs-conid'>EvTypeableTyLit</span> <span class='hs-varid'>e</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>e</span>
<a name="line-831"></a>
<a name="line-832"></a><span class='hs-comment'>{-
<a name="line-833"></a>************************************************************************
<a name="line-834"></a>*                                                                      *
<a name="line-835"></a>                  Pretty printing
<a name="line-836"></a>*                                                                      *
<a name="line-837"></a>************************************************************************
<a name="line-838"></a>-}</span>
<a name="line-839"></a>
<a name="line-840"></a><a name="instance%20Outputable%20HsWrapper"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyword'>where</span>
<a name="line-841"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprHsWrapper</span> <span class='hs-varid'>co_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"&lt;&gt;"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-842"></a>
<a name="line-843"></a><a name="pprHsWrapper"></a><span class='hs-definition'>pprHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-844"></a><span class='hs-comment'>-- With -fprint-typechecker-elaboration, print the wrapper</span>
<a name="line-845"></a><span class='hs-comment'>--   otherwise just print what's inside</span>
<a name="line-846"></a><span class='hs-comment'>-- The pp_thing_inside function takes Bool to say whether</span>
<a name="line-847"></a><span class='hs-comment'>--    it's in a position that needs parens for a non-atomic thing</span>
<a name="line-848"></a><span class='hs-definition'>pprHsWrapper</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>pp_thing_inside</span>
<a name="line-849"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-850"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintTypecheckerElaboration</span> <span class='hs-varid'>dflags</span>
<a name="line-851"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>help</span> <span class='hs-varid'>pp_thing_inside</span> <span class='hs-varid'>wrap</span> <span class='hs-conid'>False</span>
<a name="line-852"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>pp_thing_inside</span> <span class='hs-conid'>False</span>
<a name="line-853"></a>  <span class='hs-keyword'>where</span>
<a name="line-854"></a>    <span class='hs-varid'>help</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-855"></a>    <span class='hs-comment'>-- True  &lt;=&gt; appears in function application position</span>
<a name="line-856"></a>    <span class='hs-comment'>-- False &lt;=&gt; appears as body of let or lambda</span>
<a name="line-857"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-conid'>WpHole</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>it</span>
<a name="line-858"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCompose</span> <span class='hs-varid'>f1</span> <span class='hs-varid'>f2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>help</span> <span class='hs-layout'>(</span><span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-varid'>f2</span><span class='hs-layout'>)</span> <span class='hs-varid'>f1</span>
<a name="line-859"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpFun</span> <span class='hs-varid'>f1</span> <span class='hs-varid'>f2</span> <span class='hs-varid'>t1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"\\(x"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>")."</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-860"></a>                                              <span class='hs-varid'>help</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>it</span> <span class='hs-conid'>True</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>help</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"x"</span><span class='hs-layout'>)</span> <span class='hs-varid'>f1</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-varid'>f2</span> <span class='hs-conid'>False</span>
<a name="line-861"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"|&gt;"</span>
<a name="line-862"></a>                                              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-863"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_parens</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-864"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_parens</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"@"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-865"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"\\"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-keyglyph'>]</span>
<a name="line-866"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"/\\"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-keyglyph'>]</span>
<a name="line-867"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpLet</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"let"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-keyglyph'>]</span>
<a name="line-868"></a>
<a name="line-869"></a>    <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprBndr</span> <span class='hs-conid'>LambdaBind</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dot</span>
<a name="line-870"></a>
<a name="line-871"></a><a name="add_parens"></a><span class='hs-definition'>add_parens</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_parens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-872"></a><span class='hs-definition'>add_parens</span> <span class='hs-varid'>d</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>d</span>
<a name="line-873"></a><span class='hs-definition'>add_parens</span> <span class='hs-varid'>d</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-874"></a><a name="no_parens"></a><span class='hs-definition'>no_parens</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-875"></a>
<a name="line-876"></a><a name="instance%20Outputable%20TcEvBinds"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyword'>where</span>
<a name="line-877"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-878"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"EvBinds"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-879"></a>
<a name="line-880"></a><a name="instance%20Outputable%20EvBindsVar"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyword'>where</span>
<a name="line-881"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindsVar</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ebv_uniq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-882"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"EvBindsVar"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-883"></a>
<a name="line-884"></a><a name="instance%20Uniquable%20EvBindsVar"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyword'>where</span>
<a name="line-885"></a>  <span class='hs-varid'>getUnique</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindsVar</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ebv_uniq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
<a name="line-886"></a>
<a name="line-887"></a><a name="instance%20Outputable%20EvBind"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyword'>where</span>
<a name="line-888"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_is_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_given</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-889"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pp_gw</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-890"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>]</span>
<a name="line-891"></a>     <span class='hs-keyword'>where</span>
<a name="line-892"></a>       <span class='hs-varid'>pp_gw</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>is_given</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'G'</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'W'</span><span class='hs-layout'>)</span>
<a name="line-893"></a>   <span class='hs-comment'>-- We cheat a bit and pretend EqVars are CoVars for the purposes of pretty printing</span>
<a name="line-894"></a>
<a name="line-895"></a><a name="instance%20Outputable%20EvTerm"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyword'>where</span>
<a name="line-896"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-897"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"`cast`"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span>
<a name="line-898"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CO"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span>
<a name="line-899"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>d</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"sc"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-900"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-varid'>df</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>df</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>]</span>
<a name="line-901"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span>
<a name="line-902"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCallStack</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cs</span>
<a name="line-903"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDelayedError</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>     <span class='hs-varid'>text</span> <span class='hs-str'>"error"</span>
<a name="line-904"></a>                                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>]</span>
<a name="line-905"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTypeable</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Typeable"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-906"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSelector</span> <span class='hs-varid'>sel</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sel</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ts</span><span class='hs-keyglyph'>]</span>
<a name="line-907"></a>
<a name="line-908"></a><a name="instance%20Outputable%20EvLit"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvLit</span> <span class='hs-keyword'>where</span>
<a name="line-909"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvNum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>integer</span> <span class='hs-varid'>n</span>
<a name="line-910"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvStr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-911"></a>
<a name="line-912"></a><a name="instance%20Outputable%20EvCallStack"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvCallStack</span> <span class='hs-keyword'>where</span>
<a name="line-913"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>EvCsEmpty</span>
<a name="line-914"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[]"</span>
<a name="line-915"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCsPushCall</span> <span class='hs-varid'>name</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-916"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tm</span>
<a name="line-917"></a>
<a name="line-918"></a><a name="instance%20Outputable%20EvTypeable"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvTypeable</span> <span class='hs-keyword'>where</span>
<a name="line-919"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTypeableTyCon</span> <span class='hs-varid'>ts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TyCon"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ts</span>
<a name="line-920"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTypeableTyApp</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-921"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTypeableTrFun</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>arrow</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-922"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTypeableTyLit</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TyLit"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span>
<a name="line-923"></a>
<a name="line-924"></a>
<a name="line-925"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-926"></a><span class='hs-comment'>-- Helper functions for dealing with IP newtype-dictionaries</span>
<a name="line-927"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-928"></a>
<a name="line-929"></a><a name="unwrapIP"></a><span class='hs-comment'>-- | Create a 'Coercion' that unwraps an implicit-parameter or</span>
<a name="line-930"></a><span class='hs-comment'>-- overloaded-label dictionary to expose the underlying value. We</span>
<a name="line-931"></a><span class='hs-comment'>-- expect the 'Type' to have the form `IP sym ty` or `IsLabel sym ty`,</span>
<a name="line-932"></a><span class='hs-comment'>-- and return a 'Coercion' `co :: IP sym ty ~ ty` or</span>
<a name="line-933"></a><span class='hs-comment'>-- `co :: IsLabel sym ty ~ Proxy# sym -&gt; ty`.  See also</span>
<a name="line-934"></a><span class='hs-comment'>-- Note [Type-checking overloaded labels] in TcExpr.</span>
<a name="line-935"></a><span class='hs-definition'>unwrapIP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionR</span>
<a name="line-936"></a><span class='hs-definition'>unwrapIP</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-937"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>unwrapNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-938"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span> <span class='hs-conid'>[]</span>
<a name="line-939"></a>    <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"unwrapIP"</span> <span class='hs-varop'>$</span>
<a name="line-940"></a>                       <span class='hs-varid'>text</span> <span class='hs-str'>"The dictionary for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-941"></a>                         <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is not a newtype!"</span>
<a name="line-942"></a>  <span class='hs-keyword'>where</span>
<a name="line-943"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-varid'>ty</span>
<a name="line-944"></a>
<a name="line-945"></a><a name="wrapIP"></a><span class='hs-comment'>-- | Create a 'Coercion' that wraps a value in an implicit-parameter</span>
<a name="line-946"></a><span class='hs-comment'>-- dictionary. See 'unwrapIP'.</span>
<a name="line-947"></a><span class='hs-definition'>wrapIP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionR</span>
<a name="line-948"></a><span class='hs-definition'>wrapIP</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>unwrapIP</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre></body>
</html>
