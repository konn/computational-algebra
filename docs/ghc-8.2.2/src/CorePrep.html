<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>coreSyn/CorePrep.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow, 1994-2006
<a name="line-3"></a>
<a name="line-4"></a>
<a name="line-5"></a>Core pass to saturate constructors and PrimOps
<a name="line-6"></a>-}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns, CPP, MultiWayIf #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CorePrep</span> <span class='hs-layout'>(</span>
<a name="line-11"></a>      <span class='hs-varid'>corePrepPgm</span><span class='hs-layout'>,</span> <span class='hs-varid'>corePrepExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cvtLitInteger</span><span class='hs-layout'>,</span>
<a name="line-12"></a>      <span class='hs-varid'>lookupMkIntegerName</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupIntegerSDataConName</span>
<a name="line-13"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccurAnal</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkId</span>             <span class='hs-layout'>(</span> <span class='hs-varid'>realWorldPrimId</span> <span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreMonad</span>        <span class='hs-layout'>(</span> <span class='hs-conid'>CoreToDo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreLint</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>endPassIO</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSubst</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkCore</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- We use our own FloatBind here</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OrdList</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Config</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>             <span class='hs-layout'>(</span> <span class='hs-conid'>NamedThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>realSrcLocSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRealSrcLoc</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bits</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-layout'>)</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-comment'>{-
<a name="line-65"></a>-- ---------------------------------------------------------------------------
<a name="line-66"></a>-- Overview
<a name="line-67"></a>-- ---------------------------------------------------------------------------
<a name="line-68"></a>
<a name="line-69"></a>The goal of this pass is to prepare for code generation.
<a name="line-70"></a>
<a name="line-71"></a>1.  Saturate constructor and primop applications.
<a name="line-72"></a>
<a name="line-73"></a>2.  Convert to A-normal form; that is, function arguments
<a name="line-74"></a>    are always variables.
<a name="line-75"></a>
<a name="line-76"></a>    * Use case for strict arguments:
<a name="line-77"></a>        f E ==&gt; case E of x -&gt; f x
<a name="line-78"></a>        (where f is strict)
<a name="line-79"></a>
<a name="line-80"></a>    * Use let for non-trivial lazy arguments
<a name="line-81"></a>        f E ==&gt; let x = E in f x
<a name="line-82"></a>        (were f is lazy and x is non-trivial)
<a name="line-83"></a>
<a name="line-84"></a>3.  Similarly, convert any unboxed lets into cases.
<a name="line-85"></a>    [I'm experimenting with leaving 'ok-for-speculation'
<a name="line-86"></a>     rhss in let-form right up to this point.]
<a name="line-87"></a>
<a name="line-88"></a>4.  Ensure that *value* lambdas only occur as the RHS of a binding
<a name="line-89"></a>    (The code generator can't deal with anything else.)
<a name="line-90"></a>    Type lambdas are ok, however, because the code gen discards them.
<a name="line-91"></a>
<a name="line-92"></a>5.  [Not any more; nuked Jun 2002] Do the seq/par munging.
<a name="line-93"></a>
<a name="line-94"></a>6.  Clone all local Ids.
<a name="line-95"></a>    This means that all such Ids are unique, rather than the
<a name="line-96"></a>    weaker guarantee of no clashes which the simplifier provides.
<a name="line-97"></a>    And that is what the code generator needs.
<a name="line-98"></a>
<a name="line-99"></a>    We don't clone TyVars or CoVars. The code gen doesn't need that,
<a name="line-100"></a>    and doing so would be tiresome because then we'd need
<a name="line-101"></a>    to substitute in types and coercions.
<a name="line-102"></a>
<a name="line-103"></a>7.  Give each dynamic CCall occurrence a fresh unique; this is
<a name="line-104"></a>    rather like the cloning step above.
<a name="line-105"></a>
<a name="line-106"></a>8.  Inject bindings for the "implicit" Ids:
<a name="line-107"></a>        * Constructor wrappers
<a name="line-108"></a>        * Constructor workers
<a name="line-109"></a>    We want curried definitions for all of these in case they
<a name="line-110"></a>    aren't inlined by some caller.
<a name="line-111"></a>
<a name="line-112"></a>9.  Replace (lazy e) by e.  See Note [lazyId magic] in MkId.hs
<a name="line-113"></a>    Also replace (noinline e) by e.
<a name="line-114"></a>
<a name="line-115"></a>10. Convert (LitInteger i t) into the core representation
<a name="line-116"></a>    for the Integer i. Normally this uses mkInteger, but if
<a name="line-117"></a>    we are using the integer-gmp implementation then there is a
<a name="line-118"></a>    special case where we use the S# constructor for Integers that
<a name="line-119"></a>    are in the range of Int.
<a name="line-120"></a>
<a name="line-121"></a>11. Uphold tick consistency while doing this: We move ticks out of
<a name="line-122"></a>    (non-type) applications where we can, and make sure that we
<a name="line-123"></a>    annotate according to scoping rules when floating.
<a name="line-124"></a>
<a name="line-125"></a>This is all done modulo type applications and abstractions, so that
<a name="line-126"></a>when type erasure is done for conversion to STG, we don't end up with
<a name="line-127"></a>any trivial or useless bindings.
<a name="line-128"></a>
<a name="line-129"></a>
<a name="line-130"></a>Note [CorePrep invariants]
<a name="line-131"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-132"></a>Here is the syntax of the Core produced by CorePrep:
<a name="line-133"></a>
<a name="line-134"></a>    Trivial expressions
<a name="line-135"></a>       arg ::= lit |  var
<a name="line-136"></a>              | arg ty  |  /\a. arg
<a name="line-137"></a>              | truv co  |  /\c. arg  |  arg |&gt; co
<a name="line-138"></a>
<a name="line-139"></a>    Applications
<a name="line-140"></a>       app ::= lit  |  var  |  app arg  |  app ty  | app co | app |&gt; co
<a name="line-141"></a>
<a name="line-142"></a>    Expressions
<a name="line-143"></a>       body ::= app
<a name="line-144"></a>              | let(rec) x = rhs in body     -- Boxed only
<a name="line-145"></a>              | case body of pat -&gt; body
<a name="line-146"></a>              | /\a. body | /\c. body
<a name="line-147"></a>              | body |&gt; co
<a name="line-148"></a>
<a name="line-149"></a>    Right hand sides (only place where value lambdas can occur)
<a name="line-150"></a>       rhs ::= /\a.rhs  |  \x.rhs  |  body
<a name="line-151"></a>
<a name="line-152"></a>We define a synonym for each of these non-terminals.  Functions
<a name="line-153"></a>with the corresponding name produce a result in that syntax.
<a name="line-154"></a>-}</span>
<a name="line-155"></a>
<a name="line-156"></a><a name="CpeArg"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CpeArg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- Non-terminal 'arg'</span>
<a name="line-157"></a><a name="CpeApp"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CpeApp</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- Non-terminal 'app'</span>
<a name="line-158"></a><a name="CpeBody"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CpeBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- Non-terminal 'body'</span>
<a name="line-159"></a><a name="CpeRhs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CpeRhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- Non-terminal 'rhs'</span>
<a name="line-160"></a>
<a name="line-161"></a><span class='hs-comment'>{-
<a name="line-162"></a>************************************************************************
<a name="line-163"></a>*                                                                      *
<a name="line-164"></a>                Top level stuff
<a name="line-165"></a>*                                                                      *
<a name="line-166"></a>************************************************************************
<a name="line-167"></a>-}</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="corePrepPgm"></a><span class='hs-definition'>corePrepPgm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span>
<a name="line-170"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-171"></a><span class='hs-definition'>corePrepPgm</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>mod_loc</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>data_tycons</span> <span class='hs-keyglyph'>=</span>
<a name="line-172"></a>    <span class='hs-varid'>withTiming</span> <span class='hs-layout'>(</span><span class='hs-varid'>pure</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-173"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"CorePrep"</span><span class='hs-varop'>&lt;+&gt;</span><span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-174"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-175"></a>    <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSplitUniqSupply</span> <span class='hs-chr'>'s'</span>
<a name="line-176"></a>    <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkInitialCorePrepEnv</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-177"></a>
<a name="line-178"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>implicit_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDataConWorkers</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mod_loc</span> <span class='hs-varid'>data_tycons</span>
<a name="line-179"></a>            <span class='hs-comment'>-- NB: we must feed mkImplicitBinds through corePrep too</span>
<a name="line-180"></a>            <span class='hs-comment'>-- so that they are suitably cloned and eta-expanded</span>
<a name="line-181"></a>
<a name="line-182"></a>        <span class='hs-varid'>binds_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initUs_</span> <span class='hs-varid'>us</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-183"></a>                      <span class='hs-varid'>floats1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>corePrepTopBinds</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>binds</span>
<a name="line-184"></a>                      <span class='hs-varid'>floats2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>corePrepTopBinds</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>implicit_binds</span>
<a name="line-185"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>deFloatTop</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>floats2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-186"></a>
<a name="line-187"></a>    <span class='hs-varid'>endPassIO</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>alwaysQualify</span> <span class='hs-conid'>CorePrep</span> <span class='hs-varid'>binds_out</span> <span class='hs-conid'>[]</span>
<a name="line-188"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>binds_out</span>
<a name="line-189"></a>  <span class='hs-keyword'>where</span>
<a name="line-190"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="corePrepExpr"></a><span class='hs-definition'>corePrepExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-193"></a><span class='hs-definition'>corePrepExpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span>
<a name="line-194"></a>    <span class='hs-varid'>withTiming</span> <span class='hs-layout'>(</span><span class='hs-varid'>pure</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"CorePrep [expr]"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-195"></a>    <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSplitUniqSupply</span> <span class='hs-chr'>'s'</span>
<a name="line-196"></a>    <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkInitialCorePrepEnv</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-197"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initUs_</span> <span class='hs-varid'>us</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpeBodyNF</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-198"></a>    <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_prep</span> <span class='hs-str'>"CorePrep"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_expr</span><span class='hs-layout'>)</span>
<a name="line-199"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>new_expr</span>
<a name="line-200"></a>
<a name="line-201"></a><a name="corePrepTopBinds"></a><span class='hs-definition'>corePrepTopBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>Floats</span>
<a name="line-202"></a><span class='hs-comment'>-- Note [Floating out of top level bindings]</span>
<a name="line-203"></a><span class='hs-definition'>corePrepTopBinds</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>binds</span>
<a name="line-204"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>binds</span>
<a name="line-205"></a>  <span class='hs-keyword'>where</span>
<a name="line-206"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>emptyFloats</span>
<a name="line-207"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-conop'>:</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_new_bind</span><span class='hs-layout'>)</span>
<a name="line-208"></a>                                 <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBind</span> <span class='hs-conid'>TopLevel</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bind</span>
<a name="line-209"></a>                               <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>isNothing</span> <span class='hs-varid'>maybe_new_bind</span><span class='hs-layout'>)</span>
<a name="line-210"></a>                                 <span class='hs-comment'>-- Only join points get returned this way by</span>
<a name="line-211"></a>                                 <span class='hs-comment'>-- cpeBind, and no join point may float to top</span>
<a name="line-212"></a>                               <span class='hs-varid'>floatss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>binds</span>
<a name="line-213"></a>                               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>floatss</span><span class='hs-layout'>)</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="mkDataConWorkers"></a><span class='hs-definition'>mkDataConWorkers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-216"></a><span class='hs-comment'>-- See Note [Data constructor workers]</span>
<a name="line-217"></a><span class='hs-comment'>-- c.f. Note [Injecting implicit bindings] in TidyPgm</span>
<a name="line-218"></a><span class='hs-definition'>mkDataConWorkers</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mod_loc</span> <span class='hs-varid'>data_tycons</span>
<a name="line-219"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>tick_it</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-220"></a>                                <span class='hs-comment'>-- The ice is thin here, but it works</span>
<a name="line-221"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>data_tycons</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- CorePrep will eta-expand it</span>
<a name="line-222"></a>      <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-223"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConWorkId</span> <span class='hs-varid'>data_con</span>
<a name="line-224"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-225"></a> <span class='hs-keyword'>where</span>
<a name="line-226"></a>   <span class='hs-comment'>-- If we want to generate debug info, we put a source note on the</span>
<a name="line-227"></a>   <span class='hs-comment'>-- worker. This is useful, especially for heap profiling.</span>
<a name="line-228"></a>   <span class='hs-varid'>tick_it</span> <span class='hs-varid'>name</span>
<a name="line-229"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugLevel</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-230"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RealSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-varid'>name</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>span</span>
<a name="line-231"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ml_hs_file</span> <span class='hs-varid'>mod_loc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tick</span> <span class='hs-layout'>(</span><span class='hs-varid'>span1</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span>
<a name="line-232"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tick</span> <span class='hs-layout'>(</span><span class='hs-varid'>span1</span> <span class='hs-str'>"???"</span><span class='hs-layout'>)</span>
<a name="line-233"></a>     <span class='hs-keyword'>where</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>span</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-conid'>SourceNote</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-234"></a>           <span class='hs-varid'>span1</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realSrcLocSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkRealSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span>
<a name="line-235"></a>
<a name="line-236"></a><span class='hs-comment'>{-
<a name="line-237"></a>Note [Floating out of top level bindings]
<a name="line-238"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-239"></a>NB: we do need to float out of top-level bindings
<a name="line-240"></a>Consider        x = length [True,False]
<a name="line-241"></a>We want to get
<a name="line-242"></a>                s1 = False : []
<a name="line-243"></a>                s2 = True  : s1
<a name="line-244"></a>                x  = length s2
<a name="line-245"></a>
<a name="line-246"></a>We return a *list* of bindings, because we may start with
<a name="line-247"></a>        x* = f (g y)
<a name="line-248"></a>where x is demanded, in which case we want to finish with
<a name="line-249"></a>        a = g y
<a name="line-250"></a>        x* = f a
<a name="line-251"></a>And then x will actually end up case-bound
<a name="line-252"></a>
<a name="line-253"></a>Note [CafInfo and floating]
<a name="line-254"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-255"></a>What happens when we try to float bindings to the top level?  At this
<a name="line-256"></a>point all the CafInfo is supposed to be correct, and we must make certain
<a name="line-257"></a>that is true of the new top-level bindings.  There are two cases
<a name="line-258"></a>to consider
<a name="line-259"></a>
<a name="line-260"></a>a) The top-level binding is marked asCafRefs.  In that case we are
<a name="line-261"></a>   basically fine.  The floated bindings had better all be lazy lets,
<a name="line-262"></a>   so they can float to top level, but they'll all have HasCafRefs
<a name="line-263"></a>   (the default) which is safe.
<a name="line-264"></a>
<a name="line-265"></a>b) The top-level binding is marked NoCafRefs.  This really happens
<a name="line-266"></a>   Example.  CoreTidy produces
<a name="line-267"></a>      $fApplicativeSTM [NoCafRefs] = D:Alternative retry# ...blah...
<a name="line-268"></a>   Now CorePrep has to eta-expand to
<a name="line-269"></a>      $fApplicativeSTM = let sat = \xy. retry x y
<a name="line-270"></a>                         in D:Alternative sat ...blah...
<a name="line-271"></a>   So what we *want* is
<a name="line-272"></a>      sat [NoCafRefs] = \xy. retry x y
<a name="line-273"></a>      $fApplicativeSTM [NoCafRefs] = D:Alternative sat ...blah...
<a name="line-274"></a>
<a name="line-275"></a>   So, gruesomely, we must set the NoCafRefs flag on the sat bindings,
<a name="line-276"></a>   *and* substitute the modified 'sat' into the old RHS.
<a name="line-277"></a>
<a name="line-278"></a>   It should be the case that 'sat' is itself [NoCafRefs] (a value, no
<a name="line-279"></a>   cafs) else the original top-level binding would not itself have been
<a name="line-280"></a>   marked [NoCafRefs].  The DEBUG check in CoreToStg for
<a name="line-281"></a>   consistentCafInfo will find this.
<a name="line-282"></a>
<a name="line-283"></a>This is all very gruesome and horrible. It would be better to figure
<a name="line-284"></a>out CafInfo later, after CorePrep.  We'll do that in due course.
<a name="line-285"></a>Meanwhile this horrible hack works.
<a name="line-286"></a>
<a name="line-287"></a>Note [Join points and floating]
<a name="line-288"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-289"></a>Join points can float out of other join points but not out of value bindings:
<a name="line-290"></a>
<a name="line-291"></a>  let z =
<a name="line-292"></a>    let  w = ... in -- can float
<a name="line-293"></a>    join k = ... in -- can't float
<a name="line-294"></a>    ... jump k ...
<a name="line-295"></a>  join j x1 ... xn =
<a name="line-296"></a>    let  y = ... in -- can float (but don't want to)
<a name="line-297"></a>    join h = ... in -- can float (but not much point)
<a name="line-298"></a>    ... jump h ...
<a name="line-299"></a>  in ...
<a name="line-300"></a>
<a name="line-301"></a>Here, the jump to h remains valid if h is floated outward, but the jump to k
<a name="line-302"></a>does not.
<a name="line-303"></a>
<a name="line-304"></a>We don't float *out* of join points. It would only be safe to float out of
<a name="line-305"></a>nullary join points (or ones where the arguments are all either type arguments
<a name="line-306"></a>or dead binders). Nullary join points aren't ever recursive, so they're always
<a name="line-307"></a>effectively one-shot functions, which we don't float out of. We *could* float
<a name="line-308"></a>join points from nullary join points, but there's no clear benefit at this
<a name="line-309"></a>stage.
<a name="line-310"></a>
<a name="line-311"></a>Note [Data constructor workers]
<a name="line-312"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-313"></a>Create any necessary "implicit" bindings for data con workers.  We
<a name="line-314"></a>create the rather strange (non-recursive!) binding
<a name="line-315"></a>
<a name="line-316"></a>        $wC = \x y -&gt; $wC x y
<a name="line-317"></a>
<a name="line-318"></a>i.e. a curried constructor that allocates.  This means that we can
<a name="line-319"></a>treat the worker for a constructor like any other function in the rest
<a name="line-320"></a>of the compiler.  The point here is that CoreToStg will generate a
<a name="line-321"></a>StgConApp for the RHS, rather than a call to the worker (which would
<a name="line-322"></a>give a loop).  As Lennart says: the ice is thin here, but it works.
<a name="line-323"></a>
<a name="line-324"></a>Hmm.  Should we create bindings for dictionary constructors?  They are
<a name="line-325"></a>always fully applied, and the bindings are just there to support
<a name="line-326"></a>partial applications. But it's easier to let them through.
<a name="line-327"></a>
<a name="line-328"></a>
<a name="line-329"></a>Note [Dead code in CorePrep]
<a name="line-330"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-331"></a>Imagine that we got an input program like this (see Trac #4962):
<a name="line-332"></a>
<a name="line-333"></a>  f :: Show b =&gt; Int -&gt; (Int, b -&gt; Maybe Int -&gt; Int)
<a name="line-334"></a>  f x = (g True (Just x) + g () (Just x), g)
<a name="line-335"></a>    where
<a name="line-336"></a>      g :: Show a =&gt; a -&gt; Maybe Int -&gt; Int
<a name="line-337"></a>      g _ Nothing = x
<a name="line-338"></a>      g y (Just z) = if z &gt; 100 then g y (Just (z + length (show y))) else g y unknown
<a name="line-339"></a>
<a name="line-340"></a>After specialisation and SpecConstr, we would get something like this:
<a name="line-341"></a>
<a name="line-342"></a>  f :: Show b =&gt; Int -&gt; (Int, b -&gt; Maybe Int -&gt; Int)
<a name="line-343"></a>  f x = (g$Bool_True_Just x + g$Unit_Unit_Just x, g)
<a name="line-344"></a>    where
<a name="line-345"></a>      {-# RULES g $dBool = g$Bool
<a name="line-346"></a>                g $dUnit = g$Unit #-}
<a name="line-347"></a>      g = ...
<a name="line-348"></a>      {-# RULES forall x. g$Bool True (Just x) = g$Bool_True_Just x #-}
<a name="line-349"></a>      g$Bool = ...
<a name="line-350"></a>      {-# RULES forall x. g$Unit () (Just x) = g$Unit_Unit_Just x #-}
<a name="line-351"></a>      g$Unit = ...
<a name="line-352"></a>      g$Bool_True_Just = ...
<a name="line-353"></a>      g$Unit_Unit_Just = ...
<a name="line-354"></a>
<a name="line-355"></a>Note that the g$Bool and g$Unit functions are actually dead code: they
<a name="line-356"></a>are only kept alive by the occurrence analyser because they are
<a name="line-357"></a>referred to by the rules of g, which is being kept alive by the fact
<a name="line-358"></a>that it is used (unspecialised) in the returned pair.
<a name="line-359"></a>
<a name="line-360"></a>However, at the CorePrep stage there is no way that the rules for g
<a name="line-361"></a>will ever fire, and it really seems like a shame to produce an output
<a name="line-362"></a>program that goes to the trouble of allocating a closure for the
<a name="line-363"></a>unreachable g$Bool and g$Unit functions.
<a name="line-364"></a>
<a name="line-365"></a>The way we fix this is to:
<a name="line-366"></a> * In cloneBndr, drop all unfoldings/rules
<a name="line-367"></a>
<a name="line-368"></a> * In deFloatTop, run a simple dead code analyser on each top-level
<a name="line-369"></a>   RHS to drop the dead local bindings. For that call to OccAnal, we
<a name="line-370"></a>   disable the binder swap, else the occurrence analyser sometimes
<a name="line-371"></a>   introduces new let bindings for cased binders, which lead to the bug
<a name="line-372"></a>   in #5433.
<a name="line-373"></a>
<a name="line-374"></a>The reason we don't just OccAnal the whole output of CorePrep is that
<a name="line-375"></a>the tidier ensures that all top-level binders are GlobalIds, so they
<a name="line-376"></a>don't show up in the free variables any longer. So if you run the
<a name="line-377"></a>occurrence analyser on the output of CoreTidy (or later) you e.g. turn
<a name="line-378"></a>this program:
<a name="line-379"></a>
<a name="line-380"></a>  Rec {
<a name="line-381"></a>  f = ... f ...
<a name="line-382"></a>  }
<a name="line-383"></a>
<a name="line-384"></a>Into this one:
<a name="line-385"></a>
<a name="line-386"></a>  f = ... f ...
<a name="line-387"></a>
<a name="line-388"></a>(Since f is not considered to be free in its own RHS.)
<a name="line-389"></a>
<a name="line-390"></a>
<a name="line-391"></a>************************************************************************
<a name="line-392"></a>*                                                                      *
<a name="line-393"></a>                The main code
<a name="line-394"></a>*                                                                      *
<a name="line-395"></a>************************************************************************
<a name="line-396"></a>-}</span>
<a name="line-397"></a>
<a name="line-398"></a><a name="cpeBind"></a><span class='hs-definition'>cpeBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span>
<a name="line-399"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepEnv</span><span class='hs-layout'>,</span>
<a name="line-400"></a>                   <span class='hs-conid'>Floats</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Floating value bindings</span>
<a name="line-401"></a>                   <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Just bind' &lt;=&gt; returned new bind; no float</span>
<a name="line-402"></a>                                   <span class='hs-comment'>-- Nothing &lt;=&gt; added bind' to floats instead</span>
<a name="line-403"></a><span class='hs-definition'>cpeBind</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-404"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJoinId</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-405"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span>
<a name="line-406"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dmd</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idDemandInfo</span> <span class='hs-varid'>bndr</span>
<a name="line-407"></a>             <span class='hs-varid'>is_unlifted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnliftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-408"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpePair</span> <span class='hs-varid'>top_lvl</span> <span class='hs-conid'>NonRecursive</span>
<a name="line-409"></a>                                          <span class='hs-varid'>dmd</span>
<a name="line-410"></a>                                          <span class='hs-varid'>is_unlifted</span>
<a name="line-411"></a>                                          <span class='hs-varid'>env</span> <span class='hs-varid'>bndr1</span> <span class='hs-varid'>rhs</span>
<a name="line-412"></a>       <span class='hs-comment'>-- See Note [Inlining in CorePrep]</span>
<a name="line-413"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>rhs2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isNotTopLevel</span> <span class='hs-varid'>top_lvl</span>
<a name="line-414"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnvExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-415"></a>            <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-416"></a>
<a name="line-417"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_float</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFloat</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>bndr2</span> <span class='hs-varid'>rhs2</span>
<a name="line-418"></a>
<a name="line-419"></a>        <span class='hs-comment'>-- We want bndr'' in the envt, because it records</span>
<a name="line-420"></a>        <span class='hs-comment'>-- the evaluated-ness of the binder</span>
<a name="line-421"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bndr2</span><span class='hs-layout'>,</span>
<a name="line-422"></a>                 <span class='hs-varid'>addFloat</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>new_float</span><span class='hs-layout'>,</span>
<a name="line-423"></a>                 <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-424"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- See Note [Join points and floating]</span>
<a name="line-425"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- can't have top-level join point</span>
<a name="line-426"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span>
<a name="line-427"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeJoinPair</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr1</span> <span class='hs-varid'>rhs</span>
<a name="line-428"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bndr2</span><span class='hs-layout'>,</span>
<a name="line-429"></a>                 <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span>
<a name="line-430"></a>                 <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr2</span> <span class='hs-varid'>rhs1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-431"></a>
<a name="line-432"></a><span class='hs-definition'>cpeBind</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-433"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJoinId</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-434"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs</span>
<a name="line-435"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpePair</span> <span class='hs-varid'>top_lvl</span> <span class='hs-conid'>Recursive</span> <span class='hs-varid'>topDmd</span> <span class='hs-conid'>False</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs1</span> <span class='hs-varid'>rhss</span>
<a name="line-436"></a>
<a name="line-437"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhss2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip3</span> <span class='hs-varid'>stuff</span>
<a name="line-438"></a>             <span class='hs-varid'>all_pairs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrOL</span> <span class='hs-varid'>add_float</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs2</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rhss2</span><span class='hs-layout'>)</span>
<a name="line-439"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>concatFloats</span> <span class='hs-varid'>floats_s</span><span class='hs-layout'>)</span>
<a name="line-440"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnvList</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>bndrs2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-441"></a>                 <span class='hs-varid'>unitFloat</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>all_pairs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-442"></a>                 <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-443"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- See Note [Join points and floating]</span>
<a name="line-444"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs</span>
<a name="line-445"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>pairs1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpeJoinPair</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs1</span> <span class='hs-varid'>rhss</span>
<a name="line-446"></a>
<a name="line-447"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndrs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>pairs1</span>
<a name="line-448"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnvList</span> <span class='hs-varid'>env'</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>bndrs2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-449"></a>                 <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span>
<a name="line-450"></a>                 <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-451"></a>  <span class='hs-keyword'>where</span>
<a name="line-452"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pairs</span>
<a name="line-453"></a>
<a name="line-454"></a>        <span class='hs-comment'>-- Flatten all the floats, and the current</span>
<a name="line-455"></a>        <span class='hs-comment'>-- group into a single giant Rec</span>
<a name="line-456"></a>    <span class='hs-varid'>add_float</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>prs2</span>
<a name="line-457"></a>    <span class='hs-varid'>add_float</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-varid'>prs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prs2</span>
<a name="line-458"></a>    <span class='hs-varid'>add_float</span> <span class='hs-varid'>b</span>                       <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"cpeBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-459"></a>
<a name="line-460"></a><a name="cpePair"></a><span class='hs-comment'>---------------</span>
<a name="line-461"></a><span class='hs-definition'>cpePair</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-462"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-463"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-464"></a><span class='hs-comment'>-- Used for all bindings</span>
<a name="line-465"></a><span class='hs-definition'>cpePair</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>is_rec</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span>
<a name="line-466"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJoinId</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- those should use cpeJoinPair</span>
<a name="line-467"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rhs</span>
<a name="line-468"></a>
<a name="line-469"></a>       <span class='hs-comment'>-- See if we are allowed to float this stuff out of the RHS</span>
<a name="line-470"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>float_from_rhs</span> <span class='hs-varid'>floats1</span> <span class='hs-varid'>rhs1</span>
<a name="line-471"></a>
<a name="line-472"></a>       <span class='hs-comment'>-- Make the arity match up</span>
<a name="line-473"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats3</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs3</span><span class='hs-layout'>)</span>
<a name="line-474"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>rhs1</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>arity</span>
<a name="line-475"></a>               <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span>
<a name="line-476"></a>               <span class='hs-keyword'>else</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CorePrep: silly extra arguments:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-477"></a>                               <span class='hs-comment'>-- Note [Silly extra arguments]</span>
<a name="line-478"></a>                    <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-479"></a>                        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>float</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFloat</span> <span class='hs-varid'>topDmd</span> <span class='hs-conid'>False</span> <span class='hs-varid'>v</span> <span class='hs-varid'>rhs2</span>
<a name="line-480"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>addFloat</span> <span class='hs-varid'>floats2</span> <span class='hs-varid'>float</span>
<a name="line-481"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-482"></a>
<a name="line-483"></a>        <span class='hs-comment'>-- Wrap floating ticks</span>
<a name="line-484"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats4</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTicks</span> <span class='hs-varid'>floats3</span> <span class='hs-varid'>rhs3</span>
<a name="line-485"></a>
<a name="line-486"></a>        <span class='hs-comment'>-- Record if the binder is evaluated</span>
<a name="line-487"></a>        <span class='hs-comment'>-- and otherwise trim off the unfolding altogether</span>
<a name="line-488"></a>        <span class='hs-comment'>-- It's not used by the code generator; getting rid of it reduces</span>
<a name="line-489"></a>        <span class='hs-comment'>-- heap usage and, since we may be changing uniques, we'd have</span>
<a name="line-490"></a>        <span class='hs-comment'>-- to substitute to keep it right</span>
<a name="line-491"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>rhs3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>evaldUnfolding</span>
<a name="line-492"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-493"></a>
<a name="line-494"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats4</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs4</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-495"></a>  <span class='hs-keyword'>where</span>
<a name="line-496"></a>    <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_dynFlags</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-497"></a>
<a name="line-498"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>bndr</span>        <span class='hs-comment'>-- We must match this arity</span>
<a name="line-499"></a>
<a name="line-500"></a>    <span class='hs-comment'>---------------------</span>
<a name="line-501"></a>    <span class='hs-varid'>float_from_rhs</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-502"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyFloats</span> <span class='hs-varid'>floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-503"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>float_top</span>    <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-504"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>float_nested</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-505"></a>
<a name="line-506"></a>    <span class='hs-comment'>---------------------</span>
<a name="line-507"></a>    <span class='hs-varid'>float_nested</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-508"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>wantFloatNested</span> <span class='hs-varid'>is_rec</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-509"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-510"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dontFloat</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-511"></a>
<a name="line-512"></a>    <span class='hs-comment'>---------------------</span>
<a name="line-513"></a>    <span class='hs-varid'>float_top</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>        <span class='hs-comment'>-- Urhgh!  See Note [CafInfo and floating]</span>
<a name="line-514"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-515"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>allLazyTop</span> <span class='hs-varid'>floats</span>
<a name="line-516"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-517"></a>
<a name="line-518"></a>      <span class='hs-comment'>-- So the top-level binding is marked NoCafRefs</span>
<a name="line-519"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>canFloatFromNoCaf</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-520"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-521"></a>
<a name="line-522"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-523"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dontFloat</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-524"></a>
<a name="line-525"></a><a name="dontFloat"></a><span class='hs-definition'>dontFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeBody</span><span class='hs-layout'>)</span>
<a name="line-526"></a><span class='hs-comment'>-- Non-empty floats, but do not want to float from rhs</span>
<a name="line-527"></a><span class='hs-comment'>-- So wrap the rhs in the floats</span>
<a name="line-528"></a><span class='hs-comment'>-- But: rhs1 might have lambdas, and we can't</span>
<a name="line-529"></a><span class='hs-comment'>--      put them inside a wrapBinds</span>
<a name="line-530"></a><span class='hs-definition'>dontFloat</span> <span class='hs-varid'>floats1</span> <span class='hs-varid'>rhs</span>
<a name="line-531"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBody</span> <span class='hs-varid'>rhs</span>
<a name="line-532"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapBinds</span> <span class='hs-varid'>floats1</span> <span class='hs-varop'>$</span>
<a name="line-533"></a>                               <span class='hs-varid'>wrapBinds</span> <span class='hs-varid'>floats2</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-534"></a>
<a name="line-535"></a><span class='hs-comment'>{- Note [Silly extra arguments]
<a name="line-536"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-537"></a>Suppose we had this
<a name="line-538"></a>        f{arity=1} = \x\y. e
<a name="line-539"></a>We *must* match the arity on the Id, so we have to generate
<a name="line-540"></a>        f' = \x\y. e
<a name="line-541"></a>        f  = \x. f' x
<a name="line-542"></a>
<a name="line-543"></a>It's a bizarre case: why is the arity on the Id wrong?  Reason
<a name="line-544"></a>(in the days of __inline_me__):
<a name="line-545"></a>        f{arity=0} = __inline_me__ (let v = expensive in \xy. e)
<a name="line-546"></a>When InlineMe notes go away this won't happen any more.  But
<a name="line-547"></a>it seems good for CorePrep to be robust.
<a name="line-548"></a>-}</span>
<a name="line-549"></a>
<a name="line-550"></a><a name="cpeJoinPair"></a><span class='hs-comment'>---------------</span>
<a name="line-551"></a><span class='hs-definition'>cpeJoinPair</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JoinId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-552"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>JoinId</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-553"></a><span class='hs-comment'>-- Used for all join bindings</span>
<a name="line-554"></a><span class='hs-definition'>cpeJoinPair</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span>
<a name="line-555"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>isJoinId</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-556"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>join_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJoinId_maybe</span> <span class='hs-varid'>bndr</span>
<a name="line-557"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectNBinders</span> <span class='hs-varid'>join_arity</span> <span class='hs-varid'>rhs</span>
<a name="line-558"></a>
<a name="line-559"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs</span>
<a name="line-560"></a>
<a name="line-561"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBodyNF</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>body</span> <span class='hs-comment'>-- Will let-bind the body if it starts</span>
<a name="line-562"></a>                                      <span class='hs-comment'>-- with a lambda</span>
<a name="line-563"></a>
<a name="line-564"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreLams</span> <span class='hs-varid'>bndrs'</span> <span class='hs-varid'>body'</span>
<a name="line-565"></a>             <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>evaldUnfolding</span>
<a name="line-566"></a>                          <span class='hs-varop'>`setIdArity`</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>bndrs</span>
<a name="line-567"></a>                            <span class='hs-comment'>-- See Note [Arity and join points]</span>
<a name="line-568"></a>
<a name="line-569"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-570"></a>
<a name="line-571"></a><span class='hs-comment'>{-
<a name="line-572"></a>Note [Arity and join points]
<a name="line-573"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-574"></a>
<a name="line-575"></a>Up to now, we've allowed a join point to have an arity greater than its join
<a name="line-576"></a>arity (minus type arguments), since this is what's useful for eta expansion.
<a name="line-577"></a>However, for code gen purposes, its arity must be exactly the number of value
<a name="line-578"></a>arguments it will be called with, and it must have exactly that many value
<a name="line-579"></a>lambdas. Hence if there are extra lambdas we must let-bind the body of the RHS:
<a name="line-580"></a>
<a name="line-581"></a>  join j x y z = \w -&gt; ... in ...
<a name="line-582"></a>    =&gt;
<a name="line-583"></a>  join j x y z = (let f = \w -&gt; ... in f) in ...
<a name="line-584"></a>
<a name="line-585"></a>This is also what happens with Note [Silly extra arguments]. Note that it's okay
<a name="line-586"></a>for us to mess with the arity because a join point is never exported.
<a name="line-587"></a>-}</span>
<a name="line-588"></a>
<a name="line-589"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-590"></a><span class='hs-comment'>--              CpeRhs: produces a result satisfying CpeRhs</span>
<a name="line-591"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-592"></a>
<a name="line-593"></a><a name="cpeRhsE"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-594"></a><span class='hs-comment'>-- If</span>
<a name="line-595"></a><span class='hs-comment'>--      e  ===&gt;  (bs, e')</span>
<a name="line-596"></a><span class='hs-comment'>-- then</span>
<a name="line-597"></a><span class='hs-comment'>--      e = let bs in e'        (semantically, that is!)</span>
<a name="line-598"></a><span class='hs-comment'>--</span>
<a name="line-599"></a><span class='hs-comment'>-- For example</span>
<a name="line-600"></a><span class='hs-comment'>--      f (g x)   ===&gt;   ([v = g x], f v)</span>
<a name="line-601"></a>
<a name="line-602"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-603"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-604"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitInteger</span> <span class='hs-varid'>i</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-605"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtLitInteger</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_dynFlags</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getMkIntegerId</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-606"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>cpe_integerSDataCon</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-607"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-608"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-609"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-610"></a>
<a name="line-611"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-612"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_bind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBind</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bind</span>
<a name="line-613"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>body_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>body</span>
<a name="line-614"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_bind'</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>bind'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>bind'</span> <span class='hs-varid'>body'</span>
<a name="line-615"></a>                                         <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>body'</span>
<a name="line-616"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_floats</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>body_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-617"></a>
<a name="line-618"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-619"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tickishPlace</span> <span class='hs-varid'>tickish</span> <span class='hs-varop'>==</span> <span class='hs-conid'>PlaceNonLam</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tickish</span> <span class='hs-varop'>`tickishScopesLike`</span> <span class='hs-conid'>SoftScope</span>
<a name="line-620"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-621"></a>         <span class='hs-comment'>-- See [Floating Ticks in CorePrep]</span>
<a name="line-622"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFloat</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatTick</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-623"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-624"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBodyNF</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-625"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTick</span> <span class='hs-varid'>tickish'</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-626"></a>  <span class='hs-keyword'>where</span>
<a name="line-627"></a>    <span class='hs-varid'>tickish'</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tickish</span>
<a name="line-628"></a>             <span class='hs-comment'>-- See also 'substTickish'</span>
<a name="line-629"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getIdFromTrivialExpr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lookupCorePrepEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-630"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-631"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tickish</span>
<a name="line-632"></a>
<a name="line-633"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-634"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-635"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cast</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-636"></a>
<a name="line-637"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-638"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span><span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>expr</span>
<a name="line-639"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs</span>
<a name="line-640"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBodyNF</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>body</span>
<a name="line-641"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>bndrs'</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-642"></a>
<a name="line-643"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-644"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBody</span> <span class='hs-varid'>env</span> <span class='hs-varid'>scrut</span>
<a name="line-645"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndr1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>evaldUnfolding</span>
<a name="line-646"></a>            <span class='hs-comment'>-- Record that the case binder is evaluated in the alternatives</span>
<a name="line-647"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr1</span>
<a name="line-648"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>alts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>sat_alt</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-649"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>bndr2</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-650"></a>  <span class='hs-keyword'>where</span>
<a name="line-651"></a>    <span class='hs-varid'>sat_alt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-652"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span>
<a name="line-653"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBodyNF</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>rhs</span>
<a name="line-654"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-655"></a>
<a name="line-656"></a><a name="cvtLitInteger"></a><span class='hs-definition'>cvtLitInteger</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-657"></a><span class='hs-comment'>-- Here we convert a literal Integer to the low-level</span>
<a name="line-658"></a><span class='hs-comment'>-- representation. Exactly how we do this depends on the</span>
<a name="line-659"></a><span class='hs-comment'>-- library that implements Integer.  If it's GMP we</span>
<a name="line-660"></a><span class='hs-comment'>-- use the S# data constructor for small literals.</span>
<a name="line-661"></a><span class='hs-comment'>-- See Note [Integer literals] in Literal</span>
<a name="line-662"></a><span class='hs-definition'>cvtLitInteger</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>sdatacon</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-663"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inIntRange</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-- Special case for small integers</span>
<a name="line-664"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkConApp</span> <span class='hs-varid'>sdatacon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMachInt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-665"></a>
<a name="line-666"></a><span class='hs-definition'>cvtLitInteger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mk_integer</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span>
<a name="line-667"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>mk_integer</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>isNonNegative</span><span class='hs-layout'>,</span> <span class='hs-varid'>ints</span><span class='hs-keyglyph'>]</span>
<a name="line-668"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>isNonNegative</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mkConApp</span> <span class='hs-varid'>falseDataCon</span> <span class='hs-conid'>[]</span>
<a name="line-669"></a>                                 <span class='hs-keyword'>else</span> <span class='hs-varid'>mkConApp</span> <span class='hs-varid'>trueDataCon</span>  <span class='hs-conid'>[]</span>
<a name="line-670"></a>        <span class='hs-varid'>ints</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkListExpr</span> <span class='hs-varid'>intTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>abs</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-671"></a>        <span class='hs-varid'>f</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-672"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>low</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>.&amp;.</span> <span class='hs-varid'>mask</span>
<a name="line-673"></a>                  <span class='hs-varid'>high</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`shiftR`</span> <span class='hs-varid'>bits</span>
<a name="line-674"></a>              <span class='hs-keyword'>in</span> <span class='hs-varid'>mkConApp</span> <span class='hs-varid'>intDataCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMachInt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>low</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-conop'>:</span> <span class='hs-varid'>f</span> <span class='hs-varid'>high</span>
<a name="line-675"></a>        <span class='hs-varid'>bits</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>31</span>
<a name="line-676"></a>        <span class='hs-varid'>mask</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span> <span class='hs-varop'>^</span> <span class='hs-varid'>bits</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-677"></a>
<a name="line-678"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-679"></a><span class='hs-comment'>--              CpeBody: produces a result satisfying CpeBody</span>
<a name="line-680"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-681"></a>
<a name="line-682"></a><a name="cpeBodyNF"></a><span class='hs-comment'>-- | Convert a 'CoreExpr' so it satisfies 'CpeBody', without</span>
<a name="line-683"></a><span class='hs-comment'>-- producing any floats (any generated floats are immediately</span>
<a name="line-684"></a><span class='hs-comment'>-- let-bound using 'wrapBinds').  Generally you want this, esp.</span>
<a name="line-685"></a><span class='hs-comment'>-- when you've reached a binding form (e.g., a lambda) and</span>
<a name="line-686"></a><span class='hs-comment'>-- floating any further would be incorrect.</span>
<a name="line-687"></a><span class='hs-definition'>cpeBodyNF</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CpeBody</span>
<a name="line-688"></a><span class='hs-definition'>cpeBodyNF</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-689"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBody</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-690"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapBinds</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-691"></a>
<a name="line-692"></a><a name="cpeBody"></a><span class='hs-comment'>-- | Convert a 'CoreExpr' so it satisfies 'CpeBody'; also produce</span>
<a name="line-693"></a><span class='hs-comment'>-- a list of 'Floats' which are being propagated upwards.  In</span>
<a name="line-694"></a><span class='hs-comment'>-- fact, this function is used in only two cases: to</span>
<a name="line-695"></a><span class='hs-comment'>-- implement 'cpeBodyNF' (which is what you usually want),</span>
<a name="line-696"></a><span class='hs-comment'>-- and in the case when a let-binding is in a case scrutinee--here,</span>
<a name="line-697"></a><span class='hs-comment'>-- we can always float out:</span>
<a name="line-698"></a><span class='hs-comment'>--</span>
<a name="line-699"></a><span class='hs-comment'>--      case (let x = y in z) of ...</span>
<a name="line-700"></a><span class='hs-comment'>--      ==&gt; let x = y in case z of ...</span>
<a name="line-701"></a><span class='hs-comment'>--</span>
<a name="line-702"></a><span class='hs-definition'>cpeBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeBody</span><span class='hs-layout'>)</span>
<a name="line-703"></a><span class='hs-definition'>cpeBody</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-704"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-705"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBody</span> <span class='hs-varid'>rhs</span>
<a name="line-706"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-707"></a>
<a name="line-708"></a><a name="rhsToBody"></a><span class='hs-comment'>--------</span>
<a name="line-709"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeBody</span><span class='hs-layout'>)</span>
<a name="line-710"></a><span class='hs-comment'>-- Remove top level lambdas by let-binding</span>
<a name="line-711"></a>
<a name="line-712"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-713"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tickishScoped</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-conid'>NoScope</span>  <span class='hs-comment'>-- only float out of non-scoped annotations</span>
<a name="line-714"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBody</span> <span class='hs-varid'>expr</span>
<a name="line-715"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-716"></a>
<a name="line-717"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-718"></a>        <span class='hs-comment'>-- You can get things like</span>
<a name="line-719"></a>        <span class='hs-comment'>--      case e of { p -&gt; coerce t (\s -&gt; ...) }</span>
<a name="line-720"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBody</span> <span class='hs-varid'>e</span>
<a name="line-721"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cast</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-722"></a>
<a name="line-723"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-724"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>no_lam_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryEtaReducePrep</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body</span>
<a name="line-725"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_lam_result</span><span class='hs-layout'>)</span>
<a name="line-726"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>bndrs</span>           <span class='hs-comment'>-- Type lambdas are ok</span>
<a name="line-727"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-728"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-comment'>-- Some value lambdas</span>
<a name="line-729"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-730"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprArity</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span>
<a name="line-731"></a>             <span class='hs-varid'>float</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-732"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFloat</span> <span class='hs-varid'>float</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-733"></a>  <span class='hs-keyword'>where</span>
<a name="line-734"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span><span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>expr</span>
<a name="line-735"></a>
<a name="line-736"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-737"></a>
<a name="line-738"></a>
<a name="line-739"></a>
<a name="line-740"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-741"></a><span class='hs-comment'>--              CpeApp: produces a result satisfying CpeApp</span>
<a name="line-742"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-743"></a>
<a name="line-744"></a><a name="ArgInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArgInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CpeApp</span>  <span class='hs-conid'>CoreArg</span>
<a name="line-745"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CpeCast</span> <span class='hs-conid'>Coercion</span>
<a name="line-746"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CpeTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tickish</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-747"></a>
<a name="line-748"></a><span class='hs-comment'>{- Note [runRW arg]
<a name="line-749"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-750"></a>If we got, say
<a name="line-751"></a>   runRW# (case bot of {})
<a name="line-752"></a>which happened in Trac #11291, we do /not/ want to turn it into
<a name="line-753"></a>   (case bot of {}) realWorldPrimId#
<a name="line-754"></a>because that gives a panic in CoreToStg.myCollectArgs, which expects
<a name="line-755"></a>only variables in function position.  But if we are sure to make
<a name="line-756"></a>runRW# strict (which we do in MkId), this can't happen
<a name="line-757"></a>-}</span>
<a name="line-758"></a>
<a name="line-759"></a><a name="cpeApp"></a><span class='hs-definition'>cpeApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-760"></a><span class='hs-comment'>-- May return a CpeRhs because of saturating primops</span>
<a name="line-761"></a><span class='hs-definition'>cpeApp</span> <span class='hs-varid'>top_env</span> <span class='hs-varid'>expr</span>
<a name="line-762"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>terminal</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>depth</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collect_args</span> <span class='hs-varid'>expr</span>
<a name="line-763"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cpe_app</span> <span class='hs-varid'>top_env</span> <span class='hs-varid'>terminal</span> <span class='hs-varid'>args</span> <span class='hs-varid'>depth</span>
<a name="line-764"></a>       <span class='hs-layout'>}</span>
<a name="line-765"></a>
<a name="line-766"></a>  <span class='hs-keyword'>where</span>
<a name="line-767"></a>    <span class='hs-comment'>-- We have a nested data structure of the form</span>
<a name="line-768"></a>    <span class='hs-comment'>-- e `App` a1 `App` a2 ... `App` an, convert it into</span>
<a name="line-769"></a>    <span class='hs-comment'>-- (e, [CpeApp a1, CpeApp a2, ..., CpeApp an], depth)</span>
<a name="line-770"></a>    <span class='hs-comment'>-- We use 'ArgInfo' because we may also need to</span>
<a name="line-771"></a>    <span class='hs-comment'>-- record casts and ticks.  Depth counts the number</span>
<a name="line-772"></a>    <span class='hs-comment'>-- of arguments that would consume strictness information</span>
<a name="line-773"></a>    <span class='hs-comment'>-- (so, no type or coercion arguments.)</span>
<a name="line-774"></a>    <span class='hs-varid'>collect_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-775"></a>    <span class='hs-varid'>collect_args</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-conid'>[]</span> <span class='hs-num'>0</span>
<a name="line-776"></a>      <span class='hs-keyword'>where</span>
<a name="line-777"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>as</span> <span class='hs-varop'>!</span><span class='hs-varid'>depth</span>
<a name="line-778"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>CpeApp</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-779"></a>                <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isTyCoArg</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>depth</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>depth</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-780"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>as</span> <span class='hs-varid'>depth</span>
<a name="line-781"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>CpeCast</span> <span class='hs-varid'>co</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-varid'>depth</span>
<a name="line-782"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>depth</span>
<a name="line-783"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tickishPlace</span> <span class='hs-varid'>tickish</span> <span class='hs-varop'>==</span> <span class='hs-conid'>PlaceNonLam</span>
<a name="line-784"></a>            <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tickish</span> <span class='hs-varop'>`tickishScopesLike`</span> <span class='hs-conid'>SoftScope</span>
<a name="line-785"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>CpeTick</span> <span class='hs-varid'>tickish</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-varid'>depth</span>
<a name="line-786"></a>        <span class='hs-varid'>go</span> <span class='hs-varid'>terminal</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>terminal</span><span class='hs-layout'>,</span> <span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>depth</span><span class='hs-layout'>)</span>
<a name="line-787"></a>
<a name="line-788"></a>    <span class='hs-varid'>cpe_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span>
<a name="line-789"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-790"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-791"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-792"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-793"></a>    <span class='hs-varid'>cpe_app</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CpeApp</span> <span class='hs-conid'>Type</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-conid'>CpeApp</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>depth</span>
<a name="line-794"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>lazyIdKey</span>          <span class='hs-comment'>-- Replace (lazy a) with a, and</span>
<a name="line-795"></a>       <span class='hs-varop'>||</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>noinlineIdKey</span>      <span class='hs-comment'>-- Replace (noinline a) with a</span>
<a name="line-796"></a>        <span class='hs-comment'>-- Consider the code:</span>
<a name="line-797"></a>        <span class='hs-comment'>--</span>
<a name="line-798"></a>        <span class='hs-comment'>--      lazy (f x) y</span>
<a name="line-799"></a>        <span class='hs-comment'>--</span>
<a name="line-800"></a>        <span class='hs-comment'>-- We need to make sure that we need to recursively collect arguments on</span>
<a name="line-801"></a>        <span class='hs-comment'>-- "f x", otherwise we'll float "f x" out (it's not a variable) and</span>
<a name="line-802"></a>        <span class='hs-comment'>-- end up with this awful -ddump-prep:</span>
<a name="line-803"></a>        <span class='hs-comment'>--</span>
<a name="line-804"></a>        <span class='hs-comment'>--      case f x of f_x {</span>
<a name="line-805"></a>        <span class='hs-comment'>--        __DEFAULT -&gt; f_x y</span>
<a name="line-806"></a>        <span class='hs-comment'>--      }</span>
<a name="line-807"></a>        <span class='hs-comment'>--</span>
<a name="line-808"></a>        <span class='hs-comment'>-- rather than the far superior "f x y".  Test case is par01.</span>
<a name="line-809"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>terminal</span><span class='hs-layout'>,</span> <span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>depth'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collect_args</span> <span class='hs-varid'>arg</span>
<a name="line-810"></a>          <span class='hs-keyword'>in</span> <span class='hs-varid'>cpe_app</span> <span class='hs-varid'>env</span> <span class='hs-varid'>terminal</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>depth</span> <span class='hs-varop'>+</span> <span class='hs-varid'>depth'</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-811"></a>    <span class='hs-varid'>cpe_app</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CpeApp</span> <span class='hs-sel'>_runtimeRep</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Type</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeApp</span> <span class='hs-sel'>_type</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Type</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeApp</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-num'>1</span>
<a name="line-812"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>runRWKey</span>
<a name="line-813"></a>        <span class='hs-comment'>-- Replace (runRW# f) by (f realWorld#), beta reducing if possible (this</span>
<a name="line-814"></a>        <span class='hs-comment'>-- is why we return a CorePrepEnv as well)</span>
<a name="line-815"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>of</span>
<a name="line-816"></a>            <span class='hs-conid'>Lam</span> <span class='hs-varid'>s</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cpe_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s</span> <span class='hs-varid'>realWorldPrimId</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span> <span class='hs-conid'>[]</span> <span class='hs-num'>0</span>
<a name="line-817"></a>            <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cpe_app</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CpeApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>realWorldPrimId</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-num'>1</span>
<a name="line-818"></a>    <span class='hs-varid'>cpe_app</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>depth</span>
<a name="line-819"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fiddleCCall</span> <span class='hs-varid'>v</span>
<a name="line-820"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>e2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupCorePrepEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v1</span>
<a name="line-821"></a>                 <span class='hs-varid'>hd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getIdFromTrivialExpr_maybe</span> <span class='hs-varid'>e2</span>
<a name="line-822"></a>           <span class='hs-comment'>-- NB: depth from collect_args is right, because e2 is a trivial expression</span>
<a name="line-823"></a>           <span class='hs-comment'>-- and thus its embedded Id *must* be at the same depth as any</span>
<a name="line-824"></a>           <span class='hs-comment'>-- Apps it is under are type applications only (c.f.</span>
<a name="line-825"></a>           <span class='hs-comment'>-- exprIsTrivial).  But note that we need the type of the</span>
<a name="line-826"></a>           <span class='hs-comment'>-- expression, not the id.</span>
<a name="line-827"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>app</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rebuild_app</span> <span class='hs-varid'>args</span> <span class='hs-varid'>e2</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyFloats</span> <span class='hs-varid'>stricts</span>
<a name="line-828"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mb_saturate</span> <span class='hs-varid'>hd</span> <span class='hs-varid'>app</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>depth</span> <span class='hs-layout'>}</span>
<a name="line-829"></a>        <span class='hs-keyword'>where</span>
<a name="line-830"></a>          <span class='hs-varid'>stricts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idStrictness</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>of</span>
<a name="line-831"></a>                            <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>demands</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-832"></a>                              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>listLengthCmp</span> <span class='hs-varid'>demands</span> <span class='hs-varid'>depth</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>demands</span>
<a name="line-833"></a>                                    <span class='hs-comment'>-- length demands &lt;= depth</span>
<a name="line-834"></a>                              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-835"></a>                <span class='hs-comment'>-- If depth &lt; length demands, then we have too few args to</span>
<a name="line-836"></a>                <span class='hs-comment'>-- satisfy strictness  info so we have to  ignore all the</span>
<a name="line-837"></a>                <span class='hs-comment'>-- strictness info, e.g. + (error "urk")</span>
<a name="line-838"></a>                <span class='hs-comment'>-- Here, we can't evaluate the arg strictly, because this</span>
<a name="line-839"></a>                <span class='hs-comment'>-- partial application might be seq'd</span>
<a name="line-840"></a>
<a name="line-841"></a>        <span class='hs-comment'>-- We inlined into something that's not a var and has no args.</span>
<a name="line-842"></a>        <span class='hs-comment'>-- Bounce it back up to cpeRhsE.</span>
<a name="line-843"></a>    <span class='hs-varid'>cpe_app</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span>
<a name="line-844"></a>
<a name="line-845"></a>        <span class='hs-comment'>-- N-variable fun, better let-bind it</span>
<a name="line-846"></a>    <span class='hs-varid'>cpe_app</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span> <span class='hs-varid'>depth</span>
<a name="line-847"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeArg</span> <span class='hs-varid'>env</span> <span class='hs-varid'>evalDmd</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>ty</span>
<a name="line-848"></a>                          <span class='hs-comment'>-- The evalDmd says that it's sure to be evaluated,</span>
<a name="line-849"></a>                          <span class='hs-comment'>-- so we'll end up case-binding it</span>
<a name="line-850"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>app</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rebuild_app</span> <span class='hs-varid'>args</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>fun_floats</span> <span class='hs-conid'>[]</span>
<a name="line-851"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mb_saturate</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>app</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>depth</span> <span class='hs-layout'>}</span>
<a name="line-852"></a>        <span class='hs-keyword'>where</span>
<a name="line-853"></a>          <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>fun</span>
<a name="line-854"></a>
<a name="line-855"></a>    <span class='hs-comment'>-- Saturate if necessary</span>
<a name="line-856"></a>    <span class='hs-varid'>mb_saturate</span> <span class='hs-varid'>head</span> <span class='hs-varid'>app</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>depth</span> <span class='hs-keyglyph'>=</span>
<a name="line-857"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>head</span> <span class='hs-keyword'>of</span>
<a name="line-858"></a>         <span class='hs-conid'>Just</span> <span class='hs-varid'>fn_id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sat_app</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeSaturate</span> <span class='hs-varid'>fn_id</span> <span class='hs-varid'>app</span> <span class='hs-varid'>depth</span>
<a name="line-859"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>sat_app</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-860"></a>         <span class='hs-sel'>_other</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>app</span><span class='hs-layout'>)</span>
<a name="line-861"></a>
<a name="line-862"></a>    <span class='hs-comment'>-- Deconstruct and rebuild the application, floating any non-atomic</span>
<a name="line-863"></a>    <span class='hs-comment'>-- arguments to the outside.  We collect the type of the expression,</span>
<a name="line-864"></a>    <span class='hs-comment'>-- the head of the application, and the number of actual value arguments,</span>
<a name="line-865"></a>    <span class='hs-comment'>-- all of which are used to possibly saturate this application if it</span>
<a name="line-866"></a>    <span class='hs-comment'>-- has a constructor or primop at the head.</span>
<a name="line-867"></a>    <span class='hs-varid'>rebuild_app</span>
<a name="line-868"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgInfo</span><span class='hs-keyglyph'>]</span>                  <span class='hs-comment'>-- The arguments (inner to outer)</span>
<a name="line-869"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeApp</span>
<a name="line-870"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-871"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span>
<a name="line-872"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>
<a name="line-873"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CpeApp</span><span class='hs-layout'>,</span> <span class='hs-conid'>Floats</span><span class='hs-layout'>)</span>
<a name="line-874"></a>    <span class='hs-varid'>rebuild_app</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>app</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-875"></a>      <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- make sure we used all the strictness info</span>
<a name="line-876"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>app</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span>
<a name="line-877"></a>    <span class='hs-varid'>rebuild_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>of</span>
<a name="line-878"></a>      <span class='hs-conid'>CpeApp</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-879"></a>        <span class='hs-varid'>rebuild_app</span> <span class='hs-keyword'>as</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>piResultTy</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>ss</span>
<a name="line-880"></a>      <span class='hs-conid'>CpeApp</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-881"></a>        <span class='hs-varid'>rebuild_app</span> <span class='hs-keyword'>as</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>funResultTy</span> <span class='hs-varid'>fun_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>ss</span>
<a name="line-882"></a>      <span class='hs-conid'>CpeApp</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-883"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ss1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss_rest</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [lazyId magic] in MkId</span>
<a name="line-884"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>isLazyExpr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-885"></a>                   <span class='hs-layout'>(</span><span class='hs-keyword'>_</span>   <span class='hs-conop'>:</span> <span class='hs-varid'>ss_rest</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>topDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss_rest</span><span class='hs-layout'>)</span>
<a name="line-886"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>ss1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ss_rest</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ss1</span><span class='hs-layout'>,</span>    <span class='hs-varid'>ss_rest</span><span class='hs-layout'>)</span>
<a name="line-887"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>            <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>topDmd</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-888"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"cpeBody:collect_args"</span> <span class='hs-varop'>$</span>
<a name="line-889"></a>                               <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>fun_ty</span>
<a name="line-890"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeArg</span> <span class='hs-varid'>top_env</span> <span class='hs-varid'>ss1</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_ty</span>
<a name="line-891"></a>        <span class='hs-varid'>rebuild_app</span> <span class='hs-keyword'>as</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span> <span class='hs-varid'>ss_rest</span>
<a name="line-892"></a>      <span class='hs-conid'>CpeCast</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-893"></a>        <span class='hs-keyword'>let</span> <span class='hs-conid'>Pair</span> <span class='hs-sel'>_ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-894"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>rebuild_app</span> <span class='hs-keyword'>as</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>ss</span>
<a name="line-895"></a>      <span class='hs-conid'>CpeTick</span> <span class='hs-varid'>tickish</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-896"></a>        <span class='hs-comment'>-- See [Floating Ticks in CorePrep]</span>
<a name="line-897"></a>        <span class='hs-varid'>rebuild_app</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>fun_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>addFloat</span> <span class='hs-varid'>floats</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatTick</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ss</span>
<a name="line-898"></a>
<a name="line-899"></a><a name="isLazyExpr"></a><span class='hs-definition'>isLazyExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-900"></a><span class='hs-comment'>-- See Note [lazyId magic] in MkId</span>
<a name="line-901"></a><span class='hs-definition'>isLazyExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLazyExpr</span> <span class='hs-varid'>e</span>
<a name="line-902"></a><span class='hs-definition'>isLazyExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLazyExpr</span> <span class='hs-varid'>e</span>
<a name="line-903"></a><span class='hs-definition'>isLazyExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`App`</span> <span class='hs-keyword'>_</span> <span class='hs-varop'>`App`</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>lazyIdKey</span>
<a name="line-904"></a><span class='hs-definition'>isLazyExpr</span> <span class='hs-keyword'>_</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-905"></a>
<a name="line-906"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-907"></a><span class='hs-comment'>--      CpeArg: produces a result satisfying CpeArg</span>
<a name="line-908"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-909"></a>
<a name="line-910"></a><span class='hs-comment'>{-
<a name="line-911"></a>Note [ANF-ising literal string arguments]
<a name="line-912"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-913"></a>
<a name="line-914"></a>Consider a program like,
<a name="line-915"></a>
<a name="line-916"></a>    data Foo = Foo Addr#
<a name="line-917"></a>
<a name="line-918"></a>    foo = Foo "turtle"#
<a name="line-919"></a>
<a name="line-920"></a>When we go to ANFise this we might think that we want to float the string
<a name="line-921"></a>literal like we do any other non-trivial argument. This would look like,
<a name="line-922"></a>
<a name="line-923"></a>    foo = u\ [] case "turtle"# of s { __DEFAULT__ -&gt; Foo s }
<a name="line-924"></a>
<a name="line-925"></a>However, this 1) isn't necessary since strings are in a sense "trivial"; and 2)
<a name="line-926"></a>wreaks havoc on the CAF annotations that we produce here since we the result
<a name="line-927"></a>above is caffy since it is updateable. Ideally at some point in the future we
<a name="line-928"></a>would like to just float the literal to the top level as suggested in #11312,
<a name="line-929"></a>
<a name="line-930"></a>    s = "turtle"#
<a name="line-931"></a>    foo = Foo s
<a name="line-932"></a>
<a name="line-933"></a>However, until then we simply add a special case excluding literals from the
<a name="line-934"></a>floating done by cpeArg.
<a name="line-935"></a>-}</span>
<a name="line-936"></a>
<a name="line-937"></a><a name="okCpeArg"></a><span class='hs-comment'>-- | Is an argument okay to CPE?</span>
<a name="line-938"></a><span class='hs-definition'>okCpeArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-939"></a><span class='hs-comment'>-- Don't float literals. See Note [ANF-ising literal string arguments].</span>
<a name="line-940"></a><span class='hs-definition'>okCpeArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-941"></a><span class='hs-comment'>-- Do not eta expand a trivial argument</span>
<a name="line-942"></a><span class='hs-definition'>okCpeArg</span> <span class='hs-varid'>expr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-943"></a>
<a name="line-944"></a><a name="cpeArg"></a><span class='hs-comment'>-- This is where we arrange that a non-trivial argument is let-bound</span>
<a name="line-945"></a><span class='hs-definition'>cpeArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-946"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeArg</span><span class='hs-layout'>)</span>
<a name="line-947"></a><span class='hs-definition'>cpeArg</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_ty</span>
<a name="line-948"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span>     <span class='hs-comment'>-- arg1 can be a lambda</span>
<a name="line-949"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>want_float</span> <span class='hs-varid'>floats1</span> <span class='hs-varid'>arg1</span>
<a name="line-950"></a>                            <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>)</span>
<a name="line-951"></a>                            <span class='hs-keyword'>else</span> <span class='hs-varid'>dontFloat</span> <span class='hs-varid'>floats1</span> <span class='hs-varid'>arg1</span>
<a name="line-952"></a>                <span class='hs-comment'>-- Else case: arg1 might have lambdas, and we can't</span>
<a name="line-953"></a>                <span class='hs-comment'>--            put them inside a wrapBinds</span>
<a name="line-954"></a>
<a name="line-955"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>okCpeArg</span> <span class='hs-varid'>arg2</span>
<a name="line-956"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newVar</span> <span class='hs-varid'>arg_ty</span>
<a name="line-957"></a>                 <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg3</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprArity</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg2</span>
<a name="line-958"></a>                       <span class='hs-varid'>arg_float</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFloat</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>v</span> <span class='hs-varid'>arg3</span>
<a name="line-959"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>addFloat</span> <span class='hs-varid'>floats2</span> <span class='hs-varid'>arg_float</span><span class='hs-layout'>,</span> <span class='hs-varid'>varToCoreExpr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-960"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span>
<a name="line-961"></a>       <span class='hs-layout'>}</span>
<a name="line-962"></a>  <span class='hs-keyword'>where</span>
<a name="line-963"></a>    <span class='hs-varid'>is_unlifted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnliftedType</span> <span class='hs-varid'>arg_ty</span>
<a name="line-964"></a>    <span class='hs-varid'>want_float</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wantFloatNested</span> <span class='hs-conid'>NonRecursive</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span>
<a name="line-965"></a>
<a name="line-966"></a><span class='hs-comment'>{-
<a name="line-967"></a>Note [Floating unlifted arguments]
<a name="line-968"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-969"></a>Consider    C (let v* = expensive in v)
<a name="line-970"></a>
<a name="line-971"></a>where the "*" indicates "will be demanded".  Usually v will have been
<a name="line-972"></a>inlined by now, but let's suppose it hasn't (see Trac #2756).  Then we
<a name="line-973"></a>do *not* want to get
<a name="line-974"></a>
<a name="line-975"></a>     let v* = expensive in C v
<a name="line-976"></a>
<a name="line-977"></a>because that has different strictness.  Hence the use of 'allLazy'.
<a name="line-978"></a>(NB: the let v* turns into a FloatCase, in mkLocalNonRec.)
<a name="line-979"></a>
<a name="line-980"></a>
<a name="line-981"></a>------------------------------------------------------------------------------
<a name="line-982"></a>-- Building the saturated syntax
<a name="line-983"></a>-- ---------------------------------------------------------------------------
<a name="line-984"></a>
<a name="line-985"></a>maybeSaturate deals with saturating primops and constructors
<a name="line-986"></a>The type is the type of the entire application
<a name="line-987"></a>-}</span>
<a name="line-988"></a>
<a name="line-989"></a><a name="maybeSaturate"></a><span class='hs-definition'>maybeSaturate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeApp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CpeRhs</span>
<a name="line-990"></a><span class='hs-definition'>maybeSaturate</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>n_args</span>
<a name="line-991"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>DataToTagOp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isPrimOpId_maybe</span> <span class='hs-varid'>fn</span>     <span class='hs-comment'>-- DataToTag must have an evaluated arg</span>
<a name="line-992"></a>                                                <span class='hs-comment'>-- A gruesome special case</span>
<a name="line-993"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>saturateDataToTag</span> <span class='hs-varid'>sat_expr</span>
<a name="line-994"></a>
<a name="line-995"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hasNoBinding</span> <span class='hs-varid'>fn</span>        <span class='hs-comment'>-- There's no binding</span>
<a name="line-996"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>sat_expr</span>
<a name="line-997"></a>
<a name="line-998"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-999"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>expr</span>
<a name="line-1000"></a>  <span class='hs-keyword'>where</span>
<a name="line-1001"></a>    <span class='hs-varid'>fn_arity</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>fn</span>
<a name="line-1002"></a>    <span class='hs-varid'>excess_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn_arity</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n_args</span>
<a name="line-1003"></a>    <span class='hs-varid'>sat_expr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-varid'>excess_arity</span> <span class='hs-varid'>expr</span>
<a name="line-1004"></a>
<a name="line-1005"></a><a name="saturateDataToTag"></a><span class='hs-comment'>-------------</span>
<a name="line-1006"></a><span class='hs-definition'>saturateDataToTag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CpeApp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CpeApp</span>
<a name="line-1007"></a><span class='hs-comment'>-- See Note [dataToTag magic]</span>
<a name="line-1008"></a><span class='hs-definition'>saturateDataToTag</span> <span class='hs-varid'>sat_expr</span>
<a name="line-1009"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>eta_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eta_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>sat_expr</span>
<a name="line-1010"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>eta_body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-varid'>eta_body</span>
<a name="line-1011"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLams</span> <span class='hs-varid'>eta_bndrs</span> <span class='hs-varid'>eta_body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1012"></a>  <span class='hs-keyword'>where</span>
<a name="line-1013"></a>    <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CpeApp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CpeBody</span>
<a name="line-1014"></a>    <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-varid'>app</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>fun</span> <span class='hs-varop'>`App`</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1015"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>arg</span>         <span class='hs-comment'>-- Includes nullary constructors</span>
<a name="line-1016"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>app</span>            <span class='hs-comment'>-- The arg is evaluated</span>
<a name="line-1017"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                     <span class='hs-comment'>-- Arg not evaluated, so evaluate it</span>
<a name="line-1018"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1019"></a>             <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_id1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setIdUnfolding</span> <span class='hs-varid'>arg_id</span> <span class='hs-varid'>evaldUnfolding</span>
<a name="line-1020"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_id1</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>app</span><span class='hs-layout'>)</span>
<a name="line-1021"></a>                            <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`App`</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>arg_id1</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1022"></a>
<a name="line-1023"></a>    <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>app</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Scc notes can appear</span>
<a name="line-1024"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>app'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-varid'>app</span>
<a name="line-1025"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>app'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1026"></a>
<a name="line-1027"></a>    <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-varid'>other</span>     <span class='hs-comment'>-- Should not happen</span>
<a name="line-1028"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"eval_data2tag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-1029"></a>
<a name="line-1030"></a><span class='hs-comment'>{-
<a name="line-1031"></a>Note [dataToTag magic]
<a name="line-1032"></a>~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1033"></a>Horrid: we must ensure that the arg of data2TagOp is evaluated
<a name="line-1034"></a>  (data2tag x) --&gt;  (case x of y -&gt; data2tag y)
<a name="line-1035"></a>(yuk yuk) take into account the lambdas we've now introduced
<a name="line-1036"></a>
<a name="line-1037"></a>How might it not be evaluated?  Well, we might have floated it out
<a name="line-1038"></a>of the scope of a `seq`, or dropped the `seq` altogether.
<a name="line-1039"></a>
<a name="line-1040"></a>
<a name="line-1041"></a>************************************************************************
<a name="line-1042"></a>*                                                                      *
<a name="line-1043"></a>                Simple CoreSyn operations
<a name="line-1044"></a>*                                                                      *
<a name="line-1045"></a>************************************************************************
<a name="line-1046"></a>-}</span>
<a name="line-1047"></a>
<a name="line-1048"></a><span class='hs-comment'>{-
<a name="line-1049"></a>-- -----------------------------------------------------------------------------
<a name="line-1050"></a>--      Eta reduction
<a name="line-1051"></a>-- -----------------------------------------------------------------------------
<a name="line-1052"></a>
<a name="line-1053"></a>Note [Eta expansion]
<a name="line-1054"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-1055"></a>Eta expand to match the arity claimed by the binder Remember,
<a name="line-1056"></a>CorePrep must not change arity
<a name="line-1057"></a>
<a name="line-1058"></a>Eta expansion might not have happened already, because it is done by
<a name="line-1059"></a>the simplifier only when there at least one lambda already.
<a name="line-1060"></a>
<a name="line-1061"></a>NB1:we could refrain when the RHS is trivial (which can happen
<a name="line-1062"></a>    for exported things).  This would reduce the amount of code
<a name="line-1063"></a>    generated (a little) and make things a little words for
<a name="line-1064"></a>    code compiled without -O.  The case in point is data constructor
<a name="line-1065"></a>    wrappers.
<a name="line-1066"></a>
<a name="line-1067"></a>NB2: we have to be careful that the result of etaExpand doesn't
<a name="line-1068"></a>   invalidate any of the assumptions that CorePrep is attempting
<a name="line-1069"></a>   to establish.  One possible cause is eta expanding inside of
<a name="line-1070"></a>   an SCC note - we're now careful in etaExpand to make sure the
<a name="line-1071"></a>   SCC is pushed inside any new lambdas that are generated.
<a name="line-1072"></a>
<a name="line-1073"></a>Note [Eta expansion and the CorePrep invariants]
<a name="line-1074"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1075"></a>It turns out to be much much easier to do eta expansion
<a name="line-1076"></a>*after* the main CorePrep stuff.  But that places constraints
<a name="line-1077"></a>on the eta expander: given a CpeRhs, it must return a CpeRhs.
<a name="line-1078"></a>
<a name="line-1079"></a>For example here is what we do not want:
<a name="line-1080"></a>                f = /\a -&gt; g (h 3)      -- h has arity 2
<a name="line-1081"></a>After ANFing we get
<a name="line-1082"></a>                f = /\a -&gt; let s = h 3 in g s
<a name="line-1083"></a>and now we do NOT want eta expansion to give
<a name="line-1084"></a>                f = /\a -&gt; \ y -&gt; (let s = h 3 in g s) y
<a name="line-1085"></a>
<a name="line-1086"></a>Instead CoreArity.etaExpand gives
<a name="line-1087"></a>                f = /\a -&gt; \y -&gt; let s = h 3 in g s y
<a name="line-1088"></a>-}</span>
<a name="line-1089"></a>
<a name="line-1090"></a><a name="cpeEtaExpand"></a><span class='hs-definition'>cpeEtaExpand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span>
<a name="line-1091"></a><span class='hs-definition'>cpeEtaExpand</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>expr</span>
<a name="line-1092"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span>
<a name="line-1093"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaExpand</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>expr</span>
<a name="line-1094"></a>
<a name="line-1095"></a><span class='hs-comment'>{-
<a name="line-1096"></a>-- -----------------------------------------------------------------------------
<a name="line-1097"></a>--      Eta reduction
<a name="line-1098"></a>-- -----------------------------------------------------------------------------
<a name="line-1099"></a>
<a name="line-1100"></a>Why try eta reduction?  Hasn't the simplifier already done eta?
<a name="line-1101"></a>But the simplifier only eta reduces if that leaves something
<a name="line-1102"></a>trivial (like f, or f Int).  But for deLam it would be enough to
<a name="line-1103"></a>get to a partial application:
<a name="line-1104"></a>        case x of { p -&gt; \xs. map f xs }
<a name="line-1105"></a>    ==&gt; case x of { p -&gt; map f }
<a name="line-1106"></a>-}</span>
<a name="line-1107"></a>
<a name="line-1108"></a><a name="tryEtaReducePrep"></a><span class='hs-definition'>tryEtaReducePrep</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBndr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-1109"></a><span class='hs-definition'>tryEtaReducePrep</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1110"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ok_to_eta_reduce</span> <span class='hs-varid'>f</span>
<a name="line-1111"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>n_remaining</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span>
<a name="line-1112"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>and</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>last_args</span><span class='hs-layout'>)</span>
<a name="line-1113"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>fvs_remaining</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-1114"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>remaining_expr</span>   <span class='hs-comment'>-- Don't turn value into a non-value</span>
<a name="line-1115"></a>                               <span class='hs-comment'>-- else the behaviour with 'seq' changes</span>
<a name="line-1116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>remaining_expr</span>
<a name="line-1117"></a>  <span class='hs-keyword'>where</span>
<a name="line-1118"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectArgs</span> <span class='hs-varid'>expr</span>
<a name="line-1119"></a>    <span class='hs-varid'>remaining_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApps</span> <span class='hs-varid'>f</span> <span class='hs-varid'>remaining_args</span>
<a name="line-1120"></a>    <span class='hs-varid'>fvs_remaining</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprFreeVars</span> <span class='hs-varid'>remaining_expr</span>
<a name="line-1121"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>remaining_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>last_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>n_remaining</span> <span class='hs-varid'>args</span>
<a name="line-1122"></a>    <span class='hs-varid'>n_remaining</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>bndrs</span>
<a name="line-1123"></a>
<a name="line-1124"></a>    <span class='hs-varid'>ok</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>==</span> <span class='hs-varid'>arg</span>
<a name="line-1125"></a>    <span class='hs-varid'>ok</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1126"></a>
<a name="line-1127"></a>          <span class='hs-comment'>-- We can't eta reduce something which must be saturated.</span>
<a name="line-1128"></a>    <span class='hs-varid'>ok_to_eta_reduce</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasNoBinding</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-1129"></a>    <span class='hs-varid'>ok_to_eta_reduce</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- Safe. ToDo: generalise</span>
<a name="line-1130"></a>
<a name="line-1131"></a><span class='hs-definition'>tryEtaReducePrep</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-1132"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-1133"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tryEtaReducePrep</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>of</span>
<a name="line-1134"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-1135"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1136"></a>  <span class='hs-keyword'>where</span>
<a name="line-1137"></a>    <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprFreeVars</span> <span class='hs-varid'>r</span>
<a name="line-1138"></a>
<a name="line-1139"></a><span class='hs-comment'>-- NB: do not attempt to eta-reduce across ticks</span>
<a name="line-1140"></a><span class='hs-comment'>-- Otherwise we risk reducing</span>
<a name="line-1141"></a><span class='hs-comment'>--       \x. (Tick (Breakpoint {x}) f x)</span>
<a name="line-1142"></a><span class='hs-comment'>--   ==&gt; Tick (breakpoint {x}) f</span>
<a name="line-1143"></a><span class='hs-comment'>-- which is bogus (Trac #17228)</span>
<a name="line-1144"></a><span class='hs-comment'>-- tryEtaReducePrep bndrs (Tick tickish e)</span>
<a name="line-1145"></a><span class='hs-comment'>--   = fmap (mkTick tickish) $ tryEtaReducePrep bndrs e</span>
<a name="line-1146"></a>
<a name="line-1147"></a><span class='hs-definition'>tryEtaReducePrep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1148"></a>
<a name="line-1149"></a><span class='hs-comment'>{-
<a name="line-1150"></a>************************************************************************
<a name="line-1151"></a>*                                                                      *
<a name="line-1152"></a>                Floats
<a name="line-1153"></a>*                                                                      *
<a name="line-1154"></a>************************************************************************
<a name="line-1155"></a>
<a name="line-1156"></a>Note [Pin demand info on floats]
<a name="line-1157"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1158"></a>We pin demand info on floated lets, so that we can see the one-shot thunks.
<a name="line-1159"></a>-}</span>
<a name="line-1160"></a>
<a name="line-1161"></a><a name="FloatingBind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FloatingBind</span>
<a name="line-1162"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-conid'>CoreBind</span>    <span class='hs-comment'>-- Rhs of bindings are CpeRhss</span>
<a name="line-1163"></a>                         <span class='hs-comment'>-- They are always of lifted type;</span>
<a name="line-1164"></a>                         <span class='hs-comment'>-- unlifted ones are done with FloatCase</span>
<a name="line-1165"></a>
<a name="line-1166"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FloatCase</span>
<a name="line-1167"></a>      <span class='hs-conid'>Id</span> <span class='hs-conid'>CpeBody</span>
<a name="line-1168"></a>      <span class='hs-conid'>Bool</span>              <span class='hs-comment'>-- The bool indicates "ok-for-speculation"</span>
<a name="line-1169"></a>
<a name="line-1170"></a> <span class='hs-comment'>-- | See Note [Floating Ticks in CorePrep]</span>
<a name="line-1171"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FloatTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tickish</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-1172"></a>
<a name="line-1173"></a><a name="Floats"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-conid'>FloatingBind</span><span class='hs-layout'>)</span>
<a name="line-1174"></a>
<a name="line-1175"></a><a name="instance%20Outputable%20FloatingBind"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FloatingBind</span> <span class='hs-keyword'>where</span>
<a name="line-1176"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span>
<a name="line-1177"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span>
<a name="line-1178"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatTick</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t</span>
<a name="line-1179"></a>
<a name="line-1180"></a><a name="instance%20Outputable%20Floats"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Floats</span> <span class='hs-keyword'>where</span>
<a name="line-1181"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Floats"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>flag</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1182"></a>                         <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1183"></a>
<a name="line-1184"></a><a name="instance%20Outputable%20OkToSpec"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyword'>where</span>
<a name="line-1185"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>OkToSpec</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"OkToSpec"</span>
<a name="line-1186"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>IfUnboxedOk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"IfUnboxedOk"</span>
<a name="line-1187"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NotOkToSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NotOkToSpec"</span>
<a name="line-1188"></a>
<a name="line-1189"></a><a name="OkToSpec"></a><span class='hs-comment'>-- Can we float these binds out of the rhs of a let?  We cache this decision</span>
<a name="line-1190"></a><a name="OkToSpec"></a><span class='hs-comment'>-- to avoid having to recompute it in a non-linear way when there are</span>
<a name="line-1191"></a><a name="OkToSpec"></a><span class='hs-comment'>-- deeply nested lets.</span>
<a name="line-1192"></a><a name="OkToSpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>OkToSpec</span>
<a name="line-1193"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OkToSpec</span>           <span class='hs-comment'>-- Lazy bindings of lifted type</span>
<a name="line-1194"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfUnboxedOk</span>        <span class='hs-comment'>-- A mixture of lazy lifted bindings and n</span>
<a name="line-1195"></a>                        <span class='hs-comment'>-- ok-to-speculate unlifted bindings</span>
<a name="line-1196"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NotOkToSpec</span>        <span class='hs-comment'>-- Some not-ok-to-speculate unlifted bindings</span>
<a name="line-1197"></a>
<a name="line-1198"></a><a name="mkFloat"></a><span class='hs-definition'>mkFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatingBind</span>
<a name="line-1199"></a><span class='hs-definition'>mkFloat</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span>
<a name="line-1200"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>use_case</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatCase</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprOkForSpeculation</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1201"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_hnf</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span>                       <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1202"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-layout'>(</span><span class='hs-varid'>setIdDemandInfo</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1203"></a>                   <span class='hs-comment'>-- See Note [Pin demand info on floats]</span>
<a name="line-1204"></a>  <span class='hs-keyword'>where</span>
<a name="line-1205"></a>    <span class='hs-varid'>is_hnf</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>rhs</span>
<a name="line-1206"></a>    <span class='hs-varid'>is_strict</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrictDmd</span> <span class='hs-varid'>dmd</span>
<a name="line-1207"></a>    <span class='hs-varid'>use_case</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_strict</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_hnf</span>
<a name="line-1208"></a>                <span class='hs-comment'>-- Don't make a case for a value binding,</span>
<a name="line-1209"></a>                <span class='hs-comment'>-- even if it's strict.  Otherwise we get</span>
<a name="line-1210"></a>                <span class='hs-comment'>--      case (\x -&gt; e) of ...!</span>
<a name="line-1211"></a>
<a name="line-1212"></a><a name="emptyFloats"></a><span class='hs-definition'>emptyFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span>
<a name="line-1213"></a><span class='hs-definition'>emptyFloats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-varid'>nilOL</span>
<a name="line-1214"></a>
<a name="line-1215"></a><a name="isEmptyFloats"></a><span class='hs-definition'>isEmptyFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1216"></a><span class='hs-definition'>isEmptyFloats</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNilOL</span> <span class='hs-varid'>bs</span>
<a name="line-1217"></a>
<a name="line-1218"></a><a name="wrapBinds"></a><span class='hs-definition'>wrapBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeBody</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeBody</span>
<a name="line-1219"></a><span class='hs-definition'>wrapBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-1220"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrOL</span> <span class='hs-varid'>mk_bind</span> <span class='hs-varid'>body</span> <span class='hs-varid'>binds</span>
<a name="line-1221"></a>  <span class='hs-keyword'>where</span>
<a name="line-1222"></a>    <span class='hs-varid'>mk_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1223"></a>    <span class='hs-varid'>mk_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>        <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span>
<a name="line-1224"></a>    <span class='hs-varid'>mk_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatTick</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span>    <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>body</span>
<a name="line-1225"></a>
<a name="line-1226"></a><a name="addFloat"></a><span class='hs-definition'>addFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatingBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span>
<a name="line-1227"></a><span class='hs-definition'>addFloat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>ok_to_spec</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_float</span>
<a name="line-1228"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Floats</span> <span class='hs-layout'>(</span><span class='hs-varid'>combine</span> <span class='hs-varid'>ok_to_spec</span> <span class='hs-layout'>(</span><span class='hs-varid'>check</span> <span class='hs-varid'>new_float</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>new_float</span><span class='hs-layout'>)</span>
<a name="line-1229"></a>  <span class='hs-keyword'>where</span>
<a name="line-1230"></a>    <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OkToSpec</span>
<a name="line-1231"></a>    <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ok_for_spec</span><span class='hs-layout'>)</span>
<a name="line-1232"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ok_for_spec</span>  <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>IfUnboxedOk</span>
<a name="line-1233"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>NotOkToSpec</span>
<a name="line-1234"></a>    <span class='hs-varid'>check</span> <span class='hs-conid'>FloatTick</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OkToSpec</span>
<a name="line-1235"></a>        <span class='hs-comment'>-- The ok-for-speculation flag says that it's safe to</span>
<a name="line-1236"></a>        <span class='hs-comment'>-- float this Case out of a let, and thereby do it more eagerly</span>
<a name="line-1237"></a>        <span class='hs-comment'>-- We need the top-level flag because it's never ok to float</span>
<a name="line-1238"></a>        <span class='hs-comment'>-- an unboxed binding to the top level</span>
<a name="line-1239"></a>
<a name="line-1240"></a><a name="unitFloat"></a><span class='hs-definition'>unitFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatingBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span>
<a name="line-1241"></a><span class='hs-definition'>unitFloat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addFloat</span> <span class='hs-varid'>emptyFloats</span>
<a name="line-1242"></a>
<a name="line-1243"></a><a name="appendFloats"></a><span class='hs-definition'>appendFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span>
<a name="line-1244"></a><span class='hs-definition'>appendFloats</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>spec1</span> <span class='hs-varid'>floats1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>spec2</span> <span class='hs-varid'>floats2</span><span class='hs-layout'>)</span>
<a name="line-1245"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Floats</span> <span class='hs-layout'>(</span><span class='hs-varid'>combine</span> <span class='hs-varid'>spec1</span> <span class='hs-varid'>spec2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>floats2</span><span class='hs-layout'>)</span>
<a name="line-1246"></a>
<a name="line-1247"></a><a name="concatFloats"></a><span class='hs-definition'>concatFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Floats</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OrdList</span> <span class='hs-conid'>FloatingBind</span>
<a name="line-1248"></a><span class='hs-definition'>concatFloats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bs1</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>appOL</span> <span class='hs-varid'>bs1</span> <span class='hs-varid'>bs2</span><span class='hs-layout'>)</span> <span class='hs-varid'>nilOL</span>
<a name="line-1249"></a>
<a name="line-1250"></a><a name="combine"></a><span class='hs-definition'>combine</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OkToSpec</span>
<a name="line-1251"></a><span class='hs-definition'>combine</span> <span class='hs-conid'>NotOkToSpec</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotOkToSpec</span>
<a name="line-1252"></a><span class='hs-definition'>combine</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>NotOkToSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotOkToSpec</span>
<a name="line-1253"></a><span class='hs-definition'>combine</span> <span class='hs-conid'>IfUnboxedOk</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfUnboxedOk</span>
<a name="line-1254"></a><span class='hs-definition'>combine</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>IfUnboxedOk</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfUnboxedOk</span>
<a name="line-1255"></a><span class='hs-definition'>combine</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OkToSpec</span>
<a name="line-1256"></a>
<a name="line-1257"></a><a name="deFloatTop"></a><span class='hs-definition'>deFloatTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-1258"></a><span class='hs-comment'>-- For top level only; we don't expect any FloatCases</span>
<a name="line-1259"></a><span class='hs-definition'>deFloatTop</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span>
<a name="line-1260"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrOL</span> <span class='hs-varid'>get</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>floats</span>
<a name="line-1261"></a>  <span class='hs-keyword'>where</span>
<a name="line-1262"></a>    <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occurAnalyseRHSs</span> <span class='hs-varid'>b</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span>
<a name="line-1263"></a>    <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>var</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span>  <span class='hs-keyglyph'>=</span>
<a name="line-1264"></a>      <span class='hs-varid'>occurAnalyseRHSs</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>var</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span>
<a name="line-1265"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"corePrepPgm"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-1266"></a>
<a name="line-1267"></a>    <span class='hs-comment'>-- See Note [Dead code in CorePrep]</span>
<a name="line-1268"></a>    <span class='hs-varid'>occurAnalyseRHSs</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>occurAnalyseExpr_NoBinderSwap</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-1269"></a>    <span class='hs-varid'>occurAnalyseRHSs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>xes</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rec</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>occurAnalyseExpr_NoBinderSwap</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xes</span><span class='hs-keyglyph'>]</span>
<a name="line-1270"></a>
<a name="line-1271"></a><span class='hs-comment'>---------------------------------------------------------------------------</span>
<a name="line-1272"></a>
<a name="line-1273"></a><a name="canFloatFromNoCaf"></a><span class='hs-definition'>canFloatFromNoCaf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-1274"></a>       <span class='hs-comment'>-- Note [CafInfo and floating]</span>
<a name="line-1275"></a><span class='hs-definition'>canFloatFromNoCaf</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>ok_to_spec</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-1276"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ok_to_spec</span>           <span class='hs-comment'>-- Worth trying</span>
<a name="line-1277"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptySubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>nilOL</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-1278"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-varid'>fs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1279"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1280"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1281"></a>  <span class='hs-keyword'>where</span>
<a name="line-1282"></a>    <span class='hs-varid'>subst_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"CorePrep"</span><span class='hs-layout'>)</span>
<a name="line-1283"></a>
<a name="line-1284"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrdList</span> <span class='hs-conid'>FloatingBind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FloatingBind</span><span class='hs-keyglyph'>]</span>
<a name="line-1285"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrdList</span> <span class='hs-conid'>FloatingBind</span><span class='hs-layout'>)</span>
<a name="line-1286"></a>
<a name="line-1287"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span><span class='hs-layout'>)</span>
<a name="line-1288"></a>
<a name="line-1289"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fbs_in</span><span class='hs-layout'>)</span>
<a name="line-1290"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rhs_ok</span> <span class='hs-varid'>r</span>
<a name="line-1291"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>new_fb</span><span class='hs-layout'>)</span> <span class='hs-varid'>fbs_in</span>
<a name="line-1292"></a>      <span class='hs-keyword'>where</span>
<a name="line-1293"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>set_nocaf_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span>
<a name="line-1294"></a>        <span class='hs-varid'>new_fb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b'</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1295"></a>
<a name="line-1296"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fbs_in</span><span class='hs-layout'>)</span>
<a name="line-1297"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>rhs_ok</span> <span class='hs-varid'>rs</span>
<a name="line-1298"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>new_fb</span><span class='hs-layout'>)</span> <span class='hs-varid'>fbs_in</span>
<a name="line-1299"></a>      <span class='hs-keyword'>where</span>
<a name="line-1300"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>prs</span>
<a name="line-1301"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>set_nocaf_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bs</span>
<a name="line-1302"></a>        <span class='hs-varid'>rs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-varid'>rs</span>
<a name="line-1303"></a>        <span class='hs-varid'>new_fb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs'</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1304"></a>
<a name="line-1305"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ft</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>FloatTick</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fbs_in</span><span class='hs-layout'>)</span>
<a name="line-1306"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>ft</span><span class='hs-layout'>)</span> <span class='hs-varid'>fbs_in</span>
<a name="line-1307"></a>
<a name="line-1308"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>      <span class='hs-comment'>-- Encountered a caffy binding</span>
<a name="line-1309"></a>
<a name="line-1310"></a>    <span class='hs-comment'>------------</span>
<a name="line-1311"></a>    <span class='hs-varid'>set_nocaf_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-1312"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendIdSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span>
<a name="line-1313"></a>      <span class='hs-keyword'>where</span>
<a name="line-1314"></a>        <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdCafInfo`</span> <span class='hs-conid'>NoCafRefs</span>
<a name="line-1315"></a>
<a name="line-1316"></a>    <span class='hs-comment'>------------</span>
<a name="line-1317"></a>    <span class='hs-varid'>rhs_ok</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1318"></a>    <span class='hs-comment'>-- We can only float to top level from a NoCaf thing if</span>
<a name="line-1319"></a>    <span class='hs-comment'>-- the new binding is static. However it can't mention</span>
<a name="line-1320"></a>    <span class='hs-comment'>-- any non-static things or it would *already* be Caffy</span>
<a name="line-1321"></a>    <span class='hs-varid'>rhs_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhsIsStatic</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-1322"></a>                         <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rhsIsStatic"</span> <span class='hs-layout'>(</span><span class='hs-varid'>integer</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1323"></a>                         <span class='hs-comment'>-- Integer literals should not show up</span>
<a name="line-1324"></a>
<a name="line-1325"></a><a name="wantFloatNested"></a><span class='hs-definition'>wantFloatNested</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1326"></a><span class='hs-definition'>wantFloatNested</span> <span class='hs-varid'>is_rec</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-1327"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isEmptyFloats</span> <span class='hs-varid'>floats</span>
<a name="line-1328"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>isStrictDmd</span> <span class='hs-varid'>dmd</span>
<a name="line-1329"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>is_unlifted</span>
<a name="line-1330"></a>  <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>allLazyNested</span> <span class='hs-varid'>is_rec</span> <span class='hs-varid'>floats</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1331"></a>        <span class='hs-comment'>-- Why the test for allLazyNested?</span>
<a name="line-1332"></a>        <span class='hs-comment'>--      v = f (x `divInt#` y)</span>
<a name="line-1333"></a>        <span class='hs-comment'>-- we don't want to float the case, even if f has arity 2,</span>
<a name="line-1334"></a>        <span class='hs-comment'>-- because floating the case would make it evaluated too early</span>
<a name="line-1335"></a>
<a name="line-1336"></a><a name="allLazyTop"></a><span class='hs-definition'>allLazyTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1337"></a><span class='hs-definition'>allLazyTop</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1338"></a><span class='hs-definition'>allLazyTop</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1339"></a>
<a name="line-1340"></a><a name="allLazyNested"></a><span class='hs-definition'>allLazyNested</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1341"></a><span class='hs-definition'>allLazyNested</span> <span class='hs-keyword'>_</span>      <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span>    <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1342"></a><span class='hs-definition'>allLazyNested</span> <span class='hs-keyword'>_</span>      <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>NotOkToSpec</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1343"></a><span class='hs-definition'>allLazyNested</span> <span class='hs-varid'>is_rec</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>IfUnboxedOk</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNonRec</span> <span class='hs-varid'>is_rec</span>
<a name="line-1344"></a>
<a name="line-1345"></a><span class='hs-comment'>{-
<a name="line-1346"></a>************************************************************************
<a name="line-1347"></a>*                                                                      *
<a name="line-1348"></a>                Cloning
<a name="line-1349"></a>*                                                                      *
<a name="line-1350"></a>************************************************************************
<a name="line-1351"></a>-}</span>
<a name="line-1352"></a>
<a name="line-1353"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-1354"></a><span class='hs-comment'>--                      The environment</span>
<a name="line-1355"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-1356"></a>
<a name="line-1357"></a><span class='hs-comment'>-- Note [Inlining in CorePrep]</span>
<a name="line-1358"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1359"></a><span class='hs-comment'>-- There is a subtle but important invariant that must be upheld in the output</span>
<a name="line-1360"></a><span class='hs-comment'>-- of CorePrep: there are no "trivial" updatable thunks.  Thus, this Core</span>
<a name="line-1361"></a><span class='hs-comment'>-- is impermissible:</span>
<a name="line-1362"></a><span class='hs-comment'>--</span>
<a name="line-1363"></a><span class='hs-comment'>--      let x :: ()</span>
<a name="line-1364"></a><span class='hs-comment'>--          x = y</span>
<a name="line-1365"></a><span class='hs-comment'>--</span>
<a name="line-1366"></a><span class='hs-comment'>-- (where y is a reference to a GLOBAL variable).  Thunks like this are silly:</span>
<a name="line-1367"></a><span class='hs-comment'>-- they can always be profitably replaced by inlining x with y. Consequently,</span>
<a name="line-1368"></a><span class='hs-comment'>-- the code generator/runtime does not bother implementing this properly</span>
<a name="line-1369"></a><span class='hs-comment'>-- (specifically, there is no implementation of stg_ap_0_upd_info, which is the</span>
<a name="line-1370"></a><span class='hs-comment'>-- stack frame that would be used to update this thunk.  The "0" means it has</span>
<a name="line-1371"></a><span class='hs-comment'>-- zero free variables.)</span>
<a name="line-1372"></a><span class='hs-comment'>--</span>
<a name="line-1373"></a><span class='hs-comment'>-- In general, the inliner is good at eliminating these let-bindings.  However,</span>
<a name="line-1374"></a><span class='hs-comment'>-- there is one case where these trivial updatable thunks can arise: when</span>
<a name="line-1375"></a><span class='hs-comment'>-- we are optimizing away 'lazy' (see Note [lazyId magic], and also</span>
<a name="line-1376"></a><span class='hs-comment'>-- 'cpeRhsE'.)  Then, we could have started with:</span>
<a name="line-1377"></a><span class='hs-comment'>--</span>
<a name="line-1378"></a><span class='hs-comment'>--      let x :: ()</span>
<a name="line-1379"></a><span class='hs-comment'>--          x = lazy @ () y</span>
<a name="line-1380"></a><span class='hs-comment'>--</span>
<a name="line-1381"></a><span class='hs-comment'>-- which is a perfectly fine, non-trivial thunk, but then CorePrep will</span>
<a name="line-1382"></a><span class='hs-comment'>-- drop 'lazy', giving us 'x = y' which is trivial and impermissible.</span>
<a name="line-1383"></a><span class='hs-comment'>-- The solution is CorePrep to have a miniature inlining pass which deals</span>
<a name="line-1384"></a><span class='hs-comment'>-- with cases like this.  We can then drop the let-binding altogether.</span>
<a name="line-1385"></a><span class='hs-comment'>--</span>
<a name="line-1386"></a><span class='hs-comment'>-- Why does the removal of 'lazy' have to occur in CorePrep?</span>
<a name="line-1387"></a><span class='hs-comment'>-- The gory details are in Note [lazyId magic] in MkId, but the</span>
<a name="line-1388"></a><span class='hs-comment'>-- main reason is that lazy must appear in unfoldings (optimizer</span>
<a name="line-1389"></a><span class='hs-comment'>-- output) and it must prevent call-by-value for catch# (which</span>
<a name="line-1390"></a><span class='hs-comment'>-- is implemented by CorePrep.)</span>
<a name="line-1391"></a><span class='hs-comment'>--</span>
<a name="line-1392"></a><span class='hs-comment'>-- An alternate strategy for solving this problem is to have the</span>
<a name="line-1393"></a><span class='hs-comment'>-- inliner treat 'lazy e' as a trivial expression if 'e' is trivial.</span>
<a name="line-1394"></a><span class='hs-comment'>-- We decided not to adopt this solution to keep the definition</span>
<a name="line-1395"></a><span class='hs-comment'>-- of 'exprIsTrivial' simple.</span>
<a name="line-1396"></a><span class='hs-comment'>--</span>
<a name="line-1397"></a><span class='hs-comment'>-- There is ONE caveat however: for top-level bindings we have</span>
<a name="line-1398"></a><span class='hs-comment'>-- to preserve the binding so that we float the (hacky) non-recursive</span>
<a name="line-1399"></a><span class='hs-comment'>-- binding for data constructors; see Note [Data constructor workers].</span>
<a name="line-1400"></a><span class='hs-comment'>--</span>
<a name="line-1401"></a><span class='hs-comment'>-- Note [CorePrep inlines trivial CoreExpr not Id]</span>
<a name="line-1402"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1403"></a><span class='hs-comment'>-- Why does cpe_env need to be an IdEnv CoreExpr, as opposed to an</span>
<a name="line-1404"></a><span class='hs-comment'>-- IdEnv Id?  Naively, we might conjecture that trivial updatable thunks</span>
<a name="line-1405"></a><span class='hs-comment'>-- as per Note [Inlining in CorePrep] always have the form</span>
<a name="line-1406"></a><span class='hs-comment'>-- 'lazy @ SomeType gbl_id'.  But this is not true: the following is</span>
<a name="line-1407"></a><span class='hs-comment'>-- perfectly reasonable Core:</span>
<a name="line-1408"></a><span class='hs-comment'>--</span>
<a name="line-1409"></a><span class='hs-comment'>--      let x :: ()</span>
<a name="line-1410"></a><span class='hs-comment'>--          x = lazy @ (forall a. a) y @ Bool</span>
<a name="line-1411"></a><span class='hs-comment'>--</span>
<a name="line-1412"></a><span class='hs-comment'>-- When we inline 'x' after eliminating 'lazy', we need to replace</span>
<a name="line-1413"></a><span class='hs-comment'>-- occurrences of 'x' with 'y @ bool', not just 'y'.  Situations like</span>
<a name="line-1414"></a><span class='hs-comment'>-- this can easily arise with higher-rank types; thus, cpe_env must</span>
<a name="line-1415"></a><span class='hs-comment'>-- map to CoreExprs, not Ids.</span>
<a name="line-1416"></a>
<a name="line-1417"></a><a name="CorePrepEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CorePrepEnv</span>
<a name="line-1418"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CPE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cpe_dynFlags</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-1419"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>cpe_env</span>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>CoreExpr</span>   <span class='hs-comment'>-- Clone local Ids</span>
<a name="line-1420"></a>        <span class='hs-comment'>-- ^ This environment is used for three operations:</span>
<a name="line-1421"></a>        <span class='hs-comment'>--</span>
<a name="line-1422"></a>        <span class='hs-comment'>--      1. To support cloning of local Ids so that they are</span>
<a name="line-1423"></a>        <span class='hs-comment'>--      all unique (see item (6) of CorePrep overview).</span>
<a name="line-1424"></a>        <span class='hs-comment'>--</span>
<a name="line-1425"></a>        <span class='hs-comment'>--      2. To support beta-reduction of runRW, see</span>
<a name="line-1426"></a>        <span class='hs-comment'>--      Note [runRW magic] and Note [runRW arg].</span>
<a name="line-1427"></a>        <span class='hs-comment'>--</span>
<a name="line-1428"></a>        <span class='hs-comment'>--      3. To let us inline trivial RHSs of non top-level let-bindings,</span>
<a name="line-1429"></a>        <span class='hs-comment'>--      see Note [lazyId magic], Note [Inlining in CorePrep]</span>
<a name="line-1430"></a>        <span class='hs-comment'>--      and Note [CorePrep inlines trivial CoreExpr not Id] (#12076)</span>
<a name="line-1431"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>cpe_mkIntegerId</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-1432"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>cpe_integerSDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DataCon</span>
<a name="line-1433"></a>    <span class='hs-layout'>}</span>
<a name="line-1434"></a>
<a name="line-1435"></a><a name="lookupMkIntegerName"></a><span class='hs-definition'>lookupMkIntegerName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Id</span>
<a name="line-1436"></a><span class='hs-definition'>lookupMkIntegerName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1437"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guardIntegerUse</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>tyThingId</span> <span class='hs-varop'>$</span>
<a name="line-1438"></a>      <span class='hs-varid'>lookupGlobal</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mkIntegerName</span>
<a name="line-1439"></a>
<a name="line-1440"></a><a name="lookupIntegerSDataConName"></a><span class='hs-definition'>lookupIntegerSDataConName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>)</span>
<a name="line-1441"></a><span class='hs-definition'>lookupIntegerSDataConName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cIntegerLibraryType</span> <span class='hs-keyword'>of</span>
<a name="line-1442"></a>    <span class='hs-conid'>IntegerGMP</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>guardIntegerUse</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyThingDataCon</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1443"></a>                  <span class='hs-varid'>lookupGlobal</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>integerSDataConName</span>
<a name="line-1444"></a>    <span class='hs-conid'>IntegerSimple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1445"></a>
<a name="line-1446"></a><a name="guardIntegerUse"></a><span class='hs-comment'>-- | Helper for 'lookupMkIntegerName' and 'lookupIntegerSDataConName'</span>
<a name="line-1447"></a><span class='hs-definition'>guardIntegerUse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-1448"></a><span class='hs-definition'>guardIntegerUse</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>act</span>
<a name="line-1449"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-varid'>primUnitId</span>
<a name="line-1450"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Can't use Integer in ghc-prim"</span>
<a name="line-1451"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-varid'>integerUnitId</span>
<a name="line-1452"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Can't use Integer in integer-*"</span>
<a name="line-1453"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span>
<a name="line-1454"></a>
<a name="line-1455"></a><a name="mkInitialCorePrepEnv"></a><span class='hs-definition'>mkInitialCorePrepEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CorePrepEnv</span>
<a name="line-1456"></a><span class='hs-definition'>mkInitialCorePrepEnv</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1457"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>mkIntegerId</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupMkIntegerName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1458"></a>         <span class='hs-varid'>integerSDataCon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupIntegerSDataConName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1459"></a>         <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CPE</span> <span class='hs-layout'>{</span>
<a name="line-1460"></a>                      <span class='hs-varid'>cpe_dynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>,</span>
<a name="line-1461"></a>                      <span class='hs-varid'>cpe_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>,</span>
<a name="line-1462"></a>                      <span class='hs-varid'>cpe_mkIntegerId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIntegerId</span><span class='hs-layout'>,</span>
<a name="line-1463"></a>                      <span class='hs-varid'>cpe_integerSDataCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>integerSDataCon</span>
<a name="line-1464"></a>                  <span class='hs-layout'>}</span>
<a name="line-1465"></a>
<a name="line-1466"></a><a name="extendCorePrepEnv"></a><span class='hs-definition'>extendCorePrepEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CorePrepEnv</span>
<a name="line-1467"></a><span class='hs-definition'>extendCorePrepEnv</span> <span class='hs-varid'>cpe</span> <span class='hs-varid'>id</span> <span class='hs-varid'>id'</span>
<a name="line-1468"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpe</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cpe_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_env</span> <span class='hs-varid'>cpe</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1469"></a>
<a name="line-1470"></a><a name="extendCorePrepEnvExpr"></a><span class='hs-definition'>extendCorePrepEnvExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CorePrepEnv</span>
<a name="line-1471"></a><span class='hs-definition'>extendCorePrepEnvExpr</span> <span class='hs-varid'>cpe</span> <span class='hs-varid'>id</span> <span class='hs-varid'>expr</span>
<a name="line-1472"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpe</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cpe_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_env</span> <span class='hs-varid'>cpe</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>}</span>
<a name="line-1473"></a>
<a name="line-1474"></a><a name="extendCorePrepEnvList"></a><span class='hs-definition'>extendCorePrepEnvList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CorePrepEnv</span>
<a name="line-1475"></a><span class='hs-definition'>extendCorePrepEnvList</span> <span class='hs-varid'>cpe</span> <span class='hs-varid'>prs</span>
<a name="line-1476"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpe</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cpe_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_env</span> <span class='hs-varid'>cpe</span><span class='hs-layout'>)</span>
<a name="line-1477"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1478"></a>
<a name="line-1479"></a><a name="lookupCorePrepEnv"></a><span class='hs-definition'>lookupCorePrepEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-1480"></a><span class='hs-definition'>lookupCorePrepEnv</span> <span class='hs-varid'>cpe</span> <span class='hs-varid'>id</span>
<a name="line-1481"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_env</span> <span class='hs-varid'>cpe</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-1482"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>id</span>
<a name="line-1483"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>exp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>exp</span>
<a name="line-1484"></a>
<a name="line-1485"></a><a name="getMkIntegerId"></a><span class='hs-definition'>getMkIntegerId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-1486"></a><span class='hs-definition'>getMkIntegerId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpe_mkIntegerId</span>
<a name="line-1487"></a>
<a name="line-1488"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-1489"></a><span class='hs-comment'>-- Cloning binders</span>
<a name="line-1490"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-1491"></a>
<a name="line-1492"></a><a name="cpCloneBndrs"></a><span class='hs-definition'>cpCloneBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1493"></a><span class='hs-definition'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>cpCloneBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span>
<a name="line-1494"></a>
<a name="line-1495"></a><a name="cpCloneBndr"></a><span class='hs-definition'>cpCloneBndr</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-1496"></a><span class='hs-definition'>cpCloneBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span>
<a name="line-1497"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLocalId</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoVar</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-1498"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setVarUnique</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getUniqueM</span>
<a name="line-1499"></a>
<a name="line-1500"></a>       <span class='hs-comment'>-- We are going to OccAnal soon, so drop (now-useless) rules/unfoldings</span>
<a name="line-1501"></a>       <span class='hs-comment'>-- so that we can drop more stuff as dead code.</span>
<a name="line-1502"></a>       <span class='hs-comment'>-- See also Note [Dead code in CorePrep]</span>
<a name="line-1503"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>bndr''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr'</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-1504"></a>                          <span class='hs-varop'>`setIdSpecialisation`</span> <span class='hs-varid'>emptyRuleInfo</span>
<a name="line-1505"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bndr''</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr''</span><span class='hs-layout'>)</span>
<a name="line-1506"></a>
<a name="line-1507"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Top level things, which we don't want</span>
<a name="line-1508"></a>                <span class='hs-comment'>-- to clone, have become GlobalIds by now</span>
<a name="line-1509"></a>                <span class='hs-comment'>-- And we don't clone tyvars, or coercion variables</span>
<a name="line-1510"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-1511"></a>
<a name="line-1512"></a>
<a name="line-1513"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-1514"></a><span class='hs-comment'>-- Cloning ccall Ids; each must have a unique name,</span>
<a name="line-1515"></a><span class='hs-comment'>-- to give the code generator a handle to hang it on</span>
<a name="line-1516"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-1517"></a>
<a name="line-1518"></a><a name="fiddleCCall"></a><span class='hs-definition'>fiddleCCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>Id</span>
<a name="line-1519"></a><span class='hs-definition'>fiddleCCall</span> <span class='hs-varid'>id</span>
<a name="line-1520"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFCallId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span> <span class='hs-varop'>`setVarUnique`</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getUniqueM</span>
<a name="line-1521"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>id</span>
<a name="line-1522"></a>
<a name="line-1523"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-1524"></a><span class='hs-comment'>-- Generating new binders</span>
<a name="line-1525"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-1526"></a>
<a name="line-1527"></a><a name="newVar"></a><span class='hs-definition'>newVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>Id</span>
<a name="line-1528"></a><span class='hs-definition'>newVar</span> <span class='hs-varid'>ty</span>
<a name="line-1529"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`seq`</span> <span class='hs-keyword'>do</span>
<a name="line-1530"></a>     <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUniqueM</span>
<a name="line-1531"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSysLocalOrCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"sat"</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1532"></a>
<a name="line-1533"></a>
<a name="line-1534"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-1535"></a><span class='hs-comment'>-- Floating ticks</span>
<a name="line-1536"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-1537"></a><span class='hs-comment'>--</span>
<a name="line-1538"></a><span class='hs-comment'>-- Note [Floating Ticks in CorePrep]</span>
<a name="line-1539"></a><span class='hs-comment'>--</span>
<a name="line-1540"></a><span class='hs-comment'>-- It might seem counter-intuitive to float ticks by default, given</span>
<a name="line-1541"></a><span class='hs-comment'>-- that we don't actually want to move them if we can help it. On the</span>
<a name="line-1542"></a><span class='hs-comment'>-- other hand, nothing gets very far in CorePrep anyway, and we want</span>
<a name="line-1543"></a><span class='hs-comment'>-- to preserve the order of let bindings and tick annotations in</span>
<a name="line-1544"></a><span class='hs-comment'>-- relation to each other. For example, if we just wrapped let floats</span>
<a name="line-1545"></a><span class='hs-comment'>-- when they pass through ticks, we might end up performing the</span>
<a name="line-1546"></a><span class='hs-comment'>-- following transformation:</span>
<a name="line-1547"></a><span class='hs-comment'>--</span>
<a name="line-1548"></a><span class='hs-comment'>--   src&lt;...&gt; let foo = bar in baz</span>
<a name="line-1549"></a><span class='hs-comment'>--   ==&gt;  let foo = src&lt;...&gt; bar in src&lt;...&gt; baz</span>
<a name="line-1550"></a><span class='hs-comment'>--</span>
<a name="line-1551"></a><span class='hs-comment'>-- Because the let-binding would float through the tick, and then</span>
<a name="line-1552"></a><span class='hs-comment'>-- immediately materialize, achieving nothing but decreasing tick</span>
<a name="line-1553"></a><span class='hs-comment'>-- accuracy. The only special case is the following scenario:</span>
<a name="line-1554"></a><span class='hs-comment'>--</span>
<a name="line-1555"></a><span class='hs-comment'>--   let foo = src&lt;...&gt; (let a = b in bar) in baz</span>
<a name="line-1556"></a><span class='hs-comment'>--   ==&gt;  let foo = src&lt;...&gt; bar; a = src&lt;...&gt; b in baz</span>
<a name="line-1557"></a><span class='hs-comment'>--</span>
<a name="line-1558"></a><span class='hs-comment'>-- Here we would not want the source tick to end up covering "baz" and</span>
<a name="line-1559"></a><span class='hs-comment'>-- therefore refrain from pushing ticks outside. Instead, we copy them</span>
<a name="line-1560"></a><span class='hs-comment'>-- into the floating binds (here "a") in cpePair. Note that where "b"</span>
<a name="line-1561"></a><span class='hs-comment'>-- or "bar" are (value) lambdas we have to push the annotations</span>
<a name="line-1562"></a><span class='hs-comment'>-- further inside in order to uphold our rules.</span>
<a name="line-1563"></a><span class='hs-comment'>--</span>
<a name="line-1564"></a><span class='hs-comment'>-- All of this is implemented below in @wrapTicks@.</span>
<a name="line-1565"></a>
<a name="line-1566"></a><a name="wrapTicks"></a><span class='hs-comment'>-- | Like wrapFloats, but only wraps tick floats</span>
<a name="line-1567"></a><span class='hs-definition'>wrapTicks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-1568"></a><span class='hs-definition'>wrapTicks</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>floats0</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span>
<a name="line-1569"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>flag</span> <span class='hs-layout'>(</span><span class='hs-varid'>toOL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>floats1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkTick</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>ticks1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1570"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ticks1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldlOL</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>floats0</span>
<a name="line-1571"></a>        <span class='hs-comment'>-- Deeply nested constructors will produce long lists of</span>
<a name="line-1572"></a>        <span class='hs-comment'>-- redundant source note floats here. We need to eliminate</span>
<a name="line-1573"></a>        <span class='hs-comment'>-- those early, as relying on mkTick to spot it after the fact</span>
<a name="line-1574"></a>        <span class='hs-comment'>-- can yield O(n^3) complexity [#11095]</span>
<a name="line-1575"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>ticks</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatTick</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-1576"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>tickishPlace</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-conid'>PlaceNonLam</span><span class='hs-layout'>)</span>
<a name="line-1577"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>tickishContains</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>ticks</span>
<a name="line-1578"></a>                     <span class='hs-keyword'>then</span> <span class='hs-varid'>ticks</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>ticks</span><span class='hs-layout'>)</span>
<a name="line-1579"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>ticks</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span>
<a name="line-1580"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>ticks</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>ticks</span><span class='hs-layout'>)</span>
<a name="line-1581"></a>
<a name="line-1582"></a>        <span class='hs-varid'>wrap</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapBind</span> <span class='hs-varid'>t</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-1583"></a>        <span class='hs-varid'>wrap</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatCase</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>ok</span>
<a name="line-1584"></a>        <span class='hs-varid'>wrap</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"wrapTicks: unexpected float!"</span>
<a name="line-1585"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-1586"></a>        <span class='hs-varid'>wrapBind</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>binder</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1587"></a>        <span class='hs-varid'>wrapBind</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTick</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
</pre></body>
</html>
