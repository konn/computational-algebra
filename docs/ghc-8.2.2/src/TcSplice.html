<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcSplice.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a>TcSplice: Template Haskell splices
<a name="line-7"></a>-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# LANGUAGE FlexibleInstances #-}</span>
<a name="line-11"></a><span class='hs-comment'>{-# LANGUAGE MagicHash #-}</span>
<a name="line-12"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-13"></a><span class='hs-comment'>{-# LANGUAGE InstanceSigs #-}</span>
<a name="line-14"></a><span class='hs-comment'>{-# LANGUAGE GADTs #-}</span>
<a name="line-15"></a><span class='hs-comment'>{-# LANGUAGE RecordWildCards #-}</span>
<a name="line-16"></a><span class='hs-comment'>{-# LANGUAGE MultiWayIf #-}</span>
<a name="line-17"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcSplice</span><span class='hs-layout'>(</span>
<a name="line-20"></a>     <span class='hs-varid'>tcSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTypedBracket</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcUntypedBracket</span><span class='hs-layout'>,</span>
<a name="line-21"></a><span class='hs-comment'>--     runQuasiQuoteExpr, runQuasiQuotePat,</span>
<a name="line-22"></a><span class='hs-comment'>--     runQuasiQuoteDecl, runQuasiQuoteType,</span>
<a name="line-23"></a>     <span class='hs-varid'>runAnnotation</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>     <span class='hs-varid'>runMetaE</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaP</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaT</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaD</span><span class='hs-layout'>,</span> <span class='hs-varid'>runQuasi</span><span class='hs-layout'>,</span>
<a name="line-26"></a>     <span class='hs-varid'>tcTopSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupThName_maybe</span><span class='hs-layout'>,</span>
<a name="line-27"></a>     <span class='hs-varid'>defaultRunMeta</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMeta'</span><span class='hs-layout'>,</span> <span class='hs-varid'>runRemoteModFinalizers</span><span class='hs-layout'>,</span>
<a name="line-28"></a>     <span class='hs-varid'>finishTH</span>
<a name="line-29"></a>      <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcExpr</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>THNames</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi</span><span class='hs-varop'>.</span><span class='hs-conid'>Message</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi</span><span class='hs-varop'>.</span><span class='hs-conid'>RemoteTypes</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscMain</span>
<a name="line-52"></a>        <span class='hs-comment'>-- These imports are the reason that TcSplice</span>
<a name="line-53"></a>        <span class='hs-comment'>-- is very high up the module hierarchy</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnSplice</span><span class='hs-layout'>(</span> <span class='hs-varid'>traceSplice</span><span class='hs-layout'>,</span> <span class='hs-conid'>SpliceInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Convert</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnExpr</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnTypes</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSimplify</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcIface</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCoRep</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Hooks</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LoadIface</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span><span class='hs-layout'>(</span> <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsExpr</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsMonad</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Serialized</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>isEmptyVarSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterVarSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVarSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>elemVarSet</span> <span class='hs-layout'>)</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>find</span> <span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span><span class='hs-layout'>(</span> <span class='hs-conid'>MaybeErr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Lexeme</span>
<a name="line-106"></a>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-108"></a><span class='hs-comment'>-- THSyntax gives access to internal functions and data types</span>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Syntax</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-110"></a>
<a name="line-111"></a><span class='hs-comment'>-- Because GHC.Desugar might not be in the base library of the bootstrapping compiler</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Desugar</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>AnnotationWrapper</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IntSet</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>IntSet</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Binary</span>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Binary</span><span class='hs-varop'>.</span><span class='hs-conid'>Get</span>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>B</span>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>Lazy</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LB</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Dynamic</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>fromDynamic</span><span class='hs-layout'>,</span> <span class='hs-varid'>toDyn</span> <span class='hs-layout'>)</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>(</span> <span class='hs-varid'>typeOf</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypeRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeRep</span> <span class='hs-layout'>)</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-layout'>)</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Proxy</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>Proxy</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Exts</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-layout'>)</span>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-comment'>{-
<a name="line-128"></a>************************************************************************
<a name="line-129"></a>*                                                                      *
<a name="line-130"></a>\subsection{Main interface + stubs for the non-GHCI case
<a name="line-131"></a>*                                                                      *
<a name="line-132"></a>************************************************************************
<a name="line-133"></a>-}</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="tcTypedBracket"></a><span class='hs-definition'>tcTypedBracket</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-136"></a><a name="tcUntypedBracket"></a><span class='hs-definition'>tcUntypedBracket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingRnSplice</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-137"></a><a name="tcSpliceExpr"></a><span class='hs-definition'>tcSpliceExpr</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>Name</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-138"></a>        <span class='hs-comment'>-- None of these functions add constraints to the LIE</span>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-comment'>-- runQuasiQuoteExpr :: HsQuasiQuote RdrName -&gt; RnM (LHsExpr RdrName)</span>
<a name="line-141"></a><span class='hs-comment'>-- runQuasiQuotePat  :: HsQuasiQuote RdrName -&gt; RnM (LPat RdrName)</span>
<a name="line-142"></a><span class='hs-comment'>-- runQuasiQuoteType :: HsQuasiQuote RdrName -&gt; RnM (LHsType RdrName)</span>
<a name="line-143"></a><span class='hs-comment'>-- runQuasiQuoteDecl :: HsQuasiQuote RdrName -&gt; RnM [LHsDecl RdrName]</span>
<a name="line-144"></a>
<a name="line-145"></a><a name="runAnnotation"></a><span class='hs-definition'>runAnnotation</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreAnnTarget</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Annotation</span>
<a name="line-146"></a><span class='hs-comment'>{-
<a name="line-147"></a>************************************************************************
<a name="line-148"></a>*                                                                      *
<a name="line-149"></a>\subsection{Quoting an expression}
<a name="line-150"></a>*                                                                      *
<a name="line-151"></a>************************************************************************
<a name="line-152"></a>-}</span>
<a name="line-153"></a>
<a name="line-154"></a><span class='hs-comment'>-- See Note [How brackets and nested splices are handled]</span>
<a name="line-155"></a><span class='hs-comment'>-- tcTypedBracket :: HsBracket Name -&gt; TcRhoType -&gt; TcM (HsExpr TcId)</span>
<a name="line-156"></a><span class='hs-definition'>tcTypedBracket</span> <span class='hs-varid'>brack</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TExpBr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotationCtxtDoc</span> <span class='hs-varid'>brack</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-158"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cur_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-159"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps_ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>[]</span>
<a name="line-160"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lie_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getConstraintVar</span>   <span class='hs-comment'>-- Any constraints arising from nested splices</span>
<a name="line-161"></a>                                       <span class='hs-comment'>-- should get thrown into the constraint set</span>
<a name="line-162"></a>                                       <span class='hs-comment'>-- from outside the bracket</span>
<a name="line-163"></a>
<a name="line-164"></a>       <span class='hs-comment'>-- Typecheck expr to make sure it is valid,</span>
<a name="line-165"></a>       <span class='hs-comment'>-- Throw away the typechecked expression but return its type.</span>
<a name="line-166"></a>       <span class='hs-comment'>-- We'll typecheck it again when we splice it in somewhere</span>
<a name="line-167"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-sel'>_tc_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>cur_stage</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPending</span> <span class='hs-varid'>ps_ref</span> <span class='hs-varid'>lie_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-168"></a>                                <span class='hs-varid'>tcInferRhoNC</span> <span class='hs-varid'>expr</span>
<a name="line-169"></a>                                <span class='hs-comment'>-- NC for no context; tcBracket does that</span>
<a name="line-170"></a>
<a name="line-171"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>meta_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTExpTy</span> <span class='hs-varid'>expr_ty</span>
<a name="line-172"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_ref</span>
<a name="line-173"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>texpco</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>unsafeTExpCoerceName</span>
<a name="line-174"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcWrapResultO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"TExpBr"</span><span class='hs-layout'>)</span>
<a name="line-175"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyApp</span> <span class='hs-varid'>texpco</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>expr_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-176"></a>                                              <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-177"></a>                       <span class='hs-varid'>meta_ty</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-178"></a><span class='hs-definition'>tcTypedBracket</span> <span class='hs-varid'>other_brack</span> <span class='hs-keyword'>_</span>
<a name="line-179"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcTypedBracket"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other_brack</span><span class='hs-layout'>)</span>
<a name="line-180"></a>
<a name="line-181"></a><span class='hs-comment'>-- tcUntypedBracket :: HsBracket Name -&gt; [PendingRnSplice] -&gt; ExpRhoType -&gt; TcM (HsExpr TcId)</span>
<a name="line-182"></a><span class='hs-definition'>tcUntypedBracket</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>res_ty</span>
<a name="line-183"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_bracket untyped"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>brack</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-184"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcPendingSplice</span> <span class='hs-varid'>ps</span>
<a name="line-185"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>meta_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcBrackTy</span> <span class='hs-varid'>brack</span>
<a name="line-186"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_bracket done untyped"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>meta_ty</span><span class='hs-layout'>)</span>
<a name="line-187"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcWrapResultO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"untyped bracket"</span><span class='hs-layout'>)</span>
<a name="line-188"></a>                       <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps'</span><span class='hs-layout'>)</span> <span class='hs-varid'>meta_ty</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="tcBrackTy"></a><span class='hs-comment'>---------------</span>
<a name="line-191"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-192"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarBr</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>nameTyConName</span>  <span class='hs-comment'>-- Result type is Var (not Q-monadic)</span>
<a name="line-193"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExpBr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>expQTyConName</span>  <span class='hs-comment'>-- Result type is ExpQ (= Q Exp)</span>
<a name="line-194"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypBr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>typeQTyConName</span> <span class='hs-comment'>-- Result type is Type (= Q Typ)</span>
<a name="line-195"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>DecBrG</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>decsQTyConName</span> <span class='hs-comment'>-- Result type is Q [Dec]</span>
<a name="line-196"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>patQTyConName</span>  <span class='hs-comment'>-- Result type is PatQ (= Q Pat)</span>
<a name="line-197"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>DecBrL</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcBrackTy: Unexpected DecBrL"</span>
<a name="line-198"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TExpBr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcUntypedBracket: Unexpected TExpBr"</span>
<a name="line-199"></a>
<a name="line-200"></a><a name="tcPendingSplice"></a><span class='hs-comment'>---------------</span>
<a name="line-201"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PendingRnSplice</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PendingTcSplice</span>
<a name="line-202"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnSplice</span> <span class='hs-varid'>flavour</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>meta_ty_name</span>
<a name="line-204"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-205"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingTcSplice</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-206"></a>  <span class='hs-keyword'>where</span>
<a name="line-207"></a>     <span class='hs-varid'>meta_ty_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flavour</span> <span class='hs-keyword'>of</span>
<a name="line-208"></a>                       <span class='hs-conid'>UntypedExpSplice</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>expQTyConName</span>
<a name="line-209"></a>                       <span class='hs-conid'>UntypedPatSplice</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patQTyConName</span>
<a name="line-210"></a>                       <span class='hs-conid'>UntypedTypeSplice</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>typeQTyConName</span>
<a name="line-211"></a>                       <span class='hs-conid'>UntypedDeclSplice</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>decsQTyConName</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="tcTExpTy"></a><span class='hs-comment'>---------------</span>
<a name="line-214"></a><span class='hs-comment'>-- Takes a tau and returns the type Q (TExp tau)</span>
<a name="line-215"></a><span class='hs-definition'>tcTExpTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-216"></a><span class='hs-definition'>tcTExpTy</span> <span class='hs-varid'>exp_ty</span>
<a name="line-217"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTauTy</span> <span class='hs-varid'>exp_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>err_msg</span> <span class='hs-varid'>exp_ty</span><span class='hs-layout'>)</span>
<a name="line-218"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>q</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>qTyConName</span>
<a name="line-219"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>texp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>tExpTyConName</span>
<a name="line-220"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>texp</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>exp_ty</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-221"></a>  <span class='hs-keyword'>where</span>
<a name="line-222"></a>    <span class='hs-varid'>err_msg</span> <span class='hs-varid'>ty</span>
<a name="line-223"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Illegal polytype:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-224"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"The type of a Typed Template Haskell expression must"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-225"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"not have any quantification."</span> <span class='hs-keyglyph'>]</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="quotationCtxtDoc"></a><span class='hs-definition'>quotationCtxtDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-228"></a><span class='hs-definition'>quotationCtxtDoc</span> <span class='hs-varid'>br_body</span>
<a name="line-229"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the Template Haskell quotation"</span><span class='hs-layout'>)</span>
<a name="line-230"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>br_body</span><span class='hs-layout'>)</span>
<a name="line-231"></a>
<a name="line-232"></a>
<a name="line-233"></a>  <span class='hs-comment'>-- The whole of the rest of the file is the else-branch (ie stage2 only)</span>
<a name="line-234"></a>
<a name="line-235"></a><span class='hs-comment'>{-
<a name="line-236"></a>Note [How top-level splices are handled]
<a name="line-237"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-238"></a>Top-level splices (those not inside a [| .. |] quotation bracket) are handled
<a name="line-239"></a>very straightforwardly:
<a name="line-240"></a>
<a name="line-241"></a>  1. tcTopSpliceExpr: typecheck the body e of the splice $(e)
<a name="line-242"></a>
<a name="line-243"></a>  2. runMetaT: desugar, compile, run it, and convert result back to
<a name="line-244"></a>     HsSyn RdrName (of the appropriate flavour, eg HsType RdrName,
<a name="line-245"></a>     HsExpr RdrName etc)
<a name="line-246"></a>
<a name="line-247"></a>  3. treat the result as if that's what you saw in the first place
<a name="line-248"></a>     e.g for HsType, rename and kind-check
<a name="line-249"></a>         for HsExpr, rename and type-check
<a name="line-250"></a>
<a name="line-251"></a>     (The last step is different for decls, because they can *only* be
<a name="line-252"></a>      top-level: we return the result of step 2.)
<a name="line-253"></a>
<a name="line-254"></a>Note [How brackets and nested splices are handled]
<a name="line-255"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-256"></a>Nested splices (those inside a [| .. |] quotation bracket),
<a name="line-257"></a>are treated quite differently.
<a name="line-258"></a>
<a name="line-259"></a>Remember, there are two forms of bracket
<a name="line-260"></a>         typed   [|| e ||]
<a name="line-261"></a>   and untyped   [|  e  |]
<a name="line-262"></a>
<a name="line-263"></a>The life cycle of a typed bracket:
<a name="line-264"></a>   * Starts as HsBracket
<a name="line-265"></a>
<a name="line-266"></a>   * When renaming:
<a name="line-267"></a>        * Set the ThStage to (Brack s RnPendingTyped)
<a name="line-268"></a>        * Rename the body
<a name="line-269"></a>        * Result is still a HsBracket
<a name="line-270"></a>
<a name="line-271"></a>   * When typechecking:
<a name="line-272"></a>        * Set the ThStage to (Brack s (TcPending ps_var lie_var))
<a name="line-273"></a>        * Typecheck the body, and throw away the elaborated result
<a name="line-274"></a>        * Nested splices (which must be typed) are typechecked, and
<a name="line-275"></a>          the results accumulated in ps_var; their constraints
<a name="line-276"></a>          accumulate in lie_var
<a name="line-277"></a>        * Result is a HsTcBracketOut rn_brack pending_splices
<a name="line-278"></a>          where rn_brack is the incoming renamed bracket
<a name="line-279"></a>
<a name="line-280"></a>The life cycle of a un-typed bracket:
<a name="line-281"></a>   * Starts as HsBracket
<a name="line-282"></a>
<a name="line-283"></a>   * When renaming:
<a name="line-284"></a>        * Set the ThStage to (Brack s (RnPendingUntyped ps_var))
<a name="line-285"></a>        * Rename the body
<a name="line-286"></a>        * Nested splices (which must be untyped) are renamed, and the
<a name="line-287"></a>          results accumulated in ps_var
<a name="line-288"></a>        * Result is still (HsRnBracketOut rn_body pending_splices)
<a name="line-289"></a>
<a name="line-290"></a>   * When typechecking a HsRnBracketOut
<a name="line-291"></a>        * Typecheck the pending_splices individually
<a name="line-292"></a>        * Ignore the body of the bracket; just check that the context
<a name="line-293"></a>          expects a bracket of that type (e.g. a [p| pat |] bracket should
<a name="line-294"></a>          be in a context needing a (Q Pat)
<a name="line-295"></a>        * Result is a HsTcBracketOut rn_brack pending_splices
<a name="line-296"></a>          where rn_brack is the incoming renamed bracket
<a name="line-297"></a>
<a name="line-298"></a>
<a name="line-299"></a>In both cases, desugaring happens like this:
<a name="line-300"></a>  * HsTcBracketOut is desugared by DsMeta.dsBracket.  It
<a name="line-301"></a>
<a name="line-302"></a>      a) Extends the ds_meta environment with the PendingSplices
<a name="line-303"></a>         attached to the bracket
<a name="line-304"></a>
<a name="line-305"></a>      b) Converts the quoted (HsExpr Name) to a CoreExpr that, when
<a name="line-306"></a>         run, will produce a suitable TH expression/type/decl.  This
<a name="line-307"></a>         is why we leave the *renamed* expression attached to the bracket:
<a name="line-308"></a>         the quoted expression should not be decorated with all the goop
<a name="line-309"></a>         added by the type checker
<a name="line-310"></a>
<a name="line-311"></a>  * Each splice carries a unique Name, called a "splice point", thus
<a name="line-312"></a>    ${n}(e).  The name is initialised to an (Unqual "splice") when the
<a name="line-313"></a>    splice is created; the renamer gives it a unique.
<a name="line-314"></a>
<a name="line-315"></a>  * When DsMeta (used to desugar the body of the bracket) comes across
<a name="line-316"></a>    a splice, it looks up the splice's Name, n, in the ds_meta envt,
<a name="line-317"></a>    to find an (HsExpr Id) that should be substituted for the splice;
<a name="line-318"></a>    it just desugars it to get a CoreExpr (DsMeta.repSplice).
<a name="line-319"></a>
<a name="line-320"></a>Example:
<a name="line-321"></a>    Source:       f = [| Just $(g 3) |]
<a name="line-322"></a>      The [| |] part is a HsBracket
<a name="line-323"></a>
<a name="line-324"></a>    Typechecked:  f = [| Just ${s7}(g 3) |]{s7 = g Int 3}
<a name="line-325"></a>      The [| |] part is a HsBracketOut, containing *renamed*
<a name="line-326"></a>        (not typechecked) expression
<a name="line-327"></a>      The "s7" is the "splice point"; the (g Int 3) part
<a name="line-328"></a>        is a typechecked expression
<a name="line-329"></a>
<a name="line-330"></a>    Desugared:    f = do { s7 &lt;- g Int 3
<a name="line-331"></a>                         ; return (ConE "Data.Maybe.Just" s7) }
<a name="line-332"></a>
<a name="line-333"></a>
<a name="line-334"></a>Note [Template Haskell state diagram]
<a name="line-335"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-336"></a>Here are the ThStages, s, their corresponding level numbers
<a name="line-337"></a>(the result of (thLevel s)), and their state transitions.
<a name="line-338"></a>The top level of the program is stage Comp:
<a name="line-339"></a>
<a name="line-340"></a>     Start here
<a name="line-341"></a>         |
<a name="line-342"></a>         V
<a name="line-343"></a>      -----------     $      ------------   $
<a name="line-344"></a>      |  Comp   | ---------&gt; |  Splice  | -----|
<a name="line-345"></a>      |   1     |            |    0     | &lt;----|
<a name="line-346"></a>      -----------            ------------
<a name="line-347"></a>        ^     |                ^      |
<a name="line-348"></a>      $ |     | [||]         $ |      | [||]
<a name="line-349"></a>        |     v                |      v
<a name="line-350"></a>   --------------          ----------------
<a name="line-351"></a>   | Brack Comp |          | Brack Splice |
<a name="line-352"></a>   |     2      |          |      1       |
<a name="line-353"></a>   --------------          ----------------
<a name="line-354"></a>
<a name="line-355"></a>* Normal top-level declarations start in state Comp
<a name="line-356"></a>       (which has level 1).
<a name="line-357"></a>  Annotations start in state Splice, since they are
<a name="line-358"></a>       treated very like a splice (only without a '$')
<a name="line-359"></a>
<a name="line-360"></a>* Code compiled in state Splice (and only such code)
<a name="line-361"></a>  will be *run at compile time*, with the result replacing
<a name="line-362"></a>  the splice
<a name="line-363"></a>
<a name="line-364"></a>* The original paper used level -1 instead of 0, etc.
<a name="line-365"></a>
<a name="line-366"></a>* The original paper did not allow a splice within a
<a name="line-367"></a>  splice, but there is no reason not to. This is the
<a name="line-368"></a>  $ transition in the top right.
<a name="line-369"></a>
<a name="line-370"></a>Note [Template Haskell levels]
<a name="line-371"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-372"></a>* Imported things are impLevel (= 0)
<a name="line-373"></a>
<a name="line-374"></a>* However things at level 0 are not *necessarily* imported.
<a name="line-375"></a>      eg  $( \b -&gt; ... )   here b is bound at level 0
<a name="line-376"></a>
<a name="line-377"></a>* In GHCi, variables bound by a previous command are treated
<a name="line-378"></a>  as impLevel, because we have bytecode for them.
<a name="line-379"></a>
<a name="line-380"></a>* Variables are bound at the "current level"
<a name="line-381"></a>
<a name="line-382"></a>* The current level starts off at outerLevel (= 1)
<a name="line-383"></a>
<a name="line-384"></a>* The level is decremented by splicing $(..)
<a name="line-385"></a>               incremented by brackets [| |]
<a name="line-386"></a>               incremented by name-quoting 'f
<a name="line-387"></a>
<a name="line-388"></a>When a variable is used, we compare
<a name="line-389"></a>        bind:  binding level, and
<a name="line-390"></a>        use:   current level at usage site
<a name="line-391"></a>
<a name="line-392"></a>  Generally
<a name="line-393"></a>        bind &gt; use      Always error (bound later than used)
<a name="line-394"></a>                        [| \x -&gt; $(f x) |]
<a name="line-395"></a>
<a name="line-396"></a>        bind = use      Always OK (bound same stage as used)
<a name="line-397"></a>                        [| \x -&gt; $(f [| x |]) |]
<a name="line-398"></a>
<a name="line-399"></a>        bind &lt; use      Inside brackets, it depends
<a name="line-400"></a>                        Inside splice, OK
<a name="line-401"></a>                        Inside neither, OK
<a name="line-402"></a>
<a name="line-403"></a>  For (bind &lt; use) inside brackets, there are three cases:
<a name="line-404"></a>    - Imported things   OK      f = [| map |]
<a name="line-405"></a>    - Top-level things  OK      g = [| f |]
<a name="line-406"></a>    - Non-top-level     Only if there is a liftable instance
<a name="line-407"></a>                                h = \(x:Int) -&gt; [| x |]
<a name="line-408"></a>
<a name="line-409"></a>  To track top-level-ness we use the ThBindEnv in TcLclEnv
<a name="line-410"></a>
<a name="line-411"></a>  For example:
<a name="line-412"></a>           f = ...
<a name="line-413"></a>           g1 = $(map ...)         is OK
<a name="line-414"></a>           g2 = $(f ...)           is not OK; because we havn't compiled f yet
<a name="line-415"></a>
<a name="line-416"></a>-}</span>
<a name="line-417"></a>
<a name="line-418"></a><span class='hs-comment'>{-
<a name="line-419"></a>************************************************************************
<a name="line-420"></a>*                                                                      *
<a name="line-421"></a>\subsection{Splicing an expression}
<a name="line-422"></a>*                                                                      *
<a name="line-423"></a>************************************************************************
<a name="line-424"></a>-}</span>
<a name="line-425"></a>
<a name="line-426"></a><span class='hs-definition'>tcSpliceExpr</span> <span class='hs-varid'>splice</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTypedSplice</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-427"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spliceCtxtDoc</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-428"></a>    <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>    <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-429"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-430"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stage</span> <span class='hs-keyword'>of</span>
<a name="line-431"></a>          <span class='hs-conid'>Splice</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcTopSplice</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-432"></a>          <span class='hs-conid'>Brack</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varid'>pend</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcNestedSplice</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varid'>pend</span> <span class='hs-varid'>name</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-433"></a>          <span class='hs-conid'>RunSplice</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span>
<a name="line-434"></a>            <span class='hs-comment'>-- See Note [RunSplice ThLevel] in "TcRnTypes".</span>
<a name="line-435"></a>            <span class='hs-varid'>pprPanic</span> <span class='hs-layout'>(</span><span class='hs-str'>"tcSpliceExpr: attempted to typecheck a splice when "</span> <span class='hs-varop'>++</span>
<a name="line-436"></a>                      <span class='hs-str'>"running another splice"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span>
<a name="line-437"></a>          <span class='hs-conid'>Comp</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcTopSplice</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-438"></a>    <span class='hs-layout'>}</span>
<a name="line-439"></a><span class='hs-definition'>tcSpliceExpr</span> <span class='hs-varid'>splice</span> <span class='hs-keyword'>_</span>
<a name="line-440"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcSpliceExpr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span>
<a name="line-441"></a>
<a name="line-442"></a><span class='hs-comment'>{- Note [Collecting modFinalizers in typed splices]
<a name="line-443"></a>   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-444"></a>
<a name="line-445"></a>'qAddModFinalizer' of the @Quasi TcM@ instance adds finalizers in the local
<a name="line-446"></a>environment (see Note [Delaying modFinalizers in untyped splices] in
<a name="line-447"></a>"RnSplice"). Thus after executing the splice, we move the finalizers to the
<a name="line-448"></a>finalizer list in the global environment and set them to use the current local
<a name="line-449"></a>environment (with 'addModFinalizersWithLclEnv').
<a name="line-450"></a>
<a name="line-451"></a>-}</span>
<a name="line-452"></a>
<a name="line-453"></a><a name="tcNestedSplice"></a><span class='hs-definition'>tcNestedSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PendingStuff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-454"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-455"></a>    <span class='hs-comment'>-- See Note [How brackets and nested splices are handled]</span>
<a name="line-456"></a>    <span class='hs-comment'>-- A splice inside brackets</span>
<a name="line-457"></a><span class='hs-definition'>tcNestedSplice</span> <span class='hs-varid'>pop_stage</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPending</span> <span class='hs-varid'>ps_var</span> <span class='hs-varid'>lie_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-458"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expTypeToType</span> <span class='hs-varid'>res_ty</span>
<a name="line-459"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTExpTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-460"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varop'>$</span>
<a name="line-461"></a>                  <span class='hs-varid'>setConstraintVar</span> <span class='hs-varid'>lie_var</span> <span class='hs-varop'>$</span>
<a name="line-462"></a>                  <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>meta_exp_ty</span><span class='hs-layout'>)</span>
<a name="line-463"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>untypeq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>unTypeQName</span>
<a name="line-464"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>expr''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyApp</span> <span class='hs-varid'>untypeq</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>res_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr'</span>
<a name="line-465"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_var</span>
<a name="line-466"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ps_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingTcSplice</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr''</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-467"></a>
<a name="line-468"></a>       <span class='hs-comment'>-- The returned expression is ignored; it's in the pending splices</span>
<a name="line-469"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"tcSpliceExpr"</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-470"></a>
<a name="line-471"></a><span class='hs-definition'>tcNestedSplice</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>splice_name</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-472"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcNestedSplice: rename stage found"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>splice_name</span><span class='hs-layout'>)</span>
<a name="line-473"></a>
<a name="line-474"></a><a name="tcTopSplice"></a><span class='hs-definition'>tcTopSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-475"></a><span class='hs-definition'>tcTopSplice</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-476"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Typecheck the expression,</span>
<a name="line-477"></a>         <span class='hs-comment'>-- making sure it has type Q (T res_ty)</span>
<a name="line-478"></a>         <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expTypeToType</span> <span class='hs-varid'>res_ty</span>
<a name="line-479"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTExpTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-480"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_q_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>Typed</span> <span class='hs-varop'>$</span>
<a name="line-481"></a>                          <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>meta_exp_ty</span><span class='hs-layout'>)</span>
<a name="line-482"></a>
<a name="line-483"></a>         <span class='hs-comment'>-- See Note [Collecting modFinalizers in typed splices].</span>
<a name="line-484"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>modfinalizers_ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcRef</span> <span class='hs-conid'>[]</span>
<a name="line-485"></a>         <span class='hs-comment'>-- Run the expression</span>
<a name="line-486"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunSplice</span> <span class='hs-varid'>modfinalizers_ref</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-487"></a>                    <span class='hs-varid'>runMetaE</span> <span class='hs-varid'>zonked_q_expr</span>
<a name="line-488"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mod_finalizers</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>modfinalizers_ref</span>
<a name="line-489"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addModFinalizersWithLclEnv</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ThModFinalizers</span> <span class='hs-varid'>mod_finalizers</span>
<a name="line-490"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>spliceDescription</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"expression"</span>
<a name="line-491"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>spliceIsDecl</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-492"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>spliceSource</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>expr</span>
<a name="line-493"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>spliceGenerated</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-494"></a>
<a name="line-495"></a>         <span class='hs-comment'>-- Rename and typecheck the spliced-in expression,</span>
<a name="line-496"></a>         <span class='hs-comment'>-- making sure it has type res_ty</span>
<a name="line-497"></a>         <span class='hs-comment'>-- These steps should never fail; this is a *typed* splice</span>
<a name="line-498"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spliceResultDoc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-499"></a>       <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp3</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>
<a name="line-500"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>exp4</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>exp3</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCheckExpType</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-501"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>exp4</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-502"></a>
<a name="line-503"></a><span class='hs-comment'>{-
<a name="line-504"></a>************************************************************************
<a name="line-505"></a>*                                                                      *
<a name="line-506"></a>\subsection{Error messages}
<a name="line-507"></a>*                                                                      *
<a name="line-508"></a>************************************************************************
<a name="line-509"></a>-}</span>
<a name="line-510"></a>
<a name="line-511"></a><a name="spliceCtxtDoc"></a><span class='hs-definition'>spliceCtxtDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-512"></a><span class='hs-definition'>spliceCtxtDoc</span> <span class='hs-varid'>splice</span>
<a name="line-513"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the Template Haskell splice"</span><span class='hs-layout'>)</span>
<a name="line-514"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSplice</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span>
<a name="line-515"></a>
<a name="line-516"></a><a name="spliceResultDoc"></a><span class='hs-definition'>spliceResultDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-517"></a><span class='hs-definition'>spliceResultDoc</span> <span class='hs-varid'>expr</span>
<a name="line-518"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the result of the splice:"</span>
<a name="line-519"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'$'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-520"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"To see what the splice expanded to, use -ddump-splices"</span><span class='hs-keyglyph'>]</span>
<a name="line-521"></a>
<a name="line-522"></a><a name="tcTopSpliceExpr"></a><span class='hs-comment'>-------------------</span>
<a name="line-523"></a><span class='hs-definition'>tcTopSpliceExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SpliceType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-524"></a><span class='hs-comment'>-- Note [How top-level splices are handled]</span>
<a name="line-525"></a><span class='hs-comment'>-- Type check an expression that is the body of a top-level splice</span>
<a name="line-526"></a><span class='hs-comment'>--   (the caller will compile and run it)</span>
<a name="line-527"></a><span class='hs-comment'>-- Note that set the level to Splice, regardless of the original level,</span>
<a name="line-528"></a><span class='hs-comment'>-- before typechecking the expression.  For example:</span>
<a name="line-529"></a><span class='hs-comment'>--      f x = $( ...$(g 3) ... )</span>
<a name="line-530"></a><span class='hs-comment'>-- The recursive call to tcPolyExpr will simply expand the</span>
<a name="line-531"></a><span class='hs-comment'>-- inner escape before dealing with the outer one</span>
<a name="line-532"></a>
<a name="line-533"></a><span class='hs-definition'>tcTopSpliceExpr</span> <span class='hs-varid'>isTypedSplice</span> <span class='hs-varid'>tc_action</span>
<a name="line-534"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- checkNoErrs: must not try to run the thing</span>
<a name="line-535"></a>                   <span class='hs-comment'>-- if the type checker fails!</span>
<a name="line-536"></a>    <span class='hs-varid'>unsetGOptM</span> <span class='hs-conid'>Opt_DeferTypeErrors</span> <span class='hs-varop'>$</span>
<a name="line-537"></a>                   <span class='hs-comment'>-- Don't defer type errors.  Not only are we</span>
<a name="line-538"></a>                   <span class='hs-comment'>-- going to run this code, but we do an unsafe</span>
<a name="line-539"></a>                   <span class='hs-comment'>-- coerce, so we get a seg-fault if, say we</span>
<a name="line-540"></a>                   <span class='hs-comment'>-- splice a type into a place where an expression</span>
<a name="line-541"></a>                   <span class='hs-comment'>-- is expected (Trac #7276)</span>
<a name="line-542"></a>    <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-varid'>isTypedSplice</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-543"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>    <span class='hs-comment'>-- Typecheck the expression</span>
<a name="line-544"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varid'>tc_action</span>
<a name="line-545"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>const_binds</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyTop</span> <span class='hs-varid'>wanted</span>
<a name="line-546"></a>
<a name="line-547"></a>          <span class='hs-comment'>-- Zonk it and tie the knot of dictionary bindings</span>
<a name="line-548"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonkTopLExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsDictLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>const_binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-549"></a>
<a name="line-550"></a><span class='hs-comment'>{-
<a name="line-551"></a>************************************************************************
<a name="line-552"></a>*                                                                      *
<a name="line-553"></a>        Annotations
<a name="line-554"></a>*                                                                      *
<a name="line-555"></a>************************************************************************
<a name="line-556"></a>-}</span>
<a name="line-557"></a>
<a name="line-558"></a><span class='hs-definition'>runAnnotation</span> <span class='hs-varid'>target</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-559"></a>    <span class='hs-comment'>-- Find the classes we want instances for in order to call toAnnotationWrapper</span>
<a name="line-560"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-561"></a>    <span class='hs-varid'>data_class</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>dataClassName</span>
<a name="line-562"></a>    <span class='hs-varid'>to_annotation_wrapper_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>toAnnotationWrapperName</span>
<a name="line-563"></a>
<a name="line-564"></a>    <span class='hs-comment'>-- Check the instances we require live in another module (we want to execute it..)</span>
<a name="line-565"></a>    <span class='hs-comment'>-- and check identifiers live in other modules using TH stage checks. tcSimplifyStagedExpr</span>
<a name="line-566"></a>    <span class='hs-comment'>-- also resolves the LIE constraints to detect e.g. instance ambiguity</span>
<a name="line-567"></a>    <span class='hs-varid'>zonked_wrapped_expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>Untyped</span> <span class='hs-varop'>$</span>
<a name="line-568"></a>           <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferRhoNC</span> <span class='hs-varid'>expr</span>
<a name="line-569"></a>                <span class='hs-comment'>-- We manually wrap the typechecked expression in a call to toAnnotationWrapper</span>
<a name="line-570"></a>                <span class='hs-comment'>-- By instantiating the call &gt;here&lt; it gets registered in the</span>
<a name="line-571"></a>                <span class='hs-comment'>-- LIE consulted by tcTopSpliceExpr</span>
<a name="line-572"></a>                <span class='hs-comment'>-- and hence ensures the appropriate dictionary is bound by const_binds</span>
<a name="line-573"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>wrapper</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCall</span> <span class='hs-conid'>AnnOrigin</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>expr_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>data_class</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>expr_ty</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-574"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>specialised_to_annotation_wrapper_expr</span>
<a name="line-575"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-varid'>wrapper</span>
<a name="line-576"></a>                                      <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>to_annotation_wrapper_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-577"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>specialised_to_annotation_wrapper_expr</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-578"></a>
<a name="line-579"></a>    <span class='hs-comment'>-- Run the appropriately wrapped expression to get the value of</span>
<a name="line-580"></a>    <span class='hs-comment'>-- the annotation and its dictionaries. The return value is of</span>
<a name="line-581"></a>    <span class='hs-comment'>-- type AnnotationWrapper by construction, so this conversion is</span>
<a name="line-582"></a>    <span class='hs-comment'>-- safe</span>
<a name="line-583"></a>    <span class='hs-varid'>serialized</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMetaAW</span> <span class='hs-varid'>zonked_wrapped_expr'</span>
<a name="line-584"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>Annotation</span> <span class='hs-layout'>{</span>
<a name="line-585"></a>               <span class='hs-varid'>ann_target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target</span><span class='hs-layout'>,</span>
<a name="line-586"></a>               <span class='hs-varid'>ann_value</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>serialized</span>
<a name="line-587"></a>           <span class='hs-layout'>}</span>
<a name="line-588"></a>
<a name="line-589"></a><a name="convertAnnotationWrapper"></a><span class='hs-definition'>convertAnnotationWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-conid'>Serialized</span><span class='hs-layout'>)</span>
<a name="line-590"></a><span class='hs-definition'>convertAnnotationWrapper</span> <span class='hs-varid'>fhv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-591"></a>  <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-592"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ExternalInterpreter</span> <span class='hs-varid'>dflags</span>
<a name="line-593"></a>    <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-594"></a>      <span class='hs-conid'>Right</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THAnnWrapper</span> <span class='hs-varid'>fhv</span>
<a name="line-595"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-596"></a>      <span class='hs-varid'>annotation_wrapper</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wormhole</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fhv</span>
<a name="line-597"></a>      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span>
<a name="line-598"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-varid'>annotation_wrapper</span> <span class='hs-keyword'>of</span>
<a name="line-599"></a>           <span class='hs-conid'>AnnotationWrapper</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>serialized</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toSerialized</span> <span class='hs-varid'>serializeWithData</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-600"></a>               <span class='hs-comment'>-- Got the value and dictionaries: build the serialized value and</span>
<a name="line-601"></a>               <span class='hs-comment'>-- call it a day. We ensure that we seq the entire serialized value</span>
<a name="line-602"></a>               <span class='hs-comment'>-- in order that any errors in the user-written code for the</span>
<a name="line-603"></a>               <span class='hs-comment'>-- annotation are exposed at this point.  This is also why we are</span>
<a name="line-604"></a>               <span class='hs-comment'>-- doing all this stuff inside the context of runMeta: it has the</span>
<a name="line-605"></a>               <span class='hs-comment'>-- facilities to deal with user error in a meta-level expression</span>
<a name="line-606"></a>               <span class='hs-varid'>seqSerialized</span> <span class='hs-varid'>serialized</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>serialized</span>
<a name="line-607"></a>
<a name="line-608"></a><a name="seqSerialized"></a><span class='hs-comment'>-- | Force the contents of the Serialized value so weknow it doesn't contain any bottoms</span>
<a name="line-609"></a><span class='hs-definition'>seqSerialized</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Serialized</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-610"></a><span class='hs-definition'>seqSerialized</span> <span class='hs-layout'>(</span><span class='hs-conid'>Serialized</span> <span class='hs-varid'>the_type</span> <span class='hs-varid'>bytes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>the_type</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>bytes</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>()</span>
<a name="line-611"></a>
<a name="line-612"></a>
<a name="line-613"></a><span class='hs-comment'>{-
<a name="line-614"></a>************************************************************************
<a name="line-615"></a>*                                                                      *
<a name="line-616"></a>\subsection{Running an expression}
<a name="line-617"></a>*                                                                      *
<a name="line-618"></a>************************************************************************
<a name="line-619"></a>-}</span>
<a name="line-620"></a>
<a name="line-621"></a><a name="runQuasi"></a><span class='hs-definition'>runQuasi</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Q</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-622"></a><span class='hs-definition'>runQuasi</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>runQ</span> <span class='hs-varid'>act</span>
<a name="line-623"></a>
<a name="line-624"></a><a name="runRemoteModFinalizers"></a><span class='hs-definition'>runRemoteModFinalizers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThModFinalizers</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-625"></a><span class='hs-definition'>runRemoteModFinalizers</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThModFinalizers</span> <span class='hs-varid'>finRefs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-626"></a>  <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-627"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>withForeignRefs</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-conid'>[]</span>
<a name="line-628"></a>      <span class='hs-varid'>withForeignRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-conop'>:</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withForeignRef</span> <span class='hs-varid'>x</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-629"></a>        <span class='hs-varid'>withForeignRefs</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>rs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span>
<a name="line-630"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ExternalInterpreter</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-631"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>env_top</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getEnv</span>
<a name="line-632"></a>    <span class='hs-varid'>withIServ</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-633"></a>      <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-634"></a>      <span class='hs-varid'>th_state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span>
<a name="line-635"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>th_state</span> <span class='hs-keyword'>of</span>
<a name="line-636"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- TH was not started, nothing to do</span>
<a name="line-637"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>fhv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-638"></a>          <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withForeignRef</span> <span class='hs-varid'>fhv</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>st</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-639"></a>            <span class='hs-varid'>withForeignRefs</span> <span class='hs-varid'>finRefs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>qrefs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-640"></a>              <span class='hs-varid'>writeIServ</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>putMessage</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunModFinalizers</span> <span class='hs-varid'>st</span> <span class='hs-varid'>qrefs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-641"></a>          <span class='hs-conid'>()</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>i</span> <span class='hs-conid'>[]</span>
<a name="line-642"></a>          <span class='hs-varid'>readQResult</span> <span class='hs-varid'>i</span>
<a name="line-643"></a>  <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-644"></a>    <span class='hs-varid'>qs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>withForeignRefs</span> <span class='hs-varid'>finRefs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>localRef</span><span class='hs-layout'>)</span>
<a name="line-645"></a>    <span class='hs-varid'>runQuasi</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sequence_</span> <span class='hs-varid'>qs</span>
<a name="line-646"></a>
<a name="line-647"></a><a name="runQResult"></a><span class='hs-definition'>runQResult</span>
<a name="line-648"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-649"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-650"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-651"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-652"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-comment'>{- TH.Q a -}</span>
<a name="line-653"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>b</span>
<a name="line-654"></a><span class='hs-definition'>runQResult</span> <span class='hs-varid'>show_th</span> <span class='hs-varid'>f</span> <span class='hs-varid'>runQ</span> <span class='hs-varid'>expr_span</span> <span class='hs-varid'>hval</span>
<a name="line-655"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>th_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runQ</span> <span class='hs-varid'>hval</span>
<a name="line-656"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Got TH result:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show_th</span> <span class='hs-varid'>th_result</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-657"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>expr_span</span> <span class='hs-varid'>th_result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-658"></a>
<a name="line-659"></a>
<a name="line-660"></a><a name="runMeta"></a><span class='hs-comment'>-----------------</span>
<a name="line-661"></a><span class='hs-definition'>runMeta</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaHook</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>hs_syn</span><span class='hs-layout'>)</span>
<a name="line-662"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>
<a name="line-663"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>hs_syn</span>
<a name="line-664"></a><span class='hs-definition'>runMeta</span> <span class='hs-varid'>unwrap</span> <span class='hs-varid'>e</span>
<a name="line-665"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHooked</span> <span class='hs-varid'>runMetaHook</span> <span class='hs-varid'>defaultRunMeta</span>
<a name="line-666"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unwrap</span> <span class='hs-varid'>h</span> <span class='hs-varid'>e</span> <span class='hs-layout'>}</span>
<a name="line-667"></a>
<a name="line-668"></a><a name="defaultRunMeta"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaHook</span> <span class='hs-conid'>TcM</span>
<a name="line-669"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaE</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-670"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>runQResult</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>convertToHsExpr</span> <span class='hs-varid'>runTHExp</span><span class='hs-layout'>)</span>
<a name="line-671"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaP</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-672"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>runQResult</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>convertToPat</span> <span class='hs-varid'>runTHPat</span><span class='hs-layout'>)</span>
<a name="line-673"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaT</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-674"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>runQResult</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>convertToHsType</span> <span class='hs-varid'>runTHType</span><span class='hs-layout'>)</span>
<a name="line-675"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaD</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-676"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>runQResult</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>convertToHsDecls</span> <span class='hs-varid'>runTHDec</span><span class='hs-layout'>)</span>
<a name="line-677"></a><span class='hs-definition'>defaultRunMeta</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaAW</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-678"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runMeta'</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>convertAnnotationWrapper</span><span class='hs-layout'>)</span>
<a name="line-679"></a>    <span class='hs-comment'>-- We turn off showing the code in meta-level exceptions because doing so exposes</span>
<a name="line-680"></a>    <span class='hs-comment'>-- the toAnnotationWrapper function that we slap around the user's code</span>
<a name="line-681"></a>
<a name="line-682"></a><a name="runMetaAW"></a><span class='hs-comment'>----------------</span>
<a name="line-683"></a><span class='hs-definition'>runMetaAW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>         <span class='hs-comment'>-- Of type AnnotationWrapper</span>
<a name="line-684"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Serialized</span>
<a name="line-685"></a><span class='hs-definition'>runMetaAW</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestAW</span>
<a name="line-686"></a>
<a name="line-687"></a><a name="runMetaE"></a><span class='hs-definition'>runMetaE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>          <span class='hs-comment'>-- Of type (Q Exp)</span>
<a name="line-688"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-689"></a><span class='hs-definition'>runMetaE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestE</span>
<a name="line-690"></a>
<a name="line-691"></a><a name="runMetaP"></a><span class='hs-definition'>runMetaP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>          <span class='hs-comment'>-- Of type (Q Pat)</span>
<a name="line-692"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-693"></a><span class='hs-definition'>runMetaP</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestP</span>
<a name="line-694"></a>
<a name="line-695"></a><a name="runMetaT"></a><span class='hs-definition'>runMetaT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>          <span class='hs-comment'>-- Of type (Q Type)</span>
<a name="line-696"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-697"></a><span class='hs-definition'>runMetaT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestT</span>
<a name="line-698"></a>
<a name="line-699"></a><a name="runMetaD"></a><span class='hs-definition'>runMetaD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>          <span class='hs-comment'>-- Of type Q [Dec]</span>
<a name="line-700"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-701"></a><span class='hs-definition'>runMetaD</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-varid'>metaRequestD</span>
<a name="line-702"></a>
<a name="line-703"></a><a name="runMeta'"></a><span class='hs-comment'>---------------</span>
<a name="line-704"></a><span class='hs-definition'>runMeta'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                 <span class='hs-comment'>-- Whether code should be printed in the exception message</span>
<a name="line-705"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_syn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>                                    <span class='hs-comment'>-- how to print the code</span>
<a name="line-706"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-varid'>hs_syn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- How to run x</span>
<a name="line-707"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>           <span class='hs-comment'>-- Of type x; typically x = Q TH.Exp, or something like that</span>
<a name="line-708"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>hs_syn</span>           <span class='hs-comment'>-- Of type t</span>
<a name="line-709"></a><span class='hs-definition'>runMeta'</span> <span class='hs-varid'>show_code</span> <span class='hs-varid'>ppr_hs</span> <span class='hs-varid'>run_and_convert</span> <span class='hs-varid'>expr</span>
<a name="line-710"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"About to run"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-711"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>recordThSpliceUse</span> <span class='hs-comment'>-- seems to be the best place to do this,</span>
<a name="line-712"></a>                            <span class='hs-comment'>-- we catch all kinds of splices and annotations.</span>
<a name="line-713"></a>
<a name="line-714"></a>        <span class='hs-comment'>-- Check that we've had no errors of any sort so far.</span>
<a name="line-715"></a>        <span class='hs-comment'>-- For example, if we found an error in an earlier defn f, but</span>
<a name="line-716"></a>        <span class='hs-comment'>-- recovered giving it type f :: forall a.a, it'd be very dodgy</span>
<a name="line-717"></a>        <span class='hs-comment'>-- to carry ont.  Mind you, the staging restrictions mean we won't</span>
<a name="line-718"></a>        <span class='hs-comment'>-- actually run f, but it still seems wrong. And, more concretely,</span>
<a name="line-719"></a>        <span class='hs-comment'>-- see Trac #5358 for an example that fell over when trying to</span>
<a name="line-720"></a>        <span class='hs-comment'>-- reify a function with a "?" kind in it.  (These don't occur</span>
<a name="line-721"></a>        <span class='hs-comment'>-- in type-correct programs.</span>
<a name="line-722"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>failIfErrsM</span>
<a name="line-723"></a>
<a name="line-724"></a>        <span class='hs-comment'>-- Desugar</span>
<a name="line-725"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ds_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initDsTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-726"></a>        <span class='hs-comment'>-- Compile and link it; might fail if linking fails</span>
<a name="line-727"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-728"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>src_span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-729"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"About to run (desugared)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ds_expr</span><span class='hs-layout'>)</span>
<a name="line-730"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-731"></a>                         <span class='hs-conid'>HscMain</span><span class='hs-varop'>.</span><span class='hs-varid'>hscCompileCoreExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>src_span</span> <span class='hs-varid'>ds_expr</span>
<a name="line-732"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-733"></a>            <span class='hs-conid'>Left</span> <span class='hs-varid'>exn</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail_with_exn</span> <span class='hs-str'>"compile and link"</span> <span class='hs-varid'>exn</span> <span class='hs-layout'>;</span>
<a name="line-734"></a>            <span class='hs-conid'>Right</span> <span class='hs-varid'>hval</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-735"></a>
<a name="line-736"></a>        <span class='hs-layout'>{</span>       <span class='hs-comment'>-- Coerce it to Q t, and run it</span>
<a name="line-737"></a>
<a name="line-738"></a>                <span class='hs-comment'>-- Running might fail if it throws an exception of any kind (hence tryAllM)</span>
<a name="line-739"></a>                <span class='hs-comment'>-- including, say, a pattern-match exception in the code we are running</span>
<a name="line-740"></a>                <span class='hs-comment'>--</span>
<a name="line-741"></a>                <span class='hs-comment'>-- We also do the TH -&gt; HS syntax conversion inside the same</span>
<a name="line-742"></a>                <span class='hs-comment'>-- exception-cacthing thing so that if there are any lurking</span>
<a name="line-743"></a>                <span class='hs-comment'>-- exceptions in the data structure returned by hval, we'll</span>
<a name="line-744"></a>                <span class='hs-comment'>-- encounter them inside the try</span>
<a name="line-745"></a>                <span class='hs-comment'>--</span>
<a name="line-746"></a>                <span class='hs-comment'>-- See Note [Exceptions in TH]</span>
<a name="line-747"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>expr_span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getLoc</span> <span class='hs-varid'>expr</span>
<a name="line-748"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>either_tval</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryAllM</span> <span class='hs-varop'>$</span>
<a name="line-749"></a>                         <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>expr_span</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- Set the span so that qLocation can</span>
<a name="line-750"></a>                                                <span class='hs-comment'>-- see where this splice is</span>
<a name="line-751"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run_and_convert</span> <span class='hs-varid'>expr_span</span> <span class='hs-varid'>hval</span>
<a name="line-752"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_result</span> <span class='hs-keyword'>of</span>
<a name="line-753"></a>                    <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>err</span>
<a name="line-754"></a>                    <span class='hs-conid'>Right</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Got HsSyn result:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_hs</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-755"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-756"></a>
<a name="line-757"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_tval</span> <span class='hs-keyword'>of</span>
<a name="line-758"></a>            <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-759"></a>            <span class='hs-conid'>Left</span> <span class='hs-varid'>se</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>se</span> <span class='hs-keyword'>of</span>
<a name="line-760"></a>                         <span class='hs-conid'>Just</span> <span class='hs-conid'>IOEnvFailure</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failM</span> <span class='hs-comment'>-- Error already in Tc monad</span>
<a name="line-761"></a>                         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail_with_exn</span> <span class='hs-str'>"run"</span> <span class='hs-varid'>se</span> <span class='hs-comment'>-- Exception</span>
<a name="line-762"></a>        <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-763"></a>  <span class='hs-keyword'>where</span>
<a name="line-764"></a>    <span class='hs-comment'>-- see Note [Concealed TH exceptions]</span>
<a name="line-765"></a>    <span class='hs-varid'>fail_with_exn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exception</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-766"></a>    <span class='hs-varid'>fail_with_exn</span> <span class='hs-varid'>phase</span> <span class='hs-varid'>exn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-767"></a>        <span class='hs-varid'>exn_msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Panic</span><span class='hs-varop'>.</span><span class='hs-varid'>safeShowException</span> <span class='hs-varid'>exn</span>
<a name="line-768"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Exception when trying to"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>phase</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"compile-time code:"</span><span class='hs-layout'>,</span>
<a name="line-769"></a>                        <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>exn_msg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-770"></a>                        <span class='hs-keyword'>if</span> <span class='hs-varid'>show_code</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Code:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-keyglyph'>]</span>
<a name="line-771"></a>        <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-772"></a>
<a name="line-773"></a><span class='hs-comment'>{-
<a name="line-774"></a>Note [Exceptions in TH]
<a name="line-775"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-776"></a>Suppose we have something like this
<a name="line-777"></a>        $( f 4 )
<a name="line-778"></a>where
<a name="line-779"></a>        f :: Int -&gt; Q [Dec]
<a name="line-780"></a>        f n | n&gt;3       = fail "Too many declarations"
<a name="line-781"></a>            | otherwise = ...
<a name="line-782"></a>
<a name="line-783"></a>The 'fail' is a user-generated failure, and should be displayed as a
<a name="line-784"></a>perfectly ordinary compiler error message, not a panic or anything
<a name="line-785"></a>like that.  Here's how it's processed:
<a name="line-786"></a>
<a name="line-787"></a>  * 'fail' is the monad fail.  The monad instance for Q in TH.Syntax
<a name="line-788"></a>    effectively transforms (fail s) to
<a name="line-789"></a>        qReport True s &gt;&gt; fail
<a name="line-790"></a>    where 'qReport' comes from the Quasi class and fail from its monad
<a name="line-791"></a>    superclass.
<a name="line-792"></a>
<a name="line-793"></a>  * The TcM monad is an instance of Quasi (see TcSplice), and it implements
<a name="line-794"></a>    (qReport True s) by using addErr to add an error message to the bag of errors.
<a name="line-795"></a>    The 'fail' in TcM raises an IOEnvFailure exception
<a name="line-796"></a>
<a name="line-797"></a> * 'qReport' forces the message to ensure any exception hidden in unevaluated
<a name="line-798"></a>   thunk doesn't get into the bag of errors. Otherwise the following splice
<a name="line-799"></a>   will triger panic (Trac #8987):
<a name="line-800"></a>        $(fail undefined)
<a name="line-801"></a>   See also Note [Concealed TH exceptions]
<a name="line-802"></a>
<a name="line-803"></a>  * So, when running a splice, we catch all exceptions; then for
<a name="line-804"></a>        - an IOEnvFailure exception, we assume the error is already
<a name="line-805"></a>                in the error-bag (above)
<a name="line-806"></a>        - other errors, we add an error to the bag
<a name="line-807"></a>    and then fail
<a name="line-808"></a>
<a name="line-809"></a>Note [Concealed TH exceptions]
<a name="line-810"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-811"></a>When displaying the error message contained in an exception originated from TH
<a name="line-812"></a>code, we need to make sure that the error message itself does not contain an
<a name="line-813"></a>exception.  For example, when executing the following splice:
<a name="line-814"></a>
<a name="line-815"></a>    $( error ("foo " ++ error "bar") )
<a name="line-816"></a>
<a name="line-817"></a>the message for the outer exception is a thunk which will throw the inner
<a name="line-818"></a>exception when evaluated.
<a name="line-819"></a>
<a name="line-820"></a>For this reason, we display the message of a TH exception using the
<a name="line-821"></a>'safeShowException' function, which recursively catches any exception thrown
<a name="line-822"></a>when showing an error message.
<a name="line-823"></a>
<a name="line-824"></a>
<a name="line-825"></a>To call runQ in the Tc monad, we need to make TcM an instance of Quasi:
<a name="line-826"></a>-}</span>
<a name="line-827"></a>
<a name="line-828"></a><a name="instance%20TH.Quasi%20TcM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Quasi</span> <span class='hs-conid'>TcM</span> <span class='hs-keyword'>where</span>
<a name="line-829"></a>  <span class='hs-varid'>qNewName</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-830"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getKey</span> <span class='hs-varid'>u</span>
<a name="line-831"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameU</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-832"></a>
<a name="line-833"></a>  <span class='hs-comment'>-- 'msg' is forced to ensure exceptions don't escape,</span>
<a name="line-834"></a>  <span class='hs-comment'>-- see Note [Exceptions in TH]</span>
<a name="line-835"></a>  <span class='hs-varid'>qReport</span> <span class='hs-conid'>True</span> <span class='hs-varid'>msg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqList</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span>  <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-836"></a>  <span class='hs-varid'>qReport</span> <span class='hs-conid'>False</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqList</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addWarn</span> <span class='hs-conid'>NoReason</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-837"></a>
<a name="line-838"></a>  <span class='hs-varid'>qLocation</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-839"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-840"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>of</span>
<a name="line-841"></a>                        <span class='hs-conid'>UnhelpfulSpan</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"qLocation: Unhelpful location"</span>
<a name="line-842"></a>                                                    <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-843"></a>                        <span class='hs-conid'>RealSrcSpan</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>s</span>
<a name="line-844"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Loc</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanFile</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-845"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_module</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-846"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_package</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitIdString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnitId</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-847"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_start</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStartLine</span> <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanStartCol</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-848"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_end</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanEndLine</span>   <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanEndCol</span>   <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-849"></a>
<a name="line-850"></a>  <span class='hs-varid'>qLookupName</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupName</span>
<a name="line-851"></a>  <span class='hs-varid'>qReify</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify</span>
<a name="line-852"></a>  <span class='hs-varid'>qReifyFixity</span> <span class='hs-varid'>nm</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>reifyFixity</span>
<a name="line-853"></a>  <span class='hs-varid'>qReifyInstances</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyInstances</span>
<a name="line-854"></a>  <span class='hs-varid'>qReifyRoles</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyRoles</span>
<a name="line-855"></a>  <span class='hs-varid'>qReifyAnnotations</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyAnnotations</span>
<a name="line-856"></a>  <span class='hs-varid'>qReifyModule</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyModule</span>
<a name="line-857"></a>  <span class='hs-varid'>qReifyConStrictness</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>nm</span>
<a name="line-858"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>dc</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupDataCon</span> <span class='hs-varid'>nm'</span>
<a name="line-859"></a>                              <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bangs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConImplBangs</span> <span class='hs-varid'>dc</span>
<a name="line-860"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyDecidedStrictness</span> <span class='hs-varid'>bangs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-861"></a>
<a name="line-862"></a>        <span class='hs-comment'>-- For qRecover, discard error messages if</span>
<a name="line-863"></a>        <span class='hs-comment'>-- the recovery action is chosen.  Otherwise</span>
<a name="line-864"></a>        <span class='hs-comment'>-- we'll only fail higher up.</span>
<a name="line-865"></a>  <span class='hs-varid'>qRecover</span> <span class='hs-varid'>recover</span> <span class='hs-varid'>main</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryTcDiscardingErrs</span> <span class='hs-varid'>recover</span> <span class='hs-varid'>main</span>
<a name="line-866"></a>  <span class='hs-varid'>qRunIO</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>io</span>
<a name="line-867"></a>
<a name="line-868"></a>  <span class='hs-varid'>qAddDependentFile</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-869"></a>    <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_dependent_files</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-870"></a>    <span class='hs-varid'>dep_files</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-871"></a>    <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>fp</span><span class='hs-conop'>:</span><span class='hs-varid'>dep_files</span><span class='hs-layout'>)</span>
<a name="line-872"></a>
<a name="line-873"></a>  <span class='hs-varid'>qAddTopDecls</span> <span class='hs-varid'>thds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-874"></a>      <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-875"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>convertToHsDecls</span> <span class='hs-varid'>l</span> <span class='hs-varid'>thds</span>
<a name="line-876"></a>      <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyword'>of</span>
<a name="line-877"></a>              <span class='hs-conid'>Left</span> <span class='hs-varid'>exn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"qAddTopDecls: can't convert top-level declarations"</span> <span class='hs-varid'>exn</span>
<a name="line-878"></a>              <span class='hs-conid'>Right</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ds</span>
<a name="line-879"></a>      <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkTopDecl</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-880"></a>      <span class='hs-varid'>th_topdecls_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_topdecls</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-881"></a>      <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_topdecls_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>topds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>topds</span><span class='hs-layout'>)</span>
<a name="line-882"></a>    <span class='hs-keyword'>where</span>
<a name="line-883"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDecl</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-884"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValD</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-885"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>bindName</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectHsBindBinders</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-886"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-887"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-888"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnnD</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-889"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-890"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForD</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignImport</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fd_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-891"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindName</span> <span class='hs-varid'>name</span>
<a name="line-892"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-keyword'>_</span>
<a name="line-893"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Only function, value, annotation, and foreign import declarations may be added with addTopDecl"</span>
<a name="line-894"></a>
<a name="line-895"></a>      <span class='hs-varid'>bindName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-896"></a>      <span class='hs-varid'>bindName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-897"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>th_topnames_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_topnames</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-898"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_topnames_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ns</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendNameSet</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-899"></a>             <span class='hs-layout'>}</span>
<a name="line-900"></a>
<a name="line-901"></a>      <span class='hs-varid'>bindName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span>
<a name="line-902"></a>          <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span>
<a name="line-903"></a>          <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"The binder"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a NameU."</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-904"></a>             <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Probable cause: you used mkName instead of newName to generate a binding."</span><span class='hs-layout'>)</span>
<a name="line-905"></a>
<a name="line-906"></a>  <span class='hs-varid'>qAddForeignFile</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-907"></a>    <span class='hs-varid'>var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_foreign_files</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-908"></a>    <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>var</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>lang</span><span class='hs-layout'>,</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span>
<a name="line-909"></a>
<a name="line-910"></a>  <span class='hs-varid'>qAddModFinalizer</span> <span class='hs-varid'>fin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-911"></a>      <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkRemoteRef</span> <span class='hs-varid'>fin</span>
<a name="line-912"></a>      <span class='hs-varid'>fref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkForeignRef</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>freeRemoteRef</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-913"></a>      <span class='hs-varid'>addModFinalizerRef</span> <span class='hs-varid'>fref</span>
<a name="line-914"></a>
<a name="line-915"></a>  <span class='hs-varid'>qGetQ</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-916"></a>  <span class='hs-varid'>qGetQ</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-917"></a>      <span class='hs-varid'>th_state_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_state</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-918"></a>      <span class='hs-varid'>th_state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>th_state_var</span>
<a name="line-919"></a>      <span class='hs-comment'>-- See #10596 for why we use a scoped type variable here.</span>
<a name="line-920"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>Proxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>th_state</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>fromDynamic</span><span class='hs-layout'>)</span>
<a name="line-921"></a>
<a name="line-922"></a>  <span class='hs-varid'>qPutQ</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-923"></a>      <span class='hs-varid'>th_state_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_state</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-924"></a>      <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_state_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeOf</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toDyn</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-925"></a>
<a name="line-926"></a>  <span class='hs-varid'>qIsExtEnabled</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xoptM</span>
<a name="line-927"></a>
<a name="line-928"></a>  <span class='hs-varid'>qExtsEnabled</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-929"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-930"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toEnum</span> <span class='hs-varop'>$</span> <span class='hs-conid'>IntSet</span><span class='hs-varop'>.</span><span class='hs-varid'>elems</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extensionFlags</span> <span class='hs-varid'>dflags</span>
<a name="line-931"></a>
<a name="line-932"></a><a name="addModFinalizerRef"></a><span class='hs-comment'>-- | Adds a mod finalizer reference to the local environment.</span>
<a name="line-933"></a><span class='hs-definition'>addModFinalizerRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Q</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-934"></a><span class='hs-definition'>addModFinalizerRef</span> <span class='hs-varid'>finRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-935"></a>    <span class='hs-varid'>th_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-936"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>th_stage</span> <span class='hs-keyword'>of</span>
<a name="line-937"></a>      <span class='hs-conid'>RunSplice</span> <span class='hs-varid'>th_modfinalizers_var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_modfinalizers_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>finRef</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span>
<a name="line-938"></a>      <span class='hs-comment'>-- This case happens only if a splice is executed and the caller does</span>
<a name="line-939"></a>      <span class='hs-comment'>-- not set the 'ThStage' to 'RunSplice' to collect finalizers.</span>
<a name="line-940"></a>      <span class='hs-comment'>-- See Note [Delaying modFinalizers in untyped splices] in RnSplice.</span>
<a name="line-941"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-942"></a>        <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addModFinalizer was called when no finalizers were collected"</span>
<a name="line-943"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>th_stage</span><span class='hs-layout'>)</span>
<a name="line-944"></a>
<a name="line-945"></a><a name="finishTH"></a><span class='hs-comment'>-- | Releases the external interpreter state.</span>
<a name="line-946"></a><span class='hs-definition'>finishTH</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-947"></a><span class='hs-definition'>finishTH</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-948"></a>  <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-949"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ExternalInterpreter</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-950"></a>    <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-951"></a>    <span class='hs-varid'>writeTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-952"></a>
<a name="line-953"></a><a name="runTHExp"></a><span class='hs-definition'>runTHExp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Exp</span>
<a name="line-954"></a><span class='hs-definition'>runTHExp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THExp</span>
<a name="line-955"></a>
<a name="line-956"></a><a name="runTHPat"></a><span class='hs-definition'>runTHPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span>
<a name="line-957"></a><span class='hs-definition'>runTHPat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THPat</span>
<a name="line-958"></a>
<a name="line-959"></a><a name="runTHType"></a><span class='hs-definition'>runTHType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-960"></a><span class='hs-definition'>runTHType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THType</span>
<a name="line-961"></a>
<a name="line-962"></a><a name="runTHDec"></a><span class='hs-definition'>runTHDec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-963"></a><span class='hs-definition'>runTHDec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTH</span> <span class='hs-conid'>THDec</span>
<a name="line-964"></a>
<a name="line-965"></a><a name="runTH"></a><span class='hs-definition'>runTH</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Binary</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>THResultType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-966"></a><span class='hs-definition'>runTH</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>fhv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-967"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>env_top</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getEnv</span>
<a name="line-968"></a>  <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-969"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ExternalInterpreter</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-970"></a>    <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-971"></a>       <span class='hs-comment'>-- Run it in the local TcM</span>
<a name="line-972"></a>      <span class='hs-varid'>hv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wormhole</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fhv</span>
<a name="line-973"></a>      <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runQuasi</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-varid'>hv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Q</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-974"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-975"></a>    <span class='hs-keyword'>else</span>
<a name="line-976"></a>      <span class='hs-comment'>-- Run it on the server.  For an overview of how TH works with</span>
<a name="line-977"></a>      <span class='hs-comment'>-- Remote GHCi, see Note [Remote Template Haskell] in</span>
<a name="line-978"></a>      <span class='hs-comment'>-- libraries/ghci/GHCi/TH.hs.</span>
<a name="line-979"></a>      <span class='hs-varid'>withIServ</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-980"></a>        <span class='hs-varid'>rstate</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTHState</span> <span class='hs-varid'>i</span>
<a name="line-981"></a>        <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qLocation</span>
<a name="line-982"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-983"></a>          <span class='hs-varid'>withForeignRef</span> <span class='hs-varid'>rstate</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>state_hv</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-984"></a>          <span class='hs-varid'>withForeignRef</span> <span class='hs-varid'>fhv</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>q_hv</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-985"></a>            <span class='hs-varid'>writeIServ</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>putMessage</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunTH</span> <span class='hs-varid'>state_hv</span> <span class='hs-varid'>q_hv</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-986"></a>        <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>i</span> <span class='hs-conid'>[]</span>
<a name="line-987"></a>        <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readQResult</span> <span class='hs-varid'>i</span>
<a name="line-988"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>runGet</span> <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-conid'>LB</span><span class='hs-varop'>.</span><span class='hs-varid'>fromStrict</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-989"></a>
<a name="line-990"></a>
<a name="line-991"></a><a name="runRemoteTH"></a><span class='hs-comment'>-- | communicate with a remotely-running TH computation until it finishes.</span>
<a name="line-992"></a><span class='hs-comment'>-- See Note [Remote Template Haskell] in libraries/ghci/GHCi/TH.hs.</span>
<a name="line-993"></a><span class='hs-definition'>runRemoteTH</span>
<a name="line-994"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IServ</span>
<a name="line-995"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Messages</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>--  saved from nested calls to qRecover</span>
<a name="line-996"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-997"></a><span class='hs-definition'>runRemoteTH</span> <span class='hs-varid'>iserv</span> <span class='hs-varid'>recovers</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-998"></a>  <span class='hs-conid'>THMsg</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readIServ</span> <span class='hs-varid'>iserv</span> <span class='hs-varid'>getTHMessage</span>
<a name="line-999"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>msg</span> <span class='hs-keyword'>of</span>
<a name="line-1000"></a>    <span class='hs-conid'>RunTHDone</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1001"></a>    <span class='hs-conid'>StartRecover</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- Note [TH recover with -fexternal-interpreter]</span>
<a name="line-1002"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrsVar</span>
<a name="line-1003"></a>      <span class='hs-varid'>msgs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>v</span>
<a name="line-1004"></a>      <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>v</span> <span class='hs-varid'>emptyMessages</span>
<a name="line-1005"></a>      <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>iserv</span> <span class='hs-layout'>(</span><span class='hs-varid'>msgs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>recovers</span><span class='hs-layout'>)</span>
<a name="line-1006"></a>    <span class='hs-conid'>EndRecover</span> <span class='hs-varid'>caught_error</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1007"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrsVar</span>
<a name="line-1008"></a>      <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>prev_msgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>recovers</span> <span class='hs-keyword'>of</span>
<a name="line-1009"></a>             <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"EndRecover"</span>
<a name="line-1010"></a>             <span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-1011"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>caught_error</span>
<a name="line-1012"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>v</span> <span class='hs-varid'>prev_msgs</span>
<a name="line-1013"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionMessages</span> <span class='hs-varid'>prev_msgs</span><span class='hs-layout'>)</span>
<a name="line-1014"></a>      <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>iserv</span> <span class='hs-varid'>rest</span>
<a name="line-1015"></a>    <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1016"></a>      <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handleTHMessage</span> <span class='hs-varid'>msg</span>
<a name="line-1017"></a>      <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeIServ</span> <span class='hs-varid'>iserv</span> <span class='hs-layout'>(</span><span class='hs-varid'>put</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1018"></a>      <span class='hs-varid'>runRemoteTH</span> <span class='hs-varid'>iserv</span> <span class='hs-varid'>recovers</span>
<a name="line-1019"></a>
<a name="line-1020"></a><a name="readQResult"></a><span class='hs-comment'>-- | Read a value of type QResult from the iserv</span>
<a name="line-1021"></a><span class='hs-definition'>readQResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Binary</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>IServ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1022"></a><span class='hs-definition'>readQResult</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1023"></a>  <span class='hs-varid'>qr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readIServ</span> <span class='hs-varid'>i</span> <span class='hs-varid'>get</span>
<a name="line-1024"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>qr</span> <span class='hs-keyword'>of</span>
<a name="line-1025"></a>    <span class='hs-conid'>QDone</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a</span>
<a name="line-1026"></a>    <span class='hs-conid'>QException</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ErrorCall</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>
<a name="line-1027"></a>    <span class='hs-conid'>QFail</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>str</span>
<a name="line-1028"></a>
<a name="line-1029"></a><span class='hs-comment'>{- Note [TH recover with -fexternal-interpreter]
<a name="line-1030"></a>
<a name="line-1031"></a>Recover is slightly tricky to implement.
<a name="line-1032"></a>
<a name="line-1033"></a>The meaning of "recover a b" is
<a name="line-1034"></a> - Do a
<a name="line-1035"></a>   - If it finished successfully, then keep the messages it generated
<a name="line-1036"></a>   - If it failed, discard any messages it generated, and do b
<a name="line-1037"></a>
<a name="line-1038"></a>The messages are managed by GHC in the TcM monad, whereas the
<a name="line-1039"></a>exception-handling is done in the ghc-iserv process, so we have to
<a name="line-1040"></a>coordinate between the two.
<a name="line-1041"></a>
<a name="line-1042"></a>On the server:
<a name="line-1043"></a>  - emit a StartRecover message
<a name="line-1044"></a>  - run "a" inside a catch
<a name="line-1045"></a>    - if it finishes, emit EndRecover False
<a name="line-1046"></a>    - if it fails, emit EndRecover True, then run "b"
<a name="line-1047"></a>
<a name="line-1048"></a>Back in GHC, when we receive:
<a name="line-1049"></a>
<a name="line-1050"></a>  StartRecover
<a name="line-1051"></a>    save the current messages and start with an empty set.
<a name="line-1052"></a>  EndRecover caught_error
<a name="line-1053"></a>    Restore the previous messages,
<a name="line-1054"></a>    and merge in the new messages if caught_error is false.
<a name="line-1055"></a>-}</span>
<a name="line-1056"></a>
<a name="line-1057"></a><a name="getTHState"></a><span class='hs-comment'>-- | Retrieve (or create, if it hasn't been created already), the</span>
<a name="line-1058"></a><span class='hs-comment'>-- remote TH state.  The TH state is a remote reference to an IORef</span>
<a name="line-1059"></a><span class='hs-comment'>-- QState living on the server, and we have to pass this to each RunTH</span>
<a name="line-1060"></a><span class='hs-comment'>-- call we make.</span>
<a name="line-1061"></a><span class='hs-comment'>--</span>
<a name="line-1062"></a><span class='hs-comment'>-- The TH state is stored in tcg_th_remote_state in the TcGblEnv.</span>
<a name="line-1063"></a><span class='hs-comment'>--</span>
<a name="line-1064"></a><span class='hs-definition'>getTHState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IServ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>QState</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1065"></a><span class='hs-definition'>getTHState</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1066"></a>  <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1067"></a>  <span class='hs-varid'>th_state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span>
<a name="line-1068"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>th_state</span> <span class='hs-keyword'>of</span>
<a name="line-1069"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>rhv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>rhv</span>
<a name="line-1070"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1071"></a>      <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>env_top</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getEnv</span>
<a name="line-1072"></a>      <span class='hs-varid'>fhv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkFinalizedHValue</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>iservCall</span> <span class='hs-varid'>i</span> <span class='hs-conid'>StartTH</span>
<a name="line-1073"></a>      <span class='hs-varid'>writeTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fhv</span><span class='hs-layout'>)</span>
<a name="line-1074"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>fhv</span>
<a name="line-1075"></a>
<a name="line-1076"></a><a name="wrapTHResult"></a><span class='hs-definition'>wrapTHResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>THResult</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1077"></a><span class='hs-definition'>wrapTHResult</span> <span class='hs-varid'>tcm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1078"></a>  <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryM</span> <span class='hs-varid'>tcm</span>   <span class='hs-comment'>-- only catch 'fail', treat everything else as catastrophic</span>
<a name="line-1079"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-1080"></a>    <span class='hs-conid'>Left</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>THException</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1081"></a>    <span class='hs-conid'>Right</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>THComplete</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1082"></a>
<a name="line-1083"></a><a name="handleTHMessage"></a><span class='hs-definition'>handleTHMessage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>THMessage</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1084"></a><span class='hs-definition'>handleTHMessage</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>msg</span> <span class='hs-keyword'>of</span>
<a name="line-1085"></a>  <span class='hs-conid'>NewName</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qNewName</span> <span class='hs-varid'>a</span>
<a name="line-1086"></a>  <span class='hs-conid'>Report</span> <span class='hs-varid'>b</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qReport</span> <span class='hs-varid'>b</span> <span class='hs-varid'>str</span>
<a name="line-1087"></a>  <span class='hs-conid'>LookupName</span> <span class='hs-varid'>b</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qLookupName</span> <span class='hs-varid'>b</span> <span class='hs-varid'>str</span>
<a name="line-1088"></a>  <span class='hs-conid'>Reify</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qReify</span> <span class='hs-varid'>n</span>
<a name="line-1089"></a>  <span class='hs-conid'>ReifyFixity</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qReifyFixity</span> <span class='hs-varid'>n</span>
<a name="line-1090"></a>  <span class='hs-conid'>ReifyInstances</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qReifyInstances</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ts</span>
<a name="line-1091"></a>  <span class='hs-conid'>ReifyRoles</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qReifyRoles</span> <span class='hs-varid'>n</span>
<a name="line-1092"></a>  <span class='hs-conid'>ReifyAnnotations</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>tyrep</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1093"></a>    <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getAnnotationsByTypeRep</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>tyrep</span><span class='hs-layout'>)</span>
<a name="line-1094"></a>  <span class='hs-conid'>ReifyModule</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qReifyModule</span> <span class='hs-varid'>m</span>
<a name="line-1095"></a>  <span class='hs-conid'>ReifyConStrictness</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qReifyConStrictness</span> <span class='hs-varid'>nm</span>
<a name="line-1096"></a>  <span class='hs-conid'>AddDependentFile</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qAddDependentFile</span> <span class='hs-varid'>f</span>
<a name="line-1097"></a>  <span class='hs-conid'>AddModFinalizer</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1098"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>env_top</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getEnv</span>
<a name="line-1099"></a>    <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFinalizedHValue</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>addModFinalizerRef</span>
<a name="line-1100"></a>  <span class='hs-conid'>AddTopDecls</span> <span class='hs-varid'>decs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qAddTopDecls</span> <span class='hs-varid'>decs</span>
<a name="line-1101"></a>  <span class='hs-conid'>AddForeignFile</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qAddForeignFile</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>str</span>
<a name="line-1102"></a>  <span class='hs-conid'>IsExtEnabled</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qIsExtEnabled</span> <span class='hs-varid'>ext</span>
<a name="line-1103"></a>  <span class='hs-conid'>ExtsEnabled</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrapTHResult</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>qExtsEnabled</span>
<a name="line-1104"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"handleTHMessage: unexpected message "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-1105"></a>
<a name="line-1106"></a><a name="getAnnotationsByTypeRep"></a><span class='hs-definition'>getAnnotationsByTypeRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AnnLookup</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-1107"></a><span class='hs-definition'>getAnnotationsByTypeRep</span> <span class='hs-varid'>th_name</span> <span class='hs-varid'>tyrep</span>
<a name="line-1108"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThAnnLookup</span> <span class='hs-varid'>th_name</span>
<a name="line-1109"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>topEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-1110"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prepareAnnotations</span> <span class='hs-varid'>topEnv</span> <span class='hs-conid'>Nothing</span>
<a name="line-1111"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1112"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnnsByTypeRep</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tyrep</span>
<a name="line-1113"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedTcgAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnnsByTypeRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_ann_env</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tyrep</span>
<a name="line-1114"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-varop'>++</span> <span class='hs-varid'>selectedTcgAnns</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1115"></a>
<a name="line-1116"></a><span class='hs-comment'>{-
<a name="line-1117"></a>************************************************************************
<a name="line-1118"></a>*                                                                      *
<a name="line-1119"></a>            Instance Testing
<a name="line-1120"></a>*                                                                      *
<a name="line-1121"></a>************************************************************************
<a name="line-1122"></a>-}</span>
<a name="line-1123"></a>
<a name="line-1124"></a><a name="reifyInstances"></a><span class='hs-definition'>reifyInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-1125"></a><span class='hs-definition'>reifyInstances</span> <span class='hs-varid'>th_nm</span> <span class='hs-varid'>th_tys</span>
<a name="line-1126"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the argument of reifyInstances:"</span>
<a name="line-1127"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>th_nm</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>th_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1128"></a>     <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-1129"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConT</span> <span class='hs-varid'>th_nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>th_tys</span><span class='hs-layout'>)</span>
<a name="line-1130"></a>          <span class='hs-comment'>-- #9262 says to bring vars into scope, like in HsForAllTy case</span>
<a name="line-1131"></a>          <span class='hs-comment'>-- of rnHsTyKi</span>
<a name="line-1132"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>free_vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extractHsTyRdrTyVars</span> <span class='hs-varid'>rdr_ty</span>
<a name="line-1133"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv_rdrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>freeKiTyVarsAllVars</span> <span class='hs-varid'>free_vars</span>
<a name="line-1134"></a>          <span class='hs-comment'>-- Rename  to HsType Name</span>
<a name="line-1135"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tv_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fvs</span><span class='hs-layout'>)</span>
<a name="line-1136"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindLRdrNames</span> <span class='hs-varid'>tv_rdrs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tv_names</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1137"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>rdr_ty</span>
<a name="line-1138"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tv_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1139"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-sel'>_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1140"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveEqualities</span> <span class='hs-varop'>$</span>
<a name="line-1141"></a>               <span class='hs-varid'>tcImplicitTKBndrsType</span> <span class='hs-varid'>tv_names</span> <span class='hs-varop'>$</span>
<a name="line-1142"></a>               <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>tcLHsType</span> <span class='hs-varid'>rn_ty</span>
<a name="line-1143"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>emptyZonkEnv</span> <span class='hs-varid'>ty</span>
<a name="line-1144"></a>                <span class='hs-comment'>-- Substitute out the meta type variables</span>
<a name="line-1145"></a>                <span class='hs-comment'>-- In particular, the type might have kind</span>
<a name="line-1146"></a>                <span class='hs-comment'>-- variables inside it (Trac #7477)</span>
<a name="line-1147"></a>
<a name="line-1148"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reifyInstances"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1149"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>   <span class='hs-comment'>-- This expands any type synonyms</span>
<a name="line-1150"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>                 <span class='hs-comment'>-- See Trac #7910</span>
<a name="line-1151"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-1152"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-1153"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifies</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupInstEnv</span> <span class='hs-conid'>False</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-1154"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reifyInstances1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-1155"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>reifyClassInstances</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unifies</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1156"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1157"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-1158"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupFamInstEnv</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1159"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reifyInstances2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-1160"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>reifyFamilyInstances</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fim_instance</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1161"></a>            <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"reifyInstances:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1162"></a>                               <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"is not a class constraint or type family application"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1163"></a>  <span class='hs-keyword'>where</span>
<a name="line-1164"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClassInstanceCtx</span>
<a name="line-1165"></a>    <span class='hs-varid'>bale_out</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-1166"></a>
<a name="line-1167"></a>    <span class='hs-varid'>cvt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-1168"></a>    <span class='hs-varid'>cvt</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>th_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>convertToHsType</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>th_ty</span> <span class='hs-keyword'>of</span>
<a name="line-1169"></a>                      <span class='hs-conid'>Left</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-1170"></a>                      <span class='hs-conid'>Right</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-1171"></a>
<a name="line-1172"></a><span class='hs-comment'>{-
<a name="line-1173"></a>************************************************************************
<a name="line-1174"></a>*                                                                      *
<a name="line-1175"></a>                        Reification
<a name="line-1176"></a>*                                                                      *
<a name="line-1177"></a>************************************************************************
<a name="line-1178"></a>-}</span>
<a name="line-1179"></a>
<a name="line-1180"></a><a name="lookupName"></a><span class='hs-definition'>lookupName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>      <span class='hs-comment'>-- True  &lt;=&gt; type namespace</span>
<a name="line-1181"></a>                        <span class='hs-comment'>-- False &lt;=&gt; value namespace</span>
<a name="line-1182"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-1183"></a><span class='hs-definition'>lookupName</span> <span class='hs-varid'>is_type_name</span> <span class='hs-varid'>s</span>
<a name="line-1184"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-1185"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupLocalRdrEnv</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varid'>rdr_name</span> <span class='hs-keyword'>of</span>
<a name="line-1186"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1187"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_nm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupGlobalOccRn_maybe</span> <span class='hs-varid'>rdr_name</span>
<a name="line-1188"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>mb_nm</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1189"></a>  <span class='hs-keyword'>where</span>
<a name="line-1190"></a>    <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkName</span> <span class='hs-varid'>s</span>       <span class='hs-comment'>-- Parses M.x into a base of 'x' and a module of 'M'</span>
<a name="line-1191"></a>
<a name="line-1192"></a>    <span class='hs-varid'>occ_fs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span>
<a name="line-1193"></a>    <span class='hs-varid'>occ_fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFastString</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>nameBase</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-1194"></a>
<a name="line-1195"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span>
<a name="line-1196"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type_name</span>
<a name="line-1197"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isLexVarSym</span> <span class='hs-varid'>occ_fs</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isLexCon</span> <span class='hs-varid'>occ_fs</span>
<a name="line-1198"></a>                             <span class='hs-keyword'>then</span> <span class='hs-varid'>mkTcOccFS</span>    <span class='hs-varid'>occ_fs</span>
<a name="line-1199"></a>                             <span class='hs-keyword'>else</span> <span class='hs-varid'>mkTyVarOccFS</span> <span class='hs-varid'>occ_fs</span>
<a name="line-1200"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1201"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isLexCon</span> <span class='hs-varid'>occ_fs</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mkDataOccFS</span> <span class='hs-varid'>occ_fs</span>
<a name="line-1202"></a>                             <span class='hs-keyword'>else</span> <span class='hs-varid'>mkVarOccFS</span>  <span class='hs-varid'>occ_fs</span>
<a name="line-1203"></a>
<a name="line-1204"></a>    <span class='hs-varid'>rdr_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>th_name</span> <span class='hs-keyword'>of</span>
<a name="line-1205"></a>                 <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrUnqual</span> <span class='hs-varid'>occ</span>
<a name="line-1206"></a>                 <span class='hs-conid'>Just</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrQual</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span>
<a name="line-1207"></a>
<a name="line-1208"></a><a name="getThing"></a><span class='hs-definition'>getThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-1209"></a><span class='hs-definition'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-1210"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>th_name</span>
<a name="line-1211"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"reify"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_ns</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1212"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tcLookupTh</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-1213"></a>        <span class='hs-comment'>-- ToDo: this tcLookup could fail, which would give a</span>
<a name="line-1214"></a>        <span class='hs-comment'>--       rather unhelpful error message</span>
<a name="line-1215"></a>  <span class='hs-keyword'>where</span>
<a name="line-1216"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameG</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataName</span>  <span class='hs-sel'>_pkg</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"data"</span>
<a name="line-1217"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameG</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TcClsName</span> <span class='hs-sel'>_pkg</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tc"</span>
<a name="line-1218"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameG</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarName</span>   <span class='hs-sel'>_pkg</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"var"</span>
<a name="line-1219"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"reify/ppr_ns"</span>
<a name="line-1220"></a>
<a name="line-1221"></a><a name="reify"></a><span class='hs-definition'>reify</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span>
<a name="line-1222"></a><span class='hs-definition'>reify</span> <span class='hs-varid'>th_name</span>
<a name="line-1223"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reify 1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>showName</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1224"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-1225"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reify 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-1226"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>reifyThing</span> <span class='hs-varid'>thing</span> <span class='hs-layout'>}</span>
<a name="line-1227"></a>
<a name="line-1228"></a><a name="lookupThName"></a><span class='hs-definition'>lookupThName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Name</span>
<a name="line-1229"></a><span class='hs-definition'>lookupThName</span> <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1230"></a>    <span class='hs-varid'>mb_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThName_maybe</span> <span class='hs-varid'>th_name</span>
<a name="line-1231"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span>
<a name="line-1232"></a>        <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>notInScope</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-1233"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>name</span>
<a name="line-1234"></a>
<a name="line-1235"></a><a name="lookupThName_maybe"></a><span class='hs-definition'>lookupThName_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-1236"></a><span class='hs-definition'>lookupThName_maybe</span> <span class='hs-varid'>th_name</span>
<a name="line-1237"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapMaybeM</span> <span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>thRdrNameGuesses</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-1238"></a>          <span class='hs-comment'>-- Pick the first that works</span>
<a name="line-1239"></a>          <span class='hs-comment'>-- E.g. reify (mkName "A") will pick the class A in preference to the data constructor A</span>
<a name="line-1240"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToMaybe</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1241"></a>  <span class='hs-keyword'>where</span>
<a name="line-1242"></a>    <span class='hs-varid'>lookup</span> <span class='hs-varid'>rdr_name</span>
<a name="line-1243"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Repeat much of lookupOccRn, because we want</span>
<a name="line-1244"></a>                <span class='hs-comment'>-- to report errors in a TH-relevant way</span>
<a name="line-1245"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-1246"></a>             <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupLocalRdrEnv</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>rdr_name</span> <span class='hs-keyword'>of</span>
<a name="line-1247"></a>                 <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1248"></a>                 <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupGlobalOccRn_maybe</span> <span class='hs-varid'>rdr_name</span> <span class='hs-layout'>}</span>
<a name="line-1249"></a>
<a name="line-1250"></a><a name="tcLookupTh"></a><span class='hs-definition'>tcLookupTh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-1251"></a><span class='hs-comment'>-- This is a specialised version of TcEnv.tcLookup; specialised mainly in that</span>
<a name="line-1252"></a><span class='hs-comment'>-- it gives a reify-related error message on failure, whereas in the normal</span>
<a name="line-1253"></a><span class='hs-comment'>-- tcLookup, failure is a bug.</span>
<a name="line-1254"></a><span class='hs-definition'>tcLookupTh</span> <span class='hs-varid'>name</span>
<a name="line-1255"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEnvs</span>
<a name="line-1256"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_env</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-1257"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>thing</span><span class='hs-layout'>;</span>
<a name="line-1258"></a>                <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1259"></a>
<a name="line-1260"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_type_env</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-1261"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-1262"></a>                <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1263"></a>
<a name="line-1264"></a>          <span class='hs-comment'>-- EZY: I don't think this choice matters, no TH in signatures!</span>
<a name="line-1265"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_semantic_mod</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-1266"></a>          <span class='hs-keyword'>then</span>  <span class='hs-comment'>-- It's defined in this module</span>
<a name="line-1267"></a>                <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>notInEnv</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1268"></a>
<a name="line-1269"></a>          <span class='hs-keyword'>else</span>
<a name="line-1270"></a>     <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupImported_maybe</span> <span class='hs-varid'>name</span>
<a name="line-1271"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-1272"></a>            <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-1273"></a>            <span class='hs-conid'>Failed</span> <span class='hs-varid'>msg</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-1274"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-1275"></a>
<a name="line-1276"></a><a name="notInScope"></a><span class='hs-definition'>notInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1277"></a><span class='hs-definition'>notInScope</span> <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1278"></a>                     <span class='hs-varid'>text</span> <span class='hs-str'>"is not in scope at a reify"</span>
<a name="line-1279"></a>        <span class='hs-comment'>-- Ugh! Rather an indirect way to display the name</span>
<a name="line-1280"></a>
<a name="line-1281"></a><a name="notInEnv"></a><span class='hs-definition'>notInEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1282"></a><span class='hs-definition'>notInEnv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1283"></a>                     <span class='hs-varid'>text</span> <span class='hs-str'>"is not in the type environment at a reify"</span>
<a name="line-1284"></a>
<a name="line-1285"></a><a name="reifyRoles"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1286"></a><span class='hs-definition'>reifyRoles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>
<a name="line-1287"></a><span class='hs-definition'>reifyRoles</span> <span class='hs-varid'>th_name</span>
<a name="line-1288"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-1289"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-1290"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reify_role</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1291"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"No roles associated with"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1292"></a>       <span class='hs-layout'>}</span>
<a name="line-1293"></a>  <span class='hs-keyword'>where</span>
<a name="line-1294"></a>    <span class='hs-varid'>reify_role</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NominalR</span>
<a name="line-1295"></a>    <span class='hs-varid'>reify_role</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>RepresentationalR</span>
<a name="line-1296"></a>    <span class='hs-varid'>reify_role</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PhantomR</span>
<a name="line-1297"></a>
<a name="line-1298"></a><a name="reifyThing"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1299"></a><span class='hs-definition'>reifyThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span>
<a name="line-1300"></a><span class='hs-comment'>-- The only reason this is monadic is for error reporting,</span>
<a name="line-1301"></a><span class='hs-comment'>-- which in turn is mainly for the case when TH can't express</span>
<a name="line-1302"></a><span class='hs-comment'>-- some random GHC extension</span>
<a name="line-1303"></a>
<a name="line-1304"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1305"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-1306"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>id</span>
<a name="line-1307"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-1308"></a>            <span class='hs-conid'>ClassOpId</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClassOpI</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1309"></a>            <span class='hs-conid'>RecSelId</span><span class='hs-layout'>{</span><span class='hs-varid'>sel_tycon</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>RecSelData</span> <span class='hs-varid'>tc</span><span class='hs-layout'>}</span>
<a name="line-1310"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifySelector</span> <span class='hs-varid'>id</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1311"></a>            <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarI</span>     <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1312"></a>    <span class='hs-layout'>}</span>
<a name="line-1313"></a>
<a name="line-1314"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1315"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1316"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConName</span> <span class='hs-varid'>dc</span>
<a name="line-1317"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1318"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataConI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1319"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConOrigTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1320"></a>        <span class='hs-layout'>}</span>
<a name="line-1321"></a>
<a name="line-1322"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1323"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>ps</span>
<a name="line-1324"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyPatSynType</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSynSig</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-1325"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PatSynI</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1326"></a>
<a name="line-1327"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-varid'>tct_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1328"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Make use of all the info we have, even</span>
<a name="line-1329"></a>                                        <span class='hs-comment'>-- though it may be incomplete</span>
<a name="line-1330"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty1</span>
<a name="line-1331"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1332"></a>
<a name="line-1333"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-1334"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tv1</span>
<a name="line-1335"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty1</span>
<a name="line-1336"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyVarI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1337"></a>
<a name="line-1338"></a><span class='hs-definition'>reifyThing</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifyThing"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTcTyThingCategory</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-1339"></a>
<a name="line-1340"></a><a name="reifyAxBranch"></a><span class='hs-comment'>-------------------------------------------</span>
<a name="line-1341"></a><span class='hs-definition'>reifyAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynEqn</span>
<a name="line-1342"></a><span class='hs-definition'>reifyAxBranch</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1343"></a>            <span class='hs-comment'>-- remove kind patterns (#8884)</span>
<a name="line-1344"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lhs_types_only</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>lhs</span>
<a name="line-1345"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>lhs_types_only</span>
<a name="line-1346"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>annot_th_lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>annotThType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIsPolyTvs</span> <span class='hs-varid'>fam_tvs</span><span class='hs-layout'>)</span>
<a name="line-1347"></a>                                   <span class='hs-varid'>lhs_types_only</span> <span class='hs-varid'>lhs'</span>
<a name="line-1348"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>rhs</span>
<a name="line-1349"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynEqn</span> <span class='hs-varid'>annot_th_lhs</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1350"></a>  <span class='hs-keyword'>where</span>
<a name="line-1351"></a>    <span class='hs-varid'>fam_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTyVars</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-1352"></a>
<a name="line-1353"></a><a name="reifyTyCon"></a><span class='hs-definition'>reifyTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span>
<a name="line-1354"></a><span class='hs-definition'>reifyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1355"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-1356"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyClass</span> <span class='hs-varid'>cls</span>
<a name="line-1357"></a>
<a name="line-1358"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFunTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1359"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PrimTyConI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span>                <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-1360"></a>
<a name="line-1361"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1362"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PrimTyConI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnliftedTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1363"></a>
<a name="line-1364"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1365"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-1366"></a>             <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tc</span>
<a name="line-1367"></a>             <span class='hs-varid'>resVar</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famTcResVar</span> <span class='hs-varid'>tc</span>
<a name="line-1368"></a>
<a name="line-1369"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>res_kind</span>
<a name="line-1370"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>resultSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>injectivity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1371"></a>                 <span class='hs-keyword'>case</span> <span class='hs-varid'>resVar</span> <span class='hs-keyword'>of</span>
<a name="line-1372"></a>                   <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>KindSig</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1373"></a>                   <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1374"></a>                     <span class='hs-keyword'>let</span> <span class='hs-varid'>thName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>name</span>
<a name="line-1375"></a>                         <span class='hs-varid'>injAnnot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>familyTyConInjectivityInfo</span> <span class='hs-varid'>tc</span>
<a name="line-1376"></a>                         <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyVarSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>KindedTV</span> <span class='hs-varid'>thName</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-1377"></a>                         <span class='hs-varid'>inj</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>injAnnot</span> <span class='hs-keyword'>of</span>
<a name="line-1378"></a>                                 <span class='hs-conid'>NotInjective</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1379"></a>                                 <span class='hs-conid'>Injective</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1380"></a>                                     <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InjectivityAnn</span> <span class='hs-varid'>thName</span> <span class='hs-varid'>injRHS</span><span class='hs-layout'>)</span>
<a name="line-1381"></a>                                   <span class='hs-keyword'>where</span>
<a name="line-1382"></a>                                     <span class='hs-varid'>injRHS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarName</span><span class='hs-layout'>)</span>
<a name="line-1383"></a>                                                  <span class='hs-layout'>(</span><span class='hs-varid'>filterByList</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1384"></a>                     <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>inj</span><span class='hs-layout'>)</span>
<a name="line-1385"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1386"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tfHead</span> <span class='hs-keyglyph'>=</span>
<a name="line-1387"></a>               <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeFamilyHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>resultSig</span> <span class='hs-varid'>injectivity</span>
<a name="line-1388"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isOpenTypeFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1389"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-1390"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>instances</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyFamilyInstances</span> <span class='hs-varid'>tc</span>
<a name="line-1391"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>familyInstances</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1392"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FamilyI</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>OpenTypeFamilyD</span> <span class='hs-varid'>tfHead</span><span class='hs-layout'>)</span> <span class='hs-varid'>instances</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1393"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eqns</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1394"></a>                     <span class='hs-keyword'>case</span> <span class='hs-varid'>isClosedSynFamilyTyConWithAxiom_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-1395"></a>                       <span class='hs-conid'>Just</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyAxBranch</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1396"></a>                                  <span class='hs-varid'>fromBranches</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxiomBranches</span> <span class='hs-varid'>ax</span>
<a name="line-1397"></a>                       <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-1398"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FamilyI</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClosedTypeFamilyD</span> <span class='hs-varid'>tfHead</span> <span class='hs-varid'>eqns</span><span class='hs-layout'>)</span>
<a name="line-1399"></a>                      <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1400"></a>
<a name="line-1401"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1402"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-1403"></a>             <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tc</span>
<a name="line-1404"></a>
<a name="line-1405"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyKind</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>
<a name="line-1406"></a>
<a name="line-1407"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1408"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-1409"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>instances</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyFamilyInstances</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>familyInstances</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1410"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FamilyI</span>
<a name="line-1411"></a>                       <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataFamilyD</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span> <span class='hs-varid'>instances</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1412"></a>
<a name="line-1413"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConDefn_maybe</span> <span class='hs-varid'>tc</span>  <span class='hs-comment'>-- Vanilla type synonym</span>
<a name="line-1414"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>rhs</span>
<a name="line-1415"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1416"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyConI</span>
<a name="line-1417"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynD</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1418"></a>       <span class='hs-layout'>}</span>
<a name="line-1419"></a>
<a name="line-1420"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1421"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1422"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-1423"></a>              <span class='hs-varid'>dataCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span>
<a name="line-1424"></a>              <span class='hs-comment'>-- see Note [Reifying GADT data constructors]</span>
<a name="line-1425"></a>              <span class='hs-varid'>isGadt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>dataConEqSpec</span><span class='hs-layout'>)</span> <span class='hs-varid'>dataCons</span>
<a name="line-1426"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>cons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyDataCon</span> <span class='hs-varid'>isGadt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>dataCons</span>
<a name="line-1427"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>r_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1428"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span>
<a name="line-1429"></a>              <span class='hs-varid'>deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>        <span class='hs-comment'>-- Don't know about deriving</span>
<a name="line-1430"></a>              <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span>
<a name="line-1431"></a>                       <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NewtypeD</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>r_tvs</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-varid'>deriv</span>
<a name="line-1432"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span>
<a name="line-1433"></a>                       <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataD</span>    <span class='hs-varid'>cxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>r_tvs</span> <span class='hs-conid'>Nothing</span>       <span class='hs-varid'>cons</span>  <span class='hs-varid'>deriv</span>
<a name="line-1434"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyConI</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1435"></a>
<a name="line-1436"></a><a name="reifyDataCon"></a><span class='hs-definition'>reifyDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Con</span>
<a name="line-1437"></a><span class='hs-comment'>-- For GADTs etc, see Note [Reifying GADT data constructors]</span>
<a name="line-1438"></a><span class='hs-definition'>reifyDataCon</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>dc</span>
<a name="line-1439"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- used for H98 data constructors</span>
<a name="line-1440"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1441"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConInstSig</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>tys</span>
<a name="line-1442"></a>             <span class='hs-comment'>-- used for GADTs data constructors</span>
<a name="line-1443"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>g_univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>g_res_ty</span><span class='hs-layout'>)</span>
<a name="line-1444"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>dc</span>
<a name="line-1445"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>srcUnpks</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcStricts</span><span class='hs-layout'>)</span>
<a name="line-1446"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAndUnzip</span> <span class='hs-varid'>reifySourceBang</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConSrcBangs</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-1447"></a>             <span class='hs-varid'>dcdBangs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Bang</span> <span class='hs-varid'>srcUnpks</span> <span class='hs-varid'>srcStricts</span>
<a name="line-1448"></a>             <span class='hs-varid'>fields</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>dc</span>
<a name="line-1449"></a>             <span class='hs-varid'>name</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>dc</span>
<a name="line-1450"></a>             <span class='hs-comment'>-- Universal tvs present in eq_spec need to be filtered out, as</span>
<a name="line-1451"></a>             <span class='hs-comment'>-- they will not appear anywhere in the type.</span>
<a name="line-1452"></a>             <span class='hs-varid'>eq_spec_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>eqSpecTyVar</span> <span class='hs-varid'>g_eq_spec</span><span class='hs-layout'>)</span>
<a name="line-1453"></a>             <span class='hs-varid'>g_unsbst_univ_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>eq_spec_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>g_univ_tvs</span>
<a name="line-1454"></a>
<a name="line-1455"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>r_arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>g_arg_tys</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1456"></a>
<a name="line-1457"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>main_con</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1458"></a>           <span class='hs-keyword'>if</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1459"></a>                  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>RecC</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip3</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyFieldLabel</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span>
<a name="line-1460"></a>                                         <span class='hs-varid'>dcdBangs</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1461"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1462"></a>                  <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>g_res_ty</span>
<a name="line-1463"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>RecGadtC</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span>
<a name="line-1464"></a>                                     <span class='hs-layout'>(</span><span class='hs-varid'>zip3</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flSelector</span><span class='hs-layout'>)</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span>
<a name="line-1465"></a>                                      <span class='hs-varid'>dcdBangs</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-1466"></a>                <span class='hs-comment'>-- We need to check not isGadtDataCon here because GADT</span>
<a name="line-1467"></a>                <span class='hs-comment'>-- constructors can be declared infix.</span>
<a name="line-1468"></a>                <span class='hs-comment'>-- See Note [Infix GADT constructors] in TcTyClsDecls.</span>
<a name="line-1469"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dataConIsInfix</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1470"></a>                  <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varop'>==</span> <span class='hs-num'>2</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-1471"></a>                  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>r_a1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r_a2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r_arg_tys</span>
<a name="line-1472"></a>                        <span class='hs-keyglyph'>[</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span>   <span class='hs-varid'>s2</span><span class='hs-keyglyph'>]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcdBangs</span>
<a name="line-1473"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixC</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>r_a1</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>r_a2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1474"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1475"></a>                  <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>g_res_ty</span>
<a name="line-1476"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>GadtC</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>dcdBangs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-1477"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1478"></a>                  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NormalC</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>dcdBangs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-1479"></a>
<a name="line-1480"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGadtDataCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>g_unsbst_univ_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>g_ex_tvs</span>
<a name="line-1481"></a>                                                 <span class='hs-layout'>,</span> <span class='hs-varid'>g_theta</span> <span class='hs-layout'>)</span>
<a name="line-1482"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>)</span>
<a name="line-1483"></a>             <span class='hs-varid'>ret_con</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ex_tvs'</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>main_con</span>
<a name="line-1484"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1485"></a>                         <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>theta'</span>
<a name="line-1486"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>ex_tvs''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>ex_tvs'</span> <span class='hs-conid'>Nothing</span>
<a name="line-1487"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ForallC</span> <span class='hs-varid'>ex_tvs''</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>main_con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1488"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>dcdBangs</span> <span class='hs-layout'>)</span>
<a name="line-1489"></a>         <span class='hs-varid'>ret_con</span> <span class='hs-layout'>}</span>
<a name="line-1490"></a>
<a name="line-1491"></a><span class='hs-comment'>-- Note [Reifying GADT data constructors]</span>
<a name="line-1492"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1493"></a><span class='hs-comment'>-- At this point in the compilation pipeline we have no way of telling whether a</span>
<a name="line-1494"></a><span class='hs-comment'>-- data type was declared as a H98 data type or as a GADT.  We have to rely on</span>
<a name="line-1495"></a><span class='hs-comment'>-- heuristics here.  We look at dcEqSpec field of all data constructors in a</span>
<a name="line-1496"></a><span class='hs-comment'>-- data type declaration.  If at least one data constructor has non-empty</span>
<a name="line-1497"></a><span class='hs-comment'>-- dcEqSpec this means that the data type must have been declared as a GADT.</span>
<a name="line-1498"></a><span class='hs-comment'>-- Consider these declarations:</span>
<a name="line-1499"></a><span class='hs-comment'>--</span>
<a name="line-1500"></a><span class='hs-comment'>--   data T a where</span>
<a name="line-1501"></a><span class='hs-comment'>--      MkT :: forall a. (a ~ Int) =&gt; T a</span>
<a name="line-1502"></a><span class='hs-comment'>--</span>
<a name="line-1503"></a><span class='hs-comment'>--   data T a where</span>
<a name="line-1504"></a><span class='hs-comment'>--      MkT :: T Int</span>
<a name="line-1505"></a><span class='hs-comment'>--</span>
<a name="line-1506"></a><span class='hs-comment'>-- First declaration will be reified as a GADT.  Second declaration will be</span>
<a name="line-1507"></a><span class='hs-comment'>-- reified as a normal H98 data type declaration.</span>
<a name="line-1508"></a>
<a name="line-1509"></a><a name="reifyClass"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1510"></a><span class='hs-definition'>reifyClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span>
<a name="line-1511"></a><span class='hs-definition'>reifyClass</span> <span class='hs-varid'>cls</span>
<a name="line-1512"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>theta</span>
<a name="line-1513"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-1514"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>insts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyClassInstances</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstEnv</span><span class='hs-varop'>.</span><span class='hs-varid'>classInstances</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-1515"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>assocTys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>reifyAT</span> <span class='hs-varid'>ats</span>
<a name="line-1516"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ops</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>reify_op</span> <span class='hs-varid'>op_stuff</span>
<a name="line-1517"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-1518"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClassD</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>fds'</span> <span class='hs-layout'>(</span><span class='hs-varid'>assocTys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ops</span><span class='hs-layout'>)</span>
<a name="line-1519"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClassI</span> <span class='hs-varid'>dec</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1520"></a>  <span class='hs-keyword'>where</span>
<a name="line-1521"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fds</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ats</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classExtraBigSig</span> <span class='hs-varid'>cls</span>
<a name="line-1522"></a>    <span class='hs-varid'>fds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>reifyFunDep</span> <span class='hs-varid'>fds</span>
<a name="line-1523"></a>    <span class='hs-varid'>reify_op</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span><span class='hs-layout'>,</span> <span class='hs-varid'>def_meth</span><span class='hs-layout'>)</span>
<a name="line-1524"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-1525"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>op</span>
<a name="line-1526"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>def_meth</span> <span class='hs-keyword'>of</span>
<a name="line-1527"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>GenericDM</span> <span class='hs-varid'>gdm_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1528"></a>                  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gdm_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>gdm_ty</span>
<a name="line-1529"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DefaultSigD</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>gdm_ty'</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-1530"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-1531"></a>
<a name="line-1532"></a>    <span class='hs-varid'>reifyAT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClassATItem</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-1533"></a>    <span class='hs-varid'>reifyAT</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATI</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>def</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1534"></a>      <span class='hs-varid'>tycon'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-1535"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>tycon'</span> <span class='hs-keyword'>of</span>
<a name="line-1536"></a>        <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FamilyI</span> <span class='hs-varid'>dec</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1537"></a>          <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyArgs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tfNames</span> <span class='hs-varid'>dec</span>
<a name="line-1538"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>dec</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1539"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>reifyDefImpl</span> <span class='hs-varid'>tyName</span> <span class='hs-varid'>tyArgs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span>
<a name="line-1540"></a>                            <span class='hs-varid'>def</span>
<a name="line-1541"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifyAT"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>tycon'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1542"></a>
<a name="line-1543"></a>    <span class='hs-varid'>reifyDefImpl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span>
<a name="line-1544"></a>    <span class='hs-varid'>reifyDefImpl</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-1545"></a>      <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynInstD</span> <span class='hs-varid'>n</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynEqn</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarT</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty</span>
<a name="line-1546"></a>
<a name="line-1547"></a>    <span class='hs-varid'>tfNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1548"></a>    <span class='hs-varid'>tfNames</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>OpenTypeFamilyD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeFamilyHead</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1549"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>bndrName</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1550"></a>    <span class='hs-varid'>tfNames</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tfNames"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1551"></a>
<a name="line-1552"></a>    <span class='hs-varid'>bndrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyVarBndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span>
<a name="line-1553"></a>    <span class='hs-varid'>bndrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PlainTV</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-1554"></a>    <span class='hs-varid'>bndrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>KindedTV</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-1555"></a>
<a name="line-1556"></a><a name="annotThType"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1557"></a><span class='hs-comment'>-- | Annotate (with TH.SigT) a type if the first parameter is True</span>
<a name="line-1558"></a><span class='hs-comment'>-- and if the type contains a free variable.</span>
<a name="line-1559"></a><span class='hs-comment'>-- This is used to annotate type patterns for poly-kinded tyvars in</span>
<a name="line-1560"></a><span class='hs-comment'>-- reifying class and type instances. See #8953 and th/T8953.</span>
<a name="line-1561"></a><span class='hs-definition'>annotThType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>   <span class='hs-comment'>-- True &lt;=&gt; annotate</span>
<a name="line-1562"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-1563"></a>  <span class='hs-comment'>-- tiny optimization: if the type is annotated, don't annotate again.</span>
<a name="line-1564"></a><span class='hs-definition'>annotThType</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span>  <span class='hs-varid'>th_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SigT</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>th_ty</span>
<a name="line-1565"></a><span class='hs-definition'>annotThType</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>th_ty</span>
<a name="line-1566"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1567"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span>
<a name="line-1568"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>th_ki</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>ki</span>
<a name="line-1569"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SigT</span> <span class='hs-varid'>th_ty</span> <span class='hs-varid'>th_ki</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1570"></a><span class='hs-definition'>annotThType</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>th_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>th_ty</span>
<a name="line-1571"></a>
<a name="line-1572"></a><a name="mkIsPolyTvs"></a><span class='hs-comment'>-- | For every type variable in the input,</span>
<a name="line-1573"></a><span class='hs-comment'>-- report whether or not the tv is poly-kinded. This is used to eventually</span>
<a name="line-1574"></a><span class='hs-comment'>-- feed into 'annotThType'.</span>
<a name="line-1575"></a><span class='hs-definition'>mkIsPolyTvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span>
<a name="line-1576"></a><span class='hs-definition'>mkIsPolyTvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>is_poly_tv</span>
<a name="line-1577"></a>  <span class='hs-keyword'>where</span>
<a name="line-1578"></a>    <span class='hs-varid'>is_poly_tv</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span>
<a name="line-1579"></a>                    <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varop'>$</span>
<a name="line-1580"></a>                    <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varop'>$</span>
<a name="line-1581"></a>                    <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varop'>$</span>
<a name="line-1582"></a>                    <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-1583"></a>
<a name="line-1584"></a><a name="reifyClassInstances"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1585"></a><span class='hs-definition'>reifyClassInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-1586"></a><span class='hs-definition'>reifyClassInstances</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>insts</span>
<a name="line-1587"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyClassInstance</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIsPolyTvs</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>insts</span>
<a name="line-1588"></a>  <span class='hs-keyword'>where</span>
<a name="line-1589"></a>    <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyVars</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-1590"></a>
<a name="line-1591"></a><a name="reifyClassInstance"></a><span class='hs-definition'>reifyClassInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- True &lt;=&gt; the corresponding tv is poly-kinded</span>
<a name="line-1592"></a>                              <span class='hs-comment'>-- includes only *visible* tvs</span>
<a name="line-1593"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span>
<a name="line-1594"></a><span class='hs-definition'>reifyClassInstance</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-varid'>i</span>
<a name="line-1595"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>theta</span>
<a name="line-1596"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>vis_types</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>cls_tc</span> <span class='hs-varid'>types</span>
<a name="line-1597"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thtypes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>vis_types</span>
<a name="line-1598"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>annot_thtypes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>annotThType</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-varid'>vis_types</span> <span class='hs-varid'>thtypes</span>
<a name="line-1599"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>head_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>annot_thtypes</span>
<a name="line-1600"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InstanceD</span> <span class='hs-varid'>over</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>head_ty</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1601"></a>  <span class='hs-keyword'>where</span>
<a name="line-1602"></a>     <span class='hs-layout'>(</span><span class='hs-sel'>_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>types</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitDFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dfun</span><span class='hs-layout'>)</span>
<a name="line-1603"></a>     <span class='hs-varid'>cls_tc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span>
<a name="line-1604"></a>     <span class='hs-varid'>dfun</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>i</span>
<a name="line-1605"></a>     <span class='hs-varid'>over</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>overlapMode</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_flag</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1606"></a>                  <span class='hs-conid'>NoOverlap</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1607"></a>                  <span class='hs-conid'>Overlappable</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Overlappable</span>
<a name="line-1608"></a>                  <span class='hs-conid'>Overlapping</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Overlapping</span>
<a name="line-1609"></a>                  <span class='hs-conid'>Overlaps</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Overlaps</span>
<a name="line-1610"></a>                  <span class='hs-conid'>Incoherent</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Incoherent</span>
<a name="line-1611"></a>
<a name="line-1612"></a><a name="reifyFamilyInstances"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1613"></a><span class='hs-definition'>reifyFamilyInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-1614"></a><span class='hs-definition'>reifyFamilyInstances</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>fam_insts</span>
<a name="line-1615"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyFamilyInstance</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIsPolyTvs</span> <span class='hs-varid'>fam_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam_insts</span>
<a name="line-1616"></a>  <span class='hs-keyword'>where</span>
<a name="line-1617"></a>    <span class='hs-varid'>fam_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTyVars</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-1618"></a>
<a name="line-1619"></a><a name="reifyFamilyInstance"></a><span class='hs-definition'>reifyFamilyInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- True &lt;=&gt; the corresponding tv is poly-kinded</span>
<a name="line-1620"></a>                              <span class='hs-comment'>-- includes only *visible* tvs</span>
<a name="line-1621"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span>
<a name="line-1622"></a><span class='hs-definition'>reifyFamilyInstance</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-varid'>inst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flavor</span>
<a name="line-1623"></a>                                              <span class='hs-layout'>,</span> <span class='hs-varid'>fi_fam</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam</span>
<a name="line-1624"></a>                                              <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_tvs</span>
<a name="line-1625"></a>                                              <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-1626"></a>                                              <span class='hs-layout'>,</span> <span class='hs-varid'>fi_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1627"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flavor</span> <span class='hs-keyword'>of</span>
<a name="line-1628"></a>      <span class='hs-conid'>SynFamilyInst</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1629"></a>               <span class='hs-comment'>-- remove kind patterns (#8884)</span>
<a name="line-1630"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lhs_types_only</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>lhs</span>
<a name="line-1631"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>lhs_types_only</span>
<a name="line-1632"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>annot_th_lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>annotThType</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-varid'>lhs_types_only</span>
<a name="line-1633"></a>                                                   <span class='hs-varid'>th_lhs</span>
<a name="line-1634"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>rhs</span>
<a name="line-1635"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynInstD</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>fam</span><span class='hs-layout'>)</span>
<a name="line-1636"></a>                                   <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynEqn</span> <span class='hs-varid'>annot_th_lhs</span> <span class='hs-varid'>th_rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1637"></a>
<a name="line-1638"></a>      <span class='hs-conid'>DataFamilyInst</span> <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1639"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rep_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>rep_tc</span>
<a name="line-1640"></a>                 <span class='hs-varid'>fam'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>fam</span>
<a name="line-1641"></a>
<a name="line-1642"></a>                   <span class='hs-comment'>-- eta-expand lhs types, because sometimes data/newtype</span>
<a name="line-1643"></a>                   <span class='hs-comment'>-- instances are eta-reduced; See Trac #9692</span>
<a name="line-1644"></a>                   <span class='hs-comment'>-- See Note [Eta reduction for data family axioms]</span>
<a name="line-1645"></a>                   <span class='hs-comment'>-- in TcInstDcls</span>
<a name="line-1646"></a>                 <span class='hs-layout'>(</span><span class='hs-sel'>_rep_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tc_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-varid'>rhs</span>
<a name="line-1647"></a>                 <span class='hs-varid'>etad_tyvars</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropList</span> <span class='hs-varid'>rep_tc_args</span> <span class='hs-varid'>rep_tvs</span>
<a name="line-1648"></a>                 <span class='hs-varid'>etad_tys</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>etad_tyvars</span>
<a name="line-1649"></a>                 <span class='hs-varid'>eta_expanded_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>fam_tvs</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>etad_tys</span>
<a name="line-1650"></a>                 <span class='hs-varid'>eta_expanded_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>etad_tys</span>
<a name="line-1651"></a>                 <span class='hs-varid'>dataCons</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>rep_tc</span>
<a name="line-1652"></a>                 <span class='hs-comment'>-- see Note [Reifying GADT data constructors]</span>
<a name="line-1653"></a>                 <span class='hs-varid'>isGadt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>dataConEqSpec</span><span class='hs-layout'>)</span> <span class='hs-varid'>dataCons</span>
<a name="line-1654"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>cons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyDataCon</span> <span class='hs-varid'>isGadt</span> <span class='hs-varid'>eta_expanded_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>dataCons</span>
<a name="line-1655"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>types_only</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>eta_expanded_lhs</span>
<a name="line-1656"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>types_only</span>
<a name="line-1657"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>annot_th_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>annotThType</span> <span class='hs-varid'>is_poly_tvs</span> <span class='hs-varid'>types_only</span> <span class='hs-varid'>th_tys</span>
<a name="line-1658"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-1659"></a>               <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>rep_tc</span>
<a name="line-1660"></a>               <span class='hs-keyword'>then</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NewtypeInstD</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>fam'</span> <span class='hs-varid'>annot_th_tys</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-1661"></a>               <span class='hs-keyword'>else</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataInstD</span>    <span class='hs-conid'>[]</span> <span class='hs-varid'>fam'</span> <span class='hs-varid'>annot_th_tys</span> <span class='hs-conid'>Nothing</span>       <span class='hs-varid'>cons</span>  <span class='hs-conid'>[]</span>
<a name="line-1662"></a>           <span class='hs-layout'>}</span>
<a name="line-1663"></a>  <span class='hs-keyword'>where</span>
<a name="line-1664"></a>    <span class='hs-varid'>fam_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstTyCon</span> <span class='hs-varid'>inst</span>
<a name="line-1665"></a>
<a name="line-1666"></a><a name="reifyType"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1667"></a><span class='hs-definition'>reifyType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-1668"></a><span class='hs-comment'>-- Monadic only because of failure</span>
<a name="line-1669"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_for_all</span> <span class='hs-varid'>ty</span>
<a name="line-1670"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyLit</span> <span class='hs-varid'>t</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>LitT</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1671"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1672"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_tc_app</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>   <span class='hs-comment'>-- Do not expand type synonyms here</span>
<a name="line-1673"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span> <span class='hs-varop'>`</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span><span class='hs-varop'>`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1674"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-1675"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_for_all</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- Types like ((?x::Int) =&gt; Char -&gt; Char)</span>
<a name="line-1676"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ArrowT</span> <span class='hs-varop'>`</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span><span class='hs-varop'>`</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>`</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span><span class='hs-varop'>`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1677"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"kind casts"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1678"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"coercions in types"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1679"></a>
<a name="line-1680"></a><a name="reify_for_all"></a><span class='hs-definition'>reify_for_all</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-1681"></a><span class='hs-definition'>reify_for_all</span> <span class='hs-varid'>ty</span>
<a name="line-1682"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>;</span>
<a name="line-1683"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>tau</span>
<a name="line-1684"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-conid'>Nothing</span>
<a name="line-1685"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ForallT</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>cxt'</span> <span class='hs-varid'>tau'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1686"></a>  <span class='hs-keyword'>where</span>
<a name="line-1687"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span>
<a name="line-1688"></a>
<a name="line-1689"></a><a name="reifyTyLit"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoRep</span><span class='hs-varop'>.</span><span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyLit</span>
<a name="line-1690"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1691"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>StrTyLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>unpackFS</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1692"></a>
<a name="line-1693"></a><a name="reifyTypes"></a><span class='hs-definition'>reifyTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1694"></a><span class='hs-definition'>reifyTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyType</span>
<a name="line-1695"></a>
<a name="line-1696"></a><a name="reifyPatSynType"></a><span class='hs-definition'>reifyPatSynType</span>
<a name="line-1697"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-1698"></a><span class='hs-comment'>-- reifies a pattern synonym's type and returns its *complete* type</span>
<a name="line-1699"></a><span class='hs-comment'>-- signature; see NOTE [Pattern synonym signatures and Template</span>
<a name="line-1700"></a><span class='hs-comment'>-- Haskell]</span>
<a name="line-1701"></a><span class='hs-definition'>reifyPatSynType</span> <span class='hs-layout'>(</span><span class='hs-varid'>univTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>req</span><span class='hs-layout'>,</span> <span class='hs-varid'>exTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>argTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>resTy</span><span class='hs-layout'>)</span>
<a name="line-1702"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>univTyVars'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>univTyVars</span> <span class='hs-conid'>Nothing</span>
<a name="line-1703"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>req'</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>req</span>
<a name="line-1704"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>exTyVars'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>exTyVars</span> <span class='hs-conid'>Nothing</span>
<a name="line-1705"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>prov'</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>prov</span>
<a name="line-1706"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau'</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>argTys</span> <span class='hs-varid'>resTy</span><span class='hs-layout'>)</span>
<a name="line-1707"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ForallT</span> <span class='hs-varid'>univTyVars'</span> <span class='hs-varid'>req'</span>
<a name="line-1708"></a>                <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ForallT</span> <span class='hs-varid'>exTyVars'</span> <span class='hs-varid'>prov'</span> <span class='hs-varid'>tau'</span> <span class='hs-layout'>}</span>
<a name="line-1709"></a>
<a name="line-1710"></a><a name="reifyKind"></a><span class='hs-definition'>reifyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Kind</span>
<a name="line-1711"></a><span class='hs-definition'>reifyKind</span>  <span class='hs-varid'>ki</span>
<a name="line-1712"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kis</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFunTys</span> <span class='hs-varid'>ki</span>
<a name="line-1713"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ki'_rep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-varid'>ki'</span>
<a name="line-1714"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kis_rep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>kis</span>
<a name="line-1715"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ArrowT</span><span class='hs-layout'>)</span> <span class='hs-varid'>ki'_rep</span> <span class='hs-varid'>kis_rep</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1716"></a>  <span class='hs-keyword'>where</span>
<a name="line-1717"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>StarT</span>
<a name="line-1718"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConstraintT</span>
<a name="line-1719"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1720"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>k</span>
<a name="line-1721"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>k</span>
<a name="line-1722"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>kc</span> <span class='hs-varid'>kis</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_kc_app</span> <span class='hs-varid'>kc</span> <span class='hs-varid'>kis</span>
<a name="line-1723"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>k1</span>
<a name="line-1724"></a>                                                  <span class='hs-layout'>;</span> <span class='hs-varid'>k2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>k2</span>
<a name="line-1725"></a>                                                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>k1'</span> <span class='hs-varid'>k2'</span><span class='hs-layout'>)</span>
<a name="line-1726"></a>                                                  <span class='hs-layout'>}</span>
<a name="line-1727"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-varid'>k</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"this kind"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-1728"></a>
<a name="line-1729"></a><a name="reify_kc_app"></a><span class='hs-definition'>reify_kc_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Kind</span>
<a name="line-1730"></a><span class='hs-definition'>reify_kc_app</span> <span class='hs-varid'>kc</span> <span class='hs-varid'>kis</span>
<a name="line-1731"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkThAppTs</span> <span class='hs-varid'>r_kc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>vis_kis</span><span class='hs-layout'>)</span>
<a name="line-1732"></a>  <span class='hs-keyword'>where</span>
<a name="line-1733"></a>    <span class='hs-varid'>r_kc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>kc</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TupleT</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>kc</span><span class='hs-layout'>)</span>
<a name="line-1734"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>listTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ListT</span>
<a name="line-1735"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>kc</span><span class='hs-layout'>)</span>
<a name="line-1736"></a>
<a name="line-1737"></a>    <span class='hs-varid'>vis_kis</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>kc</span> <span class='hs-varid'>kis</span>
<a name="line-1738"></a>
<a name="line-1739"></a><a name="reifyCxt"></a><span class='hs-definition'>reifyCxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pred</span><span class='hs-keyglyph'>]</span>
<a name="line-1740"></a><span class='hs-definition'>reifyCxt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyPred</span>
<a name="line-1741"></a>
<a name="line-1742"></a><a name="reifyFunDep"></a><span class='hs-definition'>reifyFunDep</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FunDep</span>
<a name="line-1743"></a><span class='hs-definition'>reifyFunDep</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FunDep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-1744"></a>
<a name="line-1745"></a><a name="reifyTyVars"></a><span class='hs-definition'>reifyTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1746"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyCon</span>  <span class='hs-comment'>-- the tycon if the tycovars are from a tycon.</span>
<a name="line-1747"></a>                            <span class='hs-comment'>-- Used to detect which tvs are implicit.</span>
<a name="line-1748"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyVarBndr</span><span class='hs-keyglyph'>]</span>
<a name="line-1749"></a><span class='hs-definition'>reifyTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>m_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reify_tv</span> <span class='hs-varid'>tvs'</span>
<a name="line-1750"></a>  <span class='hs-keyword'>where</span>
<a name="line-1751"></a>    <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m_tc</span> <span class='hs-keyword'>of</span>
<a name="line-1752"></a>             <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>filterOutInvisibleTyVars</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span>
<a name="line-1753"></a>             <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tvs</span>
<a name="line-1754"></a>
<a name="line-1755"></a>    <span class='hs-comment'>-- even if the kind is *, we need to include a kind annotation,</span>
<a name="line-1756"></a>    <span class='hs-comment'>-- in case a poly-kind would be inferred without the annotation.</span>
<a name="line-1757"></a>    <span class='hs-comment'>-- See #8953 or test th/T8953</span>
<a name="line-1758"></a>    <span class='hs-varid'>reify_tv</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>KindedTV</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>kind</span>
<a name="line-1759"></a>      <span class='hs-keyword'>where</span>
<a name="line-1760"></a>        <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-1761"></a>        <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>tv</span>
<a name="line-1762"></a>
<a name="line-1763"></a><span class='hs-comment'>{-
<a name="line-1764"></a>Note [Kind annotations on TyConApps]
<a name="line-1765"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1766"></a>A poly-kinded tycon sometimes needs a kind annotation to be unambiguous.
<a name="line-1767"></a>For example:
<a name="line-1768"></a>
<a name="line-1769"></a>   type family F a :: k
<a name="line-1770"></a>   type instance F Int  = (Proxy :: * -&gt; *)
<a name="line-1771"></a>   type instance F Bool = (Proxy :: (* -&gt; *) -&gt; *)
<a name="line-1772"></a>
<a name="line-1773"></a>It's hard to figure out where these annotations should appear, so we do this:
<a name="line-1774"></a>Suppose the tycon is applied to n arguments. We strip off the first n
<a name="line-1775"></a>arguments of the tycon's kind. If there are any variables left in the result
<a name="line-1776"></a>kind, we put on a kind annotation. But we must be slightly careful: it's
<a name="line-1777"></a>possible that the tycon's kind will have fewer than n arguments, in the case
<a name="line-1778"></a>that the concrete application instantiates a result kind variable with an
<a name="line-1779"></a>arrow kind. So, if we run out of arguments, we conservatively put on a kind
<a name="line-1780"></a>annotation anyway. This should be a rare case, indeed. Here is an example:
<a name="line-1781"></a>
<a name="line-1782"></a>   data T1 :: k1 -&gt; k2 -&gt; *
<a name="line-1783"></a>   data T2 :: k1 -&gt; k2 -&gt; *
<a name="line-1784"></a>
<a name="line-1785"></a>   type family G (a :: k) :: k
<a name="line-1786"></a>   type instance G T1 = T2
<a name="line-1787"></a>
<a name="line-1788"></a>   type instance F Char = (G T1 Bool :: (* -&gt; *) -&gt; *)   -- F from above
<a name="line-1789"></a>
<a name="line-1790"></a>Here G's kind is (forall k. k -&gt; k), and the desugared RHS of that last
<a name="line-1791"></a>instance of F is (G (* -&gt; (* -&gt; *) -&gt; *) (T1 * (* -&gt; *)) Bool). According to
<a name="line-1792"></a>the algorithm above, there are 3 arguments to G so we should peel off 3
<a name="line-1793"></a>arguments in G's kind. But G's kind has only two arguments. This is the
<a name="line-1794"></a>rare special case, and we conservatively choose to put the annotation
<a name="line-1795"></a>in.
<a name="line-1796"></a>
<a name="line-1797"></a>See #8953 and test th/T8953.
<a name="line-1798"></a>-}</span>
<a name="line-1799"></a>
<a name="line-1800"></a><a name="reify_tc_app"></a><span class='hs-definition'>reify_tc_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-1801"></a><span class='hs-definition'>reify_tc_app</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1802"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1803"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>maybe_sig_t</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkThAppTs</span> <span class='hs-varid'>r_tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1804"></a>  <span class='hs-keyword'>where</span>
<a name="line-1805"></a>    <span class='hs-varid'>arity</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-1806"></a>    <span class='hs-varid'>tc_binders</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tc</span>
<a name="line-1807"></a>    <span class='hs-varid'>tc_res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tc</span>
<a name="line-1808"></a>
<a name="line-1809"></a>    <span class='hs-varid'>r_tc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedSumTyCon</span> <span class='hs-varid'>tc</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>UnboxedSumT</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-1810"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>UnboxedTupleT</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-1811"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPromotedTupleTyCon</span> <span class='hs-varid'>tc</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PromotedTupleT</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-1812"></a>             <span class='hs-comment'>-- See Note [Unboxed tuple RuntimeRep vars] in TyCon</span>
<a name="line-1813"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isPromotedDataCon</span> <span class='hs-varid'>tc</span>
<a name="line-1814"></a>                                            <span class='hs-keyword'>then</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PromotedTupleT</span> <span class='hs-varid'>arity</span>
<a name="line-1815"></a>                                            <span class='hs-keyword'>else</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TupleT</span> <span class='hs-varid'>arity</span>
<a name="line-1816"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>listTyConKey</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ListT</span>
<a name="line-1817"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>nilDataConKey</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PromotedNilT</span>
<a name="line-1818"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>consDataConKey</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PromotedConsT</span>
<a name="line-1819"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>heqTyConKey</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>EqualityT</span>
<a name="line-1820"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>EqualityT</span>
<a name="line-1821"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>coercibleTyCon</span><span class='hs-layout'>)</span>
<a name="line-1822"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPromotedDataCon</span> <span class='hs-varid'>tc</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PromotedT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1823"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1824"></a>
<a name="line-1825"></a>    <span class='hs-comment'>-- See Note [Kind annotations on TyConApps]</span>
<a name="line-1826"></a>    <span class='hs-varid'>maybe_sig_t</span> <span class='hs-varid'>th_type</span>
<a name="line-1827"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>needs_kind_sig</span>
<a name="line-1828"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>full_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1829"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_full_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>full_kind</span>
<a name="line-1830"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SigT</span> <span class='hs-varid'>th_type</span> <span class='hs-varid'>th_full_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1831"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1832"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>th_type</span>
<a name="line-1833"></a>
<a name="line-1834"></a>    <span class='hs-varid'>needs_kind_sig</span>
<a name="line-1835"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>compareLength</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tc_binders</span>
<a name="line-1836"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcIsTyVarTy</span> <span class='hs-varid'>tc_res_kind</span>
<a name="line-1837"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1838"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varop'>$</span>
<a name="line-1839"></a>        <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varop'>$</span>
<a name="line-1840"></a>        <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varop'>$</span>
<a name="line-1841"></a>        <span class='hs-varid'>mkTyConKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropList</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tc_binders</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_res_kind</span>
<a name="line-1842"></a>
<a name="line-1843"></a><a name="reifyPred"></a><span class='hs-definition'>reifyPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoRep</span><span class='hs-varop'>.</span><span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pred</span>
<a name="line-1844"></a><span class='hs-definition'>reifyPred</span> <span class='hs-varid'>ty</span>
<a name="line-1845"></a>  <span class='hs-comment'>-- We could reify the invisible parameter as a class but it seems</span>
<a name="line-1846"></a>  <span class='hs-comment'>-- nicer to support them properly...</span>
<a name="line-1847"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIPPred</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"implicit parameters"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1848"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty</span>
<a name="line-1849"></a>
<a name="line-1850"></a><a name="reifyName"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1851"></a><span class='hs-definition'>reifyName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NamedThing</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span>
<a name="line-1852"></a><span class='hs-definition'>reifyName</span> <span class='hs-varid'>thing</span>
<a name="line-1853"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_varg</span> <span class='hs-varid'>pkg_str</span> <span class='hs-varid'>mod_str</span> <span class='hs-varid'>occ_str</span>
<a name="line-1854"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameU</span> <span class='hs-varid'>occ_str</span> <span class='hs-layout'>(</span><span class='hs-varid'>getKey</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1855"></a>        <span class='hs-comment'>-- Many of the things we reify have local bindings, and</span>
<a name="line-1856"></a>        <span class='hs-comment'>-- NameL's aren't supposed to appear in binding positions, so</span>
<a name="line-1857"></a>        <span class='hs-comment'>-- we use NameU.  When/if we start to reify nested things, that</span>
<a name="line-1858"></a>        <span class='hs-comment'>-- have free variables, we may need to generate NameL's for them.</span>
<a name="line-1859"></a>  <span class='hs-keyword'>where</span>
<a name="line-1860"></a>    <span class='hs-varid'>name</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>thing</span>
<a name="line-1861"></a>    <span class='hs-varid'>mod</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-1862"></a>    <span class='hs-varid'>pkg_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitIdString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnitId</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-1863"></a>    <span class='hs-varid'>mod_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-1864"></a>    <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameString</span> <span class='hs-varid'>occ</span>
<a name="line-1865"></a>    <span class='hs-varid'>occ</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-1866"></a>    <span class='hs-varid'>mk_varg</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>isDataOcc</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameG_d</span>
<a name="line-1867"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>isVarOcc</span>  <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameG_v</span>
<a name="line-1868"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>isTcOcc</span>   <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameG_tc</span>
<a name="line-1869"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifyName"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1870"></a>
<a name="line-1871"></a><a name="reifyFieldLabel"></a><span class='hs-comment'>-- See Note [Reifying field labels]</span>
<a name="line-1872"></a><span class='hs-definition'>reifyFieldLabel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FieldLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span>
<a name="line-1873"></a><span class='hs-definition'>reifyFieldLabel</span> <span class='hs-varid'>fl</span>
<a name="line-1874"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>flIsOverloaded</span> <span class='hs-varid'>fl</span>
<a name="line-1875"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkOccName</span> <span class='hs-varid'>occ_str</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameQ</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkModName</span> <span class='hs-varid'>mod_str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1876"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameG_v</span> <span class='hs-varid'>pkg_str</span> <span class='hs-varid'>mod_str</span> <span class='hs-varid'>occ_str</span>
<a name="line-1877"></a>  <span class='hs-keyword'>where</span>
<a name="line-1878"></a>    <span class='hs-varid'>name</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flSelector</span> <span class='hs-varid'>fl</span>
<a name="line-1879"></a>    <span class='hs-varid'>mod</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-1880"></a>    <span class='hs-varid'>pkg_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitIdString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnitId</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-1881"></a>    <span class='hs-varid'>mod_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-1882"></a>    <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>flLabel</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span>
<a name="line-1883"></a>
<a name="line-1884"></a><a name="reifySelector"></a><span class='hs-definition'>reifySelector</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span>
<a name="line-1885"></a><span class='hs-definition'>reifySelector</span> <span class='hs-varid'>id</span> <span class='hs-varid'>tc</span>
<a name="line-1886"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flSelector</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConFieldLabels</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1887"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>reifyFieldLabel</span> <span class='hs-varid'>fl</span>
<a name="line-1888"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifySelector: missing field"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1889"></a>
<a name="line-1890"></a><a name="reifyFixity"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1891"></a><span class='hs-definition'>reifyFixity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span>
<a name="line-1892"></a><span class='hs-definition'>reifyFixity</span> <span class='hs-varid'>name</span>
<a name="line-1893"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>found</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn_help</span> <span class='hs-varid'>name</span>
<a name="line-1894"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>found</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>conv_fix</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1895"></a>    <span class='hs-keyword'>where</span>
<a name="line-1896"></a>      <span class='hs-varid'>conv_fix</span> <span class='hs-layout'>(</span><span class='hs-conid'>BasicTypes</span><span class='hs-varop'>.</span><span class='hs-conid'>Fixity</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>conv_dir</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-1897"></a>      <span class='hs-varid'>conv_dir</span> <span class='hs-conid'>BasicTypes</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixR</span>
<a name="line-1898"></a>      <span class='hs-varid'>conv_dir</span> <span class='hs-conid'>BasicTypes</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixL</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixL</span>
<a name="line-1899"></a>      <span class='hs-varid'>conv_dir</span> <span class='hs-conid'>BasicTypes</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixN</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixN</span>
<a name="line-1900"></a>
<a name="line-1901"></a><a name="reifyUnpackedness"></a><span class='hs-definition'>reifyUnpackedness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span><span class='hs-varop'>.</span><span class='hs-conid'>SrcUnpackedness</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SourceUnpackedness</span>
<a name="line-1902"></a><span class='hs-definition'>reifyUnpackedness</span> <span class='hs-conid'>NoSrcUnpack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NoSourceUnpackedness</span>
<a name="line-1903"></a><span class='hs-definition'>reifyUnpackedness</span> <span class='hs-conid'>SrcNoUnpack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SourceNoUnpack</span>
<a name="line-1904"></a><span class='hs-definition'>reifyUnpackedness</span> <span class='hs-conid'>SrcUnpack</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SourceUnpack</span>
<a name="line-1905"></a>
<a name="line-1906"></a><a name="reifyStrictness"></a><span class='hs-definition'>reifyStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span><span class='hs-varop'>.</span><span class='hs-conid'>SrcStrictness</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SourceStrictness</span>
<a name="line-1907"></a><span class='hs-definition'>reifyStrictness</span> <span class='hs-conid'>NoSrcStrict</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NoSourceStrictness</span>
<a name="line-1908"></a><span class='hs-definition'>reifyStrictness</span> <span class='hs-conid'>SrcStrict</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SourceStrict</span>
<a name="line-1909"></a><span class='hs-definition'>reifyStrictness</span> <span class='hs-conid'>SrcLazy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SourceLazy</span>
<a name="line-1910"></a>
<a name="line-1911"></a><a name="reifySourceBang"></a><span class='hs-definition'>reifySourceBang</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSrcBang</span>
<a name="line-1912"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SourceUnpackedness</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SourceStrictness</span><span class='hs-layout'>)</span>
<a name="line-1913"></a><span class='hs-definition'>reifySourceBang</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyUnpackedness</span> <span class='hs-varid'>u</span><span class='hs-layout'>,</span> <span class='hs-varid'>reifyStrictness</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1914"></a>
<a name="line-1915"></a><a name="reifyDecidedStrictness"></a><span class='hs-definition'>reifyDecidedStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span><span class='hs-varop'>.</span><span class='hs-conid'>HsImplBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DecidedStrictness</span>
<a name="line-1916"></a><span class='hs-definition'>reifyDecidedStrictness</span> <span class='hs-conid'>HsLazy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DecidedLazy</span>
<a name="line-1917"></a><span class='hs-definition'>reifyDecidedStrictness</span> <span class='hs-conid'>HsStrict</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DecidedStrict</span>
<a name="line-1918"></a><span class='hs-definition'>reifyDecidedStrictness</span> <span class='hs-conid'>HsUnpack</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DecidedUnpack</span>
<a name="line-1919"></a>
<a name="line-1920"></a><a name="lookupThAnnLookup"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1921"></a><span class='hs-definition'>lookupThAnnLookup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AnnLookup</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CoreAnnTarget</span>
<a name="line-1922"></a><span class='hs-definition'>lookupThAnnLookup</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AnnLookupName</span> <span class='hs-varid'>th_nm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>NamedTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupThName</span> <span class='hs-varid'>th_nm</span><span class='hs-layout'>)</span>
<a name="line-1923"></a><span class='hs-definition'>lookupThAnnLookup</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AnnLookupModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span> <span class='hs-varid'>pn</span> <span class='hs-varid'>mn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1924"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ModuleTarget</span> <span class='hs-varop'>$</span>
<a name="line-1925"></a>    <span class='hs-varid'>mkModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>stringToUnitId</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pkgString</span> <span class='hs-varid'>pn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>modString</span> <span class='hs-varid'>mn</span><span class='hs-layout'>)</span>
<a name="line-1926"></a>
<a name="line-1927"></a><a name="reifyAnnotations"></a><span class='hs-definition'>reifyAnnotations</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AnnLookup</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-1928"></a><span class='hs-definition'>reifyAnnotations</span> <span class='hs-varid'>th_name</span>
<a name="line-1929"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThAnnLookup</span> <span class='hs-varid'>th_name</span>
<a name="line-1930"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>topEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-1931"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prepareAnnotations</span> <span class='hs-varid'>topEnv</span> <span class='hs-conid'>Nothing</span>
<a name="line-1932"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-1933"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnns</span> <span class='hs-varid'>deserializeWithData</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-varid'>name</span>
<a name="line-1934"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedTcgAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnns</span> <span class='hs-varid'>deserializeWithData</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_ann_env</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-1935"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-varop'>++</span> <span class='hs-varid'>selectedTcgAnns</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1936"></a>
<a name="line-1937"></a><a name="modToTHMod"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1938"></a><span class='hs-definition'>modToTHMod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span>
<a name="line-1939"></a><span class='hs-definition'>modToTHMod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PkgName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitIdString</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>moduleUnitId</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1940"></a>                         <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1941"></a>
<a name="line-1942"></a><a name="reifyModule"></a><span class='hs-definition'>reifyModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModuleInfo</span>
<a name="line-1943"></a><span class='hs-definition'>reifyModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PkgName</span> <span class='hs-varid'>pkgString</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModName</span> <span class='hs-varid'>mString</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1944"></a>  <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-1945"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>reifMod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>stringToUnitId</span> <span class='hs-varid'>pkgString</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varid'>mString</span><span class='hs-layout'>)</span>
<a name="line-1946"></a>  <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifMod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>reifyThisModule</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>reifyFromIface</span> <span class='hs-varid'>reifMod</span>
<a name="line-1947"></a>    <span class='hs-keyword'>where</span>
<a name="line-1948"></a>      <span class='hs-varid'>reifyThisModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1949"></a>        <span class='hs-varid'>usages</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>modToTHMod</span> <span class='hs-varop'>.</span> <span class='hs-varid'>moduleEnvKeys</span> <span class='hs-varop'>.</span> <span class='hs-varid'>imp_mods</span><span class='hs-layout'>)</span> <span class='hs-varid'>getImports</span>
<a name="line-1950"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModuleInfo</span> <span class='hs-varid'>usages</span>
<a name="line-1951"></a>
<a name="line-1952"></a>      <span class='hs-varid'>reifyFromIface</span> <span class='hs-varid'>reifMod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1953"></a>        <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadInterfaceForModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"reifying module from TH for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>reifMod</span><span class='hs-layout'>)</span> <span class='hs-varid'>reifMod</span>
<a name="line-1954"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>usages</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>modToTHMod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>usage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mi_usages</span> <span class='hs-varid'>iface</span><span class='hs-layout'>,</span>
<a name="line-1955"></a>                                     <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>usageToModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnitId</span> <span class='hs-varid'>reifMod</span><span class='hs-layout'>)</span> <span class='hs-varid'>usage</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-1956"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModuleInfo</span> <span class='hs-varid'>usages</span>
<a name="line-1957"></a>
<a name="line-1958"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnitId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Usage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Module</span>
<a name="line-1959"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsageFile</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1960"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-varid'>this_pkg</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsageHomeModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>usg_mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mn</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkModule</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>mn</span>
<a name="line-1961"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsagePackageModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>usg_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>
<a name="line-1962"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsageMergedRequirement</span> <span class='hs-layout'>{</span> <span class='hs-varid'>usg_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>
<a name="line-1963"></a>
<a name="line-1964"></a><a name="mkThAppTs"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1965"></a><span class='hs-definition'>mkThAppTs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-1966"></a><span class='hs-definition'>mkThAppTs</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1967"></a>
<a name="line-1968"></a><a name="noTH"></a><span class='hs-definition'>noTH</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LitString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1969"></a><span class='hs-definition'>noTH</span> <span class='hs-varid'>s</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Can't represent"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1970"></a>                                <span class='hs-varid'>text</span> <span class='hs-str'>"in Template Haskell:"</span><span class='hs-layout'>,</span>
<a name="line-1971"></a>                             <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1972"></a>
<a name="line-1973"></a><a name="ppr_th"></a><span class='hs-definition'>ppr_th</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Ppr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1974"></a><span class='hs-definition'>ppr_th</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1975"></a>
<a name="line-1976"></a><span class='hs-comment'>{-
<a name="line-1977"></a>Note [Reifying field labels]
<a name="line-1978"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1979"></a>When reifying a datatype declared with DuplicateRecordFields enabled, we want
<a name="line-1980"></a>the reified names of the fields to be labels rather than selector functions.
<a name="line-1981"></a>That is, we want (reify ''T) and (reify 'foo) to produce
<a name="line-1982"></a>
<a name="line-1983"></a>    data T = MkT { foo :: Int }
<a name="line-1984"></a>    foo :: T -&gt; Int
<a name="line-1985"></a>
<a name="line-1986"></a>rather than
<a name="line-1987"></a>
<a name="line-1988"></a>    data T = MkT { $sel:foo:MkT :: Int }
<a name="line-1989"></a>    $sel:foo:MkT :: T -&gt; Int
<a name="line-1990"></a>
<a name="line-1991"></a>because otherwise TH code that uses the field names as strings will silently do
<a name="line-1992"></a>the wrong thing.  Thus we use the field label (e.g. foo) as the OccName, rather
<a name="line-1993"></a>than the selector (e.g. $sel:foo:MkT).  Since the Orig name M.foo isn't in the
<a name="line-1994"></a>environment, NameG can't be used to represent such fields.  Instead,
<a name="line-1995"></a>reifyFieldLabel uses NameQ.
<a name="line-1996"></a>
<a name="line-1997"></a>However, this means that extracting the field name from the output of reify, and
<a name="line-1998"></a>trying to reify it again, may fail with an ambiguity error if there are multiple
<a name="line-1999"></a>such fields defined in the module (see the test case
<a name="line-2000"></a>overloadedrecflds/should_fail/T11103.hs).  The "proper" fix requires changes to
<a name="line-2001"></a>the TH AST to make it able to represent duplicate record fields.
<a name="line-2002"></a>-}</span>
</pre></body>
</html>
