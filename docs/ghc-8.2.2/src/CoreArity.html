<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>coreSyn/CoreArity.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a>        Arity and eta expansion
<a name="line-7"></a>-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>-- | Arity and eta expansion</span>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CoreArity</span> <span class='hs-layout'>(</span>
<a name="line-13"></a>        <span class='hs-varid'>manifestArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>joinRhsArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeArity</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>exprEtaExpandArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>findRhsArity</span><span class='hs-layout'>,</span> <span class='hs-conid'>CheapFun</span><span class='hs-layout'>,</span> <span class='hs-varid'>etaExpand</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>etaExpandToJoinPoint</span><span class='hs-layout'>,</span> <span class='hs-varid'>etaExpandToJoinPointRule</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>exprBotStrictness_maybe</span>
<a name="line-17"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSubst</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>initRecTc</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkRecTc</span> <span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span> <span class='hs-layout'>(</span> <span class='hs-conid'>DynFlags</span><span class='hs-layout'>,</span> <span class='hs-conid'>GeneralFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>gopt</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-comment'>{-
<a name="line-41"></a>************************************************************************
<a name="line-42"></a>*                                                                      *
<a name="line-43"></a>              manifestArity and exprArity
<a name="line-44"></a>*                                                                      *
<a name="line-45"></a>************************************************************************
<a name="line-46"></a>
<a name="line-47"></a>exprArity is a cheap-and-cheerful version of exprEtaExpandArity.
<a name="line-48"></a>It tells how many things the expression can be applied to before doing
<a name="line-49"></a>any work.  It doesn't look inside cases, lets, etc.  The idea is that
<a name="line-50"></a>exprEtaExpandArity will do the hard work, leaving something that's easy
<a name="line-51"></a>for exprArity to grapple with.  In particular, Simplify uses exprArity to
<a name="line-52"></a>compute the ArityInfo for the Id.
<a name="line-53"></a>
<a name="line-54"></a>Originally I thought that it was enough just to look for top-level lambdas, but
<a name="line-55"></a>it isn't.  I've seen this
<a name="line-56"></a>
<a name="line-57"></a>        foo = PrelBase.timesInt
<a name="line-58"></a>
<a name="line-59"></a>We want foo to get arity 2 even though the eta-expander will leave it
<a name="line-60"></a>unchanged, in the expectation that it'll be inlined.  But occasionally it
<a name="line-61"></a>isn't, because foo is blacklisted (used in a rule).
<a name="line-62"></a>
<a name="line-63"></a>Similarly, see the ok_note check in exprEtaExpandArity.  So
<a name="line-64"></a>        f = __inline_me (\x -&gt; e)
<a name="line-65"></a>won't be eta-expanded.
<a name="line-66"></a>
<a name="line-67"></a>And in any case it seems more robust to have exprArity be a bit more intelligent.
<a name="line-68"></a>But note that   (\x y z -&gt; f x y z)
<a name="line-69"></a>should have arity 3, regardless of f's arity.
<a name="line-70"></a>-}</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="manifestArity"></a><span class='hs-definition'>manifestArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-73"></a><span class='hs-comment'>-- ^ manifestArity sees how many leading value lambdas there are,</span>
<a name="line-74"></a><span class='hs-comment'>--   after looking through casts</span>
<a name="line-75"></a><span class='hs-definition'>manifestArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>v</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>e</span>
<a name="line-76"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>e</span>
<a name="line-77"></a><span class='hs-definition'>manifestArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickishIsCode</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>e</span>
<a name="line-78"></a><span class='hs-definition'>manifestArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>e</span>
<a name="line-79"></a><span class='hs-definition'>manifestArity</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="joinRhsArity"></a><span class='hs-definition'>joinRhsArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JoinArity</span>
<a name="line-82"></a><span class='hs-comment'>-- Join points are supposed to have manifestly-visible</span>
<a name="line-83"></a><span class='hs-comment'>-- lambdas at the top: no ticks, no casts, nothing</span>
<a name="line-84"></a><span class='hs-comment'>-- Moreover, type lambdas count in JoinArity</span>
<a name="line-85"></a><span class='hs-definition'>joinRhsArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>joinRhsArity</span> <span class='hs-varid'>e</span>
<a name="line-86"></a><span class='hs-definition'>joinRhsArity</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-87"></a>
<a name="line-88"></a>
<a name="line-89"></a><a name="exprArity"></a><span class='hs-comment'>---------------</span>
<a name="line-90"></a><span class='hs-definition'>exprArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-91"></a><span class='hs-comment'>-- ^ An approximate, fast, version of 'exprEtaExpandArity'</span>
<a name="line-92"></a><span class='hs-definition'>exprArity</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>
<a name="line-93"></a>  <span class='hs-keyword'>where</span>
<a name="line-94"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>v</span>
<a name="line-95"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>x</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-96"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>
<a name="line-97"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickishIsCode</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>
<a name="line-98"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trim_arity</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-99"></a>                                        <span class='hs-comment'>-- Note [exprArity invariant]</span>
<a name="line-100"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>
<a name="line-101"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`max`</span> <span class='hs-num'>0</span>
<a name="line-102"></a>        <span class='hs-comment'>-- See Note [exprArity for applications]</span>
<a name="line-103"></a>        <span class='hs-comment'>-- NB: coercions count as a value argument</span>
<a name="line-104"></a>
<a name="line-105"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-varid'>trim_arity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-108"></a>    <span class='hs-varid'>trim_arity</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>`min`</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeArity</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="typeArity"></a><span class='hs-comment'>---------------</span>
<a name="line-111"></a><span class='hs-definition'>typeArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OneShotInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-112"></a><span class='hs-comment'>-- How many value arrows are visible in the type?</span>
<a name="line-113"></a><span class='hs-comment'>-- We look through foralls, and newtypes</span>
<a name="line-114"></a><span class='hs-comment'>-- See Note [exprArity invariant]</span>
<a name="line-115"></a><span class='hs-definition'>typeArity</span> <span class='hs-varid'>ty</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>initRecTc</span> <span class='hs-varid'>ty</span>
<a name="line-117"></a>  <span class='hs-keyword'>where</span>
<a name="line-118"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span>
<a name="line-119"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-120"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty'</span>
<a name="line-121"></a>
<a name="line-122"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-123"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeOneShot</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>res</span>
<a name="line-124"></a>
<a name="line-125"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-126"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-127"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkRecTc</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span>  <span class='hs-comment'>-- See Note [Expanding newtypes]</span>
<a name="line-128"></a>                                                <span class='hs-comment'>-- in TyCon</span>
<a name="line-129"></a><span class='hs-comment'>--   , not (isClassTyCon tc)    -- Do not eta-expand through newtype classes</span>
<a name="line-130"></a><span class='hs-comment'>--                              -- See Note [Newtype classes and eta expansion]</span>
<a name="line-131"></a><span class='hs-comment'>--                              (no longer required)</span>
<a name="line-132"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-varid'>ty'</span>
<a name="line-133"></a>        <span class='hs-comment'>-- Important to look through non-recursive newtypes, so that, eg</span>
<a name="line-134"></a>        <span class='hs-comment'>--      (f x)   where f has arity 2, f :: Int -&gt; IO ()</span>
<a name="line-135"></a>        <span class='hs-comment'>-- Here we want to get arity 1 for the result!</span>
<a name="line-136"></a>        <span class='hs-comment'>--</span>
<a name="line-137"></a>        <span class='hs-comment'>-- AND through a layer of recursive newtypes</span>
<a name="line-138"></a>        <span class='hs-comment'>-- e.g. newtype Stream m a b = Stream (m (Either b (a, Stream m a b)))</span>
<a name="line-139"></a>
<a name="line-140"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-141"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="exprBotStrictness_maybe"></a><span class='hs-comment'>---------------</span>
<a name="line-144"></a><span class='hs-definition'>exprBotStrictness_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>StrictSig</span><span class='hs-layout'>)</span>
<a name="line-145"></a><span class='hs-comment'>-- A cheap and cheerful function that identifies bottoming functions</span>
<a name="line-146"></a><span class='hs-comment'>-- and gives them a suitable strictness signatures.  It's used during</span>
<a name="line-147"></a><span class='hs-comment'>-- float-out</span>
<a name="line-148"></a><span class='hs-definition'>exprBotStrictness_maybe</span> <span class='hs-varid'>e</span>
<a name="line-149"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getBotArity</span> <span class='hs-layout'>(</span><span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-150"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-151"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>ar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ar</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>ar</span><span class='hs-layout'>)</span>
<a name="line-152"></a>  <span class='hs-keyword'>where</span>
<a name="line-153"></a>    <span class='hs-varid'>env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_ped_bot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ae_cheap_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-154"></a>    <span class='hs-varid'>sig</span> <span class='hs-varid'>ar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosedStrictSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>topDmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>exnRes</span>
<a name="line-155"></a>                  <span class='hs-comment'>-- For this purpose we can be very simple</span>
<a name="line-156"></a>                  <span class='hs-comment'>-- exnRes is a bit less aggressive than botRes</span>
<a name="line-157"></a>
<a name="line-158"></a><span class='hs-comment'>{-
<a name="line-159"></a>Note [exprArity invariant]
<a name="line-160"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-161"></a>exprArity has the following invariant:
<a name="line-162"></a>
<a name="line-163"></a>  (1) If typeArity (exprType e) = n,
<a name="line-164"></a>      then manifestArity (etaExpand e n) = n
<a name="line-165"></a>
<a name="line-166"></a>      That is, etaExpand can always expand as much as typeArity says
<a name="line-167"></a>      So the case analysis in etaExpand and in typeArity must match
<a name="line-168"></a>
<a name="line-169"></a>  (2) exprArity e &lt;= typeArity (exprType e)
<a name="line-170"></a>
<a name="line-171"></a>  (3) Hence if (exprArity e) = n, then manifestArity (etaExpand e n) = n
<a name="line-172"></a>
<a name="line-173"></a>      That is, if exprArity says "the arity is n" then etaExpand really
<a name="line-174"></a>      can get "n" manifest lambdas to the top.
<a name="line-175"></a>
<a name="line-176"></a>Why is this important?  Because
<a name="line-177"></a>  - In TidyPgm we use exprArity to fix the *final arity* of
<a name="line-178"></a>    each top-level Id, and in
<a name="line-179"></a>  - In CorePrep we use etaExpand on each rhs, so that the visible lambdas
<a name="line-180"></a>    actually match that arity, which in turn means
<a name="line-181"></a>    that the StgRhs has the right number of lambdas
<a name="line-182"></a>
<a name="line-183"></a>An alternative would be to do the eta-expansion in TidyPgm, at least
<a name="line-184"></a>for top-level bindings, in which case we would not need the trim_arity
<a name="line-185"></a>in exprArity.  That is a less local change, so I'm going to leave it for today!
<a name="line-186"></a>
<a name="line-187"></a>Note [Newtype classes and eta expansion]
<a name="line-188"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-189"></a>    NB: this nasty special case is no longer required, because
<a name="line-190"></a>    for newtype classes we don't use the class-op rule mechanism
<a name="line-191"></a>    at all.  See Note [Single-method classes] in TcInstDcls. SLPJ May 2013
<a name="line-192"></a>
<a name="line-193"></a>-------- Old out of date comments, just for interest -----------
<a name="line-194"></a>We have to be careful when eta-expanding through newtypes.  In general
<a name="line-195"></a>it's a good idea, but annoyingly it interacts badly with the class-op
<a name="line-196"></a>rule mechanism.  Consider
<a name="line-197"></a>
<a name="line-198"></a>   class C a where { op :: a -&gt; a }
<a name="line-199"></a>   instance C b =&gt; C [b] where
<a name="line-200"></a>     op x = ...
<a name="line-201"></a>
<a name="line-202"></a>These translate to
<a name="line-203"></a>
<a name="line-204"></a>   co :: forall a. (a-&gt;a) ~ C a
<a name="line-205"></a>
<a name="line-206"></a>   $copList :: C b -&gt; [b] -&gt; [b]
<a name="line-207"></a>   $copList d x = ...
<a name="line-208"></a>
<a name="line-209"></a>   $dfList :: C b -&gt; C [b]
<a name="line-210"></a>   {-# DFunUnfolding = [$copList] #-}
<a name="line-211"></a>   $dfList d = $copList d |&gt; co@[b]
<a name="line-212"></a>
<a name="line-213"></a>Now suppose we have:
<a name="line-214"></a>
<a name="line-215"></a>   dCInt :: C Int
<a name="line-216"></a>
<a name="line-217"></a>   blah :: [Int] -&gt; [Int]
<a name="line-218"></a>   blah = op ($dfList dCInt)
<a name="line-219"></a>
<a name="line-220"></a>Now we want the built-in op/$dfList rule will fire to give
<a name="line-221"></a>   blah = $copList dCInt
<a name="line-222"></a>
<a name="line-223"></a>But with eta-expansion 'blah' might (and in Trac #3772, which is
<a name="line-224"></a>slightly more complicated, does) turn into
<a name="line-225"></a>
<a name="line-226"></a>   blah = op (\eta. ($dfList dCInt |&gt; sym co) eta)
<a name="line-227"></a>
<a name="line-228"></a>and now it is *much* harder for the op/$dfList rule to fire, because
<a name="line-229"></a>exprIsConApp_maybe won't hold of the argument to op.  I considered
<a name="line-230"></a>trying to *make* it hold, but it's tricky and I gave up.
<a name="line-231"></a>
<a name="line-232"></a>The test simplCore/should_compile/T3722 is an excellent example.
<a name="line-233"></a>-------- End of old out of date comments, just for interest -----------
<a name="line-234"></a>
<a name="line-235"></a>
<a name="line-236"></a>Note [exprArity for applications]
<a name="line-237"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-238"></a>When we come to an application we check that the arg is trivial.
<a name="line-239"></a>   eg  f (fac x) does not have arity 2,
<a name="line-240"></a>                 even if f has arity 3!
<a name="line-241"></a>
<a name="line-242"></a>* We require that is trivial rather merely cheap.  Suppose f has arity 2.
<a name="line-243"></a>  Then    f (Just y)
<a name="line-244"></a>  has arity 0, because if we gave it arity 1 and then inlined f we'd get
<a name="line-245"></a>          let v = Just y in \w. &lt;f-body&gt;
<a name="line-246"></a>  which has arity 0.  And we try to maintain the invariant that we don't
<a name="line-247"></a>  have arity decreases.
<a name="line-248"></a>
<a name="line-249"></a>*  The `max 0` is important!  (\x y -&gt; f x) has arity 2, even if f is
<a name="line-250"></a>   unknown, hence arity 0
<a name="line-251"></a>
<a name="line-252"></a>
<a name="line-253"></a>************************************************************************
<a name="line-254"></a>*                                                                      *
<a name="line-255"></a>           Computing the "arity" of an expression
<a name="line-256"></a>*                                                                      *
<a name="line-257"></a>************************************************************************
<a name="line-258"></a>
<a name="line-259"></a>Note [Definition of arity]
<a name="line-260"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-261"></a>The "arity" of an expression 'e' is n if
<a name="line-262"></a>   applying 'e' to *fewer* than n *value* arguments
<a name="line-263"></a>   converges rapidly
<a name="line-264"></a>
<a name="line-265"></a>Or, to put it another way
<a name="line-266"></a>
<a name="line-267"></a>   there is no work lost in duplicating the partial
<a name="line-268"></a>   application (e x1 .. x(n-1))
<a name="line-269"></a>
<a name="line-270"></a>In the divegent case, no work is lost by duplicating because if the thing
<a name="line-271"></a>is evaluated once, that's the end of the program.
<a name="line-272"></a>
<a name="line-273"></a>Or, to put it another way, in any context C
<a name="line-274"></a>
<a name="line-275"></a>   C[ (\x1 .. xn. e x1 .. xn) ]
<a name="line-276"></a>         is as efficient as
<a name="line-277"></a>   C[ e ]
<a name="line-278"></a>
<a name="line-279"></a>It's all a bit more subtle than it looks:
<a name="line-280"></a>
<a name="line-281"></a>Note [One-shot lambdas]
<a name="line-282"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-283"></a>Consider one-shot lambdas
<a name="line-284"></a>                let x = expensive in \y z -&gt; E
<a name="line-285"></a>We want this to have arity 1 if the \y-abstraction is a 1-shot lambda.
<a name="line-286"></a>
<a name="line-287"></a>Note [Dealing with bottom]
<a name="line-288"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-289"></a>A Big Deal with computing arities is expressions like
<a name="line-290"></a>
<a name="line-291"></a>   f = \x -&gt; case x of
<a name="line-292"></a>               True  -&gt; \s -&gt; e1
<a name="line-293"></a>               False -&gt; \s -&gt; e2
<a name="line-294"></a>
<a name="line-295"></a>This happens all the time when f :: Bool -&gt; IO ()
<a name="line-296"></a>In this case we do eta-expand, in order to get that \s to the
<a name="line-297"></a>top, and give f arity 2.
<a name="line-298"></a>
<a name="line-299"></a>This isn't really right in the presence of seq.  Consider
<a name="line-300"></a>        (f bot) `seq` 1
<a name="line-301"></a>
<a name="line-302"></a>This should diverge!  But if we eta-expand, it won't.  We ignore this
<a name="line-303"></a>"problem" (unless -fpedantic-bottoms is on), because being scrupulous
<a name="line-304"></a>would lose an important transformation for many programs. (See
<a name="line-305"></a>Trac #5587 for an example.)
<a name="line-306"></a>
<a name="line-307"></a>Consider also
<a name="line-308"></a>        f = \x -&gt; error "foo"
<a name="line-309"></a>Here, arity 1 is fine.  But if it is
<a name="line-310"></a>        f = \x -&gt; case x of
<a name="line-311"></a>                        True  -&gt; error "foo"
<a name="line-312"></a>                        False -&gt; \y -&gt; x+y
<a name="line-313"></a>then we want to get arity 2.  Technically, this isn't quite right, because
<a name="line-314"></a>        (f True) `seq` 1
<a name="line-315"></a>should diverge, but it'll converge if we eta-expand f.  Nevertheless, we
<a name="line-316"></a>do so; it improves some programs significantly, and increasing convergence
<a name="line-317"></a>isn't a bad thing.  Hence the ABot/ATop in ArityType.
<a name="line-318"></a>
<a name="line-319"></a>So these two transformations aren't always the Right Thing, and we
<a name="line-320"></a>have several tickets reporting unexpected bahaviour resulting from
<a name="line-321"></a>this transformation.  So we try to limit it as much as possible:
<a name="line-322"></a>
<a name="line-323"></a> (1) Do NOT move a lambda outside a known-bottom case expression
<a name="line-324"></a>       case undefined of { (a,b) -&gt; \y -&gt; e }
<a name="line-325"></a>     This showed up in Trac #5557
<a name="line-326"></a>
<a name="line-327"></a> (2) Do NOT move a lambda outside a case if all the branches of
<a name="line-328"></a>     the case are known to return bottom.
<a name="line-329"></a>        case x of { (a,b) -&gt; \y -&gt; error "urk" }
<a name="line-330"></a>     This case is less important, but the idea is that if the fn is
<a name="line-331"></a>     going to diverge eventually anyway then getting the best arity
<a name="line-332"></a>     isn't an issue, so we might as well play safe
<a name="line-333"></a>
<a name="line-334"></a> (3) Do NOT move a lambda outside a case unless
<a name="line-335"></a>     (a) The scrutinee is ok-for-speculation, or
<a name="line-336"></a>     (b) more liberally: the scrutinee is cheap (e.g. a variable), and
<a name="line-337"></a>         -fpedantic-bottoms is not enforced (see Trac #2915 for an example)
<a name="line-338"></a>
<a name="line-339"></a>Of course both (1) and (2) are readily defeated by disguising the bottoms.
<a name="line-340"></a>
<a name="line-341"></a>4. Note [Newtype arity]
<a name="line-342"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-343"></a>Non-recursive newtypes are transparent, and should not get in the way.
<a name="line-344"></a>We do (currently) eta-expand recursive newtypes too.  So if we have, say
<a name="line-345"></a>
<a name="line-346"></a>        newtype T = MkT ([T] -&gt; Int)
<a name="line-347"></a>
<a name="line-348"></a>Suppose we have
<a name="line-349"></a>        e = coerce T f
<a name="line-350"></a>where f has arity 1.  Then: etaExpandArity e = 1;
<a name="line-351"></a>that is, etaExpandArity looks through the coerce.
<a name="line-352"></a>
<a name="line-353"></a>When we eta-expand e to arity 1: eta_expand 1 e T
<a name="line-354"></a>we want to get:                  coerce T (\x::[T] -&gt; (coerce ([T]-&gt;Int) e) x)
<a name="line-355"></a>
<a name="line-356"></a>  HOWEVER, note that if you use coerce bogusly you can ge
<a name="line-357"></a>        coerce Int negate
<a name="line-358"></a>  And since negate has arity 2, you might try to eta expand.  But you can't
<a name="line-359"></a>  decopose Int to a function type.   Hence the final case in eta_expand.
<a name="line-360"></a>
<a name="line-361"></a>Note [The state-transformer hack]
<a name="line-362"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-363"></a>Suppose we have
<a name="line-364"></a>        f = e
<a name="line-365"></a>where e has arity n.  Then, if we know from the context that f has
<a name="line-366"></a>a usage type like
<a name="line-367"></a>        t1 -&gt; ... -&gt; tn -1-&gt; t(n+1) -1-&gt; ... -1-&gt; tm -&gt; ...
<a name="line-368"></a>then we can expand the arity to m.  This usage type says that
<a name="line-369"></a>any application (x e1 .. en) will be applied to uniquely to (m-n) more args
<a name="line-370"></a>Consider f = \x. let y = &lt;expensive&gt;
<a name="line-371"></a>                 in case x of
<a name="line-372"></a>                      True  -&gt; foo
<a name="line-373"></a>                      False -&gt; \(s:RealWorld) -&gt; e
<a name="line-374"></a>where foo has arity 1.  Then we want the state hack to
<a name="line-375"></a>apply to foo too, so we can eta expand the case.
<a name="line-376"></a>
<a name="line-377"></a>Then we expect that if f is applied to one arg, it'll be applied to two
<a name="line-378"></a>(that's the hack -- we don't really know, and sometimes it's false)
<a name="line-379"></a>See also Id.isOneShotBndr.
<a name="line-380"></a>
<a name="line-381"></a>Note [State hack and bottoming functions]
<a name="line-382"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-383"></a>It's a terrible idea to use the state hack on a bottoming function.
<a name="line-384"></a>Here's what happens (Trac #2861):
<a name="line-385"></a>
<a name="line-386"></a>  f :: String -&gt; IO T
<a name="line-387"></a>  f = \p. error "..."
<a name="line-388"></a>
<a name="line-389"></a>Eta-expand, using the state hack:
<a name="line-390"></a>
<a name="line-391"></a>  f = \p. (\s. ((error "...") |&gt; g1) s) |&gt; g2
<a name="line-392"></a>  g1 :: IO T ~ (S -&gt; (S,T))
<a name="line-393"></a>  g2 :: (S -&gt; (S,T)) ~ IO T
<a name="line-394"></a>
<a name="line-395"></a>Extrude the g2
<a name="line-396"></a>
<a name="line-397"></a>  f' = \p. \s. ((error "...") |&gt; g1) s
<a name="line-398"></a>  f = f' |&gt; (String -&gt; g2)
<a name="line-399"></a>
<a name="line-400"></a>Discard args for bottomming function
<a name="line-401"></a>
<a name="line-402"></a>  f' = \p. \s. ((error "...") |&gt; g1 |&gt; g3
<a name="line-403"></a>  g3 :: (S -&gt; (S,T)) ~ (S,T)
<a name="line-404"></a>
<a name="line-405"></a>Extrude g1.g3
<a name="line-406"></a>
<a name="line-407"></a>  f'' = \p. \s. (error "...")
<a name="line-408"></a>  f' = f'' |&gt; (String -&gt; S -&gt; g1.g3)
<a name="line-409"></a>
<a name="line-410"></a>And now we can repeat the whole loop.  Aargh!  The bug is in applying the
<a name="line-411"></a>state hack to a function which then swallows the argument.
<a name="line-412"></a>
<a name="line-413"></a>This arose in another guise in Trac #3959.  Here we had
<a name="line-414"></a>
<a name="line-415"></a>     catch# (throw exn &gt;&gt; return ())
<a name="line-416"></a>
<a name="line-417"></a>Note that (throw :: forall a e. Exn e =&gt; e -&gt; a) is called with [a = IO ()].
<a name="line-418"></a>After inlining (&gt;&gt;) we get
<a name="line-419"></a>
<a name="line-420"></a>     catch# (\_. throw {IO ()} exn)
<a name="line-421"></a>
<a name="line-422"></a>We must *not* eta-expand to
<a name="line-423"></a>
<a name="line-424"></a>     catch# (\_ _. throw {...} exn)
<a name="line-425"></a>
<a name="line-426"></a>because 'catch#' expects to get a (# _,_ #) after applying its argument to
<a name="line-427"></a>a State#, not another function!
<a name="line-428"></a>
<a name="line-429"></a>In short, we use the state hack to allow us to push let inside a lambda,
<a name="line-430"></a>but not to introduce a new lambda.
<a name="line-431"></a>
<a name="line-432"></a>
<a name="line-433"></a>Note [ArityType]
<a name="line-434"></a>~~~~~~~~~~~~~~~~
<a name="line-435"></a>ArityType is the result of a compositional analysis on expressions,
<a name="line-436"></a>from which we can decide the real arity of the expression (extracted
<a name="line-437"></a>with function exprEtaExpandArity).
<a name="line-438"></a>
<a name="line-439"></a>Here is what the fields mean. If an arbitrary expression 'f' has
<a name="line-440"></a>ArityType 'at', then
<a name="line-441"></a>
<a name="line-442"></a> * If at = ABot n, then (f x1..xn) definitely diverges. Partial
<a name="line-443"></a>   applications to fewer than n args may *or may not* diverge.
<a name="line-444"></a>
<a name="line-445"></a>   We allow ourselves to eta-expand bottoming functions, even
<a name="line-446"></a>   if doing so may lose some `seq` sharing,
<a name="line-447"></a>       let x = &lt;expensive&gt; in \y. error (g x y)
<a name="line-448"></a>       ==&gt; \y. let x = &lt;expensive&gt; in error (g x y)
<a name="line-449"></a>
<a name="line-450"></a> * If at = ATop as, and n=length as,
<a name="line-451"></a>   then expanding 'f' to (\x1..xn. f x1 .. xn) loses no sharing,
<a name="line-452"></a>   assuming the calls of f respect the one-shot-ness of
<a name="line-453"></a>   its definition.
<a name="line-454"></a>
<a name="line-455"></a>   NB 'f' is an arbitrary expression, eg (f = g e1 e2).  This 'f'
<a name="line-456"></a>   can have ArityType as ATop, with length as &gt; 0, only if e1 e2 are
<a name="line-457"></a>   themselves.
<a name="line-458"></a>
<a name="line-459"></a> * In both cases, f, (f x1), ... (f x1 ... f(n-1)) are definitely
<a name="line-460"></a>   really functions, or bottom, but *not* casts from a data type, in
<a name="line-461"></a>   at least one case branch.  (If it's a function in one case branch but
<a name="line-462"></a>   an unsafe cast from a data type in another, the program is bogus.)
<a name="line-463"></a>   So eta expansion is dynamically ok; see Note [State hack and
<a name="line-464"></a>   bottoming functions], the part about catch#
<a name="line-465"></a>
<a name="line-466"></a>Example:
<a name="line-467"></a>      f = \x\y. let v = &lt;expensive&gt; in
<a name="line-468"></a>          \s(one-shot) \t(one-shot). blah
<a name="line-469"></a>      'f' has ArityType [ManyShot,ManyShot,OneShot,OneShot]
<a name="line-470"></a>      The one-shot-ness means we can, in effect, push that
<a name="line-471"></a>      'let' inside the \st.
<a name="line-472"></a>
<a name="line-473"></a>
<a name="line-474"></a>Suppose f = \xy. x+y
<a name="line-475"></a>Then  f             :: AT [False,False] ATop
<a name="line-476"></a>      f v           :: AT [False]       ATop
<a name="line-477"></a>      f &lt;expensive&gt; :: AT []            ATop
<a name="line-478"></a>
<a name="line-479"></a>-------------------- Main arity code ----------------------------
<a name="line-480"></a>-}</span>
<a name="line-481"></a>
<a name="line-482"></a><a name="ArityType"></a><span class='hs-comment'>-- See Note [ArityType]</span>
<a name="line-483"></a><a name="ArityType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArityType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OneShotInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ABot</span> <span class='hs-conid'>Arity</span>
<a name="line-484"></a>     <span class='hs-comment'>-- There is always an explicit lambda</span>
<a name="line-485"></a>     <span class='hs-comment'>-- to justify the [OneShot], or the Arity</span>
<a name="line-486"></a>
<a name="line-487"></a><a name="vanillaArityType"></a><span class='hs-definition'>vanillaArityType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArityType</span>
<a name="line-488"></a><span class='hs-definition'>vanillaArityType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-conid'>[]</span>      <span class='hs-comment'>-- Totally uninformative</span>
<a name="line-489"></a>
<a name="line-490"></a><a name="exprEtaExpandArity"></a><span class='hs-comment'>-- ^ The Arity returned is the number of value args the</span>
<a name="line-491"></a><span class='hs-comment'>-- expression can be applied to without doing much work</span>
<a name="line-492"></a><span class='hs-definition'>exprEtaExpandArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-493"></a><span class='hs-comment'>-- exprEtaExpandArity is used when eta expanding</span>
<a name="line-494"></a><span class='hs-comment'>--      e  ==&gt;  \xy -&gt; e x y</span>
<a name="line-495"></a><span class='hs-definition'>exprEtaExpandArity</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>e</span>
<a name="line-496"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-497"></a>      <span class='hs-conid'>ATop</span> <span class='hs-varid'>oss</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>oss</span>
<a name="line-498"></a>      <span class='hs-conid'>ABot</span> <span class='hs-varid'>n</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span>
<a name="line-499"></a>  <span class='hs-keyword'>where</span>
<a name="line-500"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_cheap_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_cheap_fn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>isCheapApp</span>
<a name="line-501"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ae_ped_bot</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PedanticBottoms</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>}</span>
<a name="line-502"></a>
<a name="line-503"></a><a name="getBotArity"></a><span class='hs-definition'>getBotArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArityType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Arity</span>
<a name="line-504"></a><span class='hs-comment'>-- Arity of a divergent function</span>
<a name="line-505"></a><span class='hs-definition'>getBotArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABot</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>
<a name="line-506"></a><span class='hs-definition'>getBotArity</span> <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-507"></a>
<a name="line-508"></a><a name="mk_cheap_fn"></a><span class='hs-definition'>mk_cheap_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheapAppFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheapFun</span>
<a name="line-509"></a><span class='hs-definition'>mk_cheap_fn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cheap_app</span>
<a name="line-510"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DictsCheap</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-511"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>exprIsOk</span> <span class='hs-varid'>cheap_app</span> <span class='hs-varid'>e</span>
<a name="line-512"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-513"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-varid'>mb_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>exprIsOk</span> <span class='hs-varid'>cheap_app</span> <span class='hs-varid'>e</span>
<a name="line-514"></a>             <span class='hs-varop'>||</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ty</span> <span class='hs-keyword'>of</span>
<a name="line-515"></a>                  <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-516"></a>                  <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isDictLikeTy</span> <span class='hs-varid'>ty</span>
<a name="line-517"></a>
<a name="line-518"></a>
<a name="line-519"></a><a name="findRhsArity"></a><span class='hs-comment'>----------------------</span>
<a name="line-520"></a><span class='hs-definition'>findRhsArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-521"></a><span class='hs-comment'>-- This implements the fixpoint loop for arity analysis</span>
<a name="line-522"></a><span class='hs-comment'>-- See Note [Arity analysis]</span>
<a name="line-523"></a><span class='hs-definition'>findRhsArity</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>old_arity</span>
<a name="line-524"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhsEtaExpandArity</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>init_cheap_app</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-525"></a>       <span class='hs-comment'>-- We always call exprEtaExpandArity once, but usually</span>
<a name="line-526"></a>       <span class='hs-comment'>-- that produces a result equal to old_arity, and then</span>
<a name="line-527"></a>       <span class='hs-comment'>-- we stop right away (since arities should not decrease)</span>
<a name="line-528"></a>       <span class='hs-comment'>-- Result: the common case is that there is just one iteration</span>
<a name="line-529"></a>  <span class='hs-keyword'>where</span>
<a name="line-530"></a>    <span class='hs-varid'>init_cheap_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CheapAppFun</span>
<a name="line-531"></a>    <span class='hs-varid'>init_cheap_app</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>n_val_args</span>
<a name="line-532"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fn</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- On the first pass, this binder gets infinite arity</span>
<a name="line-533"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isCheapApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>n_val_args</span>
<a name="line-534"></a>
<a name="line-535"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-536"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>cur_arity</span>
<a name="line-537"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cur_arity</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>old_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cur_arity</span>
<a name="line-538"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>cur_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cur_arity</span>
<a name="line-539"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>new_arity</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>cur_arity</span> <span class='hs-layout'>)</span>
<a name="line-540"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-541"></a>                    <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"Exciting arity"</span>
<a name="line-542"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cur_arity</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_arity</span>
<a name="line-543"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-544"></a><span class='hs-cpp'>#endif</span>
<a name="line-545"></a>                    <span class='hs-varid'>go</span> <span class='hs-varid'>new_arity</span>
<a name="line-546"></a>      <span class='hs-keyword'>where</span>
<a name="line-547"></a>        <span class='hs-varid'>new_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhsEtaExpandArity</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cheap_app</span> <span class='hs-varid'>rhs</span>
<a name="line-548"></a>
<a name="line-549"></a>        <span class='hs-varid'>cheap_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CheapAppFun</span>
<a name="line-550"></a>        <span class='hs-varid'>cheap_app</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>n_val_args</span>
<a name="line-551"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fn</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>cur_arity</span>
<a name="line-552"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isCheapApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>n_val_args</span>
<a name="line-553"></a>
<a name="line-554"></a><a name="rhsEtaExpandArity"></a><span class='hs-comment'>-- ^ The Arity returned is the number of value args the</span>
<a name="line-555"></a><span class='hs-comment'>-- expression can be applied to without doing much work</span>
<a name="line-556"></a><span class='hs-definition'>rhsEtaExpandArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CheapAppFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-557"></a><span class='hs-comment'>-- exprEtaExpandArity is used when eta expanding</span>
<a name="line-558"></a><span class='hs-comment'>--      e  ==&gt;  \xy -&gt; e x y</span>
<a name="line-559"></a><span class='hs-definition'>rhsEtaExpandArity</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cheap_app</span> <span class='hs-varid'>e</span>
<a name="line-560"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-561"></a>      <span class='hs-conid'>ATop</span> <span class='hs-layout'>(</span><span class='hs-varid'>os</span><span class='hs-conop'>:</span><span class='hs-varid'>oss</span><span class='hs-layout'>)</span>
<a name="line-562"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOneShotInfo</span> <span class='hs-varid'>os</span> <span class='hs-varop'>||</span> <span class='hs-varid'>has_lam</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>oss</span>
<a name="line-563"></a>                                   <span class='hs-comment'>-- Don't expand PAPs/thunks</span>
<a name="line-564"></a>                                   <span class='hs-comment'>-- Note [Eta expanding thunks]</span>
<a name="line-565"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-566"></a>      <span class='hs-conid'>ATop</span> <span class='hs-conid'>[]</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-567"></a>      <span class='hs-conid'>ABot</span> <span class='hs-varid'>n</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span>
<a name="line-568"></a>  <span class='hs-keyword'>where</span>
<a name="line-569"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_cheap_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_cheap_fn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cheap_app</span>
<a name="line-570"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ae_ped_bot</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PedanticBottoms</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>}</span>
<a name="line-571"></a>
<a name="line-572"></a>    <span class='hs-varid'>has_lam</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>has_lam</span> <span class='hs-varid'>e</span>
<a name="line-573"></a>    <span class='hs-varid'>has_lam</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>b</span> <span class='hs-varop'>||</span> <span class='hs-varid'>has_lam</span> <span class='hs-varid'>e</span>
<a name="line-574"></a>    <span class='hs-varid'>has_lam</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-575"></a>
<a name="line-576"></a><span class='hs-comment'>{-
<a name="line-577"></a>Note [Arity analysis]
<a name="line-578"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-579"></a>The motivating example for arity analysis is this:
<a name="line-580"></a>
<a name="line-581"></a>  f = \x. let g = f (x+1)
<a name="line-582"></a>          in \y. ...g...
<a name="line-583"></a>
<a name="line-584"></a>What arity does f have?  Really it should have arity 2, but a naive
<a name="line-585"></a>look at the RHS won't see that.  You need a fixpoint analysis which
<a name="line-586"></a>says it has arity "infinity" the first time round.
<a name="line-587"></a>
<a name="line-588"></a>This example happens a lot; it first showed up in Andy Gill's thesis,
<a name="line-589"></a>fifteen years ago!  It also shows up in the code for 'rnf' on lists
<a name="line-590"></a>in Trac #4138.
<a name="line-591"></a>
<a name="line-592"></a>The analysis is easy to achieve because exprEtaExpandArity takes an
<a name="line-593"></a>argument
<a name="line-594"></a>     type CheapFun = CoreExpr -&gt; Maybe Type -&gt; Bool
<a name="line-595"></a>used to decide if an expression is cheap enough to push inside a
<a name="line-596"></a>lambda.  And exprIsCheap' in turn takes an argument
<a name="line-597"></a>     type CheapAppFun = Id -&gt; Int -&gt; Bool
<a name="line-598"></a>which tells when an application is cheap. This makes it easy to
<a name="line-599"></a>write the analysis loop.
<a name="line-600"></a>
<a name="line-601"></a>The analysis is cheap-and-cheerful because it doesn't deal with
<a name="line-602"></a>mutual recursion.  But the self-recursive case is the important one.
<a name="line-603"></a>
<a name="line-604"></a>
<a name="line-605"></a>Note [Eta expanding through dictionaries]
<a name="line-606"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-607"></a>If the experimental -fdicts-cheap flag is on, we eta-expand through
<a name="line-608"></a>dictionary bindings.  This improves arities. Thereby, it also
<a name="line-609"></a>means that full laziness is less prone to floating out the
<a name="line-610"></a>application of a function to its dictionary arguments, which
<a name="line-611"></a>can thereby lose opportunities for fusion.  Example:
<a name="line-612"></a>        foo :: Ord a =&gt; a -&gt; ...
<a name="line-613"></a>     foo = /\a \(d:Ord a). let d' = ...d... in \(x:a). ....
<a name="line-614"></a>        -- So foo has arity 1
<a name="line-615"></a>
<a name="line-616"></a>     f = \x. foo dInt $ bar x
<a name="line-617"></a>
<a name="line-618"></a>The (foo DInt) is floated out, and makes ineffective a RULE
<a name="line-619"></a>     foo (bar x) = ...
<a name="line-620"></a>
<a name="line-621"></a>One could go further and make exprIsCheap reply True to any
<a name="line-622"></a>dictionary-typed expression, but that's more work.
<a name="line-623"></a>
<a name="line-624"></a>See Note [Dictionary-like types] in TcType.hs for why we use
<a name="line-625"></a>isDictLikeTy here rather than isDictTy
<a name="line-626"></a>
<a name="line-627"></a>Note [Eta expanding thunks]
<a name="line-628"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-629"></a>We don't eta-expand
<a name="line-630"></a>   * Trivial RHSs     x = y
<a name="line-631"></a>   * PAPs             x = map g
<a name="line-632"></a>   * Thunks           f = case y of p -&gt; \x -&gt; blah
<a name="line-633"></a>
<a name="line-634"></a>When we see
<a name="line-635"></a>     f = case y of p -&gt; \x -&gt; blah
<a name="line-636"></a>should we eta-expand it? Well, if 'x' is a one-shot state token
<a name="line-637"></a>then 'yes' because 'f' will only be applied once.  But otherwise
<a name="line-638"></a>we (conservatively) say no.  My main reason is to avoid expanding
<a name="line-639"></a>PAPSs
<a name="line-640"></a>        f = g d  ==&gt;  f = \x. g d x
<a name="line-641"></a>because that might in turn make g inline (if it has an inline pragma),
<a name="line-642"></a>which we might not want.  After all, INLINE pragmas say "inline only
<a name="line-643"></a>when saturated" so we don't want to be too gung-ho about saturating!
<a name="line-644"></a>-}</span>
<a name="line-645"></a>
<a name="line-646"></a><a name="arityLam"></a><span class='hs-definition'>arityLam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArityType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArityType</span>
<a name="line-647"></a><span class='hs-definition'>arityLam</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-layout'>(</span><span class='hs-varid'>idStateHackOneShotInfo</span> <span class='hs-varid'>id</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-648"></a><span class='hs-definition'>arityLam</span> <span class='hs-keyword'>_</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ABot</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABot</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-649"></a>
<a name="line-650"></a><a name="floatIn"></a><span class='hs-definition'>floatIn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArityType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArityType</span>
<a name="line-651"></a><span class='hs-comment'>-- We have something like (let x = E in b),</span>
<a name="line-652"></a><span class='hs-comment'>-- where b has the given arity type.</span>
<a name="line-653"></a><span class='hs-definition'>floatIn</span> <span class='hs-keyword'>_</span>     <span class='hs-layout'>(</span><span class='hs-conid'>ABot</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABot</span> <span class='hs-varid'>n</span>
<a name="line-654"></a><span class='hs-definition'>floatIn</span> <span class='hs-conid'>True</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span>
<a name="line-655"></a><span class='hs-definition'>floatIn</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeWhile</span> <span class='hs-varid'>isOneShotInfo</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-656"></a>   <span class='hs-comment'>-- If E is not cheap, keep arity only for one-shots</span>
<a name="line-657"></a>
<a name="line-658"></a><a name="arityApp"></a><span class='hs-definition'>arityApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArityType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArityType</span>
<a name="line-659"></a><span class='hs-comment'>-- Processing (fun arg) where at is the ArityType of fun,</span>
<a name="line-660"></a><span class='hs-comment'>-- Knock off an argument and behave like 'let'</span>
<a name="line-661"></a><span class='hs-definition'>arityApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABot</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABot</span> <span class='hs-num'>0</span>
<a name="line-662"></a><span class='hs-definition'>arityApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABot</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABot</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-663"></a><span class='hs-definition'>arityApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>     <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-conid'>[]</span>
<a name="line-664"></a><span class='hs-definition'>arityApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cheap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatIn</span> <span class='hs-varid'>cheap</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-665"></a>
<a name="line-666"></a><a name="andArityType"></a><span class='hs-definition'>andArityType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArityType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArityType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArityType</span>   <span class='hs-comment'>-- Used for branches of a 'case'</span>
<a name="line-667"></a><span class='hs-definition'>andArityType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABot</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABot</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABot</span> <span class='hs-layout'>(</span><span class='hs-varid'>n1</span> <span class='hs-varop'>`max`</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Note [ABot branches: use max]</span>
<a name="line-668"></a><span class='hs-definition'>andArityType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ABot</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span>
<a name="line-669"></a><span class='hs-definition'>andArityType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABot</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-varid'>bs</span>
<a name="line-670"></a><span class='hs-definition'>andArityType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ATop</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span> <span class='hs-varop'>`combine`</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-671"></a>  <span class='hs-keyword'>where</span>      <span class='hs-comment'>-- See Note [Combining case branches]</span>
<a name="line-672"></a>    <span class='hs-varid'>combine</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`bestOneShot`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>combine</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>bs</span>
<a name="line-673"></a>    <span class='hs-varid'>combine</span> <span class='hs-conid'>[]</span>     <span class='hs-varid'>bs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeWhile</span> <span class='hs-varid'>isOneShotInfo</span> <span class='hs-varid'>bs</span>
<a name="line-674"></a>    <span class='hs-varid'>combine</span> <span class='hs-keyword'>as</span>     <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeWhile</span> <span class='hs-varid'>isOneShotInfo</span> <span class='hs-keyword'>as</span>
<a name="line-675"></a>
<a name="line-676"></a><span class='hs-comment'>{- Note [ABot branches: use max]
<a name="line-677"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-678"></a>Consider   case x of
<a name="line-679"></a>             True  -&gt; \x.  error "urk"
<a name="line-680"></a>             False -&gt; \xy. error "urk2"
<a name="line-681"></a>
<a name="line-682"></a>Remember: ABot n means "if you apply to n args, it'll definitely diverge".
<a name="line-683"></a>So we need (ABot 2) for the whole thing, the /max/ of the ABot arities.
<a name="line-684"></a>
<a name="line-685"></a>Note [Combining case branches]
<a name="line-686"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-687"></a>Consider
<a name="line-688"></a>  go = \x. let z = go e0
<a name="line-689"></a>               go2 = \x. case x of
<a name="line-690"></a>                           True  -&gt; z
<a name="line-691"></a>                           False -&gt; \s(one-shot). e1
<a name="line-692"></a>           in go2 x
<a name="line-693"></a>We *really* want to eta-expand go and go2.
<a name="line-694"></a>When combining the barnches of the case we have
<a name="line-695"></a>     ATop [] `andAT` ATop [OneShotLam]
<a name="line-696"></a>and we want to get ATop [OneShotLam].  But if the inner
<a name="line-697"></a>lambda wasn't one-shot we don't want to do this.
<a name="line-698"></a>(We need a proper arity analysis to justify that.)
<a name="line-699"></a>
<a name="line-700"></a>So we combine the best of the two branches, on the (slightly dodgy)
<a name="line-701"></a>basis that if we know one branch is one-shot, then they all must be.
<a name="line-702"></a>-}</span>
<a name="line-703"></a>
<a name="line-704"></a><a name="CheapFun"></a><span class='hs-comment'>---------------------------</span>
<a name="line-705"></a><a name="CheapFun"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CheapFun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-706"></a>        <span class='hs-comment'>-- How to decide if an expression is cheap</span>
<a name="line-707"></a>        <span class='hs-comment'>-- If the Maybe is Just, the type is the type</span>
<a name="line-708"></a>        <span class='hs-comment'>-- of the expression; Nothing means "don't know"</span>
<a name="line-709"></a>
<a name="line-710"></a><a name="ArityEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArityEnv</span>
<a name="line-711"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_cheap_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CheapFun</span>
<a name="line-712"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>ae_ped_bot</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- True &lt;=&gt; be pedantic about bottoms</span>
<a name="line-713"></a>  <span class='hs-layout'>}</span>
<a name="line-714"></a>
<a name="line-715"></a><a name="arityType"></a><span class='hs-definition'>arityType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArityEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArityType</span>
<a name="line-716"></a>
<a name="line-717"></a><span class='hs-definition'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-718"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-719"></a>      <span class='hs-conid'>ATop</span> <span class='hs-varid'>os</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ATop</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>co_arity</span> <span class='hs-varid'>os</span><span class='hs-layout'>)</span>
<a name="line-720"></a>      <span class='hs-conid'>ABot</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ABot</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>`min`</span> <span class='hs-varid'>co_arity</span><span class='hs-layout'>)</span>
<a name="line-721"></a>  <span class='hs-keyword'>where</span>
<a name="line-722"></a>    <span class='hs-varid'>co_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeArity</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-723"></a>    <span class='hs-comment'>-- See Note [exprArity invariant] (2); must be true of</span>
<a name="line-724"></a>    <span class='hs-comment'>-- arityType too, since that is how we compute the arity</span>
<a name="line-725"></a>    <span class='hs-comment'>-- of variables, and they in turn affect result of exprArity</span>
<a name="line-726"></a>    <span class='hs-comment'>-- Trac #5441 is a nice demo</span>
<a name="line-727"></a>    <span class='hs-comment'>-- However, do make sure that ATop -&gt; ATop and ABot -&gt; ABot!</span>
<a name="line-728"></a>    <span class='hs-comment'>--   Casts don't affect that part. Getting this wrong provoked #5475</span>
<a name="line-729"></a>
<a name="line-730"></a><span class='hs-definition'>arityType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-731"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>strict_sig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idStrictness</span> <span class='hs-varid'>v</span>
<a name="line-732"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isTopSig</span> <span class='hs-varid'>strict_sig</span>
<a name="line-733"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitStrictSig</span> <span class='hs-varid'>strict_sig</span>
<a name="line-734"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ds</span>
<a name="line-735"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isBotRes</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>ABot</span> <span class='hs-varid'>arity</span>
<a name="line-736"></a>                    <span class='hs-keyword'>else</span> <span class='hs-conid'>ATop</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>one_shots</span><span class='hs-layout'>)</span>
<a name="line-737"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-738"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ATop</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-layout'>(</span><span class='hs-varid'>idArity</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>one_shots</span><span class='hs-layout'>)</span>
<a name="line-739"></a>  <span class='hs-keyword'>where</span>
<a name="line-740"></a>    <span class='hs-varid'>one_shots</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OneShotInfo</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- One-shot-ness derived from the type</span>
<a name="line-741"></a>    <span class='hs-varid'>one_shots</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeArity</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-742"></a>
<a name="line-743"></a>        <span class='hs-comment'>-- Lambdas; increase arity</span>
<a name="line-744"></a><span class='hs-definition'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-745"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>x</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityLam</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-746"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-747"></a>
<a name="line-748"></a>        <span class='hs-comment'>-- Applications; decrease arity, except for types</span>
<a name="line-749"></a><span class='hs-definition'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-750"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span>
<a name="line-751"></a><span class='hs-definition'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span> <span class='hs-layout'>)</span>
<a name="line-752"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ae_cheap_fn</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-753"></a>
<a name="line-754"></a>        <span class='hs-comment'>-- Case/Let; keep arity if either the expression is cheap</span>
<a name="line-755"></a>        <span class='hs-comment'>-- or it's a 1-shot lambda</span>
<a name="line-756"></a>        <span class='hs-comment'>-- The former is not really right for Haskell</span>
<a name="line-757"></a>        <span class='hs-comment'>--      f x = case x of { (a,b) -&gt; \y. e }</span>
<a name="line-758"></a>        <span class='hs-comment'>--  ===&gt;</span>
<a name="line-759"></a>        <span class='hs-comment'>--      f x y = case x of { (a,b) -&gt; e }</span>
<a name="line-760"></a>        <span class='hs-comment'>-- The difference is observable using 'seq'</span>
<a name="line-761"></a>        <span class='hs-comment'>--</span>
<a name="line-762"></a><span class='hs-definition'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-763"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsBottom</span> <span class='hs-varid'>scrut</span> <span class='hs-varop'>||</span> <span class='hs-varid'>null</span> <span class='hs-varid'>alts</span>
<a name="line-764"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABot</span> <span class='hs-num'>0</span>     <span class='hs-comment'>-- Do not eta expand</span>
<a name="line-765"></a>               <span class='hs-comment'>-- See Note [Dealing with bottom (1)]</span>
<a name="line-766"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-767"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>alts_type</span> <span class='hs-keyword'>of</span>
<a name="line-768"></a>     <span class='hs-conid'>ABot</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span><span class='hs-varop'>&gt;</span><span class='hs-num'>0</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ATop</span> <span class='hs-conid'>[]</span>    <span class='hs-comment'>-- Don't eta expand</span>
<a name="line-769"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ABot</span> <span class='hs-num'>0</span>     <span class='hs-comment'>-- if RHS is bottomming</span>
<a name="line-770"></a>                                       <span class='hs-comment'>-- See Note [Dealing with bottom (2)]</span>
<a name="line-771"></a>
<a name="line-772"></a>     <span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>ae_ped_bot</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- See Note [Dealing with bottom (3)]</span>
<a name="line-773"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ae_cheap_fn</span> <span class='hs-varid'>env</span> <span class='hs-varid'>scrut</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span>
<a name="line-774"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprOkForSpeculation</span> <span class='hs-varid'>scrut</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ATop</span> <span class='hs-keyword'>as</span>
<a name="line-775"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ATop</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeWhile</span> <span class='hs-varid'>isOneShotInfo</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-776"></a>  <span class='hs-keyword'>where</span>
<a name="line-777"></a>    <span class='hs-varid'>alts_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr1</span> <span class='hs-varid'>andArityType</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>alts</span><span class='hs-keyglyph'>]</span>
<a name="line-778"></a>
<a name="line-779"></a><span class='hs-definition'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-780"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatIn</span> <span class='hs-layout'>(</span><span class='hs-varid'>cheap_bind</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-781"></a>  <span class='hs-keyword'>where</span>
<a name="line-782"></a>    <span class='hs-varid'>cheap_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_cheap</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-783"></a>    <span class='hs-varid'>cheap_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>is_cheap</span> <span class='hs-varid'>prs</span>
<a name="line-784"></a>    <span class='hs-varid'>is_cheap</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ae_cheap_fn</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-785"></a>
<a name="line-786"></a><span class='hs-definition'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-787"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickishIsCode</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-788"></a>
<a name="line-789"></a><span class='hs-definition'>arityType</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vanillaArityType</span>
<a name="line-790"></a>
<a name="line-791"></a><span class='hs-comment'>{-
<a name="line-792"></a>%************************************************************************
<a name="line-793"></a>%*                                                                      *
<a name="line-794"></a>              The main eta-expander
<a name="line-795"></a>%*                                                                      *
<a name="line-796"></a>%************************************************************************
<a name="line-797"></a>
<a name="line-798"></a>We go for:
<a name="line-799"></a>   f = \x1..xn -&gt; N  ==&gt;   f = \x1..xn y1..ym -&gt; N y1..ym
<a name="line-800"></a>                                 (n &gt;= 0)
<a name="line-801"></a>
<a name="line-802"></a>where (in both cases)
<a name="line-803"></a>
<a name="line-804"></a>        * The xi can include type variables
<a name="line-805"></a>
<a name="line-806"></a>        * The yi are all value variables
<a name="line-807"></a>
<a name="line-808"></a>        * N is a NORMAL FORM (i.e. no redexes anywhere)
<a name="line-809"></a>          wanting a suitable number of extra args.
<a name="line-810"></a>
<a name="line-811"></a>The biggest reason for doing this is for cases like
<a name="line-812"></a>
<a name="line-813"></a>        f = \x -&gt; case x of
<a name="line-814"></a>                    True  -&gt; \y -&gt; e1
<a name="line-815"></a>                    False -&gt; \y -&gt; e2
<a name="line-816"></a>
<a name="line-817"></a>Here we want to get the lambdas together.  A good example is the nofib
<a name="line-818"></a>program fibheaps, which gets 25% more allocation if you don't do this
<a name="line-819"></a>eta-expansion.
<a name="line-820"></a>
<a name="line-821"></a>We may have to sandwich some coerces between the lambdas
<a name="line-822"></a>to make the types work.   exprEtaExpandArity looks through coerces
<a name="line-823"></a>when computing arity; and etaExpand adds the coerces as necessary when
<a name="line-824"></a>actually computing the expansion.
<a name="line-825"></a>
<a name="line-826"></a>Note [No crap in eta-expanded code]
<a name="line-827"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-828"></a>The eta expander is careful not to introduce "crap".  In particular,
<a name="line-829"></a>given a CoreExpr satisfying the 'CpeRhs' invariant (in CorePrep), it
<a name="line-830"></a>returns a CoreExpr satisfying the same invariant. See Note [Eta
<a name="line-831"></a>expansion and the CorePrep invariants] in CorePrep.
<a name="line-832"></a>
<a name="line-833"></a>This means the eta-expander has to do a bit of on-the-fly
<a name="line-834"></a>simplification but it's not too hard.  The alernative, of relying on
<a name="line-835"></a>a subsequent clean-up phase of the Simplifier to de-crapify the result,
<a name="line-836"></a>means you can't really use it in CorePrep, which is painful.
<a name="line-837"></a>
<a name="line-838"></a>Note [Eta expansion and SCCs]
<a name="line-839"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-840"></a>Note that SCCs are not treated specially by etaExpand.  If we have
<a name="line-841"></a>        etaExpand 2 (\x -&gt; scc "foo" e)
<a name="line-842"></a>        = (\xy -&gt; (scc "foo" e) y)
<a name="line-843"></a>So the costs of evaluating 'e' (not 'e y') are attributed to "foo"
<a name="line-844"></a>
<a name="line-845"></a>Note [Eta expansion and source notes]
<a name="line-846"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-847"></a>CorePrep puts floatable ticks outside of value applications, but not
<a name="line-848"></a>type applications. As a result we might be trying to eta-expand an
<a name="line-849"></a>expression like
<a name="line-850"></a>
<a name="line-851"></a>  (src&lt;...&gt; v) @a
<a name="line-852"></a>
<a name="line-853"></a>which we want to lead to code like
<a name="line-854"></a>
<a name="line-855"></a>  \x -&gt; src&lt;...&gt; v @a x
<a name="line-856"></a>
<a name="line-857"></a>This means that we need to look through type applications and be ready
<a name="line-858"></a>to re-add floats on the top.
<a name="line-859"></a>
<a name="line-860"></a>-}</span>
<a name="line-861"></a>
<a name="line-862"></a><a name="etaExpand"></a><span class='hs-comment'>-- | @etaExpand n e@ returns an expression with</span>
<a name="line-863"></a><span class='hs-comment'>-- the same meaning as @e@, but with arity @n@.</span>
<a name="line-864"></a><span class='hs-comment'>--</span>
<a name="line-865"></a><span class='hs-comment'>-- Given:</span>
<a name="line-866"></a><span class='hs-comment'>--</span>
<a name="line-867"></a><span class='hs-comment'>-- &gt; e' = etaExpand n e</span>
<a name="line-868"></a><span class='hs-comment'>--</span>
<a name="line-869"></a><span class='hs-comment'>-- We should have that:</span>
<a name="line-870"></a><span class='hs-comment'>--</span>
<a name="line-871"></a><span class='hs-comment'>-- &gt; ty = exprType e = exprType e'</span>
<a name="line-872"></a><span class='hs-definition'>etaExpand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span>              <span class='hs-comment'>-- ^ Result should have this number of value args</span>
<a name="line-873"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>           <span class='hs-comment'>-- ^ Expression to expand</span>
<a name="line-874"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-875"></a><span class='hs-comment'>-- etaExpand arity e = res</span>
<a name="line-876"></a><span class='hs-comment'>-- Then 'res' has at least 'arity' lambdas at the top</span>
<a name="line-877"></a><span class='hs-comment'>--</span>
<a name="line-878"></a><span class='hs-comment'>-- etaExpand deals with for-alls. For example:</span>
<a name="line-879"></a><span class='hs-comment'>--              etaExpand 1 E</span>
<a name="line-880"></a><span class='hs-comment'>-- where  E :: forall a. a -&gt; a</span>
<a name="line-881"></a><span class='hs-comment'>-- would return</span>
<a name="line-882"></a><span class='hs-comment'>--      (/\b. \y::a -&gt; E b y)</span>
<a name="line-883"></a><span class='hs-comment'>--</span>
<a name="line-884"></a><span class='hs-comment'>-- It deals with coerces too, though they are now rare</span>
<a name="line-885"></a><span class='hs-comment'>-- so perhaps the extra code isn't worth it</span>
<a name="line-886"></a>
<a name="line-887"></a><span class='hs-definition'>etaExpand</span> <span class='hs-varid'>n</span> <span class='hs-varid'>orig_expr</span>
<a name="line-888"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>orig_expr</span>
<a name="line-889"></a>  <span class='hs-keyword'>where</span>
<a name="line-890"></a>      <span class='hs-comment'>-- Strip off existing lambdas and casts</span>
<a name="line-891"></a>      <span class='hs-comment'>-- Note [Eta expansion and SCCs]</span>
<a name="line-892"></a>    <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span>
<a name="line-893"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>v</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>n</span>     <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-894"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-895"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cast</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-896"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span>
<a name="line-897"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "ee" (vcat [ppr orig_expr, ppr expr, ppr etas]) $</span>
<a name="line-898"></a>        <span class='hs-varid'>retick</span> <span class='hs-varop'>$</span> <span class='hs-varid'>etaInfoAbs</span> <span class='hs-varid'>etas</span> <span class='hs-layout'>(</span><span class='hs-varid'>etaInfoApp</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>sexpr</span> <span class='hs-varid'>etas</span><span class='hs-layout'>)</span>
<a name="line-899"></a>      <span class='hs-keyword'>where</span>
<a name="line-900"></a>          <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprFreeVars</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-901"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>in_scope'</span><span class='hs-layout'>,</span> <span class='hs-varid'>etas</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEtaWW</span> <span class='hs-varid'>n</span> <span class='hs-varid'>orig_expr</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-902"></a>          <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptySubst</span> <span class='hs-varid'>in_scope'</span>
<a name="line-903"></a>
<a name="line-904"></a>          <span class='hs-comment'>-- Find ticks behind type apps.</span>
<a name="line-905"></a>          <span class='hs-comment'>-- See Note [Eta expansion and source notes]</span>
<a name="line-906"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectArgs</span> <span class='hs-varid'>expr</span>
<a name="line-907"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>ticks</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr''</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stripTicksTop</span> <span class='hs-varid'>tickishFloatable</span> <span class='hs-varid'>expr'</span>
<a name="line-908"></a>          <span class='hs-varid'>sexpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>App</span> <span class='hs-varid'>expr''</span> <span class='hs-varid'>args</span>
<a name="line-909"></a>          <span class='hs-varid'>retick</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkTick</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>ticks</span>
<a name="line-910"></a>
<a name="line-911"></a>                                <span class='hs-comment'>-- Wrapper    Unwrapper</span>
<a name="line-912"></a><a name="EtaInfo"></a><span class='hs-comment'>--------------</span>
<a name="line-913"></a><a name="EtaInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EtaInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EtaVar</span> <span class='hs-conid'>Var</span>       <span class='hs-comment'>-- /\a. [],   [] a</span>
<a name="line-914"></a>                                <span class='hs-comment'>-- \x.  [],   [] x</span>
<a name="line-915"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EtaCo</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- [] |&gt; co,  [] |&gt; (sym co)</span>
<a name="line-916"></a>
<a name="line-917"></a><a name="instance%20Outputable%20EtaInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EtaInfo</span> <span class='hs-keyword'>where</span>
<a name="line-918"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"EtaVar"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-919"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"EtaCo"</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span>
<a name="line-920"></a>
<a name="line-921"></a><a name="pushCoercion"></a><span class='hs-definition'>pushCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EtaInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EtaInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-922"></a><span class='hs-definition'>pushCoercion</span> <span class='hs-varid'>co1</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaCo</span> <span class='hs-varid'>co2</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-923"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eis</span>
<a name="line-924"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EtaCo</span> <span class='hs-varid'>co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span>
<a name="line-925"></a>  <span class='hs-keyword'>where</span>
<a name="line-926"></a>    <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co2</span>
<a name="line-927"></a>
<a name="line-928"></a><span class='hs-definition'>pushCoercion</span> <span class='hs-varid'>co</span> <span class='hs-varid'>eis</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EtaCo</span> <span class='hs-varid'>co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span>
<a name="line-929"></a>
<a name="line-930"></a><a name="etaInfoAbs"></a><span class='hs-comment'>--------------</span>
<a name="line-931"></a><span class='hs-definition'>etaInfoAbs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EtaInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-932"></a><span class='hs-definition'>etaInfoAbs</span> <span class='hs-conid'>[]</span>               <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span>
<a name="line-933"></a><span class='hs-definition'>etaInfoAbs</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaVar</span> <span class='hs-varid'>v</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>etaInfoAbs</span> <span class='hs-varid'>eis</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-934"></a><span class='hs-definition'>etaInfoAbs</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaCo</span> <span class='hs-varid'>co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cast</span> <span class='hs-layout'>(</span><span class='hs-varid'>etaInfoAbs</span> <span class='hs-varid'>eis</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-935"></a>
<a name="line-936"></a><a name="etaInfoApp"></a><span class='hs-comment'>--------------</span>
<a name="line-937"></a><span class='hs-definition'>etaInfoApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EtaInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-938"></a><span class='hs-comment'>-- (etaInfoApp s e eis) returns something equivalent to</span>
<a name="line-939"></a><span class='hs-comment'>--             ((substExpr s e) `appliedto` eis)</span>
<a name="line-940"></a>
<a name="line-941"></a><span class='hs-definition'>etaInfoApp</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaVar</span> <span class='hs-varid'>v2</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-942"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaInfoApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreSubst</span><span class='hs-varop'>.</span><span class='hs-varid'>extendSubstWithVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-varid'>eis</span>
<a name="line-943"></a>
<a name="line-944"></a><span class='hs-definition'>etaInfoApp</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-945"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaInfoApp</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>pushCoercion</span> <span class='hs-varid'>co'</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-946"></a>  <span class='hs-keyword'>where</span>
<a name="line-947"></a>    <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreSubst</span><span class='hs-varop'>.</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co1</span>
<a name="line-948"></a>
<a name="line-949"></a><span class='hs-definition'>etaInfoApp</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-950"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>b1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_alts_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreSubst</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts'</span>
<a name="line-951"></a>  <span class='hs-keyword'>where</span>
<a name="line-952"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst1</span><span class='hs-layout'>,</span> <span class='hs-varid'>b1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span>
<a name="line-953"></a>    <span class='hs-varid'>alts'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>subst_alt</span> <span class='hs-varid'>alts</span>
<a name="line-954"></a>    <span class='hs-varid'>subst_alt</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>etaInfoApp</span> <span class='hs-varid'>subst2</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-955"></a>              <span class='hs-keyword'>where</span>
<a name="line-956"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>subst2</span><span class='hs-layout'>,</span><span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndrs</span> <span class='hs-varid'>subst1</span> <span class='hs-varid'>bs</span>
<a name="line-957"></a>
<a name="line-958"></a>    <span class='hs-varid'>mk_alts_ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-959"></a>    <span class='hs-varid'>mk_alts_ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaVar</span> <span class='hs-varid'>v</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_alts_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyTypeToArg</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>varToCoreExpr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-960"></a>    <span class='hs-varid'>mk_alts_ty</span> <span class='hs-keyword'>_</span>  <span class='hs-layout'>(</span><span class='hs-conid'>EtaCo</span> <span class='hs-varid'>co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_alts_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-961"></a>
<a name="line-962"></a><span class='hs-definition'>etaInfoApp</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-963"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>b'</span> <span class='hs-layout'>(</span><span class='hs-varid'>etaInfoApp</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>e</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-964"></a>  <span class='hs-keyword'>where</span>
<a name="line-965"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaInfoAppBind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span> <span class='hs-varid'>eis</span>
<a name="line-966"></a>
<a name="line-967"></a><span class='hs-definition'>etaInfoApp</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-968"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTickish</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>etaInfoApp</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-969"></a>
<a name="line-970"></a><span class='hs-definition'>etaInfoApp</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>_</span>
<a name="line-971"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collectArgs</span> <span class='hs-varid'>expr</span>
<a name="line-972"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>fun'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupIdSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"etaInfoApp"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span>
<a name="line-973"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isJoinId</span> <span class='hs-varid'>fun'</span>
<a name="line-974"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>expr</span>
<a name="line-975"></a>
<a name="line-976"></a><span class='hs-definition'>etaInfoApp</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e</span> <span class='hs-varid'>eis</span>
<a name="line-977"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-978"></a>  <span class='hs-keyword'>where</span>
<a name="line-979"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-conid'>[]</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span>
<a name="line-980"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaVar</span> <span class='hs-varid'>v</span>    <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>varToCoreExpr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-981"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaCo</span> <span class='hs-varid'>co</span>    <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-982"></a>
<a name="line-983"></a><a name="etaInfoAppBind"></a><span class='hs-comment'>--------------</span>
<a name="line-984"></a><span class='hs-comment'>-- | Apply the eta info to a local binding. Mostly delegates to</span>
<a name="line-985"></a><span class='hs-comment'>-- `etaInfoAppLocalBndr` and `etaInfoAppRhs`.</span>
<a name="line-986"></a><span class='hs-definition'>etaInfoAppBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EtaInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-987"></a><span class='hs-definition'>etaInfoAppBind</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-988"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-989"></a>  <span class='hs-keyword'>where</span>
<a name="line-990"></a>    <span class='hs-varid'>bndr_w_new_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaInfoAppLocalBndr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>eis</span>
<a name="line-991"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr_w_new_type</span>
<a name="line-992"></a>    <span class='hs-varid'>rhs'</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaInfoAppRhs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr1</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>eis</span>
<a name="line-993"></a>    <span class='hs-varid'>bndr'</span>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isJoinId</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr1</span> <span class='hs-varop'>`setIdArity`</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>rhs'</span>
<a name="line-994"></a>                                        <span class='hs-comment'>-- Arity may have changed</span>
<a name="line-995"></a>                                        <span class='hs-comment'>-- (see etaInfoAppRhs example)</span>
<a name="line-996"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr1</span>
<a name="line-997"></a><span class='hs-definition'>etaInfoAppBind</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-varid'>eis</span>
<a name="line-998"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs'</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rhss'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-999"></a>  <span class='hs-keyword'>where</span>
<a name="line-1000"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhss</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pairs</span>
<a name="line-1001"></a>    <span class='hs-varid'>bndrs_w_new_types</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>etaInfoAppLocalBndr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-1002"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs1</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substRecBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs_w_new_types</span>
<a name="line-1003"></a>    <span class='hs-varid'>rhss'</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>process</span> <span class='hs-varid'>bndrs1</span> <span class='hs-varid'>rhss</span>
<a name="line-1004"></a>    <span class='hs-varid'>process</span> <span class='hs-varid'>bndr'</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaInfoAppRhs</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>bndr'</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>eis</span>
<a name="line-1005"></a>    <span class='hs-varid'>bndrs'</span>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isJoinId</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-1006"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>bndr1</span> <span class='hs-varop'>`setIdArity`</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>rhs'</span>
<a name="line-1007"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bndrs1</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rhss'</span> <span class='hs-keyglyph'>]</span>
<a name="line-1008"></a>                          <span class='hs-comment'>-- Arities may have changed</span>
<a name="line-1009"></a>                          <span class='hs-comment'>-- (see etaInfoAppRhs example)</span>
<a name="line-1010"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1011"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs1</span>
<a name="line-1012"></a>
<a name="line-1013"></a><a name="etaInfoAppRhs"></a><span class='hs-comment'>--------------</span>
<a name="line-1014"></a><span class='hs-comment'>-- | Apply the eta info to a binder's RHS. Only interesting for a join point,</span>
<a name="line-1015"></a><span class='hs-comment'>-- where we might have this:</span>
<a name="line-1016"></a><span class='hs-comment'>--   join j :: a -&gt; [a] -&gt; [a]</span>
<a name="line-1017"></a><span class='hs-comment'>--        j x = \xs -&gt; x : xs in jump j z</span>
<a name="line-1018"></a><span class='hs-comment'>-- Eta-expanding produces this:</span>
<a name="line-1019"></a><span class='hs-comment'>--   \ys -&gt; (join j :: a -&gt; [a] -&gt; [a]</span>
<a name="line-1020"></a><span class='hs-comment'>--                j x = \xs -&gt; x : xs in jump j z) ys</span>
<a name="line-1021"></a><span class='hs-comment'>-- Now when we push the application to ys inward (see Note [No crap in</span>
<a name="line-1022"></a><span class='hs-comment'>-- eta-expanded code]), it goes to the body of the RHS of the join point (after</span>
<a name="line-1023"></a><span class='hs-comment'>-- the lambda x!):</span>
<a name="line-1024"></a><span class='hs-comment'>--   \ys -&gt; join j :: a -&gt; [a]</span>
<a name="line-1025"></a><span class='hs-comment'>--               j x = x : ys in jump j z</span>
<a name="line-1026"></a><span class='hs-comment'>-- Note that the type and arity of j have both changed.</span>
<a name="line-1027"></a><span class='hs-definition'>etaInfoAppRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EtaInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-1028"></a><span class='hs-definition'>etaInfoAppRhs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>eis</span>
<a name="line-1029"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isJoinId_maybe</span> <span class='hs-varid'>bndr</span>
<a name="line-1030"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_join_point</span> <span class='hs-varid'>arity</span>
<a name="line-1031"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1032"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>expr</span>
<a name="line-1033"></a>  <span class='hs-keyword'>where</span>
<a name="line-1034"></a>    <span class='hs-varid'>do_join_point</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>join_bndrs'</span> <span class='hs-varid'>join_body'</span>
<a name="line-1035"></a>      <span class='hs-keyword'>where</span>
<a name="line-1036"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>join_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>join_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectNBinders</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>expr</span>
<a name="line-1037"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>join_bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>join_bndrs</span>
<a name="line-1038"></a>        <span class='hs-varid'>join_body'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaInfoApp</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>join_body</span> <span class='hs-varid'>eis</span>
<a name="line-1039"></a>
<a name="line-1040"></a>
<a name="line-1041"></a><a name="etaInfoAppLocalBndr"></a><span class='hs-comment'>--------------</span>
<a name="line-1042"></a><span class='hs-comment'>-- | Apply the eta info to a local binder. A join point will have the EtaInfos</span>
<a name="line-1043"></a><span class='hs-comment'>-- applied to its RHS, so its type may change. See comment on etaInfoAppRhs for</span>
<a name="line-1044"></a><span class='hs-comment'>-- an example. See Note [No crap in eta-expanded code] for why all this is</span>
<a name="line-1045"></a><span class='hs-comment'>-- necessary.</span>
<a name="line-1046"></a><span class='hs-definition'>etaInfoAppLocalBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreBndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EtaInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBndr</span>
<a name="line-1047"></a><span class='hs-definition'>etaInfoAppLocalBndr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>orig_eis</span>
<a name="line-1048"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isJoinId_maybe</span> <span class='hs-varid'>bndr</span> <span class='hs-keyword'>of</span>
<a name="line-1049"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdType`</span> <span class='hs-varid'>modifyJoinResTy</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>(</span><span class='hs-varid'>app</span> <span class='hs-varid'>orig_eis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1050"></a>      <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bndr</span>
<a name="line-1051"></a>  <span class='hs-keyword'>where</span>
<a name="line-1052"></a>    <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span>
<a name="line-1053"></a>
<a name="line-1054"></a>    <span class='hs-comment'>-- | Apply the given EtaInfos to the result type of the join point.</span>
<a name="line-1055"></a>    <span class='hs-varid'>app</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EtaInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- To apply</span>
<a name="line-1056"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>      <span class='hs-comment'>-- Result type of join point</span>
<a name="line-1057"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>      <span class='hs-comment'>-- New result type</span>
<a name="line-1058"></a>    <span class='hs-varid'>app</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty</span>
<a name="line-1059"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-1060"></a>    <span class='hs-varid'>app</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaVar</span> <span class='hs-varid'>v</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1061"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>v</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>app</span> <span class='hs-varid'>eis</span> <span class='hs-layout'>(</span><span class='hs-varid'>funResultTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1062"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>app</span> <span class='hs-varid'>eis</span> <span class='hs-layout'>(</span><span class='hs-varid'>piResultTy</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1063"></a>    <span class='hs-varid'>app</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaCo</span> <span class='hs-varid'>co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1064"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span><span class='hs-varid'>from_ty</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"can't apply"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_eis</span><span class='hs-layout'>,</span>
<a name="line-1065"></a>                                            <span class='hs-varid'>text</span> <span class='hs-str'>"to"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1066"></a>                                                       <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1067"></a>        <span class='hs-varid'>app</span> <span class='hs-varid'>eis</span> <span class='hs-varid'>to_ty</span>
<a name="line-1068"></a>      <span class='hs-keyword'>where</span>
<a name="line-1069"></a>        <span class='hs-conid'>Pair</span> <span class='hs-varid'>from_ty</span> <span class='hs-varid'>to_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-1070"></a>
<a name="line-1071"></a><a name="mkEtaWW"></a><span class='hs-comment'>--------------</span>
<a name="line-1072"></a><span class='hs-definition'>mkEtaWW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1073"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>InScopeSet</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EtaInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1074"></a>        <span class='hs-comment'>-- EtaInfo contains fresh variables,</span>
<a name="line-1075"></a>        <span class='hs-comment'>--   not free in the incoming CoreExpr</span>
<a name="line-1076"></a>        <span class='hs-comment'>-- Outgoing InScopeSet includes the EtaInfo vars</span>
<a name="line-1077"></a>        <span class='hs-comment'>--   and the original free vars</span>
<a name="line-1078"></a>
<a name="line-1079"></a><span class='hs-definition'>mkEtaWW</span> <span class='hs-varid'>orig_n</span> <span class='hs-varid'>orig_expr</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>orig_ty</span>
<a name="line-1080"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_n</span> <span class='hs-varid'>empty_subst</span> <span class='hs-varid'>orig_ty</span> <span class='hs-conid'>[]</span>
<a name="line-1081"></a>  <span class='hs-keyword'>where</span>
<a name="line-1082"></a>    <span class='hs-varid'>empty_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varid'>in_scope</span>
<a name="line-1083"></a>
<a name="line-1084"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>eis</span>       <span class='hs-comment'>-- See Note [exprArity invariant]</span>
<a name="line-1085"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1086"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTCvInScope</span> <span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-1087"></a>
<a name="line-1088"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1089"></a>       <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-1090"></a>           <span class='hs-comment'>-- Avoid free vars of the original expression</span>
<a name="line-1091"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaVar</span> <span class='hs-varid'>tv'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-1092"></a>
<a name="line-1093"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1094"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypeLevPoly</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-1095"></a>          <span class='hs-comment'>-- See Note [Levity polymorphism invariants] in CoreSyn</span>
<a name="line-1096"></a>          <span class='hs-comment'>-- See also test case typecheck/should_run/EtaExpandLevPoly</span>
<a name="line-1097"></a>
<a name="line-1098"></a>       <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>eta_id'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>freshEtaId</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg_ty</span>
<a name="line-1099"></a>           <span class='hs-comment'>-- Avoid free vars of the original expression</span>
<a name="line-1100"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaVar</span> <span class='hs-varid'>eta_id'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-1101"></a>
<a name="line-1102"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topNormaliseNewType_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1103"></a>       <span class='hs-keyglyph'>=</span>        <span class='hs-comment'>-- Given this:</span>
<a name="line-1104"></a>                <span class='hs-comment'>--      newtype T = MkT ([T] -&gt; Int)</span>
<a name="line-1105"></a>                <span class='hs-comment'>-- Consider eta-expanding this</span>
<a name="line-1106"></a>                <span class='hs-comment'>--      eta_expand 1 e T</span>
<a name="line-1107"></a>                <span class='hs-comment'>-- We want to get</span>
<a name="line-1108"></a>                <span class='hs-comment'>--      coerce T (\x::[T] -&gt; (coerce ([T]-&gt;Int) e) x)</span>
<a name="line-1109"></a>         <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaCo</span> <span class='hs-varid'>co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-1110"></a>
<a name="line-1111"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-comment'>-- We have an expression of arity &gt; 0,</span>
<a name="line-1112"></a>                         <span class='hs-comment'>-- but its type isn't a function, or a binder</span>
<a name="line-1113"></a>                         <span class='hs-comment'>-- is levity-polymorphic</span>
<a name="line-1114"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_expr</span> <span class='hs-layout'>)</span>
<a name="line-1115"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>getTCvInScope</span> <span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>eis</span><span class='hs-layout'>)</span>
<a name="line-1116"></a>        <span class='hs-comment'>-- This *can* legitmately happen:</span>
<a name="line-1117"></a>        <span class='hs-comment'>-- e.g.  coerce Int (\x. x) Essentially the programmer is</span>
<a name="line-1118"></a>        <span class='hs-comment'>-- playing fast and loose with types (Happy does this a lot).</span>
<a name="line-1119"></a>        <span class='hs-comment'>-- So we simply decline to eta-expand.  Otherwise we'd end up</span>
<a name="line-1120"></a>        <span class='hs-comment'>-- with an explicit lambda having a non-function type</span>
<a name="line-1121"></a>
<a name="line-1122"></a>
<a name="line-1123"></a>
<a name="line-1124"></a><span class='hs-comment'>--------------</span>
<a name="line-1125"></a><span class='hs-comment'>-- Don't use short-cutting substitution - we may be changing the types of join</span>
<a name="line-1126"></a><span class='hs-comment'>-- points, so applying the in-scope set is necessary</span>
<a name="line-1127"></a><span class='hs-comment'>-- TODO Check if we actually *are* changing any join points' types</span>
<a name="line-1128"></a>
<a name="line-1129"></a><a name="subst_expr"></a><span class='hs-definition'>subst_expr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-1130"></a><span class='hs-definition'>subst_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"CoreArity:substExpr"</span><span class='hs-layout'>)</span>
<a name="line-1131"></a>
<a name="line-1132"></a>
<a name="line-1133"></a><span class='hs-comment'>--------------</span>
<a name="line-1134"></a>
<a name="line-1135"></a><a name="etaExpandToJoinPoint"></a><span class='hs-comment'>-- | Split an expression into the given number of binders and a body,</span>
<a name="line-1136"></a><span class='hs-comment'>-- eta-expanding if necessary. Counts value *and* type binders.</span>
<a name="line-1137"></a><span class='hs-definition'>etaExpandToJoinPoint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JoinArity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBndr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-1138"></a><span class='hs-definition'>etaExpandToJoinPoint</span> <span class='hs-varid'>join_arity</span> <span class='hs-varid'>expr</span>
<a name="line-1139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>join_arity</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>expr</span>
<a name="line-1140"></a>  <span class='hs-keyword'>where</span>
<a name="line-1141"></a>    <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-varid'>rev_bs</span> <span class='hs-varid'>e</span>         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>rev_bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-1142"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>rev_bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rev_bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-1143"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>rev_bs</span> <span class='hs-varid'>e</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>etaBodyForJoinPoint</span> <span class='hs-varid'>n</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-1144"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>rev_bs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-1145"></a>
<a name="line-1146"></a><a name="etaExpandToJoinPointRule"></a><span class='hs-definition'>etaExpandToJoinPointRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JoinArity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreRule</span>
<a name="line-1147"></a><span class='hs-definition'>etaExpandToJoinPointRule</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rule</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BuiltinRule</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1148"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Can't eta-expand built-in rule:"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rule</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1149"></a>      <span class='hs-comment'>-- How did a local binding get a built-in rule anyway? Probably a plugin.</span>
<a name="line-1150"></a>    <span class='hs-varid'>rule</span>
<a name="line-1151"></a><span class='hs-definition'>etaExpandToJoinPointRule</span> <span class='hs-varid'>join_arity</span> <span class='hs-varid'>rule</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span>
<a name="line-1152"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>ru_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1153"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>need_args</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1154"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule</span>
<a name="line-1155"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>need_args</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span>
<a name="line-1156"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"etaExpandToJoinPointRule"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>join_arity</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rule</span><span class='hs-layout'>)</span>
<a name="line-1157"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1158"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>new_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>new_args</span>
<a name="line-1159"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ru_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_rhs</span> <span class='hs-layout'>}</span>
<a name="line-1160"></a>  <span class='hs-keyword'>where</span>
<a name="line-1161"></a>    <span class='hs-varid'>need_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>join_arity</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span>
<a name="line-1162"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaBodyForJoinPoint</span> <span class='hs-varid'>need_args</span> <span class='hs-varid'>rhs</span>
<a name="line-1163"></a>    <span class='hs-varid'>new_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varsToCoreExprs</span> <span class='hs-varid'>new_bndrs</span>
<a name="line-1164"></a>
<a name="line-1165"></a><a name="etaBodyForJoinPoint"></a><span class='hs-comment'>-- Adds as many binders as asked for; assumes expr is not a lambda</span>
<a name="line-1166"></a><span class='hs-definition'>etaBodyForJoinPoint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBndr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-1167"></a><span class='hs-definition'>etaBodyForJoinPoint</span> <span class='hs-varid'>need_args</span> <span class='hs-varid'>body</span>
<a name="line-1168"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>need_args</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>init_subst</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>body</span>
<a name="line-1169"></a>  <span class='hs-keyword'>where</span>
<a name="line-1170"></a>    <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>     <span class='hs-varid'>rev_bs</span> <span class='hs-varid'>e</span>
<a name="line-1171"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>rev_bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-1172"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rev_bs</span> <span class='hs-varid'>e</span>
<a name="line-1173"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1174"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-1175"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rev_bs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-varop'>`App`</span> <span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1176"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1177"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>freshEtaId</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg_ty</span>
<a name="line-1178"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rev_bs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-varop'>`App`</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-1179"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1180"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"etaBodyForJoinPoint"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>int</span> <span class='hs-varid'>need_args</span> <span class='hs-varop'>$$</span>
<a name="line-1181"></a>                                         <span class='hs-varid'>ppr</span> <span class='hs-varid'>body</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-1182"></a>
<a name="line-1183"></a>    <span class='hs-varid'>init_subst</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprFreeVars</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1184"></a>
<a name="line-1185"></a><a name="freshEtaId"></a><span class='hs-comment'>--------------</span>
<a name="line-1186"></a><span class='hs-definition'>freshEtaId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-1187"></a><span class='hs-comment'>-- Make a fresh Id, with specified type (after applying substitution)</span>
<a name="line-1188"></a><span class='hs-comment'>-- It should be "fresh" in the sense that it's not in the in-scope set</span>
<a name="line-1189"></a><span class='hs-comment'>-- of the TvSubstEnv; and it should itself then be added to the in-scope</span>
<a name="line-1190"></a><span class='hs-comment'>-- set of the TvSubstEnv</span>
<a name="line-1191"></a><span class='hs-comment'>--</span>
<a name="line-1192"></a><span class='hs-comment'>-- The Int is just a reasonable starting point for generating a unique;</span>
<a name="line-1193"></a><span class='hs-comment'>-- it does not necessarily have to be unique itself.</span>
<a name="line-1194"></a><span class='hs-definition'>freshEtaId</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-1195"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>eta_id'</span><span class='hs-layout'>)</span>
<a name="line-1196"></a>      <span class='hs-keyword'>where</span>
<a name="line-1197"></a>        <span class='hs-varid'>ty'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-1198"></a>        <span class='hs-varid'>eta_id'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTCvInScope</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1199"></a>                  <span class='hs-varid'>mkSysLocalOrCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"eta"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBuiltinUnique</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span>
<a name="line-1200"></a>        <span class='hs-varid'>subst'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTCvInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>eta_id'</span>
</pre></body>
</html>
