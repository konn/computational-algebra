<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>cmm/SMRep.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- (c) The University of Glasgow 2006</span>
<a name="line-2"></a><span class='hs-comment'>-- (c) The GRASP/AQUA Project, Glasgow University, 1992-1998</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- Storage manager representation of closures</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE CPP,GeneralizedNewtypeDeriving #-}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>SMRep</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>        <span class='hs-comment'>-- * Words and bytes</span>
<a name="line-10"></a>        <span class='hs-conid'>WordOff</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteOff</span><span class='hs-layout'>,</span>
<a name="line-11"></a>        <span class='hs-varid'>wordsToBytes</span><span class='hs-layout'>,</span> <span class='hs-varid'>bytesToWordsRoundUp</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>roundUpToWords</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-conid'>StgWord</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromStgWord</span><span class='hs-layout'>,</span> <span class='hs-varid'>toStgWord</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-conid'>StgHalfWord</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromStgHalfWord</span><span class='hs-layout'>,</span> <span class='hs-varid'>toStgHalfWord</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>hALF_WORD_SIZE</span><span class='hs-layout'>,</span> <span class='hs-varid'>hALF_WORD_SIZE_IN_BITS</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-comment'>-- * Closure repesentation</span>
<a name="line-19"></a>        <span class='hs-conid'>SMRep</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- CmmInfo sees the rep; no one else does</span>
<a name="line-20"></a>        <span class='hs-conid'>IsStatic</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-conid'>ClosureTypeInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgDescr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Liveness</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-conid'>ConstrDescription</span><span class='hs-layout'>,</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-comment'>-- ** Construction</span>
<a name="line-25"></a>        <span class='hs-varid'>mkHeapRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>blackHoleRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>indStaticRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkStackRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRTSRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>arrPtrsRep</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>smallArrPtrsRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>arrWordsRep</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-comment'>-- ** Predicates</span>
<a name="line-29"></a>        <span class='hs-varid'>isStaticRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isConRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isThunkRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFunRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStaticNoCafCon</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>isStackRep</span><span class='hs-layout'>,</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-comment'>-- ** Size-related things</span>
<a name="line-33"></a>        <span class='hs-varid'>heapClosureSizeW</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>fixedHdrSizeW</span><span class='hs-layout'>,</span> <span class='hs-varid'>arrWordsHdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>arrWordsHdrSizeW</span><span class='hs-layout'>,</span> <span class='hs-varid'>arrPtrsHdrSize</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>arrPtrsHdrSizeW</span><span class='hs-layout'>,</span> <span class='hs-varid'>profHdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>thunkHdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonHdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonHdrSizeW</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>smallArrPtrsHdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>smallArrPtrsHdrSizeW</span><span class='hs-layout'>,</span> <span class='hs-varid'>hdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>hdrSizeW</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>fixedHdrSize</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-comment'>-- ** RTS closure types</span>
<a name="line-40"></a>        <span class='hs-varid'>rtsClosureType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rET_SMALL</span><span class='hs-layout'>,</span> <span class='hs-varid'>rET_BIG</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>aRG_GEN</span><span class='hs-layout'>,</span> <span class='hs-varid'>aRG_GEN_BIG</span><span class='hs-layout'>,</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-comment'>-- ** Arrays</span>
<a name="line-44"></a>        <span class='hs-varid'>card</span><span class='hs-layout'>,</span> <span class='hs-varid'>cardRoundUp</span><span class='hs-layout'>,</span> <span class='hs-varid'>cardTableSizeB</span><span class='hs-layout'>,</span> <span class='hs-varid'>cardTableSizeW</span><span class='hs-layout'>,</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-comment'>-- * Operations over [Word8] strings that don't belong here</span>
<a name="line-47"></a>        <span class='hs-varid'>pprWord8String</span><span class='hs-layout'>,</span> <span class='hs-varid'>stringToWord8s</span>
<a name="line-48"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-cpp'>#include "../HsVersions.h"</span>
<a name="line-51"></a><span class='hs-cpp'>#include "../includes/MachDeps.h"</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span><span class='hs-layout'>(</span> <span class='hs-varid'>ord</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Word</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bits</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-comment'>{-
<a name="line-63"></a>************************************************************************
<a name="line-64"></a>*                                                                      *
<a name="line-65"></a>                Words and bytes
<a name="line-66"></a>*                                                                      *
<a name="line-67"></a>************************************************************************
<a name="line-68"></a>-}</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="WordOff"></a><span class='hs-comment'>-- | Word offset, or word count</span>
<a name="line-71"></a><a name="WordOff"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="ByteOff"></a><span class='hs-comment'>-- | Byte offset, or byte count</span>
<a name="line-74"></a><a name="ByteOff"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="roundUpToWords"></a><span class='hs-comment'>-- | Round up the given byte count to the next byte count that's a</span>
<a name="line-77"></a><span class='hs-comment'>-- multiple of the machine's word size.</span>
<a name="line-78"></a><span class='hs-definition'>roundUpToWords</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-79"></a><span class='hs-definition'>roundUpToWords</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span>
<a name="line-80"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>dflags</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>.&amp;.</span> <span class='hs-layout'>(</span><span class='hs-varid'>complement</span> <span class='hs-layout'>(</span><span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>dflags</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="wordsToBytes"></a><span class='hs-comment'>-- | Convert the given number of words to a number of bytes.</span>
<a name="line-83"></a><span class='hs-comment'>--</span>
<a name="line-84"></a><span class='hs-comment'>-- This function morally has type @WordOff -&gt; ByteOff@, but uses @Num</span>
<a name="line-85"></a><span class='hs-comment'>-- a@ to allow for overloading.</span>
<a name="line-86"></a><span class='hs-definition'>wordsToBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-87"></a><span class='hs-definition'>wordsToBytes</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>n</span>
<a name="line-88"></a><span class='hs-comment'>{-# SPECIALIZE wordsToBytes :: DynFlags -&gt; Int -&gt; Int #-}</span>
<a name="line-89"></a><span class='hs-comment'>{-# SPECIALIZE wordsToBytes :: DynFlags -&gt; Word -&gt; Word #-}</span>
<a name="line-90"></a><span class='hs-comment'>{-# SPECIALIZE wordsToBytes :: DynFlags -&gt; Integer -&gt; Integer #-}</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="bytesToWordsRoundUp"></a><span class='hs-comment'>-- | First round the given byte count up to a multiple of the</span>
<a name="line-93"></a><span class='hs-comment'>-- machine's word size and then convert the result to words.</span>
<a name="line-94"></a><span class='hs-definition'>bytesToWordsRoundUp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-95"></a><span class='hs-definition'>bytesToWordsRoundUp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-varid'>word_size</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`quot`</span> <span class='hs-varid'>word_size</span>
<a name="line-96"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>word_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>dflags</span>
<a name="line-97"></a><a name="StgWord"></a><span class='hs-comment'>-- StgWord is a type representing an StgWord on the target platform.</span>
<a name="line-98"></a><a name="StgWord"></a><span class='hs-comment'>-- A Word64 is large enough to hold a Word for either a 32bit or 64bit platform</span>
<a name="line-99"></a><a name="StgWord"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>StgWord</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgWord</span> <span class='hs-conid'>Word64</span>
<a name="line-100"></a>    <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bits</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="fromStgWord"></a><span class='hs-definition'>fromStgWord</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgWord</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span>
<a name="line-103"></a><span class='hs-definition'>fromStgWord</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgWord</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toInteger</span> <span class='hs-varid'>i</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="toStgWord"></a><span class='hs-definition'>toStgWord</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgWord</span>
<a name="line-106"></a><span class='hs-definition'>toStgWord</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span>
<a name="line-107"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformWordSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-108"></a>      <span class='hs-comment'>-- These conversions mean that things like toStgWord (-1)</span>
<a name="line-109"></a>      <span class='hs-comment'>-- do the right thing</span>
<a name="line-110"></a>      <span class='hs-num'>4</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgWord</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromInteger</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word32</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-111"></a>      <span class='hs-num'>8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgWord</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromInteger</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word64</span><span class='hs-layout'>)</span>
<a name="line-112"></a>      <span class='hs-varid'>w</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"toStgWord: Unknown platformWordSize: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-113"></a>
<a name="line-114"></a><a name="instance%20Outputable%20StgWord"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StgWord</span> <span class='hs-keyword'>where</span>
<a name="line-115"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgWord</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>integer</span> <span class='hs-layout'>(</span><span class='hs-varid'>toInteger</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-116"></a>
<a name="line-117"></a><span class='hs-comment'>--</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="StgHalfWord"></a><span class='hs-comment'>-- A Word32 is large enough to hold half a Word for either a 32bit or</span>
<a name="line-120"></a><a name="StgHalfWord"></a><span class='hs-comment'>-- 64bit platform</span>
<a name="line-121"></a><a name="StgHalfWord"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>StgHalfWord</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgHalfWord</span> <span class='hs-conid'>Word32</span>
<a name="line-122"></a>    <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="fromStgHalfWord"></a><span class='hs-definition'>fromStgHalfWord</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgHalfWord</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span>
<a name="line-125"></a><span class='hs-definition'>fromStgHalfWord</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgHalfWord</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toInteger</span> <span class='hs-varid'>w</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="toStgHalfWord"></a><span class='hs-definition'>toStgHalfWord</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgHalfWord</span>
<a name="line-128"></a><span class='hs-definition'>toStgHalfWord</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span>
<a name="line-129"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>platformWordSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-130"></a>      <span class='hs-comment'>-- These conversions mean that things like toStgHalfWord (-1)</span>
<a name="line-131"></a>      <span class='hs-comment'>-- do the right thing</span>
<a name="line-132"></a>      <span class='hs-num'>4</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgHalfWord</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromInteger</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word16</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-133"></a>      <span class='hs-num'>8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgHalfWord</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromInteger</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word32</span><span class='hs-layout'>)</span>
<a name="line-134"></a>      <span class='hs-varid'>w</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"toStgHalfWord: Unknown platformWordSize: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="instance%20Outputable%20StgHalfWord"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StgHalfWord</span> <span class='hs-keyword'>where</span>
<a name="line-137"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgHalfWord</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>integer</span> <span class='hs-layout'>(</span><span class='hs-varid'>toInteger</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="hALF_WORD_SIZE"></a><span class='hs-definition'>hALF_WORD_SIZE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-140"></a><span class='hs-definition'>hALF_WORD_SIZE</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformWordSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>`shiftR`</span> <span class='hs-num'>1</span>
<a name="line-141"></a><a name="hALF_WORD_SIZE_IN_BITS"></a><span class='hs-definition'>hALF_WORD_SIZE_IN_BITS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-142"></a><span class='hs-definition'>hALF_WORD_SIZE_IN_BITS</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformWordSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-num'>2</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-comment'>{-
<a name="line-145"></a>************************************************************************
<a name="line-146"></a>*                                                                      *
<a name="line-147"></a>\subsubsection[SMRep-datatype]{@SMRep@---storage manager representation}
<a name="line-148"></a>*                                                                      *
<a name="line-149"></a>************************************************************************
<a name="line-150"></a>-}</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="SMRep"></a><span class='hs-comment'>-- | A description of the layout of a closure.  Corresponds directly</span>
<a name="line-153"></a><a name="SMRep"></a><span class='hs-comment'>-- to the closure types in includes/rts/storage/ClosureTypes.h.</span>
<a name="line-154"></a><a name="SMRep"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SMRep</span>
<a name="line-155"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeapRep</span>              <span class='hs-comment'>-- GC routines consult sizes in info tbl</span>
<a name="line-156"></a>        <span class='hs-conid'>IsStatic</span>
<a name="line-157"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>WordOff</span>         <span class='hs-comment'>--  # ptr words</span>
<a name="line-158"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>WordOff</span>         <span class='hs-comment'>--  # non-ptr words INCLUDING SLOP (see mkHeapRep below)</span>
<a name="line-159"></a>        <span class='hs-conid'>ClosureTypeInfo</span>  <span class='hs-comment'>-- type-specific info</span>
<a name="line-160"></a>
<a name="line-161"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrayPtrsRep</span>
<a name="line-162"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>WordOff</span>        <span class='hs-comment'>-- # ptr words</span>
<a name="line-163"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>WordOff</span>        <span class='hs-comment'>-- # card table words</span>
<a name="line-164"></a>
<a name="line-165"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SmallArrayPtrsRep</span>
<a name="line-166"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>WordOff</span>        <span class='hs-comment'>-- # ptr words</span>
<a name="line-167"></a>
<a name="line-168"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrayWordsRep</span>
<a name="line-169"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>WordOff</span>        <span class='hs-comment'>-- # bytes expressed in words, rounded up</span>
<a name="line-170"></a>
<a name="line-171"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StackRep</span>            <span class='hs-comment'>-- Stack frame (RET_SMALL or RET_BIG)</span>
<a name="line-172"></a>        <span class='hs-conid'>Liveness</span>
<a name="line-173"></a>
<a name="line-174"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RTSRep</span>              <span class='hs-comment'>-- The RTS needs to declare info tables with specific</span>
<a name="line-175"></a>        <span class='hs-conid'>Int</span>             <span class='hs-comment'>-- type tags, so this form lets us override the default</span>
<a name="line-176"></a>        <span class='hs-conid'>SMRep</span>           <span class='hs-comment'>-- tag for an SMRep.</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="IsStatic"></a><span class='hs-comment'>-- | True &lt;=&gt; This is a static closure.  Affects how we garbage-collect it.</span>
<a name="line-179"></a><a name="IsStatic"></a><span class='hs-comment'>-- Static closure have an extra static link field at the end.</span>
<a name="line-180"></a><a name="IsStatic"></a><span class='hs-comment'>-- Constructors do not have a static variant; see Note [static constructors]</span>
<a name="line-181"></a><a name="IsStatic"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IsStatic</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bool</span>
<a name="line-182"></a>
<a name="line-183"></a><span class='hs-comment'>-- From an SMRep you can get to the closure type defined in</span>
<a name="line-184"></a><span class='hs-comment'>-- includes/rts/storage/ClosureTypes.h. Described by the function</span>
<a name="line-185"></a><span class='hs-comment'>-- rtsClosureType below.</span>
<a name="line-186"></a>
<a name="line-187"></a><a name="ClosureTypeInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ClosureTypeInfo</span>
<a name="line-188"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Constr</span>        <span class='hs-conid'>ConstrTag</span> <span class='hs-conid'>ConstrDescription</span>
<a name="line-189"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Fun</span>           <span class='hs-conid'>FunArity</span> <span class='hs-conid'>ArgDescr</span>
<a name="line-190"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Thunk</span>
<a name="line-191"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ThunkSelector</span> <span class='hs-conid'>SelectorOffset</span>
<a name="line-192"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BlackHole</span>
<a name="line-193"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IndStatic</span>
<a name="line-194"></a>
<a name="line-195"></a><a name="ConstrTag"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ConstrTag</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-196"></a><a name="ConstrDescription"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ConstrDescription</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- result of dataConIdentity</span>
<a name="line-197"></a><a name="FunArity"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FunArity</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-198"></a><a name="SelectorOffset"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SelectorOffset</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-199"></a>
<a name="line-200"></a><span class='hs-comment'>-------------------------</span>
<a name="line-201"></a><span class='hs-comment'>-- We represent liveness bitmaps as a Bitmap (whose internal</span>
<a name="line-202"></a><span class='hs-comment'>-- representation really is a bitmap).  These are pinned onto case return</span>
<a name="line-203"></a><span class='hs-comment'>-- vectors to indicate the state of the stack for the garbage collector.</span>
<a name="line-204"></a><span class='hs-comment'>--</span>
<a name="line-205"></a><span class='hs-comment'>-- In the compiled program, liveness bitmaps that fit inside a single</span>
<a name="line-206"></a><span class='hs-comment'>-- word (StgWord) are stored as a single word, while larger bitmaps are</span>
<a name="line-207"></a><span class='hs-comment'>-- stored as a pointer to an array of words.</span>
<a name="line-208"></a>
<a name="line-209"></a><a name="Liveness"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Liveness</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- One Bool per word; True  &lt;=&gt; non-ptr or dead</span>
<a name="line-210"></a>                         <span class='hs-comment'>--                    False &lt;=&gt; ptr</span>
<a name="line-211"></a>
<a name="line-212"></a><span class='hs-comment'>-------------------------</span>
<a name="line-213"></a><span class='hs-comment'>-- An ArgDescr describes the argument pattern of a function</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="ArgDescr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArgDescr</span>
<a name="line-216"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ArgSpec</span>             <span class='hs-comment'>-- Fits one of the standard patterns</span>
<a name="line-217"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>            <span class='hs-comment'>-- RTS type identifier ARG_P, ARG_N, ...</span>
<a name="line-218"></a>
<a name="line-219"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArgGen</span>              <span class='hs-comment'>-- General case</span>
<a name="line-220"></a>        <span class='hs-conid'>Liveness</span>        <span class='hs-comment'>-- Details about the arguments</span>
<a name="line-221"></a>
<a name="line-222"></a>
<a name="line-223"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-224"></a><span class='hs-comment'>-- Construction</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="mkHeapRep"></a><span class='hs-definition'>mkHeapRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsStatic</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClosureTypeInfo</span>
<a name="line-227"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span>
<a name="line-228"></a><span class='hs-definition'>mkHeapRep</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>is_static</span> <span class='hs-varid'>ptr_wds</span> <span class='hs-varid'>nonptr_wds</span> <span class='hs-varid'>cl_type_info</span>
<a name="line-229"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeapRep</span> <span class='hs-varid'>is_static</span>
<a name="line-230"></a>            <span class='hs-varid'>ptr_wds</span>
<a name="line-231"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>nonptr_wds</span> <span class='hs-varop'>+</span> <span class='hs-varid'>slop_wds</span><span class='hs-layout'>)</span>
<a name="line-232"></a>            <span class='hs-varid'>cl_type_info</span>
<a name="line-233"></a>  <span class='hs-keyword'>where</span>
<a name="line-234"></a>     <span class='hs-varid'>slop_wds</span>
<a name="line-235"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_static</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-236"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>minClosureSize</span> <span class='hs-varid'>dflags</span> <span class='hs-comment'>-</span> <span class='hs-layout'>(</span><span class='hs-varid'>hdr_size</span> <span class='hs-varop'>+</span> <span class='hs-varid'>payload_size</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-237"></a>
<a name="line-238"></a>     <span class='hs-varid'>hdr_size</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureTypeHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cl_type_info</span>
<a name="line-239"></a>     <span class='hs-varid'>payload_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptr_wds</span> <span class='hs-varop'>+</span> <span class='hs-varid'>nonptr_wds</span>
<a name="line-240"></a>
<a name="line-241"></a><a name="mkRTSRep"></a><span class='hs-definition'>mkRTSRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span>
<a name="line-242"></a><span class='hs-definition'>mkRTSRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RTSRep</span>
<a name="line-243"></a>
<a name="line-244"></a><a name="mkStackRep"></a><span class='hs-definition'>mkStackRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span>
<a name="line-245"></a><span class='hs-definition'>mkStackRep</span> <span class='hs-varid'>liveness</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StackRep</span> <span class='hs-varid'>liveness</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="blackHoleRep"></a><span class='hs-definition'>blackHoleRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span>
<a name="line-248"></a><span class='hs-definition'>blackHoleRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-conid'>BlackHole</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="indStaticRep"></a><span class='hs-definition'>indStaticRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span>
<a name="line-251"></a><span class='hs-definition'>indStaticRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>True</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-conid'>IndStatic</span>
<a name="line-252"></a>
<a name="line-253"></a><a name="arrPtrsRep"></a><span class='hs-definition'>arrPtrsRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span>
<a name="line-254"></a><span class='hs-definition'>arrPtrsRep</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>elems</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ArrayPtrsRep</span> <span class='hs-varid'>elems</span> <span class='hs-layout'>(</span><span class='hs-varid'>cardTableSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>elems</span><span class='hs-layout'>)</span>
<a name="line-255"></a>
<a name="line-256"></a><a name="smallArrPtrsRep"></a><span class='hs-definition'>smallArrPtrsRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span>
<a name="line-257"></a><span class='hs-definition'>smallArrPtrsRep</span> <span class='hs-varid'>elems</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SmallArrayPtrsRep</span> <span class='hs-varid'>elems</span>
<a name="line-258"></a>
<a name="line-259"></a><a name="arrWordsRep"></a><span class='hs-definition'>arrWordsRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span>
<a name="line-260"></a><span class='hs-definition'>arrWordsRep</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>bytes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ArrayWordsRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>bytesToWordsRoundUp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>bytes</span><span class='hs-layout'>)</span>
<a name="line-261"></a>
<a name="line-262"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-263"></a><span class='hs-comment'>-- Predicates</span>
<a name="line-264"></a>
<a name="line-265"></a><a name="isStaticRep"></a><span class='hs-definition'>isStaticRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsStatic</span>
<a name="line-266"></a><span class='hs-definition'>isStaticRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-varid'>is_static</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_static</span>
<a name="line-267"></a><span class='hs-definition'>isStaticRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>RTSRep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStaticRep</span> <span class='hs-varid'>rep</span>
<a name="line-268"></a><span class='hs-definition'>isStaticRep</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-269"></a>
<a name="line-270"></a><a name="isStackRep"></a><span class='hs-definition'>isStackRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-271"></a><span class='hs-definition'>isStackRep</span> <span class='hs-conid'>StackRep</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-272"></a><span class='hs-definition'>isStackRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>RTSRep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStackRep</span> <span class='hs-varid'>rep</span>
<a name="line-273"></a><span class='hs-definition'>isStackRep</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-274"></a>
<a name="line-275"></a><a name="isConRep"></a><span class='hs-definition'>isConRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-276"></a><span class='hs-definition'>isConRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-277"></a><span class='hs-definition'>isConRep</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-278"></a>
<a name="line-279"></a><a name="isThunkRep"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-280"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-281"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>ThunkSelector</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-282"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>BlackHole</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-283"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>IndStatic</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-284"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-keyword'>_</span>                               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-285"></a>
<a name="line-286"></a><a name="isFunRep"></a><span class='hs-definition'>isFunRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-287"></a><span class='hs-definition'>isFunRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-288"></a><span class='hs-definition'>isFunRep</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-289"></a>
<a name="line-290"></a><a name="isStaticNoCafCon"></a><span class='hs-definition'>isStaticNoCafCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-291"></a><span class='hs-comment'>-- This should line up exactly with CONSTR_NOCAF below</span>
<a name="line-292"></a><span class='hs-comment'>-- See Note [Static NoCaf constructors]</span>
<a name="line-293"></a><span class='hs-definition'>isStaticNoCafCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-294"></a><span class='hs-definition'>isStaticNoCafCon</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-295"></a>
<a name="line-296"></a>
<a name="line-297"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-298"></a><span class='hs-comment'>-- Size-related things</span>
<a name="line-299"></a>
<a name="line-300"></a><a name="fixedHdrSize"></a><span class='hs-definition'>fixedHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-301"></a><span class='hs-definition'>fixedHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wordsToBytes</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixedHdrSizeW</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-302"></a>
<a name="line-303"></a><a name="fixedHdrSizeW"></a><span class='hs-comment'>-- | Size of a closure header (StgHeader in includes/rts/storage/Closures.h)</span>
<a name="line-304"></a><span class='hs-definition'>fixedHdrSizeW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-305"></a><span class='hs-definition'>fixedHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sTD_HDR_SIZE</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span> <span class='hs-varid'>profHdrSize</span> <span class='hs-varid'>dflags</span>
<a name="line-306"></a>
<a name="line-307"></a><a name="profHdrSize"></a><span class='hs-comment'>-- | Size of the profiling part of a closure header</span>
<a name="line-308"></a><span class='hs-comment'>-- (StgProfHeader in includes/rts/storage/Closures.h)</span>
<a name="line-309"></a><span class='hs-definition'>profHdrSize</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-310"></a><span class='hs-definition'>profHdrSize</span> <span class='hs-varid'>dflags</span>
<a name="line-311"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_SccProfilingOn</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pROF_HDR_SIZE</span> <span class='hs-varid'>dflags</span>
<a name="line-312"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-313"></a>
<a name="line-314"></a><a name="minClosureSize"></a><span class='hs-comment'>-- | The garbage collector requires that every closure is at least as</span>
<a name="line-315"></a><span class='hs-comment'>--   big as this.</span>
<a name="line-316"></a><span class='hs-definition'>minClosureSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-317"></a><span class='hs-definition'>minClosureSize</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span> <span class='hs-varid'>mIN_PAYLOAD_SIZE</span> <span class='hs-varid'>dflags</span>
<a name="line-318"></a>
<a name="line-319"></a><a name="arrWordsHdrSize"></a><span class='hs-definition'>arrWordsHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-320"></a><span class='hs-definition'>arrWordsHdrSize</span> <span class='hs-varid'>dflags</span>
<a name="line-321"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sIZEOF_StgArrBytes_NoHdr</span> <span class='hs-varid'>dflags</span>
<a name="line-322"></a>
<a name="line-323"></a><a name="arrWordsHdrSizeW"></a><span class='hs-definition'>arrWordsHdrSizeW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-324"></a><span class='hs-definition'>arrWordsHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span>
<a name="line-325"></a>    <span class='hs-varid'>fixedHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span>
<a name="line-326"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sIZEOF_StgArrBytes_NoHdr</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>`quot`</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-327"></a>
<a name="line-328"></a><a name="arrPtrsHdrSize"></a><span class='hs-definition'>arrPtrsHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-329"></a><span class='hs-definition'>arrPtrsHdrSize</span> <span class='hs-varid'>dflags</span>
<a name="line-330"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sIZEOF_StgMutArrPtrs_NoHdr</span> <span class='hs-varid'>dflags</span>
<a name="line-331"></a>
<a name="line-332"></a><a name="arrPtrsHdrSizeW"></a><span class='hs-definition'>arrPtrsHdrSizeW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-333"></a><span class='hs-definition'>arrPtrsHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span>
<a name="line-334"></a>    <span class='hs-varid'>fixedHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span>
<a name="line-335"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sIZEOF_StgMutArrPtrs_NoHdr</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>`quot`</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-336"></a>
<a name="line-337"></a><a name="smallArrPtrsHdrSize"></a><span class='hs-definition'>smallArrPtrsHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-338"></a><span class='hs-definition'>smallArrPtrsHdrSize</span> <span class='hs-varid'>dflags</span>
<a name="line-339"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sIZEOF_StgSmallMutArrPtrs_NoHdr</span> <span class='hs-varid'>dflags</span>
<a name="line-340"></a>
<a name="line-341"></a><a name="smallArrPtrsHdrSizeW"></a><span class='hs-definition'>smallArrPtrsHdrSizeW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-342"></a><span class='hs-definition'>smallArrPtrsHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span>
<a name="line-343"></a>    <span class='hs-varid'>fixedHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span>
<a name="line-344"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sIZEOF_StgSmallMutArrPtrs_NoHdr</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>`quot`</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-345"></a>
<a name="line-346"></a><a name="thunkHdrSize"></a><span class='hs-comment'>-- Thunks have an extra header word on SMP, so the update doesn't</span>
<a name="line-347"></a><span class='hs-comment'>-- splat the payload.</span>
<a name="line-348"></a><span class='hs-definition'>thunkHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-349"></a><span class='hs-definition'>thunkHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span> <span class='hs-varid'>smp_hdr</span>
<a name="line-350"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>smp_hdr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sIZEOF_StgSMPThunkHeader</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>`quot`</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>dflags</span>
<a name="line-351"></a>
<a name="line-352"></a><a name="hdrSize"></a><span class='hs-definition'>hdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-353"></a><span class='hs-definition'>hdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wordsToBytes</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span>
<a name="line-354"></a>
<a name="line-355"></a><a name="hdrSizeW"></a><span class='hs-definition'>hdrSizeW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-356"></a><span class='hs-definition'>hdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureTypeHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty</span>
<a name="line-357"></a><span class='hs-definition'>hdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrayPtrsRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arrPtrsHdrSizeW</span> <span class='hs-varid'>dflags</span>
<a name="line-358"></a><span class='hs-definition'>hdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>SmallArrayPtrsRep</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>smallArrPtrsHdrSizeW</span> <span class='hs-varid'>dflags</span>
<a name="line-359"></a><span class='hs-definition'>hdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrayWordsRep</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arrWordsHdrSizeW</span> <span class='hs-varid'>dflags</span>
<a name="line-360"></a><span class='hs-definition'>hdrSizeW</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"SMRep.hdrSizeW"</span>
<a name="line-361"></a>
<a name="line-362"></a><a name="nonHdrSize"></a><span class='hs-definition'>nonHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-363"></a><span class='hs-definition'>nonHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wordsToBytes</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonHdrSizeW</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span>
<a name="line-364"></a>
<a name="line-365"></a><a name="nonHdrSizeW"></a><span class='hs-definition'>nonHdrSizeW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-366"></a><span class='hs-definition'>nonHdrSizeW</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-varid'>np</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span> <span class='hs-varop'>+</span> <span class='hs-varid'>np</span>
<a name="line-367"></a><span class='hs-definition'>nonHdrSizeW</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrayPtrsRep</span> <span class='hs-varid'>elems</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elems</span> <span class='hs-varop'>+</span> <span class='hs-varid'>ct</span>
<a name="line-368"></a><span class='hs-definition'>nonHdrSizeW</span> <span class='hs-layout'>(</span><span class='hs-conid'>SmallArrayPtrsRep</span> <span class='hs-varid'>elems</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elems</span>
<a name="line-369"></a><span class='hs-definition'>nonHdrSizeW</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrayWordsRep</span> <span class='hs-varid'>words</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>words</span>
<a name="line-370"></a><span class='hs-definition'>nonHdrSizeW</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackRep</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>bs</span>
<a name="line-371"></a><span class='hs-definition'>nonHdrSizeW</span> <span class='hs-layout'>(</span><span class='hs-conid'>RTSRep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonHdrSizeW</span> <span class='hs-varid'>rep</span>
<a name="line-372"></a>
<a name="line-373"></a><a name="heapClosureSizeW"></a><span class='hs-comment'>-- | The total size of the closure, in words.</span>
<a name="line-374"></a><span class='hs-definition'>heapClosureSizeW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-375"></a><span class='hs-definition'>heapClosureSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-varid'>np</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-376"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureTypeHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>+</span> <span class='hs-varid'>p</span> <span class='hs-varop'>+</span> <span class='hs-varid'>np</span>
<a name="line-377"></a><span class='hs-definition'>heapClosureSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrayPtrsRep</span> <span class='hs-varid'>elems</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-378"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arrPtrsHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span> <span class='hs-varid'>elems</span> <span class='hs-varop'>+</span> <span class='hs-varid'>ct</span>
<a name="line-379"></a><span class='hs-definition'>heapClosureSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>SmallArrayPtrsRep</span> <span class='hs-varid'>elems</span><span class='hs-layout'>)</span>
<a name="line-380"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>smallArrPtrsHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span> <span class='hs-varid'>elems</span>
<a name="line-381"></a><span class='hs-definition'>heapClosureSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrayWordsRep</span> <span class='hs-varid'>words</span><span class='hs-layout'>)</span>
<a name="line-382"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arrWordsHdrSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>+</span> <span class='hs-varid'>words</span>
<a name="line-383"></a><span class='hs-definition'>heapClosureSizeW</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"SMRep.heapClosureSize"</span>
<a name="line-384"></a>
<a name="line-385"></a><a name="closureTypeHdrSize"></a><span class='hs-definition'>closureTypeHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClosureTypeInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-386"></a><span class='hs-definition'>closureTypeHdrSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-387"></a>                  <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thunkHdrSize</span> <span class='hs-varid'>dflags</span>
<a name="line-388"></a>                  <span class='hs-conid'>ThunkSelector</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thunkHdrSize</span> <span class='hs-varid'>dflags</span>
<a name="line-389"></a>                  <span class='hs-conid'>BlackHole</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thunkHdrSize</span> <span class='hs-varid'>dflags</span>
<a name="line-390"></a>                  <span class='hs-conid'>IndStatic</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thunkHdrSize</span> <span class='hs-varid'>dflags</span>
<a name="line-391"></a>                  <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fixedHdrSizeW</span> <span class='hs-varid'>dflags</span>
<a name="line-392"></a>        <span class='hs-comment'>-- All thunks use thunkHdrSize, even if they are non-updatable.</span>
<a name="line-393"></a>        <span class='hs-comment'>-- this is because we don't have separate closure types for</span>
<a name="line-394"></a>        <span class='hs-comment'>-- updatable vs. non-updatable thunks, so the GC can't tell the</span>
<a name="line-395"></a>        <span class='hs-comment'>-- difference.  If we ever have significant numbers of non-</span>
<a name="line-396"></a>        <span class='hs-comment'>-- updatable thunks, it might be worth fixing this.</span>
<a name="line-397"></a>
<a name="line-398"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-399"></a><span class='hs-comment'>-- Arrays</span>
<a name="line-400"></a>
<a name="line-401"></a><a name="card"></a><span class='hs-comment'>-- | The byte offset into the card table of the card for a given element</span>
<a name="line-402"></a><span class='hs-definition'>card</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-403"></a><span class='hs-definition'>card</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>`shiftR`</span> <span class='hs-varid'>mUT_ARR_PTRS_CARD_BITS</span> <span class='hs-varid'>dflags</span>
<a name="line-404"></a>
<a name="line-405"></a><a name="cardRoundUp"></a><span class='hs-comment'>-- | Convert a number of elements to a number of cards, rounding up</span>
<a name="line-406"></a><span class='hs-definition'>cardRoundUp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-407"></a><span class='hs-definition'>cardRoundUp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span>
<a name="line-408"></a>  <span class='hs-varid'>card</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-varid'>mUT_ARR_PTRS_CARD_BITS</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-409"></a>
<a name="line-410"></a><a name="cardTableSizeB"></a><span class='hs-comment'>-- | The size of a card table, in bytes</span>
<a name="line-411"></a><span class='hs-definition'>cardTableSizeB</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>
<a name="line-412"></a><span class='hs-definition'>cardTableSizeB</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>elems</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cardRoundUp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>elems</span>
<a name="line-413"></a>
<a name="line-414"></a><a name="cardTableSizeW"></a><span class='hs-comment'>-- | The size of a card table, in words</span>
<a name="line-415"></a><span class='hs-definition'>cardTableSizeW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-416"></a><span class='hs-definition'>cardTableSizeW</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>elems</span> <span class='hs-keyglyph'>=</span>
<a name="line-417"></a>  <span class='hs-varid'>bytesToWordsRoundUp</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>cardTableSizeB</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>elems</span><span class='hs-layout'>)</span>
<a name="line-418"></a>
<a name="line-419"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-420"></a><span class='hs-comment'>-- deriving the RTS closure type from an SMRep</span>
<a name="line-421"></a>
<a name="line-422"></a><span class='hs-cpp'>#include "../includes/rts/storage/ClosureTypes.h"</span>
<a name="line-423"></a><span class='hs-cpp'>#include "../includes/rts/storage/FunTypes.h"</span>
<a name="line-424"></a><span class='hs-comment'>-- Defines CONSTR, CONSTR_1_0 etc</span>
<a name="line-425"></a>
<a name="line-426"></a><a name="rtsClosureType"></a><span class='hs-comment'>-- | Derives the RTS closure type from an 'SMRep'</span>
<a name="line-427"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-428"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-varid'>rep</span>
<a name="line-429"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rep</span> <span class='hs-keyword'>of</span>
<a name="line-430"></a>      <span class='hs-conid'>RTSRep</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span>
<a name="line-431"></a>
<a name="line-432"></a>      <span class='hs-comment'>-- See Note [static constructors]</span>
<a name="line-433"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span>     <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CONSTR_1_0</span>
<a name="line-434"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span>     <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CONSTR_0_1</span>
<a name="line-435"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span>     <span class='hs-num'>2</span> <span class='hs-num'>0</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CONSTR_2_0</span>
<a name="line-436"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span>     <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CONSTR_1_1</span>
<a name="line-437"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span>     <span class='hs-num'>0</span> <span class='hs-num'>2</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CONSTR_0_2</span>
<a name="line-438"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span>     <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CONSTR_NOCAF</span>
<a name="line-439"></a>           <span class='hs-comment'>-- See Note [Static NoCaf constructors]</span>
<a name="line-440"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span>     <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CONSTR</span>
<a name="line-441"></a>
<a name="line-442"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FUN_1_0</span>
<a name="line-443"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FUN_0_1</span>
<a name="line-444"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>2</span> <span class='hs-num'>0</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FUN_2_0</span>
<a name="line-445"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FUN_1_1</span>
<a name="line-446"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>2</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FUN_0_2</span>
<a name="line-447"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FUN</span>
<a name="line-448"></a>
<a name="line-449"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>THUNK_1_0</span>
<a name="line-450"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>THUNK_0_1</span>
<a name="line-451"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>2</span> <span class='hs-num'>0</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>THUNK_2_0</span>
<a name="line-452"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>THUNK_1_1</span>
<a name="line-453"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>2</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>THUNK_0_2</span>
<a name="line-454"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>THUNK</span>
<a name="line-455"></a>
<a name="line-456"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>ThunkSelector</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>THUNK_SELECTOR</span>
<a name="line-457"></a>
<a name="line-458"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>True</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FUN_STATIC</span>
<a name="line-459"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>True</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>THUNK_STATIC</span>
<a name="line-460"></a>
<a name="line-461"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>BlackHole</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BLACKHOLE</span>
<a name="line-462"></a>
<a name="line-463"></a>      <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>IndStatic</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IND_STATIC</span>
<a name="line-464"></a>
<a name="line-465"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rtsClosureType"</span>
<a name="line-466"></a>
<a name="line-467"></a><a name="rET_SMALL"></a><span class='hs-comment'>-- We export these ones</span>
<a name="line-468"></a><span class='hs-definition'>rET_SMALL</span><span class='hs-layout'>,</span> <span class='hs-varid'>rET_BIG</span><span class='hs-layout'>,</span> <span class='hs-varid'>aRG_GEN</span><span class='hs-layout'>,</span> <span class='hs-varid'>aRG_GEN_BIG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-469"></a><span class='hs-definition'>rET_SMALL</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RET_SMALL</span>
<a name="line-470"></a><a name="rET_BIG"></a><span class='hs-definition'>rET_BIG</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RET_BIG</span>
<a name="line-471"></a><a name="aRG_GEN"></a><span class='hs-definition'>aRG_GEN</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ARG_GEN</span>
<a name="line-472"></a><a name="aRG_GEN_BIG"></a><span class='hs-definition'>aRG_GEN_BIG</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ARG_GEN_BIG</span>
<a name="line-473"></a>
<a name="line-474"></a><span class='hs-comment'>{-
<a name="line-475"></a>Note [static constructors]
<a name="line-476"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-477"></a>
<a name="line-478"></a>We used to have a CONSTR_STATIC closure type, and each constructor had
<a name="line-479"></a>two info tables: one with CONSTR (or CONSTR_1_0 etc.), and one with
<a name="line-480"></a>CONSTR_STATIC.
<a name="line-481"></a>
<a name="line-482"></a>This distinction was removed, because when copying a data structure
<a name="line-483"></a>into a compact region, we must copy static constructors into the
<a name="line-484"></a>compact region too.  If we didn't do this, we would need to track the
<a name="line-485"></a>references from the compact region out to the static constructors,
<a name="line-486"></a>because they might (indirectly) refer to CAFs.
<a name="line-487"></a>
<a name="line-488"></a>Since static constructors will be copied to the heap, if we wanted to
<a name="line-489"></a>use different info tables for static and dynamic constructors, we
<a name="line-490"></a>would have to switch the info pointer when copying the constructor
<a name="line-491"></a>into the compact region, which means we would need an extra field of
<a name="line-492"></a>the static info table to point to the dynamic one.
<a name="line-493"></a>
<a name="line-494"></a>However, since the distinction between static and dynamic closure
<a name="line-495"></a>types is never actually needed (other than for assertions), we can
<a name="line-496"></a>just drop the distinction and use the same info table for both.
<a name="line-497"></a>
<a name="line-498"></a>The GC *does* need to distinguish between static and dynamic closures,
<a name="line-499"></a>but it does this using the HEAP_ALLOCED() macro which checks whether
<a name="line-500"></a>the address of the closure resides within the dynamic heap.
<a name="line-501"></a>HEAP_ALLOCED() doesn't read the closure's info table.
<a name="line-502"></a>
<a name="line-503"></a>Note [Static NoCaf constructors]
<a name="line-504"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-505"></a>If we know that a top-level binding 'x' is not Caffy (ie no CAFs are
<a name="line-506"></a>reachable from 'x'), then a statically allocated constructor (Just x)
<a name="line-507"></a>is also not Caffy, and the garbage collector need not follow its
<a name="line-508"></a>argument fields.  Exploiting this would require two static info tables
<a name="line-509"></a>for Just, for the two cases where the argument was Caffy or non-Caffy.
<a name="line-510"></a>
<a name="line-511"></a>Currently we don't do this; instead we treat nullary constructors
<a name="line-512"></a>as non-Caffy, and the others as potentially Caffy.
<a name="line-513"></a>
<a name="line-514"></a>
<a name="line-515"></a>************************************************************************
<a name="line-516"></a>*                                                                      *
<a name="line-517"></a>             Pretty printing of SMRep and friends
<a name="line-518"></a>*                                                                      *
<a name="line-519"></a>************************************************************************
<a name="line-520"></a>-}</span>
<a name="line-521"></a>
<a name="line-522"></a><a name="instance%20Outputable%20ClosureTypeInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ClosureTypeInfo</span> <span class='hs-keyword'>where</span>
<a name="line-523"></a>   <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTypeInfo</span>
<a name="line-524"></a>
<a name="line-525"></a><a name="instance%20Outputable%20SMRep"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyword'>where</span>
<a name="line-526"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-varid'>static</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>nps</span> <span class='hs-varid'>tyinfo</span><span class='hs-layout'>)</span>
<a name="line-527"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>header</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>lbrace</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyinfo</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>rbrace</span><span class='hs-layout'>)</span>
<a name="line-528"></a>     <span class='hs-keyword'>where</span>
<a name="line-529"></a>       <span class='hs-varid'>header</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"HeapRep"</span>
<a name="line-530"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>static</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"static"</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span>
<a name="line-531"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_n</span> <span class='hs-str'>"ptrs"</span> <span class='hs-varid'>ps</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_n</span> <span class='hs-str'>"nonptrs"</span> <span class='hs-varid'>nps</span>
<a name="line-532"></a>       <span class='hs-varid'>pp_n</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-533"></a>       <span class='hs-varid'>pp_n</span> <span class='hs-keyword'>_</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-534"></a>       <span class='hs-varid'>pp_n</span> <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>s</span>
<a name="line-535"></a>
<a name="line-536"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrayPtrsRep</span> <span class='hs-varid'>size</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ArrayPtrsRep"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>size</span>
<a name="line-537"></a>
<a name="line-538"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SmallArrayPtrsRep</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"SmallArrayPtrsRep"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>size</span>
<a name="line-539"></a>
<a name="line-540"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrayWordsRep</span> <span class='hs-varid'>words</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ArrayWordsRep"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>words</span>
<a name="line-541"></a>
<a name="line-542"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackRep</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"StackRep"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bs</span>
<a name="line-543"></a>
<a name="line-544"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RTSRep</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tag:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rep</span>
<a name="line-545"></a>
<a name="line-546"></a><a name="instance%20Outputable%20ArgDescr"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ArgDescr</span> <span class='hs-keyword'>where</span>
<a name="line-547"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArgSpec</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ArgSpec"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>
<a name="line-548"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArgGen</span> <span class='hs-varid'>ls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ArgGen"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ls</span>
<a name="line-549"></a>
<a name="line-550"></a><a name="pprTypeInfo"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureTypeInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-551"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Constr</span> <span class='hs-varid'>tag</span> <span class='hs-varid'>descr</span><span class='hs-layout'>)</span>
<a name="line-552"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Con"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-553"></a>    <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tag:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tag</span>
<a name="line-554"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"descr:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>descr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-555"></a>
<a name="line-556"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fun</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-557"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Fun"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-558"></a>    <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"arity:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arity</span>
<a name="line-559"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-layout'>(</span><span class='hs-str'>"fun_type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-560"></a>
<a name="line-561"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThunkSelector</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span>
<a name="line-562"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ThunkSel"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>offset</span>
<a name="line-563"></a>
<a name="line-564"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-conid'>Thunk</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Thunk"</span>
<a name="line-565"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-conid'>BlackHole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"BlackHole"</span>
<a name="line-566"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-conid'>IndStatic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"IndStatic"</span>
<a name="line-567"></a>
<a name="line-568"></a><a name="stringToWord8s"></a><span class='hs-comment'>-- XXX Does not belong here!!</span>
<a name="line-569"></a><span class='hs-definition'>stringToWord8s</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span>
<a name="line-570"></a><span class='hs-definition'>stringToWord8s</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ord</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-571"></a>
<a name="line-572"></a><a name="pprWord8String"></a><span class='hs-definition'>pprWord8String</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-573"></a><span class='hs-comment'>-- Debug printing.  Not very clever right now.</span>
<a name="line-574"></a><span class='hs-definition'>pprWord8String</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span>
</pre></body>
</html>
