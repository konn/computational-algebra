<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>main/GHC.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP, NondecreasingIndentation, ScopedTypeVariables,
<a name="line-2"></a>             NamedFieldPuns, TupleSections #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- (c) The University of Glasgow, 2005-2012</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- The GHC API</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC</span> <span class='hs-layout'>(</span>
<a name="line-13"></a>        <span class='hs-comment'>-- * Initialisation</span>
<a name="line-14"></a>        <span class='hs-varid'>defaultErrorHandler</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>defaultCleanupHandler</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>prettyPrintGhcErrors</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>withSignalHandlers</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>withCleanupSession</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>        <span class='hs-comment'>-- * GHC Monad</span>
<a name="line-21"></a>        <span class='hs-conid'>Ghc</span><span class='hs-layout'>,</span> <span class='hs-conid'>GhcT</span><span class='hs-layout'>,</span> <span class='hs-conid'>GhcMonad</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>HscEnv</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>runGhc</span><span class='hs-layout'>,</span> <span class='hs-varid'>runGhcT</span><span class='hs-layout'>,</span> <span class='hs-varid'>initGhcMonad</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>gcatch</span><span class='hs-layout'>,</span> <span class='hs-varid'>gbracket</span><span class='hs-layout'>,</span> <span class='hs-varid'>gfinally</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>printException</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>handleSourceError</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>needsTemplateHaskell</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-comment'>-- * Flags and settings</span>
<a name="line-29"></a>        <span class='hs-conid'>DynFlags</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>GeneralFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Severity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>HscTarget</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>gopt</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-conid'>GhcMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>GhcLink</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>defaultObjectTarget</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>parseDynamicFlags</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>getSessionDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>setSessionDynFlags</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>getProgramDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>setProgramDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>setLogAction</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>getInteractiveDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInteractiveDynFlags</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-comment'>-- * Targets</span>
<a name="line-37"></a>        <span class='hs-conid'>Target</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TargetId</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Phase</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>setTargets</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>getTargets</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>addTarget</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>removeTarget</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>guessTarget</span><span class='hs-layout'>,</span>
<a name="line-43"></a>
<a name="line-44"></a>        <span class='hs-comment'>-- * Loading\/compiling the program</span>
<a name="line-45"></a>        <span class='hs-varid'>depanal</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-varid'>load</span><span class='hs-layout'>,</span> <span class='hs-conid'>LoadHowMuch</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>InteractiveImport</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-47"></a>        <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>succeeded</span><span class='hs-layout'>,</span> <span class='hs-varid'>failed</span><span class='hs-layout'>,</span>
<a name="line-48"></a>        <span class='hs-varid'>defaultWarnErrLogger</span><span class='hs-layout'>,</span> <span class='hs-conid'>WarnErrLogger</span><span class='hs-layout'>,</span>
<a name="line-49"></a>        <span class='hs-varid'>workingDirectoryChanged</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>parseModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>typecheckModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>desugarModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadModule</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-conid'>ParsedModule</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypecheckedModule</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>DesugaredModule</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-conid'>TypecheckedSource</span><span class='hs-layout'>,</span> <span class='hs-conid'>ParsedSource</span><span class='hs-layout'>,</span> <span class='hs-conid'>RenamedSource</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ditto</span>
<a name="line-53"></a>        <span class='hs-conid'>TypecheckedMod</span><span class='hs-layout'>,</span> <span class='hs-conid'>ParsedMod</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-varid'>moduleInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>renamedSource</span><span class='hs-layout'>,</span> <span class='hs-varid'>typecheckedSource</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>parsedSource</span><span class='hs-layout'>,</span> <span class='hs-varid'>coreModule</span><span class='hs-layout'>,</span>
<a name="line-56"></a>
<a name="line-57"></a>        <span class='hs-comment'>-- ** Compiling to Core</span>
<a name="line-58"></a>        <span class='hs-conid'>CoreModule</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>compileToCoreModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>compileToCoreSimplified</span><span class='hs-layout'>,</span>
<a name="line-60"></a>
<a name="line-61"></a>        <span class='hs-comment'>-- * Inspecting the module structure of the program</span>
<a name="line-62"></a>        <span class='hs-conid'>ModuleGraph</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModSummary</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_mod_name</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModLocation</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-63"></a>        <span class='hs-varid'>getModSummary</span><span class='hs-layout'>,</span>
<a name="line-64"></a>        <span class='hs-varid'>getModuleGraph</span><span class='hs-layout'>,</span>
<a name="line-65"></a>        <span class='hs-varid'>isLoaded</span><span class='hs-layout'>,</span>
<a name="line-66"></a>        <span class='hs-varid'>topSortModuleGraph</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-comment'>-- * Inspecting modules</span>
<a name="line-69"></a>        <span class='hs-conid'>ModuleInfo</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-varid'>getModuleInfo</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>modInfoTyThings</span><span class='hs-layout'>,</span>
<a name="line-72"></a>        <span class='hs-varid'>modInfoTopLevelScope</span><span class='hs-layout'>,</span>
<a name="line-73"></a>        <span class='hs-varid'>modInfoExports</span><span class='hs-layout'>,</span>
<a name="line-74"></a>        <span class='hs-varid'>modInfoExportsWithSelectors</span><span class='hs-layout'>,</span>
<a name="line-75"></a>        <span class='hs-varid'>modInfoInstances</span><span class='hs-layout'>,</span>
<a name="line-76"></a>        <span class='hs-varid'>modInfoIsExportedName</span><span class='hs-layout'>,</span>
<a name="line-77"></a>        <span class='hs-varid'>modInfoLookupName</span><span class='hs-layout'>,</span>
<a name="line-78"></a>        <span class='hs-varid'>modInfoIface</span><span class='hs-layout'>,</span>
<a name="line-79"></a>        <span class='hs-varid'>modInfoSafe</span><span class='hs-layout'>,</span>
<a name="line-80"></a>        <span class='hs-varid'>lookupGlobalName</span><span class='hs-layout'>,</span>
<a name="line-81"></a>        <span class='hs-varid'>findGlobalAnns</span><span class='hs-layout'>,</span>
<a name="line-82"></a>        <span class='hs-varid'>mkPrintUnqualifiedForModule</span><span class='hs-layout'>,</span>
<a name="line-83"></a>        <span class='hs-conid'>ModIface</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-84"></a>        <span class='hs-conid'>SafeHaskellMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-85"></a>
<a name="line-86"></a>        <span class='hs-comment'>-- * Querying the environment</span>
<a name="line-87"></a>        <span class='hs-comment'>-- packageDbModules,</span>
<a name="line-88"></a>
<a name="line-89"></a>        <span class='hs-comment'>-- * Printing</span>
<a name="line-90"></a>        <span class='hs-conid'>PrintUnqualified</span><span class='hs-layout'>,</span> <span class='hs-varid'>alwaysQualify</span><span class='hs-layout'>,</span>
<a name="line-91"></a>
<a name="line-92"></a>        <span class='hs-comment'>-- * Interactive evaluation</span>
<a name="line-93"></a>
<a name="line-94"></a>        <span class='hs-comment'>-- ** Executing statements</span>
<a name="line-95"></a>        <span class='hs-varid'>execStmt</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExecOptions</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>execOptions</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExecResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-96"></a>        <span class='hs-varid'>resumeExec</span><span class='hs-layout'>,</span>
<a name="line-97"></a>
<a name="line-98"></a>        <span class='hs-comment'>-- ** Adding new declarations</span>
<a name="line-99"></a>        <span class='hs-varid'>runDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>runDeclsWithLocation</span><span class='hs-layout'>,</span>
<a name="line-100"></a>
<a name="line-101"></a>        <span class='hs-comment'>-- ** Get/set the current context</span>
<a name="line-102"></a>        <span class='hs-varid'>parseImportDecl</span><span class='hs-layout'>,</span>
<a name="line-103"></a>        <span class='hs-varid'>setContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>getContext</span><span class='hs-layout'>,</span>
<a name="line-104"></a>        <span class='hs-varid'>setGHCiMonad</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGHCiMonad</span><span class='hs-layout'>,</span>
<a name="line-105"></a>
<a name="line-106"></a>        <span class='hs-comment'>-- ** Inspecting the current context</span>
<a name="line-107"></a>        <span class='hs-varid'>getBindings</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInsts</span><span class='hs-layout'>,</span> <span class='hs-varid'>getPrintUnqual</span><span class='hs-layout'>,</span>
<a name="line-108"></a>        <span class='hs-varid'>findModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupModule</span><span class='hs-layout'>,</span>
<a name="line-109"></a>        <span class='hs-varid'>isModuleTrusted</span><span class='hs-layout'>,</span> <span class='hs-varid'>moduleTrustReqs</span><span class='hs-layout'>,</span>
<a name="line-110"></a>        <span class='hs-varid'>getNamesInScope</span><span class='hs-layout'>,</span>
<a name="line-111"></a>        <span class='hs-varid'>getRdrNamesInScope</span><span class='hs-layout'>,</span>
<a name="line-112"></a>        <span class='hs-varid'>getGRE</span><span class='hs-layout'>,</span>
<a name="line-113"></a>        <span class='hs-varid'>moduleIsInterpreted</span><span class='hs-layout'>,</span>
<a name="line-114"></a>        <span class='hs-varid'>getInfo</span><span class='hs-layout'>,</span>
<a name="line-115"></a>        <span class='hs-varid'>showModule</span><span class='hs-layout'>,</span>
<a name="line-116"></a>        <span class='hs-varid'>moduleIsBootOrNotObjectLinkable</span><span class='hs-layout'>,</span>
<a name="line-117"></a>        <span class='hs-varid'>getNameToInstancesIndex</span><span class='hs-layout'>,</span>
<a name="line-118"></a>
<a name="line-119"></a>        <span class='hs-comment'>-- ** Inspecting types and kinds</span>
<a name="line-120"></a>        <span class='hs-varid'>exprType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRnExprMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-121"></a>        <span class='hs-varid'>typeKind</span><span class='hs-layout'>,</span>
<a name="line-122"></a>
<a name="line-123"></a>        <span class='hs-comment'>-- ** Looking up a Name</span>
<a name="line-124"></a>        <span class='hs-varid'>parseName</span><span class='hs-layout'>,</span>
<a name="line-125"></a>        <span class='hs-varid'>lookupName</span><span class='hs-layout'>,</span>
<a name="line-126"></a>
<a name="line-127"></a>        <span class='hs-comment'>-- ** Compiling expressions</span>
<a name="line-128"></a>        <span class='hs-conid'>HValue</span><span class='hs-layout'>,</span> <span class='hs-varid'>parseExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>compileParsedExpr</span><span class='hs-layout'>,</span>
<a name="line-129"></a>        <span class='hs-conid'>InteractiveEval</span><span class='hs-varop'>.</span><span class='hs-varid'>compileExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>dynCompileExpr</span><span class='hs-layout'>,</span>
<a name="line-130"></a>        <span class='hs-conid'>ForeignHValue</span><span class='hs-layout'>,</span>
<a name="line-131"></a>        <span class='hs-varid'>compileExprRemote</span><span class='hs-layout'>,</span> <span class='hs-varid'>compileParsedExprRemote</span><span class='hs-layout'>,</span>
<a name="line-132"></a>
<a name="line-133"></a>        <span class='hs-comment'>-- ** Other</span>
<a name="line-134"></a>        <span class='hs-varid'>runTcInteractive</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Desired by some clients (Trac #8878)</span>
<a name="line-135"></a>        <span class='hs-varid'>isStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasImport</span><span class='hs-layout'>,</span> <span class='hs-varid'>isImport</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDecl</span><span class='hs-layout'>,</span>
<a name="line-136"></a>
<a name="line-137"></a>        <span class='hs-comment'>-- ** The debugger</span>
<a name="line-138"></a>        <span class='hs-conid'>SingleStep</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-139"></a>        <span class='hs-conid'>Resume</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-140"></a>        <span class='hs-conid'>History</span><span class='hs-layout'>(</span><span class='hs-varid'>historyBreakInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>historyEnclosingDecls</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-141"></a>        <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-varid'>getHistorySpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>getHistoryModule</span><span class='hs-layout'>,</span>
<a name="line-142"></a>        <span class='hs-varid'>abandon</span><span class='hs-layout'>,</span> <span class='hs-varid'>abandonAll</span><span class='hs-layout'>,</span>
<a name="line-143"></a>        <span class='hs-varid'>getResumeContext</span><span class='hs-layout'>,</span>
<a name="line-144"></a>        <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-varid'>obtainTermFromId</span><span class='hs-layout'>,</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-varid'>obtainTermFromVal</span><span class='hs-layout'>,</span> <span class='hs-varid'>reconstructType</span><span class='hs-layout'>,</span>
<a name="line-145"></a>        <span class='hs-varid'>modInfoModBreaks</span><span class='hs-layout'>,</span>
<a name="line-146"></a>        <span class='hs-conid'>ModBreaks</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>BreakIndex</span><span class='hs-layout'>,</span>
<a name="line-147"></a>        <span class='hs-conid'>BreakInfo</span><span class='hs-layout'>(</span><span class='hs-varid'>breakInfo_number</span><span class='hs-layout'>,</span> <span class='hs-varid'>breakInfo_module</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-148"></a>        <span class='hs-conid'>InteractiveEval</span><span class='hs-varop'>.</span><span class='hs-varid'>back</span><span class='hs-layout'>,</span>
<a name="line-149"></a>        <span class='hs-conid'>InteractiveEval</span><span class='hs-varop'>.</span><span class='hs-varid'>forward</span><span class='hs-layout'>,</span>
<a name="line-150"></a>
<a name="line-151"></a>        <span class='hs-comment'>-- * Abstract syntax elements</span>
<a name="line-152"></a>
<a name="line-153"></a>        <span class='hs-comment'>-- ** Packages</span>
<a name="line-154"></a>        <span class='hs-conid'>UnitId</span><span class='hs-layout'>,</span>
<a name="line-155"></a>
<a name="line-156"></a>        <span class='hs-comment'>-- ** Modules</span>
<a name="line-157"></a>        <span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>moduleName</span><span class='hs-layout'>,</span> <span class='hs-varid'>moduleUnitId</span><span class='hs-layout'>,</span>
<a name="line-158"></a>        <span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkModuleName</span><span class='hs-layout'>,</span> <span class='hs-varid'>moduleNameString</span><span class='hs-layout'>,</span>
<a name="line-159"></a>
<a name="line-160"></a>        <span class='hs-comment'>-- ** Names</span>
<a name="line-161"></a>        <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>
<a name="line-162"></a>        <span class='hs-varid'>isExternalName</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParenSymName</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameSrcSpan</span><span class='hs-layout'>,</span>
<a name="line-163"></a>        <span class='hs-conid'>NamedThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-164"></a>        <span class='hs-conid'>RdrName</span><span class='hs-layout'>(</span><span class='hs-conid'>Qual</span><span class='hs-layout'>,</span><span class='hs-conid'>Unqual</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-165"></a>
<a name="line-166"></a>        <span class='hs-comment'>-- ** Identifiers</span>
<a name="line-167"></a>        <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-varid'>idType</span><span class='hs-layout'>,</span>
<a name="line-168"></a>        <span class='hs-varid'>isImplicitId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDeadBinder</span><span class='hs-layout'>,</span>
<a name="line-169"></a>        <span class='hs-varid'>isExportedId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isLocalId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGlobalId</span><span class='hs-layout'>,</span>
<a name="line-170"></a>        <span class='hs-varid'>isRecordSelector</span><span class='hs-layout'>,</span>
<a name="line-171"></a>        <span class='hs-varid'>isPrimOpId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFCallId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isClassOpId_maybe</span><span class='hs-layout'>,</span>
<a name="line-172"></a>        <span class='hs-varid'>isDataConWorkId</span><span class='hs-layout'>,</span> <span class='hs-varid'>idDataCon</span><span class='hs-layout'>,</span>
<a name="line-173"></a>        <span class='hs-varid'>isBottomingId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDictonaryId</span><span class='hs-layout'>,</span>
<a name="line-174"></a>        <span class='hs-varid'>recordSelectorTyCon</span><span class='hs-layout'>,</span>
<a name="line-175"></a>
<a name="line-176"></a>        <span class='hs-comment'>-- ** Type constructors</span>
<a name="line-177"></a>        <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span>
<a name="line-178"></a>        <span class='hs-varid'>tyConTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConDataCons</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConArity</span><span class='hs-layout'>,</span>
<a name="line-179"></a>        <span class='hs-varid'>isClassTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTypeSynonymTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTypeFamilyTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNewTyCon</span><span class='hs-layout'>,</span>
<a name="line-180"></a>        <span class='hs-varid'>isPrimTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFunTyCon</span><span class='hs-layout'>,</span>
<a name="line-181"></a>        <span class='hs-varid'>isFamilyTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isOpenFamilyTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isOpenTypeFamilyTyCon</span><span class='hs-layout'>,</span>
<a name="line-182"></a>        <span class='hs-varid'>tyConClass_maybe</span><span class='hs-layout'>,</span>
<a name="line-183"></a>        <span class='hs-varid'>synTyConRhs_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>synTyConDefn_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span><span class='hs-layout'>,</span>
<a name="line-184"></a>
<a name="line-185"></a>        <span class='hs-comment'>-- ** Type variables</span>
<a name="line-186"></a>        <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span>
<a name="line-187"></a>        <span class='hs-varid'>alphaTyVars</span><span class='hs-layout'>,</span>
<a name="line-188"></a>
<a name="line-189"></a>        <span class='hs-comment'>-- ** Data constructors</span>
<a name="line-190"></a>        <span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span>
<a name="line-191"></a>        <span class='hs-varid'>dataConSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConType</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConFieldLabels</span><span class='hs-layout'>,</span>
<a name="line-192"></a>        <span class='hs-varid'>dataConIsInfix</span><span class='hs-layout'>,</span> <span class='hs-varid'>isVanillaDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConUserType</span><span class='hs-layout'>,</span>
<a name="line-193"></a>        <span class='hs-varid'>dataConSrcBangs</span><span class='hs-layout'>,</span>
<a name="line-194"></a>        <span class='hs-conid'>StrictnessMark</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMarkedStrict</span><span class='hs-layout'>,</span>
<a name="line-195"></a>
<a name="line-196"></a>        <span class='hs-comment'>-- ** Classes</span>
<a name="line-197"></a>        <span class='hs-conid'>Class</span><span class='hs-layout'>,</span>
<a name="line-198"></a>        <span class='hs-varid'>classMethods</span><span class='hs-layout'>,</span> <span class='hs-varid'>classSCTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>classTvsFds</span><span class='hs-layout'>,</span> <span class='hs-varid'>classATs</span><span class='hs-layout'>,</span>
<a name="line-199"></a>        <span class='hs-varid'>pprFundeps</span><span class='hs-layout'>,</span>
<a name="line-200"></a>
<a name="line-201"></a>        <span class='hs-comment'>-- ** Instances</span>
<a name="line-202"></a>        <span class='hs-conid'>ClsInst</span><span class='hs-layout'>,</span>
<a name="line-203"></a>        <span class='hs-varid'>instanceDFunId</span><span class='hs-layout'>,</span>
<a name="line-204"></a>        <span class='hs-varid'>pprInstance</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprInstanceHdr</span><span class='hs-layout'>,</span>
<a name="line-205"></a>        <span class='hs-varid'>pprFamInst</span><span class='hs-layout'>,</span>
<a name="line-206"></a>
<a name="line-207"></a>        <span class='hs-conid'>FamInst</span><span class='hs-layout'>,</span>
<a name="line-208"></a>
<a name="line-209"></a>        <span class='hs-comment'>-- ** Types and Kinds</span>
<a name="line-210"></a>        <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitForAllTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>funResultTy</span><span class='hs-layout'>,</span>
<a name="line-211"></a>        <span class='hs-varid'>pprParendType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTypeApp</span><span class='hs-layout'>,</span>
<a name="line-212"></a>        <span class='hs-conid'>Kind</span><span class='hs-layout'>,</span>
<a name="line-213"></a>        <span class='hs-conid'>PredType</span><span class='hs-layout'>,</span>
<a name="line-214"></a>        <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprForAll</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprThetaArrowTy</span><span class='hs-layout'>,</span>
<a name="line-215"></a>
<a name="line-216"></a>        <span class='hs-comment'>-- ** Entities</span>
<a name="line-217"></a>        <span class='hs-conid'>TyThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-218"></a>
<a name="line-219"></a>        <span class='hs-comment'>-- ** Syntax</span>
<a name="line-220"></a>        <span class='hs-keyword'>module</span> <span class='hs-conid'>HsSyn</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ToDo: remove extraneous bits</span>
<a name="line-221"></a>
<a name="line-222"></a>        <span class='hs-comment'>-- ** Fixities</span>
<a name="line-223"></a>        <span class='hs-conid'>FixityDirection</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-224"></a>        <span class='hs-varid'>defaultFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxPrecedence</span><span class='hs-layout'>,</span>
<a name="line-225"></a>        <span class='hs-varid'>negateFixity</span><span class='hs-layout'>,</span>
<a name="line-226"></a>        <span class='hs-varid'>compareFixity</span><span class='hs-layout'>,</span>
<a name="line-227"></a>        <span class='hs-conid'>LexicalFixity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-228"></a>
<a name="line-229"></a>        <span class='hs-comment'>-- ** Source locations</span>
<a name="line-230"></a>        <span class='hs-conid'>SrcLoc</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>RealSrcLoc</span><span class='hs-layout'>,</span>
<a name="line-231"></a>        <span class='hs-varid'>mkSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>noSrcLoc</span><span class='hs-layout'>,</span>
<a name="line-232"></a>        <span class='hs-varid'>srcLocFile</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcLocLine</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcLocCol</span><span class='hs-layout'>,</span>
<a name="line-233"></a>        <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>RealSrcSpan</span><span class='hs-layout'>,</span>
<a name="line-234"></a>        <span class='hs-varid'>mkSrcSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcLocSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGoodSrcSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>noSrcSpan</span><span class='hs-layout'>,</span>
<a name="line-235"></a>        <span class='hs-varid'>srcSpanStart</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanEnd</span><span class='hs-layout'>,</span>
<a name="line-236"></a>        <span class='hs-varid'>srcSpanFile</span><span class='hs-layout'>,</span>
<a name="line-237"></a>        <span class='hs-varid'>srcSpanStartLine</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanEndLine</span><span class='hs-layout'>,</span>
<a name="line-238"></a>        <span class='hs-varid'>srcSpanStartCol</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanEndCol</span><span class='hs-layout'>,</span>
<a name="line-239"></a>
<a name="line-240"></a>        <span class='hs-comment'>-- ** Located</span>
<a name="line-241"></a>        <span class='hs-conid'>GenLocated</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Located</span><span class='hs-layout'>,</span>
<a name="line-242"></a>
<a name="line-243"></a>        <span class='hs-comment'>-- *** Constructing Located</span>
<a name="line-244"></a>        <span class='hs-varid'>noLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGeneralLocated</span><span class='hs-layout'>,</span>
<a name="line-245"></a>
<a name="line-246"></a>        <span class='hs-comment'>-- *** Deconstructing Located</span>
<a name="line-247"></a>        <span class='hs-varid'>getLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>,</span>
<a name="line-248"></a>
<a name="line-249"></a>        <span class='hs-comment'>-- *** Combining and comparing Located values</span>
<a name="line-250"></a>        <span class='hs-varid'>eqLocated</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmpLocated</span><span class='hs-layout'>,</span> <span class='hs-varid'>combineLocs</span><span class='hs-layout'>,</span> <span class='hs-varid'>addCLoc</span><span class='hs-layout'>,</span>
<a name="line-251"></a>        <span class='hs-varid'>leftmost_smallest</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftmost_largest</span><span class='hs-layout'>,</span> <span class='hs-varid'>rightmost</span><span class='hs-layout'>,</span>
<a name="line-252"></a>        <span class='hs-varid'>spans</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSubspanOf</span><span class='hs-layout'>,</span>
<a name="line-253"></a>
<a name="line-254"></a>        <span class='hs-comment'>-- * Exceptions</span>
<a name="line-255"></a>        <span class='hs-conid'>GhcException</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>showGhcException</span><span class='hs-layout'>,</span>
<a name="line-256"></a>
<a name="line-257"></a>        <span class='hs-comment'>-- * Token stream manipulations</span>
<a name="line-258"></a>        <span class='hs-conid'>Token</span><span class='hs-layout'>,</span>
<a name="line-259"></a>        <span class='hs-varid'>getTokenStream</span><span class='hs-layout'>,</span> <span class='hs-varid'>getRichTokenStream</span><span class='hs-layout'>,</span>
<a name="line-260"></a>        <span class='hs-varid'>showRichTokenStream</span><span class='hs-layout'>,</span> <span class='hs-varid'>addSourceToTokens</span><span class='hs-layout'>,</span>
<a name="line-261"></a>
<a name="line-262"></a>        <span class='hs-comment'>-- * Pure interface to the parser</span>
<a name="line-263"></a>        <span class='hs-varid'>parser</span><span class='hs-layout'>,</span>
<a name="line-264"></a>
<a name="line-265"></a>        <span class='hs-comment'>-- * API Annotations</span>
<a name="line-266"></a>        <span class='hs-conid'>ApiAnns</span><span class='hs-layout'>,</span><span class='hs-conid'>AnnKeywordId</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-conid'>AnnotationComment</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-267"></a>        <span class='hs-varid'>getAnnotation</span><span class='hs-layout'>,</span> <span class='hs-varid'>getAndRemoveAnnotation</span><span class='hs-layout'>,</span>
<a name="line-268"></a>        <span class='hs-varid'>getAnnotationComments</span><span class='hs-layout'>,</span> <span class='hs-varid'>getAndRemoveAnnotationComments</span><span class='hs-layout'>,</span>
<a name="line-269"></a>        <span class='hs-varid'>unicodeAnn</span><span class='hs-layout'>,</span>
<a name="line-270"></a>
<a name="line-271"></a>        <span class='hs-comment'>-- * Miscellaneous</span>
<a name="line-272"></a>        <span class='hs-varop'>--sessionHscEnv,</span>
<a name="line-273"></a>        <span class='hs-varid'>cyclicModuleErr</span><span class='hs-layout'>,</span>
<a name="line-274"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-275"></a>
<a name="line-276"></a><span class='hs-comment'>{-
<a name="line-277"></a> ToDo:
<a name="line-278"></a>
<a name="line-279"></a>  * inline bits of HscMain here to simplify layering: hscTcExpr, hscStmt.
<a name="line-280"></a>-}</span>
<a name="line-281"></a>
<a name="line-282"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-283"></a>
<a name="line-284"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ByteCodeTypes</span>
<a name="line-285"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InteractiveEval</span>
<a name="line-286"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InteractiveEvalTypes</span>
<a name="line-287"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnDriver</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-layout'>)</span>
<a name="line-288"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi</span>
<a name="line-289"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi</span><span class='hs-varop'>.</span><span class='hs-conid'>RemoteTypes</span>
<a name="line-290"></a>
<a name="line-291"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprTyThing</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>pprFamInst</span> <span class='hs-layout'>)</span>
<a name="line-292"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscMain</span>
<a name="line-293"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GhcMake</span>
<a name="line-294"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DriverPipeline</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>compileOne'</span> <span class='hs-layout'>)</span>
<a name="line-295"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GhcMonad</span>
<a name="line-296"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>finalSafeMode</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixSafeInstances</span> <span class='hs-layout'>)</span>
<a name="line-297"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-298"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Packages</span>
<a name="line-299"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-300"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-301"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-302"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>     <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-varid'>typeKind</span> <span class='hs-layout'>)</span>
<a name="line-303"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>           <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-varid'>typeKind</span> <span class='hs-layout'>)</span>
<a name="line-304"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-305"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>alphaTyVars</span> <span class='hs-layout'>)</span>
<a name="line-306"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-307"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-308"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-309"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>             <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>)</span>
<a name="line-310"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-311"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-312"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-layout'>(</span> <span class='hs-conid'>FamInst</span> <span class='hs-layout'>)</span>
<a name="line-313"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-314"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-315"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TidyPgm</span>
<a name="line-316"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DriverPhases</span>     <span class='hs-layout'>(</span> <span class='hs-conid'>Phase</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isHaskellSrcFilename</span> <span class='hs-layout'>)</span>
<a name="line-317"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Finder</span>
<a name="line-318"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-319"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-320"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SysTools</span>
<a name="line-321"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-322"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-323"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-324"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-325"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>              <span class='hs-layout'>(</span> <span class='hs-varid'>listToBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>)</span>
<a name="line-326"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-327"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-328"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-329"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StringBuffer</span>
<a name="line-330"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-331"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-332"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>expectJust</span> <span class='hs-layout'>)</span>
<a name="line-333"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-334"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Parser</span>
<a name="line-335"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Lexer</span>
<a name="line-336"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ApiAnnotation</span>
<a name="line-337"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-338"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-339"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>orphNamesOfFamInst</span> <span class='hs-layout'>)</span>
<a name="line-340"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>famInstEnvElts</span> <span class='hs-layout'>)</span>
<a name="line-341"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnDriver</span>
<a name="line-342"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-343"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>
<a name="line-344"></a>
<a name="line-345"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Foldable</span>
<a name="line-346"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-347"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-layout'>)</span>
<a name="line-348"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Sequence</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Seq</span>
<a name="line-349"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Directory</span> <span class='hs-layout'>(</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-layout'>)</span>
<a name="line-350"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-351"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>find</span> <span class='hs-layout'>)</span>
<a name="line-352"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Time</span>
<a name="line-353"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-354"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Word</span>        <span class='hs-layout'>(</span> <span class='hs-conid'>Word8</span> <span class='hs-layout'>)</span>
<a name="line-355"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-356"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Exit</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>exitWith</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExitCode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-357"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Exception</span>
<a name="line-358"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-359"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span>
<a name="line-360"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>
<a name="line-361"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>init</span><span class='hs-layout'>)</span>
<a name="line-362"></a>
<a name="line-363"></a>
<a name="line-364"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-365"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-366"></a><span class='hs-comment'>--             Initialisation: exception handlers</span>
<a name="line-367"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-368"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-369"></a>
<a name="line-370"></a>
<a name="line-371"></a><a name="defaultErrorHandler"></a><span class='hs-comment'>-- | Install some default exception handlers and run the inner computation.</span>
<a name="line-372"></a><span class='hs-comment'>-- Unless you want to handle exceptions yourself, you should wrap this around</span>
<a name="line-373"></a><span class='hs-comment'>-- the top level of your program.  The default handlers output the error</span>
<a name="line-374"></a><span class='hs-comment'>-- message(s) to stderr and exit cleanly.</span>
<a name="line-375"></a><span class='hs-definition'>defaultErrorHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExceptionMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-376"></a>                    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FatalMessager</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FlushOut</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-377"></a><span class='hs-definition'>defaultErrorHandler</span> <span class='hs-varid'>fm</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlushOut</span> <span class='hs-varid'>flushOut</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner</span> <span class='hs-keyglyph'>=</span>
<a name="line-378"></a>  <span class='hs-comment'>-- top-level exception handler: any unrecognised exception is a compiler bug.</span>
<a name="line-379"></a>  <span class='hs-varid'>ghandle</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>exception</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-380"></a>           <span class='hs-varid'>flushOut</span>
<a name="line-381"></a>           <span class='hs-keyword'>case</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>exception</span> <span class='hs-keyword'>of</span>
<a name="line-382"></a>                <span class='hs-comment'>-- an IO exception probably isn't our fault, so don't panic</span>
<a name="line-383"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ioe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IOException</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-384"></a>                  <span class='hs-varid'>fatalErrorMsg''</span> <span class='hs-varid'>fm</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>ioe</span><span class='hs-layout'>)</span>
<a name="line-385"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>exception</span> <span class='hs-keyword'>of</span>
<a name="line-386"></a>                     <span class='hs-conid'>Just</span> <span class='hs-conid'>UserInterrupt</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-387"></a>                         <span class='hs-comment'>-- Important to let this one propagate out so our</span>
<a name="line-388"></a>                         <span class='hs-comment'>-- calling process knows we were interrupted by ^C</span>
<a name="line-389"></a>                         <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-conid'>UserInterrupt</span>
<a name="line-390"></a>                     <span class='hs-conid'>Just</span> <span class='hs-conid'>StackOverflow</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-391"></a>                         <span class='hs-varid'>fatalErrorMsg''</span> <span class='hs-varid'>fm</span> <span class='hs-str'>"stack overflow: use +RTS -K&lt;size&gt; to increase it"</span>
<a name="line-392"></a>                     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>exception</span> <span class='hs-keyword'>of</span>
<a name="line-393"></a>                          <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ex</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExitCode</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-varid'>ex</span>
<a name="line-394"></a>                          <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-395"></a>                              <span class='hs-varid'>fatalErrorMsg''</span> <span class='hs-varid'>fm</span>
<a name="line-396"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Panic</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>exception</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-397"></a>           <span class='hs-varid'>exitWith</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitFailure</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-398"></a>         <span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-399"></a>
<a name="line-400"></a>  <span class='hs-comment'>-- error messages propagated as exceptions</span>
<a name="line-401"></a>  <span class='hs-varid'>handleGhcException</span>
<a name="line-402"></a>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ge</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-403"></a>                <span class='hs-varid'>flushOut</span>
<a name="line-404"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>ge</span> <span class='hs-keyword'>of</span>
<a name="line-405"></a>                     <span class='hs-conid'>Signal</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>exitWith</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitFailure</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-406"></a>                     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fatalErrorMsg''</span> <span class='hs-varid'>fm</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>ge</span><span class='hs-layout'>)</span>
<a name="line-407"></a>                             <span class='hs-varid'>exitWith</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitFailure</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-408"></a>            <span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-409"></a>  <span class='hs-varid'>inner</span>
<a name="line-410"></a>
<a name="line-411"></a><a name="defaultCleanupHandler"></a><span class='hs-comment'>-- | This function is no longer necessary, cleanup is now done by</span>
<a name="line-412"></a><span class='hs-comment'>-- runGhc/runGhcT.</span>
<a name="line-413"></a><span class='hs-comment'>{-# DEPRECATED defaultCleanupHandler "Cleanup is now done by runGhc/runGhcT" #-}</span>
<a name="line-414"></a><span class='hs-definition'>defaultCleanupHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExceptionMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-415"></a><span class='hs-definition'>defaultCleanupHandler</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span>
<a name="line-416"></a> <span class='hs-keyword'>where</span> <span class='hs-sel'>_warning_suppression</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varop'>`gonException`</span> <span class='hs-varid'>undefined</span>
<a name="line-417"></a>
<a name="line-418"></a>
<a name="line-419"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-420"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-421"></a><span class='hs-comment'>--             The Ghc Monad</span>
<a name="line-422"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-423"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-424"></a>
<a name="line-425"></a><span class='hs-comment'>-- | Run function for the 'Ghc' monad.</span>
<a name="line-426"></a><span class='hs-comment'>--</span>
<a name="line-427"></a><span class='hs-comment'>-- It initialises the GHC session and warnings via 'initGhcMonad'.  Each call</span>
<a name="line-428"></a><span class='hs-comment'>-- to this function will create a new session which should not be shared among</span>
<a name="line-429"></a><span class='hs-comment'>-- several threads.</span>
<a name="line-430"></a><span class='hs-comment'>--</span>
<a name="line-431"></a><span class='hs-comment'>-- Any errors not handled inside the 'Ghc' action are propagated as IO</span>
<a name="line-432"></a><span class='hs-comment'>-- exceptions.</span>
<a name="line-433"></a>
<a name="line-434"></a><a name="runGhc"></a><span class='hs-definition'>runGhc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span>  <span class='hs-comment'>-- ^ See argument to 'initGhcMonad'.</span>
<a name="line-435"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ghc</span> <span class='hs-varid'>a</span>           <span class='hs-comment'>-- ^ The action to perform.</span>
<a name="line-436"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-437"></a><span class='hs-definition'>runGhc</span> <span class='hs-varid'>mb_top_dir</span> <span class='hs-varid'>ghc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-438"></a>  <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"empty session"</span><span class='hs-layout'>)</span>
<a name="line-439"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>session</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Session</span> <span class='hs-varid'>ref</span>
<a name="line-440"></a>  <span class='hs-varid'>flip</span> <span class='hs-varid'>unGhc</span> <span class='hs-varid'>session</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withSignalHandlers</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- catch ^C</span>
<a name="line-441"></a>    <span class='hs-varid'>initGhcMonad</span> <span class='hs-varid'>mb_top_dir</span>
<a name="line-442"></a>    <span class='hs-varid'>withCleanupSession</span> <span class='hs-varid'>ghc</span>
<a name="line-443"></a>
<a name="line-444"></a><span class='hs-comment'>-- | Run function for 'GhcT' monad transformer.</span>
<a name="line-445"></a><span class='hs-comment'>--</span>
<a name="line-446"></a><span class='hs-comment'>-- It initialises the GHC session and warnings via 'initGhcMonad'.  Each call</span>
<a name="line-447"></a><span class='hs-comment'>-- to this function will create a new session which should not be shared among</span>
<a name="line-448"></a><span class='hs-comment'>-- several threads.</span>
<a name="line-449"></a>
<a name="line-450"></a><a name="runGhcT"></a><span class='hs-definition'>runGhcT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExceptionMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-451"></a>           <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span>  <span class='hs-comment'>-- ^ See argument to 'initGhcMonad'.</span>
<a name="line-452"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GhcT</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>        <span class='hs-comment'>-- ^ The action to perform.</span>
<a name="line-453"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-454"></a><span class='hs-definition'>runGhcT</span> <span class='hs-varid'>mb_top_dir</span> <span class='hs-varid'>ghct</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-455"></a>  <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"empty session"</span><span class='hs-layout'>)</span>
<a name="line-456"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>session</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Session</span> <span class='hs-varid'>ref</span>
<a name="line-457"></a>  <span class='hs-varid'>flip</span> <span class='hs-varid'>unGhcT</span> <span class='hs-varid'>session</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withSignalHandlers</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- catch ^C</span>
<a name="line-458"></a>    <span class='hs-varid'>initGhcMonad</span> <span class='hs-varid'>mb_top_dir</span>
<a name="line-459"></a>    <span class='hs-varid'>withCleanupSession</span> <span class='hs-varid'>ghct</span>
<a name="line-460"></a>
<a name="line-461"></a><a name="withCleanupSession"></a><span class='hs-definition'>withCleanupSession</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-462"></a><span class='hs-definition'>withCleanupSession</span> <span class='hs-varid'>ghc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ghc</span> <span class='hs-varop'>`gfinally`</span> <span class='hs-varid'>cleanup</span>
<a name="line-463"></a>  <span class='hs-keyword'>where</span>
<a name="line-464"></a>   <span class='hs-varid'>cleanup</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-465"></a>      <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-466"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-467"></a>      <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-468"></a>          <span class='hs-varid'>cleanTempFiles</span> <span class='hs-varid'>dflags</span>
<a name="line-469"></a>          <span class='hs-varid'>cleanTempDirs</span> <span class='hs-varid'>dflags</span>
<a name="line-470"></a>          <span class='hs-varid'>stopIServ</span> <span class='hs-varid'>hsc_env</span> <span class='hs-comment'>-- shut down the IServ</span>
<a name="line-471"></a>          <span class='hs-varid'>log_finaliser</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span>
<a name="line-472"></a>          <span class='hs-comment'>--  exceptions will be blocked while we clean the temporary files,</span>
<a name="line-473"></a>          <span class='hs-comment'>-- so there shouldn't be any difficulty if we receive further</span>
<a name="line-474"></a>          <span class='hs-comment'>-- signals.</span>
<a name="line-475"></a>
<a name="line-476"></a><span class='hs-comment'>-- | Initialise a GHC session.</span>
<a name="line-477"></a><span class='hs-comment'>--</span>
<a name="line-478"></a><span class='hs-comment'>-- If you implement a custom 'GhcMonad' you must call this function in the</span>
<a name="line-479"></a><span class='hs-comment'>-- monad run function.  It will initialise the session variable and clear all</span>
<a name="line-480"></a><span class='hs-comment'>-- warnings.</span>
<a name="line-481"></a><span class='hs-comment'>--</span>
<a name="line-482"></a><span class='hs-comment'>-- The first argument should point to the directory where GHC's library files</span>
<a name="line-483"></a><span class='hs-comment'>-- reside.  More precisely, this should be the output of @ghc --print-libdir@</span>
<a name="line-484"></a><span class='hs-comment'>-- of the version of GHC the module using this API is compiled with.  For</span>
<a name="line-485"></a><span class='hs-comment'>-- portability, you should use the @ghc-paths@ package, available at</span>
<a name="line-486"></a><span class='hs-comment'>-- &lt;<a href="http://hackage.haskell.org/package/ghc-paths">http://hackage.haskell.org/package/ghc-paths</a>&gt;.</span>
<a name="line-487"></a>
<a name="line-488"></a><a name="initGhcMonad"></a><span class='hs-definition'>initGhcMonad</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-489"></a><span class='hs-definition'>initGhcMonad</span> <span class='hs-varid'>mb_top_dir</span>
<a name="line-490"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-491"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mySettings</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initSysTools</span> <span class='hs-varid'>mb_top_dir</span>
<a name="line-492"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initDynFlags</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultDynFlags</span> <span class='hs-varid'>mySettings</span><span class='hs-layout'>)</span>
<a name="line-493"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>checkBrokenTablesNextToCode</span> <span class='hs-varid'>dflags</span>
<a name="line-494"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>setUnsafeGlobalDynFlags</span> <span class='hs-varid'>dflags</span>
<a name="line-495"></a>                      <span class='hs-comment'>-- c.f. DynFlags.parseDynamicFlagsFull, which</span>
<a name="line-496"></a>                      <span class='hs-comment'>-- creates DynFlags and sets the UnsafeGlobalDynFlags</span>
<a name="line-497"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>newHscEnv</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>}</span>
<a name="line-498"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setSession</span> <span class='hs-varid'>env</span> <span class='hs-layout'>}</span>
<a name="line-499"></a>
<a name="line-500"></a><a name="checkBrokenTablesNextToCode"></a><span class='hs-comment'>-- | The binutils linker on ARM emits unnecessary R_ARM_COPY relocations which</span>
<a name="line-501"></a><span class='hs-comment'>-- breaks tables-next-to-code in dynamically linked modules. This</span>
<a name="line-502"></a><span class='hs-comment'>-- check should be more selective but there is currently no released</span>
<a name="line-503"></a><span class='hs-comment'>-- version where this bug is fixed.</span>
<a name="line-504"></a><span class='hs-comment'>-- See https://sourceware.org/bugzilla/show_bug.cgi?id=16177 and</span>
<a name="line-505"></a><span class='hs-comment'>-- https://ghc.haskell.org/trac/ghc/ticket/4210#comment:29</span>
<a name="line-506"></a><span class='hs-definition'>checkBrokenTablesNextToCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-507"></a><span class='hs-definition'>checkBrokenTablesNextToCode</span> <span class='hs-varid'>dflags</span>
<a name="line-508"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>broken</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkBrokenTablesNextToCode'</span> <span class='hs-varid'>dflags</span>
<a name="line-509"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>broken</span>
<a name="line-510"></a>         <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkApiErr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>invalidLdErr</span>
<a name="line-511"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"unsupported linker"</span>
<a name="line-512"></a>              <span class='hs-layout'>}</span>
<a name="line-513"></a>       <span class='hs-layout'>}</span>
<a name="line-514"></a>  <span class='hs-keyword'>where</span>
<a name="line-515"></a>    <span class='hs-varid'>invalidLdErr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Tables-next-to-code not supported on ARM"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-516"></a>                   <span class='hs-varid'>text</span> <span class='hs-str'>"when using binutils ld (please see:"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-517"></a>                   <span class='hs-varid'>text</span> <span class='hs-str'>"https://sourceware.org/bugzilla/show_bug.cgi?id=16177)"</span>
<a name="line-518"></a>
<a name="line-519"></a><a name="checkBrokenTablesNextToCode'"></a><span class='hs-definition'>checkBrokenTablesNextToCode'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Bool</span>
<a name="line-520"></a><span class='hs-definition'>checkBrokenTablesNextToCode'</span> <span class='hs-varid'>dflags</span>
<a name="line-521"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isARM</span> <span class='hs-varid'>arch</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-522"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayDyn</span> <span class='hs-varop'>`notElem`</span> <span class='hs-varid'>ways</span> <span class='hs-varid'>dflags</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-523"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tablesNextToCode</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-524"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-525"></a>    <span class='hs-varid'>linkerInfo</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getLinkerInfo</span> <span class='hs-varid'>dflags</span>
<a name="line-526"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>linkerInfo</span> <span class='hs-keyword'>of</span>
<a name="line-527"></a>      <span class='hs-conid'>GnuLD</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-528"></a>      <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-529"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-530"></a>        <span class='hs-varid'>arch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span>
<a name="line-531"></a>
<a name="line-532"></a>
<a name="line-533"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-534"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-535"></a><span class='hs-comment'>--             Flags &amp; settings</span>
<a name="line-536"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-537"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-538"></a>
<a name="line-539"></a><span class='hs-comment'>-- $DynFlags</span>
<a name="line-540"></a><span class='hs-comment'>--</span>
<a name="line-541"></a><span class='hs-comment'>-- The GHC session maintains two sets of 'DynFlags':</span>
<a name="line-542"></a><span class='hs-comment'>--</span>
<a name="line-543"></a><span class='hs-comment'>--   * The "interactive" @DynFlags@, which are used for everything</span>
<a name="line-544"></a><span class='hs-comment'>--     related to interactive evaluation, including 'runStmt',</span>
<a name="line-545"></a><span class='hs-comment'>--     'runDecls', 'exprType', 'lookupName' and so on (everything</span>
<a name="line-546"></a><span class='hs-comment'>--     under \"Interactive evaluation\" in this module).</span>
<a name="line-547"></a><span class='hs-comment'>--</span>
<a name="line-548"></a><span class='hs-comment'>--   * The "program" @DynFlags@, which are used when loading</span>
<a name="line-549"></a><span class='hs-comment'>--     whole modules with 'load'</span>
<a name="line-550"></a><span class='hs-comment'>--</span>
<a name="line-551"></a><span class='hs-comment'>-- 'setInteractiveDynFlags', 'getInteractiveDynFlags' work with the</span>
<a name="line-552"></a><span class='hs-comment'>-- interactive @DynFlags@.</span>
<a name="line-553"></a><span class='hs-comment'>--</span>
<a name="line-554"></a><span class='hs-comment'>-- 'setProgramDynFlags', 'getProgramDynFlags' work with the</span>
<a name="line-555"></a><span class='hs-comment'>-- program @DynFlags@.</span>
<a name="line-556"></a><span class='hs-comment'>--</span>
<a name="line-557"></a><span class='hs-comment'>-- 'setSessionDynFlags' sets both @DynFlags@, and 'getSessionDynFlags'</span>
<a name="line-558"></a><span class='hs-comment'>-- retrieves the program @DynFlags@ (for backwards compatibility).</span>
<a name="line-559"></a>
<a name="line-560"></a>
<a name="line-561"></a><a name="setSessionDynFlags"></a><span class='hs-comment'>-- | Updates both the interactive and program DynFlags in a Session.</span>
<a name="line-562"></a><span class='hs-comment'>-- This also reads the package database (unless it has already been</span>
<a name="line-563"></a><span class='hs-comment'>-- read), and prepares the compilers knowledge about packages.  It can</span>
<a name="line-564"></a><span class='hs-comment'>-- be called again to load new packages: just add new package flags to</span>
<a name="line-565"></a><span class='hs-comment'>-- (packageFlags dflags).</span>
<a name="line-566"></a><span class='hs-comment'>--</span>
<a name="line-567"></a><span class='hs-comment'>-- Returns a list of new packages that may need to be linked in using</span>
<a name="line-568"></a><span class='hs-comment'>-- the dynamic linker (see 'linkPackages') as a result of new package</span>
<a name="line-569"></a><span class='hs-comment'>-- flags.  If you are not doing linking or doing static linking, you</span>
<a name="line-570"></a><span class='hs-comment'>-- can ignore the list of packages returned.</span>
<a name="line-571"></a><span class='hs-comment'>--</span>
<a name="line-572"></a><span class='hs-definition'>setSessionDynFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstalledUnitId</span><span class='hs-keyglyph'>]</span>
<a name="line-573"></a><span class='hs-definition'>setSessionDynFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-574"></a>  <span class='hs-varid'>dflags'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNewDynFlags</span> <span class='hs-varid'>dflags</span>
<a name="line-575"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>dflags''</span><span class='hs-layout'>,</span> <span class='hs-varid'>preload</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>initPackages</span> <span class='hs-varid'>dflags'</span>
<a name="line-576"></a>  <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags''</span>
<a name="line-577"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span><span class='hs-layout'>{</span> <span class='hs-varid'>ic_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags''</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-578"></a>  <span class='hs-varid'>invalidateModSummaryCache</span>
<a name="line-579"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>preload</span>
<a name="line-580"></a>
<a name="line-581"></a><a name="setProgramDynFlags"></a><span class='hs-comment'>-- | Sets the program 'DynFlags'.  Note: this invalidates the internal</span>
<a name="line-582"></a><span class='hs-comment'>-- cached module graph, causing more work to be done the next time</span>
<a name="line-583"></a><span class='hs-comment'>-- 'load' is called.</span>
<a name="line-584"></a><span class='hs-definition'>setProgramDynFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstalledUnitId</span><span class='hs-keyglyph'>]</span>
<a name="line-585"></a><span class='hs-definition'>setProgramDynFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setProgramDynFlags_</span> <span class='hs-conid'>True</span> <span class='hs-varid'>dflags</span>
<a name="line-586"></a>
<a name="line-587"></a><a name="setLogAction"></a><span class='hs-comment'>-- | Set the action taken when the compiler produces a message.  This</span>
<a name="line-588"></a><span class='hs-comment'>-- can also be accomplished using 'setProgramDynFlags', but using</span>
<a name="line-589"></a><span class='hs-comment'>-- 'setLogAction' avoids invalidating the cached module graph.</span>
<a name="line-590"></a><span class='hs-definition'>setLogAction</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>LogAction</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LogFinaliser</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-591"></a><span class='hs-definition'>setLogAction</span> <span class='hs-varid'>action</span> <span class='hs-varid'>finaliser</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-592"></a>  <span class='hs-varid'>dflags'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProgramDynFlags</span>
<a name="line-593"></a>  <span class='hs-varid'>void</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setProgramDynFlags_</span> <span class='hs-conid'>False</span> <span class='hs-varop'>$</span>
<a name="line-594"></a>    <span class='hs-varid'>dflags'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>log_action</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>action</span>
<a name="line-595"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>log_finaliser</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finaliser</span> <span class='hs-layout'>}</span>
<a name="line-596"></a>
<a name="line-597"></a><a name="setProgramDynFlags_"></a><span class='hs-definition'>setProgramDynFlags_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstalledUnitId</span><span class='hs-keyglyph'>]</span>
<a name="line-598"></a><span class='hs-definition'>setProgramDynFlags_</span> <span class='hs-varid'>invalidate_needed</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-599"></a>  <span class='hs-varid'>dflags'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNewDynFlags</span> <span class='hs-varid'>dflags</span>
<a name="line-600"></a>  <span class='hs-varid'>dflags_prev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProgramDynFlags</span>
<a name="line-601"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>dflags''</span><span class='hs-layout'>,</span> <span class='hs-varid'>preload</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-602"></a>    <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>packageFlagsChanged</span> <span class='hs-varid'>dflags_prev</span> <span class='hs-varid'>dflags'</span><span class='hs-layout'>)</span>
<a name="line-603"></a>       <span class='hs-keyword'>then</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>initPackages</span> <span class='hs-varid'>dflags'</span>
<a name="line-604"></a>       <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>dflags'</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-605"></a>  <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags''</span> <span class='hs-layout'>}</span>
<a name="line-606"></a>  <span class='hs-varid'>when</span> <span class='hs-varid'>invalidate_needed</span> <span class='hs-varop'>$</span> <span class='hs-varid'>invalidateModSummaryCache</span>
<a name="line-607"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>preload</span>
<a name="line-608"></a>
<a name="line-609"></a>
<a name="line-610"></a><a name="invalidateModSummaryCache"></a><span class='hs-comment'>-- When changing the DynFlags, we want the changes to apply to future</span>
<a name="line-611"></a><span class='hs-comment'>-- loads, but without completely discarding the program.  But the</span>
<a name="line-612"></a><span class='hs-comment'>-- DynFlags are cached in each ModSummary in the hsc_mod_graph, so</span>
<a name="line-613"></a><span class='hs-comment'>-- after a change to DynFlags, the changes would apply to new modules</span>
<a name="line-614"></a><span class='hs-comment'>-- but not existing modules; this seems undesirable.</span>
<a name="line-615"></a><span class='hs-comment'>--</span>
<a name="line-616"></a><span class='hs-comment'>-- Furthermore, the GHC API client might expect that changing</span>
<a name="line-617"></a><span class='hs-comment'>-- log_action would affect future compilation messages, but for those</span>
<a name="line-618"></a><span class='hs-comment'>-- modules we have cached ModSummaries for, we'll continue to use the</span>
<a name="line-619"></a><span class='hs-comment'>-- old log_action.  This is definitely wrong (#7478).</span>
<a name="line-620"></a><span class='hs-comment'>--</span>
<a name="line-621"></a><span class='hs-comment'>-- Hence, we invalidate the ModSummary cache after changing the</span>
<a name="line-622"></a><span class='hs-comment'>-- DynFlags.  We do this by tweaking the date on each ModSummary, so</span>
<a name="line-623"></a><span class='hs-comment'>-- that the next downsweep will think that all the files have changed</span>
<a name="line-624"></a><span class='hs-comment'>-- and preprocess them again.  This won't necessarily cause everything</span>
<a name="line-625"></a><span class='hs-comment'>-- to be recompiled, because by the time we check whether we need to</span>
<a name="line-626"></a><span class='hs-comment'>-- recopmile a module, we'll have re-summarised the module and have a</span>
<a name="line-627"></a><span class='hs-comment'>-- correct ModSummary.</span>
<a name="line-628"></a><span class='hs-comment'>--</span>
<a name="line-629"></a><span class='hs-definition'>invalidateModSummaryCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-630"></a><span class='hs-definition'>invalidateModSummaryCache</span> <span class='hs-keyglyph'>=</span>
<a name="line-631"></a>  <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>inval</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_mod_graph</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-632"></a> <span class='hs-keyword'>where</span>
<a name="line-633"></a>  <span class='hs-varid'>inval</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ms_hs_date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addUTCTime</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_hs_date</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-634"></a>
<a name="line-635"></a><a name="getProgramDynFlags"></a><span class='hs-comment'>-- | Returns the program 'DynFlags'.</span>
<a name="line-636"></a><span class='hs-definition'>getProgramDynFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>DynFlags</span>
<a name="line-637"></a><span class='hs-definition'>getProgramDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSessionDynFlags</span>
<a name="line-638"></a>
<a name="line-639"></a><a name="setInteractiveDynFlags"></a><span class='hs-comment'>-- | Set the 'DynFlags' used to evaluate interactive expressions.</span>
<a name="line-640"></a><span class='hs-comment'>-- Note: this cannot be used for changes to packages.  Use</span>
<a name="line-641"></a><span class='hs-comment'>-- 'setSessionDynFlags', or 'setProgramDynFlags' and then copy the</span>
<a name="line-642"></a><span class='hs-comment'>-- 'pkgState' into the interactive @DynFlags@.</span>
<a name="line-643"></a><span class='hs-definition'>setInteractiveDynFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-644"></a><span class='hs-definition'>setInteractiveDynFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-645"></a>  <span class='hs-varid'>dflags'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNewDynFlags</span> <span class='hs-varid'>dflags</span>
<a name="line-646"></a>  <span class='hs-varid'>dflags''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNewInteractiveDynFlags</span> <span class='hs-varid'>dflags'</span>
<a name="line-647"></a>  <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags''</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-648"></a>
<a name="line-649"></a><a name="getInteractiveDynFlags"></a><span class='hs-comment'>-- | Get the 'DynFlags' used to evaluate interactive expressions.</span>
<a name="line-650"></a><span class='hs-definition'>getInteractiveDynFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>DynFlags</span>
<a name="line-651"></a><span class='hs-definition'>getInteractiveDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-652"></a>
<a name="line-653"></a>
<a name="line-654"></a><a name="parseDynamicFlags"></a><span class='hs-definition'>parseDynamicFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-655"></a>                     <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-656"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-657"></a><span class='hs-definition'>parseDynamicFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseDynamicFlagsCmdLine</span>
<a name="line-658"></a>
<a name="line-659"></a><a name="checkNewDynFlags"></a><span class='hs-comment'>-- | Checks the set of new DynFlags for possibly erroneous option</span>
<a name="line-660"></a><span class='hs-comment'>-- combinations when invoking 'setSessionDynFlags' and friends, and if</span>
<a name="line-661"></a><span class='hs-comment'>-- found, returns a fixed copy (if possible).</span>
<a name="line-662"></a><span class='hs-definition'>checkNewDynFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>DynFlags</span>
<a name="line-663"></a><span class='hs-definition'>checkNewDynFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-664"></a>  <span class='hs-comment'>-- See Note [DynFlags consistency]</span>
<a name="line-665"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>dflags'</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnings</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeDynFlagsConsistent</span> <span class='hs-varid'>dflags</span>
<a name="line-666"></a>  <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>handleFlagWarnings</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>warnings</span>
<a name="line-667"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>dflags'</span>
<a name="line-668"></a>
<a name="line-669"></a><a name="checkNewInteractiveDynFlags"></a><span class='hs-definition'>checkNewInteractiveDynFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>DynFlags</span>
<a name="line-670"></a><span class='hs-definition'>checkNewInteractiveDynFlags</span> <span class='hs-varid'>dflags0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-671"></a>  <span class='hs-varid'>dflags1</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-672"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>StaticPointers</span> <span class='hs-varid'>dflags0</span>
<a name="line-673"></a>      <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>printOrThrowWarnings</span> <span class='hs-varid'>dflags0</span> <span class='hs-varop'>$</span> <span class='hs-varid'>listToBag</span>
<a name="line-674"></a>                <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkPlainWarnMsg</span> <span class='hs-varid'>dflags0</span> <span class='hs-varid'>interactiveSrcSpan</span>
<a name="line-675"></a>                 <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"StaticPointers is not supported in GHCi interactive expressions."</span><span class='hs-keyglyph'>]</span>
<a name="line-676"></a>              <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>xopt_unset</span> <span class='hs-varid'>dflags0</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>StaticPointers</span>
<a name="line-677"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>dflags0</span>
<a name="line-678"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>dflags1</span>
<a name="line-679"></a>
<a name="line-680"></a>
<a name="line-681"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-682"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-683"></a><span class='hs-comment'>--             Setting, getting, and modifying the targets</span>
<a name="line-684"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-685"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-686"></a>
<a name="line-687"></a><span class='hs-comment'>-- ToDo: think about relative vs. absolute file paths. And what</span>
<a name="line-688"></a><span class='hs-comment'>-- happens when the current directory changes.</span>
<a name="line-689"></a>
<a name="line-690"></a><a name="setTargets"></a><span class='hs-comment'>-- | Sets the targets for this session.  Each target may be a module name</span>
<a name="line-691"></a><span class='hs-comment'>-- or a filename.  The targets correspond to the set of root modules for</span>
<a name="line-692"></a><span class='hs-comment'>-- the program\/library.  Unloading the current program is achieved by</span>
<a name="line-693"></a><span class='hs-comment'>-- setting the current set of targets to be empty, followed by 'load'.</span>
<a name="line-694"></a><span class='hs-definition'>setTargets</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Target</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-695"></a><span class='hs-definition'>setTargets</span> <span class='hs-varid'>targets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifySession</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_targets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targets</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-696"></a>
<a name="line-697"></a><a name="getTargets"></a><span class='hs-comment'>-- | Returns the current set of targets</span>
<a name="line-698"></a><span class='hs-definition'>getTargets</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Target</span><span class='hs-keyglyph'>]</span>
<a name="line-699"></a><span class='hs-definition'>getTargets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsc_targets</span><span class='hs-layout'>)</span>
<a name="line-700"></a>
<a name="line-701"></a><a name="addTarget"></a><span class='hs-comment'>-- | Add another target.</span>
<a name="line-702"></a><span class='hs-definition'>addTarget</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Target</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-703"></a><span class='hs-definition'>addTarget</span> <span class='hs-varid'>target</span>
<a name="line-704"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifySession</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_targets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target</span> <span class='hs-conop'>:</span> <span class='hs-varid'>hsc_targets</span> <span class='hs-varid'>h</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-705"></a>
<a name="line-706"></a><a name="removeTarget"></a><span class='hs-comment'>-- | Remove a target</span>
<a name="line-707"></a><span class='hs-definition'>removeTarget</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TargetId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-708"></a><span class='hs-definition'>removeTarget</span> <span class='hs-varid'>target_id</span>
<a name="line-709"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifySession</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_targets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_targets</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-710"></a>  <span class='hs-keyword'>where</span>
<a name="line-711"></a>   <span class='hs-varid'>filter</span> <span class='hs-varid'>targets</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Target</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>targets</span><span class='hs-layout'>,</span> <span class='hs-varid'>id</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>target_id</span> <span class='hs-keyglyph'>]</span>
<a name="line-712"></a>
<a name="line-713"></a><a name="guessTarget"></a><span class='hs-comment'>-- | Attempts to guess what Target a string refers to.  This function</span>
<a name="line-714"></a><span class='hs-comment'>-- implements the @--make@/GHCi command-line syntax for filenames:</span>
<a name="line-715"></a><span class='hs-comment'>--</span>
<a name="line-716"></a><span class='hs-comment'>--   - if the string looks like a Haskell source filename, then interpret it</span>
<a name="line-717"></a><span class='hs-comment'>--     as such</span>
<a name="line-718"></a><span class='hs-comment'>--</span>
<a name="line-719"></a><span class='hs-comment'>--   - if adding a .hs or .lhs suffix yields the name of an existing file,</span>
<a name="line-720"></a><span class='hs-comment'>--     then use that</span>
<a name="line-721"></a><span class='hs-comment'>--</span>
<a name="line-722"></a><span class='hs-comment'>--   - otherwise interpret the string as a module name</span>
<a name="line-723"></a><span class='hs-comment'>--</span>
<a name="line-724"></a><span class='hs-definition'>guessTarget</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Phase</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Target</span>
<a name="line-725"></a><span class='hs-definition'>guessTarget</span> <span class='hs-varid'>str</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>phase</span><span class='hs-layout'>)</span>
<a name="line-726"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Target</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetFile</span> <span class='hs-varid'>str</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>phase</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-727"></a><span class='hs-definition'>guessTarget</span> <span class='hs-varid'>str</span> <span class='hs-conid'>Nothing</span>
<a name="line-728"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isHaskellSrcFilename</span> <span class='hs-varid'>file</span>
<a name="line-729"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>target</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetFile</span> <span class='hs-varid'>file</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-730"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-731"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>exists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>hs_file</span>
<a name="line-732"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>exists</span>
<a name="line-733"></a>           <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>target</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetFile</span> <span class='hs-varid'>hs_file</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-734"></a>           <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-735"></a>        <span class='hs-varid'>exists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>lhs_file</span>
<a name="line-736"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>exists</span>
<a name="line-737"></a>           <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>target</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetFile</span> <span class='hs-varid'>lhs_file</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-738"></a>           <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-739"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>looksLikeModuleName</span> <span class='hs-varid'>file</span>
<a name="line-740"></a>           <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>target</span> <span class='hs-layout'>(</span><span class='hs-conid'>TargetModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-741"></a>           <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-742"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-743"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwGhcExceptionIO</span>
<a name="line-744"></a>                 <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-layout'>(</span><span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-745"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"target"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-746"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"is not a module name or a source file"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-747"></a>     <span class='hs-keyword'>where</span>
<a name="line-748"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>file</span><span class='hs-layout'>,</span><span class='hs-varid'>obj_allowed</span><span class='hs-layout'>)</span>
<a name="line-749"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-chr'>'*'</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-750"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>str</span><span class='hs-layout'>,</span>  <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-751"></a>
<a name="line-752"></a>         <span class='hs-varid'>hs_file</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>file</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"hs"</span>
<a name="line-753"></a>         <span class='hs-varid'>lhs_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>file</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"lhs"</span>
<a name="line-754"></a>
<a name="line-755"></a>         <span class='hs-varid'>target</span> <span class='hs-varid'>tid</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Target</span> <span class='hs-varid'>tid</span> <span class='hs-varid'>obj_allowed</span> <span class='hs-conid'>Nothing</span>
<a name="line-756"></a>
<a name="line-757"></a>
<a name="line-758"></a><a name="workingDirectoryChanged"></a><span class='hs-comment'>-- | Inform GHC that the working directory has changed.  GHC will flush</span>
<a name="line-759"></a><span class='hs-comment'>-- its cache of module locations, since it may no longer be valid.</span>
<a name="line-760"></a><span class='hs-comment'>--</span>
<a name="line-761"></a><span class='hs-comment'>-- Note: Before changing the working directory make sure all threads running</span>
<a name="line-762"></a><span class='hs-comment'>-- in the same session have stopped.  If you change the working directory,</span>
<a name="line-763"></a><span class='hs-comment'>-- you should also unload the current program (set targets to empty,</span>
<a name="line-764"></a><span class='hs-comment'>-- followed by load).</span>
<a name="line-765"></a><span class='hs-definition'>workingDirectoryChanged</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-766"></a><span class='hs-definition'>workingDirectoryChanged</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flushFinderCaches</span><span class='hs-layout'>)</span>
<a name="line-767"></a>
<a name="line-768"></a>
<a name="line-769"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-770"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-771"></a><span class='hs-comment'>--             Running phases one at a time</span>
<a name="line-772"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-773"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-774"></a>
<a name="line-775"></a><a name="TypecheckedMod"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>ParsedMod</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>where</span>
<a name="line-776"></a>  <span class='hs-varid'>modSummary</span>   <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span>
<a name="line-777"></a>  <span class='hs-varid'>parsedSource</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ParsedSource</span>
<a name="line-778"></a>
<a name="line-779"></a><a name="TypecheckedMod"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>ParsedMod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TypecheckedMod</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>where</span>
<a name="line-780"></a>  <span class='hs-varid'>renamedSource</span>     <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>RenamedSource</span>
<a name="line-781"></a>  <span class='hs-varid'>typecheckedSource</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypecheckedSource</span>
<a name="line-782"></a>  <span class='hs-varid'>moduleInfo</span>        <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleInfo</span>
<a name="line-783"></a>  <span class='hs-varid'>tm_internals</span>      <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModDetails</span><span class='hs-layout'>)</span>
<a name="line-784"></a>        <span class='hs-comment'>-- ToDo: improvements that could be made here:</span>
<a name="line-785"></a>        <span class='hs-comment'>--  if the module succeeded renaming but not typechecking,</span>
<a name="line-786"></a>        <span class='hs-comment'>--  we can still get back the GlobalRdrEnv and exports, so</span>
<a name="line-787"></a>        <span class='hs-comment'>--  perhaps the ModuleInfo should be split up into separate</span>
<a name="line-788"></a>        <span class='hs-comment'>--  fields.</span>
<a name="line-789"></a>
<a name="line-790"></a><a name="DesugaredMod"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>TypecheckedMod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DesugaredMod</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>where</span>
<a name="line-791"></a>  <span class='hs-varid'>coreModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span>
<a name="line-792"></a>
<a name="line-793"></a><a name="ParsedModule"></a><span class='hs-comment'>-- | The result of successful parsing.</span>
<a name="line-794"></a><a name="ParsedModule"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ParsedModule</span> <span class='hs-keyglyph'>=</span>
<a name="line-795"></a>  <span class='hs-conid'>ParsedModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pm_mod_summary</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span>
<a name="line-796"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>pm_parsed_source</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ParsedSource</span>
<a name="line-797"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>pm_extra_src_files</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-798"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>pm_annotations</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ApiAnns</span> <span class='hs-layout'>}</span>
<a name="line-799"></a>               <span class='hs-comment'>-- See Note [Api annotations] in ApiAnnotation.hs</span>
<a name="line-800"></a>
<a name="line-801"></a><a name="instance%20ParsedMod%20ParsedModule"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ParsedMod</span> <span class='hs-conid'>ParsedModule</span> <span class='hs-keyword'>where</span>
<a name="line-802"></a>  <span class='hs-varid'>modSummary</span> <span class='hs-varid'>m</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pm_mod_summary</span> <span class='hs-varid'>m</span>
<a name="line-803"></a>  <span class='hs-varid'>parsedSource</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pm_parsed_source</span> <span class='hs-varid'>m</span>
<a name="line-804"></a>
<a name="line-805"></a><a name="TypecheckedModule"></a><span class='hs-comment'>-- | The result of successful typechecking.  It also contains the parser</span>
<a name="line-806"></a><a name="TypecheckedModule"></a><span class='hs-comment'>--   result.</span>
<a name="line-807"></a><a name="TypecheckedModule"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TypecheckedModule</span> <span class='hs-keyglyph'>=</span>
<a name="line-808"></a>  <span class='hs-conid'>TypecheckedModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tm_parsed_module</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ParsedModule</span>
<a name="line-809"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>tm_renamed_source</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>RenamedSource</span>
<a name="line-810"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>tm_typechecked_source</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypecheckedSource</span>
<a name="line-811"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>tm_checked_module_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span>
<a name="line-812"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>tm_internals_</span>          <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModDetails</span><span class='hs-layout'>)</span>
<a name="line-813"></a>                    <span class='hs-layout'>}</span>
<a name="line-814"></a>
<a name="line-815"></a><a name="instance%20ParsedMod%20TypecheckedModule"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ParsedMod</span> <span class='hs-conid'>TypecheckedModule</span> <span class='hs-keyword'>where</span>
<a name="line-816"></a>  <span class='hs-varid'>modSummary</span> <span class='hs-varid'>m</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modSummary</span> <span class='hs-layout'>(</span><span class='hs-varid'>tm_parsed_module</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-817"></a>  <span class='hs-varid'>parsedSource</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parsedSource</span> <span class='hs-layout'>(</span><span class='hs-varid'>tm_parsed_module</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-818"></a>
<a name="line-819"></a><a name="instance%20TypecheckedMod%20TypecheckedModule"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>TypecheckedMod</span> <span class='hs-conid'>TypecheckedModule</span> <span class='hs-keyword'>where</span>
<a name="line-820"></a>  <span class='hs-varid'>renamedSource</span> <span class='hs-varid'>m</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm_renamed_source</span> <span class='hs-varid'>m</span>
<a name="line-821"></a>  <span class='hs-varid'>typecheckedSource</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm_typechecked_source</span> <span class='hs-varid'>m</span>
<a name="line-822"></a>  <span class='hs-varid'>moduleInfo</span> <span class='hs-varid'>m</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm_checked_module_info</span> <span class='hs-varid'>m</span>
<a name="line-823"></a>  <span class='hs-varid'>tm_internals</span> <span class='hs-varid'>m</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm_internals_</span> <span class='hs-varid'>m</span>
<a name="line-824"></a>
<a name="line-825"></a><a name="DesugaredModule"></a><span class='hs-comment'>-- | The result of successful desugaring (i.e., translation to core).  Also</span>
<a name="line-826"></a><a name="DesugaredModule"></a><span class='hs-comment'>--  contains all the information of a typechecked module.</span>
<a name="line-827"></a><a name="DesugaredModule"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DesugaredModule</span> <span class='hs-keyglyph'>=</span>
<a name="line-828"></a>  <span class='hs-conid'>DesugaredModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dm_typechecked_module</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypecheckedModule</span>
<a name="line-829"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>dm_core_module</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModGuts</span>
<a name="line-830"></a>             <span class='hs-layout'>}</span>
<a name="line-831"></a>
<a name="line-832"></a><a name="instance%20ParsedMod%20DesugaredModule"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ParsedMod</span> <span class='hs-conid'>DesugaredModule</span> <span class='hs-keyword'>where</span>
<a name="line-833"></a>  <span class='hs-varid'>modSummary</span> <span class='hs-varid'>m</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modSummary</span> <span class='hs-layout'>(</span><span class='hs-varid'>dm_typechecked_module</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-834"></a>  <span class='hs-varid'>parsedSource</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parsedSource</span> <span class='hs-layout'>(</span><span class='hs-varid'>dm_typechecked_module</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-835"></a>
<a name="line-836"></a><a name="instance%20TypecheckedMod%20DesugaredModule"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>TypecheckedMod</span> <span class='hs-conid'>DesugaredModule</span> <span class='hs-keyword'>where</span>
<a name="line-837"></a>  <span class='hs-varid'>renamedSource</span> <span class='hs-varid'>m</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>renamedSource</span> <span class='hs-layout'>(</span><span class='hs-varid'>dm_typechecked_module</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-838"></a>  <span class='hs-varid'>typecheckedSource</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typecheckedSource</span> <span class='hs-layout'>(</span><span class='hs-varid'>dm_typechecked_module</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-839"></a>  <span class='hs-varid'>moduleInfo</span> <span class='hs-varid'>m</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>dm_typechecked_module</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-840"></a>  <span class='hs-varid'>tm_internals</span> <span class='hs-varid'>m</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm_internals_</span> <span class='hs-layout'>(</span><span class='hs-varid'>dm_typechecked_module</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-841"></a>
<a name="line-842"></a><a name="instance%20DesugaredMod%20DesugaredModule"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>DesugaredMod</span> <span class='hs-conid'>DesugaredModule</span> <span class='hs-keyword'>where</span>
<a name="line-843"></a>  <span class='hs-varid'>coreModule</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dm_core_module</span> <span class='hs-varid'>m</span>
<a name="line-844"></a>
<a name="line-845"></a><a name="ParsedSource"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ParsedSource</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsModule</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-846"></a><a name="RenamedSource"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RenamedSource</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsGroup</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-847"></a>                          <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span><span class='hs-layout'>)</span>
<a name="line-848"></a><a name="TypecheckedSource"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TypecheckedSource</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span>
<a name="line-849"></a>
<a name="line-850"></a><span class='hs-comment'>-- NOTE:</span>
<a name="line-851"></a><span class='hs-comment'>--   - things that aren't in the output of the typechecker right now:</span>
<a name="line-852"></a><span class='hs-comment'>--     - the export list</span>
<a name="line-853"></a><span class='hs-comment'>--     - the imports</span>
<a name="line-854"></a><span class='hs-comment'>--     - type signatures</span>
<a name="line-855"></a><span class='hs-comment'>--     - type/data/newtype declarations</span>
<a name="line-856"></a><span class='hs-comment'>--     - class declarations</span>
<a name="line-857"></a><span class='hs-comment'>--     - instances</span>
<a name="line-858"></a><span class='hs-comment'>--   - extra things in the typechecker's output:</span>
<a name="line-859"></a><span class='hs-comment'>--     - default methods are turned into top-level decls.</span>
<a name="line-860"></a><span class='hs-comment'>--     - dictionary bindings</span>
<a name="line-861"></a>
<a name="line-862"></a><a name="getModSummary"></a><span class='hs-comment'>-- | Return the 'ModSummary' of a module with the given name.</span>
<a name="line-863"></a><span class='hs-comment'>--</span>
<a name="line-864"></a><span class='hs-comment'>-- The module must be part of the module graph (see 'hsc_mod_graph' and</span>
<a name="line-865"></a><span class='hs-comment'>-- 'ModuleGraph').  If this is not the case, this function will throw a</span>
<a name="line-866"></a><span class='hs-comment'>-- 'GhcApiError'.</span>
<a name="line-867"></a><span class='hs-comment'>--</span>
<a name="line-868"></a><span class='hs-comment'>-- This function ignores boot modules and requires that there is only one</span>
<a name="line-869"></a><span class='hs-comment'>-- non-boot module with the given name.</span>
<a name="line-870"></a><span class='hs-definition'>getModSummary</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>ModSummary</span>
<a name="line-871"></a><span class='hs-definition'>getModSummary</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-872"></a>   <span class='hs-varid'>mg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-varid'>getSession</span>
<a name="line-873"></a>   <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBootSummary</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-874"></a>     <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-875"></a>              <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkApiErr</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Module not part of module graph"</span><span class='hs-layout'>)</span>
<a name="line-876"></a>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>ms</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ms</span>
<a name="line-877"></a>     <span class='hs-varid'>multiple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-878"></a>                    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkApiErr</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"getModSummary is ambiguous: "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>multiple</span><span class='hs-layout'>)</span>
<a name="line-879"></a>
<a name="line-880"></a><a name="parseModule"></a><span class='hs-comment'>-- | Parse a module.</span>
<a name="line-881"></a><span class='hs-comment'>--</span>
<a name="line-882"></a><span class='hs-comment'>-- Throws a 'SourceError' on parse error.</span>
<a name="line-883"></a><span class='hs-definition'>parseModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>ParsedModule</span>
<a name="line-884"></a><span class='hs-definition'>parseModule</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-885"></a>   <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-886"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>hsc_env_tmp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span>
<a name="line-887"></a>   <span class='hs-varid'>hpm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscParse</span> <span class='hs-varid'>hsc_env_tmp</span> <span class='hs-varid'>ms</span>
<a name="line-888"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParsedModule</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>(</span><span class='hs-varid'>hpm_module</span> <span class='hs-varid'>hpm</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hpm_src_files</span> <span class='hs-varid'>hpm</span><span class='hs-layout'>)</span>
<a name="line-889"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>hpm_annotations</span> <span class='hs-varid'>hpm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-890"></a>               <span class='hs-comment'>-- See Note [Api annotations] in ApiAnnotation.hs</span>
<a name="line-891"></a>
<a name="line-892"></a><a name="typecheckModule"></a><span class='hs-comment'>-- | Typecheck and rename a parsed module.</span>
<a name="line-893"></a><span class='hs-comment'>--</span>
<a name="line-894"></a><span class='hs-comment'>-- Throws a 'SourceError' if either fails.</span>
<a name="line-895"></a><span class='hs-definition'>typecheckModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ParsedModule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>TypecheckedModule</span>
<a name="line-896"></a><span class='hs-definition'>typecheckModule</span> <span class='hs-varid'>pmod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-897"></a> <span class='hs-keyword'>let</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modSummary</span> <span class='hs-varid'>pmod</span>
<a name="line-898"></a> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-899"></a> <span class='hs-keyword'>let</span> <span class='hs-varid'>hsc_env_tmp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span>
<a name="line-900"></a> <span class='hs-layout'>(</span><span class='hs-varid'>tc_gbl_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_info</span><span class='hs-layout'>)</span>
<a name="line-901"></a>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscTypecheckRename</span> <span class='hs-varid'>hsc_env_tmp</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>$</span>
<a name="line-902"></a>                      <span class='hs-conid'>HsParsedModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hpm_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parsedSource</span> <span class='hs-varid'>pmod</span><span class='hs-layout'>,</span>
<a name="line-903"></a>                                       <span class='hs-varid'>hpm_src_files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pm_extra_src_files</span> <span class='hs-varid'>pmod</span><span class='hs-layout'>,</span>
<a name="line-904"></a>                                       <span class='hs-varid'>hpm_annotations</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pm_annotations</span> <span class='hs-varid'>pmod</span> <span class='hs-layout'>}</span>
<a name="line-905"></a> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>makeSimpleDetails</span> <span class='hs-varid'>hsc_env_tmp</span> <span class='hs-varid'>tc_gbl_env</span>
<a name="line-906"></a> <span class='hs-keyword'>safe</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>finalSafeMode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_hspp_opts</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_gbl_env</span>
<a name="line-907"></a>
<a name="line-908"></a> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-909"></a>     <span class='hs-conid'>TypecheckedModule</span> <span class='hs-layout'>{</span>
<a name="line-910"></a>       <span class='hs-varid'>tm_internals_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_gbl_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-911"></a>       <span class='hs-varid'>tm_parsed_module</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pmod</span><span class='hs-layout'>,</span>
<a name="line-912"></a>       <span class='hs-varid'>tm_renamed_source</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rn_info</span><span class='hs-layout'>,</span>
<a name="line-913"></a>       <span class='hs-varid'>tm_typechecked_source</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_binds</span> <span class='hs-varid'>tc_gbl_env</span><span class='hs-layout'>,</span>
<a name="line-914"></a>       <span class='hs-varid'>tm_checked_module_info</span> <span class='hs-keyglyph'>=</span>
<a name="line-915"></a>         <span class='hs-conid'>ModuleInfo</span> <span class='hs-layout'>{</span>
<a name="line-916"></a>           <span class='hs-varid'>minf_type_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>md_types</span> <span class='hs-varid'>details</span><span class='hs-layout'>,</span>
<a name="line-917"></a>           <span class='hs-varid'>minf_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>md_exports</span> <span class='hs-varid'>details</span><span class='hs-layout'>,</span>
<a name="line-918"></a>           <span class='hs-varid'>minf_rdr_env</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_rdr_env</span> <span class='hs-varid'>tc_gbl_env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-919"></a>           <span class='hs-varid'>minf_instances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixSafeInstances</span> <span class='hs-keyword'>safe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>md_insts</span> <span class='hs-varid'>details</span><span class='hs-layout'>,</span>
<a name="line-920"></a>           <span class='hs-varid'>minf_iface</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span>
<a name="line-921"></a>           <span class='hs-varid'>minf_safe</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>safe</span><span class='hs-layout'>,</span>
<a name="line-922"></a>           <span class='hs-varid'>minf_modBreaks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModBreaks</span>
<a name="line-923"></a>         <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-924"></a>
<a name="line-925"></a><a name="desugarModule"></a><span class='hs-comment'>-- | Desugar a typechecked module.</span>
<a name="line-926"></a><span class='hs-definition'>desugarModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TypecheckedModule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>DesugaredModule</span>
<a name="line-927"></a><span class='hs-definition'>desugarModule</span> <span class='hs-varid'>tcm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-928"></a> <span class='hs-keyword'>let</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modSummary</span> <span class='hs-varid'>tcm</span>
<a name="line-929"></a> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm_internals</span> <span class='hs-varid'>tcm</span>
<a name="line-930"></a> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-931"></a> <span class='hs-keyword'>let</span> <span class='hs-varid'>hsc_env_tmp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span>
<a name="line-932"></a> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscDesugar</span> <span class='hs-varid'>hsc_env_tmp</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>tcg</span>
<a name="line-933"></a> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-934"></a>     <span class='hs-conid'>DesugaredModule</span> <span class='hs-layout'>{</span>
<a name="line-935"></a>       <span class='hs-varid'>dm_typechecked_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcm</span><span class='hs-layout'>,</span>
<a name="line-936"></a>       <span class='hs-varid'>dm_core_module</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guts</span>
<a name="line-937"></a>     <span class='hs-layout'>}</span>
<a name="line-938"></a>
<a name="line-939"></a><a name="loadModule"></a><span class='hs-comment'>-- | Load a module.  Input doesn't need to be desugared.</span>
<a name="line-940"></a><span class='hs-comment'>--</span>
<a name="line-941"></a><span class='hs-comment'>-- A module must be loaded before dependent modules can be typechecked.  This</span>
<a name="line-942"></a><span class='hs-comment'>-- always includes generating a 'ModIface' and, depending on the</span>
<a name="line-943"></a><span class='hs-comment'>-- 'DynFlags.hscTarget', may also include code generation.</span>
<a name="line-944"></a><span class='hs-comment'>--</span>
<a name="line-945"></a><span class='hs-comment'>-- This function will always cause recompilation and will always overwrite</span>
<a name="line-946"></a><span class='hs-comment'>-- previous compilation results (potentially files on disk).</span>
<a name="line-947"></a><span class='hs-comment'>--</span>
<a name="line-948"></a><span class='hs-definition'>loadModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypecheckedMod</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>mod</span>
<a name="line-949"></a><span class='hs-definition'>loadModule</span> <span class='hs-varid'>tcm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-950"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modSummary</span> <span class='hs-varid'>tcm</span>
<a name="line-951"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>ms</span>
<a name="line-952"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_location</span> <span class='hs-varid'>ms</span>
<a name="line-953"></a>   <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg</span><span class='hs-layout'>,</span> <span class='hs-sel'>_details</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm_internals</span> <span class='hs-varid'>tcm</span>
<a name="line-954"></a>
<a name="line-955"></a>   <span class='hs-varid'>mb_linkable</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ms_obj_date</span> <span class='hs-varid'>ms</span> <span class='hs-keyword'>of</span>
<a name="line-956"></a>                     <span class='hs-conid'>Just</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>ms_hs_date</span> <span class='hs-varid'>ms</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-957"></a>                         <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findObjectLinkable</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-958"></a>                                                  <span class='hs-layout'>(</span><span class='hs-varid'>ml_obj_file</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span>
<a name="line-959"></a>                         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-960"></a>                     <span class='hs-sel'>_otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-961"></a>
<a name="line-962"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>source_modified</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_linkable</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SourceModified</span>
<a name="line-963"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SourceUnmodified</span>
<a name="line-964"></a>                       <span class='hs-comment'>-- we can't determine stability here</span>
<a name="line-965"></a>
<a name="line-966"></a>   <span class='hs-comment'>-- compile doesn't change the session</span>
<a name="line-967"></a>   <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-968"></a>   <span class='hs-varid'>mod_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>compileOne'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-969"></a>                                    <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>ms</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>mb_linkable</span>
<a name="line-970"></a>                                    <span class='hs-varid'>source_modified</span>
<a name="line-971"></a>
<a name="line-972"></a>   <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToHpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>mod_info</span> <span class='hs-layout'>}</span>
<a name="line-973"></a>   <span class='hs-varid'>return</span> <span class='hs-varid'>tcm</span>
<a name="line-974"></a>
<a name="line-975"></a>
<a name="line-976"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-977"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-978"></a><span class='hs-comment'>--             Dealing with Core</span>
<a name="line-979"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-980"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-981"></a>
<a name="line-982"></a><a name="CoreModule"></a><span class='hs-comment'>-- | A CoreModule consists of just the fields of a 'ModGuts' that are needed for</span>
<a name="line-983"></a><a name="CoreModule"></a><span class='hs-comment'>-- the 'GHC.compileToCoreModule' interface.</span>
<a name="line-984"></a><a name="CoreModule"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoreModule</span>
<a name="line-985"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreModule</span> <span class='hs-layout'>{</span>
<a name="line-986"></a>      <span class='hs-comment'>-- | Module name</span>
<a name="line-987"></a>      <span class='hs-varid'>cm_module</span>   <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span>
<a name="line-988"></a>      <span class='hs-comment'>-- | Type environment for types declared in this module</span>
<a name="line-989"></a>      <span class='hs-varid'>cm_types</span>    <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-990"></a>      <span class='hs-comment'>-- | Declarations</span>
<a name="line-991"></a>      <span class='hs-varid'>cm_binds</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>,</span>
<a name="line-992"></a>      <span class='hs-comment'>-- | Safe Haskell mode</span>
<a name="line-993"></a>      <span class='hs-varid'>cm_safe</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SafeHaskellMode</span>
<a name="line-994"></a>    <span class='hs-layout'>}</span>
<a name="line-995"></a>
<a name="line-996"></a><a name="instance%20Outputable%20CoreModule"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CoreModule</span> <span class='hs-keyword'>where</span>
<a name="line-997"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreModule</span> <span class='hs-layout'>{</span><span class='hs-varid'>cm_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mn</span><span class='hs-layout'>,</span> <span class='hs-varid'>cm_types</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>te</span><span class='hs-layout'>,</span> <span class='hs-varid'>cm_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cb</span><span class='hs-layout'>,</span>
<a name="line-998"></a>                    <span class='hs-varid'>cm_safe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sf</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-999"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"%module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mn</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sf</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>te</span>
<a name="line-1000"></a>      <span class='hs-varop'>$$</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cb</span><span class='hs-layout'>)</span>
<a name="line-1001"></a>
<a name="line-1002"></a><a name="compileToCoreModule"></a><span class='hs-comment'>-- | This is the way to get access to the Core bindings corresponding</span>
<a name="line-1003"></a><span class='hs-comment'>-- to a module. 'compileToCore' parses, typechecks, and</span>
<a name="line-1004"></a><span class='hs-comment'>-- desugars the module, then returns the resulting Core module (consisting of</span>
<a name="line-1005"></a><span class='hs-comment'>-- the module name, type declarations, and function declarations) if</span>
<a name="line-1006"></a><span class='hs-comment'>-- successful.</span>
<a name="line-1007"></a><span class='hs-definition'>compileToCoreModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>CoreModule</span>
<a name="line-1008"></a><span class='hs-definition'>compileToCoreModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compileCore</span> <span class='hs-conid'>False</span>
<a name="line-1009"></a>
<a name="line-1010"></a><a name="compileToCoreSimplified"></a><span class='hs-comment'>-- | Like compileToCoreModule, but invokes the simplifier, so</span>
<a name="line-1011"></a><span class='hs-comment'>-- as to return simplified and tidied Core.</span>
<a name="line-1012"></a><span class='hs-definition'>compileToCoreSimplified</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>CoreModule</span>
<a name="line-1013"></a><span class='hs-definition'>compileToCoreSimplified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compileCore</span> <span class='hs-conid'>True</span>
<a name="line-1014"></a>
<a name="line-1015"></a><a name="compileCore"></a><span class='hs-definition'>compileCore</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>CoreModule</span>
<a name="line-1016"></a><span class='hs-definition'>compileCore</span> <span class='hs-varid'>simplify</span> <span class='hs-varid'>fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1017"></a>   <span class='hs-comment'>-- First, set the target to the desired filename</span>
<a name="line-1018"></a>   <span class='hs-varid'>target</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>guessTarget</span> <span class='hs-varid'>fn</span> <span class='hs-conid'>Nothing</span>
<a name="line-1019"></a>   <span class='hs-varid'>addTarget</span> <span class='hs-varid'>target</span>
<a name="line-1020"></a>   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>load</span> <span class='hs-conid'>LoadAllTargets</span>
<a name="line-1021"></a>   <span class='hs-comment'>-- Then find dependencies</span>
<a name="line-1022"></a>   <span class='hs-varid'>modGraph</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>depanal</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>True</span>
<a name="line-1023"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>msHsFilePath</span><span class='hs-layout'>)</span> <span class='hs-varid'>modGraph</span> <span class='hs-keyword'>of</span>
<a name="line-1024"></a>     <span class='hs-conid'>Just</span> <span class='hs-varid'>modSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1025"></a>       <span class='hs-comment'>-- Now we have the module name;</span>
<a name="line-1026"></a>       <span class='hs-comment'>-- parse, typecheck and desugar the module</span>
<a name="line-1027"></a>       <span class='hs-varid'>mod_guts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreModule</span> <span class='hs-varop'>`fmap`</span>
<a name="line-1028"></a>                      <span class='hs-comment'>-- TODO: space leaky: call hsc* directly?</span>
<a name="line-1029"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>desugarModule</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>typecheckModule</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>parseModule</span> <span class='hs-varid'>modSummary</span><span class='hs-layout'>)</span>
<a name="line-1030"></a>       <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>gutsToCoreModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_safe_haskell</span> <span class='hs-varid'>mod_guts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1031"></a>         <span class='hs-keyword'>if</span> <span class='hs-varid'>simplify</span>
<a name="line-1032"></a>          <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-1033"></a>             <span class='hs-comment'>-- If simplify is true: simplify (hscSimplify), then tidy</span>
<a name="line-1034"></a>             <span class='hs-comment'>-- (tidyProgram).</span>
<a name="line-1035"></a>             <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-1036"></a>             <span class='hs-varid'>simpl_guts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscSimplify</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_guts</span>
<a name="line-1037"></a>             <span class='hs-varid'>tidy_guts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tidyProgram</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>simpl_guts</span>
<a name="line-1038"></a>             <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>tidy_guts</span>
<a name="line-1039"></a>          <span class='hs-keyword'>else</span>
<a name="line-1040"></a>             <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>mod_guts</span>
<a name="line-1041"></a>
<a name="line-1042"></a>     <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"</span><span class='hs-varid'>compileToCoreModule</span><span class='hs-conop'>:</span> <span class='hs-varid'>target</span> <span class='hs-conid'>FilePath</span> <span class='hs-varid'>not</span> <span class='hs-varid'>found</span> <span class='hs-keyword'>in</span><span class='hs-keyglyph'>\</span>
<a name="line-1043"></a>                           <span class='hs-keyword'>module</span> <span class='hs-varid'>dependency</span> <span class='hs-varid'>graph</span><span class='hs-str'>"</span>
<a name="line-1044"></a>  <span class='hs-keyword'>where</span> <span class='hs-comment'>-- two versions, based on whether we simplify (thus run tidyProgram,</span>
<a name="line-1045"></a>        <span class='hs-comment'>-- which returns a (CgGuts, ModDetails) pair, or not (in which case</span>
<a name="line-1046"></a>        <span class='hs-comment'>-- we just have a ModGuts.</span>
<a name="line-1047"></a>        <span class='hs-varid'>gutsToCoreModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SafeHaskellMode</span>
<a name="line-1048"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgGuts</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModDetails</span><span class='hs-layout'>)</span> <span class='hs-conid'>ModGuts</span>
<a name="line-1049"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreModule</span>
<a name="line-1050"></a>        <span class='hs-varid'>gutsToCoreModule</span> <span class='hs-varid'>safe_mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg</span><span class='hs-layout'>,</span> <span class='hs-varid'>md</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreModule</span> <span class='hs-layout'>{</span>
<a name="line-1051"></a>          <span class='hs-varid'>cm_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cg_module</span> <span class='hs-varid'>cg</span><span class='hs-layout'>,</span>
<a name="line-1052"></a>          <span class='hs-varid'>cm_types</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>md_types</span> <span class='hs-varid'>md</span><span class='hs-layout'>,</span>
<a name="line-1053"></a>          <span class='hs-varid'>cm_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cg_binds</span> <span class='hs-varid'>cg</span><span class='hs-layout'>,</span>
<a name="line-1054"></a>          <span class='hs-varid'>cm_safe</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safe_mode</span>
<a name="line-1055"></a>        <span class='hs-layout'>}</span>
<a name="line-1056"></a>        <span class='hs-varid'>gutsToCoreModule</span> <span class='hs-varid'>safe_mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>mg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreModule</span> <span class='hs-layout'>{</span>
<a name="line-1057"></a>          <span class='hs-varid'>cm_module</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mg_module</span> <span class='hs-varid'>mg</span><span class='hs-layout'>,</span>
<a name="line-1058"></a>          <span class='hs-varid'>cm_types</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeEnvFromEntities</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindersOfBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>mg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1059"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>mg_tcs</span> <span class='hs-varid'>mg</span><span class='hs-layout'>)</span>
<a name="line-1060"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>mg_fam_insts</span> <span class='hs-varid'>mg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1061"></a>          <span class='hs-varid'>cm_binds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mg_binds</span> <span class='hs-varid'>mg</span><span class='hs-layout'>,</span>
<a name="line-1062"></a>          <span class='hs-varid'>cm_safe</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safe_mode</span>
<a name="line-1063"></a>         <span class='hs-layout'>}</span>
<a name="line-1064"></a>
<a name="line-1065"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-1066"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-1067"></a><span class='hs-comment'>--             Inspecting the session</span>
<a name="line-1068"></a><span class='hs-comment'>-- %*                                                                      *</span>
<a name="line-1069"></a><span class='hs-comment'>-- %************************************************************************</span>
<a name="line-1070"></a>
<a name="line-1071"></a><a name="getModuleGraph"></a><span class='hs-comment'>-- | Get the module dependency graph.</span>
<a name="line-1072"></a><span class='hs-definition'>getModuleGraph</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>ModuleGraph</span> <span class='hs-comment'>-- ToDo: DiGraph ModSummary</span>
<a name="line-1073"></a><span class='hs-definition'>getModuleGraph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-varid'>getSession</span>
<a name="line-1074"></a>
<a name="line-1075"></a><a name="needsTemplateHaskell"></a><span class='hs-comment'>-- | Determines whether a set of modules requires Template Haskell.</span>
<a name="line-1076"></a><span class='hs-comment'>--</span>
<a name="line-1077"></a><span class='hs-comment'>-- Note that if the session's 'DynFlags' enabled Template Haskell when</span>
<a name="line-1078"></a><span class='hs-comment'>-- 'depanal' was called, then each module in the returned module graph will</span>
<a name="line-1079"></a><span class='hs-comment'>-- have Template Haskell enabled whether it is actually needed or not.</span>
<a name="line-1080"></a><span class='hs-definition'>needsTemplateHaskell</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1081"></a><span class='hs-definition'>needsTemplateHaskell</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span>
<a name="line-1082"></a>    <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>TemplateHaskell</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ms_hspp_opts</span><span class='hs-layout'>)</span> <span class='hs-varid'>ms</span>
<a name="line-1083"></a>
<a name="line-1084"></a><a name="isLoaded"></a><span class='hs-comment'>-- | Return @True@ &lt;==&gt; module is loaded.</span>
<a name="line-1085"></a><span class='hs-definition'>isLoaded</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Bool</span>
<a name="line-1086"></a><span class='hs-definition'>isLoaded</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1087"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupHpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1088"></a>
<a name="line-1089"></a><a name="getBindings"></a><span class='hs-comment'>-- | Return the bindings for the current interactive session.</span>
<a name="line-1090"></a><span class='hs-definition'>getBindings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span>
<a name="line-1091"></a><span class='hs-definition'>getBindings</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1092"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>icInScopeTTs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1093"></a>
<a name="line-1094"></a><a name="getInsts"></a><span class='hs-comment'>-- | Return the instances for the current interactive session.</span>
<a name="line-1095"></a><span class='hs-definition'>getInsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1096"></a><span class='hs-definition'>getInsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1097"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ic_instances</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1098"></a>
<a name="line-1099"></a><a name="getPrintUnqual"></a><span class='hs-definition'>getPrintUnqual</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>PrintUnqualified</span>
<a name="line-1100"></a><span class='hs-definition'>getPrintUnqual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1101"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>icPrintUnqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1102"></a>
<a name="line-1103"></a><a name="ModuleInfo"></a><span class='hs-comment'>-- | Container for information about a 'Module'.</span>
<a name="line-1104"></a><a name="ModuleInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-layout'>{</span>
<a name="line-1105"></a>        <span class='hs-varid'>minf_type_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-1106"></a>        <span class='hs-varid'>minf_exports</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-1107"></a>        <span class='hs-varid'>minf_rdr_env</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Nothing for a compiled/package mod</span>
<a name="line-1108"></a>        <span class='hs-varid'>minf_instances</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-1109"></a>        <span class='hs-varid'>minf_iface</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>,</span>
<a name="line-1110"></a>        <span class='hs-varid'>minf_safe</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SafeHaskellMode</span><span class='hs-layout'>,</span>
<a name="line-1111"></a>        <span class='hs-varid'>minf_modBreaks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModBreaks</span>
<a name="line-1112"></a>  <span class='hs-layout'>}</span>
<a name="line-1113"></a>        <span class='hs-comment'>-- We don't want HomeModInfo here, because a ModuleInfo applies</span>
<a name="line-1114"></a>        <span class='hs-comment'>-- to package modules too.</span>
<a name="line-1115"></a>
<a name="line-1116"></a><a name="getModuleInfo"></a><span class='hs-comment'>-- | Request information about a loaded 'Module'</span>
<a name="line-1117"></a><span class='hs-definition'>getModuleInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModuleInfo</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- XXX: Maybe X</span>
<a name="line-1118"></a><span class='hs-definition'>getModuleInfo</span> <span class='hs-varid'>mdl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1119"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>mg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_mod_graph</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1120"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>mdl</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mg</span>
<a name="line-1121"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getHomeModuleInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mdl</span>
<a name="line-1122"></a>        <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-1123"></a>  <span class='hs-comment'>{- if isHomeModule (hsc_dflags hsc_env) mdl
<a name="line-1124"></a>        then return Nothing
<a name="line-1125"></a>        else -}</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getPackageModuleInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mdl</span>
<a name="line-1126"></a>   <span class='hs-comment'>-- ToDo: we don't understand what the following comment means.</span>
<a name="line-1127"></a>   <span class='hs-comment'>--    (SDM, 19/7/2011)</span>
<a name="line-1128"></a>   <span class='hs-comment'>-- getPackageModuleInfo will attempt to find the interface, so</span>
<a name="line-1129"></a>   <span class='hs-comment'>-- we don't want to call it for a home module, just in case there</span>
<a name="line-1130"></a>   <span class='hs-comment'>-- was a problem loading the module and the interface doesn't</span>
<a name="line-1131"></a>   <span class='hs-comment'>-- exist... hence the isHomeModule test here.  (ToDo: reinstate)</span>
<a name="line-1132"></a>
<a name="line-1133"></a><a name="getPackageModuleInfo"></a><span class='hs-definition'>getPackageModuleInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModuleInfo</span><span class='hs-layout'>)</span>
<a name="line-1134"></a><span class='hs-definition'>getPackageModuleInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mdl</span>
<a name="line-1135"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscEPS</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1136"></a>        <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscGetModuleInterface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mdl</span>
<a name="line-1137"></a>        <span class='hs-keyword'>let</span>
<a name="line-1138"></a>            <span class='hs-varid'>avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_exports</span> <span class='hs-varid'>iface</span>
<a name="line-1139"></a>            <span class='hs-varid'>pte</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eps_PTE</span> <span class='hs-varid'>eps</span>
<a name="line-1140"></a>            <span class='hs-varid'>tys</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>availNames</span> <span class='hs-varid'>avails</span><span class='hs-layout'>,</span>
<a name="line-1141"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lookupTypeEnv</span> <span class='hs-varid'>pte</span> <span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-1142"></a>        <span class='hs-comment'>--</span>
<a name="line-1143"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleInfo</span> <span class='hs-layout'>{</span>
<a name="line-1144"></a>                        <span class='hs-varid'>minf_type_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTypeEnv</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span>
<a name="line-1145"></a>                        <span class='hs-varid'>minf_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>avails</span><span class='hs-layout'>,</span>
<a name="line-1146"></a>                        <span class='hs-varid'>minf_rdr_env</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>availsToGlobalRdrEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mdl</span><span class='hs-layout'>)</span> <span class='hs-varid'>avails</span><span class='hs-layout'>,</span>
<a name="line-1147"></a>                        <span class='hs-varid'>minf_instances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"getModuleInfo: instances for package module unimplemented"</span><span class='hs-layout'>,</span>
<a name="line-1148"></a>                        <span class='hs-varid'>minf_iface</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span><span class='hs-layout'>,</span>
<a name="line-1149"></a>                        <span class='hs-varid'>minf_safe</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSafeMode</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mi_trust</span> <span class='hs-varid'>iface</span><span class='hs-layout'>,</span>
<a name="line-1150"></a>                        <span class='hs-varid'>minf_modBreaks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModBreaks</span>
<a name="line-1151"></a>                <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1152"></a>
<a name="line-1153"></a><a name="getHomeModuleInfo"></a><span class='hs-definition'>getHomeModuleInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModuleInfo</span><span class='hs-layout'>)</span>
<a name="line-1154"></a><span class='hs-definition'>getHomeModuleInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mdl</span> <span class='hs-keyglyph'>=</span>
<a name="line-1155"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupHpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mdl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1156"></a>    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1157"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1158"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hm_details</span> <span class='hs-varid'>hmi</span>
<a name="line-1159"></a>          <span class='hs-varid'>iface</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hm_iface</span> <span class='hs-varid'>hmi</span>
<a name="line-1160"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleInfo</span> <span class='hs-layout'>{</span>
<a name="line-1161"></a>                        <span class='hs-varid'>minf_type_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>md_types</span> <span class='hs-varid'>details</span><span class='hs-layout'>,</span>
<a name="line-1162"></a>                        <span class='hs-varid'>minf_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>md_exports</span> <span class='hs-varid'>details</span><span class='hs-layout'>,</span>
<a name="line-1163"></a>                        <span class='hs-varid'>minf_rdr_env</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_globals</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>hm_iface</span> <span class='hs-varid'>hmi</span><span class='hs-layout'>,</span>
<a name="line-1164"></a>                        <span class='hs-varid'>minf_instances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>md_insts</span> <span class='hs-varid'>details</span><span class='hs-layout'>,</span>
<a name="line-1165"></a>                        <span class='hs-varid'>minf_iface</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span><span class='hs-layout'>,</span>
<a name="line-1166"></a>                        <span class='hs-varid'>minf_safe</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSafeMode</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mi_trust</span> <span class='hs-varid'>iface</span>
<a name="line-1167"></a>                       <span class='hs-layout'>,</span><span class='hs-varid'>minf_modBreaks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getModBreaks</span> <span class='hs-varid'>hmi</span>
<a name="line-1168"></a>                        <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1169"></a>
<a name="line-1170"></a><a name="modInfoTyThings"></a><span class='hs-comment'>-- | The list of top-level entities defined in a module</span>
<a name="line-1171"></a><span class='hs-definition'>modInfoTyThings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span>
<a name="line-1172"></a><span class='hs-definition'>modInfoTyThings</span> <span class='hs-varid'>minf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>minf_type_env</span> <span class='hs-varid'>minf</span><span class='hs-layout'>)</span>
<a name="line-1173"></a>
<a name="line-1174"></a><a name="modInfoTopLevelScope"></a><span class='hs-definition'>modInfoTopLevelScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1175"></a><span class='hs-definition'>modInfoTopLevelScope</span> <span class='hs-varid'>minf</span>
<a name="line-1176"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>gre_name</span> <span class='hs-varop'>.</span> <span class='hs-varid'>globalRdrEnvElts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>minf_rdr_env</span> <span class='hs-varid'>minf</span><span class='hs-layout'>)</span>
<a name="line-1177"></a>
<a name="line-1178"></a><a name="modInfoExports"></a><span class='hs-definition'>modInfoExports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1179"></a><span class='hs-definition'>modInfoExports</span> <span class='hs-varid'>minf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>availNames</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>minf_exports</span> <span class='hs-varid'>minf</span>
<a name="line-1180"></a>
<a name="line-1181"></a><a name="modInfoExportsWithSelectors"></a><span class='hs-definition'>modInfoExportsWithSelectors</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1182"></a><span class='hs-definition'>modInfoExportsWithSelectors</span> <span class='hs-varid'>minf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>availNamesWithSelectors</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>minf_exports</span> <span class='hs-varid'>minf</span>
<a name="line-1183"></a>
<a name="line-1184"></a><a name="modInfoInstances"></a><span class='hs-comment'>-- | Returns the instances defined by the specified module.</span>
<a name="line-1185"></a><span class='hs-comment'>-- Warning: currently unimplemented for package modules.</span>
<a name="line-1186"></a><span class='hs-definition'>modInfoInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span>
<a name="line-1187"></a><span class='hs-definition'>modInfoInstances</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>minf_instances</span>
<a name="line-1188"></a>
<a name="line-1189"></a><a name="modInfoIsExportedName"></a><span class='hs-definition'>modInfoIsExportedName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1190"></a><span class='hs-definition'>modInfoIsExportedName</span> <span class='hs-varid'>minf</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elemNameSet</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>availsToNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>minf_exports</span> <span class='hs-varid'>minf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1191"></a>
<a name="line-1192"></a><a name="mkPrintUnqualifiedForModule"></a><span class='hs-definition'>mkPrintUnqualifiedForModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-1193"></a>                               <span class='hs-conid'>ModuleInfo</span>
<a name="line-1194"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>PrintUnqualified</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- XXX: returns a Maybe X</span>
<a name="line-1195"></a><span class='hs-definition'>mkPrintUnqualifiedForModule</span> <span class='hs-varid'>minf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1196"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPrintUnqualified</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>minf_rdr_env</span> <span class='hs-varid'>minf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1197"></a>
<a name="line-1198"></a><a name="modInfoLookupName"></a><span class='hs-definition'>modInfoLookupName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-1199"></a>                     <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-1200"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyThing</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- XXX: returns a Maybe X</span>
<a name="line-1201"></a><span class='hs-definition'>modInfoLookupName</span> <span class='hs-varid'>minf</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1202"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupTypeEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>minf_type_env</span> <span class='hs-varid'>minf</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-1203"></a>     <span class='hs-conid'>Just</span> <span class='hs-varid'>tyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tyThing</span><span class='hs-layout'>)</span>
<a name="line-1204"></a>     <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1205"></a>       <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_EPS</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1206"></a>       <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>lookupType</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1207"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_PTE</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-1208"></a>
<a name="line-1209"></a><a name="modInfoIface"></a><span class='hs-definition'>modInfoIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span>
<a name="line-1210"></a><span class='hs-definition'>modInfoIface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>minf_iface</span>
<a name="line-1211"></a>
<a name="line-1212"></a><a name="modInfoSafe"></a><span class='hs-comment'>-- | Retrieve module safe haskell mode</span>
<a name="line-1213"></a><span class='hs-definition'>modInfoSafe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SafeHaskellMode</span>
<a name="line-1214"></a><span class='hs-definition'>modInfoSafe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>minf_safe</span>
<a name="line-1215"></a>
<a name="line-1216"></a><a name="modInfoModBreaks"></a><span class='hs-definition'>modInfoModBreaks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModBreaks</span>
<a name="line-1217"></a><span class='hs-definition'>modInfoModBreaks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>minf_modBreaks</span>
<a name="line-1218"></a>
<a name="line-1219"></a><a name="isDictonaryId"></a><span class='hs-definition'>isDictonaryId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1220"></a><span class='hs-definition'>isDictonaryId</span> <span class='hs-varid'>id</span>
<a name="line-1221"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-1222"></a>      <span class='hs-layout'>(</span><span class='hs-sel'>_tvs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isDictTy</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span>
<a name="line-1223"></a>
<a name="line-1224"></a><a name="lookupGlobalName"></a><span class='hs-comment'>-- | Looks up a global name: that is, any top-level name in any</span>
<a name="line-1225"></a><span class='hs-comment'>-- visible module.  Unlike 'lookupName', lookupGlobalName does not use</span>
<a name="line-1226"></a><span class='hs-comment'>-- the interactive context, and therefore does not require a preceding</span>
<a name="line-1227"></a><span class='hs-comment'>-- 'setContext'.</span>
<a name="line-1228"></a><span class='hs-definition'>lookupGlobalName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyThing</span><span class='hs-layout'>)</span>
<a name="line-1229"></a><span class='hs-definition'>lookupGlobalName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1230"></a>   <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupTypeHscEnv</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span>
<a name="line-1231"></a>
<a name="line-1232"></a><a name="findGlobalAnns"></a><span class='hs-definition'>findGlobalAnns</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnnTarget</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-1233"></a><span class='hs-definition'>findGlobalAnns</span> <span class='hs-varid'>deserialize</span> <span class='hs-varid'>target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1234"></a>    <span class='hs-varid'>ann_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prepareAnnotations</span> <span class='hs-varid'>hsc_env</span> <span class='hs-conid'>Nothing</span>
<a name="line-1235"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>findAnns</span> <span class='hs-varid'>deserialize</span> <span class='hs-varid'>ann_env</span> <span class='hs-varid'>target</span><span class='hs-layout'>)</span>
<a name="line-1236"></a>
<a name="line-1237"></a><a name="getGRE"></a><span class='hs-comment'>-- | get the GlobalRdrEnv for a session</span>
<a name="line-1238"></a><span class='hs-definition'>getGRE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-1239"></a><span class='hs-definition'>getGRE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1240"></a>
<a name="line-1241"></a><a name="getNameToInstancesIndex"></a><span class='hs-comment'>-- | Retrieve all type and family instances in the environment, indexed</span>
<a name="line-1242"></a><span class='hs-comment'>-- by 'Name'. Each name's lists will contain every instance in which that name</span>
<a name="line-1243"></a><span class='hs-comment'>-- is mentioned in the instance head.</span>
<a name="line-1244"></a><span class='hs-definition'>getNameToInstancesIndex</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span>
<a name="line-1245"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>NameEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1246"></a><span class='hs-definition'>getNameToInstancesIndex</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1247"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-1248"></a>  <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-1249"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loadUnqualIfaces</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-1250"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>InstEnvs</span> <span class='hs-layout'>{</span><span class='hs-varid'>ie_global</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie_local</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie_visible</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-1251"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg_fie</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_fie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-1252"></a>       <span class='hs-comment'>-- We use Data.Sequence.Seq because we are creating left associated</span>
<a name="line-1253"></a>       <span class='hs-comment'>-- mappends.</span>
<a name="line-1254"></a>       <span class='hs-comment'>-- cls_index and fam_index below are adapted from TcRnDriver.lookupInsts</span>
<a name="line-1255"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cls_index</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromListWith</span> <span class='hs-varid'>mappend</span>
<a name="line-1256"></a>                 <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Seq</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span>
<a name="line-1257"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instEnvElts</span> <span class='hs-varid'>ie_local</span> <span class='hs-varop'>++</span> <span class='hs-varid'>instEnvElts</span> <span class='hs-varid'>ie_global</span>
<a name="line-1258"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>instIsVisible</span> <span class='hs-varid'>ie_visible</span> <span class='hs-varid'>ispec</span>
<a name="line-1259"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameSetElemsStable</span> <span class='hs-varop'>$</span> <span class='hs-varid'>orphNamesOfClsInst</span> <span class='hs-varid'>ispec</span>
<a name="line-1260"></a>                 <span class='hs-keyglyph'>]</span>
<a name="line-1261"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_index</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromListWith</span> <span class='hs-varid'>mappend</span>
<a name="line-1262"></a>                 <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Seq</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>fispec</span><span class='hs-layout'>)</span>
<a name="line-1263"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fispec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>famInstEnvElts</span> <span class='hs-varid'>home_fie</span> <span class='hs-varop'>++</span> <span class='hs-varid'>famInstEnvElts</span> <span class='hs-varid'>pkg_fie</span>
<a name="line-1264"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameSetElemsStable</span> <span class='hs-varop'>$</span> <span class='hs-varid'>orphNamesOfFamInst</span> <span class='hs-varid'>fispec</span>
<a name="line-1265"></a>                 <span class='hs-keyglyph'>]</span>
<a name="line-1266"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNameEnv</span> <span class='hs-varop'>$</span>
<a name="line-1267"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>toList</span> <span class='hs-varid'>clss</span><span class='hs-layout'>,</span> <span class='hs-varid'>toList</span> <span class='hs-varid'>fams</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1268"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>clss</span><span class='hs-layout'>,</span> <span class='hs-varid'>fams</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>unionWith</span> <span class='hs-varid'>mappend</span>
<a name="line-1269"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-layout'>,</span><span class='hs-conid'>Seq</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls_index</span><span class='hs-layout'>)</span>
<a name="line-1270"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Seq</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>,</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam_index</span><span class='hs-layout'>)</span>
<a name="line-1271"></a>           <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-1272"></a>
<a name="line-1273"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1274"></a>
<a name="line-1275"></a><span class='hs-comment'>{- ToDo: Move the primary logic here to compiler/main/Packages.hs
<a name="line-1276"></a>-- | Return all /external/ modules available in the package database.
<a name="line-1277"></a>-- Modules from the current session (i.e., from the 'HomePackageTable') are
<a name="line-1278"></a>-- not included.  This includes module names which are reexported by packages.
<a name="line-1279"></a>packageDbModules :: GhcMonad m =&gt;
<a name="line-1280"></a>                    Bool  -- ^ Only consider exposed packages.
<a name="line-1281"></a>                 -&gt; m [Module]
<a name="line-1282"></a>packageDbModules only_exposed = do
<a name="line-1283"></a>   dflags &lt;- getSessionDynFlags
<a name="line-1284"></a>   let pkgs = eltsUFM (pkgIdMap (pkgState dflags))
<a name="line-1285"></a>   return $
<a name="line-1286"></a>     [ mkModule pid modname
<a name="line-1287"></a>     | p &lt;- pkgs
<a name="line-1288"></a>     , not only_exposed || exposed p
<a name="line-1289"></a>     , let pid = packageConfigId p
<a name="line-1290"></a>     , modname &lt;- exposedModules p
<a name="line-1291"></a>               ++ map exportName (reexportedModules p) ]
<a name="line-1292"></a>               -}</span>
<a name="line-1293"></a>
<a name="line-1294"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1295"></a><span class='hs-comment'>-- Misc exported utils</span>
<a name="line-1296"></a>
<a name="line-1297"></a><a name="dataConType"></a><span class='hs-definition'>dataConType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1298"></a><span class='hs-definition'>dataConType</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-1299"></a>
<a name="line-1300"></a><a name="pprParenSymName"></a><span class='hs-comment'>-- | print a 'NamedThing', adding parentheses if the name is an operator.</span>
<a name="line-1301"></a><span class='hs-definition'>pprParenSymName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NamedThing</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1302"></a><span class='hs-definition'>pprParenSymName</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parenSymOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1303"></a>
<a name="line-1304"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-1305"></a>
<a name="line-1306"></a><span class='hs-cpp'>#if 0</span>
<a name="line-1307"></a>
<a name="line-1308"></a><span class='hs-comment'>-- ToDo:</span>
<a name="line-1309"></a><span class='hs-comment'>--   - Data and Typeable instances for HsSyn.</span>
<a name="line-1310"></a>
<a name="line-1311"></a><span class='hs-comment'>-- ToDo: check for small transformations that happen to the syntax in</span>
<a name="line-1312"></a><span class='hs-comment'>-- the typechecker (eg. -e ==&gt; negate e, perhaps for fromIntegral)</span>
<a name="line-1313"></a>
<a name="line-1314"></a><span class='hs-comment'>-- ToDo: maybe use TH syntax instead of IfaceSyn?  There's already a way</span>
<a name="line-1315"></a><span class='hs-comment'>-- to get from TyCons, Ids etc. to TH syntax (reify).</span>
<a name="line-1316"></a>
<a name="line-1317"></a><span class='hs-comment'>-- :browse will use either lm_toplev or inspect lm_interface, depending</span>
<a name="line-1318"></a><span class='hs-comment'>-- on whether the module is interpreted or not.</span>
<a name="line-1319"></a>
<a name="line-1320"></a><span class='hs-cpp'>#endif</span>
<a name="line-1321"></a>
<a name="line-1322"></a><a name="getModuleSourceAndFlags"></a><span class='hs-comment'>-- Extract the filename, stringbuffer content and dynflags associed to a module</span>
<a name="line-1323"></a><span class='hs-comment'>--</span>
<a name="line-1324"></a><span class='hs-comment'>-- XXX: Explain pre-conditions</span>
<a name="line-1325"></a><span class='hs-definition'>getModuleSourceAndFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>StringBuffer</span><span class='hs-layout'>,</span> <span class='hs-conid'>DynFlags</span><span class='hs-layout'>)</span>
<a name="line-1326"></a><span class='hs-definition'>getModuleSourceAndFlags</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1327"></a>  <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModSummary</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-1328"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ml_hs_file</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ms_location</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-1329"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1330"></a>                  <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkApiErr</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"No source available for module "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-1331"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>sourceFile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1332"></a>        <span class='hs-varid'>source</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hGetStringBuffer</span> <span class='hs-varid'>sourceFile</span>
<a name="line-1333"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sourceFile</span><span class='hs-layout'>,</span> <span class='hs-varid'>source</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_hspp_opts</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1334"></a>
<a name="line-1335"></a>
<a name="line-1336"></a><a name="getTokenStream"></a><span class='hs-comment'>-- | Return module source as token stream, including comments.</span>
<a name="line-1337"></a><span class='hs-comment'>--</span>
<a name="line-1338"></a><span class='hs-comment'>-- The module must be in the module graph and its source must be available.</span>
<a name="line-1339"></a><span class='hs-comment'>-- Throws a 'HscTypes.SourceError' on parse error.</span>
<a name="line-1340"></a><span class='hs-definition'>getTokenStream</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Token</span><span class='hs-keyglyph'>]</span>
<a name="line-1341"></a><span class='hs-definition'>getTokenStream</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1342"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>sourceFile</span><span class='hs-layout'>,</span> <span class='hs-varid'>source</span><span class='hs-layout'>,</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModuleSourceAndFlags</span> <span class='hs-varid'>mod</span>
<a name="line-1343"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>startLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRealSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>sourceFile</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span>
<a name="line-1344"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>lexTokenStream</span> <span class='hs-varid'>source</span> <span class='hs-varid'>startLoc</span> <span class='hs-varid'>flags</span> <span class='hs-keyword'>of</span>
<a name="line-1345"></a>    <span class='hs-conid'>POk</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ts</span>
<a name="line-1346"></a>    <span class='hs-conid'>PFailed</span> <span class='hs-varid'>span</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1347"></a>        <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1348"></a>           <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkSrcErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainErrMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>span</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-1349"></a>
<a name="line-1350"></a><a name="getRichTokenStream"></a><span class='hs-comment'>-- | Give even more information on the source than 'getTokenStream'</span>
<a name="line-1351"></a><span class='hs-comment'>-- This function allows reconstructing the source completely with</span>
<a name="line-1352"></a><span class='hs-comment'>-- 'showRichTokenStream'.</span>
<a name="line-1353"></a><span class='hs-definition'>getRichTokenStream</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Token</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1354"></a><span class='hs-definition'>getRichTokenStream</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1355"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>sourceFile</span><span class='hs-layout'>,</span> <span class='hs-varid'>source</span><span class='hs-layout'>,</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModuleSourceAndFlags</span> <span class='hs-varid'>mod</span>
<a name="line-1356"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>startLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRealSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>sourceFile</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span>
<a name="line-1357"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>lexTokenStream</span> <span class='hs-varid'>source</span> <span class='hs-varid'>startLoc</span> <span class='hs-varid'>flags</span> <span class='hs-keyword'>of</span>
<a name="line-1358"></a>    <span class='hs-conid'>POk</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addSourceToTokens</span> <span class='hs-varid'>startLoc</span> <span class='hs-varid'>source</span> <span class='hs-varid'>ts</span>
<a name="line-1359"></a>    <span class='hs-conid'>PFailed</span> <span class='hs-varid'>span</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1360"></a>        <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1361"></a>           <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkSrcErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainErrMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>span</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-1362"></a>
<a name="line-1363"></a><a name="addSourceToTokens"></a><span class='hs-comment'>-- | Given a source location and a StringBuffer corresponding to this</span>
<a name="line-1364"></a><span class='hs-comment'>-- location, return a rich token stream with the source associated to the</span>
<a name="line-1365"></a><span class='hs-comment'>-- tokens.</span>
<a name="line-1366"></a><span class='hs-definition'>addSourceToTokens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RealSrcLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StringBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Token</span><span class='hs-keyglyph'>]</span>
<a name="line-1367"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Token</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1368"></a><span class='hs-definition'>addSourceToTokens</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1369"></a><span class='hs-definition'>addSourceToTokens</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>buf</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-1370"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>span</span> <span class='hs-keyword'>of</span>
<a name="line-1371"></a>      <span class='hs-conid'>UnhelpfulSpan</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>addSourceToTokens</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>ts</span>
<a name="line-1372"></a>      <span class='hs-conid'>RealSrcSpan</span> <span class='hs-varid'>s</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>addSourceToTokens</span> <span class='hs-varid'>newLoc</span> <span class='hs-varid'>newBuf</span> <span class='hs-varid'>ts</span>
<a name="line-1373"></a>        <span class='hs-keyword'>where</span>
<a name="line-1374"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>newLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>newBuf</span><span class='hs-layout'>,</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-str'>""</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>buf</span>
<a name="line-1375"></a>          <span class='hs-varid'>start</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realSrcSpanStart</span> <span class='hs-varid'>s</span>
<a name="line-1376"></a>          <span class='hs-varid'>end</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realSrcSpanEnd</span> <span class='hs-varid'>s</span>
<a name="line-1377"></a>          <span class='hs-varid'>go</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>start</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>nLoc</span> <span class='hs-varid'>nBuf</span>
<a name="line-1378"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>start</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>end</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>ch</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>nLoc</span> <span class='hs-varid'>nBuf</span>
<a name="line-1379"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>buf</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-1380"></a>              <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>ch</span><span class='hs-layout'>,</span> <span class='hs-varid'>nBuf</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nextChar</span> <span class='hs-varid'>buf</span>
<a name="line-1381"></a>                    <span class='hs-varid'>nLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>advanceSrcLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ch</span>
<a name="line-1382"></a>
<a name="line-1383"></a>
<a name="line-1384"></a><a name="showRichTokenStream"></a><span class='hs-comment'>-- | Take a rich token stream such as produced from 'getRichTokenStream' and</span>
<a name="line-1385"></a><span class='hs-comment'>-- return source code almost identical to the original code (except for</span>
<a name="line-1386"></a><span class='hs-comment'>-- insignificant whitespace.)</span>
<a name="line-1387"></a><span class='hs-definition'>showRichTokenStream</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Token</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-1388"></a><span class='hs-definition'>showRichTokenStream</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>startLoc</span> <span class='hs-varid'>ts</span> <span class='hs-str'>""</span>
<a name="line-1389"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>sourceFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getFile</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span>
<a name="line-1390"></a>          <span class='hs-varid'>getFile</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"showRichTokenStream: No source file found"</span>
<a name="line-1391"></a>          <span class='hs-varid'>getFile</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnhelpfulSpan</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getFile</span> <span class='hs-varid'>xs</span>
<a name="line-1392"></a>          <span class='hs-varid'>getFile</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealSrcSpan</span> <span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcSpanFile</span> <span class='hs-varid'>s</span>
<a name="line-1393"></a>          <span class='hs-varid'>startLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRealSrcLoc</span> <span class='hs-varid'>sourceFile</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span>
<a name="line-1394"></a>          <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-1395"></a>          <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-1396"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>span</span> <span class='hs-keyword'>of</span>
<a name="line-1397"></a>                <span class='hs-conid'>UnhelpfulSpan</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ts</span>
<a name="line-1398"></a>                <span class='hs-conid'>RealSrcSpan</span> <span class='hs-varid'>s</span>
<a name="line-1399"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>locLine</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tokLine</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>tokCol</span> <span class='hs-comment'>-</span> <span class='hs-varid'>locCol</span><span class='hs-layout'>)</span> <span class='hs-chr'>' '</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span>
<a name="line-1400"></a>                                       <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>str</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span>
<a name="line-1401"></a>                                       <span class='hs-varop'>.</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tokEnd</span> <span class='hs-varid'>ts</span>
<a name="line-1402"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>tokLine</span> <span class='hs-comment'>-</span> <span class='hs-varid'>locLine</span><span class='hs-layout'>)</span> <span class='hs-chr'>'\n'</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span>
<a name="line-1403"></a>                               <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>tokCol</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-chr'>' '</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span>
<a name="line-1404"></a>                              <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>str</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span>
<a name="line-1405"></a>                              <span class='hs-varop'>.</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tokEnd</span> <span class='hs-varid'>ts</span>
<a name="line-1406"></a>                  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>locLine</span><span class='hs-layout'>,</span> <span class='hs-varid'>locCol</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcLocLine</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcLocCol</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-1407"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>tokLine</span><span class='hs-layout'>,</span> <span class='hs-varid'>tokCol</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStartLine</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanStartCol</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1408"></a>                        <span class='hs-varid'>tokEnd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realSrcSpanEnd</span> <span class='hs-varid'>s</span>
<a name="line-1409"></a>
<a name="line-1410"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1411"></a><span class='hs-comment'>-- Interactive evaluation</span>
<a name="line-1412"></a>
<a name="line-1413"></a><a name="findModule"></a><span class='hs-comment'>-- | Takes a 'ModuleName' and possibly a 'UnitId', and consults the</span>
<a name="line-1414"></a><span class='hs-comment'>-- filesystem and package database to find the corresponding 'Module',</span>
<a name="line-1415"></a><span class='hs-comment'>-- using the algorithm that is used for an @import@ declaration.</span>
<a name="line-1416"></a><span class='hs-definition'>findModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Module</span>
<a name="line-1417"></a><span class='hs-definition'>findModule</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>maybe_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1418"></a>  <span class='hs-keyword'>let</span>
<a name="line-1419"></a>    <span class='hs-varid'>dflags</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1420"></a>    <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span>
<a name="line-1421"></a>  <span class='hs-comment'>--</span>
<a name="line-1422"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_pkg</span> <span class='hs-keyword'>of</span>
<a name="line-1423"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fsToUnitId</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"this"</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1424"></a>      <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findImportedModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>maybe_pkg</span>
<a name="line-1425"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-1426"></a>        <span class='hs-conid'>Found</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>m</span>
<a name="line-1427"></a>        <span class='hs-varid'>err</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwOneError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>noModError</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>err</span>
<a name="line-1428"></a>    <span class='hs-sel'>_otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1429"></a>      <span class='hs-varid'>home</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLoadedHomeModule</span> <span class='hs-varid'>mod_name</span>
<a name="line-1430"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>home</span> <span class='hs-keyword'>of</span>
<a name="line-1431"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>m</span>
<a name="line-1432"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1433"></a>           <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findImportedModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>maybe_pkg</span>
<a name="line-1434"></a>           <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-1435"></a>             <span class='hs-conid'>Found</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>moduleUnitId</span> <span class='hs-varid'>m</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>m</span>
<a name="line-1436"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>modNotLoadedError</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span>
<a name="line-1437"></a>             <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwOneError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>noModError</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>err</span>
<a name="line-1438"></a>
<a name="line-1439"></a><a name="modNotLoadedError"></a><span class='hs-definition'>modNotLoadedError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-1440"></a><span class='hs-definition'>modNotLoadedError</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CmdLineError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-1441"></a>   <span class='hs-varid'>text</span> <span class='hs-str'>"module is not loaded:"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1442"></a>   <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1443"></a>   <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"modNotLoadedError"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ml_hs_file</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1444"></a>
<a name="line-1445"></a><a name="lookupModule"></a><span class='hs-comment'>-- | Like 'findModule', but differs slightly when the module refers to</span>
<a name="line-1446"></a><span class='hs-comment'>-- a source file, and the file has not been loaded via 'load'.  In</span>
<a name="line-1447"></a><span class='hs-comment'>-- this case, 'findModule' will throw an error (module not loaded),</span>
<a name="line-1448"></a><span class='hs-comment'>-- but 'lookupModule' will check to see whether the module can also be</span>
<a name="line-1449"></a><span class='hs-comment'>-- found in a package, and if so, that package 'Module' will be</span>
<a name="line-1450"></a><span class='hs-comment'>-- returned.  If not, the usual module-not-found error will be thrown.</span>
<a name="line-1451"></a><span class='hs-comment'>--</span>
<a name="line-1452"></a><span class='hs-definition'>lookupModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Module</span>
<a name="line-1453"></a><span class='hs-definition'>lookupModule</span> <span class='hs-varid'>mod_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findModule</span> <span class='hs-varid'>mod_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-1454"></a><span class='hs-definition'>lookupModule</span> <span class='hs-varid'>mod_name</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1455"></a>  <span class='hs-varid'>home</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLoadedHomeModule</span> <span class='hs-varid'>mod_name</span>
<a name="line-1456"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>home</span> <span class='hs-keyword'>of</span>
<a name="line-1457"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>m</span>
<a name="line-1458"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1459"></a>      <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findExposedPackageModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_name</span> <span class='hs-conid'>Nothing</span>
<a name="line-1460"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-1461"></a>        <span class='hs-conid'>Found</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>m</span>
<a name="line-1462"></a>        <span class='hs-varid'>err</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwOneError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>noModError</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>err</span>
<a name="line-1463"></a>
<a name="line-1464"></a><a name="lookupLoadedHomeModule"></a><span class='hs-definition'>lookupLoadedHomeModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Module</span><span class='hs-layout'>)</span>
<a name="line-1465"></a><span class='hs-definition'>lookupLoadedHomeModule</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1466"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupHpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyword'>of</span>
<a name="line-1467"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>mod_info</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_module</span> <span class='hs-layout'>(</span><span class='hs-varid'>hm_iface</span> <span class='hs-varid'>mod_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1468"></a>    <span class='hs-sel'>_not_a_home_module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1469"></a>
<a name="line-1470"></a><a name="isModuleTrusted"></a><span class='hs-comment'>-- | Check that a module is safe to import (according to Safe Haskell).</span>
<a name="line-1471"></a><span class='hs-comment'>--</span>
<a name="line-1472"></a><span class='hs-comment'>-- We return True to indicate the import is safe and False otherwise</span>
<a name="line-1473"></a><span class='hs-comment'>-- although in the False case an error may be thrown first.</span>
<a name="line-1474"></a><span class='hs-definition'>isModuleTrusted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Bool</span>
<a name="line-1475"></a><span class='hs-definition'>isModuleTrusted</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1476"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscCheckSafe</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>m</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-1477"></a>
<a name="line-1478"></a><a name="moduleTrustReqs"></a><span class='hs-comment'>-- | Return if a module is trusted and the pkgs it depends on to be trusted.</span>
<a name="line-1479"></a><span class='hs-definition'>moduleTrustReqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>InstalledUnitId</span><span class='hs-layout'>)</span>
<a name="line-1480"></a><span class='hs-definition'>moduleTrustReqs</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1481"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscGetSafe</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>m</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-1482"></a>
<a name="line-1483"></a><a name="setGHCiMonad"></a><span class='hs-comment'>-- | Set the monad GHCi lifts user statements into.</span>
<a name="line-1484"></a><span class='hs-comment'>--</span>
<a name="line-1485"></a><span class='hs-comment'>-- Checks that a type (in string form) is an instance of the</span>
<a name="line-1486"></a><span class='hs-comment'>-- @GHC.GHCi.GHCiSandboxIO@ type class. Sets it to be the GHCi monad if it is,</span>
<a name="line-1487"></a><span class='hs-comment'>-- throws an error otherwise.</span>
<a name="line-1488"></a><span class='hs-definition'>setGHCiMonad</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-1489"></a><span class='hs-definition'>setGHCiMonad</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1490"></a>    <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscIsGHCiMonad</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span>
<a name="line-1491"></a>    <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1492"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_monad</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-1493"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>s</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>}</span>
<a name="line-1494"></a>
<a name="line-1495"></a><a name="getGHCiMonad"></a><span class='hs-comment'>-- | Get the monad GHCi lifts user statements into.</span>
<a name="line-1496"></a><span class='hs-definition'>getGHCiMonad</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Name</span>
<a name="line-1497"></a><span class='hs-definition'>getGHCiMonad</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_monad</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsc_IC</span><span class='hs-layout'>)</span> <span class='hs-varid'>getSession</span>
<a name="line-1498"></a>
<a name="line-1499"></a><a name="getHistorySpan"></a><span class='hs-definition'>getHistorySpan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>History</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-1500"></a><span class='hs-definition'>getHistorySpan</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1501"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>InteractiveEval</span><span class='hs-varop'>.</span><span class='hs-varid'>getHistorySpan</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>h</span>
<a name="line-1502"></a>
<a name="line-1503"></a><a name="obtainTermFromVal"></a><span class='hs-definition'>obtainTermFromVal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Term</span>
<a name="line-1504"></a><span class='hs-definition'>obtainTermFromVal</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>force</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1505"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>InteractiveEval</span><span class='hs-varop'>.</span><span class='hs-varid'>obtainTermFromVal</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>force</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>a</span>
<a name="line-1506"></a>
<a name="line-1507"></a><a name="obtainTermFromId"></a><span class='hs-definition'>obtainTermFromId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Term</span>
<a name="line-1508"></a><span class='hs-definition'>obtainTermFromId</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>force</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1509"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>InteractiveEval</span><span class='hs-varop'>.</span><span class='hs-varid'>obtainTermFromId</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>force</span> <span class='hs-varid'>id</span>
<a name="line-1510"></a>
<a name="line-1511"></a>
<a name="line-1512"></a><a name="lookupName"></a><span class='hs-comment'>-- | Returns the 'TyThing' for a 'Name'.  The 'Name' may refer to any</span>
<a name="line-1513"></a><span class='hs-comment'>-- entity known to GHC, including 'Name's defined using 'runStmt'.</span>
<a name="line-1514"></a><span class='hs-definition'>lookupName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyThing</span><span class='hs-layout'>)</span>
<a name="line-1515"></a><span class='hs-definition'>lookupName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span>
<a name="line-1516"></a>     <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1517"></a>       <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscTcRcLookupName</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span>
<a name="line-1518"></a>
<a name="line-1519"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-1520"></a><span class='hs-comment'>-- Pure API</span>
<a name="line-1521"></a>
<a name="line-1522"></a><a name="parser"></a><span class='hs-comment'>-- | A pure interface to the module parser.</span>
<a name="line-1523"></a><span class='hs-comment'>--</span>
<a name="line-1524"></a><span class='hs-definition'>parser</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>         <span class='hs-comment'>-- ^ Haskell module source text (full Unicode is supported)</span>
<a name="line-1525"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span>       <span class='hs-comment'>-- ^ the flags</span>
<a name="line-1526"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>       <span class='hs-comment'>-- ^ the filename (for source locations)</span>
<a name="line-1527"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>ErrorMessages</span> <span class='hs-layout'>(</span><span class='hs-conid'>WarningMessages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsModule</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1528"></a>
<a name="line-1529"></a><span class='hs-definition'>parser</span> <span class='hs-varid'>str</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>filename</span> <span class='hs-keyglyph'>=</span>
<a name="line-1530"></a>   <span class='hs-keyword'>let</span>
<a name="line-1531"></a>       <span class='hs-varid'>loc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRealSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>filename</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span>
<a name="line-1532"></a>       <span class='hs-varid'>buf</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stringToStringBuffer</span> <span class='hs-varid'>str</span>
<a name="line-1533"></a>   <span class='hs-keyword'>in</span>
<a name="line-1534"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>unP</span> <span class='hs-conid'>Parser</span><span class='hs-varop'>.</span><span class='hs-varid'>parseModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPState</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1535"></a>
<a name="line-1536"></a>     <span class='hs-conid'>PFailed</span> <span class='hs-varid'>span</span> <span class='hs-varid'>err</span>   <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1537"></a>         <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPlainErrMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>span</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1538"></a>
<a name="line-1539"></a>     <span class='hs-conid'>POk</span> <span class='hs-varid'>pst</span> <span class='hs-varid'>rdr_module</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1540"></a>         <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getMessages</span> <span class='hs-varid'>pst</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>in</span>
<a name="line-1541"></a>         <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span> <span class='hs-varid'>rdr_module</span><span class='hs-layout'>)</span>
</pre></body>
</html>
