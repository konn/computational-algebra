<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>main/SysTools.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>-----------------------------------------------------------------------------
<a name="line-3"></a>--
<a name="line-4"></a>-- (c) The University of Glasgow 2001-2003
<a name="line-5"></a>--
<a name="line-6"></a>-- Access to system tools: gcc, cp, rm etc
<a name="line-7"></a>--
<a name="line-8"></a>-----------------------------------------------------------------------------
<a name="line-9"></a>-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>{-# LANGUAGE CPP, MultiWayIf, ScopedTypeVariables #-}</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>SysTools</span> <span class='hs-layout'>(</span>
<a name="line-14"></a>        <span class='hs-comment'>-- Initialisation</span>
<a name="line-15"></a>        <span class='hs-varid'>initSysTools</span><span class='hs-layout'>,</span>
<a name="line-16"></a>
<a name="line-17"></a>        <span class='hs-comment'>-- Interface to system tools</span>
<a name="line-18"></a>        <span class='hs-varid'>runUnlit</span><span class='hs-layout'>,</span> <span class='hs-varid'>runCpp</span><span class='hs-layout'>,</span> <span class='hs-varid'>runCc</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- [Option] -&gt; IO ()</span>
<a name="line-19"></a>        <span class='hs-varid'>runPp</span><span class='hs-layout'>,</span>                   <span class='hs-comment'>-- [Option] -&gt; IO ()</span>
<a name="line-20"></a>        <span class='hs-varid'>runSplit</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- [Option] -&gt; IO ()</span>
<a name="line-21"></a>        <span class='hs-varid'>runAs</span><span class='hs-layout'>,</span> <span class='hs-varid'>runLink</span><span class='hs-layout'>,</span> <span class='hs-varid'>runLibtool</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- [Option] -&gt; IO ()</span>
<a name="line-22"></a>        <span class='hs-varid'>runMkDLL</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>runWindres</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>runLlvmOpt</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>runLlvmLlc</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>runClang</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>figureLlvmVersion</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-varid'>getLinkerInfo</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>getCompilerInfo</span><span class='hs-layout'>,</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-varid'>linkDynLib</span><span class='hs-layout'>,</span>
<a name="line-33"></a>
<a name="line-34"></a>        <span class='hs-varid'>askLd</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-varid'>touch</span><span class='hs-layout'>,</span>                  <span class='hs-comment'>-- String -&gt; String -&gt; IO ()</span>
<a name="line-37"></a>        <span class='hs-varid'>copy</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>copyWithHeader</span><span class='hs-layout'>,</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-comment'>-- Temporary-file management</span>
<a name="line-41"></a>        <span class='hs-varid'>setTmpDir</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>newTempName</span><span class='hs-layout'>,</span> <span class='hs-varid'>newTempLibName</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>cleanTempDirs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanTempFiles</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanTempFilesExcept</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>addFilesToClean</span><span class='hs-layout'>,</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-conid'>Option</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-comment'>-- platform-specifics</span>
<a name="line-49"></a>        <span class='hs-varid'>libmLinkOpts</span><span class='hs-layout'>,</span>
<a name="line-50"></a>
<a name="line-51"></a>        <span class='hs-comment'>-- frameworks</span>
<a name="line-52"></a>        <span class='hs-varid'>getPkgFrameworkOpts</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-varid'>getFrameworkOpts</span>
<a name="line-54"></a>
<a name="line-55"></a>
<a name="line-56"></a> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DriverPhases</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Packages</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Config</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Exception</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LlvmCodeGen</span><span class='hs-varop'>.</span><span class='hs-conid'>Base</span> <span class='hs-layout'>(</span><span class='hs-varid'>llvmVersionStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>supportedLlvmVersion</span><span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Exit</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Environment</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Error</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>IO</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Directory</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-86"></a>
<a name="line-87"></a><span class='hs-cpp'>#ifndef mingw32_HOST_OS</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Posix</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span>
<a name="line-89"></a><span class='hs-cpp'>#else /* Must be Win32 */</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>C</span><span class='hs-varop'>.</span><span class='hs-conid'>String</span>
<a name="line-92"></a><span class='hs-cpp'>#if MIN_VERSION_Win32(2,5,0)</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Win32</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Win32</span>
<a name="line-94"></a><span class='hs-cpp'>#else</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Win32</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Win32</span>
<a name="line-96"></a><span class='hs-cpp'>#endif</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Win32</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span> <span class='hs-layout'>(</span><span class='hs-conid'>DWORD</span><span class='hs-layout'>,</span> <span class='hs-conid'>LPTSTR</span><span class='hs-layout'>,</span> <span class='hs-conid'>HANDLE</span><span class='hs-layout'>)</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Win32</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span> <span class='hs-layout'>(</span><span class='hs-varid'>failIfNull</span><span class='hs-layout'>,</span> <span class='hs-varid'>failIf</span><span class='hs-layout'>,</span> <span class='hs-varid'>iNVALID_HANDLE_VALUE</span><span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Win32</span><span class='hs-varop'>.</span><span class='hs-conid'>File</span> <span class='hs-layout'>(</span><span class='hs-varid'>createFile</span><span class='hs-layout'>,</span><span class='hs-varid'>closeHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>gENERIC_READ</span><span class='hs-layout'>,</span> <span class='hs-varid'>fILE_SHARE_READ</span><span class='hs-layout'>,</span> <span class='hs-varid'>oPEN_EXISTING</span><span class='hs-layout'>,</span> <span class='hs-varid'>fILE_ATTRIBUTE_NORMAL</span><span class='hs-layout'>,</span> <span class='hs-varid'>fILE_FLAG_BACKUP_SEMANTICS</span> <span class='hs-layout'>)</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Win32</span><span class='hs-varop'>.</span><span class='hs-conid'>DLL</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadLibrary</span><span class='hs-layout'>,</span> <span class='hs-varid'>getProcAddress</span><span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-cpp'>#endif</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Process</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>SrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>noSrcSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSrcSpan</span> <span class='hs-layout'>)</span>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-cpp'>#ifdef mingw32_HOST_OS</span>
<a name="line-109"></a><span class='hs-cpp'># if defined(i386_HOST_ARCH)</span>
<a name="line-110"></a><span class='hs-cpp'>#  define WINDOWS_CCONV stdcall</span>
<a name="line-111"></a><span class='hs-cpp'># elif defined(x86_64_HOST_ARCH)</span>
<a name="line-112"></a><span class='hs-cpp'>#  define WINDOWS_CCONV ccall</span>
<a name="line-113"></a><span class='hs-cpp'># else</span>
<a name="line-114"></a><span class='hs-cpp'>#  error Unknown mingw32 arch</span>
<a name="line-115"></a><span class='hs-cpp'># endif</span>
<a name="line-116"></a><span class='hs-cpp'>#endif</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-comment'>{-
<a name="line-119"></a>How GHC finds its files
<a name="line-120"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-121"></a>
<a name="line-122"></a>[Note topdir]
<a name="line-123"></a>
<a name="line-124"></a>GHC needs various support files (library packages, RTS etc), plus
<a name="line-125"></a>various auxiliary programs (cp, gcc, etc).  It starts by finding topdir,
<a name="line-126"></a>the root of GHC's support files
<a name="line-127"></a>
<a name="line-128"></a>On Unix:
<a name="line-129"></a>  - ghc always has a shell wrapper that passes a -B&lt;dir&gt; option
<a name="line-130"></a>
<a name="line-131"></a>On Windows:
<a name="line-132"></a>  - ghc never has a shell wrapper.
<a name="line-133"></a>  - we can find the location of the ghc binary, which is
<a name="line-134"></a>        $topdir/&lt;foo&gt;/&lt;something&gt;.exe
<a name="line-135"></a>    where &lt;something&gt; may be "ghc", "ghc-stage2", or similar
<a name="line-136"></a>  - we strip off the "&lt;foo&gt;/&lt;something&gt;.exe" to leave $topdir.
<a name="line-137"></a>
<a name="line-138"></a>from topdir we can find package.conf, ghc-asm, etc.
<a name="line-139"></a>
<a name="line-140"></a>
<a name="line-141"></a>SysTools.initSysProgs figures out exactly where all the auxiliary programs
<a name="line-142"></a>are, and initialises mutable variables to make it easy to call them.
<a name="line-143"></a>To to this, it makes use of definitions in Config.hs, which is a Haskell
<a name="line-144"></a>file containing variables whose value is figured out by the build system.
<a name="line-145"></a>
<a name="line-146"></a>Config.hs contains two sorts of things
<a name="line-147"></a>
<a name="line-148"></a>  cGCC,         The *names* of the programs
<a name="line-149"></a>  cCPP            e.g.  cGCC = gcc
<a name="line-150"></a>  cUNLIT                cCPP = gcc -E
<a name="line-151"></a>  etc           They do *not* include paths
<a name="line-152"></a>
<a name="line-153"></a>
<a name="line-154"></a>  cUNLIT_DIR   The *path* to the directory containing unlit, split etc
<a name="line-155"></a>  cSPLIT_DIR   *relative* to the root of the build tree,
<a name="line-156"></a>                   for use when running *in-place* in a build tree (only)
<a name="line-157"></a>
<a name="line-158"></a>
<a name="line-159"></a>
<a name="line-160"></a>---------------------------------------------
<a name="line-161"></a>NOTES for an ALTERNATIVE scheme (i.e *not* what is currently implemented):
<a name="line-162"></a>
<a name="line-163"></a>Another hair-brained scheme for simplifying the current tool location
<a name="line-164"></a>nightmare in GHC: Simon originally suggested using another
<a name="line-165"></a>configuration file along the lines of GCC's specs file - which is fine
<a name="line-166"></a>except that it means adding code to read yet another configuration
<a name="line-167"></a>file.  What I didn't notice is that the current package.conf is
<a name="line-168"></a>general enough to do this:
<a name="line-169"></a>
<a name="line-170"></a>Package
<a name="line-171"></a>    {name = "tools",    import_dirs = [],  source_dirs = [],
<a name="line-172"></a>     library_dirs = [], hs_libraries = [], extra_libraries = [],
<a name="line-173"></a>     include_dirs = [], c_includes = [],   package_deps = [],
<a name="line-174"></a>     extra_ghc_opts = ["-pgmc/usr/bin/gcc","-pgml${topdir}/bin/unlit", ... etc.],
<a name="line-175"></a>     extra_cc_opts = [], extra_ld_opts = []}
<a name="line-176"></a>
<a name="line-177"></a>Which would have the advantage that we get to collect together in one
<a name="line-178"></a>place the path-specific package stuff with the path-specific tool
<a name="line-179"></a>stuff.
<a name="line-180"></a>                End of NOTES
<a name="line-181"></a>---------------------------------------------
<a name="line-182"></a>
<a name="line-183"></a>************************************************************************
<a name="line-184"></a>*                                                                      *
<a name="line-185"></a>\subsection{Initialisation}
<a name="line-186"></a>*                                                                      *
<a name="line-187"></a>************************************************************************
<a name="line-188"></a>-}</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="initSysTools"></a><span class='hs-definition'>initSysTools</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span>    <span class='hs-comment'>-- Maybe TopDir path (without the '-B' prefix)</span>
<a name="line-191"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Settings</span>     <span class='hs-comment'>-- Set all the mutable variables above, holding</span>
<a name="line-192"></a>                                <span class='hs-comment'>--      (a) the system programs</span>
<a name="line-193"></a>                                <span class='hs-comment'>--      (b) the package-config file</span>
<a name="line-194"></a>                                <span class='hs-comment'>--      (c) the GHC usage message</span>
<a name="line-195"></a><span class='hs-definition'>initSysTools</span> <span class='hs-varid'>mbMinusB</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>top_dir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findTopDir</span> <span class='hs-varid'>mbMinusB</span>
<a name="line-197"></a>             <span class='hs-comment'>-- see [Note topdir]</span>
<a name="line-198"></a>             <span class='hs-comment'>-- NB: top_dir is assumed to be in standard Unix</span>
<a name="line-199"></a>             <span class='hs-comment'>-- format, '/' separated</span>
<a name="line-200"></a>
<a name="line-201"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>settingsFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"settings"</span>
<a name="line-202"></a>           <span class='hs-varid'>platformConstantsFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"platformConstants"</span>
<a name="line-203"></a>           <span class='hs-varid'>installed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-204"></a>           <span class='hs-varid'>installed</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>file</span>
<a name="line-205"></a>           <span class='hs-varid'>libexec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-206"></a>           <span class='hs-varid'>libexec</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"bin"</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>file</span>
<a name="line-207"></a>
<a name="line-208"></a>       <span class='hs-varid'>settingsStr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readFile</span> <span class='hs-varid'>settingsFile</span>
<a name="line-209"></a>       <span class='hs-varid'>platformConstantsStr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readFile</span> <span class='hs-varid'>platformConstantsFile</span>
<a name="line-210"></a>       <span class='hs-varid'>mySettings</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeReadFuzzy</span> <span class='hs-varid'>settingsStr</span> <span class='hs-keyword'>of</span>
<a name="line-211"></a>                     <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-212"></a>                         <span class='hs-varid'>return</span> <span class='hs-varid'>s</span>
<a name="line-213"></a>                     <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-214"></a>                         <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"Can't parse "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>settingsFile</span><span class='hs-layout'>)</span>
<a name="line-215"></a>       <span class='hs-varid'>platformConstants</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeReadFuzzy</span> <span class='hs-varid'>platformConstantsStr</span> <span class='hs-keyword'>of</span>
<a name="line-216"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-217"></a>                                <span class='hs-varid'>return</span> <span class='hs-varid'>s</span>
<a name="line-218"></a>                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-219"></a>                                <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"Can't parse "</span> <span class='hs-varop'>++</span>
<a name="line-220"></a>                                          <span class='hs-varid'>show</span> <span class='hs-varid'>platformConstantsFile</span><span class='hs-layout'>)</span>
<a name="line-221"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>getSetting</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>key</span> <span class='hs-varid'>mySettings</span> <span class='hs-keyword'>of</span>
<a name="line-222"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-223"></a>                                <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stripPrefix</span> <span class='hs-str'>"$topdir"</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-224"></a>                                         <span class='hs-conid'>Just</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-225"></a>                                             <span class='hs-varid'>top_dir</span>
<a name="line-226"></a>                                         <span class='hs-conid'>Just</span> <span class='hs-varid'>xs'</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-227"></a>                                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-228"></a>                                             <span class='hs-varid'>top_dir</span> <span class='hs-varop'>++</span> <span class='hs-varid'>xs'</span>
<a name="line-229"></a>                                         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-230"></a>                                             <span class='hs-varid'>xs</span>
<a name="line-231"></a>                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"No entry for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>" in "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>settingsFile</span><span class='hs-layout'>)</span>
<a name="line-232"></a>           <span class='hs-varid'>getBooleanSetting</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>key</span> <span class='hs-varid'>mySettings</span> <span class='hs-keyword'>of</span>
<a name="line-233"></a>                                   <span class='hs-conid'>Just</span> <span class='hs-str'>"YES"</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-234"></a>                                   <span class='hs-conid'>Just</span> <span class='hs-str'>"NO"</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-235"></a>                                   <span class='hs-conid'>Just</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"Bad value for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>": "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-236"></a>                                   <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"No entry for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>" in "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>settingsFile</span><span class='hs-layout'>)</span>
<a name="line-237"></a>           <span class='hs-varid'>readSetting</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>key</span> <span class='hs-varid'>mySettings</span> <span class='hs-keyword'>of</span>
<a name="line-238"></a>                             <span class='hs-conid'>Just</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-239"></a>                                 <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeRead</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-240"></a>                                 <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-241"></a>                                 <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"Failed to read "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>" value "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-242"></a>                             <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"No entry for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>" in "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>settingsFile</span><span class='hs-layout'>)</span>
<a name="line-243"></a>       <span class='hs-varid'>crossCompiling</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"cross compiling"</span>
<a name="line-244"></a>       <span class='hs-varid'>targetArch</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target arch"</span>
<a name="line-245"></a>       <span class='hs-varid'>targetOS</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target os"</span>
<a name="line-246"></a>       <span class='hs-varid'>targetWordSize</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target word size"</span>
<a name="line-247"></a>       <span class='hs-varid'>targetUnregisterised</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"Unregisterised"</span>
<a name="line-248"></a>       <span class='hs-varid'>targetHasGnuNonexecStack</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target has GNU nonexec stack"</span>
<a name="line-249"></a>       <span class='hs-varid'>targetHasIdentDirective</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target has .ident directive"</span>
<a name="line-250"></a>       <span class='hs-varid'>targetHasSubsectionsViaSymbols</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target has subsections via symbols"</span>
<a name="line-251"></a>       <span class='hs-varid'>myExtraGccViaCFlags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"GCC extra via C opts"</span>
<a name="line-252"></a>       <span class='hs-comment'>-- On Windows, mingw is distributed with GHC,</span>
<a name="line-253"></a>       <span class='hs-comment'>-- so we look in TopDir/../mingw/bin</span>
<a name="line-254"></a>       <span class='hs-comment'>-- It would perhaps be nice to be able to override this</span>
<a name="line-255"></a>       <span class='hs-comment'>-- with the settings file, but it would be a little fiddly</span>
<a name="line-256"></a>       <span class='hs-comment'>-- to make that possible, so for now you can't.</span>
<a name="line-257"></a>       <span class='hs-varid'>gcc_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"C compiler command"</span>
<a name="line-258"></a>       <span class='hs-varid'>gcc_args_str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"C compiler flags"</span>
<a name="line-259"></a>       <span class='hs-varid'>gccSupportsNoPie</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"C compiler supports -no-pie"</span>
<a name="line-260"></a>       <span class='hs-varid'>cpp_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"Haskell CPP command"</span>
<a name="line-261"></a>       <span class='hs-varid'>cpp_args_str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"Haskell CPP flags"</span>
<a name="line-262"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>unreg_gcc_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>targetUnregisterised</span>
<a name="line-263"></a>                            <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-DNO_REGS"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-DUSE_MINIINTERPRETER"</span><span class='hs-keyglyph'>]</span>
<a name="line-264"></a>                            <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-265"></a>           <span class='hs-comment'>-- TABLES_NEXT_TO_CODE affects the info table layout.</span>
<a name="line-266"></a>           <span class='hs-varid'>tntc_gcc_args</span>
<a name="line-267"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mkTablesNextToCode</span> <span class='hs-varid'>targetUnregisterised</span>
<a name="line-268"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-DTABLES_NEXT_TO_CODE"</span><span class='hs-keyglyph'>]</span>
<a name="line-269"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-270"></a>           <span class='hs-varid'>cpp_args</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>words</span> <span class='hs-varid'>cpp_args_str</span><span class='hs-layout'>)</span>
<a name="line-271"></a>           <span class='hs-varid'>gcc_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>words</span> <span class='hs-varid'>gcc_args_str</span>
<a name="line-272"></a>                               <span class='hs-varop'>++</span> <span class='hs-varid'>unreg_gcc_args</span>
<a name="line-273"></a>                               <span class='hs-varop'>++</span> <span class='hs-varid'>tntc_gcc_args</span><span class='hs-layout'>)</span>
<a name="line-274"></a>       <span class='hs-varid'>ldSupportsCompactUnwind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"ld supports compact unwind"</span>
<a name="line-275"></a>       <span class='hs-varid'>ldSupportsBuildId</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"ld supports build-id"</span>
<a name="line-276"></a>       <span class='hs-varid'>ldSupportsFilelist</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"ld supports filelist"</span>
<a name="line-277"></a>       <span class='hs-varid'>ldIsGnuLd</span>               <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"ld is GNU ld"</span>
<a name="line-278"></a>       <span class='hs-varid'>perl_path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"perl command"</span>
<a name="line-279"></a>
<a name="line-280"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>pkgconfig_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installed</span> <span class='hs-str'>"package.conf.d"</span>
<a name="line-281"></a>           <span class='hs-varid'>ghc_usage_msg_path</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installed</span> <span class='hs-str'>"ghc-usage.txt"</span>
<a name="line-282"></a>           <span class='hs-varid'>ghci_usage_msg_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installed</span> <span class='hs-str'>"ghci-usage.txt"</span>
<a name="line-283"></a>
<a name="line-284"></a>             <span class='hs-comment'>-- For all systems, unlit, split, mangle are GHC utilities</span>
<a name="line-285"></a>             <span class='hs-comment'>-- architecture-specific stuff is done when building Config.hs</span>
<a name="line-286"></a>           <span class='hs-varid'>unlit_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libexec</span> <span class='hs-varid'>cGHC_UNLIT_PGM</span>
<a name="line-287"></a>
<a name="line-288"></a>             <span class='hs-comment'>-- split is a Perl script</span>
<a name="line-289"></a>           <span class='hs-varid'>split_script</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libexec</span> <span class='hs-varid'>cGHC_SPLIT_PGM</span>
<a name="line-290"></a>
<a name="line-291"></a>       <span class='hs-varid'>windres_path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"windres command"</span>
<a name="line-292"></a>       <span class='hs-varid'>libtool_path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"libtool command"</span>
<a name="line-293"></a>
<a name="line-294"></a>       <span class='hs-varid'>tmpdir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTemporaryDirectory</span>
<a name="line-295"></a>
<a name="line-296"></a>       <span class='hs-varid'>touch_path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"touch command"</span>
<a name="line-297"></a>
<a name="line-298"></a>       <span class='hs-keyword'>let</span> <span class='hs-comment'>-- On Win32 we don't want to rely on #!/bin/perl, so we prepend</span>
<a name="line-299"></a>           <span class='hs-comment'>-- a call to Perl to get the invocation of split.</span>
<a name="line-300"></a>           <span class='hs-comment'>-- On Unix, scripts are invoked using the '#!' method.  Binary</span>
<a name="line-301"></a>           <span class='hs-comment'>-- installations of GHC on Unix place the correct line on the</span>
<a name="line-302"></a>           <span class='hs-comment'>-- front of the script at installation time, so we don't want</span>
<a name="line-303"></a>           <span class='hs-comment'>-- to wire-in our knowledge of $(PERL) on the host system here.</span>
<a name="line-304"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>split_prog</span><span class='hs-layout'>,</span>  <span class='hs-varid'>split_args</span><span class='hs-layout'>)</span>
<a name="line-305"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWindowsHost</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>perl_path</span><span class='hs-layout'>,</span>    <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-varid'>split_script</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-306"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>split_script</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-307"></a>       <span class='hs-varid'>mkdll_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"dllwrap command"</span>
<a name="line-308"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>mkdll_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-309"></a>
<a name="line-310"></a>       <span class='hs-comment'>-- cpp is derived from gcc on all platforms</span>
<a name="line-311"></a>       <span class='hs-comment'>-- HACK, see setPgmP below. We keep 'words' here to remember to fix</span>
<a name="line-312"></a>       <span class='hs-comment'>-- Config.hs one day.</span>
<a name="line-313"></a>
<a name="line-314"></a>
<a name="line-315"></a>       <span class='hs-comment'>-- Other things being equal, as and ld are simply gcc</span>
<a name="line-316"></a>       <span class='hs-varid'>gcc_link_args_str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"C compiler link flags"</span>
<a name="line-317"></a>       <span class='hs-keyword'>let</span>   <span class='hs-varid'>as_prog</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gcc_prog</span>
<a name="line-318"></a>             <span class='hs-varid'>as_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gcc_args</span>
<a name="line-319"></a>             <span class='hs-varid'>ld_prog</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gcc_prog</span>
<a name="line-320"></a>             <span class='hs-varid'>ld_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gcc_args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>words</span> <span class='hs-varid'>gcc_link_args_str</span><span class='hs-layout'>)</span>
<a name="line-321"></a>
<a name="line-322"></a>       <span class='hs-comment'>-- We just assume on command line</span>
<a name="line-323"></a>       <span class='hs-varid'>lc_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"LLVM llc command"</span>
<a name="line-324"></a>       <span class='hs-varid'>lo_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"LLVM opt command"</span>
<a name="line-325"></a>
<a name="line-326"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>iserv_prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libexec</span> <span class='hs-str'>"ghc-iserv"</span>
<a name="line-327"></a>
<a name="line-328"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Platform</span> <span class='hs-layout'>{</span>
<a name="line-329"></a>                          <span class='hs-varid'>platformArch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetArch</span><span class='hs-layout'>,</span>
<a name="line-330"></a>                          <span class='hs-varid'>platformOS</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetOS</span><span class='hs-layout'>,</span>
<a name="line-331"></a>                          <span class='hs-varid'>platformWordSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetWordSize</span><span class='hs-layout'>,</span>
<a name="line-332"></a>                          <span class='hs-varid'>platformUnregisterised</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetUnregisterised</span><span class='hs-layout'>,</span>
<a name="line-333"></a>                          <span class='hs-varid'>platformHasGnuNonexecStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetHasGnuNonexecStack</span><span class='hs-layout'>,</span>
<a name="line-334"></a>                          <span class='hs-varid'>platformHasIdentDirective</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetHasIdentDirective</span><span class='hs-layout'>,</span>
<a name="line-335"></a>                          <span class='hs-varid'>platformHasSubsectionsViaSymbols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetHasSubsectionsViaSymbols</span><span class='hs-layout'>,</span>
<a name="line-336"></a>                          <span class='hs-varid'>platformIsCrossCompiling</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>crossCompiling</span>
<a name="line-337"></a>                      <span class='hs-layout'>}</span>
<a name="line-338"></a>
<a name="line-339"></a>       <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Settings</span> <span class='hs-layout'>{</span>
<a name="line-340"></a>                    <span class='hs-varid'>sTargetPlatform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platform</span><span class='hs-layout'>,</span>
<a name="line-341"></a>                    <span class='hs-varid'>sTmpDir</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normalise</span> <span class='hs-varid'>tmpdir</span><span class='hs-layout'>,</span>
<a name="line-342"></a>                    <span class='hs-varid'>sGhcUsagePath</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ghc_usage_msg_path</span><span class='hs-layout'>,</span>
<a name="line-343"></a>                    <span class='hs-varid'>sGhciUsagePath</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ghci_usage_msg_path</span><span class='hs-layout'>,</span>
<a name="line-344"></a>                    <span class='hs-varid'>sTopDir</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span><span class='hs-layout'>,</span>
<a name="line-345"></a>                    <span class='hs-varid'>sRawSettings</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mySettings</span><span class='hs-layout'>,</span>
<a name="line-346"></a>                    <span class='hs-varid'>sExtraGccViaCFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>words</span> <span class='hs-varid'>myExtraGccViaCFlags</span><span class='hs-layout'>,</span>
<a name="line-347"></a>                    <span class='hs-varid'>sSystemPackageConfig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgconfig_path</span><span class='hs-layout'>,</span>
<a name="line-348"></a>                    <span class='hs-varid'>sLdSupportsCompactUnwind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldSupportsCompactUnwind</span><span class='hs-layout'>,</span>
<a name="line-349"></a>                    <span class='hs-varid'>sLdSupportsBuildId</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldSupportsBuildId</span><span class='hs-layout'>,</span>
<a name="line-350"></a>                    <span class='hs-varid'>sLdSupportsFilelist</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldSupportsFilelist</span><span class='hs-layout'>,</span>
<a name="line-351"></a>                    <span class='hs-varid'>sLdIsGnuLd</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldIsGnuLd</span><span class='hs-layout'>,</span>
<a name="line-352"></a>                    <span class='hs-varid'>sGccSupportsNoPie</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gccSupportsNoPie</span><span class='hs-layout'>,</span>
<a name="line-353"></a>                    <span class='hs-varid'>sProgramName</span>             <span class='hs-keyglyph'>=</span> <span class='hs-str'>"ghc"</span><span class='hs-layout'>,</span>
<a name="line-354"></a>                    <span class='hs-varid'>sProjectVersion</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cProjectVersion</span><span class='hs-layout'>,</span>
<a name="line-355"></a>                    <span class='hs-varid'>sPgm_L</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unlit_path</span><span class='hs-layout'>,</span>
<a name="line-356"></a>                    <span class='hs-varid'>sPgm_P</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpp_prog</span><span class='hs-layout'>,</span> <span class='hs-varid'>cpp_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-357"></a>                    <span class='hs-varid'>sPgm_F</span>   <span class='hs-keyglyph'>=</span> <span class='hs-str'>""</span><span class='hs-layout'>,</span>
<a name="line-358"></a>                    <span class='hs-varid'>sPgm_c</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>gcc_prog</span><span class='hs-layout'>,</span> <span class='hs-varid'>gcc_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-359"></a>                    <span class='hs-varid'>sPgm_s</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>split_prog</span><span class='hs-layout'>,</span><span class='hs-varid'>split_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-360"></a>                    <span class='hs-varid'>sPgm_a</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>as_prog</span><span class='hs-layout'>,</span> <span class='hs-varid'>as_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-361"></a>                    <span class='hs-varid'>sPgm_l</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ld_prog</span><span class='hs-layout'>,</span> <span class='hs-varid'>ld_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-362"></a>                    <span class='hs-varid'>sPgm_dll</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkdll_prog</span><span class='hs-layout'>,</span><span class='hs-varid'>mkdll_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-363"></a>                    <span class='hs-varid'>sPgm_T</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>touch_path</span><span class='hs-layout'>,</span>
<a name="line-364"></a>                    <span class='hs-varid'>sPgm_windres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>windres_path</span><span class='hs-layout'>,</span>
<a name="line-365"></a>                    <span class='hs-varid'>sPgm_libtool</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libtool_path</span><span class='hs-layout'>,</span>
<a name="line-366"></a>                    <span class='hs-varid'>sPgm_lo</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>lo_prog</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-367"></a>                    <span class='hs-varid'>sPgm_lc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>lc_prog</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-368"></a>                    <span class='hs-varid'>sPgm_i</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iserv_prog</span><span class='hs-layout'>,</span>
<a name="line-369"></a>                    <span class='hs-varid'>sOpt_L</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-370"></a>                    <span class='hs-varid'>sOpt_P</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-371"></a>                    <span class='hs-varid'>sOpt_F</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-372"></a>                    <span class='hs-varid'>sOpt_c</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-373"></a>                    <span class='hs-varid'>sOpt_a</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-374"></a>                    <span class='hs-varid'>sOpt_l</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-375"></a>                    <span class='hs-varid'>sOpt_windres</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-376"></a>                    <span class='hs-varid'>sOpt_lo</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-377"></a>                    <span class='hs-varid'>sOpt_lc</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-378"></a>                    <span class='hs-varid'>sOpt_i</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-379"></a>                    <span class='hs-varid'>sPlatformConstants</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformConstants</span>
<a name="line-380"></a>             <span class='hs-layout'>}</span>
<a name="line-381"></a>
<a name="line-382"></a><a name="findTopDir"></a><span class='hs-comment'>-- returns a Unix-format path (relying on getBaseDir to do so too)</span>
<a name="line-383"></a><span class='hs-definition'>findTopDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- Maybe TopDir path (without the '-B' prefix).</span>
<a name="line-384"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>String</span>    <span class='hs-comment'>-- TopDir (in Unix format '/' separated)</span>
<a name="line-385"></a><span class='hs-definition'>findTopDir</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>minusb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>normalise</span> <span class='hs-varid'>minusb</span><span class='hs-layout'>)</span>
<a name="line-386"></a><span class='hs-definition'>findTopDir</span> <span class='hs-conid'>Nothing</span>
<a name="line-387"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- Get directory of executable</span>
<a name="line-388"></a>         <span class='hs-varid'>maybe_exec_dir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBaseDir</span>
<a name="line-389"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_exec_dir</span> <span class='hs-keyword'>of</span>
<a name="line-390"></a>             <span class='hs-comment'>-- "Just" on Windows, "Nothing" on unix</span>
<a name="line-391"></a>             <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstallationError</span> <span class='hs-str'>"missing -B&lt;dir&gt; option"</span><span class='hs-layout'>)</span>
<a name="line-392"></a>             <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>dir</span>
<a name="line-393"></a>
<a name="line-394"></a><span class='hs-comment'>{-
<a name="line-395"></a>************************************************************************
<a name="line-396"></a>*                                                                      *
<a name="line-397"></a>\subsection{Running an external program}
<a name="line-398"></a>*                                                                      *
<a name="line-399"></a>************************************************************************
<a name="line-400"></a>-}</span>
<a name="line-401"></a>
<a name="line-402"></a><a name="runUnlit"></a><span class='hs-definition'>runUnlit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-403"></a><span class='hs-definition'>runUnlit</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-404"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_L</span> <span class='hs-varid'>dflags</span>
<a name="line-405"></a>      <span class='hs-varid'>opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_L</span>
<a name="line-406"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Literate pre-processor"</span> <span class='hs-varid'>prog</span>
<a name="line-407"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>opts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-408"></a>
<a name="line-409"></a><a name="runCpp"></a><span class='hs-definition'>runCpp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-410"></a><span class='hs-definition'>runCpp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>   <span class='hs-keyword'>do</span>
<a name="line-411"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_P</span> <span class='hs-varid'>dflags</span>
<a name="line-412"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_P</span><span class='hs-layout'>)</span>
<a name="line-413"></a>      <span class='hs-varid'>args2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-Werror"</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_WarnIsError</span> <span class='hs-varid'>dflags</span><span class='hs-keyglyph'>]</span>
<a name="line-414"></a>                <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-Wundef"</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnCPPUndef</span> <span class='hs-varid'>dflags</span><span class='hs-keyglyph'>]</span>
<a name="line-415"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-416"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span>  <span class='hs-str'>"C pre-processor"</span> <span class='hs-varid'>p</span>
<a name="line-417"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args2</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_env</span>
<a name="line-418"></a>
<a name="line-419"></a><a name="runPp"></a><span class='hs-definition'>runPp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-420"></a><span class='hs-definition'>runPp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>   <span class='hs-keyword'>do</span>
<a name="line-421"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_F</span> <span class='hs-varid'>dflags</span>
<a name="line-422"></a>      <span class='hs-varid'>opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_F</span><span class='hs-layout'>)</span>
<a name="line-423"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Haskell pre-processor"</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>opts</span><span class='hs-layout'>)</span>
<a name="line-424"></a>
<a name="line-425"></a><a name="runCc"></a><span class='hs-definition'>runCc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-426"></a><span class='hs-definition'>runCc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>   <span class='hs-keyword'>do</span>
<a name="line-427"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_c</span> <span class='hs-varid'>dflags</span>
<a name="line-428"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_c</span><span class='hs-layout'>)</span>
<a name="line-429"></a>      <span class='hs-varid'>args2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-430"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-431"></a>  <span class='hs-varid'>runSomethingResponseFile</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cc_filter</span> <span class='hs-str'>"C Compiler"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-432"></a> <span class='hs-keyword'>where</span>
<a name="line-433"></a>  <span class='hs-comment'>-- discard some harmless warnings from gcc that we can't turn off</span>
<a name="line-434"></a>  <span class='hs-varid'>cc_filter</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unlines</span> <span class='hs-varop'>.</span> <span class='hs-varid'>doFilter</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lines</span>
<a name="line-435"></a>
<a name="line-436"></a>  <span class='hs-comment'>{-
<a name="line-437"></a>  gcc gives warnings in chunks like so:
<a name="line-438"></a>      In file included from /foo/bar/baz.h:11,
<a name="line-439"></a>                       from /foo/bar/baz2.h:22,
<a name="line-440"></a>                       from wibble.c:33:
<a name="line-441"></a>      /foo/flibble:14: global register variable ...
<a name="line-442"></a>      /foo/flibble:15: warning: call-clobbered r...
<a name="line-443"></a>  We break it up into its chunks, remove any call-clobbered register
<a name="line-444"></a>  warnings from each chunk, and then delete any chunks that we have
<a name="line-445"></a>  emptied of warnings.
<a name="line-446"></a>  -}</span>
<a name="line-447"></a>  <span class='hs-varid'>doFilter</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unChunkWarnings</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filterWarnings</span> <span class='hs-varop'>.</span> <span class='hs-varid'>chunkWarnings</span> <span class='hs-conid'>[]</span>
<a name="line-448"></a>  <span class='hs-comment'>-- We can't assume that the output will start with an "In file inc..."</span>
<a name="line-449"></a>  <span class='hs-comment'>-- line, so we start off expecting a list of warnings rather than a</span>
<a name="line-450"></a>  <span class='hs-comment'>-- location stack.</span>
<a name="line-451"></a>  <span class='hs-varid'>chunkWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- The location stack to use for the next</span>
<a name="line-452"></a>                            <span class='hs-comment'>-- list of warnings</span>
<a name="line-453"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- The remaining lines to look at</span>
<a name="line-454"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-455"></a>  <span class='hs-varid'>chunkWarnings</span> <span class='hs-varid'>loc_stack</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>loc_stack</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-456"></a>  <span class='hs-varid'>chunkWarnings</span> <span class='hs-varid'>loc_stack</span> <span class='hs-varid'>xs</span>
<a name="line-457"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>break</span> <span class='hs-varid'>loc_stack_start</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-458"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>warnings</span><span class='hs-layout'>,</span> <span class='hs-varid'>lss</span><span class='hs-conop'>:</span><span class='hs-varid'>xs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-459"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>span</span> <span class='hs-varid'>loc_start_continuation</span> <span class='hs-varid'>xs'</span> <span class='hs-keyword'>of</span>
<a name="line-460"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>lsc</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs''</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-461"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>loc_stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnings</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>chunkWarnings</span> <span class='hs-layout'>(</span><span class='hs-varid'>lss</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lsc</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs''</span>
<a name="line-462"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>loc_stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-463"></a>
<a name="line-464"></a>  <span class='hs-varid'>filterWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-465"></a>  <span class='hs-varid'>filterWarnings</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-466"></a>  <span class='hs-comment'>-- If the warnings are already empty then we are probably doing</span>
<a name="line-467"></a>  <span class='hs-comment'>-- something wrong, so don't delete anything</span>
<a name="line-468"></a>  <span class='hs-varid'>filterWarnings</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>filterWarnings</span> <span class='hs-varid'>zs</span>
<a name="line-469"></a>  <span class='hs-varid'>filterWarnings</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>wantedWarning</span> <span class='hs-varid'>ys</span> <span class='hs-keyword'>of</span>
<a name="line-470"></a>                                       <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>filterWarnings</span> <span class='hs-varid'>zs</span>
<a name="line-471"></a>                                       <span class='hs-varid'>ys'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>filterWarnings</span> <span class='hs-varid'>zs</span>
<a name="line-472"></a>
<a name="line-473"></a>  <span class='hs-varid'>unChunkWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-474"></a>  <span class='hs-varid'>unChunkWarnings</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-475"></a>  <span class='hs-varid'>unChunkWarnings</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unChunkWarnings</span> <span class='hs-varid'>zs</span>
<a name="line-476"></a>
<a name="line-477"></a>  <span class='hs-varid'>loc_stack_start</span>        <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"In file included from "</span> <span class='hs-varop'>`isPrefixOf`</span> <span class='hs-varid'>s</span>
<a name="line-478"></a>  <span class='hs-varid'>loc_start_continuation</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"                 from "</span> <span class='hs-varop'>`isPrefixOf`</span> <span class='hs-varid'>s</span>
<a name="line-479"></a>  <span class='hs-varid'>wantedWarning</span> <span class='hs-varid'>w</span>
<a name="line-480"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-str'>"warning: call-clobbered register used"</span> <span class='hs-varop'>`isContainedIn`</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-481"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-482"></a>
<a name="line-483"></a><a name="isContainedIn"></a><span class='hs-definition'>isContainedIn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-484"></a><a name="isContainedIn"></a><span class='hs-definition'>xs</span> <span class='hs-varop'>`isContainedIn`</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tails</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-485"></a>
<a name="line-486"></a><a name="askLd"></a><span class='hs-comment'>-- | Run the linker with some arguments and return the output</span>
<a name="line-487"></a><span class='hs-definition'>askLd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>String</span>
<a name="line-488"></a><span class='hs-definition'>askLd</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-489"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_l</span> <span class='hs-varid'>dflags</span>
<a name="line-490"></a>      <span class='hs-varid'>args1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_l</span><span class='hs-layout'>)</span>
<a name="line-491"></a>      <span class='hs-varid'>args2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-492"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-493"></a>  <span class='hs-varid'>runSomethingWith</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"gcc"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args2</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>real_args</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-494"></a>    <span class='hs-varid'>readCreateProcessWithExitCode'</span> <span class='hs-layout'>(</span><span class='hs-varid'>proc</span> <span class='hs-varid'>p</span> <span class='hs-varid'>real_args</span><span class='hs-layout'>)</span><span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_env</span> <span class='hs-layout'>}</span>
<a name="line-495"></a>
<a name="line-496"></a><a name="readCreateProcessWithExitCode'"></a><span class='hs-comment'>-- Similar to System.Process.readCreateProcessWithExitCode, but stderr is</span>
<a name="line-497"></a><span class='hs-comment'>-- inherited from the parent process, and output to stderr is not captured.</span>
<a name="line-498"></a><span class='hs-definition'>readCreateProcessWithExitCode'</span>
<a name="line-499"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CreateProcess</span>
<a name="line-500"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitCode</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- ^ stdout</span>
<a name="line-501"></a><span class='hs-definition'>readCreateProcessWithExitCode'</span> <span class='hs-varid'>proc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-502"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>outh</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>pid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-503"></a>        <span class='hs-varid'>createProcess</span> <span class='hs-varid'>proc</span><span class='hs-layout'>{</span> <span class='hs-varid'>std_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CreatePipe</span> <span class='hs-layout'>}</span>
<a name="line-504"></a>
<a name="line-505"></a>    <span class='hs-comment'>-- fork off a thread to start consuming the output</span>
<a name="line-506"></a>    <span class='hs-varid'>output</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetContents</span> <span class='hs-varid'>outh</span>
<a name="line-507"></a>    <span class='hs-varid'>outMVar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEmptyMVar</span>
<a name="line-508"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>evaluate</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>output</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>putMVar</span> <span class='hs-varid'>outMVar</span> <span class='hs-conid'>()</span>
<a name="line-509"></a>
<a name="line-510"></a>    <span class='hs-comment'>-- wait on the output</span>
<a name="line-511"></a>    <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>outMVar</span>
<a name="line-512"></a>    <span class='hs-varid'>hClose</span> <span class='hs-varid'>outh</span>
<a name="line-513"></a>
<a name="line-514"></a>    <span class='hs-comment'>-- wait on the process</span>
<a name="line-515"></a>    <span class='hs-varid'>ex</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>waitForProcess</span> <span class='hs-varid'>pid</span>
<a name="line-516"></a>
<a name="line-517"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ex</span><span class='hs-layout'>,</span> <span class='hs-varid'>output</span><span class='hs-layout'>)</span>
<a name="line-518"></a>
<a name="line-519"></a><a name="replaceVar"></a><span class='hs-definition'>replaceVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-520"></a><span class='hs-definition'>replaceVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>value</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span>
<a name="line-521"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>value</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>var'</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>var</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>var'</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-522"></a>
<a name="line-523"></a><a name="readProcessEnvWithExitCode"></a><span class='hs-comment'>-- | Version of @System.Process.readProcessWithExitCode@ that takes a</span>
<a name="line-524"></a><span class='hs-comment'>-- key-value tuple to insert into the environment.</span>
<a name="line-525"></a><span class='hs-definition'>readProcessEnvWithExitCode</span>
<a name="line-526"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ program path</span>
<a name="line-527"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ program args</span>
<a name="line-528"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ addition to the environment</span>
<a name="line-529"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitCode</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ (exit_code, stdout, stderr)</span>
<a name="line-530"></a><span class='hs-definition'>readProcessEnvWithExitCode</span> <span class='hs-varid'>prog</span> <span class='hs-varid'>args</span> <span class='hs-varid'>env_update</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-531"></a>    <span class='hs-varid'>current_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEnvironment</span>
<a name="line-532"></a>    <span class='hs-varid'>readCreateProcessWithExitCode</span> <span class='hs-layout'>(</span><span class='hs-varid'>proc</span> <span class='hs-varid'>prog</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span>
<a name="line-533"></a>        <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>replaceVar</span> <span class='hs-varid'>env_update</span> <span class='hs-varid'>current_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-str'>""</span>
<a name="line-534"></a>
<a name="line-535"></a><a name="c_locale_env"></a><span class='hs-comment'>-- Don't let gcc localize version info string, #8825</span>
<a name="line-536"></a><span class='hs-definition'>c_locale_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-537"></a><span class='hs-definition'>c_locale_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-str'>"LANGUAGE"</span><span class='hs-layout'>,</span> <span class='hs-str'>"C"</span><span class='hs-layout'>)</span>
<a name="line-538"></a>
<a name="line-539"></a><a name="getGccEnv"></a><span class='hs-comment'>-- If the -B&lt;dir&gt; option is set, add &lt;dir&gt; to PATH.  This works around</span>
<a name="line-540"></a><span class='hs-comment'>-- a bug in gcc on Windows Vista where it can't find its auxiliary</span>
<a name="line-541"></a><span class='hs-comment'>-- binaries (see bug #1110).</span>
<a name="line-542"></a><span class='hs-definition'>getGccEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-543"></a><span class='hs-definition'>getGccEnv</span> <span class='hs-varid'>opts</span> <span class='hs-keyglyph'>=</span>
<a name="line-544"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>b_dirs</span>
<a name="line-545"></a>     <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-546"></a>     <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEnvironment</span>
<a name="line-547"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mangle_path</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-548"></a> <span class='hs-keyword'>where</span>
<a name="line-549"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>b_dirs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>get_b_opt</span> <span class='hs-varid'>opts</span>
<a name="line-550"></a>
<a name="line-551"></a>  <span class='hs-varid'>get_b_opt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-chr'>'-'</span><span class='hs-conop'>:</span><span class='hs-chr'>'B'</span><span class='hs-conop'>:</span><span class='hs-varid'>dir</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>dir</span>
<a name="line-552"></a>  <span class='hs-varid'>get_b_opt</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>other</span>
<a name="line-553"></a>
<a name="line-554"></a>  <span class='hs-varid'>mangle_path</span> <span class='hs-layout'>(</span><span class='hs-varid'>path</span><span class='hs-layout'>,</span><span class='hs-varid'>paths</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toUpper</span> <span class='hs-varid'>path</span> <span class='hs-varop'>==</span> <span class='hs-str'>"PATH"</span>
<a name="line-555"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>path</span><span class='hs-layout'>,</span> <span class='hs-chr'>'\"'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>head</span> <span class='hs-varid'>b_dirs</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\";"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>paths</span><span class='hs-layout'>)</span>
<a name="line-556"></a>  <span class='hs-varid'>mangle_path</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other</span>
<a name="line-557"></a>
<a name="line-558"></a><a name="runSplit"></a><span class='hs-definition'>runSplit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-559"></a><span class='hs-definition'>runSplit</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-560"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_s</span> <span class='hs-varid'>dflags</span>
<a name="line-561"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Splitter"</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>args0</span><span class='hs-varop'>++</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-562"></a>
<a name="line-563"></a><a name="runAs"></a><span class='hs-definition'>runAs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-564"></a><span class='hs-definition'>runAs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-565"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_a</span> <span class='hs-varid'>dflags</span>
<a name="line-566"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_a</span><span class='hs-layout'>)</span>
<a name="line-567"></a>      <span class='hs-varid'>args2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-568"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-569"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Assembler"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-570"></a>
<a name="line-571"></a><a name="runLlvmOpt"></a><span class='hs-comment'>-- | Run the LLVM Optimiser</span>
<a name="line-572"></a><span class='hs-definition'>runLlvmOpt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-573"></a><span class='hs-definition'>runLlvmOpt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-574"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_lo</span> <span class='hs-varid'>dflags</span>
<a name="line-575"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_lo</span><span class='hs-layout'>)</span>
<a name="line-576"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"LLVM Optimiser"</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-577"></a>
<a name="line-578"></a><a name="runLlvmLlc"></a><span class='hs-comment'>-- | Run the LLVM Compiler</span>
<a name="line-579"></a><span class='hs-definition'>runLlvmLlc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-580"></a><span class='hs-definition'>runLlvmLlc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-581"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_lc</span> <span class='hs-varid'>dflags</span>
<a name="line-582"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_lc</span><span class='hs-layout'>)</span>
<a name="line-583"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"LLVM Compiler"</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-584"></a>
<a name="line-585"></a><a name="runClang"></a><span class='hs-comment'>-- | Run the clang compiler (used as an assembler for the LLVM</span>
<a name="line-586"></a><span class='hs-comment'>-- backend on OS X as LLVM doesn't support the OS X system</span>
<a name="line-587"></a><span class='hs-comment'>-- assembler)</span>
<a name="line-588"></a><span class='hs-definition'>runClang</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-589"></a><span class='hs-definition'>runClang</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-590"></a>  <span class='hs-comment'>-- we simply assume its available on the PATH</span>
<a name="line-591"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>clang</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"clang"</span>
<a name="line-592"></a>      <span class='hs-comment'>-- be careful what options we call clang with</span>
<a name="line-593"></a>      <span class='hs-comment'>-- see #5903 and #7617 for bugs caused by this.</span>
<a name="line-594"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_a</span> <span class='hs-varid'>dflags</span>
<a name="line-595"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_a</span><span class='hs-layout'>)</span>
<a name="line-596"></a>      <span class='hs-varid'>args2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-597"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-598"></a>  <span class='hs-conid'>Exception</span><span class='hs-varop'>.</span><span class='hs-varid'>catch</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-599"></a>        <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Clang (Assembler)"</span> <span class='hs-varid'>clang</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-600"></a>    <span class='hs-layout'>)</span>
<a name="line-601"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-602"></a>        <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-603"></a>            <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>"Error running clang! you need clang installed to use the"</span> <span class='hs-varop'>++</span>
<a name="line-604"></a>                  <span class='hs-str'>" LLVM backend"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$+$</span>
<a name="line-605"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"(or GHC tried to execute clang incorrectly)"</span>
<a name="line-606"></a>        <span class='hs-varid'>throwIO</span> <span class='hs-varid'>err</span>
<a name="line-607"></a>    <span class='hs-layout'>)</span>
<a name="line-608"></a>
<a name="line-609"></a><a name="figureLlvmVersion"></a><span class='hs-comment'>-- | Figure out which version of LLVM we are running this session</span>
<a name="line-610"></a><span class='hs-definition'>figureLlvmVersion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-611"></a><span class='hs-definition'>figureLlvmVersion</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-612"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>pgm</span><span class='hs-layout'>,</span><span class='hs-varid'>opts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_lc</span> <span class='hs-varid'>dflags</span>
<a name="line-613"></a>      <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>notNull</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>opts</span><span class='hs-layout'>)</span>
<a name="line-614"></a>      <span class='hs-comment'>-- we grab the args even though they should be useless just in</span>
<a name="line-615"></a>      <span class='hs-comment'>-- case the user is using a customised 'llc' that requires some</span>
<a name="line-616"></a>      <span class='hs-comment'>-- of the options they've specified. llc doesn't care what other</span>
<a name="line-617"></a>      <span class='hs-comment'>-- options are specified when '-version' is used.</span>
<a name="line-618"></a>      <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-version"</span><span class='hs-keyglyph'>]</span>
<a name="line-619"></a>  <span class='hs-varid'>ver</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catchIO</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-620"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>pin</span><span class='hs-layout'>,</span> <span class='hs-varid'>pout</span><span class='hs-layout'>,</span> <span class='hs-varid'>perr</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runInteractiveProcess</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args'</span>
<a name="line-621"></a>                                             <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span>
<a name="line-622"></a>             <span class='hs-comment'>{- &gt; llc -version
<a name="line-623"></a>                  LLVM (<a href="http://llvm.org/):">http://llvm.org/):</a>
<a name="line-624"></a>                    LLVM version 3.5.2
<a name="line-625"></a>                    ...
<a name="line-626"></a>             -}</span>
<a name="line-627"></a>             <span class='hs-varid'>hSetBinaryMode</span> <span class='hs-varid'>pout</span> <span class='hs-conid'>False</span>
<a name="line-628"></a>             <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetLine</span> <span class='hs-varid'>pout</span>
<a name="line-629"></a>             <span class='hs-varid'>vline</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dropWhile</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isDigit</span><span class='hs-layout'>)</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>hGetLine</span> <span class='hs-varid'>pout</span>
<a name="line-630"></a>             <span class='hs-varid'>v</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-chr'>'.'</span><span class='hs-layout'>)</span> <span class='hs-varid'>vline</span> <span class='hs-keyword'>of</span>
<a name="line-631"></a>                        <span class='hs-layout'>(</span><span class='hs-str'>""</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"no digits!"</span>
<a name="line-632"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>read</span> <span class='hs-varid'>x</span>
<a name="line-633"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>read</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeWhile</span> <span class='hs-varid'>isDigit</span> <span class='hs-varop'>$</span> <span class='hs-varid'>drop</span> <span class='hs-num'>1</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>
<a name="line-634"></a>
<a name="line-635"></a>             <span class='hs-varid'>hClose</span> <span class='hs-varid'>pin</span>
<a name="line-636"></a>             <span class='hs-varid'>hClose</span> <span class='hs-varid'>pout</span>
<a name="line-637"></a>             <span class='hs-varid'>hClose</span> <span class='hs-varid'>perr</span>
<a name="line-638"></a>             <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>
<a name="line-639"></a>            <span class='hs-layout'>)</span>
<a name="line-640"></a>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-641"></a>                <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span>
<a name="line-642"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Error (figuring out LLVM version):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-643"></a>                     <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-644"></a>                <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-645"></a>                    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Warning:"</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>9</span> <span class='hs-varop'>$</span>
<a name="line-646"></a>                          <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't figure out LLVM version!"</span> <span class='hs-varop'>$$</span>
<a name="line-647"></a>                          <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>"Make sure you have installed LLVM "</span> <span class='hs-varop'>++</span>
<a name="line-648"></a>                                <span class='hs-varid'>llvmVersionStr</span> <span class='hs-varid'>supportedLlvmVersion</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-649"></a>                <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-650"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>ver</span>
<a name="line-651"></a>
<a name="line-652"></a><span class='hs-comment'>{- Note [Windows stack usage]
<a name="line-653"></a>
<a name="line-654"></a>See: Trac #8870 (and #8834 for related info) and #12186
<a name="line-655"></a>
<a name="line-656"></a>On Windows, occasionally we need to grow the stack. In order to do
<a name="line-657"></a>this, we would normally just bump the stack pointer - but there's a
<a name="line-658"></a>catch on Windows.
<a name="line-659"></a>
<a name="line-660"></a>If the stack pointer is bumped by more than a single page, then the
<a name="line-661"></a>pages between the initial pointer and the resulting location must be
<a name="line-662"></a>properly committed by the Windows virtual memory subsystem. This is
<a name="line-663"></a>only needed in the event we bump by more than one page (i.e 4097 bytes
<a name="line-664"></a>or more).
<a name="line-665"></a>
<a name="line-666"></a>Windows compilers solve this by emitting a call to a special function
<a name="line-667"></a>called _chkstk, which does this committing of the pages for you.
<a name="line-668"></a>
<a name="line-669"></a>The reason this was causing a segfault was because due to the fact the
<a name="line-670"></a>new code generator tends to generate larger functions, we needed more
<a name="line-671"></a>stack space in GHC itself. In the x86 codegen, we needed approximately
<a name="line-672"></a>~12kb of stack space in one go, which caused the process to segfault,
<a name="line-673"></a>as the intervening pages were not committed.
<a name="line-674"></a>
<a name="line-675"></a>GCC can emit such a check for us automatically but only when the flag
<a name="line-676"></a>-fstack-check is used.
<a name="line-677"></a>
<a name="line-678"></a>See https://gcc.gnu.org/onlinedocs/gnat_ugn/Stack-Overflow-Checking.html
<a name="line-679"></a>for more information.
<a name="line-680"></a>
<a name="line-681"></a>-}</span>
<a name="line-682"></a>
<a name="line-683"></a><span class='hs-comment'>{- Note [Run-time linker info]
<a name="line-684"></a>
<a name="line-685"></a>See also: Trac #5240, Trac #6063, Trac #10110
<a name="line-686"></a>
<a name="line-687"></a>Before 'runLink', we need to be sure to get the relevant information
<a name="line-688"></a>about the linker we're using at runtime to see if we need any extra
<a name="line-689"></a>options. For example, GNU ld requires '--reduce-memory-overheads' and
<a name="line-690"></a>'--hash-size=31' in order to use reasonable amounts of memory (see
<a name="line-691"></a>trac #5240.) But this isn't supported in GNU gold.
<a name="line-692"></a>
<a name="line-693"></a>Generally, the linker changing from what was detected at ./configure
<a name="line-694"></a>time has always been possible using -pgml, but on Linux it can happen
<a name="line-695"></a>'transparently' by installing packages like binutils-gold, which
<a name="line-696"></a>change what /usr/bin/ld actually points to.
<a name="line-697"></a>
<a name="line-698"></a>Clang vs GCC notes:
<a name="line-699"></a>
<a name="line-700"></a>For gcc, 'gcc -Wl,--version' gives a bunch of output about how to
<a name="line-701"></a>invoke the linker before the version information string. For 'clang',
<a name="line-702"></a>the version information for 'ld' is all that's output. For this
<a name="line-703"></a>reason, we typically need to slurp up all of the standard error output
<a name="line-704"></a>and look through it.
<a name="line-705"></a>
<a name="line-706"></a>Other notes:
<a name="line-707"></a>
<a name="line-708"></a>We cache the LinkerInfo inside DynFlags, since clients may link
<a name="line-709"></a>multiple times. The definition of LinkerInfo is there to avoid a
<a name="line-710"></a>circular dependency.
<a name="line-711"></a>
<a name="line-712"></a>-}</span>
<a name="line-713"></a>
<a name="line-714"></a><span class='hs-comment'>{- Note [ELF needed shared libs]
<a name="line-715"></a>
<a name="line-716"></a>Some distributions change the link editor's default handling of
<a name="line-717"></a>ELF DT_NEEDED tags to include only those shared objects that are
<a name="line-718"></a>needed to resolve undefined symbols. For Template Haskell we need
<a name="line-719"></a>the last temporary shared library also if it is not needed for the
<a name="line-720"></a>currently linked temporary shared library. We specify --no-as-needed
<a name="line-721"></a>to override the default. This flag exists in GNU ld and GNU gold.
<a name="line-722"></a>
<a name="line-723"></a>The flag is only needed on ELF systems. On Windows (PE) and Mac OS X
<a name="line-724"></a>(Mach-O) the flag is not needed.
<a name="line-725"></a>
<a name="line-726"></a>-}</span>
<a name="line-727"></a>
<a name="line-728"></a><span class='hs-comment'>{- Note [Windows static libGCC]
<a name="line-729"></a>
<a name="line-730"></a>The GCC versions being upgraded to in #10726 are configured with
<a name="line-731"></a>dynamic linking of libgcc supported. This results in libgcc being
<a name="line-732"></a>linked dynamically when a shared library is created.
<a name="line-733"></a>
<a name="line-734"></a>This introduces thus an extra dependency on GCC dll that was not
<a name="line-735"></a>needed before by shared libraries created with GHC. This is a particular
<a name="line-736"></a>issue on Windows because you get a non-obvious error due to this missing
<a name="line-737"></a>dependency. This dependent dll is also not commonly on your path.
<a name="line-738"></a>
<a name="line-739"></a>For this reason using the static libgcc is preferred as it preserves
<a name="line-740"></a>the same behaviour that existed before. There are however some very good
<a name="line-741"></a>reasons to have the shared version as well as described on page 181 of
<a name="line-742"></a>https://gcc.gnu.org/onlinedocs/gcc-5.2.0/gcc.pdf :
<a name="line-743"></a>
<a name="line-744"></a>"There are several situations in which an application should use the
<a name="line-745"></a> shared libgcc instead of the static version. The most common of these
<a name="line-746"></a> is when the application wishes to throw and catch exceptions across different
<a name="line-747"></a> shared libraries. In that case, each of the libraries as well as the application
<a name="line-748"></a> itself should use the shared libgcc. "
<a name="line-749"></a>
<a name="line-750"></a>-}</span>
<a name="line-751"></a>
<a name="line-752"></a><a name="neededLinkArgs"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LinkerInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>
<a name="line-753"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-754"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuGold</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-755"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>DarwinLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-756"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>SolarisLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-757"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AixLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-758"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-conid'>UnknownLD</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-759"></a>
<a name="line-760"></a><a name="getLinkerInfo"></a><span class='hs-comment'>-- Grab linker info and cache it in DynFlags.</span>
<a name="line-761"></a><span class='hs-definition'>getLinkerInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>LinkerInfo</span>
<a name="line-762"></a><span class='hs-definition'>getLinkerInfo</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-763"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtldInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-764"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-765"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-766"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-767"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLinkerInfo'</span> <span class='hs-varid'>dflags</span>
<a name="line-768"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtldInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-769"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-770"></a>
<a name="line-771"></a><a name="getLinkerInfo'"></a><span class='hs-comment'>-- See Note [Run-time linker info].</span>
<a name="line-772"></a><span class='hs-definition'>getLinkerInfo'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>LinkerInfo</span>
<a name="line-773"></a><span class='hs-definition'>getLinkerInfo'</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-774"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-775"></a>      <span class='hs-varid'>os</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span>
<a name="line-776"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>pgm</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_l</span> <span class='hs-varid'>dflags</span>
<a name="line-777"></a>      <span class='hs-varid'>args1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_l</span><span class='hs-layout'>)</span>
<a name="line-778"></a>      <span class='hs-varid'>args2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span>
<a name="line-779"></a>      <span class='hs-varid'>args3</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>notNull</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>args2</span><span class='hs-layout'>)</span>
<a name="line-780"></a>
<a name="line-781"></a>      <span class='hs-comment'>-- Try to grab the info from the process output.</span>
<a name="line-782"></a>      <span class='hs-varid'>parseLinkerInfo</span> <span class='hs-varid'>stdo</span> <span class='hs-sel'>_stde</span> <span class='hs-sel'>_exitc</span>
<a name="line-783"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"GNU ld"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stdo</span> <span class='hs-keyglyph'>=</span>
<a name="line-784"></a>          <span class='hs-comment'>-- GNU ld specifically needs to use less memory. This especially</span>
<a name="line-785"></a>          <span class='hs-comment'>-- hurts on small object files. Trac #5240.</span>
<a name="line-786"></a>          <span class='hs-comment'>-- Set DT_NEEDED for all shared libraries. Trac #10110.</span>
<a name="line-787"></a>          <span class='hs-comment'>-- TODO: Investigate if these help or hurt when using split sections.</span>
<a name="line-788"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuLD</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-Wl,--hash-size=31"</span><span class='hs-layout'>,</span>
<a name="line-789"></a>                                      <span class='hs-str'>"-Wl,--reduce-memory-overheads"</span><span class='hs-layout'>,</span>
<a name="line-790"></a>                                      <span class='hs-comment'>-- ELF specific flag</span>
<a name="line-791"></a>                                      <span class='hs-comment'>-- see Note [ELF needed shared libs]</span>
<a name="line-792"></a>                                      <span class='hs-str'>"-Wl,--no-as-needed"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-793"></a>
<a name="line-794"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"GNU gold"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stdo</span> <span class='hs-keyglyph'>=</span>
<a name="line-795"></a>          <span class='hs-comment'>-- GNU gold only needs --no-as-needed. Trac #10110.</span>
<a name="line-796"></a>          <span class='hs-comment'>-- ELF specific flag, see Note [ELF needed shared libs]</span>
<a name="line-797"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuGold</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-Wl,--no-as-needed"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-798"></a>
<a name="line-799"></a>         <span class='hs-comment'>-- Unknown linker.</span>
<a name="line-800"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"invalid --version output, or linker is unsupported"</span>
<a name="line-801"></a>
<a name="line-802"></a>  <span class='hs-comment'>-- Process the executable call</span>
<a name="line-803"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catchIO</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-804"></a>             <span class='hs-keyword'>case</span> <span class='hs-varid'>os</span> <span class='hs-keyword'>of</span>
<a name="line-805"></a>               <span class='hs-conid'>OSSolaris2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-806"></a>                 <span class='hs-comment'>-- Solaris uses its own Solaris linker. Even all</span>
<a name="line-807"></a>                 <span class='hs-comment'>-- GNU C are recommended to configure with Solaris</span>
<a name="line-808"></a>                 <span class='hs-comment'>-- linker instead of using GNU binutils linker. Also</span>
<a name="line-809"></a>                 <span class='hs-comment'>-- all GCC distributed with Solaris follows this rule</span>
<a name="line-810"></a>                 <span class='hs-comment'>-- precisely so we assume here, the Solaris linker is</span>
<a name="line-811"></a>                 <span class='hs-comment'>-- used.</span>
<a name="line-812"></a>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SolarisLD</span> <span class='hs-conid'>[]</span>
<a name="line-813"></a>               <span class='hs-conid'>OSAIX</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-814"></a>                 <span class='hs-comment'>-- IBM AIX uses its own non-binutils linker as well</span>
<a name="line-815"></a>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>AixLD</span> <span class='hs-conid'>[]</span>
<a name="line-816"></a>               <span class='hs-conid'>OSDarwin</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-817"></a>                 <span class='hs-comment'>-- Darwin has neither GNU Gold or GNU LD, but a strange linker</span>
<a name="line-818"></a>                 <span class='hs-comment'>-- that doesn't support --version. We can just assume that's</span>
<a name="line-819"></a>                 <span class='hs-comment'>-- what we're using.</span>
<a name="line-820"></a>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DarwinLD</span> <span class='hs-conid'>[]</span>
<a name="line-821"></a>               <span class='hs-conid'>OSiOS</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-822"></a>                 <span class='hs-comment'>-- Ditto for iOS</span>
<a name="line-823"></a>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DarwinLD</span> <span class='hs-conid'>[]</span>
<a name="line-824"></a>               <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-825"></a>                 <span class='hs-comment'>-- GHC doesn't support anything but GNU ld on Windows anyway.</span>
<a name="line-826"></a>                 <span class='hs-comment'>-- Process creation is also fairly expensive on win32, so</span>
<a name="line-827"></a>                 <span class='hs-comment'>-- we short-circuit here.</span>
<a name="line-828"></a>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GnuLD</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span>
<a name="line-829"></a>                   <span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- Reduce ld memory usage</span>
<a name="line-830"></a>                     <span class='hs-str'>"-Wl,--hash-size=31"</span>
<a name="line-831"></a>                   <span class='hs-layout'>,</span> <span class='hs-str'>"-Wl,--reduce-memory-overheads"</span>
<a name="line-832"></a>                     <span class='hs-comment'>-- Emit gcc stack checks</span>
<a name="line-833"></a>                     <span class='hs-comment'>-- Note [Windows stack usage]</span>
<a name="line-834"></a>                   <span class='hs-layout'>,</span> <span class='hs-str'>"-fstack-check"</span>
<a name="line-835"></a>                     <span class='hs-comment'>-- Force static linking of libGCC</span>
<a name="line-836"></a>                     <span class='hs-comment'>-- Note [Windows static libGCC]</span>
<a name="line-837"></a>                   <span class='hs-layout'>,</span> <span class='hs-str'>"-static-libgcc"</span> <span class='hs-keyglyph'>]</span>
<a name="line-838"></a>               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-839"></a>                 <span class='hs-comment'>-- In practice, we use the compiler as the linker here. Pass</span>
<a name="line-840"></a>                 <span class='hs-comment'>-- -Wl,--version to get linker version info.</span>
<a name="line-841"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>exitc</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>,</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readProcessEnvWithExitCode</span> <span class='hs-varid'>pgm</span>
<a name="line-842"></a>                                        <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-str'>"-Wl,--version"</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args3</span><span class='hs-layout'>)</span>
<a name="line-843"></a>                                        <span class='hs-varid'>c_locale_env</span>
<a name="line-844"></a>                 <span class='hs-comment'>-- Split the output by lines to make certain kinds</span>
<a name="line-845"></a>                 <span class='hs-comment'>-- of processing easier. In particular, 'clang' and 'gcc'</span>
<a name="line-846"></a>                 <span class='hs-comment'>-- have slightly different outputs for '-Wl,--version', but</span>
<a name="line-847"></a>                 <span class='hs-comment'>-- it's still easy to figure out.</span>
<a name="line-848"></a>                 <span class='hs-varid'>parseLinkerInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-varid'>exitc</span>
<a name="line-849"></a>            <span class='hs-layout'>)</span>
<a name="line-850"></a>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-851"></a>                <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span>
<a name="line-852"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Error (figuring out linker information):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-853"></a>                     <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-854"></a>                <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Warning:"</span><span class='hs-layout'>)</span> <span class='hs-num'>9</span> <span class='hs-varop'>$</span>
<a name="line-855"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't figure out linker information!"</span> <span class='hs-varop'>$$</span>
<a name="line-856"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"Make sure you're using GNU ld, GNU gold"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-857"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"or the built in OS X linker, etc."</span>
<a name="line-858"></a>                <span class='hs-varid'>return</span> <span class='hs-conid'>UnknownLD</span><span class='hs-layout'>)</span>
<a name="line-859"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>info</span>
<a name="line-860"></a>
<a name="line-861"></a><a name="getCompilerInfo"></a><span class='hs-comment'>-- Grab compiler info and cache it in DynFlags.</span>
<a name="line-862"></a><span class='hs-definition'>getCompilerInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CompilerInfo</span>
<a name="line-863"></a><span class='hs-definition'>getCompilerInfo</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-864"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtccInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-865"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-866"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-867"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-868"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCompilerInfo'</span> <span class='hs-varid'>dflags</span>
<a name="line-869"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtccInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-870"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-871"></a>
<a name="line-872"></a><a name="getCompilerInfo'"></a><span class='hs-comment'>-- See Note [Run-time linker info].</span>
<a name="line-873"></a><span class='hs-definition'>getCompilerInfo'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CompilerInfo</span>
<a name="line-874"></a><span class='hs-definition'>getCompilerInfo'</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-875"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>pgm</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_c</span> <span class='hs-varid'>dflags</span>
<a name="line-876"></a>      <span class='hs-comment'>-- Try to grab the info from the process output.</span>
<a name="line-877"></a>      <span class='hs-varid'>parseCompilerInfo</span> <span class='hs-sel'>_stdo</span> <span class='hs-varid'>stde</span> <span class='hs-sel'>_exitc</span>
<a name="line-878"></a>        <span class='hs-comment'>-- Regular GCC</span>
<a name="line-879"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"gcc version"</span> <span class='hs-varop'>`isInfixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-880"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>GCC</span>
<a name="line-881"></a>        <span class='hs-comment'>-- Regular clang</span>
<a name="line-882"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"clang version"</span> <span class='hs-varop'>`isInfixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-883"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>Clang</span>
<a name="line-884"></a>        <span class='hs-comment'>-- XCode 5.1 clang</span>
<a name="line-885"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"Apple LLVM version 5.1"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-886"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>AppleClang51</span>
<a name="line-887"></a>        <span class='hs-comment'>-- XCode 5 clang</span>
<a name="line-888"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"Apple LLVM version"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-889"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>AppleClang</span>
<a name="line-890"></a>        <span class='hs-comment'>-- XCode 4.1 clang</span>
<a name="line-891"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"Apple clang version"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-892"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>AppleClang</span>
<a name="line-893"></a>         <span class='hs-comment'>-- Unknown linker.</span>
<a name="line-894"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"invalid -v output, or compiler is unsupported"</span>
<a name="line-895"></a>
<a name="line-896"></a>  <span class='hs-comment'>-- Process the executable call</span>
<a name="line-897"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catchIO</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-898"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>exitc</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>,</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-899"></a>                    <span class='hs-varid'>readProcessEnvWithExitCode</span> <span class='hs-varid'>pgm</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-v"</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>c_locale_env</span>
<a name="line-900"></a>                <span class='hs-comment'>-- Split the output by lines to make certain kinds</span>
<a name="line-901"></a>                <span class='hs-comment'>-- of processing easier.</span>
<a name="line-902"></a>                <span class='hs-varid'>parseCompilerInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-varid'>exitc</span>
<a name="line-903"></a>            <span class='hs-layout'>)</span>
<a name="line-904"></a>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-905"></a>                <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span>
<a name="line-906"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Error (figuring out C compiler information):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-907"></a>                     <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-908"></a>                <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Warning:"</span><span class='hs-layout'>)</span> <span class='hs-num'>9</span> <span class='hs-varop'>$</span>
<a name="line-909"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't figure out C compiler information!"</span> <span class='hs-varop'>$$</span>
<a name="line-910"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"Make sure you're using GNU gcc, or clang"</span>
<a name="line-911"></a>                <span class='hs-varid'>return</span> <span class='hs-conid'>UnknownCC</span><span class='hs-layout'>)</span>
<a name="line-912"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>info</span>
<a name="line-913"></a>
<a name="line-914"></a><a name="runLink"></a><span class='hs-definition'>runLink</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-915"></a><span class='hs-definition'>runLink</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-916"></a>  <span class='hs-comment'>-- See Note [Run-time linker info]</span>
<a name="line-917"></a>  <span class='hs-varid'>linkargs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>neededLinkArgs</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>getLinkerInfo</span> <span class='hs-varid'>dflags</span>
<a name="line-918"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_l</span> <span class='hs-varid'>dflags</span>
<a name="line-919"></a>      <span class='hs-varid'>args1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_l</span><span class='hs-layout'>)</span>
<a name="line-920"></a>      <span class='hs-varid'>args2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>linkargs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-921"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-922"></a>  <span class='hs-varid'>runSomethingResponseFile</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ld_filter</span> <span class='hs-str'>"Linker"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-923"></a>  <span class='hs-keyword'>where</span>
<a name="line-924"></a>    <span class='hs-varid'>ld_filter</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformOS</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-925"></a>                  <span class='hs-conid'>OSSolaris2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sunos_ld_filter</span>
<a name="line-926"></a>                  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id</span>
<a name="line-927"></a><span class='hs-comment'>{-
<a name="line-928"></a>  SunOS/Solaris ld emits harmless warning messages about unresolved
<a name="line-929"></a>  symbols in case of compiling into shared library when we do not
<a name="line-930"></a>  link against all the required libs. That is the case of GHC which
<a name="line-931"></a>  does not link against RTS library explicitly in order to be able to
<a name="line-932"></a>  choose the library later based on binary application linking
<a name="line-933"></a>  parameters. The warnings look like:
<a name="line-934"></a>
<a name="line-935"></a>Undefined                       first referenced
<a name="line-936"></a> symbol                             in file
<a name="line-937"></a>stg_ap_n_fast                       ./T2386_Lib.o
<a name="line-938"></a>stg_upd_frame_info                  ./T2386_Lib.o
<a name="line-939"></a>templatezmhaskell_LanguageziHaskellziTHziLib_litE_closure ./T2386_Lib.o
<a name="line-940"></a>templatezmhaskell_LanguageziHaskellziTHziLib_appE_closure ./T2386_Lib.o
<a name="line-941"></a>templatezmhaskell_LanguageziHaskellziTHziLib_conE_closure ./T2386_Lib.o
<a name="line-942"></a>templatezmhaskell_LanguageziHaskellziTHziSyntax_mkNameGzud_closure ./T2386_Lib.o
<a name="line-943"></a>newCAF                              ./T2386_Lib.o
<a name="line-944"></a>stg_bh_upd_frame_info               ./T2386_Lib.o
<a name="line-945"></a>stg_ap_ppp_fast                     ./T2386_Lib.o
<a name="line-946"></a>templatezmhaskell_LanguageziHaskellziTHziLib_stringL_closure ./T2386_Lib.o
<a name="line-947"></a>stg_ap_p_fast                       ./T2386_Lib.o
<a name="line-948"></a>stg_ap_pp_fast                      ./T2386_Lib.o
<a name="line-949"></a>ld: warning: symbol referencing errors
<a name="line-950"></a>
<a name="line-951"></a>  this is actually coming from T2386 testcase. The emitting of those
<a name="line-952"></a>  warnings is also a reason why so many TH testcases fail on Solaris.
<a name="line-953"></a>
<a name="line-954"></a>  Following filter code is SunOS/Solaris linker specific and should
<a name="line-955"></a>  filter out only linker warnings. Please note that the logic is a
<a name="line-956"></a>  little bit more complex due to the simple reason that we need to preserve
<a name="line-957"></a>  any other linker emitted messages. If there are any. Simply speaking
<a name="line-958"></a>  if we see "Undefined" and later "ld: warning:..." then we omit all
<a name="line-959"></a>  text between (including) the marks. Otherwise we copy the whole output.
<a name="line-960"></a>-}</span>
<a name="line-961"></a>    <span class='hs-varid'>sunos_ld_filter</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-962"></a>    <span class='hs-varid'>sunos_ld_filter</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unlines</span> <span class='hs-varop'>.</span> <span class='hs-varid'>sunos_ld_filter'</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lines</span>
<a name="line-963"></a>    <span class='hs-varid'>sunos_ld_filter'</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>undefined_found</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ld_warning_found</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-964"></a>                         <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>ld_prefix</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>ld_postfix</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-965"></a>                         <span class='hs-keyword'>else</span> <span class='hs-varid'>x</span>
<a name="line-966"></a>    <span class='hs-varid'>breakStartsWith</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>break</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPrefixOf</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>y</span>
<a name="line-967"></a>    <span class='hs-varid'>ld_prefix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>breakStartsWith</span> <span class='hs-str'>"Undefined"</span>
<a name="line-968"></a>    <span class='hs-varid'>undefined_found</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>breakStartsWith</span> <span class='hs-str'>"Undefined"</span>
<a name="line-969"></a>    <span class='hs-varid'>ld_warn_break</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>breakStartsWith</span> <span class='hs-str'>"ld: warning: symbol referencing errors"</span>
<a name="line-970"></a>    <span class='hs-varid'>ld_postfix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tail</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ld_warn_break</span>
<a name="line-971"></a>    <span class='hs-varid'>ld_warning_found</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ld_warn_break</span>
<a name="line-972"></a>
<a name="line-973"></a>
<a name="line-974"></a><a name="runLibtool"></a><span class='hs-definition'>runLibtool</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-975"></a><span class='hs-definition'>runLibtool</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-976"></a>  <span class='hs-varid'>linkargs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>neededLinkArgs</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>getLinkerInfo</span> <span class='hs-varid'>dflags</span>
<a name="line-977"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>args1</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_l</span><span class='hs-layout'>)</span>
<a name="line-978"></a>      <span class='hs-varid'>args2</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-static"</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>linkargs</span>
<a name="line-979"></a>      <span class='hs-varid'>libtool</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_libtool</span> <span class='hs-varid'>dflags</span>
<a name="line-980"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-981"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Linker"</span> <span class='hs-varid'>libtool</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-982"></a>
<a name="line-983"></a><a name="runMkDLL"></a><span class='hs-definition'>runMkDLL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-984"></a><span class='hs-definition'>runMkDLL</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-985"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_dll</span> <span class='hs-varid'>dflags</span>
<a name="line-986"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-987"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>args0</span><span class='hs-varop'>++</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-988"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Make DLL"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args1</span> <span class='hs-varid'>mb_env</span>
<a name="line-989"></a>
<a name="line-990"></a><a name="runWindres"></a><span class='hs-definition'>runWindres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-991"></a><span class='hs-definition'>runWindres</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-992"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>gcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>gcc_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_c</span> <span class='hs-varid'>dflags</span>
<a name="line-993"></a>      <span class='hs-varid'>windres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_windres</span> <span class='hs-varid'>dflags</span>
<a name="line-994"></a>      <span class='hs-varid'>opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_windres</span><span class='hs-layout'>)</span>
<a name="line-995"></a>      <span class='hs-varid'>quote</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"\""</span> <span class='hs-varop'>++</span> <span class='hs-varid'>x</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\""</span>
<a name="line-996"></a>      <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- If windres.exe and gcc.exe are in a directory containing</span>
<a name="line-997"></a>              <span class='hs-comment'>-- spaces then windres fails to run gcc. We therefore need</span>
<a name="line-998"></a>              <span class='hs-comment'>-- to tell it what command to use...</span>
<a name="line-999"></a>              <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-str'>"--preprocessor="</span> <span class='hs-varop'>++</span>
<a name="line-1000"></a>                      <span class='hs-varid'>unwords</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>quote</span> <span class='hs-layout'>(</span><span class='hs-varid'>gcc</span> <span class='hs-conop'>:</span>
<a name="line-1001"></a>                                          <span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>gcc_args</span> <span class='hs-varop'>++</span>
<a name="line-1002"></a>                                          <span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>opts</span> <span class='hs-varop'>++</span>
<a name="line-1003"></a>                                          <span class='hs-keyglyph'>[</span><span class='hs-str'>"-E"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-xc"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-DRC_INVOKED"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1004"></a>              <span class='hs-comment'>-- ...but if we do that then if windres calls popen then</span>
<a name="line-1005"></a>              <span class='hs-comment'>-- it can't understand the quoting, so we have to use</span>
<a name="line-1006"></a>              <span class='hs-comment'>-- --use-temp-file so that it interprets it correctly.</span>
<a name="line-1007"></a>              <span class='hs-comment'>-- See #1828.</span>
<a name="line-1008"></a>            <span class='hs-conop'>:</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"--use-temp-file"</span>
<a name="line-1009"></a>            <span class='hs-conop'>:</span> <span class='hs-varid'>args</span>
<a name="line-1010"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>gcc_args</span>
<a name="line-1011"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Windres"</span> <span class='hs-varid'>windres</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>mb_env</span>
<a name="line-1012"></a>
<a name="line-1013"></a><a name="touch"></a><span class='hs-definition'>touch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1014"></a><span class='hs-definition'>touch</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span>
<a name="line-1015"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-layout'>(</span><span class='hs-varid'>pgm_T</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-1016"></a>
<a name="line-1017"></a><a name="copy"></a><span class='hs-definition'>copy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1018"></a><span class='hs-definition'>copy</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>copyWithHeader</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span>
<a name="line-1019"></a>
<a name="line-1020"></a><a name="copyWithHeader"></a><span class='hs-definition'>copyWithHeader</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1021"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1022"></a><span class='hs-definition'>copyWithHeader</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-varid'>maybe_header</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1023"></a>  <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span>
<a name="line-1024"></a>
<a name="line-1025"></a>  <span class='hs-varid'>hout</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openBinaryFile</span> <span class='hs-varid'>to</span>   <span class='hs-conid'>WriteMode</span>
<a name="line-1026"></a>  <span class='hs-varid'>hin</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openBinaryFile</span> <span class='hs-varid'>from</span> <span class='hs-conid'>ReadMode</span>
<a name="line-1027"></a>  <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetContents</span> <span class='hs-varid'>hin</span> <span class='hs-comment'>-- inefficient, but it'll do for now. ToDo: speed up</span>
<a name="line-1028"></a>  <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>header</span> <span class='hs-varid'>hout</span><span class='hs-layout'>)</span> <span class='hs-varid'>maybe_header</span>
<a name="line-1029"></a>  <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>hout</span> <span class='hs-varid'>ls</span>
<a name="line-1030"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hout</span>
<a name="line-1031"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hin</span>
<a name="line-1032"></a> <span class='hs-keyword'>where</span>
<a name="line-1033"></a>  <span class='hs-comment'>-- write the header string in UTF-8.  The header is something like</span>
<a name="line-1034"></a>  <span class='hs-comment'>--   {-# LINE "foo.hs" #-}</span>
<a name="line-1035"></a>  <span class='hs-comment'>-- and we want to make sure a Unicode filename isn't mangled.</span>
<a name="line-1036"></a>  <span class='hs-varid'>header</span> <span class='hs-varid'>h</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1037"></a>   <span class='hs-varid'>hSetEncoding</span> <span class='hs-varid'>h</span> <span class='hs-varid'>utf8</span>
<a name="line-1038"></a>   <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span> <span class='hs-varid'>str</span>
<a name="line-1039"></a>   <span class='hs-varid'>hSetBinaryMode</span> <span class='hs-varid'>h</span> <span class='hs-conid'>True</span>
<a name="line-1040"></a>
<a name="line-1041"></a>
<a name="line-1042"></a>
<a name="line-1043"></a><span class='hs-comment'>{-
<a name="line-1044"></a>************************************************************************
<a name="line-1045"></a>*                                                                      *
<a name="line-1046"></a>\subsection{Managing temporary files
<a name="line-1047"></a>*                                                                      *
<a name="line-1048"></a>************************************************************************
<a name="line-1049"></a>-}</span>
<a name="line-1050"></a>
<a name="line-1051"></a><a name="cleanTempDirs"></a><span class='hs-definition'>cleanTempDirs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1052"></a><span class='hs-definition'>cleanTempDirs</span> <span class='hs-varid'>dflags</span>
<a name="line-1053"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KeepTmpFiles</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-1054"></a>   <span class='hs-varop'>$</span> <span class='hs-varid'>mask_</span>
<a name="line-1055"></a>   <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dirsToClean</span> <span class='hs-varid'>dflags</span>
<a name="line-1056"></a>        <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-1057"></a>        <span class='hs-varid'>removeTmpDirs</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>elems</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-1058"></a>
<a name="line-1059"></a><a name="cleanTempFiles"></a><span class='hs-definition'>cleanTempFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1060"></a><span class='hs-definition'>cleanTempFiles</span> <span class='hs-varid'>dflags</span>
<a name="line-1061"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KeepTmpFiles</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-1062"></a>   <span class='hs-varop'>$</span> <span class='hs-varid'>mask_</span>
<a name="line-1063"></a>   <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filesToClean</span> <span class='hs-varid'>dflags</span>
<a name="line-1064"></a>        <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>fs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-1065"></a>        <span class='hs-varid'>removeTmpFiles</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fs</span>
<a name="line-1066"></a>
<a name="line-1067"></a><a name="cleanTempFilesExcept"></a><span class='hs-definition'>cleanTempFilesExcept</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1068"></a><span class='hs-definition'>cleanTempFilesExcept</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dont_delete</span>
<a name="line-1069"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KeepTmpFiles</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-1070"></a>   <span class='hs-varop'>$</span> <span class='hs-varid'>mask_</span>
<a name="line-1071"></a>   <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filesToClean</span> <span class='hs-varid'>dflags</span>
<a name="line-1072"></a>        <span class='hs-varid'>to_delete</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>files</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1073"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-sel'>_to_keep</span><span class='hs-layout'>,</span> <span class='hs-sel'>_to_delete</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1074"></a>                    <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varop'>`</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span><span class='hs-varop'>`</span> <span class='hs-varid'>dont_delete_set</span><span class='hs-layout'>)</span> <span class='hs-varid'>files</span>
<a name="line-1075"></a>            <span class='hs-keyword'>in</span>  <span class='hs-varid'>res</span>
<a name="line-1076"></a>        <span class='hs-varid'>removeTmpFiles</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>to_delete</span>
<a name="line-1077"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>dont_delete_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varid'>dont_delete</span>
<a name="line-1078"></a>
<a name="line-1079"></a>
<a name="line-1080"></a><a name="newTempSuffix"></a><span class='hs-comment'>-- Return a unique numeric temp file suffix</span>
<a name="line-1081"></a><span class='hs-definition'>newTempSuffix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span>
<a name="line-1082"></a><span class='hs-definition'>newTempSuffix</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-layout'>(</span><span class='hs-varid'>nextTempSuffix</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1083"></a>
<a name="line-1084"></a><a name="newTempName"></a><span class='hs-comment'>-- Find a temporary name that doesn't already exist.</span>
<a name="line-1085"></a><span class='hs-definition'>newTempName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Suffix</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-1086"></a><span class='hs-definition'>newTempName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>extn</span>
<a name="line-1087"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTempDir</span> <span class='hs-varid'>dflags</span>
<a name="line-1088"></a>       <span class='hs-varid'>findTempName</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"ghc_"</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- See Note [Deterministic base name]</span>
<a name="line-1089"></a>  <span class='hs-keyword'>where</span>
<a name="line-1090"></a>    <span class='hs-varid'>findTempName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-1091"></a>    <span class='hs-varid'>findTempName</span> <span class='hs-varid'>prefix</span>
<a name="line-1092"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempSuffix</span> <span class='hs-varid'>dflags</span>
<a name="line-1093"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefix</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>extn</span>
<a name="line-1094"></a>           <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>filename</span>
<a name="line-1095"></a>           <span class='hs-keyword'>if</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>findTempName</span> <span class='hs-varid'>prefix</span>
<a name="line-1096"></a>                <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- clean it up later</span>
<a name="line-1097"></a>                        <span class='hs-varid'>consIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>filesToClean</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>filename</span>
<a name="line-1098"></a>                        <span class='hs-varid'>return</span> <span class='hs-varid'>filename</span>
<a name="line-1099"></a>
<a name="line-1100"></a><a name="newTempLibName"></a><span class='hs-definition'>newTempLibName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Suffix</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-1101"></a><span class='hs-definition'>newTempLibName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>extn</span>
<a name="line-1102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTempDir</span> <span class='hs-varid'>dflags</span>
<a name="line-1103"></a>       <span class='hs-varid'>findTempName</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-str'>"ghc_"</span><span class='hs-layout'>)</span>
<a name="line-1104"></a>  <span class='hs-keyword'>where</span>
<a name="line-1105"></a>    <span class='hs-varid'>findTempName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-1106"></a>    <span class='hs-varid'>findTempName</span> <span class='hs-varid'>dir</span> <span class='hs-varid'>prefix</span>
<a name="line-1107"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempSuffix</span> <span class='hs-varid'>dflags</span> <span class='hs-comment'>-- See Note [Deterministic base name]</span>
<a name="line-1108"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>libname</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefix</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span>
<a name="line-1109"></a>               <span class='hs-varid'>filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"lib"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>libname</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>extn</span>
<a name="line-1110"></a>           <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>filename</span>
<a name="line-1111"></a>           <span class='hs-keyword'>if</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>findTempName</span> <span class='hs-varid'>dir</span> <span class='hs-varid'>prefix</span>
<a name="line-1112"></a>                <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- clean it up later</span>
<a name="line-1113"></a>                        <span class='hs-varid'>consIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>filesToClean</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>filename</span>
<a name="line-1114"></a>                        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>filename</span><span class='hs-layout'>,</span> <span class='hs-varid'>dir</span><span class='hs-layout'>,</span> <span class='hs-varid'>libname</span><span class='hs-layout'>)</span>
<a name="line-1115"></a>
<a name="line-1116"></a>
<a name="line-1117"></a><a name="getTempDir"></a><span class='hs-comment'>-- Return our temporary directory within tmp_dir, creating one if we</span>
<a name="line-1118"></a><span class='hs-comment'>-- don't have one yet.</span>
<a name="line-1119"></a><span class='hs-definition'>getTempDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-1120"></a><span class='hs-definition'>getTempDir</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1121"></a>    <span class='hs-varid'>mapping</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>dir_ref</span>
<a name="line-1122"></a>    <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>tmp_dir</span> <span class='hs-varid'>mapping</span> <span class='hs-keyword'>of</span>
<a name="line-1123"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1124"></a>            <span class='hs-varid'>pid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProcessID</span>
<a name="line-1125"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>prefix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmp_dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"ghc"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>pid</span> <span class='hs-varop'>++</span> <span class='hs-str'>"_"</span>
<a name="line-1126"></a>            <span class='hs-varid'>mask_</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTempDir</span> <span class='hs-varid'>prefix</span>
<a name="line-1127"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>dir</span>
<a name="line-1128"></a>  <span class='hs-keyword'>where</span>
<a name="line-1129"></a>    <span class='hs-varid'>tmp_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpDir</span> <span class='hs-varid'>dflags</span>
<a name="line-1130"></a>    <span class='hs-varid'>dir_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dirsToClean</span> <span class='hs-varid'>dflags</span>
<a name="line-1131"></a>
<a name="line-1132"></a>    <span class='hs-varid'>mkTempDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-1133"></a>    <span class='hs-varid'>mkTempDir</span> <span class='hs-varid'>prefix</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1134"></a>        <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempSuffix</span> <span class='hs-varid'>dflags</span>
<a name="line-1135"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>our_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefix</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span>
<a name="line-1136"></a>
<a name="line-1137"></a>        <span class='hs-comment'>-- 1. Speculatively create our new directory.</span>
<a name="line-1138"></a>        <span class='hs-varid'>createDirectory</span> <span class='hs-varid'>our_dir</span>
<a name="line-1139"></a>
<a name="line-1140"></a>        <span class='hs-comment'>-- 2. Update the dirsToClean mapping unless an entry already exists</span>
<a name="line-1141"></a>        <span class='hs-comment'>-- (i.e. unless another thread beat us to it).</span>
<a name="line-1142"></a>        <span class='hs-varid'>their_dir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>dir_ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>mapping</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1143"></a>            <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>tmp_dir</span> <span class='hs-varid'>mapping</span> <span class='hs-keyword'>of</span>
<a name="line-1144"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapping</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span><span class='hs-layout'>)</span>
<a name="line-1145"></a>                <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>tmp_dir</span> <span class='hs-varid'>our_dir</span> <span class='hs-varid'>mapping</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1146"></a>
<a name="line-1147"></a>        <span class='hs-comment'>-- 3. If there was an existing entry, return it and delete the</span>
<a name="line-1148"></a>        <span class='hs-comment'>-- directory we created.  Otherwise return the directory we created.</span>
<a name="line-1149"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>their_dir</span> <span class='hs-keyword'>of</span>
<a name="line-1150"></a>            <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1151"></a>                <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span>
<a name="line-1152"></a>                    <span class='hs-varid'>text</span> <span class='hs-str'>"Created temporary directory:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>our_dir</span>
<a name="line-1153"></a>                <span class='hs-varid'>return</span> <span class='hs-varid'>our_dir</span>
<a name="line-1154"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1155"></a>                <span class='hs-varid'>removeDirectory</span> <span class='hs-varid'>our_dir</span>
<a name="line-1156"></a>                <span class='hs-varid'>return</span> <span class='hs-varid'>dir</span>
<a name="line-1157"></a>      <span class='hs-varop'>`catchIO`</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isAlreadyExistsError</span> <span class='hs-varid'>e</span>
<a name="line-1158"></a>                      <span class='hs-keyword'>then</span> <span class='hs-varid'>mkTempDir</span> <span class='hs-varid'>prefix</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>ioError</span> <span class='hs-varid'>e</span>
<a name="line-1159"></a>
<a name="line-1160"></a><span class='hs-comment'>-- Note [Deterministic base name]</span>
<a name="line-1161"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1162"></a><span class='hs-comment'>--</span>
<a name="line-1163"></a><span class='hs-comment'>-- The filename of temporary files, especially the basename of C files, can end</span>
<a name="line-1164"></a><span class='hs-comment'>-- up in the output in some form, e.g. as part of linker debug information. In the</span>
<a name="line-1165"></a><span class='hs-comment'>-- interest of bit-wise exactly reproducible compilation (#4012), the basename of</span>
<a name="line-1166"></a><span class='hs-comment'>-- the temporary file no longer contains random information (it used to contain</span>
<a name="line-1167"></a><span class='hs-comment'>-- the process id).</span>
<a name="line-1168"></a><span class='hs-comment'>--</span>
<a name="line-1169"></a><span class='hs-comment'>-- This is ok, as the temporary directory used contains the pid (see getTempDir).</span>
<a name="line-1170"></a>
<a name="line-1171"></a><a name="addFilesToClean"></a><span class='hs-definition'>addFilesToClean</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1172"></a><span class='hs-comment'>-- May include wildcards [used by DriverPipeline.run_phase SplitMangle]</span>
<a name="line-1173"></a><span class='hs-definition'>addFilesToClean</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>new_files</span>
<a name="line-1174"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-layout'>(</span><span class='hs-varid'>filesToClean</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>files</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_files</span><span class='hs-varop'>++</span><span class='hs-varid'>files</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1175"></a>
<a name="line-1176"></a><a name="removeTmpDirs"></a><span class='hs-definition'>removeTmpDirs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1177"></a><span class='hs-definition'>removeTmpDirs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ds</span>
<a name="line-1178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceCmd</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Deleting temp dirs"</span>
<a name="line-1179"></a>             <span class='hs-layout'>(</span><span class='hs-str'>"Deleting: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unwords</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-1180"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>removeDirectory</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-1181"></a>
<a name="line-1182"></a><a name="removeTmpFiles"></a><span class='hs-definition'>removeTmpFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1183"></a><span class='hs-definition'>removeTmpFiles</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fs</span>
<a name="line-1184"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warnNon</span> <span class='hs-varop'>$</span>
<a name="line-1185"></a>    <span class='hs-varid'>traceCmd</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Deleting temp files"</span>
<a name="line-1186"></a>             <span class='hs-layout'>(</span><span class='hs-str'>"Deleting: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unwords</span> <span class='hs-varid'>deletees</span><span class='hs-layout'>)</span>
<a name="line-1187"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>removeFile</span><span class='hs-layout'>)</span> <span class='hs-varid'>deletees</span><span class='hs-layout'>)</span>
<a name="line-1188"></a>  <span class='hs-keyword'>where</span>
<a name="line-1189"></a>     <span class='hs-comment'>-- Flat out refuse to delete files that are likely to be source input</span>
<a name="line-1190"></a>     <span class='hs-comment'>-- files (is there a worse bug than having a compiler delete your source</span>
<a name="line-1191"></a>     <span class='hs-comment'>-- files?)</span>
<a name="line-1192"></a>     <span class='hs-comment'>--</span>
<a name="line-1193"></a>     <span class='hs-comment'>-- Deleting source files is a sign of a bug elsewhere, so prominently flag</span>
<a name="line-1194"></a>     <span class='hs-comment'>-- the condition.</span>
<a name="line-1195"></a>    <span class='hs-varid'>warnNon</span> <span class='hs-varid'>act</span>
<a name="line-1196"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>non_deletees</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span>
<a name="line-1197"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1198"></a>        <span class='hs-varid'>putMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"WARNING - NOT deleting source files:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>text</span> <span class='hs-varid'>non_deletees</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1199"></a>        <span class='hs-varid'>act</span>
<a name="line-1200"></a>
<a name="line-1201"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>non_deletees</span><span class='hs-layout'>,</span> <span class='hs-varid'>deletees</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isHaskellUserSrcFilename</span> <span class='hs-varid'>fs</span>
<a name="line-1202"></a>
<a name="line-1203"></a><a name="removeWith"></a><span class='hs-definition'>removeWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1204"></a><span class='hs-definition'>removeWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>remover</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>remover</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`catchIO`</span>
<a name="line-1205"></a>  <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1206"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isDoesNotExistError</span> <span class='hs-varid'>e</span>
<a name="line-1207"></a>             <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Warning: deleting non-existent"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>f</span>
<a name="line-1208"></a>             <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Warning: exception raised when deleting"</span>
<a name="line-1209"></a>                                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-1210"></a>               <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-1211"></a>   <span class='hs-keyword'>in</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-varid'>msg</span>
<a name="line-1212"></a>  <span class='hs-layout'>)</span>
<a name="line-1213"></a>
<a name="line-1214"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-1215"></a><span class='hs-comment'>-- Running an external program</span>
<a name="line-1216"></a>
<a name="line-1217"></a><a name="runSomething"></a><span class='hs-definition'>runSomething</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-1218"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>          <span class='hs-comment'>-- For -v message</span>
<a name="line-1219"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>          <span class='hs-comment'>-- Command name (possibly a full path)</span>
<a name="line-1220"></a>                                <span class='hs-comment'>--      assumed already dos-ified</span>
<a name="line-1221"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Arguments</span>
<a name="line-1222"></a>                                <span class='hs-comment'>--      runSomething will dos-ify them</span>
<a name="line-1223"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1224"></a>
<a name="line-1225"></a><span class='hs-definition'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>
<a name="line-1226"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-conid'>Nothing</span>
<a name="line-1227"></a>
<a name="line-1228"></a><a name="runSomethingResponseFile"></a><span class='hs-comment'>-- | Run a command, placing the arguments in an external response file.</span>
<a name="line-1229"></a><span class='hs-comment'>--</span>
<a name="line-1230"></a><span class='hs-comment'>-- This command is used in order to avoid overlong command line arguments on</span>
<a name="line-1231"></a><span class='hs-comment'>-- Windows. The command line arguments are first written to an external,</span>
<a name="line-1232"></a><span class='hs-comment'>-- temporary response file, and then passed to the linker via @filepath.</span>
<a name="line-1233"></a><span class='hs-comment'>-- response files for passing them in. See:</span>
<a name="line-1234"></a><span class='hs-comment'>--</span>
<a name="line-1235"></a><span class='hs-comment'>--     https://gcc.gnu.org/wiki/Response_Files</span>
<a name="line-1236"></a><span class='hs-comment'>--     https://ghc.haskell.org/trac/ghc/ticket/10777</span>
<a name="line-1237"></a><span class='hs-definition'>runSomethingResponseFile</span>
<a name="line-1238"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>
<a name="line-1239"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1240"></a>
<a name="line-1241"></a><span class='hs-definition'>runSomethingResponseFile</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>filter_fn</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>=</span>
<a name="line-1242"></a>    <span class='hs-varid'>runSomethingWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>real_args</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1243"></a>        <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getResponseFile</span> <span class='hs-varid'>real_args</span>
<a name="line-1244"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'@'</span><span class='hs-conop'>:</span><span class='hs-varid'>fp</span><span class='hs-keyglyph'>]</span>
<a name="line-1245"></a>        <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>builderMainLoop</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>filter_fn</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mb_env</span>
<a name="line-1246"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1247"></a>  <span class='hs-keyword'>where</span>
<a name="line-1248"></a>    <span class='hs-varid'>getResponseFile</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1249"></a>      <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempName</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"rsp"</span>
<a name="line-1250"></a>      <span class='hs-varid'>withFile</span> <span class='hs-varid'>fp</span> <span class='hs-conid'>WriteMode</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1251"></a><span class='hs-cpp'>#if defined(mingw32_HOST_OS)</span>
<a name="line-1252"></a>          <span class='hs-varid'>hSetEncoding</span> <span class='hs-varid'>h</span> <span class='hs-varid'>latin1</span>
<a name="line-1253"></a><span class='hs-cpp'>#else</span>
<a name="line-1254"></a>          <span class='hs-varid'>hSetEncoding</span> <span class='hs-varid'>h</span> <span class='hs-varid'>utf8</span>
<a name="line-1255"></a><span class='hs-cpp'>#endif</span>
<a name="line-1256"></a>          <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unlines</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>escape</span> <span class='hs-varid'>args</span>
<a name="line-1257"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>fp</span>
<a name="line-1258"></a>
<a name="line-1259"></a>    <span class='hs-comment'>-- Note: Response files have backslash-escaping, double quoting, and are</span>
<a name="line-1260"></a>    <span class='hs-comment'>-- whitespace separated (some implementations use newline, others any</span>
<a name="line-1261"></a>    <span class='hs-comment'>-- whitespace character). Therefore, escape any backslashes, newlines, and</span>
<a name="line-1262"></a>    <span class='hs-comment'>-- double quotes in the argument, and surround the content with double</span>
<a name="line-1263"></a>    <span class='hs-comment'>-- quotes.</span>
<a name="line-1264"></a>    <span class='hs-comment'>--</span>
<a name="line-1265"></a>    <span class='hs-comment'>-- Another possibility that could be considered would be to convert</span>
<a name="line-1266"></a>    <span class='hs-comment'>-- backslashes in the argument to forward slashes. This would generally do</span>
<a name="line-1267"></a>    <span class='hs-comment'>-- the right thing, since backslashes in general only appear in arguments</span>
<a name="line-1268"></a>    <span class='hs-comment'>-- as part of file paths on Windows, and the forward slash is accepted for</span>
<a name="line-1269"></a>    <span class='hs-comment'>-- those. However, escaping is more reliable, in case somehow a backslash</span>
<a name="line-1270"></a>    <span class='hs-comment'>-- appears in a non-file.</span>
<a name="line-1271"></a>    <span class='hs-varid'>escape</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span>
<a name="line-1272"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-str'>"\""</span>
<a name="line-1273"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>concatMap</span>
<a name="line-1274"></a>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1275"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>of</span>
<a name="line-1276"></a>                    <span class='hs-chr'>'\\'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"\\\\"</span>
<a name="line-1277"></a>                    <span class='hs-chr'>'\n'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"\\n"</span>
<a name="line-1278"></a>                    <span class='hs-chr'>'\"'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"\\\""</span>
<a name="line-1279"></a>                    <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1280"></a>            <span class='hs-varid'>x</span>
<a name="line-1281"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"\""</span>
<a name="line-1282"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-1283"></a>
<a name="line-1284"></a><a name="runSomethingFiltered"></a><span class='hs-definition'>runSomethingFiltered</span>
<a name="line-1285"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>
<a name="line-1286"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1287"></a>
<a name="line-1288"></a><span class='hs-definition'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>filter_fn</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1289"></a>    <span class='hs-varid'>runSomethingWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>real_args</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1290"></a>        <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>builderMainLoop</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>filter_fn</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>real_args</span> <span class='hs-varid'>mb_env</span>
<a name="line-1291"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1292"></a>
<a name="line-1293"></a><a name="runSomethingWith"></a><span class='hs-definition'>runSomethingWith</span>
<a name="line-1294"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>
<a name="line-1295"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitCode</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1296"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-1297"></a>
<a name="line-1298"></a><span class='hs-definition'>runSomethingWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1299"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>real_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>notNull</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1300"></a>      <span class='hs-varid'>cmdLine</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showCommandForUser</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>real_args</span>
<a name="line-1301"></a>  <span class='hs-varid'>traceCmd</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>cmdLine</span> <span class='hs-varop'>$</span> <span class='hs-varid'>handleProc</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>phase_name</span> <span class='hs-varop'>$</span> <span class='hs-varid'>io</span> <span class='hs-varid'>real_args</span>
<a name="line-1302"></a>
<a name="line-1303"></a><a name="handleProc"></a><span class='hs-definition'>handleProc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitCode</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>r</span>
<a name="line-1304"></a><span class='hs-definition'>handleProc</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>proc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1305"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>rc</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>proc</span> <span class='hs-varop'>`catchIO`</span> <span class='hs-varid'>handler</span>
<a name="line-1306"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>rc</span> <span class='hs-keyword'>of</span>
<a name="line-1307"></a>      <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-1308"></a>      <span class='hs-conid'>ExitFailure</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span>
<a name="line-1309"></a>            <span class='hs-conid'>ProgramError</span> <span class='hs-layout'>(</span><span class='hs-str'>"`"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>takeFileName</span> <span class='hs-varid'>pgm</span> <span class='hs-varop'>++</span> <span class='hs-str'>"'"</span> <span class='hs-varop'>++</span>
<a name="line-1310"></a>                          <span class='hs-str'>" failed in phase `"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>phase_name</span> <span class='hs-varop'>++</span> <span class='hs-str'>"'."</span> <span class='hs-varop'>++</span>
<a name="line-1311"></a>                          <span class='hs-str'>" (Exit code: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1312"></a>  <span class='hs-keyword'>where</span>
<a name="line-1313"></a>    <span class='hs-varid'>handler</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span>
<a name="line-1314"></a>       <span class='hs-keyword'>if</span> <span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-varid'>isDoesNotExistError</span> <span class='hs-varid'>err</span>
<a name="line-1315"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>does_not_exist</span>
<a name="line-1316"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>show</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-1317"></a>
<a name="line-1318"></a>    <span class='hs-varid'>does_not_exist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstallationError</span> <span class='hs-layout'>(</span><span class='hs-str'>"could not execute: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pgm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1319"></a>
<a name="line-1320"></a>
<a name="line-1321"></a><a name="builderMainLoop"></a><span class='hs-definition'>builderMainLoop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1322"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1323"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ExitCode</span>
<a name="line-1324"></a><span class='hs-definition'>builderMainLoop</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>filter_fn</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>real_args</span> <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1325"></a>  <span class='hs-varid'>chan</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newChan</span>
<a name="line-1326"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>hStdIn</span><span class='hs-layout'>,</span> <span class='hs-varid'>hStdOut</span><span class='hs-layout'>,</span> <span class='hs-varid'>hStdErr</span><span class='hs-layout'>,</span> <span class='hs-varid'>hProcess</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runInteractiveProcess</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>real_args</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>mb_env</span>
<a name="line-1327"></a>
<a name="line-1328"></a>  <span class='hs-comment'>-- and run a loop piping the output from the compiler to the log_action in DynFlags</span>
<a name="line-1329"></a>  <span class='hs-varid'>hSetBuffering</span> <span class='hs-varid'>hStdOut</span> <span class='hs-conid'>LineBuffering</span>
<a name="line-1330"></a>  <span class='hs-varid'>hSetBuffering</span> <span class='hs-varid'>hStdErr</span> <span class='hs-conid'>LineBuffering</span>
<a name="line-1331"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>readerProc</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hStdOut</span> <span class='hs-varid'>filter_fn</span><span class='hs-layout'>)</span>
<a name="line-1332"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>readerProc</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hStdErr</span> <span class='hs-varid'>filter_fn</span><span class='hs-layout'>)</span>
<a name="line-1333"></a>  <span class='hs-comment'>-- we don't want to finish until 2 streams have been completed</span>
<a name="line-1334"></a>  <span class='hs-comment'>-- (stdout and stderr)</span>
<a name="line-1335"></a>  <span class='hs-comment'>-- nor until 1 exit code has been retrieved.</span>
<a name="line-1336"></a>  <span class='hs-varid'>rc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Integer</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Integer</span><span class='hs-layout'>)</span> <span class='hs-conid'>ExitSuccess</span>
<a name="line-1337"></a>  <span class='hs-comment'>-- after that, we're done here.</span>
<a name="line-1338"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hStdIn</span>
<a name="line-1339"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hStdOut</span>
<a name="line-1340"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hStdErr</span>
<a name="line-1341"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>rc</span>
<a name="line-1342"></a>  <span class='hs-keyword'>where</span>
<a name="line-1343"></a>    <span class='hs-comment'>-- status starts at zero, and increments each time either</span>
<a name="line-1344"></a>    <span class='hs-comment'>-- a reader process gets EOF, or the build proc exits.  We wait</span>
<a name="line-1345"></a>    <span class='hs-comment'>-- for all of these to happen (status==3).</span>
<a name="line-1346"></a>    <span class='hs-comment'>-- ToDo: we should really have a contingency plan in case any of</span>
<a name="line-1347"></a>    <span class='hs-comment'>-- the threads dies, such as a timeout.</span>
<a name="line-1348"></a>    <span class='hs-varid'>loop</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span>        <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>exitcode</span>
<a name="line-1349"></a>    <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1350"></a>      <span class='hs-varid'>mb_code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>p</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-1351"></a>                   <span class='hs-keyword'>then</span> <span class='hs-varid'>getProcessExitCode</span> <span class='hs-varid'>hProcess</span>
<a name="line-1352"></a>                   <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1353"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_code</span> <span class='hs-keyword'>of</span>
<a name="line-1354"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>code</span>
<a name="line-1355"></a>        <span class='hs-conid'>Nothing</span>
<a name="line-1356"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1357"></a>              <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readChan</span> <span class='hs-varid'>chan</span>
<a name="line-1358"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>msg</span> <span class='hs-keyword'>of</span>
<a name="line-1359"></a>                <span class='hs-conid'>BuildMsg</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1360"></a>                  <span class='hs-varid'>putLogMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>NoReason</span> <span class='hs-conid'>SevInfo</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-1361"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>defaultUserStyle</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>msg</span>
<a name="line-1362"></a>                  <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span>
<a name="line-1363"></a>                <span class='hs-conid'>BuildError</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1364"></a>                  <span class='hs-varid'>putLogMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>NoReason</span> <span class='hs-conid'>SevError</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-1365"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>defaultUserStyle</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>msg</span>
<a name="line-1366"></a>                  <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span>
<a name="line-1367"></a>                <span class='hs-conid'>EOF</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1368"></a>                  <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span>
<a name="line-1369"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span>
<a name="line-1370"></a>
<a name="line-1371"></a><a name="readerProc"></a><span class='hs-definition'>readerProc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Chan</span> <span class='hs-conid'>BuildMessage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1372"></a><span class='hs-definition'>readerProc</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hdl</span> <span class='hs-varid'>filter_fn</span> <span class='hs-keyglyph'>=</span>
<a name="line-1373"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetContents</span> <span class='hs-varid'>hdl</span>
<a name="line-1374"></a>        <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>linesPlatform</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter_fn</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1375"></a>    <span class='hs-varop'>`finally`</span>
<a name="line-1376"></a>       <span class='hs-varid'>writeChan</span> <span class='hs-varid'>chan</span> <span class='hs-conid'>EOF</span>
<a name="line-1377"></a>        <span class='hs-comment'>-- ToDo: check errors more carefully</span>
<a name="line-1378"></a>        <span class='hs-comment'>-- ToDo: in the future, the filter should be implemented as</span>
<a name="line-1379"></a>        <span class='hs-comment'>-- a stream transformer.</span>
<a name="line-1380"></a>    <span class='hs-keyword'>where</span>
<a name="line-1381"></a>        <span class='hs-varid'>loop</span> <span class='hs-conid'>[]</span>     <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1382"></a>        <span class='hs-varid'>loop</span> <span class='hs-conid'>[]</span>     <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeChan</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>err</span>
<a name="line-1383"></a>        <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-varid'>ls</span><span class='hs-layout'>)</span> <span class='hs-varid'>in_err</span>     <span class='hs-keyglyph'>=</span>
<a name="line-1384"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>in_err</span> <span class='hs-keyword'>of</span>
<a name="line-1385"></a>                  <span class='hs-conid'>Just</span> <span class='hs-varid'>err</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BuildError</span> <span class='hs-varid'>srcLoc</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-1386"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>leading_whitespace</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1387"></a>                        <span class='hs-varid'>loop</span> <span class='hs-varid'>ls</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuildError</span> <span class='hs-varid'>srcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1388"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1389"></a>                        <span class='hs-varid'>writeChan</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>err</span>
<a name="line-1390"></a>                        <span class='hs-varid'>checkError</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ls</span>
<a name="line-1391"></a>                  <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1392"></a>                        <span class='hs-varid'>checkError</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ls</span>
<a name="line-1393"></a>                  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"readerProc/loop"</span>
<a name="line-1394"></a>
<a name="line-1395"></a>        <span class='hs-varid'>checkError</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ls</span>
<a name="line-1396"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>parseError</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>of</span>
<a name="line-1397"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1398"></a>                    <span class='hs-varid'>writeChan</span> <span class='hs-varid'>chan</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuildMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1399"></a>                    <span class='hs-varid'>loop</span> <span class='hs-varid'>ls</span> <span class='hs-conid'>Nothing</span>
<a name="line-1400"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>file</span><span class='hs-layout'>,</span> <span class='hs-varid'>lineNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>colNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1401"></a>                    <span class='hs-keyword'>let</span> <span class='hs-varid'>srcLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span> <span class='hs-varid'>lineNum</span> <span class='hs-varid'>colNum</span>
<a name="line-1402"></a>                    <span class='hs-varid'>loop</span> <span class='hs-varid'>ls</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuildError</span> <span class='hs-varid'>srcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1403"></a>
<a name="line-1404"></a>        <span class='hs-varid'>leading_whitespace</span> <span class='hs-conid'>[]</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1405"></a>        <span class='hs-varid'>leading_whitespace</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSpace</span> <span class='hs-varid'>x</span>
<a name="line-1406"></a>
<a name="line-1407"></a><a name="parseError"></a><span class='hs-definition'>parseError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-1408"></a><span class='hs-definition'>parseError</span> <span class='hs-varid'>s0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>breakColon</span> <span class='hs-varid'>s0</span> <span class='hs-keyword'>of</span>
<a name="line-1409"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>filename</span><span class='hs-layout'>,</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1410"></a>                    <span class='hs-keyword'>case</span> <span class='hs-varid'>breakIntColon</span> <span class='hs-varid'>s1</span> <span class='hs-keyword'>of</span>
<a name="line-1411"></a>                    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>lineNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1412"></a>                        <span class='hs-keyword'>case</span> <span class='hs-varid'>breakIntColon</span> <span class='hs-varid'>s2</span> <span class='hs-keyword'>of</span>
<a name="line-1413"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>columnNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>s3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1414"></a>                            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>filename</span><span class='hs-layout'>,</span> <span class='hs-varid'>lineNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>columnNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>s3</span><span class='hs-layout'>)</span>
<a name="line-1415"></a>                        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1416"></a>                            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>filename</span><span class='hs-layout'>,</span> <span class='hs-varid'>lineNum</span><span class='hs-layout'>,</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-1417"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1418"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1419"></a>
<a name="line-1420"></a><a name="breakColon"></a><span class='hs-definition'>breakColon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-1421"></a><span class='hs-definition'>breakColon</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>break</span> <span class='hs-layout'>(</span><span class='hs-chr'>':'</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-1422"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span>
<a name="line-1423"></a>                    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1424"></a>
<a name="line-1425"></a><a name="breakIntColon"></a><span class='hs-definition'>breakIntColon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-1426"></a><span class='hs-definition'>breakIntColon</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>break</span> <span class='hs-layout'>(</span><span class='hs-chr'>':'</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-1427"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>zs</span><span class='hs-layout'>)</span>
<a name="line-1428"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isAscii</span> <span class='hs-varid'>ys</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isDigit</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1429"></a>                           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>read</span> <span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span>
<a name="line-1430"></a>                       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1431"></a>
<a name="line-1432"></a><a name="BuildMessage"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>BuildMessage</span>
<a name="line-1433"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BuildMsg</span>   <span class='hs-varop'>!</span><span class='hs-conid'>SDoc</span>
<a name="line-1434"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BuildError</span> <span class='hs-varop'>!</span><span class='hs-conid'>SrcLoc</span> <span class='hs-varop'>!</span><span class='hs-conid'>SDoc</span>
<a name="line-1435"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EOF</span>
<a name="line-1436"></a>
<a name="line-1437"></a><a name="traceCmd"></a><span class='hs-definition'>traceCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-1438"></a><span class='hs-comment'>-- trace the command (at two levels of verbosity)</span>
<a name="line-1439"></a><span class='hs-definition'>traceCmd</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>cmd_line</span> <span class='hs-varid'>action</span>
<a name="line-1440"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>   <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>verb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>dflags</span>
<a name="line-1441"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span>
<a name="line-1442"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>3</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>cmd_line</span><span class='hs-layout'>)</span>
<a name="line-1443"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flushErr</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-1444"></a>              <span class='hs-conid'>FlushErr</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>io</span>
<a name="line-1445"></a>
<a name="line-1446"></a>           <span class='hs-comment'>-- And run it!</span>
<a name="line-1447"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>action</span> <span class='hs-varop'>`catchIO`</span> <span class='hs-varid'>handle_exn</span> <span class='hs-varid'>verb</span>
<a name="line-1448"></a>        <span class='hs-layout'>}</span>
<a name="line-1449"></a>  <span class='hs-keyword'>where</span>
<a name="line-1450"></a>    <span class='hs-varid'>handle_exn</span> <span class='hs-sel'>_verb</span> <span class='hs-varid'>exn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'\n'</span><span class='hs-layout'>)</span>
<a name="line-1451"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Failed:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>cmd_line</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>exn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1452"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>exn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-1453"></a>
<a name="line-1454"></a><span class='hs-comment'>{-
<a name="line-1455"></a>************************************************************************
<a name="line-1456"></a>*                                                                      *
<a name="line-1457"></a>\subsection{Support code}
<a name="line-1458"></a>*                                                                      *
<a name="line-1459"></a>************************************************************************
<a name="line-1460"></a>-}</span>
<a name="line-1461"></a>
<a name="line-1462"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-1463"></a><span class='hs-comment'>-- Define       getBaseDir     :: IO (Maybe String)</span>
<a name="line-1464"></a>
<a name="line-1465"></a><a name="getBaseDir"></a><span class='hs-definition'>getBaseDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-1466"></a><span class='hs-cpp'>#if defined(mingw32_HOST_OS)</span>
<a name="line-1467"></a><span class='hs-comment'>-- Assuming we are running ghc, accessed by path  $(stuff)/&lt;foo&gt;/ghc.exe,</span>
<a name="line-1468"></a><span class='hs-comment'>-- return the path $(stuff)/lib.</span>
<a name="line-1469"></a><span class='hs-definition'>getBaseDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>try_size</span> <span class='hs-num'>2048</span> <span class='hs-comment'>-- plenty, PATH_MAX is 512 under Win32.</span>
<a name="line-1470"></a>  <span class='hs-keyword'>where</span>
<a name="line-1471"></a>    <span class='hs-varid'>try_size</span> <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allocaArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>buf</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1472"></a>        <span class='hs-varid'>ret</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>c_GetModuleFileName</span> <span class='hs-varid'>nullPtr</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>size</span>
<a name="line-1473"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>ret</span> <span class='hs-keyword'>of</span>
<a name="line-1474"></a>          <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1475"></a>          <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ret</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>size</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1476"></a>                <span class='hs-varid'>path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peekCWString</span> <span class='hs-varid'>buf</span>
<a name="line-1477"></a>                <span class='hs-varid'>real</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFinalPath</span> <span class='hs-varid'>path</span> <span class='hs-comment'>-- try to resolve symlinks paths</span>
<a name="line-1478"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>libdir</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>rootDir</span> <span class='hs-varop'>.</span> <span class='hs-varid'>sanitize</span> <span class='hs-varop'>.</span> <span class='hs-varid'>maybe</span> <span class='hs-varid'>path</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>real</span>
<a name="line-1479"></a>                <span class='hs-varid'>exists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesDirectoryExist</span> <span class='hs-varid'>libdir</span>
<a name="line-1480"></a>                <span class='hs-keyword'>if</span> <span class='hs-varid'>exists</span>
<a name="line-1481"></a>                   <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>libdir</span>
<a name="line-1482"></a>                   <span class='hs-keyword'>else</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>path</span>
<a name="line-1483"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>try_size</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-varop'>*</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-1484"></a>
<a name="line-1485"></a>    <span class='hs-comment'>-- getFinalPath returns paths in full raw form.</span>
<a name="line-1486"></a>    <span class='hs-comment'>-- Unfortunately GHC isn't set up to handle these</span>
<a name="line-1487"></a>    <span class='hs-comment'>-- So if the call succeeded, we need to drop the</span>
<a name="line-1488"></a>    <span class='hs-comment'>-- \\?\ prefix.</span>
<a name="line-1489"></a>    <span class='hs-varid'>sanitize</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-str'>"\\\\?\\"</span> <span class='hs-varop'>`isPrefixOf`</span> <span class='hs-varid'>s</span>
<a name="line-1490"></a>                    <span class='hs-keyword'>then</span> <span class='hs-varid'>drop</span> <span class='hs-num'>4</span> <span class='hs-varid'>s</span>
<a name="line-1491"></a>                    <span class='hs-keyword'>else</span> <span class='hs-varid'>s</span>
<a name="line-1492"></a>
<a name="line-1493"></a>    <span class='hs-varid'>rootDir</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitFileName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>normalise</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-1494"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-varid'>ghc_exe</span><span class='hs-layout'>)</span>
<a name="line-1495"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lower</span> <span class='hs-varid'>ghc_exe</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"ghc.exe"</span><span class='hs-layout'>,</span>
<a name="line-1496"></a>                                         <span class='hs-str'>"ghc-stage1.exe"</span><span class='hs-layout'>,</span>
<a name="line-1497"></a>                                         <span class='hs-str'>"ghc-stage2.exe"</span><span class='hs-layout'>,</span>
<a name="line-1498"></a>                                         <span class='hs-str'>"ghc-stage3.exe"</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1499"></a>                    <span class='hs-keyword'>case</span> <span class='hs-varid'>splitFileName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeDirectory</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>of</span>
<a name="line-1500"></a>                    <span class='hs-comment'>-- ghc is in $topdir/bin/ghc.exe</span>
<a name="line-1501"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>d'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>takeDirectory</span> <span class='hs-varid'>d'</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"lib"</span>
<a name="line-1502"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>s</span>
<a name="line-1503"></a>
<a name="line-1504"></a>    <span class='hs-varid'>fail</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"can't decompose ghc.exe path: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1505"></a>    <span class='hs-varid'>lower</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toLower</span>
<a name="line-1506"></a>
<a name="line-1507"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>WINDOWS_CCONV</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"windows.h GetModuleFileNameW"</span>
<a name="line-1508"></a>  <span class='hs-varid'>c_GetModuleFileName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CWString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word32</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Word32</span>
<a name="line-1509"></a>
<a name="line-1510"></a><a name="getFinalPath"></a><span class='hs-comment'>-- Attempt to resolve symlinks in order to find the actual location GHC</span>
<a name="line-1511"></a><span class='hs-comment'>-- is located at. See Trac #11759.</span>
<a name="line-1512"></a><span class='hs-definition'>getFinalPath</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-1513"></a><span class='hs-definition'>getFinalPath</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1514"></a>    <span class='hs-varid'>dllHwnd</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>failIfNull</span> <span class='hs-str'>"LoadLibray"</span>     <span class='hs-varop'>$</span> <span class='hs-varid'>loadLibrary</span> <span class='hs-str'>"kernel32.dll"</span>
<a name="line-1515"></a>    <span class='hs-comment'>-- Note: The API GetFinalPathNameByHandleW is only available starting from Windows Vista.</span>
<a name="line-1516"></a>    <span class='hs-comment'>-- This means that we can't bind directly to it since it may be missing.</span>
<a name="line-1517"></a>    <span class='hs-comment'>-- Instead try to find it's address at runtime and if we don't succeed consider the</span>
<a name="line-1518"></a>    <span class='hs-comment'>-- function failed.</span>
<a name="line-1519"></a>    <span class='hs-varid'>addr_m</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>failIfNull</span> <span class='hs-str'>"getProcAddress"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getProcAddress</span> <span class='hs-varid'>dllHwnd</span> <span class='hs-str'>"GetFinalPathNameByHandleW"</span><span class='hs-layout'>)</span>
<a name="line-1520"></a>                  <span class='hs-varop'>`catch`</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1521"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>addr_m</span> <span class='hs-keyword'>of</span>
<a name="line-1522"></a>      <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1523"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>addr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>handle</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>failIf</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-varid'>iNVALID_HANDLE_VALUE</span><span class='hs-layout'>)</span> <span class='hs-str'>"CreateFile"</span>
<a name="line-1524"></a>                                        <span class='hs-varop'>$</span> <span class='hs-varid'>createFile</span> <span class='hs-varid'>name</span>
<a name="line-1525"></a>                                                     <span class='hs-varid'>gENERIC_READ</span>
<a name="line-1526"></a>                                                     <span class='hs-varid'>fILE_SHARE_READ</span>
<a name="line-1527"></a>                                                     <span class='hs-conid'>Nothing</span>
<a name="line-1528"></a>                                                     <span class='hs-varid'>oPEN_EXISTING</span>
<a name="line-1529"></a>                                                     <span class='hs-layout'>(</span><span class='hs-varid'>fILE_ATTRIBUTE_NORMAL</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>fILE_FLAG_BACKUP_SEMANTICS</span><span class='hs-layout'>)</span>
<a name="line-1530"></a>                                                     <span class='hs-conid'>Nothing</span>
<a name="line-1531"></a>                      <span class='hs-keyword'>let</span> <span class='hs-varid'>fnPtr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeGetFinalPathNameByHandle</span> <span class='hs-varop'>$</span> <span class='hs-varid'>castPtrToFunPtr</span> <span class='hs-varid'>addr</span>
<a name="line-1532"></a>                      <span class='hs-comment'>-- First try to resolve the path to get the actual path</span>
<a name="line-1533"></a>                      <span class='hs-comment'>-- of any symlinks or other file system redirections that</span>
<a name="line-1534"></a>                      <span class='hs-comment'>-- may be in place. However this function can fail, and in</span>
<a name="line-1535"></a>                      <span class='hs-comment'>-- the event it does fail, we need to try using the</span>
<a name="line-1536"></a>                      <span class='hs-comment'>-- original path and see if we can decompose that.</span>
<a name="line-1537"></a>                      <span class='hs-comment'>-- If the call fails Win32.try will raise an exception</span>
<a name="line-1538"></a>                      <span class='hs-comment'>-- that needs to be caught. See #14159</span>
<a name="line-1539"></a>                      <span class='hs-varid'>path</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-conid'>Win32</span><span class='hs-varop'>.</span><span class='hs-varid'>try</span> <span class='hs-str'>"GetFinalPathName"</span>
<a name="line-1540"></a>                                    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>buf</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fnPtr</span> <span class='hs-varid'>handle</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>len</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-num'>512</span>
<a name="line-1541"></a>                                    <span class='hs-varop'>`finally`</span> <span class='hs-varid'>closeHandle</span> <span class='hs-varid'>handle</span><span class='hs-layout'>)</span>
<a name="line-1542"></a>                                <span class='hs-varop'>`catch`</span>
<a name="line-1543"></a>                                 <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IOException</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1544"></a>                      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>path</span>
<a name="line-1545"></a>
<a name="line-1546"></a><a name="GetFinalPath"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>GetFinalPath</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HANDLE</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LPTSTR</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DWORD</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DWORD</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>DWORD</span>
<a name="line-1547"></a>
<a name="line-1548"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>WINDOWS_CCONV</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"dynamic"</span>
<a name="line-1549"></a>  <span class='hs-varid'>makeGetFinalPathNameByHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunPtr</span> <span class='hs-conid'>GetFinalPath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GetFinalPath</span>
<a name="line-1550"></a><span class='hs-cpp'>#else</span>
<a name="line-1551"></a><span class='hs-definition'>getBaseDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1552"></a><span class='hs-cpp'>#endif</span>
<a name="line-1553"></a>
<a name="line-1554"></a><span class='hs-cpp'>#ifdef mingw32_HOST_OS</span>
<a name="line-1555"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"_getpid"</span> <span class='hs-varid'>getProcessID</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- relies on Int == Int32 on Windows</span>
<a name="line-1556"></a><span class='hs-cpp'>#else</span>
<a name="line-1557"></a><a name="getProcessID"></a><span class='hs-definition'>getProcessID</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span>
<a name="line-1558"></a><span class='hs-definition'>getProcessID</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Posix</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-varid'>c_getpid</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromIntegral</span>
<a name="line-1559"></a><span class='hs-cpp'>#endif</span>
<a name="line-1560"></a>
<a name="line-1561"></a><a name="linesPlatform"></a><span class='hs-comment'>-- Divvy up text stream into lines, taking platform dependent</span>
<a name="line-1562"></a><span class='hs-comment'>-- line termination into account.</span>
<a name="line-1563"></a><span class='hs-definition'>linesPlatform</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-1564"></a><span class='hs-cpp'>#if !defined(mingw32_HOST_OS)</span>
<a name="line-1565"></a><span class='hs-definition'>linesPlatform</span> <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lines</span> <span class='hs-varid'>ls</span>
<a name="line-1566"></a><span class='hs-cpp'>#else</span>
<a name="line-1567"></a><span class='hs-definition'>linesPlatform</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1568"></a><span class='hs-definition'>linesPlatform</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span>
<a name="line-1569"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>lineBreak</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-1570"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>xs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>as</span> <span class='hs-conop'>:</span> <span class='hs-varid'>linesPlatform</span> <span class='hs-varid'>xs1</span>
<a name="line-1571"></a>  <span class='hs-keyword'>where</span>
<a name="line-1572"></a>   <span class='hs-varid'>lineBreak</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-str'>""</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span>
<a name="line-1573"></a>   <span class='hs-varid'>lineBreak</span> <span class='hs-layout'>(</span><span class='hs-chr'>'\r'</span><span class='hs-conop'>:</span><span class='hs-chr'>'\n'</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-1574"></a>   <span class='hs-varid'>lineBreak</span> <span class='hs-layout'>(</span><span class='hs-chr'>'\n'</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-1575"></a>   <span class='hs-varid'>lineBreak</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lineBreak</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-1576"></a>
<a name="line-1577"></a><span class='hs-cpp'>#endif</span>
<a name="line-1578"></a>
<a name="line-1579"></a><a name="linkDynLib"></a><span class='hs-definition'>linkDynLib</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstalledUnitId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1580"></a><span class='hs-definition'>linkDynLib</span> <span class='hs-varid'>dflags0</span> <span class='hs-varid'>o_files</span> <span class='hs-varid'>dep_packages</span>
<a name="line-1581"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1582"></a>    <span class='hs-keyword'>let</span> <span class='hs-comment'>-- This is a rather ugly hack to fix dynamically linked</span>
<a name="line-1583"></a>        <span class='hs-comment'>-- GHC on Windows. If GHC is linked with -threaded, then</span>
<a name="line-1584"></a>        <span class='hs-comment'>-- it links against libHSrts_thr. But if base is linked</span>
<a name="line-1585"></a>        <span class='hs-comment'>-- against libHSrts, then both end up getting loaded,</span>
<a name="line-1586"></a>        <span class='hs-comment'>-- and things go wrong. We therefore link the libraries</span>
<a name="line-1587"></a>        <span class='hs-comment'>-- with the same RTS flags that we link GHC with.</span>
<a name="line-1588"></a>        <span class='hs-varid'>dflags1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>cGhcThreaded</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>addWay'</span> <span class='hs-conid'>WayThreaded</span> <span class='hs-varid'>dflags0</span>
<a name="line-1589"></a>                                  <span class='hs-keyword'>else</span>                     <span class='hs-varid'>dflags0</span>
<a name="line-1590"></a>        <span class='hs-varid'>dflags2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>cGhcDebugged</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>addWay'</span> <span class='hs-conid'>WayDebug</span> <span class='hs-varid'>dflags1</span>
<a name="line-1591"></a>                                  <span class='hs-keyword'>else</span>                  <span class='hs-varid'>dflags1</span>
<a name="line-1592"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateWays</span> <span class='hs-varid'>dflags2</span>
<a name="line-1593"></a>
<a name="line-1594"></a>        <span class='hs-varid'>verbFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getVerbFlags</span> <span class='hs-varid'>dflags</span>
<a name="line-1595"></a>        <span class='hs-varid'>o_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>outputFile</span> <span class='hs-varid'>dflags</span>
<a name="line-1596"></a>
<a name="line-1597"></a>    <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPreloadPackagesAnd</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dep_packages</span>
<a name="line-1598"></a>
<a name="line-1599"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>pkg_lib_paths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectLibraryPaths</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pkgs</span>
<a name="line-1600"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>pkg_lib_path_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>get_pkg_lib_path_opts</span> <span class='hs-varid'>pkg_lib_paths</span>
<a name="line-1601"></a>        <span class='hs-varid'>get_pkg_lib_path_opts</span> <span class='hs-varid'>l</span>
<a name="line-1602"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span> <span class='hs-varid'>osElfTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformOS</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-1603"></a>             <span class='hs-varid'>osMachOTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformOS</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-1604"></a>           <span class='hs-varid'>dynLibLoader</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>SystemDependent</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-1605"></a>           <span class='hs-conid'>WayDyn</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>ways</span> <span class='hs-varid'>dflags</span>
<a name="line-1606"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-L"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-str'>"-Xlinker"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-rpath"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-Xlinker"</span><span class='hs-layout'>,</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span>
<a name="line-1607"></a>              <span class='hs-comment'>-- See Note [-Xlinker -rpath vs -Wl,-rpath]</span>
<a name="line-1608"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-L"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span>
<a name="line-1609"></a>
<a name="line-1610"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>lib_paths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libraryPaths</span> <span class='hs-varid'>dflags</span>
<a name="line-1611"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>lib_path_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-str'>"-L"</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>lib_paths</span>
<a name="line-1612"></a>
<a name="line-1613"></a>    <span class='hs-comment'>-- We don't want to link our dynamic libs against the RTS package,</span>
<a name="line-1614"></a>    <span class='hs-comment'>-- because the RTS lib comes in several flavours and we want to be</span>
<a name="line-1615"></a>    <span class='hs-comment'>-- able to pick the flavour when a binary is linked.</span>
<a name="line-1616"></a>    <span class='hs-comment'>-- On Windows we need to link the RTS import lib as Windows does</span>
<a name="line-1617"></a>    <span class='hs-comment'>-- not allow undefined symbols.</span>
<a name="line-1618"></a>    <span class='hs-comment'>-- The RTS library path is still added to the library search path</span>
<a name="line-1619"></a>    <span class='hs-comment'>-- above in case the RTS is being explicitly linked in (see #3807).</span>
<a name="line-1620"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-1621"></a>        <span class='hs-varid'>os</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span>
<a name="line-1622"></a>        <span class='hs-varid'>pkgs_no_rts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>os</span> <span class='hs-keyword'>of</span>
<a name="line-1623"></a>                      <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1624"></a>                          <span class='hs-varid'>pkgs</span>
<a name="line-1625"></a>                      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1626"></a>                          <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-varid'>rtsUnitId</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>packageConfigId</span><span class='hs-layout'>)</span> <span class='hs-varid'>pkgs</span>
<a name="line-1627"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>pkg_link_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>package_hs_libs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra_libs</span><span class='hs-layout'>,</span> <span class='hs-varid'>other_flags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectLinkOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pkgs_no_rts</span>
<a name="line-1628"></a>                        <span class='hs-keyword'>in</span>  <span class='hs-varid'>package_hs_libs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>extra_libs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>other_flags</span>
<a name="line-1629"></a>
<a name="line-1630"></a>        <span class='hs-comment'>-- probably _stub.o files</span>
<a name="line-1631"></a>        <span class='hs-comment'>-- and last temporary shared object file</span>
<a name="line-1632"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>extra_ld_inputs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldInputs</span> <span class='hs-varid'>dflags</span>
<a name="line-1633"></a>
<a name="line-1634"></a>    <span class='hs-comment'>-- frameworks</span>
<a name="line-1635"></a>    <span class='hs-varid'>pkg_framework_opts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPkgFrameworkOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>platform</span>
<a name="line-1636"></a>                                              <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unitId</span> <span class='hs-varid'>pkgs</span><span class='hs-layout'>)</span>
<a name="line-1637"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>framework_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getFrameworkOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>platform</span>
<a name="line-1638"></a>
<a name="line-1639"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>os</span> <span class='hs-keyword'>of</span>
<a name="line-1640"></a>        <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1641"></a>            <span class='hs-comment'>-------------------------------------------------------------</span>
<a name="line-1642"></a>            <span class='hs-comment'>-- Making a DLL</span>
<a name="line-1643"></a>            <span class='hs-comment'>-------------------------------------------------------------</span>
<a name="line-1644"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>output_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>o_file</span> <span class='hs-keyword'>of</span>
<a name="line-1645"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span>
<a name="line-1646"></a>                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"HSdll.dll"</span>
<a name="line-1647"></a>
<a name="line-1648"></a>            <span class='hs-varid'>runLink</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span>
<a name="line-1649"></a>                    <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>verbFlags</span>
<a name="line-1650"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-o"</span>
<a name="line-1651"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>output_fn</span>
<a name="line-1652"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-shared"</span>
<a name="line-1653"></a>                    <span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-1654"></a>                    <span class='hs-keyglyph'>[</span> <span class='hs-conid'>FileOption</span> <span class='hs-str'>"-Wl,--out-implib="</span> <span class='hs-layout'>(</span><span class='hs-varid'>output_fn</span> <span class='hs-varop'>++</span> <span class='hs-str'>".a"</span><span class='hs-layout'>)</span>
<a name="line-1655"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_SharedImplib</span> <span class='hs-varid'>dflags</span>
<a name="line-1656"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-1657"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span> <span class='hs-varid'>o_files</span>
<a name="line-1658"></a>
<a name="line-1659"></a>                 <span class='hs-comment'>-- Permit the linker to auto link _symbol to _imp_symbol</span>
<a name="line-1660"></a>                 <span class='hs-comment'>-- This lets us link against DLLs without needing an "import library"</span>
<a name="line-1661"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-Wl,--enable-auto-import"</span><span class='hs-keyglyph'>]</span>
<a name="line-1662"></a>
<a name="line-1663"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>extra_ld_inputs</span>
<a name="line-1664"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span>
<a name="line-1665"></a>                    <span class='hs-varid'>lib_path_opts</span>
<a name="line-1666"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>pkg_lib_path_opts</span>
<a name="line-1667"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>pkg_link_opts</span>
<a name="line-1668"></a>                <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1669"></a>        <span class='hs-conid'>OSDarwin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1670"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-1671"></a>            <span class='hs-comment'>-- Making a darwin dylib</span>
<a name="line-1672"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-1673"></a>            <span class='hs-comment'>-- About the options used for Darwin:</span>
<a name="line-1674"></a>            <span class='hs-comment'>-- -dynamiclib</span>
<a name="line-1675"></a>            <span class='hs-comment'>--   Apple's way of saying -shared</span>
<a name="line-1676"></a>            <span class='hs-comment'>-- -undefined dynamic_lookup:</span>
<a name="line-1677"></a>            <span class='hs-comment'>--   Without these options, we'd have to specify the correct</span>
<a name="line-1678"></a>            <span class='hs-comment'>--   dependencies for each of the dylibs. Note that we could</span>
<a name="line-1679"></a>            <span class='hs-comment'>--   (and should) do without this for all libraries except</span>
<a name="line-1680"></a>            <span class='hs-comment'>--   the RTS; all we need to do is to pass the correct</span>
<a name="line-1681"></a>            <span class='hs-comment'>--   HSfoo_dyn.dylib files to the link command.</span>
<a name="line-1682"></a>            <span class='hs-comment'>--   This feature requires Mac OS X 10.3 or later; there is</span>
<a name="line-1683"></a>            <span class='hs-comment'>--   a similar feature, -flat_namespace -undefined suppress,</span>
<a name="line-1684"></a>            <span class='hs-comment'>--   which works on earlier versions, but it has other</span>
<a name="line-1685"></a>            <span class='hs-comment'>--   disadvantages.</span>
<a name="line-1686"></a>            <span class='hs-comment'>-- -single_module</span>
<a name="line-1687"></a>            <span class='hs-comment'>--   Build the dynamic library as a single "module", i.e. no</span>
<a name="line-1688"></a>            <span class='hs-comment'>--   dynamic binding nonsense when referring to symbols from</span>
<a name="line-1689"></a>            <span class='hs-comment'>--   within the library. The NCG assumes that this option is</span>
<a name="line-1690"></a>            <span class='hs-comment'>--   specified (on i386, at least).</span>
<a name="line-1691"></a>            <span class='hs-comment'>-- -install_name</span>
<a name="line-1692"></a>            <span class='hs-comment'>--   Mac OS/X stores the path where a dynamic library is (to</span>
<a name="line-1693"></a>            <span class='hs-comment'>--   be) installed in the library itself.  It's called the</span>
<a name="line-1694"></a>            <span class='hs-comment'>--   "install name" of the library. Then any library or</span>
<a name="line-1695"></a>            <span class='hs-comment'>--   executable that links against it before it's installed</span>
<a name="line-1696"></a>            <span class='hs-comment'>--   will search for it in its ultimate install location.</span>
<a name="line-1697"></a>            <span class='hs-comment'>--   By default we set the install name to the absolute path</span>
<a name="line-1698"></a>            <span class='hs-comment'>--   at build time, but it can be overridden by the</span>
<a name="line-1699"></a>            <span class='hs-comment'>--   -dylib-install-name option passed to ghc. Cabal does</span>
<a name="line-1700"></a>            <span class='hs-comment'>--   this.</span>
<a name="line-1701"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-1702"></a>
<a name="line-1703"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>output_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>o_file</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"a.out"</span><span class='hs-layout'>;</span> <span class='hs-layout'>}</span>
<a name="line-1704"></a>
<a name="line-1705"></a>            <span class='hs-varid'>instName</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dylibInstallName</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-1706"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n</span>
<a name="line-1707"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-str'>"@rpath"</span> <span class='hs-varop'>`combine`</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeFileName</span> <span class='hs-varid'>output_fn</span><span class='hs-layout'>)</span>
<a name="line-1708"></a>            <span class='hs-varid'>runLink</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span>
<a name="line-1709"></a>                    <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>verbFlags</span>
<a name="line-1710"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-dynamiclib"</span>
<a name="line-1711"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-o"</span>
<a name="line-1712"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>output_fn</span>
<a name="line-1713"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-1714"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>o_files</span>
<a name="line-1715"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-undefined"</span><span class='hs-layout'>,</span>
<a name="line-1716"></a>                      <span class='hs-conid'>Option</span> <span class='hs-str'>"dynamic_lookup"</span><span class='hs-layout'>,</span>
<a name="line-1717"></a>                      <span class='hs-conid'>Option</span> <span class='hs-str'>"-single_module"</span> <span class='hs-keyglyph'>]</span>
<a name="line-1718"></a>                 <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ArchX86_64</span>
<a name="line-1719"></a>                     <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyglyph'>]</span>
<a name="line-1720"></a>                     <span class='hs-keyword'>else</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-Wl,-read_only_relocs,suppress"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1721"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-install_name"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>instName</span> <span class='hs-keyglyph'>]</span>
<a name="line-1722"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>lib_path_opts</span>
<a name="line-1723"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>extra_ld_inputs</span>
<a name="line-1724"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>framework_opts</span>
<a name="line-1725"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>pkg_lib_path_opts</span>
<a name="line-1726"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>pkg_link_opts</span>
<a name="line-1727"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>pkg_framework_opts</span>
<a name="line-1728"></a>              <span class='hs-layout'>)</span>
<a name="line-1729"></a>        <span class='hs-conid'>OSiOS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>"dynamic libraries are not supported on iOS target"</span><span class='hs-layout'>)</span>
<a name="line-1730"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1731"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-1732"></a>            <span class='hs-comment'>-- Making a DSO</span>
<a name="line-1733"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-1734"></a>
<a name="line-1735"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>output_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>o_file</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"a.out"</span><span class='hs-layout'>;</span> <span class='hs-layout'>}</span>
<a name="line-1736"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>bsymbolicFlag</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- we need symbolic linking to resolve</span>
<a name="line-1737"></a>                                <span class='hs-comment'>-- non-PIC intra-package-relocations</span>
<a name="line-1738"></a>                                <span class='hs-keyglyph'>[</span><span class='hs-str'>"-Wl,-Bsymbolic"</span><span class='hs-keyglyph'>]</span>
<a name="line-1739"></a>
<a name="line-1740"></a>            <span class='hs-varid'>runLink</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span>
<a name="line-1741"></a>                    <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>verbFlags</span>
<a name="line-1742"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>libmLinkOpts</span>
<a name="line-1743"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-o"</span>
<a name="line-1744"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>output_fn</span>
<a name="line-1745"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-1746"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>o_files</span>
<a name="line-1747"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-shared"</span> <span class='hs-keyglyph'>]</span>
<a name="line-1748"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>bsymbolicFlag</span>
<a name="line-1749"></a>                    <span class='hs-comment'>-- Set the library soname. We use -h rather than -soname as</span>
<a name="line-1750"></a>                    <span class='hs-comment'>-- Solaris 10 doesn't support the latter:</span>
<a name="line-1751"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-str'>"-Wl,-h,"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>takeFileName</span> <span class='hs-varid'>output_fn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1752"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>extra_ld_inputs</span>
<a name="line-1753"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>lib_path_opts</span>
<a name="line-1754"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>pkg_lib_path_opts</span>
<a name="line-1755"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>pkg_link_opts</span>
<a name="line-1756"></a>              <span class='hs-layout'>)</span>
<a name="line-1757"></a>
<a name="line-1758"></a><a name="libmLinkOpts"></a><span class='hs-comment'>-- | Some platforms require that we explicitly link against @libm@ if any</span>
<a name="line-1759"></a><span class='hs-comment'>-- math-y things are used (which we assume to include all programs). See #14022.</span>
<a name="line-1760"></a><span class='hs-definition'>libmLinkOpts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>
<a name="line-1761"></a><span class='hs-definition'>libmLinkOpts</span> <span class='hs-keyglyph'>=</span>
<a name="line-1762"></a><span class='hs-cpp'>#if defined(HAVE_LIBM)</span>
<a name="line-1763"></a>  <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-lm"</span><span class='hs-keyglyph'>]</span>
<a name="line-1764"></a><span class='hs-cpp'>#else</span>
<a name="line-1765"></a>  <span class='hs-conid'>[]</span>
<a name="line-1766"></a><span class='hs-cpp'>#endif</span>
<a name="line-1767"></a>
<a name="line-1768"></a><a name="getPkgFrameworkOpts"></a><span class='hs-definition'>getPkgFrameworkOpts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstalledUnitId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-1769"></a><span class='hs-definition'>getPkgFrameworkOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>dep_packages</span>
<a name="line-1770"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>platformUsesFrameworks</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1771"></a>    <span class='hs-varid'>pkg_framework_path_opts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>do</span>
<a name="line-1772"></a>        <span class='hs-varid'>pkg_framework_paths</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPackageFrameworkPath</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dep_packages</span>
<a name="line-1773"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-str'>"-F"</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>pkg_framework_paths</span>
<a name="line-1774"></a>
<a name="line-1775"></a>    <span class='hs-varid'>pkg_framework_opts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>do</span>
<a name="line-1776"></a>        <span class='hs-varid'>pkg_frameworks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPackageFrameworks</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dep_packages</span>
<a name="line-1777"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-framework"</span><span class='hs-layout'>,</span> <span class='hs-varid'>fw</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fw</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pkg_frameworks</span> <span class='hs-keyglyph'>]</span>
<a name="line-1778"></a>
<a name="line-1779"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg_framework_path_opts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pkg_framework_opts</span><span class='hs-layout'>)</span>
<a name="line-1780"></a>
<a name="line-1781"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-1782"></a>
<a name="line-1783"></a><a name="getFrameworkOpts"></a><span class='hs-definition'>getFrameworkOpts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-1784"></a><span class='hs-definition'>getFrameworkOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>platform</span>
<a name="line-1785"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>platformUsesFrameworks</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>framework_path_opts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>framework_opts</span>
<a name="line-1786"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1787"></a>  <span class='hs-keyword'>where</span>
<a name="line-1788"></a>    <span class='hs-varid'>framework_paths</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>frameworkPaths</span> <span class='hs-varid'>dflags</span>
<a name="line-1789"></a>    <span class='hs-varid'>framework_path_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-str'>"-F"</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>framework_paths</span>
<a name="line-1790"></a>
<a name="line-1791"></a>    <span class='hs-varid'>frameworks</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmdlineFrameworks</span> <span class='hs-varid'>dflags</span>
<a name="line-1792"></a>    <span class='hs-comment'>-- reverse because they're added in reverse order from the cmd line:</span>
<a name="line-1793"></a>    <span class='hs-varid'>framework_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-framework"</span><span class='hs-layout'>,</span> <span class='hs-varid'>fw</span><span class='hs-keyglyph'>]</span>
<a name="line-1794"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fw</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>frameworks</span> <span class='hs-keyglyph'>]</span>
</pre></body>
</html>
