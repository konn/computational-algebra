<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcRnTypes.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006-2012
<a name="line-3"></a>(c) The GRASP Project, Glasgow University, 1992-2002
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a>Various types used during typechecking, please see TcRnMonad as well for
<a name="line-7"></a>operations on these types. You probably want to import it, instead of this
<a name="line-8"></a>module.
<a name="line-9"></a>
<a name="line-10"></a>All the monads exported here are built on top of the same IOEnv monad. The
<a name="line-11"></a>monad functions like a Reader monad in the way it passes the environment
<a name="line-12"></a>around. This is done to allow the environment to be manipulated in a stack
<a name="line-13"></a>like fashion when entering expressions... ect.
<a name="line-14"></a>
<a name="line-15"></a>For state that is global and should be returned at the end (e.g not part
<a name="line-16"></a>of the stack mechanism), you should use an TcRef (= IORef) to store them.
<a name="line-17"></a>-}</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-comment'>{-# LANGUAGE CPP, ExistentialQuantification, GeneralizedNewtypeDeriving,
<a name="line-20"></a>             ViewPatterns #-}</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcRnTypes</span><span class='hs-layout'>(</span>
<a name="line-23"></a>        <span class='hs-conid'>TcRnIf</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcM</span><span class='hs-layout'>,</span> <span class='hs-conid'>RnM</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfM</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfL</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfG</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The monad is opaque outside this module</span>
<a name="line-24"></a>        <span class='hs-conid'>TcRef</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-comment'>-- The environment types</span>
<a name="line-27"></a>        <span class='hs-conid'>Env</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-conid'>IfGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>tcVisibleOrphanMods</span><span class='hs-layout'>,</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-comment'>-- Frontend types (shouldn't really be here)</span>
<a name="line-33"></a>        <span class='hs-conid'>FrontendResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-comment'>-- Renamer types</span>
<a name="line-36"></a>        <span class='hs-conid'>ErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>RecFieldEnv</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyImportAvails</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusImportAvails</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-conid'>WhereFrom</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkModDeps</span><span class='hs-layout'>,</span> <span class='hs-varid'>modDepsElts</span><span class='hs-layout'>,</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-comment'>-- Typechecker types</span>
<a name="line-41"></a>        <span class='hs-conid'>TcTypeEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdBinderStack</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdBinder</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-conid'>TcTyThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PromotionErr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-conid'>IdBindingInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClosedTypeId</span><span class='hs-layout'>,</span> <span class='hs-conid'>RhsNames</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-conid'>IsGroupClosed</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-conid'>SelfBootInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-varid'>pprTcTyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPECategory</span><span class='hs-layout'>,</span> <span class='hs-conid'>CompleteMatch</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-comment'>-- Desugaring types</span>
<a name="line-49"></a>        <span class='hs-conid'>DsM</span><span class='hs-layout'>,</span> <span class='hs-conid'>DsLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>DsGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PArrBuiltin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-conid'>DsMetaEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>DsMetaVal</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CompleteMatchMap</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>mkCompleteMatchMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCompleteMatchMap</span><span class='hs-layout'>,</span>
<a name="line-52"></a>
<a name="line-53"></a>        <span class='hs-comment'>-- Template Haskell</span>
<a name="line-54"></a>        <span class='hs-conid'>ThStage</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>SpliceType</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PendingStuff</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>topStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topAnnStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSpliceStage</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-conid'>ThLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>impLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>outerLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>thLevel</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-conid'>ForeignSrcLang</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-58"></a>
<a name="line-59"></a>        <span class='hs-comment'>-- Arrows</span>
<a name="line-60"></a>        <span class='hs-conid'>ArrowCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-61"></a>
<a name="line-62"></a>        <span class='hs-comment'>-- TcSigInfo</span>
<a name="line-63"></a>        <span class='hs-conid'>TcSigFun</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-64"></a>        <span class='hs-conid'>TcIdSigInst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPatSynInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-65"></a>        <span class='hs-varid'>isPartialSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasCompleteSig</span><span class='hs-layout'>,</span>
<a name="line-66"></a>
<a name="line-67"></a>        <span class='hs-comment'>-- Canonical constraints</span>
<a name="line-68"></a>        <span class='hs-conid'>Xi</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>andCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>andManyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCts</span><span class='hs-layout'>,</span>
<a name="line-69"></a>        <span class='hs-varid'>singleCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>listToCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctsElts</span><span class='hs-layout'>,</span> <span class='hs-varid'>consCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>snocCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCtsList</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-varid'>isEmptyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCTyEqCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCFunEqCan</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>isPendingScDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>superClassesMightHelp</span><span class='hs-layout'>,</span>
<a name="line-72"></a>        <span class='hs-varid'>isCDictCan_Maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCFunEqCan_maybe</span><span class='hs-layout'>,</span>
<a name="line-73"></a>        <span class='hs-varid'>isCIrredEvCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCNonCanonical</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWantedCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerivedCt</span><span class='hs-layout'>,</span>
<a name="line-74"></a>        <span class='hs-varid'>isGivenCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isHoleCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isOutOfScopeCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isExprHoleCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTypeHoleCt</span><span class='hs-layout'>,</span>
<a name="line-75"></a>        <span class='hs-varid'>isUserTypeErrorCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>getUserTypeErrorMsg</span><span class='hs-layout'>,</span>
<a name="line-76"></a>        <span class='hs-varid'>ctEvidence</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCtLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctFlavour</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEqRel</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctOrigin</span><span class='hs-layout'>,</span>
<a name="line-77"></a>        <span class='hs-varid'>mkTcEqPredLikeEv</span><span class='hs-layout'>,</span>
<a name="line-78"></a>        <span class='hs-varid'>mkNonCanonical</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNonCanonicalCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGivens</span><span class='hs-layout'>,</span>
<a name="line-79"></a>        <span class='hs-varid'>ctEvPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvOrigin</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvEqRel</span><span class='hs-layout'>,</span>
<a name="line-80"></a>        <span class='hs-varid'>ctEvTerm</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvCoercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvId</span><span class='hs-layout'>,</span>
<a name="line-81"></a>        <span class='hs-varid'>tyCoVarsOfCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCts</span><span class='hs-layout'>,</span>
<a name="line-82"></a>        <span class='hs-varid'>tyCoVarsOfCtList</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCtsList</span><span class='hs-layout'>,</span>
<a name="line-83"></a>
<a name="line-84"></a>        <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>insolubleWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyWC</span><span class='hs-layout'>,</span>
<a name="line-85"></a>        <span class='hs-varid'>andWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionsWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSimpleWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkImplicWC</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>addInsols</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInsolubles</span><span class='hs-layout'>,</span> <span class='hs-varid'>insolublesOnly</span><span class='hs-layout'>,</span> <span class='hs-varid'>addSimples</span><span class='hs-layout'>,</span> <span class='hs-varid'>addImplics</span><span class='hs-layout'>,</span>
<a name="line-87"></a>        <span class='hs-varid'>tyCoVarsOfWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>dropDerivedWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>dropDerivedSimples</span><span class='hs-layout'>,</span> <span class='hs-varid'>dropDerivedInsols</span><span class='hs-layout'>,</span>
<a name="line-88"></a>        <span class='hs-varid'>tyCoVarsOfWCList</span><span class='hs-layout'>,</span> <span class='hs-varid'>trulyInsoluble</span><span class='hs-layout'>,</span>
<a name="line-89"></a>        <span class='hs-varid'>isDroppableDerivedLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>insolubleImplic</span><span class='hs-layout'>,</span>
<a name="line-90"></a>        <span class='hs-varid'>arisesFromGivens</span><span class='hs-layout'>,</span>
<a name="line-91"></a>
<a name="line-92"></a>        <span class='hs-conid'>Implication</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImplicStatus</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isInsolubleStatus</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSolvedStatus</span><span class='hs-layout'>,</span>
<a name="line-93"></a>        <span class='hs-conid'>SubGoalDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>initialSubGoalDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxSubGoalDepth</span><span class='hs-layout'>,</span>
<a name="line-94"></a>        <span class='hs-varid'>bumpSubGoalDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>subGoalDepthExceeded</span><span class='hs-layout'>,</span>
<a name="line-95"></a>        <span class='hs-conid'>CtLoc</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocOrigin</span><span class='hs-layout'>,</span>
<a name="line-96"></a>        <span class='hs-varid'>ctLocTypeOrKind_maybe</span><span class='hs-layout'>,</span>
<a name="line-97"></a>        <span class='hs-varid'>ctLocDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>bumpCtLocDepth</span><span class='hs-layout'>,</span>
<a name="line-98"></a>        <span class='hs-varid'>setCtLocOrigin</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCtLocEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCtLocSpan</span><span class='hs-layout'>,</span>
<a name="line-99"></a>        <span class='hs-conid'>CtOrigin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprCtOrigin</span><span class='hs-layout'>,</span> <span class='hs-varid'>lexprCtOrigin</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchesCtOrigin</span><span class='hs-layout'>,</span> <span class='hs-varid'>grhssCtOrigin</span><span class='hs-layout'>,</span>
<a name="line-100"></a>        <span class='hs-conid'>ErrorThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkErrorThing</span><span class='hs-layout'>,</span> <span class='hs-varid'>errorThingNumArgs_maybe</span><span class='hs-layout'>,</span>
<a name="line-101"></a>        <span class='hs-conid'>TypeOrKind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTypeLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>isKindLevel</span><span class='hs-layout'>,</span>
<a name="line-102"></a>        <span class='hs-varid'>pprCtOrigin</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCtLoc</span><span class='hs-layout'>,</span>
<a name="line-103"></a>        <span class='hs-varid'>pushErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>pushErrCtxtSameOrigin</span><span class='hs-layout'>,</span>
<a name="line-104"></a>
<a name="line-105"></a>        <span class='hs-conid'>SkolemInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprSigSkolInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprSkolInfo</span><span class='hs-layout'>,</span>
<a name="line-106"></a>        <span class='hs-varid'>termEvidenceAllowed</span><span class='hs-layout'>,</span>
<a name="line-107"></a>
<a name="line-108"></a>        <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvDest</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-109"></a>        <span class='hs-varid'>mkGivenLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkKindLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>toKindLoc</span><span class='hs-layout'>,</span>
<a name="line-110"></a>        <span class='hs-varid'>isWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGiven</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerived</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGivenOrWDeriv</span><span class='hs-layout'>,</span>
<a name="line-111"></a>        <span class='hs-varid'>ctEvRole</span><span class='hs-layout'>,</span>
<a name="line-112"></a>
<a name="line-113"></a>        <span class='hs-comment'>-- Constraint solver plugins</span>
<a name="line-114"></a>        <span class='hs-conid'>TcPlugin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPluginResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPluginSolver</span><span class='hs-layout'>,</span>
<a name="line-115"></a>        <span class='hs-conid'>TcPluginM</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcPluginM</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeTcPluginTcM</span><span class='hs-layout'>,</span>
<a name="line-116"></a>        <span class='hs-varid'>getEvBindsTcPluginM</span><span class='hs-layout'>,</span>
<a name="line-117"></a>
<a name="line-118"></a>        <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ShadowInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvFlavour</span><span class='hs-layout'>,</span>
<a name="line-119"></a>        <span class='hs-conid'>CtFlavourRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvFlavourRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctFlavourRole</span><span class='hs-layout'>,</span>
<a name="line-120"></a>        <span class='hs-varid'>eqCanRewriteFR</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqMayRewriteFR</span><span class='hs-layout'>,</span>
<a name="line-121"></a>        <span class='hs-varid'>eqCanDischarge</span><span class='hs-layout'>,</span>
<a name="line-122"></a>        <span class='hs-varid'>funEqCanDischarge</span><span class='hs-layout'>,</span> <span class='hs-varid'>funEqCanDischargeF</span><span class='hs-layout'>,</span>
<a name="line-123"></a>
<a name="line-124"></a>        <span class='hs-comment'>-- Pretty printing</span>
<a name="line-125"></a>        <span class='hs-varid'>pprEvVarTheta</span><span class='hs-layout'>,</span>
<a name="line-126"></a>        <span class='hs-varid'>pprEvVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprEvVarWithType</span><span class='hs-layout'>,</span>
<a name="line-127"></a>
<a name="line-128"></a>        <span class='hs-comment'>-- Misc other types</span>
<a name="line-129"></a>        <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdSet</span><span class='hs-layout'>,</span>
<a name="line-130"></a>        <span class='hs-conid'>Hole</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>holeOcc</span><span class='hs-layout'>,</span>
<a name="line-131"></a>        <span class='hs-conid'>NameShape</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-132"></a>
<a name="line-133"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-136"></a>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>Class</span> <span class='hs-layout'>)</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-layout'>)</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHoleCo</span> <span class='hs-layout'>)</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>ConLike</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConUserType</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConOrigArgTys</span> <span class='hs-layout'>)</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span>   <span class='hs-layout'>(</span> <span class='hs-conid'>PatSyn</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPatSynType</span> <span class='hs-layout'>)</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>idType</span><span class='hs-layout'>,</span> <span class='hs-varid'>idName</span> <span class='hs-layout'>)</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FieldLabel</span> <span class='hs-layout'>(</span> <span class='hs-conid'>FieldLabel</span> <span class='hs-layout'>)</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-151"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PmExpr</span>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IOEnv</span>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-160"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FV</span>
<a name="line-163"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-164"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-165"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-167"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-168"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-169"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-170"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-171"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-172"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-173"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-174"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-175"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-176"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-177"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Fingerprint</span>
<a name="line-178"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-179"></a>
<a name="line-180"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>ap</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftM</span><span class='hs-layout'>,</span> <span class='hs-varid'>msum</span><span class='hs-layout'>)</span>
<a name="line-181"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-182"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Fail</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>MonadFail</span>
<a name="line-183"></a><span class='hs-cpp'>#endif</span>
<a name="line-184"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>Set</span> <span class='hs-layout'>)</span>
<a name="line-185"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-186"></a>
<a name="line-187"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>sort</span> <span class='hs-layout'>)</span>
<a name="line-188"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Map</span> <span class='hs-layout'>)</span>
<a name="line-189"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Dynamic</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>Dynamic</span> <span class='hs-layout'>)</span>
<a name="line-190"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TypeRep</span> <span class='hs-layout'>)</span>
<a name="line-191"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi</span><span class='hs-varop'>.</span><span class='hs-conid'>Message</span>
<a name="line-192"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi</span><span class='hs-varop'>.</span><span class='hs-conid'>RemoteTypes</span>
<a name="line-193"></a>
<a name="line-194"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-195"></a>
<a name="line-196"></a><a name="NameShape"></a><span class='hs-comment'>-- | A 'NameShape' is a substitution on 'Name's that can be used</span>
<a name="line-197"></a><a name="NameShape"></a><span class='hs-comment'>-- to refine the identities of a hole while we are renaming interfaces</span>
<a name="line-198"></a><a name="NameShape"></a><span class='hs-comment'>-- (see 'RnModIface').  Specifically, a 'NameShape' for</span>
<a name="line-199"></a><a name="NameShape"></a><span class='hs-comment'>-- 'ns_module_name' @A@, defines a mapping from @{A.T}@</span>
<a name="line-200"></a><a name="NameShape"></a><span class='hs-comment'>-- (for some 'OccName' @T@) to some arbitrary other 'Name'.</span>
<a name="line-201"></a><a name="NameShape"></a><span class='hs-comment'>--</span>
<a name="line-202"></a><a name="NameShape"></a><span class='hs-comment'>-- The most intruiging thing about a 'NameShape', however, is</span>
<a name="line-203"></a><a name="NameShape"></a><span class='hs-comment'>-- how it's constructed.  A 'NameShape' is *implied* by the</span>
<a name="line-204"></a><a name="NameShape"></a><span class='hs-comment'>-- exported 'AvailInfo's of the implementor of an interface:</span>
<a name="line-205"></a><a name="NameShape"></a><span class='hs-comment'>-- if an implementor of signature @&lt;H&gt;@ exports @M.T@, you implicitly</span>
<a name="line-206"></a><a name="NameShape"></a><span class='hs-comment'>-- define a substitution from @{H.T}@ to @M.T@.  So a 'NameShape'</span>
<a name="line-207"></a><a name="NameShape"></a><span class='hs-comment'>-- is computed from the list of 'AvailInfo's that are exported</span>
<a name="line-208"></a><a name="NameShape"></a><span class='hs-comment'>-- by the implementation of a module, or successively merged</span>
<a name="line-209"></a><a name="NameShape"></a><span class='hs-comment'>-- together by the export lists of signatures which are joining</span>
<a name="line-210"></a><a name="NameShape"></a><span class='hs-comment'>-- together.</span>
<a name="line-211"></a><a name="NameShape"></a><span class='hs-comment'>--</span>
<a name="line-212"></a><a name="NameShape"></a><span class='hs-comment'>-- It's not the most obvious way to go about doing this, but it</span>
<a name="line-213"></a><a name="NameShape"></a><span class='hs-comment'>-- does seem to work!</span>
<a name="line-214"></a><a name="NameShape"></a><span class='hs-comment'>--</span>
<a name="line-215"></a><a name="NameShape"></a><span class='hs-comment'>-- NB: Can't boot this and put it in NameShape because then we</span>
<a name="line-216"></a><a name="NameShape"></a><span class='hs-comment'>-- start pulling in too many DynFlags things.</span>
<a name="line-217"></a><a name="NameShape"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>NameShape</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameShape</span> <span class='hs-layout'>{</span>
<a name="line-218"></a>        <span class='hs-varid'>ns_mod_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span>
<a name="line-219"></a>        <span class='hs-varid'>ns_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-220"></a>        <span class='hs-varid'>ns_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccEnv</span> <span class='hs-conid'>Name</span>
<a name="line-221"></a>    <span class='hs-layout'>}</span>
<a name="line-222"></a>
<a name="line-223"></a>
<a name="line-224"></a><span class='hs-comment'>{-
<a name="line-225"></a>************************************************************************
<a name="line-226"></a>*                                                                      *
<a name="line-227"></a>               Standard monad definition for TcRn
<a name="line-228"></a>    All the combinators for the monad can be found in TcRnMonad
<a name="line-229"></a>*                                                                      *
<a name="line-230"></a>************************************************************************
<a name="line-231"></a>
<a name="line-232"></a>The monad itself has to be defined here, because it is mentioned by ErrCtxt
<a name="line-233"></a>-}</span>
<a name="line-234"></a>
<a name="line-235"></a><a name="TcRnIf"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IOEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-236"></a><a name="TcRn"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRn</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-conid'>TcLclEnv</span>    <span class='hs-comment'>-- Type inference</span>
<a name="line-237"></a><a name="IfM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>IfGblEnv</span> <span class='hs-varid'>lcl</span>         <span class='hs-comment'>-- Iface stuff</span>
<a name="line-238"></a><a name="IfG"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfG</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfM</span> <span class='hs-conid'>()</span>                      <span class='hs-comment'>--    Top level</span>
<a name="line-239"></a><a name="IfL"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfL</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfM</span> <span class='hs-conid'>IfLclEnv</span>                <span class='hs-comment'>--    Nested</span>
<a name="line-240"></a><a name="DsM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DsM</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>DsGblEnv</span> <span class='hs-conid'>DsLclEnv</span>    <span class='hs-comment'>-- Desugaring</span>
<a name="line-241"></a>
<a name="line-242"></a><span class='hs-comment'>-- TcRn is the type-checking and renaming monad: the main monad that</span>
<a name="line-243"></a><span class='hs-comment'>-- most type-checking takes place in.  The global environment is</span>
<a name="line-244"></a><span class='hs-comment'>-- 'TcGblEnv', which tracks all of the top-level type-checking</span>
<a name="line-245"></a><span class='hs-comment'>-- information we've accumulated while checking a module, while the</span>
<a name="line-246"></a><span class='hs-comment'>-- local environment is 'TcLclEnv', which tracks local information as</span>
<a name="line-247"></a><span class='hs-comment'>-- we move inside expressions.</span>
<a name="line-248"></a>
<a name="line-249"></a><a name="RnM"></a><span class='hs-comment'>-- | Historical "renaming monad" (now it's just 'TcRn').</span>
<a name="line-250"></a><a name="RnM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RnM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRn</span>
<a name="line-251"></a>
<a name="line-252"></a><a name="TcM"></a><span class='hs-comment'>-- | Historical "type-checking monad" (now it's just 'TcRn').</span>
<a name="line-253"></a><a name="TcM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRn</span>
<a name="line-254"></a>
<a name="line-255"></a><a name="Env"></a><span class='hs-comment'>-- We 'stack' these envs through the Reader like monad infrastructure</span>
<a name="line-256"></a><a name="Env"></a><span class='hs-comment'>-- as we move into an expression (although the change is focused in</span>
<a name="line-257"></a><a name="Env"></a><span class='hs-comment'>-- the lcl type).</span>
<a name="line-258"></a><a name="Env"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span>
<a name="line-259"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Env</span> <span class='hs-layout'>{</span>
<a name="line-260"></a>        <span class='hs-varid'>env_top</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Top-level stuff that never changes</span>
<a name="line-261"></a>                             <span class='hs-comment'>-- Includes all info about imported things</span>
<a name="line-262"></a>
<a name="line-263"></a>        <span class='hs-varid'>env_us</span>   <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>UniqSupply</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-264"></a>                             <span class='hs-comment'>-- Unique supply for local variables</span>
<a name="line-265"></a>
<a name="line-266"></a>        <span class='hs-varid'>env_gbl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>gbl</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Info about things defined at the top level</span>
<a name="line-267"></a>                             <span class='hs-comment'>-- of the module being compiled</span>
<a name="line-268"></a>
<a name="line-269"></a>        <span class='hs-varid'>env_lcl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>lcl</span>      <span class='hs-comment'>-- Nested stuff; changes as we go into</span>
<a name="line-270"></a>    <span class='hs-layout'>}</span>
<a name="line-271"></a>
<a name="line-272"></a><a name="instance%20ContainsDynFlags%20(Env%20gbl%20lcl)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsDynFlags</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-273"></a>    <span class='hs-varid'>extractDynFlags</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_top</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-274"></a>
<a name="line-275"></a><a name="instance%20ContainsModule%20(Env%20gbl%20lcl)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-varid'>gbl</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-276"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_gbl</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-277"></a>
<a name="line-278"></a>
<a name="line-279"></a><span class='hs-comment'>{-
<a name="line-280"></a>************************************************************************
<a name="line-281"></a>*                                                                      *
<a name="line-282"></a>                The interface environments
<a name="line-283"></a>              Used when dealing with IfaceDecls
<a name="line-284"></a>*                                                                      *
<a name="line-285"></a>************************************************************************
<a name="line-286"></a>-}</span>
<a name="line-287"></a>
<a name="line-288"></a><a name="IfGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfGblEnv</span>
<a name="line-289"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfGblEnv</span> <span class='hs-layout'>{</span>
<a name="line-290"></a>        <span class='hs-comment'>-- Some information about where this environment came from;</span>
<a name="line-291"></a>        <span class='hs-comment'>-- useful for debugging.</span>
<a name="line-292"></a>        <span class='hs-varid'>if_doc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>,</span>
<a name="line-293"></a>        <span class='hs-comment'>-- The type environment for the module being compiled,</span>
<a name="line-294"></a>        <span class='hs-comment'>-- in case the interface refers back to it via a reference that</span>
<a name="line-295"></a>        <span class='hs-comment'>-- was originally a hi-boot file.</span>
<a name="line-296"></a>        <span class='hs-comment'>-- We need the module name so we can test when it's appropriate</span>
<a name="line-297"></a>        <span class='hs-comment'>-- to look in this env.</span>
<a name="line-298"></a>        <span class='hs-comment'>-- See Note [Tying the knot] in TcIface</span>
<a name="line-299"></a>        <span class='hs-varid'>if_rec_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>)</span>
<a name="line-300"></a>                <span class='hs-comment'>-- Allows a read effect, so it can be in a mutable</span>
<a name="line-301"></a>                <span class='hs-comment'>-- variable; c.f. handling the external package type env</span>
<a name="line-302"></a>                <span class='hs-comment'>-- Nothing =&gt; interactive stuff, no loops possible</span>
<a name="line-303"></a>    <span class='hs-layout'>}</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="IfLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfLclEnv</span>
<a name="line-306"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-307"></a>        <span class='hs-comment'>-- The module for the current IfaceDecl</span>
<a name="line-308"></a>        <span class='hs-comment'>-- So if we see   f = \x -&gt; x</span>
<a name="line-309"></a>        <span class='hs-comment'>-- it means M.f = \x -&gt; x, where M is the if_mod</span>
<a name="line-310"></a>        <span class='hs-comment'>-- NB: This is a semantic module, see</span>
<a name="line-311"></a>        <span class='hs-comment'>-- Note [Identity versus semantic module]</span>
<a name="line-312"></a>        <span class='hs-varid'>if_mod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>
<a name="line-313"></a>
<a name="line-314"></a>        <span class='hs-comment'>-- Whether or not the IfaceDecl came from a boot</span>
<a name="line-315"></a>        <span class='hs-comment'>-- file or not; we'll use this to choose between</span>
<a name="line-316"></a>        <span class='hs-comment'>-- NoUnfolding and BootUnfolding</span>
<a name="line-317"></a>        <span class='hs-varid'>if_boot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-318"></a>
<a name="line-319"></a>        <span class='hs-comment'>-- The field is used only for error reporting</span>
<a name="line-320"></a>        <span class='hs-comment'>-- if (say) there's a Lint error in it</span>
<a name="line-321"></a>        <span class='hs-varid'>if_loc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>,</span>
<a name="line-322"></a>                <span class='hs-comment'>-- Where the interface came from:</span>
<a name="line-323"></a>                <span class='hs-comment'>--      .hi file, or GHCi state, or ext core</span>
<a name="line-324"></a>                <span class='hs-comment'>-- plus which bit is currently being examined</span>
<a name="line-325"></a>
<a name="line-326"></a>        <span class='hs-varid'>if_nsubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>NameShape</span><span class='hs-layout'>,</span>
<a name="line-327"></a>
<a name="line-328"></a>        <span class='hs-comment'>-- This field is used to make sure "implicit" declarations</span>
<a name="line-329"></a>        <span class='hs-comment'>-- (anything that cannot be exported in mi_exports) get</span>
<a name="line-330"></a>        <span class='hs-comment'>-- wired up correctly in typecheckIfacesForMerging.  Most</span>
<a name="line-331"></a>        <span class='hs-comment'>-- of the time it's @Nothing@.  See Note [Resolving never-exported Names in TcIface]</span>
<a name="line-332"></a>        <span class='hs-comment'>-- in TcIface.</span>
<a name="line-333"></a>        <span class='hs-varid'>if_implicits_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-334"></a>
<a name="line-335"></a>        <span class='hs-varid'>if_tv_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastStringEnv</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Nested tyvar bindings</span>
<a name="line-336"></a>        <span class='hs-varid'>if_id_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastStringEnv</span> <span class='hs-conid'>Id</span>         <span class='hs-comment'>-- Nested id binding</span>
<a name="line-337"></a>    <span class='hs-layout'>}</span>
<a name="line-338"></a>
<a name="line-339"></a><span class='hs-comment'>{-
<a name="line-340"></a>************************************************************************
<a name="line-341"></a>*                                                                      *
<a name="line-342"></a>                Desugarer monad
<a name="line-343"></a>*                                                                      *
<a name="line-344"></a>************************************************************************
<a name="line-345"></a>
<a name="line-346"></a>Now the mondo monad magic (yes, @DsM@ is a silly name)---carry around
<a name="line-347"></a>a @UniqueSupply@ and some annotations, which
<a name="line-348"></a>presumably include source-file location information:
<a name="line-349"></a>-}</span>
<a name="line-350"></a>
<a name="line-351"></a><a name="PArrBuiltin"></a><span class='hs-comment'>-- If '-XParallelArrays' is given, the desugarer populates this table with the corresponding</span>
<a name="line-352"></a><a name="PArrBuiltin"></a><span class='hs-comment'>-- variables found in 'Data.Array.Parallel'.</span>
<a name="line-353"></a><a name="PArrBuiltin"></a><span class='hs-comment'>--</span>
<a name="line-354"></a><a name="PArrBuiltin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PArrBuiltin</span>
<a name="line-355"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PArrBuiltin</span>
<a name="line-356"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>lengthPVar</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ lengthP</span>
<a name="line-357"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>replicatePVar</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ replicateP</span>
<a name="line-358"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>singletonPVar</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ singletonP</span>
<a name="line-359"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>mapPVar</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ mapP</span>
<a name="line-360"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>filterPVar</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ filterP</span>
<a name="line-361"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>zipPVar</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ zipP</span>
<a name="line-362"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>crossMapPVar</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ crossMapP</span>
<a name="line-363"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>indexPVar</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ (!:)</span>
<a name="line-364"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>emptyPVar</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ emptyP</span>
<a name="line-365"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>appPVar</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ (+:+)</span>
<a name="line-366"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>enumFromToPVar</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ enumFromToP</span>
<a name="line-367"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>enumFromThenToPVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ enumFromThenToP</span>
<a name="line-368"></a>        <span class='hs-layout'>}</span>
<a name="line-369"></a>
<a name="line-370"></a><a name="DsGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DsGblEnv</span>
<a name="line-371"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DsGblEnv</span>
<a name="line-372"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>ds_mod</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span>             <span class='hs-comment'>-- For SCC profiling</span>
<a name="line-373"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_fam_inst_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span>         <span class='hs-comment'>-- Like tcg_fam_inst_env</span>
<a name="line-374"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_unqual</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrintUnqualified</span>
<a name="line-375"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_msgs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Messages</span>          <span class='hs-comment'>-- Warning messages</span>
<a name="line-376"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_if_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfLclEnv</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Used for looking up global,</span>
<a name="line-377"></a>                                                <span class='hs-comment'>-- possibly-imported things</span>
<a name="line-378"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_dph_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span>            <span class='hs-comment'>-- exported entities of 'Data.Array.Parallel.Prim'</span>
<a name="line-379"></a>                                                <span class='hs-comment'>-- iff '-fvectorise' flag was given as well as</span>
<a name="line-380"></a>                                                <span class='hs-comment'>-- exported entities of 'Data.Array.Parallel' iff</span>
<a name="line-381"></a>                                                <span class='hs-comment'>-- '-XParallelArrays' was given; otherwise, empty</span>
<a name="line-382"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_parr_bi</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PArrBuiltin</span>             <span class='hs-comment'>-- desugarar names for '-XParallelArrays'</span>
<a name="line-383"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_complete_matches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CompleteMatchMap</span>
<a name="line-384"></a>           <span class='hs-comment'>-- Additional complete pattern matches</span>
<a name="line-385"></a>        <span class='hs-layout'>}</span>
<a name="line-386"></a>
<a name="line-387"></a><a name="instance%20ContainsModule%20DsGblEnv"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-conid'>DsGblEnv</span> <span class='hs-keyword'>where</span>
<a name="line-388"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_mod</span>
<a name="line-389"></a>
<a name="line-390"></a><a name="DsLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DsLclEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DsLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-391"></a>        <span class='hs-varid'>dsl_meta</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMetaEnv</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Template Haskell bindings</span>
<a name="line-392"></a>        <span class='hs-varid'>dsl_loc</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RealSrcSpan</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- To put in pattern-matching error msgs</span>
<a name="line-393"></a>        <span class='hs-varid'>dsl_dicts</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Constraints from GADT pattern-matching</span>
<a name="line-394"></a>        <span class='hs-varid'>dsl_tm_cs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>SimpleEq</span><span class='hs-layout'>,</span>
<a name="line-395"></a>        <span class='hs-varid'>dsl_pm_iter</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span>         <span class='hs-comment'>-- no iterations for pmcheck</span>
<a name="line-396"></a>     <span class='hs-layout'>}</span>
<a name="line-397"></a>
<a name="line-398"></a><a name="DsMetaEnv"></a><span class='hs-comment'>-- Inside [| |] brackets, the desugarer looks</span>
<a name="line-399"></a><a name="DsMetaEnv"></a><span class='hs-comment'>-- up variables in the DsMetaEnv</span>
<a name="line-400"></a><a name="DsMetaEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DsMetaEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>DsMetaVal</span>
<a name="line-401"></a>
<a name="line-402"></a><a name="DsMetaVal"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DsMetaVal</span>
<a name="line-403"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DsBound</span> <span class='hs-conid'>Id</span>         <span class='hs-comment'>-- Bound by a pattern inside the [| |].</span>
<a name="line-404"></a>                        <span class='hs-comment'>-- Will be dynamically alpha renamed.</span>
<a name="line-405"></a>                        <span class='hs-comment'>-- The Id has type THSyntax.Var</span>
<a name="line-406"></a>
<a name="line-407"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DsSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- These bindings are introduced by</span>
<a name="line-408"></a>                          <span class='hs-comment'>-- the PendingSplices on a HsBracketOut</span>
<a name="line-409"></a>
<a name="line-410"></a>
<a name="line-411"></a><span class='hs-comment'>{-
<a name="line-412"></a>************************************************************************
<a name="line-413"></a>*                                                                      *
<a name="line-414"></a>                Global typechecker environment
<a name="line-415"></a>*                                                                      *
<a name="line-416"></a>************************************************************************
<a name="line-417"></a>-}</span>
<a name="line-418"></a>
<a name="line-419"></a><a name="FrontendResult"></a><span class='hs-comment'>-- | 'FrontendResult' describes the result of running the</span>
<a name="line-420"></a><a name="FrontendResult"></a><span class='hs-comment'>-- frontend of a Haskell module.  Usually, you'll get</span>
<a name="line-421"></a><a name="FrontendResult"></a><span class='hs-comment'>-- a 'FrontendTypecheck', since running the frontend involves</span>
<a name="line-422"></a><a name="FrontendResult"></a><span class='hs-comment'>-- typechecking a program, but for an hs-boot merge you'll</span>
<a name="line-423"></a><a name="FrontendResult"></a><span class='hs-comment'>-- just get a ModIface, since no actual typechecking occurred.</span>
<a name="line-424"></a><a name="FrontendResult"></a><span class='hs-comment'>--</span>
<a name="line-425"></a><a name="FrontendResult"></a><span class='hs-comment'>-- This data type really should be in HscTypes, but it needs</span>
<a name="line-426"></a><a name="FrontendResult"></a><span class='hs-comment'>-- to have a TcGblEnv which is only defined here.</span>
<a name="line-427"></a><a name="FrontendResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FrontendResult</span>
<a name="line-428"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FrontendTypecheck</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-429"></a>
<a name="line-430"></a><span class='hs-comment'>-- Note [Identity versus semantic module]</span>
<a name="line-431"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-432"></a><span class='hs-comment'>-- When typechecking an hsig file, it is convenient to keep track</span>
<a name="line-433"></a><span class='hs-comment'>-- of two different "this module" identifiers:</span>
<a name="line-434"></a><span class='hs-comment'>--</span>
<a name="line-435"></a><span class='hs-comment'>--      - The IDENTITY module is simply thisPackage + the module</span>
<a name="line-436"></a><span class='hs-comment'>--        name; i.e. it uniquely *identifies* the interface file</span>
<a name="line-437"></a><span class='hs-comment'>--        we're compiling.  For example, p[A=&lt;A&gt;]:A is an</span>
<a name="line-438"></a><span class='hs-comment'>--        identity module identifying the requirement named A</span>
<a name="line-439"></a><span class='hs-comment'>--        from library p.</span>
<a name="line-440"></a><span class='hs-comment'>--</span>
<a name="line-441"></a><span class='hs-comment'>--      - The SEMANTIC module, which is the actual module that</span>
<a name="line-442"></a><span class='hs-comment'>--        this signature is intended to represent (e.g. if</span>
<a name="line-443"></a><span class='hs-comment'>--        we have a identity module p[A=base:Data.IORef]:A,</span>
<a name="line-444"></a><span class='hs-comment'>--        then the semantic module is base:Data.IORef)</span>
<a name="line-445"></a><span class='hs-comment'>--</span>
<a name="line-446"></a><span class='hs-comment'>-- Which one should you use?</span>
<a name="line-447"></a><span class='hs-comment'>--</span>
<a name="line-448"></a><span class='hs-comment'>--      - In the desugarer and later phases of compilation,</span>
<a name="line-449"></a><span class='hs-comment'>--        identity and semantic modules coincide, since we never compile</span>
<a name="line-450"></a><span class='hs-comment'>--        signatures (we just generate blank object files for</span>
<a name="line-451"></a><span class='hs-comment'>--        hsig files.)</span>
<a name="line-452"></a><span class='hs-comment'>--</span>
<a name="line-453"></a><span class='hs-comment'>--        A corrolary of this is that the following invariant holds at any point</span>
<a name="line-454"></a><span class='hs-comment'>--        past desugaring,</span>
<a name="line-455"></a><span class='hs-comment'>--</span>
<a name="line-456"></a><span class='hs-comment'>--            if I have a Module, this_mod, in hand representing the module</span>
<a name="line-457"></a><span class='hs-comment'>--            currently being compiled,</span>
<a name="line-458"></a><span class='hs-comment'>--            then moduleUnitId this_mod == thisPackage dflags</span>
<a name="line-459"></a><span class='hs-comment'>--</span>
<a name="line-460"></a><span class='hs-comment'>--      - For any code involving Names, we want semantic modules.</span>
<a name="line-461"></a><span class='hs-comment'>--        See lookupIfaceTop in IfaceEnv, mkIface and addFingerprints</span>
<a name="line-462"></a><span class='hs-comment'>--        in MkIface, and tcLookupGlobal in TcEnv</span>
<a name="line-463"></a><span class='hs-comment'>--</span>
<a name="line-464"></a><span class='hs-comment'>--      - When reading interfaces, we want the identity module to</span>
<a name="line-465"></a><span class='hs-comment'>--        identify the specific interface we want (such interfaces</span>
<a name="line-466"></a><span class='hs-comment'>--        should never be loaded into the EPS).  However, if a</span>
<a name="line-467"></a><span class='hs-comment'>--        hole module &lt;A&gt; is requested, we look for A.hi</span>
<a name="line-468"></a><span class='hs-comment'>--        in the home library we are compiling.  (See LoadIface.)</span>
<a name="line-469"></a><span class='hs-comment'>--        Similarly, in RnNames we check for self-imports using</span>
<a name="line-470"></a><span class='hs-comment'>--        identity modules, to allow signatures to import their implementor.</span>
<a name="line-471"></a><span class='hs-comment'>--</span>
<a name="line-472"></a><span class='hs-comment'>--      - For recompilation avoidance, you want the identity module,</span>
<a name="line-473"></a><span class='hs-comment'>--        since that will actually say the specific interface you</span>
<a name="line-474"></a><span class='hs-comment'>--        want to track (and recompile if it changes)</span>
<a name="line-475"></a>
<a name="line-476"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- | 'TcGblEnv' describes the top-level of the module at the</span>
<a name="line-477"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- point at which the typechecker is finished work.</span>
<a name="line-478"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- It is this structure that is handed on to the desugarer</span>
<a name="line-479"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- For state that needs to be updated during the typechecking</span>
<a name="line-480"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- phase and returned at end, use a 'TcRef' (= 'IORef').</span>
<a name="line-481"></a><a name="TcGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-482"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-layout'>{</span>
<a name="line-483"></a>        <span class='hs-varid'>tcg_mod</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ^ Module being compiled</span>
<a name="line-484"></a>        <span class='hs-varid'>tcg_semantic_mod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- ^ If a signature, the backing module</span>
<a name="line-485"></a>            <span class='hs-comment'>-- See also Note [Identity versus semantic module]</span>
<a name="line-486"></a>        <span class='hs-varid'>tcg_src</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscSource</span><span class='hs-layout'>,</span>
<a name="line-487"></a>          <span class='hs-comment'>-- ^ What kind of module (regular Haskell, hs-boot, hsig)</span>
<a name="line-488"></a>
<a name="line-489"></a>        <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ Top level envt; used during renaming</span>
<a name="line-490"></a>        <span class='hs-varid'>tcg_default</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-491"></a>          <span class='hs-comment'>-- ^ Types used for defaulting. @Nothing@ =&gt; no @default@ decl</span>
<a name="line-492"></a>
<a name="line-493"></a>        <span class='hs-varid'>tcg_fix_env</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FixityEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ Just for things in this module</span>
<a name="line-494"></a>        <span class='hs-varid'>tcg_field_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFieldEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ Just for things in this module</span>
<a name="line-495"></a>                                        <span class='hs-comment'>-- See Note [The interactive package] in HscTypes</span>
<a name="line-496"></a>
<a name="line-497"></a>        <span class='hs-varid'>tcg_type_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-498"></a>          <span class='hs-comment'>-- ^ Global type env for the module we are compiling now.  All</span>
<a name="line-499"></a>          <span class='hs-comment'>-- TyCons and Classes (for this module) end up in here right away,</span>
<a name="line-500"></a>          <span class='hs-comment'>-- along with their derived constructors, selectors.</span>
<a name="line-501"></a>          <span class='hs-comment'>--</span>
<a name="line-502"></a>          <span class='hs-comment'>-- (Ids defined in this module start in the local envt, though they</span>
<a name="line-503"></a>          <span class='hs-comment'>--  move to the global envt during zonking)</span>
<a name="line-504"></a>          <span class='hs-comment'>--</span>
<a name="line-505"></a>          <span class='hs-comment'>-- NB: for what "things in this module" means, see</span>
<a name="line-506"></a>          <span class='hs-comment'>-- Note [The interactive package] in HscTypes</span>
<a name="line-507"></a>
<a name="line-508"></a>        <span class='hs-varid'>tcg_type_env_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-509"></a>                <span class='hs-comment'>-- Used only to initialise the interface-file</span>
<a name="line-510"></a>                <span class='hs-comment'>-- typechecker in initIfaceTcRn, so that it can see stuff</span>
<a name="line-511"></a>                <span class='hs-comment'>-- bound in this module when dealing with hi-boot recursions</span>
<a name="line-512"></a>                <span class='hs-comment'>-- Updated at intervals (e.g. after dealing with types and classes)</span>
<a name="line-513"></a>
<a name="line-514"></a>        <span class='hs-varid'>tcg_inst_env</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InstEnv</span><span class='hs-layout'>,</span>
<a name="line-515"></a>          <span class='hs-comment'>-- ^ Instance envt for all /home-package/ modules;</span>
<a name="line-516"></a>          <span class='hs-comment'>-- Includes the dfuns in tcg_insts</span>
<a name="line-517"></a>        <span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Ditto for family instances</span>
<a name="line-518"></a>        <span class='hs-varid'>tcg_ann_env</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnnEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ And for annotations</span>
<a name="line-519"></a>
<a name="line-520"></a>        <span class='hs-comment'>-- | Family instances we have to check for consistency.</span>
<a name="line-521"></a>        <span class='hs-comment'>-- Invariant: each FamInst in the list's fi_fam matches the</span>
<a name="line-522"></a>        <span class='hs-comment'>-- key of the entry in the 'NameEnv'.  This gets consumed</span>
<a name="line-523"></a>        <span class='hs-comment'>-- by 'checkRecFamInstConsistency'.</span>
<a name="line-524"></a>        <span class='hs-comment'>-- See Note [Don't check hs-boot type family instances too early]</span>
<a name="line-525"></a>        <span class='hs-varid'>tcg_pending_fam_checks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-526"></a>
<a name="line-527"></a>                <span class='hs-comment'>-- Now a bunch of things about this module that are simply</span>
<a name="line-528"></a>                <span class='hs-comment'>-- accumulated, but never consulted until the end.</span>
<a name="line-529"></a>                <span class='hs-comment'>-- Nevertheless, it's convenient to accumulate them along</span>
<a name="line-530"></a>                <span class='hs-comment'>-- with the rest of the info from this module.</span>
<a name="line-531"></a>        <span class='hs-varid'>tcg_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ What is exported</span>
<a name="line-532"></a>        <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>,</span>
<a name="line-533"></a>          <span class='hs-comment'>-- ^ Information about what was imported from where, including</span>
<a name="line-534"></a>          <span class='hs-comment'>-- things bound in this module. Also store Safe Haskell info</span>
<a name="line-535"></a>          <span class='hs-comment'>-- here about transative trusted packaage requirements.</span>
<a name="line-536"></a>
<a name="line-537"></a>        <span class='hs-varid'>tcg_dus</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ What is defined in this module and what is used.</span>
<a name="line-538"></a>        <span class='hs-varid'>tcg_used_gres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- ^ Records occurrences of imported entities</span>
<a name="line-539"></a>          <span class='hs-comment'>-- See Note [Tracking unused binding and imports]</span>
<a name="line-540"></a>
<a name="line-541"></a>        <span class='hs-varid'>tcg_keep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>
<a name="line-542"></a>          <span class='hs-comment'>-- ^ Locally-defined top-level names to keep alive.</span>
<a name="line-543"></a>          <span class='hs-comment'>--</span>
<a name="line-544"></a>          <span class='hs-comment'>-- "Keep alive" means give them an Exported flag, so that the</span>
<a name="line-545"></a>          <span class='hs-comment'>-- simplifier does not discard them as dead code, and so that they</span>
<a name="line-546"></a>          <span class='hs-comment'>-- are exposed in the interface file (but not to export to the</span>
<a name="line-547"></a>          <span class='hs-comment'>-- user).</span>
<a name="line-548"></a>          <span class='hs-comment'>--</span>
<a name="line-549"></a>          <span class='hs-comment'>-- Some things, like dict-fun Ids and default-method Ids are "born"</span>
<a name="line-550"></a>          <span class='hs-comment'>-- with the Exported flag on, for exactly the above reason, but some</span>
<a name="line-551"></a>          <span class='hs-comment'>-- we only discover as we go.  Specifically:</span>
<a name="line-552"></a>          <span class='hs-comment'>--</span>
<a name="line-553"></a>          <span class='hs-comment'>--   * The to/from functions for generic data types</span>
<a name="line-554"></a>          <span class='hs-comment'>--</span>
<a name="line-555"></a>          <span class='hs-comment'>--   * Top-level variables appearing free in the RHS of an orphan</span>
<a name="line-556"></a>          <span class='hs-comment'>--     rule</span>
<a name="line-557"></a>          <span class='hs-comment'>--</span>
<a name="line-558"></a>          <span class='hs-comment'>--   * Top-level variables appearing free in a TH bracket</span>
<a name="line-559"></a>
<a name="line-560"></a>        <span class='hs-varid'>tcg_th_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-561"></a>          <span class='hs-comment'>-- ^ @True@ &lt;=&gt; Template Haskell syntax used.</span>
<a name="line-562"></a>          <span class='hs-comment'>--</span>
<a name="line-563"></a>          <span class='hs-comment'>-- We need this so that we can generate a dependency on the</span>
<a name="line-564"></a>          <span class='hs-comment'>-- Template Haskell package, because the desugarer is going</span>
<a name="line-565"></a>          <span class='hs-comment'>-- to emit loads of references to TH symbols.  The reference</span>
<a name="line-566"></a>          <span class='hs-comment'>-- is implicit rather than explicit, so we have to zap a</span>
<a name="line-567"></a>          <span class='hs-comment'>-- mutable variable.</span>
<a name="line-568"></a>
<a name="line-569"></a>        <span class='hs-varid'>tcg_th_splice_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-570"></a>          <span class='hs-comment'>-- ^ @True@ &lt;=&gt; A Template Haskell splice was used.</span>
<a name="line-571"></a>          <span class='hs-comment'>--</span>
<a name="line-572"></a>          <span class='hs-comment'>-- Splices disable recompilation avoidance (see #481)</span>
<a name="line-573"></a>
<a name="line-574"></a>        <span class='hs-varid'>tcg_th_top_level_locs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span> <span class='hs-conid'>RealSrcSpan</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-575"></a>          <span class='hs-comment'>-- ^ Locations of the top-level splices; used for providing details on</span>
<a name="line-576"></a>          <span class='hs-comment'>-- scope in error messages for out-of-scope variables</span>
<a name="line-577"></a>
<a name="line-578"></a>        <span class='hs-varid'>tcg_dfun_n</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>OccSet</span><span class='hs-layout'>,</span>
<a name="line-579"></a>          <span class='hs-comment'>-- ^ Allows us to choose unique DFun names.</span>
<a name="line-580"></a>
<a name="line-581"></a>        <span class='hs-varid'>tcg_merged</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-582"></a>          <span class='hs-comment'>-- ^ The requirements we merged with; we always have to recompile</span>
<a name="line-583"></a>          <span class='hs-comment'>-- if any of these changed.</span>
<a name="line-584"></a>
<a name="line-585"></a>        <span class='hs-comment'>-- The next fields accumulate the payload of the module</span>
<a name="line-586"></a>        <span class='hs-comment'>-- The binds, rules and foreign-decl fields are collected</span>
<a name="line-587"></a>        <span class='hs-comment'>-- initially in un-zonked form and are finally zonked in tcRnSrcDecls</span>
<a name="line-588"></a>
<a name="line-589"></a>        <span class='hs-varid'>tcg_rn_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>IE</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-590"></a>                <span class='hs-comment'>-- Nothing &lt;=&gt; no explicit export list</span>
<a name="line-591"></a>                <span class='hs-comment'>-- Is always Nothing if we don't want to retain renamed</span>
<a name="line-592"></a>                <span class='hs-comment'>-- exports</span>
<a name="line-593"></a>
<a name="line-594"></a>        <span class='hs-varid'>tcg_rn_imports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-595"></a>                <span class='hs-comment'>-- Keep the renamed imports regardless.  They are not</span>
<a name="line-596"></a>                <span class='hs-comment'>-- voluminous and are needed if you want to report unused imports</span>
<a name="line-597"></a>
<a name="line-598"></a>        <span class='hs-varid'>tcg_rn_decls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsGroup</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-599"></a>          <span class='hs-comment'>-- ^ Renamed decls, maybe.  @Nothing@ &lt;=&gt; Don't retain renamed</span>
<a name="line-600"></a>          <span class='hs-comment'>-- decls.</span>
<a name="line-601"></a>
<a name="line-602"></a>        <span class='hs-varid'>tcg_dependent_files</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ dependencies from addDependentFile</span>
<a name="line-603"></a>
<a name="line-604"></a>        <span class='hs-varid'>tcg_th_topdecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-605"></a>        <span class='hs-comment'>-- ^ Top-level declarations from addTopDecls</span>
<a name="line-606"></a>
<a name="line-607"></a>        <span class='hs-varid'>tcg_th_foreign_files</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ForeignSrcLang</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-608"></a>        <span class='hs-comment'>-- ^ Foreign files emitted from TH.</span>
<a name="line-609"></a>
<a name="line-610"></a>        <span class='hs-varid'>tcg_th_topnames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>
<a name="line-611"></a>        <span class='hs-comment'>-- ^ Exact names bound in top-level declarations in tcg_th_topdecls</span>
<a name="line-612"></a>
<a name="line-613"></a>        <span class='hs-varid'>tcg_th_modfinalizers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-614"></a>        <span class='hs-comment'>-- ^ Template Haskell module finalizers.</span>
<a name="line-615"></a>        <span class='hs-comment'>--</span>
<a name="line-616"></a>        <span class='hs-comment'>-- They are computations in the @TcM@ monad rather than @Q@ because we</span>
<a name="line-617"></a>        <span class='hs-comment'>-- set them to use particular local environments.</span>
<a name="line-618"></a>
<a name="line-619"></a>        <span class='hs-varid'>tcg_th_state</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span> <span class='hs-conid'>TypeRep</span> <span class='hs-conid'>Dynamic</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-620"></a>        <span class='hs-varid'>tcg_th_remote_state</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>QState</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-621"></a>        <span class='hs-comment'>-- ^ Template Haskell state</span>
<a name="line-622"></a>
<a name="line-623"></a>        <span class='hs-varid'>tcg_ev_binds</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Top-level evidence bindings</span>
<a name="line-624"></a>
<a name="line-625"></a>        <span class='hs-comment'>-- Things defined in this module, or (in GHCi)</span>
<a name="line-626"></a>        <span class='hs-comment'>-- in the declarations for a single GHCi command.</span>
<a name="line-627"></a>        <span class='hs-comment'>-- For the latter, see Note [The interactive package] in HscTypes</span>
<a name="line-628"></a>        <span class='hs-varid'>tcg_tr_module</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- Id for $trModule :: GHC.Types.Module</span>
<a name="line-629"></a>                                             <span class='hs-comment'>-- for which every module has a top-level defn</span>
<a name="line-630"></a>                                             <span class='hs-comment'>-- except in GHCi in which case we have Nothing</span>
<a name="line-631"></a>        <span class='hs-varid'>tcg_binds</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Value bindings in this module</span>
<a name="line-632"></a>        <span class='hs-varid'>tcg_sigs</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- ...Top-level names that *lack* a signature</span>
<a name="line-633"></a>        <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- ...SPECIALISE prags for imported Ids</span>
<a name="line-634"></a>        <span class='hs-varid'>tcg_warns</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Warnings</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- ...Warnings and deprecations</span>
<a name="line-635"></a>        <span class='hs-varid'>tcg_anns</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Annotation</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- ...Annotations</span>
<a name="line-636"></a>        <span class='hs-varid'>tcg_tcs</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- ...TyCons and Classes</span>
<a name="line-637"></a>        <span class='hs-varid'>tcg_insts</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- ...Instances</span>
<a name="line-638"></a>        <span class='hs-varid'>tcg_fam_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- ...Family instances</span>
<a name="line-639"></a>        <span class='hs-varid'>tcg_rules</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ...Rules</span>
<a name="line-640"></a>        <span class='hs-varid'>tcg_fords</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LForeignDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- ...Foreign import &amp; exports</span>
<a name="line-641"></a>        <span class='hs-varid'>tcg_vects</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LVectDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ...Vectorisation declarations</span>
<a name="line-642"></a>        <span class='hs-varid'>tcg_patsyns</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PatSyn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- ...Pattern synonyms</span>
<a name="line-643"></a>
<a name="line-644"></a>        <span class='hs-varid'>tcg_doc_hdr</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Maybe Haddock header docs</span>
<a name="line-645"></a>        <span class='hs-varid'>tcg_hpc</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnyHpcUsage</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- ^ @True@ if any part of the</span>
<a name="line-646"></a>                                             <span class='hs-comment'>--  prog uses hpc instrumentation.</span>
<a name="line-647"></a>
<a name="line-648"></a>        <span class='hs-varid'>tcg_self_boot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SelfBootInfo</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- ^ Whether this module has a</span>
<a name="line-649"></a>                                             <span class='hs-comment'>-- corresponding hi-boot file</span>
<a name="line-650"></a>
<a name="line-651"></a>        <span class='hs-varid'>tcg_main</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ^ The Name of the main</span>
<a name="line-652"></a>                                             <span class='hs-comment'>-- function, if this module is</span>
<a name="line-653"></a>                                             <span class='hs-comment'>-- the main module.</span>
<a name="line-654"></a>
<a name="line-655"></a>        <span class='hs-varid'>tcg_safeInfer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>WarningMessages</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-656"></a>        <span class='hs-comment'>-- ^ Has the typechecker inferred this module as -XSafe (Safe Haskell)</span>
<a name="line-657"></a>        <span class='hs-comment'>-- See Note [Safe Haskell Overlapping Instances Implementation],</span>
<a name="line-658"></a>        <span class='hs-comment'>-- although this is used for more than just that failure case.</span>
<a name="line-659"></a>
<a name="line-660"></a>        <span class='hs-varid'>tcg_tc_plugins</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcPluginSolver</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-661"></a>        <span class='hs-comment'>-- ^ A list of user-defined plugins for the constraint solver.</span>
<a name="line-662"></a>
<a name="line-663"></a>        <span class='hs-varid'>tcg_top_loc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RealSrcSpan</span><span class='hs-layout'>,</span>
<a name="line-664"></a>        <span class='hs-comment'>-- ^ The RealSrcSpan this module came from</span>
<a name="line-665"></a>
<a name="line-666"></a>        <span class='hs-varid'>tcg_static_wc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span>
<a name="line-667"></a>          <span class='hs-comment'>-- ^ Wanted constraints of static forms.</span>
<a name="line-668"></a>        <span class='hs-comment'>-- See Note [Constraints in static forms].</span>
<a name="line-669"></a>        <span class='hs-varid'>tcg_complete_matches</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CompleteMatch</span><span class='hs-keyglyph'>]</span>
<a name="line-670"></a>    <span class='hs-layout'>}</span>
<a name="line-671"></a>
<a name="line-672"></a><span class='hs-comment'>-- NB: topModIdentity, not topModSemantic!</span>
<a name="line-673"></a><span class='hs-comment'>-- Definition sites of orphan identities will be identity modules, not semantic</span>
<a name="line-674"></a><span class='hs-comment'>-- modules.</span>
<a name="line-675"></a>
<a name="line-676"></a><span class='hs-comment'>-- Note [Constraints in static forms]</span>
<a name="line-677"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-678"></a><span class='hs-comment'>--</span>
<a name="line-679"></a><span class='hs-comment'>-- When a static form produces constraints like</span>
<a name="line-680"></a><span class='hs-comment'>--</span>
<a name="line-681"></a><span class='hs-comment'>-- f :: StaticPtr (Bool -&gt; String)</span>
<a name="line-682"></a><span class='hs-comment'>-- f = static show</span>
<a name="line-683"></a><span class='hs-comment'>--</span>
<a name="line-684"></a><span class='hs-comment'>-- we collect them in tcg_static_wc and resolve them at the end</span>
<a name="line-685"></a><span class='hs-comment'>-- of type checking. They need to be resolved separately because</span>
<a name="line-686"></a><span class='hs-comment'>-- we don't want to resolve them in the context of the enclosing</span>
<a name="line-687"></a><span class='hs-comment'>-- expression. Consider</span>
<a name="line-688"></a><span class='hs-comment'>--</span>
<a name="line-689"></a><span class='hs-comment'>-- g :: Show a =&gt; StaticPtr (a -&gt; String)</span>
<a name="line-690"></a><span class='hs-comment'>-- g = static show</span>
<a name="line-691"></a><span class='hs-comment'>--</span>
<a name="line-692"></a><span class='hs-comment'>-- If the @Show a0@ constraint that the body of the static form produces was</span>
<a name="line-693"></a><span class='hs-comment'>-- resolved in the context of the enclosing expression, then the body of the</span>
<a name="line-694"></a><span class='hs-comment'>-- static form wouldn't be closed because the Show dictionary would come from</span>
<a name="line-695"></a><span class='hs-comment'>-- g's context instead of coming from the top level.</span>
<a name="line-696"></a>
<a name="line-697"></a><a name="tcVisibleOrphanMods"></a><span class='hs-definition'>tcVisibleOrphanMods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleSet</span>
<a name="line-698"></a><span class='hs-definition'>tcVisibleOrphanMods</span> <span class='hs-varid'>tcg_env</span>
<a name="line-699"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModuleSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_mod</span> <span class='hs-varid'>tcg_env</span> <span class='hs-conop'>:</span> <span class='hs-varid'>imp_orphs</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_imports</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-700"></a>
<a name="line-701"></a><a name="instance%20ContainsModule%20TcGblEnv"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyword'>where</span>
<a name="line-702"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_semantic_mod</span> <span class='hs-varid'>env</span>
<a name="line-703"></a>
<a name="line-704"></a><a name="RecFieldEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RecFieldEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FieldLabel</span><span class='hs-keyglyph'>]</span>
<a name="line-705"></a>        <span class='hs-comment'>-- Maps a constructor name *in this module*</span>
<a name="line-706"></a>        <span class='hs-comment'>-- to the fields for that constructor.</span>
<a name="line-707"></a>        <span class='hs-comment'>-- This is used when dealing with ".." notation in record</span>
<a name="line-708"></a>        <span class='hs-comment'>-- construction and pattern matching.</span>
<a name="line-709"></a>        <span class='hs-comment'>-- The FieldEnv deals *only* with constructors defined in *this*</span>
<a name="line-710"></a>        <span class='hs-comment'>-- module.  For imported modules, we get the same info from the</span>
<a name="line-711"></a>        <span class='hs-comment'>-- TypeEnv</span>
<a name="line-712"></a>
<a name="line-713"></a><a name="SelfBootInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SelfBootInfo</span>
<a name="line-714"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoSelfBoot</span>    <span class='hs-comment'>-- No corresponding hi-boot file</span>
<a name="line-715"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SelfBoot</span>
<a name="line-716"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>sb_mds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModDetails</span>   <span class='hs-comment'>-- There was a hi-boot file,</span>
<a name="line-717"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>sb_tcs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-layout'>}</span>    <span class='hs-comment'>-- defining these TyCons,</span>
<a name="line-718"></a><span class='hs-comment'>-- What is sb_tcs used for?  See Note [Extra dependencies from .hs-boot files]</span>
<a name="line-719"></a><span class='hs-comment'>-- in RnSource</span>
<a name="line-720"></a>
<a name="line-721"></a>
<a name="line-722"></a><span class='hs-comment'>{- Note [Tracking unused binding and imports]
<a name="line-723"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-724"></a>We gather two sorts of usage information
<a name="line-725"></a>
<a name="line-726"></a> * tcg_dus (defs/uses)
<a name="line-727"></a>      Records *defined* Names (local, top-level)
<a name="line-728"></a>          and *used*    Names (local or imported)
<a name="line-729"></a>
<a name="line-730"></a>      Used (a) to report "defined but not used"
<a name="line-731"></a>               (see RnNames.reportUnusedNames)
<a name="line-732"></a>           (b) to generate version-tracking usage info in interface
<a name="line-733"></a>               files (see MkIface.mkUsedNames)
<a name="line-734"></a>   This usage info is mainly gathered by the renamer's
<a name="line-735"></a>   gathering of free-variables
<a name="line-736"></a>
<a name="line-737"></a> * tcg_used_gres
<a name="line-738"></a>      Used only to report unused import declarations
<a name="line-739"></a>
<a name="line-740"></a>      Records each *occurrence* an *imported* (not locally-defined) entity.
<a name="line-741"></a>      The occurrence is recorded by keeping a GlobalRdrElt for it.
<a name="line-742"></a>      These is not the GRE that is in the GlobalRdrEnv; rather it
<a name="line-743"></a>      is recorded *after* the filtering done by pickGREs.  So it reflect
<a name="line-744"></a>      /how that occurrence is in scope/.   See Note [GRE filtering] in
<a name="line-745"></a>      RdrName.
<a name="line-746"></a>
<a name="line-747"></a>
<a name="line-748"></a>************************************************************************
<a name="line-749"></a>*                                                                      *
<a name="line-750"></a>                The local typechecker environment
<a name="line-751"></a>*                                                                      *
<a name="line-752"></a>************************************************************************
<a name="line-753"></a>
<a name="line-754"></a>Note [The Global-Env/Local-Env story]
<a name="line-755"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-756"></a>During type checking, we keep in the tcg_type_env
<a name="line-757"></a>        * All types and classes
<a name="line-758"></a>        * All Ids derived from types and classes (constructors, selectors)
<a name="line-759"></a>
<a name="line-760"></a>At the end of type checking, we zonk the local bindings,
<a name="line-761"></a>and as we do so we add to the tcg_type_env
<a name="line-762"></a>        * Locally defined top-level Ids
<a name="line-763"></a>
<a name="line-764"></a>Why?  Because they are now Ids not TcIds.  This final GlobalEnv is
<a name="line-765"></a>        a) fed back (via the knot) to typechecking the
<a name="line-766"></a>           unfoldings of interface signatures
<a name="line-767"></a>        b) used in the ModDetails of this module
<a name="line-768"></a>-}</span>
<a name="line-769"></a>
<a name="line-770"></a><a name="TcLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcLclEnv</span>           <span class='hs-comment'>-- Changes as we move inside an expression</span>
<a name="line-771"></a>                        <span class='hs-comment'>-- Discarded after typecheck/rename; not passed on to desugarer</span>
<a name="line-772"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-773"></a>        <span class='hs-varid'>tcl_loc</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RealSrcSpan</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Source span</span>
<a name="line-774"></a>        <span class='hs-varid'>tcl_ctxt</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ErrCtxt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Error context, innermost on top</span>
<a name="line-775"></a>        <span class='hs-varid'>tcl_tclvl</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Birthplace for new unification variables</span>
<a name="line-776"></a>
<a name="line-777"></a>        <span class='hs-varid'>tcl_th_ctxt</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Template Haskell context</span>
<a name="line-778"></a>        <span class='hs-varid'>tcl_th_bndrs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThBindEnv</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- and binder info</span>
<a name="line-779"></a>            <span class='hs-comment'>-- The ThBindEnv records the TH binding level of in-scope Names</span>
<a name="line-780"></a>            <span class='hs-comment'>-- defined in this module (not imported)</span>
<a name="line-781"></a>            <span class='hs-comment'>-- We can't put this info in the TypeEnv because it's needed</span>
<a name="line-782"></a>            <span class='hs-comment'>-- (and extended) in the renamer, for untyed splices</span>
<a name="line-783"></a>
<a name="line-784"></a>        <span class='hs-varid'>tcl_arrow_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArrowCtxt</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Arrow-notation context</span>
<a name="line-785"></a>
<a name="line-786"></a>        <span class='hs-varid'>tcl_rdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Local name envt</span>
<a name="line-787"></a>                <span class='hs-comment'>-- Maintained during renaming, of course, but also during</span>
<a name="line-788"></a>                <span class='hs-comment'>-- type checking, solely so that when renaming a Template-Haskell</span>
<a name="line-789"></a>                <span class='hs-comment'>-- splice we have the right environment for the renamer.</span>
<a name="line-790"></a>                <span class='hs-comment'>--</span>
<a name="line-791"></a>                <span class='hs-comment'>--   Does *not* include global name envt; may shadow it</span>
<a name="line-792"></a>                <span class='hs-comment'>--   Includes both ordinary variables and type variables;</span>
<a name="line-793"></a>                <span class='hs-comment'>--   they are kept distinct because tyvar have a different</span>
<a name="line-794"></a>                <span class='hs-comment'>--   occurrence constructor (Name.TvOcc)</span>
<a name="line-795"></a>                <span class='hs-comment'>-- We still need the unsullied global name env so that</span>
<a name="line-796"></a>                <span class='hs-comment'>--   we can look up record field names</span>
<a name="line-797"></a>
<a name="line-798"></a>        <span class='hs-varid'>tcl_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTypeEnv</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- The local type environment:</span>
<a name="line-799"></a>                                  <span class='hs-comment'>-- Ids and TyVars defined in this module</span>
<a name="line-800"></a>
<a name="line-801"></a>        <span class='hs-varid'>tcl_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdBinderStack</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Used for reporting relevant bindings</span>
<a name="line-802"></a>
<a name="line-803"></a>        <span class='hs-varid'>tcl_tidy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Used for tidying types; contains all</span>
<a name="line-804"></a>                                  <span class='hs-comment'>-- in-scope type variables (but not term variables)</span>
<a name="line-805"></a>
<a name="line-806"></a>        <span class='hs-varid'>tcl_tyvars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>TcTyVarSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The "global tyvars"</span>
<a name="line-807"></a>                        <span class='hs-comment'>-- Namely, the in-scope TyVars bound in tcl_env,</span>
<a name="line-808"></a>                        <span class='hs-comment'>-- plus the tyvars mentioned in the types of Ids bound</span>
<a name="line-809"></a>                        <span class='hs-comment'>-- in tcl_lenv.</span>
<a name="line-810"></a>                        <span class='hs-comment'>-- Why mutable? see notes with tcGetGlobalTyCoVars</span>
<a name="line-811"></a>
<a name="line-812"></a>        <span class='hs-varid'>tcl_lie</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Place to accumulate type constraints</span>
<a name="line-813"></a>        <span class='hs-varid'>tcl_errs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Messages</span>              <span class='hs-comment'>-- Place to accumulate errors</span>
<a name="line-814"></a>    <span class='hs-layout'>}</span>
<a name="line-815"></a>
<a name="line-816"></a><a name="ErrCtxt"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-817"></a>        <span class='hs-comment'>-- Monadic so that we have a chance</span>
<a name="line-818"></a>        <span class='hs-comment'>-- to deal with bound type variables just before error</span>
<a name="line-819"></a>        <span class='hs-comment'>-- message construction</span>
<a name="line-820"></a>
<a name="line-821"></a>        <span class='hs-comment'>-- Bool:  True &lt;=&gt; this is a landmark context; do not</span>
<a name="line-822"></a>        <span class='hs-comment'>--                 discard it when trimming for display</span>
<a name="line-823"></a>
<a name="line-824"></a><a name="TcTypeEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcTypeEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-825"></a>
<a name="line-826"></a><a name="ThBindEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThBindEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThLevel</span><span class='hs-layout'>)</span>
<a name="line-827"></a>   <span class='hs-comment'>-- Domain = all Ids bound in this module (ie not imported)</span>
<a name="line-828"></a>   <span class='hs-comment'>-- The TopLevelFlag tells if the binding is syntactically top level.</span>
<a name="line-829"></a>   <span class='hs-comment'>-- We need to know this, because the cross-stage persistence story allows</span>
<a name="line-830"></a>   <span class='hs-comment'>-- cross-stage at arbitrary types if the Id is bound at top level.</span>
<a name="line-831"></a>   <span class='hs-comment'>--</span>
<a name="line-832"></a>   <span class='hs-comment'>-- Nota bene: a ThLevel of 'outerLevel' is *not* the same as being</span>
<a name="line-833"></a>   <span class='hs-comment'>-- bound at top level!  See Note [Template Haskell levels] in TcSplice</span>
<a name="line-834"></a>
<a name="line-835"></a><span class='hs-comment'>{- Note [Given Insts]
<a name="line-836"></a>   ~~~~~~~~~~~~~~~~~~
<a name="line-837"></a>Because of GADTs, we have to pass inwards the Insts provided by type signatures
<a name="line-838"></a>and existential contexts. Consider
<a name="line-839"></a>        data T a where { T1 :: b -&gt; b -&gt; T [b] }
<a name="line-840"></a>        f :: Eq a =&gt; T a -&gt; Bool
<a name="line-841"></a>        f (T1 x y) = [x]==[y]
<a name="line-842"></a>
<a name="line-843"></a>The constructor T1 binds an existential variable 'b', and we need Eq [b].
<a name="line-844"></a>Well, we have it, because Eq a refines to Eq [b], but we can only spot that if we
<a name="line-845"></a>pass it inwards.
<a name="line-846"></a>
<a name="line-847"></a>-}</span>
<a name="line-848"></a>
<a name="line-849"></a><a name="TcRef"></a><span class='hs-comment'>-- | Type alias for 'IORef'; the convention is we'll use this for mutable</span>
<a name="line-850"></a><a name="TcRef"></a><span class='hs-comment'>-- bits of data in 'TcGblEnv' which are updated during typechecking and</span>
<a name="line-851"></a><a name="TcRef"></a><span class='hs-comment'>-- returned at the end.</span>
<a name="line-852"></a><a name="TcRef"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IORef</span> <span class='hs-varid'>a</span>
<a name="line-853"></a><a name="TcId"></a><span class='hs-comment'>-- ToDo: when should I refer to it as a 'TcId' instead of an 'Id'?</span>
<a name="line-854"></a><a name="TcId"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcId</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span>
<a name="line-855"></a><a name="TcIdSet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcIdSet</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdSet</span>
<a name="line-856"></a>
<a name="line-857"></a><span class='hs-comment'>---------------------------</span>
<a name="line-858"></a><span class='hs-comment'>-- The TcIdBinderStack</span>
<a name="line-859"></a><span class='hs-comment'>---------------------------</span>
<a name="line-860"></a>
<a name="line-861"></a><a name="TcIdBinderStack"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcIdBinderStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-862"></a>   <span class='hs-comment'>-- This is a stack of locally-bound ids, innermost on top</span>
<a name="line-863"></a>   <span class='hs-comment'>-- Used ony in error reporting (relevantBindings in TcError)</span>
<a name="line-864"></a>   <span class='hs-comment'>-- We can't use the tcl_env type environment, because it doesn't</span>
<a name="line-865"></a>   <span class='hs-comment'>--   keep track of the nesting order</span>
<a name="line-866"></a>
<a name="line-867"></a><a name="TcIdBinder"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcIdBinder</span>
<a name="line-868"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcIdBndr</span>
<a name="line-869"></a>       <span class='hs-conid'>TcId</span>
<a name="line-870"></a>       <span class='hs-conid'>TopLevelFlag</span>    <span class='hs-comment'>-- Tells whether the binding is syntactically top-level</span>
<a name="line-871"></a>                       <span class='hs-comment'>-- (The monomorphic Ids for a recursive group count</span>
<a name="line-872"></a>                       <span class='hs-comment'>--  as not-top-level for this purpose.)</span>
<a name="line-873"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcIdBndr_ExpType</span>  <span class='hs-comment'>-- Variant that allows the type to be specified as</span>
<a name="line-874"></a>                      <span class='hs-comment'>-- an ExpType</span>
<a name="line-875"></a>       <span class='hs-conid'>Name</span>
<a name="line-876"></a>       <span class='hs-conid'>ExpType</span>
<a name="line-877"></a>       <span class='hs-conid'>TopLevelFlag</span>
<a name="line-878"></a>
<a name="line-879"></a><a name="instance%20Outputable%20TcIdBinder"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcIdBinder</span> <span class='hs-keyword'>where</span>
<a name="line-880"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdBndr</span> <span class='hs-varid'>id</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span>
<a name="line-881"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdBndr_ExpType</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span>
<a name="line-882"></a>
<a name="line-883"></a><a name="instance%20HasOccName%20TcIdBinder"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasOccName</span> <span class='hs-conid'>TcIdBinder</span> <span class='hs-keyword'>where</span>
<a name="line-884"></a>    <span class='hs-varid'>occName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdBndr</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>occName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-885"></a>    <span class='hs-varid'>occName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdBndr_ExpType</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>occName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-886"></a>
<a name="line-887"></a><span class='hs-comment'>---------------------------</span>
<a name="line-888"></a><span class='hs-comment'>-- Template Haskell stages and levels</span>
<a name="line-889"></a><span class='hs-comment'>---------------------------</span>
<a name="line-890"></a>
<a name="line-891"></a><a name="SpliceType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SpliceType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Typed</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Untyped</span>
<a name="line-892"></a>
<a name="line-893"></a><a name="ThStage"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ThStage</span>    <span class='hs-comment'>-- See Note [Template Haskell state diagram] in TcSplice</span>
<a name="line-894"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>SpliceType</span> <span class='hs-comment'>-- Inside a top-level splice</span>
<a name="line-895"></a>                      <span class='hs-comment'>-- This code will be run *at compile time*;</span>
<a name="line-896"></a>                      <span class='hs-comment'>--   the result replaces the splice</span>
<a name="line-897"></a>                      <span class='hs-comment'>-- Binding level = 0</span>
<a name="line-898"></a>
<a name="line-899"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RunSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ForeignRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Q</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-900"></a>      <span class='hs-comment'>-- Set when running a splice, i.e. NOT when renaming or typechecking the</span>
<a name="line-901"></a>      <span class='hs-comment'>-- Haskell code for the splice. See Note [RunSplice ThLevel].</span>
<a name="line-902"></a>      <span class='hs-comment'>--</span>
<a name="line-903"></a>      <span class='hs-comment'>-- Contains a list of mod finalizers collected while executing the splice.</span>
<a name="line-904"></a>      <span class='hs-comment'>--</span>
<a name="line-905"></a>      <span class='hs-comment'>-- 'addModFinalizer' inserts finalizers here, and from here they are taken</span>
<a name="line-906"></a>      <span class='hs-comment'>-- to construct an @HsSpliced@ annotation for untyped splices. See Note</span>
<a name="line-907"></a>      <span class='hs-comment'>-- [Delaying modFinalizers in untyped splices] in "RnSplice".</span>
<a name="line-908"></a>      <span class='hs-comment'>--</span>
<a name="line-909"></a>      <span class='hs-comment'>-- For typed splices, the typechecker takes finalizers from here and</span>
<a name="line-910"></a>      <span class='hs-comment'>-- inserts them in the list of finalizers in the global environment.</span>
<a name="line-911"></a>      <span class='hs-comment'>--</span>
<a name="line-912"></a>      <span class='hs-comment'>-- See Note [Collecting modFinalizers in typed splices] in "TcSplice".</span>
<a name="line-913"></a>
<a name="line-914"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Comp</span>        <span class='hs-comment'>-- Ordinary Haskell code</span>
<a name="line-915"></a>                <span class='hs-comment'>-- Binding level = 1</span>
<a name="line-916"></a>
<a name="line-917"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Brack</span>                       <span class='hs-comment'>-- Inside brackets</span>
<a name="line-918"></a>      <span class='hs-conid'>ThStage</span>                   <span class='hs-comment'>--   Enclosing stage</span>
<a name="line-919"></a>      <span class='hs-conid'>PendingStuff</span>
<a name="line-920"></a>
<a name="line-921"></a><a name="PendingStuff"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PendingStuff</span>
<a name="line-922"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RnPendingUntyped</span>              <span class='hs-comment'>-- Renaming the inside of an *untyped* bracket</span>
<a name="line-923"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingRnSplice</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Pending splices in here</span>
<a name="line-924"></a>
<a name="line-925"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RnPendingTyped</span>                <span class='hs-comment'>-- Renaming the inside of a *typed* bracket</span>
<a name="line-926"></a>
<a name="line-927"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPending</span>                     <span class='hs-comment'>-- Typechecking the inside of a typed bracket</span>
<a name="line-928"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingTcSplice</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>--   Accumulate pending splices here</span>
<a name="line-929"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>)</span>   <span class='hs-comment'>--     and type constraints here</span>
<a name="line-930"></a>
<a name="line-931"></a><a name="topStage"></a><span class='hs-definition'>topStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topAnnStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSpliceStage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span>
<a name="line-932"></a><span class='hs-definition'>topStage</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Comp</span>
<a name="line-933"></a><a name="topAnnStage"></a><span class='hs-definition'>topAnnStage</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>Untyped</span>
<a name="line-934"></a><a name="topSpliceStage"></a><span class='hs-definition'>topSpliceStage</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>Untyped</span>
<a name="line-935"></a>
<a name="line-936"></a><a name="instance%20Outputable%20ThStage"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyword'>where</span>
<a name="line-937"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Splice"</span>
<a name="line-938"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunSplice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"RunSplice"</span>
<a name="line-939"></a>   <span class='hs-varid'>ppr</span> <span class='hs-conid'>Comp</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Comp"</span>
<a name="line-940"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Brack"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-941"></a>
<a name="line-942"></a><a name="ThLevel"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-943"></a>    <span class='hs-comment'>-- NB: see Note [Template Haskell levels] in TcSplice</span>
<a name="line-944"></a>    <span class='hs-comment'>-- Incremented when going inside a bracket,</span>
<a name="line-945"></a>    <span class='hs-comment'>-- decremented when going inside a splice</span>
<a name="line-946"></a>    <span class='hs-comment'>-- NB: ThLevel is one greater than the 'n' in Fig 2 of the</span>
<a name="line-947"></a>    <span class='hs-comment'>--     original "Template meta-programming for Haskell" paper</span>
<a name="line-948"></a>
<a name="line-949"></a><a name="impLevel"></a><span class='hs-definition'>impLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>outerLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThLevel</span>
<a name="line-950"></a><span class='hs-definition'>impLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>    <span class='hs-comment'>-- Imported things; they can be used inside a top level splice</span>
<a name="line-951"></a><a name="outerLevel"></a><span class='hs-definition'>outerLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>  <span class='hs-comment'>-- Things defined outside brackets</span>
<a name="line-952"></a>
<a name="line-953"></a><a name="thLevel"></a><span class='hs-definition'>thLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThLevel</span>
<a name="line-954"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-955"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunSplice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-956"></a>    <span class='hs-comment'>-- See Note [RunSplice ThLevel].</span>
<a name="line-957"></a>    <span class='hs-varid'>panic</span> <span class='hs-str'>"thLevel: called when running a splice"</span>
<a name="line-958"></a><span class='hs-definition'>thLevel</span> <span class='hs-conid'>Comp</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-959"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thLevel</span> <span class='hs-varid'>s</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-960"></a>
<a name="line-961"></a><span class='hs-comment'>{- Node [RunSplice ThLevel]
<a name="line-962"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-963"></a>The 'RunSplice' stage is set when executing a splice, and only when running a
<a name="line-964"></a>splice. In particular it is not set when the splice is renamed or typechecked.
<a name="line-965"></a>
<a name="line-966"></a>'RunSplice' is needed to provide a reference where 'addModFinalizer' can insert
<a name="line-967"></a>the finalizer (see Note [Delaying modFinalizers in untyped splices]), and
<a name="line-968"></a>'addModFinalizer' runs when doing Q things. Therefore, It doesn't make sense to
<a name="line-969"></a>set 'RunSplice' when renaming or typechecking the splice, where 'Splice', 'Brak'
<a name="line-970"></a>or 'Comp' are used instead.
<a name="line-971"></a>
<a name="line-972"></a>-}</span>
<a name="line-973"></a>
<a name="line-974"></a><span class='hs-comment'>---------------------------</span>
<a name="line-975"></a><span class='hs-comment'>-- Arrow-notation context</span>
<a name="line-976"></a><span class='hs-comment'>---------------------------</span>
<a name="line-977"></a>
<a name="line-978"></a><span class='hs-comment'>{- Note [Escaping the arrow scope]
<a name="line-979"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-980"></a>In arrow notation, a variable bound by a proc (or enclosed let/kappa)
<a name="line-981"></a>is not in scope to the left of an arrow tail (-&lt;) or the head of (|..|).
<a name="line-982"></a>For example
<a name="line-983"></a>
<a name="line-984"></a>        proc x -&gt; (e1 -&lt; e2)
<a name="line-985"></a>
<a name="line-986"></a>Here, x is not in scope in e1, but it is in scope in e2.  This can get
<a name="line-987"></a>a bit complicated:
<a name="line-988"></a>
<a name="line-989"></a>        let x = 3 in
<a name="line-990"></a>        proc y -&gt; (proc z -&gt; e1) -&lt; e2
<a name="line-991"></a>
<a name="line-992"></a>Here, x and z are in scope in e1, but y is not.
<a name="line-993"></a>
<a name="line-994"></a>We implement this by
<a name="line-995"></a>recording the environment when passing a proc (using newArrowScope),
<a name="line-996"></a>and returning to that (using escapeArrowScope) on the left of -&lt; and the
<a name="line-997"></a>head of (|..|).
<a name="line-998"></a>
<a name="line-999"></a>All this can be dealt with by the *renamer*. But the type checker needs
<a name="line-1000"></a>to be involved too.  Example (arrowfail001)
<a name="line-1001"></a>  class Foo a where foo :: a -&gt; ()
<a name="line-1002"></a>  data Bar = forall a. Foo a =&gt; Bar a
<a name="line-1003"></a>  get :: Bar -&gt; ()
<a name="line-1004"></a>  get = proc x -&gt; case x of Bar a -&gt; foo -&lt; a
<a name="line-1005"></a>Here the call of 'foo' gives rise to a (Foo a) constraint that should not
<a name="line-1006"></a>be captured by the pattern match on 'Bar'.  Rather it should join the
<a name="line-1007"></a>constraints from further out.  So we must capture the constraint bag
<a name="line-1008"></a>from further out in the ArrowCtxt that we push inwards.
<a name="line-1009"></a>-}</span>
<a name="line-1010"></a>
<a name="line-1011"></a><a name="ArrowCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArrowCtxt</span>   <span class='hs-comment'>-- Note [Escaping the arrow scope]</span>
<a name="line-1012"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoArrowCtxt</span>
<a name="line-1013"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrowCtxt</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>)</span>
<a name="line-1014"></a>
<a name="line-1015"></a>
<a name="line-1016"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1017"></a><span class='hs-comment'>-- TcTyThing</span>
<a name="line-1018"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1019"></a>
<a name="line-1020"></a><a name="TcTyThing"></a><span class='hs-comment'>-- | A typecheckable thing available in a local context.  Could be</span>
<a name="line-1021"></a><a name="TcTyThing"></a><span class='hs-comment'>-- 'AGlobal' 'TyThing', but also lexically scoped variables, etc.</span>
<a name="line-1022"></a><a name="TcTyThing"></a><span class='hs-comment'>-- See 'TcEnv' for how to retrieve a 'TyThing' given a 'Name'.</span>
<a name="line-1023"></a><a name="TcTyThing"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-1024"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AGlobal</span> <span class='hs-conid'>TyThing</span>             <span class='hs-comment'>-- Used only in the return type of a lookup</span>
<a name="line-1025"></a>
<a name="line-1026"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATcId</span>           <span class='hs-comment'>-- Ids defined in this module; may not be fully zonked</span>
<a name="line-1027"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>tct_id</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span>
<a name="line-1028"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tct_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdBindingInfo</span>   <span class='hs-comment'>-- See Note [Meaning of IdBindingInfo]</span>
<a name="line-1029"></a>      <span class='hs-layout'>}</span>
<a name="line-1030"></a>
<a name="line-1031"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyVar</span>  <span class='hs-conid'>Name</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- The type variable to which the lexically scoped type</span>
<a name="line-1032"></a>                                <span class='hs-comment'>-- variable is bound. We only need the Name</span>
<a name="line-1033"></a>                                <span class='hs-comment'>-- for error-message purposes; it is the corresponding</span>
<a name="line-1034"></a>                                <span class='hs-comment'>-- Name in the domain of the envt</span>
<a name="line-1035"></a>
<a name="line-1036"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATcTyCon</span> <span class='hs-conid'>TyCon</span>   <span class='hs-comment'>-- Used temporarily, during kind checking, for the</span>
<a name="line-1037"></a>                     <span class='hs-comment'>-- tycons and clases in this recursive group</span>
<a name="line-1038"></a>                     <span class='hs-comment'>-- The TyCon is always a TcTyCon.  Its kind</span>
<a name="line-1039"></a>                     <span class='hs-comment'>-- can be a mono-kind or a poly-kind; in TcTyClsDcls see</span>
<a name="line-1040"></a>                     <span class='hs-comment'>-- Note [Type checking recursive type and class declarations]</span>
<a name="line-1041"></a>
<a name="line-1042"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>APromotionErr</span> <span class='hs-conid'>PromotionErr</span>
<a name="line-1043"></a>
<a name="line-1044"></a><a name="PromotionErr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PromotionErr</span>
<a name="line-1045"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConPE</span>          <span class='hs-comment'>-- TyCon used in a kind before we are ready</span>
<a name="line-1046"></a>                     <span class='hs-comment'>--     data T :: T -&gt; * where ...</span>
<a name="line-1047"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassPE</span>          <span class='hs-comment'>-- Ditto Class</span>
<a name="line-1048"></a>
<a name="line-1049"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamDataConPE</span>     <span class='hs-comment'>-- Data constructor for a data family</span>
<a name="line-1050"></a>                     <span class='hs-comment'>-- See Note [AFamDataCon: not promoting data family constructors]</span>
<a name="line-1051"></a>                     <span class='hs-comment'>-- in TcEnv.</span>
<a name="line-1052"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatSynPE</span>         <span class='hs-comment'>-- Pattern synonyms</span>
<a name="line-1053"></a>                     <span class='hs-comment'>-- See Note [Don't promote pattern synonyms] in TcEnv</span>
<a name="line-1054"></a>
<a name="line-1055"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecDataConPE</span>     <span class='hs-comment'>-- Data constructor in a recursive loop</span>
<a name="line-1056"></a>                     <span class='hs-comment'>-- See Note [ARecDataCon: recusion and promoting data constructors] in TcTyClsDecls</span>
<a name="line-1057"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoDataKindsTC</span>    <span class='hs-comment'>-- -XDataKinds not enabled (for a tycon)</span>
<a name="line-1058"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoDataKindsDC</span>    <span class='hs-comment'>-- -XDataKinds not enabled (for a datacon)</span>
<a name="line-1059"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoTypeInTypeTC</span>   <span class='hs-comment'>-- -XTypeInType not enabled (for a tycon)</span>
<a name="line-1060"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoTypeInTypeDC</span>   <span class='hs-comment'>-- -XTypeInType not enabled (for a datacon)</span>
<a name="line-1061"></a>
<a name="line-1062"></a><a name="instance%20Outputable%20TcTyThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyword'>where</span>     <span class='hs-comment'>-- Debugging only</span>
<a name="line-1063"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>g</span>
<a name="line-1064"></a>   <span class='hs-varid'>ppr</span> <span class='hs-varid'>elt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Identifier"</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-1065"></a>                          <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_id</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-1066"></a>                                 <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_id</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-1067"></a>                                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_info</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1068"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type variable"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span>
<a name="line-1069"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ATcTyCon"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1070"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"APromotionErr"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>err</span>
<a name="line-1071"></a>
<a name="line-1072"></a><a name="IdBindingInfo"></a><span class='hs-comment'>-- | IdBindingInfo describes how an Id is bound.</span>
<a name="line-1073"></a><a name="IdBindingInfo"></a><span class='hs-comment'>--</span>
<a name="line-1074"></a><a name="IdBindingInfo"></a><span class='hs-comment'>-- It is used for the following purposes:</span>
<a name="line-1075"></a><a name="IdBindingInfo"></a><span class='hs-comment'>-- a) for static forms in TcExpr.checkClosedInStaticForm and</span>
<a name="line-1076"></a><a name="IdBindingInfo"></a><span class='hs-comment'>-- b) to figure out when a nested binding can be generalised,</span>
<a name="line-1077"></a><a name="IdBindingInfo"></a><span class='hs-comment'>--    in TcBinds.decideGeneralisationPlan.</span>
<a name="line-1078"></a><a name="IdBindingInfo"></a><span class='hs-comment'>--</span>
<a name="line-1079"></a><a name="IdBindingInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IdBindingInfo</span> <span class='hs-comment'>-- See Note [Meaning of IdBindingInfo and ClosedTypeId]</span>
<a name="line-1080"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotLetBound</span>
<a name="line-1081"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClosedLet</span>
<a name="line-1082"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NonClosedLet</span>
<a name="line-1083"></a>         <span class='hs-conid'>RhsNames</span>        <span class='hs-comment'>-- Used for (static e) checks only</span>
<a name="line-1084"></a>         <span class='hs-conid'>ClosedTypeId</span>    <span class='hs-comment'>-- Used for generalisation checks</span>
<a name="line-1085"></a>                         <span class='hs-comment'>-- and for (static e) checks</span>
<a name="line-1086"></a>
<a name="line-1087"></a><a name="IsGroupClosed"></a><span class='hs-comment'>-- | IsGroupClosed describes a group of mutually-recursive bindings</span>
<a name="line-1088"></a><a name="IsGroupClosed"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IsGroupClosed</span>
<a name="line-1089"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IsGroupClosed</span>
<a name="line-1090"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>NameEnv</span> <span class='hs-conid'>RhsNames</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Free var info for the RHS of each binding in the goup</span>
<a name="line-1091"></a>                          <span class='hs-comment'>-- Used only for (static e) checks</span>
<a name="line-1092"></a>
<a name="line-1093"></a>      <span class='hs-conid'>ClosedTypeId</span>        <span class='hs-comment'>-- True &lt;=&gt; all the free vars of the group are</span>
<a name="line-1094"></a>                          <span class='hs-comment'>--          imported or ClosedLet or</span>
<a name="line-1095"></a>                          <span class='hs-comment'>--          NonClosedLet with ClosedTypeId=True.</span>
<a name="line-1096"></a>                          <span class='hs-comment'>--          In particular, no tyvars, no NotLetBound</span>
<a name="line-1097"></a>
<a name="line-1098"></a><a name="RhsNames"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RhsNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameSet</span>   <span class='hs-comment'>-- Names of variables, mentioned on the RHS of</span>
<a name="line-1099"></a>                          <span class='hs-comment'>-- a definition, that are not Global or ClosedLet</span>
<a name="line-1100"></a>
<a name="line-1101"></a><a name="ClosedTypeId"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ClosedTypeId</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bool</span>
<a name="line-1102"></a>  <span class='hs-comment'>-- See Note [Meaning of IdBindingInfo and ClosedTypeId]</span>
<a name="line-1103"></a>
<a name="line-1104"></a><span class='hs-comment'>{- Note [Meaning of IdBindingInfo]
<a name="line-1105"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1106"></a>NotLetBound means that
<a name="line-1107"></a>  the Id is not let-bound (e.g. it is bound in a
<a name="line-1108"></a>  lambda-abstraction or in a case pattern)
<a name="line-1109"></a>
<a name="line-1110"></a>ClosedLet means that
<a name="line-1111"></a>   - The Id is let-bound,
<a name="line-1112"></a>   - Any free term variables are also Global or ClosedLet
<a name="line-1113"></a>   - Its type has no free variables (NB: a top-level binding subject
<a name="line-1114"></a>     to the MR might have free vars in its type)
<a name="line-1115"></a>   These ClosedLets can definitely be floated to top level; and we
<a name="line-1116"></a>   may need to do so for static forms.
<a name="line-1117"></a>
<a name="line-1118"></a>   Property:   ClosedLet
<a name="line-1119"></a>             is equivalent to
<a name="line-1120"></a>               NonClosedLet emptyNameSet True
<a name="line-1121"></a>
<a name="line-1122"></a>(NonClosedLet (fvs::RhsNames) (cl::ClosedTypeId)) means that
<a name="line-1123"></a>   - The Id is let-bound
<a name="line-1124"></a>
<a name="line-1125"></a>   - The fvs::RhsNames contains the free names of the RHS,
<a name="line-1126"></a>     excluding Global and ClosedLet ones.
<a name="line-1127"></a>
<a name="line-1128"></a>   - For the ClosedTypeId field see Note [Bindings with closed types]
<a name="line-1129"></a>
<a name="line-1130"></a>For (static e) to be valid, we need for every 'x' free in 'e',
<a name="line-1131"></a>x's binding must be floatable to top level.  Specifically:
<a name="line-1132"></a>   * x's RhsNames must be non-empty
<a name="line-1133"></a>   * x's type has no free variables
<a name="line-1134"></a>See Note [Grand plan for static forms] in StaticPtrTable.hs.
<a name="line-1135"></a>This test is made in TcExpr.checkClosedInStaticForm.
<a name="line-1136"></a>Actually knowing x's RhsNames (rather than just its emptiness
<a name="line-1137"></a>or otherwise) is just so we can produce better error messages
<a name="line-1138"></a>
<a name="line-1139"></a>Note [Bindings with closed types: ClosedTypeId]
<a name="line-1140"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1141"></a>Consider
<a name="line-1142"></a>
<a name="line-1143"></a>  f x = let g ys = map not ys
<a name="line-1144"></a>        in ...
<a name="line-1145"></a>
<a name="line-1146"></a>Can we generalise 'g' under the OutsideIn algorithm?  Yes,
<a name="line-1147"></a>because all g's free variables are top-level; that is they themselves
<a name="line-1148"></a>have no free type variables, and it is the type variables in the
<a name="line-1149"></a>environment that makes things tricky for OutsideIn generalisation.
<a name="line-1150"></a>
<a name="line-1151"></a>Here's the invariant:
<a name="line-1152"></a>   If an Id has ClosedTypeId=True (in its IdBindingInfo), then
<a name="line-1153"></a>   the Id's type is /definitely/ closed (has no free type variables).
<a name="line-1154"></a>   Specifically,
<a name="line-1155"></a>       a) The Id's acutal type is closed (has no free tyvars)
<a name="line-1156"></a>       b) Either the Id has a (closed) user-supplied type signature
<a name="line-1157"></a>          or all its free varaibles are Global/ClosedLet
<a name="line-1158"></a>             or NonClosedLet with ClosedTypeId=True.
<a name="line-1159"></a>          In particular, none are NotLetBound.
<a name="line-1160"></a>
<a name="line-1161"></a>Why is (b) needed?   Consider
<a name="line-1162"></a>    \x. (x :: Int, let y = x+1 in ...)
<a name="line-1163"></a>Initially x::alpha.  If we happen to typecheck the 'let' before the
<a name="line-1164"></a>(x::Int), y's type will have a free tyvar; but if the other way round
<a name="line-1165"></a>it won't.  So we treat any let-bound variable with a free
<a name="line-1166"></a>non-let-bound variable as not ClosedTypeId, regardless of what the
<a name="line-1167"></a>free vars of its type actually are.
<a name="line-1168"></a>
<a name="line-1169"></a>But if it has a signature, all is well:
<a name="line-1170"></a>   \x. ...(let { y::Int; y = x+1 } in
<a name="line-1171"></a>           let { v = y+2 } in ...)...
<a name="line-1172"></a>Here the signature on 'v' makes 'y' a ClosedTypeId, so we can
<a name="line-1173"></a>generalise 'v'.
<a name="line-1174"></a>
<a name="line-1175"></a>Note that:
<a name="line-1176"></a>
<a name="line-1177"></a>  * A top-level binding may not have ClosedTypeId=True, if it suffers
<a name="line-1178"></a>    from the MR
<a name="line-1179"></a>
<a name="line-1180"></a>  * A nested binding may be closed (eg 'g' in the example we started
<a name="line-1181"></a>    with). Indeed, that's the point; whether a function is defined at
<a name="line-1182"></a>    top level or nested is orthogonal to the question of whether or
<a name="line-1183"></a>    not it is closed.
<a name="line-1184"></a>
<a name="line-1185"></a>  * A binding may be non-closed because it mentions a lexically scoped
<a name="line-1186"></a>    *type variable*  Eg
<a name="line-1187"></a>        f :: forall a. blah
<a name="line-1188"></a>        f x = let g y = ...(y::a)...
<a name="line-1189"></a>
<a name="line-1190"></a>Under OutsideIn we are free to generalise an Id all of whose free
<a name="line-1191"></a>variables have ClosedTypeId=True (or imported).  This is an extension
<a name="line-1192"></a>compared to the JFP paper on OutsideIn, which used "top-level" as a
<a name="line-1193"></a>proxy for "closed".  (It's not a good proxy anyway -- the MR can make
<a name="line-1194"></a>a top-level binding with a free type variable.)
<a name="line-1195"></a>-}</span>
<a name="line-1196"></a>
<a name="line-1197"></a><a name="instance%20Outputable%20IdBindingInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>IdBindingInfo</span> <span class='hs-keyword'>where</span>
<a name="line-1198"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NotLetBound</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NotLetBound"</span>
<a name="line-1199"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ClosedLet</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TopLevelLet"</span>
<a name="line-1200"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonClosedLet</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>closed_type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1201"></a>    <span class='hs-varid'>text</span> <span class='hs-str'>"TopLevelLet"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>closed_type</span>
<a name="line-1202"></a>
<a name="line-1203"></a><a name="instance%20Outputable%20PromotionErr"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyword'>where</span>
<a name="line-1204"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ClassPE</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ClassPE"</span>
<a name="line-1205"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TyConPE</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TyConPE"</span>
<a name="line-1206"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>PatSynPE</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"PatSynPE"</span>
<a name="line-1207"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>FamDataConPE</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"FamDataConPE"</span>
<a name="line-1208"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RecDataConPE</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"RecDataConPE"</span>
<a name="line-1209"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoDataKindsTC</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NoDataKindsTC"</span>
<a name="line-1210"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoDataKindsDC</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NoDataKindsDC"</span>
<a name="line-1211"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoTypeInTypeTC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NoTypeInTypeTC"</span>
<a name="line-1212"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoTypeInTypeDC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NoTypeInTypeDC"</span>
<a name="line-1213"></a>
<a name="line-1214"></a><a name="pprTcTyThingCategory"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1215"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyThingCategory</span> <span class='hs-varid'>thing</span>
<a name="line-1216"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type variable"</span>
<a name="line-1217"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Local identifier"</span>
<a name="line-1218"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcTyCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Local tycon"</span>
<a name="line-1219"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>pe</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPECategory</span> <span class='hs-varid'>pe</span>
<a name="line-1220"></a>
<a name="line-1221"></a><a name="pprPECategory"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1222"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>ClassPE</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Class"</span>
<a name="line-1223"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>TyConPE</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type constructor"</span>
<a name="line-1224"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>PatSynPE</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Pattern synonym"</span>
<a name="line-1225"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>FamDataConPE</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Data constructor"</span>
<a name="line-1226"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>RecDataConPE</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Data constructor"</span>
<a name="line-1227"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>NoDataKindsTC</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type constructor"</span>
<a name="line-1228"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>NoDataKindsDC</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Data constructor"</span>
<a name="line-1229"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>NoTypeInTypeTC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type constructor"</span>
<a name="line-1230"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>NoTypeInTypeDC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Data constructor"</span>
<a name="line-1231"></a>
<a name="line-1232"></a><span class='hs-comment'>{-
<a name="line-1233"></a>************************************************************************
<a name="line-1234"></a>*                                                                      *
<a name="line-1235"></a>        Operations over ImportAvails
<a name="line-1236"></a>*                                                                      *
<a name="line-1237"></a>************************************************************************
<a name="line-1238"></a>-}</span>
<a name="line-1239"></a>
<a name="line-1240"></a><a name="ImportAvails"></a><span class='hs-comment'>-- | 'ImportAvails' summarises what was imported from where, irrespective of</span>
<a name="line-1241"></a><a name="ImportAvails"></a><span class='hs-comment'>-- whether the imported things are actually used or not.  It is used:</span>
<a name="line-1242"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1243"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when processing the export list,</span>
<a name="line-1244"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1245"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when constructing usage info for the interface file,</span>
<a name="line-1246"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1247"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * to identify the list of directly imported modules for initialisation</span>
<a name="line-1248"></a><a name="ImportAvails"></a><span class='hs-comment'>--    purposes and for optimised overlap checking of family instances,</span>
<a name="line-1249"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1250"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when figuring out what things are really unused</span>
<a name="line-1251"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-1252"></a><a name="ImportAvails"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-1253"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span>
<a name="line-1254"></a>        <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportedMods</span><span class='hs-layout'>,</span>
<a name="line-1255"></a>          <span class='hs-comment'>--      = ModuleEnv [ImportedModsVal],</span>
<a name="line-1256"></a>          <span class='hs-comment'>-- ^ Domain is all directly-imported modules</span>
<a name="line-1257"></a>          <span class='hs-comment'>--</span>
<a name="line-1258"></a>          <span class='hs-comment'>-- See the documentation on ImportedModsVal in HscTypes for the</span>
<a name="line-1259"></a>          <span class='hs-comment'>-- meaning of the fields.</span>
<a name="line-1260"></a>          <span class='hs-comment'>--</span>
<a name="line-1261"></a>          <span class='hs-comment'>-- We need a full ModuleEnv rather than a ModuleNameEnv here,</span>
<a name="line-1262"></a>          <span class='hs-comment'>-- because we might be importing modules of the same name from</span>
<a name="line-1263"></a>          <span class='hs-comment'>-- different packages. (currently not the case, but might be in the</span>
<a name="line-1264"></a>          <span class='hs-comment'>-- future).</span>
<a name="line-1265"></a>
<a name="line-1266"></a>        <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1267"></a>          <span class='hs-comment'>-- ^ Home-package modules needed by the module being compiled</span>
<a name="line-1268"></a>          <span class='hs-comment'>--</span>
<a name="line-1269"></a>          <span class='hs-comment'>-- It doesn't matter whether any of these dependencies</span>
<a name="line-1270"></a>          <span class='hs-comment'>-- are actually /used/ when compiling the module; they</span>
<a name="line-1271"></a>          <span class='hs-comment'>-- are listed if they are below it at all.  For</span>
<a name="line-1272"></a>          <span class='hs-comment'>-- example, suppose M imports A which imports X.  Then</span>
<a name="line-1273"></a>          <span class='hs-comment'>-- compiling M might not need to consult X.hi, but X</span>
<a name="line-1274"></a>          <span class='hs-comment'>-- is still listed in M's dependencies.</span>
<a name="line-1275"></a>
<a name="line-1276"></a>        <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>InstalledUnitId</span><span class='hs-layout'>,</span>
<a name="line-1277"></a>          <span class='hs-comment'>-- ^ Packages needed by the module being compiled, whether directly,</span>
<a name="line-1278"></a>          <span class='hs-comment'>-- or via other modules in this package, or via modules imported</span>
<a name="line-1279"></a>          <span class='hs-comment'>-- from other packages.</span>
<a name="line-1280"></a>
<a name="line-1281"></a>        <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>InstalledUnitId</span><span class='hs-layout'>,</span>
<a name="line-1282"></a>          <span class='hs-comment'>-- ^ This is strictly a subset of imp_dep_pkgs and records the</span>
<a name="line-1283"></a>          <span class='hs-comment'>-- packages the current module needs to trust for Safe Haskell</span>
<a name="line-1284"></a>          <span class='hs-comment'>-- compilation to succeed. A package is required to be trusted if</span>
<a name="line-1285"></a>          <span class='hs-comment'>-- we are dependent on a trustworthy module in that package.</span>
<a name="line-1286"></a>          <span class='hs-comment'>-- While perhaps making imp_dep_pkgs a tuple of (UnitId, Bool)</span>
<a name="line-1287"></a>          <span class='hs-comment'>-- where True for the bool indicates the package is required to be</span>
<a name="line-1288"></a>          <span class='hs-comment'>-- trusted is the more logical  design, doing so complicates a lot</span>
<a name="line-1289"></a>          <span class='hs-comment'>-- of code not concerned with Safe Haskell.</span>
<a name="line-1290"></a>          <span class='hs-comment'>-- See Note [RnNames . Tracking Trust Transitively]</span>
<a name="line-1291"></a>
<a name="line-1292"></a>        <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-1293"></a>          <span class='hs-comment'>-- ^ Do we require that our own package is trusted?</span>
<a name="line-1294"></a>          <span class='hs-comment'>-- This is to handle efficiently the case where a Safe module imports</span>
<a name="line-1295"></a>          <span class='hs-comment'>-- a Trustworthy module that resides in the same package as it.</span>
<a name="line-1296"></a>          <span class='hs-comment'>-- See Note [RnNames . Trust Own Package]</span>
<a name="line-1297"></a>
<a name="line-1298"></a>        <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-1299"></a>          <span class='hs-comment'>-- ^ Orphan modules below us in the import tree (and maybe including</span>
<a name="line-1300"></a>          <span class='hs-comment'>-- us for imported modules)</span>
<a name="line-1301"></a>
<a name="line-1302"></a>        <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span>
<a name="line-1303"></a>          <span class='hs-comment'>-- ^ Family instance modules below us in the import tree (and maybe</span>
<a name="line-1304"></a>          <span class='hs-comment'>-- including us for imported modules)</span>
<a name="line-1305"></a>      <span class='hs-layout'>}</span>
<a name="line-1306"></a>
<a name="line-1307"></a><a name="mkModDeps"></a><span class='hs-definition'>mkModDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1308"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span>
<a name="line-1309"></a><span class='hs-definition'>mkModDeps</span> <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyUFM</span> <span class='hs-varid'>deps</span>
<a name="line-1310"></a>               <span class='hs-keyword'>where</span>
<a name="line-1311"></a>                 <span class='hs-varid'>add</span> <span class='hs-varid'>env</span> <span class='hs-varid'>elt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM</span> <span class='hs-varid'>env</span> <span class='hs-varid'>m</span> <span class='hs-varid'>elt</span>
<a name="line-1312"></a>
<a name="line-1313"></a><a name="modDepsElts"></a><span class='hs-definition'>modDepsElts</span>
<a name="line-1314"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span>
<a name="line-1315"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1316"></a><span class='hs-definition'>modDepsElts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sort</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nonDetEltsUFM</span>
<a name="line-1317"></a>  <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here because sorting by module names</span>
<a name="line-1318"></a>  <span class='hs-comment'>-- restores determinism</span>
<a name="line-1319"></a>
<a name="line-1320"></a><a name="emptyImportAvails"></a><span class='hs-definition'>emptyImportAvails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-1321"></a><span class='hs-definition'>emptyImportAvails</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModuleEnv</span><span class='hs-layout'>,</span>
<a name="line-1322"></a>                                   <span class='hs-varid'>imp_dep_mods</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span>
<a name="line-1323"></a>                                   <span class='hs-varid'>imp_dep_pkgs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>,</span>
<a name="line-1324"></a>                                   <span class='hs-varid'>imp_trust_pkgs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>,</span>
<a name="line-1325"></a>                                   <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-1326"></a>                                   <span class='hs-varid'>imp_orphs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-1327"></a>                                   <span class='hs-varid'>imp_finsts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-1328"></a>
<a name="line-1329"></a><a name="plusImportAvails"></a><span class='hs-comment'>-- | Union two ImportAvails</span>
<a name="line-1330"></a><span class='hs-comment'>--</span>
<a name="line-1331"></a><span class='hs-comment'>-- This function is a key part of Import handling, basically</span>
<a name="line-1332"></a><span class='hs-comment'>-- for each import we create a separate ImportAvails structure</span>
<a name="line-1333"></a><span class='hs-comment'>-- and then union them all together with this function.</span>
<a name="line-1334"></a><span class='hs-definition'>plusImportAvails</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>ImportAvails</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>ImportAvails</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>ImportAvails</span>
<a name="line-1335"></a><span class='hs-definition'>plusImportAvails</span>
<a name="line-1336"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods1</span><span class='hs-layout'>,</span>
<a name="line-1337"></a>                  <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmods1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs1</span><span class='hs-layout'>,</span>
<a name="line-1338"></a>                  <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself1</span><span class='hs-layout'>,</span>
<a name="line-1339"></a>                  <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1340"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods2</span><span class='hs-layout'>,</span>
<a name="line-1341"></a>                  <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmods2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs2</span><span class='hs-layout'>,</span>
<a name="line-1342"></a>                  <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself2</span><span class='hs-layout'>,</span>
<a name="line-1343"></a>                  <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1344"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusModuleEnv_C</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>mods1</span> <span class='hs-varid'>mods2</span><span class='hs-layout'>,</span>
<a name="line-1345"></a>                   <span class='hs-varid'>imp_dep_mods</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusUFM_C</span> <span class='hs-varid'>plus_mod_dep</span> <span class='hs-varid'>dmods1</span> <span class='hs-varid'>dmods2</span><span class='hs-layout'>,</span>
<a name="line-1346"></a>                   <span class='hs-varid'>imp_dep_pkgs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs1</span> <span class='hs-varop'>`</span><span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>union</span><span class='hs-varop'>`</span> <span class='hs-varid'>dpkgs2</span><span class='hs-layout'>,</span>
<a name="line-1347"></a>                   <span class='hs-varid'>imp_trust_pkgs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs1</span> <span class='hs-varop'>`</span><span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>union</span><span class='hs-varop'>`</span> <span class='hs-varid'>tpkgs2</span><span class='hs-layout'>,</span>
<a name="line-1348"></a>                   <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tself2</span><span class='hs-layout'>,</span>
<a name="line-1349"></a>                   <span class='hs-varid'>imp_orphs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>orphs2</span><span class='hs-layout'>,</span>
<a name="line-1350"></a>                   <span class='hs-varid'>imp_finsts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>finsts2</span> <span class='hs-layout'>}</span>
<a name="line-1351"></a>  <span class='hs-keyword'>where</span>
<a name="line-1352"></a>    <span class='hs-varid'>plus_mod_dep</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>)</span>
<a name="line-1353"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>boot1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1354"></a>                <span class='hs-comment'>-- Check mod-names match</span>
<a name="line-1355"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- If either side can "see" a non-hi-boot interface, use that</span>
<a name="line-1356"></a>
<a name="line-1357"></a><span class='hs-comment'>{-
<a name="line-1358"></a>************************************************************************
<a name="line-1359"></a>*                                                                      *
<a name="line-1360"></a>\subsection{Where from}
<a name="line-1361"></a>*                                                                      *
<a name="line-1362"></a>************************************************************************
<a name="line-1363"></a>
<a name="line-1364"></a>The @WhereFrom@ type controls where the renamer looks for an interface file
<a name="line-1365"></a>-}</span>
<a name="line-1366"></a>
<a name="line-1367"></a><a name="WhereFrom"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WhereFrom</span>
<a name="line-1368"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportByUser</span> <span class='hs-conid'>IsBootInterface</span>        <span class='hs-comment'>-- Ordinary user import (perhaps {-# SOURCE #-})</span>
<a name="line-1369"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImportBySystem</span>                      <span class='hs-comment'>-- Non user import.</span>
<a name="line-1370"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImportByPlugin</span>                      <span class='hs-comment'>-- Importing a plugin;</span>
<a name="line-1371"></a>                                        <span class='hs-comment'>-- See Note [Care with plugin imports] in LoadIface</span>
<a name="line-1372"></a>
<a name="line-1373"></a><a name="instance%20Outputable%20WhereFrom"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WhereFrom</span> <span class='hs-keyword'>where</span>
<a name="line-1374"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportByUser</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_boot</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"{- SOURCE -}"</span>
<a name="line-1375"></a>                             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-1376"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ImportBySystem</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"{- SYSTEM -}"</span>
<a name="line-1377"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ImportByPlugin</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"{- PLUGIN -}"</span>
<a name="line-1378"></a>
<a name="line-1379"></a>
<a name="line-1380"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1381"></a>*                                                                      *
<a name="line-1382"></a>                Type signatures
<a name="line-1383"></a>*                                                                      *
<a name="line-1384"></a>********************************************************************* -}</span>
<a name="line-1385"></a>
<a name="line-1386"></a><span class='hs-comment'>-- These data types need to be here only because</span>
<a name="line-1387"></a><span class='hs-comment'>-- TcSimplify uses them, and TcSimplify is fairly</span>
<a name="line-1388"></a><span class='hs-comment'>-- low down in the module hierarchy</span>
<a name="line-1389"></a>
<a name="line-1390"></a><a name="TcSigFun"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcSigFun</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcSigInfo</span>
<a name="line-1391"></a>
<a name="line-1392"></a><a name="TcSigInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcIdSig</span>     <span class='hs-conid'>TcIdSigInfo</span>
<a name="line-1393"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPatSynSig</span> <span class='hs-conid'>TcPatSynInfo</span>
<a name="line-1394"></a>
<a name="line-1395"></a><a name="TcIdSigInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcIdSigInfo</span>   <span class='hs-comment'>-- See Note [Complete and partial type signatures]</span>
<a name="line-1396"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CompleteSig</span>    <span class='hs-comment'>-- A complete signature with no wildcards,</span>
<a name="line-1397"></a>                   <span class='hs-comment'>-- so the complete polymorphic type is known.</span>
<a name="line-1398"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span>          <span class='hs-comment'>-- The polymorphic Id with that type</span>
<a name="line-1399"></a>
<a name="line-1400"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>  <span class='hs-comment'>-- In the case of type-class default methods,</span>
<a name="line-1401"></a>                                  <span class='hs-comment'>-- the Name in the FunSigCtxt is not the same</span>
<a name="line-1402"></a>                                  <span class='hs-comment'>-- as the TcId; the former is 'op', while the</span>
<a name="line-1403"></a>                                  <span class='hs-comment'>-- latter is '$dmop' or some such</span>
<a name="line-1404"></a>
<a name="line-1405"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>       <span class='hs-comment'>-- Location of the type signature</span>
<a name="line-1406"></a>      <span class='hs-layout'>}</span>
<a name="line-1407"></a>
<a name="line-1408"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PartialSig</span>     <span class='hs-comment'>-- A partial type signature (i.e. includes one or more</span>
<a name="line-1409"></a>                   <span class='hs-comment'>-- wildcards). In this case it doesn't make sense to give</span>
<a name="line-1410"></a>                   <span class='hs-comment'>-- the polymorphic Id, because we are going to /infer/ its</span>
<a name="line-1411"></a>                   <span class='hs-comment'>-- type, so we can't make the polymorphic Id ab-initio</span>
<a name="line-1412"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>psig_name</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>               <span class='hs-comment'>-- Name of the function; used when report wildcards</span>
<a name="line-1413"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>psig_hs_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>Name</span>  <span class='hs-comment'>-- The original partial signature in HsSyn form</span>
<a name="line-1414"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-1415"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>            <span class='hs-comment'>-- Location of the type signature</span>
<a name="line-1416"></a>      <span class='hs-layout'>}</span>
<a name="line-1417"></a>
<a name="line-1418"></a>
<a name="line-1419"></a><span class='hs-comment'>{- Note [Complete and partial type signatures]
<a name="line-1420"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1421"></a>A type signature is partial when it contains one or more wildcards
<a name="line-1422"></a>(= type holes).  The wildcard can either be:
<a name="line-1423"></a>* A (type) wildcard occurring in sig_theta or sig_tau. These are
<a name="line-1424"></a>  stored in sig_wcs.
<a name="line-1425"></a>      f :: Bool -&gt; _
<a name="line-1426"></a>      g :: Eq _a =&gt; _a -&gt; _a -&gt; Bool
<a name="line-1427"></a>* Or an extra-constraints wildcard, stored in sig_cts:
<a name="line-1428"></a>      h :: (Num a, _) =&gt; a -&gt; a
<a name="line-1429"></a>
<a name="line-1430"></a>A type signature is a complete type signature when there are no
<a name="line-1431"></a>wildcards in the type signature, i.e. iff sig_wcs is empty and
<a name="line-1432"></a>sig_extra_cts is Nothing.
<a name="line-1433"></a>-}</span>
<a name="line-1434"></a>
<a name="line-1435"></a><a name="TcIdSigInst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcIdSigInst</span>
<a name="line-1436"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdSigInfo</span>
<a name="line-1437"></a>
<a name="line-1438"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_skols</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1439"></a>               <span class='hs-comment'>-- Instantiated type and kind variables, SigTvs</span>
<a name="line-1440"></a>               <span class='hs-comment'>-- The Name is the Name that the renamer chose;</span>
<a name="line-1441"></a>               <span class='hs-comment'>--   but the TcTyVar may come from instantiating</span>
<a name="line-1442"></a>               <span class='hs-comment'>--   the type and hence have a different unique.</span>
<a name="line-1443"></a>               <span class='hs-comment'>-- No need to keep track of whether they are truly lexically</span>
<a name="line-1444"></a>               <span class='hs-comment'>--   scoped because the renamer has named them uniquely</span>
<a name="line-1445"></a>               <span class='hs-comment'>-- See Note [Binding scoped type variables] in TcSigs</span>
<a name="line-1446"></a>
<a name="line-1447"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_theta</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span>
<a name="line-1448"></a>               <span class='hs-comment'>-- Instantiated theta.  In the case of a</span>
<a name="line-1449"></a>               <span class='hs-comment'>-- PartialSig, sig_theta does not include</span>
<a name="line-1450"></a>               <span class='hs-comment'>-- the extra-constraints wildcard</span>
<a name="line-1451"></a>
<a name="line-1452"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_tau</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigmaType</span>   <span class='hs-comment'>-- Instantiated tau</span>
<a name="line-1453"></a>               <span class='hs-comment'>-- See Note [sig_inst_tau may be polymorphic]</span>
<a name="line-1454"></a>
<a name="line-1455"></a>         <span class='hs-comment'>-- Relevant for partial signature only</span>
<a name="line-1456"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1457"></a>               <span class='hs-comment'>-- Like sig_inst_skols, but for wildcards.  The named</span>
<a name="line-1458"></a>               <span class='hs-comment'>-- wildcards scope over the binding, and hence their</span>
<a name="line-1459"></a>               <span class='hs-comment'>-- Names may appear in type signatures in the binding</span>
<a name="line-1460"></a>
<a name="line-1461"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcx</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-1462"></a>               <span class='hs-comment'>-- Extra-constraints wildcard to fill in, if any</span>
<a name="line-1463"></a>         <span class='hs-layout'>}</span>
<a name="line-1464"></a>
<a name="line-1465"></a><span class='hs-comment'>{- Note [sig_inst_tau may be polymorphic]
<a name="line-1466"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1467"></a>Note that "sig_inst_tau" might actually be a polymorphic type,
<a name="line-1468"></a>if the original function had a signature like
<a name="line-1469"></a>   forall a. Eq a =&gt; forall b. Ord b =&gt; ....
<a name="line-1470"></a>But that's ok: tcMatchesFun (called by tcRhs) can deal with that
<a name="line-1471"></a>It happens, too!  See Note [Polymorphic methods] in TcClassDcl.
<a name="line-1472"></a>
<a name="line-1473"></a>Note [Wildcards in partial signatures]
<a name="line-1474"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1475"></a>The wildcards in psig_wcs may stand for a type mentioning
<a name="line-1476"></a>the universally-quantified tyvars of psig_ty
<a name="line-1477"></a>
<a name="line-1478"></a>E.g.  f :: forall a. _ -&gt; a
<a name="line-1479"></a>      f x = x
<a name="line-1480"></a>We get sig_inst_skols = [a]
<a name="line-1481"></a>       sig_inst_tau   = _22 -&gt; a
<a name="line-1482"></a>       sig_inst_wcs   = [_22]
<a name="line-1483"></a>and _22 in the end is unified with the type 'a'
<a name="line-1484"></a>
<a name="line-1485"></a>Moreover the kind of a wildcard in sig_inst_wcs may mention
<a name="line-1486"></a>the universally-quantified tyvars sig_inst_skols
<a name="line-1487"></a>e.g.   f :: t a -&gt; t _
<a name="line-1488"></a>Here we get
<a name="line-1489"></a>   sig_inst_skols = [k:*, (t::k -&gt;*), (a::k)]
<a name="line-1490"></a>   sig_inst_tau   = t a -&gt; t _22
<a name="line-1491"></a>   sig_inst_wcs   = [ _22::k ]
<a name="line-1492"></a>-}</span>
<a name="line-1493"></a>
<a name="line-1494"></a><a name="TcPatSynInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcPatSynInfo</span>
<a name="line-1495"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TPSI</span> <span class='hs-layout'>{</span>
<a name="line-1496"></a>        <span class='hs-varid'>patsig_name</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>
<a name="line-1497"></a>        <span class='hs-varid'>patsig_implicit_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVarBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Implicitly-bound kind vars (Inferred) and</span>
<a name="line-1498"></a>                                                <span class='hs-comment'>-- implicitly-bound type vars (Specified)</span>
<a name="line-1499"></a>          <span class='hs-comment'>-- See Note [The pattern-synonym signature splitting rule] in TcPatSyn</span>
<a name="line-1500"></a>        <span class='hs-varid'>patsig_univ_bndrs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Bound by explicit user forall</span>
<a name="line-1501"></a>        <span class='hs-varid'>patsig_req</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span>
<a name="line-1502"></a>        <span class='hs-varid'>patsig_ex_bndrs</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Bound by explicit user forall</span>
<a name="line-1503"></a>        <span class='hs-varid'>patsig_prov</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span>
<a name="line-1504"></a>        <span class='hs-varid'>patsig_body_ty</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-1505"></a>    <span class='hs-layout'>}</span>
<a name="line-1506"></a>
<a name="line-1507"></a><a name="instance%20Outputable%20TcSigInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-keyword'>where</span>
<a name="line-1508"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdSig</span>     <span class='hs-varid'>idsi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>idsi</span>
<a name="line-1509"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPatSynSig</span> <span class='hs-varid'>tpsi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TcPatSynInfo"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tpsi</span>
<a name="line-1510"></a>
<a name="line-1511"></a><a name="instance%20Outputable%20TcIdSigInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcIdSigInfo</span> <span class='hs-keyword'>where</span>
<a name="line-1512"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1513"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-1514"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>psig_hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1515"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"psig"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span>
<a name="line-1516"></a>
<a name="line-1517"></a><a name="instance%20Outputable%20TcIdSigInst"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcIdSigInst</span> <span class='hs-keyword'>where</span>
<a name="line-1518"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span>
<a name="line-1519"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1520"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skols</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>theta</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>darrow</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1521"></a>
<a name="line-1522"></a><a name="instance%20Outputable%20TcPatSynInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcPatSynInfo</span> <span class='hs-keyword'>where</span>
<a name="line-1523"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TPSI</span><span class='hs-layout'>{</span> <span class='hs-varid'>patsig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span>
<a name="line-1524"></a>
<a name="line-1525"></a><a name="isPartialSig"></a><span class='hs-definition'>isPartialSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdSigInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1526"></a><span class='hs-definition'>isPartialSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1527"></a><span class='hs-definition'>isPartialSig</span> <span class='hs-keyword'>_</span>                                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1528"></a>
<a name="line-1529"></a><a name="hasCompleteSig"></a><span class='hs-comment'>-- | No signature or a partial signature</span>
<a name="line-1530"></a><span class='hs-definition'>hasCompleteSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1531"></a><span class='hs-definition'>hasCompleteSig</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>name</span>
<a name="line-1532"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-1533"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1534"></a>      <span class='hs-keyword'>_</span>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1535"></a>
<a name="line-1536"></a>
<a name="line-1537"></a><span class='hs-comment'>{-
<a name="line-1538"></a>************************************************************************
<a name="line-1539"></a>*                                                                      *
<a name="line-1540"></a>*                       Canonical constraints                          *
<a name="line-1541"></a>*                                                                      *
<a name="line-1542"></a>*   These are the constraints the low-level simplifier works with      *
<a name="line-1543"></a>*                                                                      *
<a name="line-1544"></a>************************************************************************
<a name="line-1545"></a>-}</span>
<a name="line-1546"></a>
<a name="line-1547"></a><span class='hs-comment'>-- The syntax of xi () types:</span>
<a name="line-1548"></a><span class='hs-comment'>-- xi ::= a | T xis | xis -&gt; xis | ... | forall a. tau</span>
<a name="line-1549"></a><span class='hs-comment'>-- Two important notes:</span>
<a name="line-1550"></a><span class='hs-comment'>--      (i) No type families, unless we are under a ForAll</span>
<a name="line-1551"></a><span class='hs-comment'>--      (ii) Note that xi types can contain unexpanded type synonyms;</span>
<a name="line-1552"></a><span class='hs-comment'>--           however, the (transitive) expansions of those type synonyms</span>
<a name="line-1553"></a><span class='hs-comment'>--           will not contain any type functions, unless we are under a ForAll.</span>
<a name="line-1554"></a><span class='hs-comment'>-- We enforce the structure of Xi types when we flatten (TcCanonical)</span>
<a name="line-1555"></a>
<a name="line-1556"></a><a name="Xi"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Xi</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>       <span class='hs-comment'>-- In many comments, "xi" ranges over Xi</span>
<a name="line-1557"></a>
<a name="line-1558"></a><a name="Cts"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span>
<a name="line-1559"></a>
<a name="line-1560"></a><a name="Ct"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Ct</span>
<a name="line-1561"></a>  <span class='hs-comment'>-- Atomic canonical constraints</span>
<a name="line-1562"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- e.g.  Num xi</span>
<a name="line-1563"></a>      <span class='hs-varid'>cc_ev</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1564"></a>
<a name="line-1565"></a>      <span class='hs-varid'>cc_class</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span>
<a name="line-1566"></a>      <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- cc_tyargs are function-free, hence Xi</span>
<a name="line-1567"></a>
<a name="line-1568"></a>      <span class='hs-varid'>cc_pend_sc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>   <span class='hs-comment'>-- See Note [The superclass story] in TcCanonical</span>
<a name="line-1569"></a>                           <span class='hs-comment'>-- True &lt;=&gt; (a) cc_class has superclasses</span>
<a name="line-1570"></a>                           <span class='hs-comment'>--          (b) we have not (yet) added those</span>
<a name="line-1571"></a>                           <span class='hs-comment'>--              superclasses as Givens</span>
<a name="line-1572"></a>    <span class='hs-layout'>}</span>
<a name="line-1573"></a>
<a name="line-1574"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- These stand for yet-unusable predicates</span>
<a name="line-1575"></a>      <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span>   <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1576"></a>        <span class='hs-comment'>-- The ctev_pred of the evidence is</span>
<a name="line-1577"></a>        <span class='hs-comment'>-- of form   (tv xi1 xi2 ... xin)</span>
<a name="line-1578"></a>        <span class='hs-comment'>--      or   (tv1 ~ ty2)   where the CTyEqCan  kind invariant fails</span>
<a name="line-1579"></a>        <span class='hs-comment'>--      or   (F tys ~ ty)  where the CFunEqCan kind invariant fails</span>
<a name="line-1580"></a>        <span class='hs-comment'>-- See Note [CIrredEvCan constraints]</span>
<a name="line-1581"></a>    <span class='hs-layout'>}</span>
<a name="line-1582"></a>
<a name="line-1583"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- tv ~ rhs</span>
<a name="line-1584"></a>       <span class='hs-comment'>-- Invariants:</span>
<a name="line-1585"></a>       <span class='hs-comment'>--   * See Note [Applying the inert substitution] in TcFlatten</span>
<a name="line-1586"></a>       <span class='hs-comment'>--   * tv not in tvs(rhs)   (occurs check)</span>
<a name="line-1587"></a>       <span class='hs-comment'>--   * If tv is a TauTv, then rhs has no foralls</span>
<a name="line-1588"></a>       <span class='hs-comment'>--       (this avoids substituting a forall for the tyvar in other types)</span>
<a name="line-1589"></a>       <span class='hs-comment'>--   * typeKind ty `tcEqKind` typeKind tv</span>
<a name="line-1590"></a>       <span class='hs-comment'>--   * rhs may have at most one top-level cast</span>
<a name="line-1591"></a>       <span class='hs-comment'>--   * rhs (perhaps under the one cast) is not necessarily function-free,</span>
<a name="line-1592"></a>       <span class='hs-comment'>--       but it has no top-level function.</span>
<a name="line-1593"></a>       <span class='hs-comment'>--     E.g. a ~ [F b]  is fine</span>
<a name="line-1594"></a>       <span class='hs-comment'>--     but  a ~ F b    is not</span>
<a name="line-1595"></a>       <span class='hs-comment'>--   * If the equality is representational, rhs has no top-level newtype</span>
<a name="line-1596"></a>       <span class='hs-comment'>--     See Note [No top-level newtypes on RHS of representational</span>
<a name="line-1597"></a>       <span class='hs-comment'>--     equalities] in TcCanonical</span>
<a name="line-1598"></a>       <span class='hs-comment'>--   * If rhs (perhaps under the cast) is also a tv, then it is oriented</span>
<a name="line-1599"></a>       <span class='hs-comment'>--     to give best chance of</span>
<a name="line-1600"></a>       <span class='hs-comment'>--     unification happening; eg if rhs is touchable then lhs is too</span>
<a name="line-1601"></a>      <span class='hs-varid'>cc_ev</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1602"></a>      <span class='hs-varid'>cc_tyvar</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span>
<a name="line-1603"></a>      <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Not necessarily function-free (hence not Xi)</span>
<a name="line-1604"></a>                               <span class='hs-comment'>-- See invariants above</span>
<a name="line-1605"></a>
<a name="line-1606"></a>      <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span>       <span class='hs-comment'>-- INVARIANT: cc_eq_rel = ctEvEqRel cc_ev</span>
<a name="line-1607"></a>    <span class='hs-layout'>}</span>
<a name="line-1608"></a>
<a name="line-1609"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- F xis ~ fsk</span>
<a name="line-1610"></a>       <span class='hs-comment'>-- Invariants:</span>
<a name="line-1611"></a>       <span class='hs-comment'>--   * isTypeFamilyTyCon cc_fun</span>
<a name="line-1612"></a>       <span class='hs-comment'>--   * typeKind (F xis) = tyVarKind fsk</span>
<a name="line-1613"></a>       <span class='hs-comment'>--   * always Nominal role</span>
<a name="line-1614"></a>      <span class='hs-varid'>cc_ev</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1615"></a>      <span class='hs-varid'>cc_fun</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- A type function</span>
<a name="line-1616"></a>
<a name="line-1617"></a>      <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- cc_tyargs are function-free (hence Xi)</span>
<a name="line-1618"></a>        <span class='hs-comment'>-- Either under-saturated or exactly saturated</span>
<a name="line-1619"></a>        <span class='hs-comment'>--    *never* over-saturated (because if so</span>
<a name="line-1620"></a>        <span class='hs-comment'>--    we should have decomposed)</span>
<a name="line-1621"></a>
<a name="line-1622"></a>      <span class='hs-varid'>cc_fsk</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span>  <span class='hs-comment'>-- [Given]  always a FlatSkol skolem</span>
<a name="line-1623"></a>                            <span class='hs-comment'>-- [Wanted] always a FlatMetaTv unification variable</span>
<a name="line-1624"></a>        <span class='hs-comment'>-- See Note [The flattening story] in TcFlatten</span>
<a name="line-1625"></a>    <span class='hs-layout'>}</span>
<a name="line-1626"></a>
<a name="line-1627"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span>        <span class='hs-comment'>-- See Note [NonCanonical Semantics] in TcSMonad</span>
<a name="line-1628"></a>      <span class='hs-varid'>cc_ev</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-1629"></a>    <span class='hs-layout'>}</span>
<a name="line-1630"></a>
<a name="line-1631"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span>             <span class='hs-comment'>-- See Note [Hole constraints]</span>
<a name="line-1632"></a>       <span class='hs-comment'>-- Treated as an "insoluble" constraint</span>
<a name="line-1633"></a>       <span class='hs-comment'>-- See Note [Insoluble constraints]</span>
<a name="line-1634"></a>      <span class='hs-varid'>cc_ev</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span>
<a name="line-1635"></a>      <span class='hs-varid'>cc_hole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Hole</span>
<a name="line-1636"></a>    <span class='hs-layout'>}</span>
<a name="line-1637"></a>
<a name="line-1638"></a><a name="Hole"></a><span class='hs-comment'>-- | An expression or type hole</span>
<a name="line-1639"></a><a name="Hole"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Hole</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExprHole</span> <span class='hs-conid'>UnboundVar</span>
<a name="line-1640"></a>            <span class='hs-comment'>-- ^ Either an out-of-scope variable or a "true" hole in an</span>
<a name="line-1641"></a>            <span class='hs-comment'>-- expression (TypedHoles)</span>
<a name="line-1642"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TypeHole</span> <span class='hs-conid'>OccName</span>
<a name="line-1643"></a>            <span class='hs-comment'>-- ^ A hole in a type (PartialTypeSignatures)</span>
<a name="line-1644"></a>
<a name="line-1645"></a><a name="holeOcc"></a><span class='hs-definition'>holeOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Hole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-1646"></a><span class='hs-definition'>holeOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprHole</span> <span class='hs-varid'>uv</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unboundVarOcc</span> <span class='hs-varid'>uv</span>
<a name="line-1647"></a><span class='hs-definition'>holeOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeHole</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span>
<a name="line-1648"></a>
<a name="line-1649"></a><span class='hs-comment'>{- Note [Hole constraints]
<a name="line-1650"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1651"></a>CHoleCan constraints are used for two kinds of holes,
<a name="line-1652"></a>distinguished by cc_hole:
<a name="line-1653"></a>
<a name="line-1654"></a>  * For holes in expressions (including variables not in scope)
<a name="line-1655"></a>    e.g.   f x = g _ x
<a name="line-1656"></a>
<a name="line-1657"></a>  * For holes in type signatures
<a name="line-1658"></a>    e.g.   f :: _ -&gt; _
<a name="line-1659"></a>           f x = [x,True]
<a name="line-1660"></a>
<a name="line-1661"></a>Note [CIrredEvCan constraints]
<a name="line-1662"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1663"></a>CIrredEvCan constraints are used for constraints that are "stuck"
<a name="line-1664"></a>   - we can't solve them (yet)
<a name="line-1665"></a>   - we can't use them to solve other constraints
<a name="line-1666"></a>   - but they may become soluble if we substitute for some
<a name="line-1667"></a>     of the type variables in the constraint
<a name="line-1668"></a>
<a name="line-1669"></a>Example 1:  (c Int), where c :: * -&gt; Constraint.  We can't do anything
<a name="line-1670"></a>            with this yet, but if later c := Num, *then* we can solve it
<a name="line-1671"></a>
<a name="line-1672"></a>Example 2:  a ~ b, where a :: *, b :: k, where k is a kind variable
<a name="line-1673"></a>            We don't want to use this to substitute 'b' for 'a', in case
<a name="line-1674"></a>            'k' is subequently unifed with (say) *-&gt;*, because then
<a name="line-1675"></a>            we'd have ill-kinded types floating about.  Rather we want
<a name="line-1676"></a>            to defer using the equality altogether until 'k' get resolved.
<a name="line-1677"></a>
<a name="line-1678"></a>Note [Ct/evidence invariant]
<a name="line-1679"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1680"></a>If  ct :: Ct, then extra fields of 'ct' cache precisely the ctev_pred field
<a name="line-1681"></a>of (cc_ev ct), and is fully rewritten wrt the substitution.   Eg for CDictCan,
<a name="line-1682"></a>   ctev_pred (cc_ev ct) = (cc_class ct) (cc_tyargs ct)
<a name="line-1683"></a>This holds by construction; look at the unique place where CDictCan is
<a name="line-1684"></a>built (in TcCanonical).
<a name="line-1685"></a>
<a name="line-1686"></a>In contrast, the type of the evidence *term* (ctev_dest / ctev_evar) in
<a name="line-1687"></a>the evidence may *not* be fully zonked; we are careful not to look at it
<a name="line-1688"></a>during constraint solving. See Note [Evidence field of CtEvidence].
<a name="line-1689"></a>-}</span>
<a name="line-1690"></a>
<a name="line-1691"></a><a name="mkNonCanonical"></a><span class='hs-definition'>mkNonCanonical</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-1692"></a><span class='hs-definition'>mkNonCanonical</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span>
<a name="line-1693"></a>
<a name="line-1694"></a><a name="mkNonCanonicalCt"></a><span class='hs-definition'>mkNonCanonicalCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-1695"></a><span class='hs-definition'>mkNonCanonicalCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span>
<a name="line-1696"></a>
<a name="line-1697"></a><a name="mkGivens"></a><span class='hs-definition'>mkGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1698"></a><span class='hs-definition'>mkGivens</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ev_ids</span>
<a name="line-1699"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mk</span> <span class='hs-varid'>ev_ids</span>
<a name="line-1700"></a>  <span class='hs-keyword'>where</span>
<a name="line-1701"></a>    <span class='hs-varid'>mk</span> <span class='hs-varid'>ev_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_id</span>
<a name="line-1702"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>ev_id</span>
<a name="line-1703"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1704"></a>
<a name="line-1705"></a><a name="ctEvidence"></a><span class='hs-definition'>ctEvidence</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-1706"></a><span class='hs-definition'>ctEvidence</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span>
<a name="line-1707"></a>
<a name="line-1708"></a><a name="ctLoc"></a><span class='hs-definition'>ctLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1709"></a><span class='hs-definition'>ctLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvidence</span>
<a name="line-1710"></a>
<a name="line-1711"></a><a name="setCtLoc"></a><span class='hs-definition'>setCtLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-1712"></a><span class='hs-definition'>setCtLoc</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1713"></a>
<a name="line-1714"></a><a name="ctOrigin"></a><span class='hs-definition'>ctOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1715"></a><span class='hs-definition'>ctOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctLoc</span>
<a name="line-1716"></a>
<a name="line-1717"></a><a name="ctPred"></a><span class='hs-definition'>ctPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span>
<a name="line-1718"></a><span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1719"></a><span class='hs-definition'>ctPred</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1720"></a>
<a name="line-1721"></a><a name="mkTcEqPredLikeEv"></a><span class='hs-comment'>-- | Makes a new equality predicate with the same role as the given</span>
<a name="line-1722"></a><span class='hs-comment'>-- evidence.</span>
<a name="line-1723"></a><span class='hs-definition'>mkTcEqPredLikeEv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-1724"></a><span class='hs-definition'>mkTcEqPredLikeEv</span> <span class='hs-varid'>ev</span>
<a name="line-1725"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>predTypeEqRel</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-1726"></a>      <span class='hs-conid'>NomEq</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkPrimEqPred</span>
<a name="line-1727"></a>      <span class='hs-conid'>ReprEq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkReprPrimEqPred</span>
<a name="line-1728"></a>  <span class='hs-keyword'>where</span>
<a name="line-1729"></a>    <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span>
<a name="line-1730"></a>
<a name="line-1731"></a><a name="ctFlavour"></a><span class='hs-comment'>-- | Get the flavour of the given 'Ct'</span>
<a name="line-1732"></a><span class='hs-definition'>ctFlavour</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavour</span>
<a name="line-1733"></a><span class='hs-definition'>ctFlavour</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvFlavour</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvidence</span>
<a name="line-1734"></a>
<a name="line-1735"></a><a name="ctEqRel"></a><span class='hs-comment'>-- | Get the equality relation for the given 'Ct'</span>
<a name="line-1736"></a><span class='hs-definition'>ctEqRel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqRel</span>
<a name="line-1737"></a><span class='hs-definition'>ctEqRel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvEqRel</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvidence</span>
<a name="line-1738"></a>
<a name="line-1739"></a><a name="instance%20Outputable%20Ct"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Ct</span> <span class='hs-keyword'>where</span>
<a name="line-1740"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>pp_sort</span>
<a name="line-1741"></a>    <span class='hs-keyword'>where</span>
<a name="line-1742"></a>      <span class='hs-varid'>pp_sort</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-1743"></a>         <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CTyEqCan"</span>
<a name="line-1744"></a>         <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CFunEqCan"</span>
<a name="line-1745"></a>         <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CNonCanonical"</span>
<a name="line-1746"></a>         <span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_pend_sc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pend_sc</span> <span class='hs-layout'>}</span>
<a name="line-1747"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>pend_sc</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CDictCan(psc)"</span>
<a name="line-1748"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CDictCan"</span>
<a name="line-1749"></a>         <span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CIrredEvCan"</span>
<a name="line-1750"></a>         <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_hole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hole</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CHoleCan:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>holeOcc</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span>
<a name="line-1751"></a>
<a name="line-1752"></a><span class='hs-comment'>{-
<a name="line-1753"></a>************************************************************************
<a name="line-1754"></a>*                                                                      *
<a name="line-1755"></a>        Simple functions over evidence variables
<a name="line-1756"></a>*                                                                      *
<a name="line-1757"></a>************************************************************************
<a name="line-1758"></a>-}</span>
<a name="line-1759"></a>
<a name="line-1760"></a><span class='hs-comment'>---------------- Getting free tyvars -------------------------</span>
<a name="line-1761"></a>
<a name="line-1762"></a><a name="tyCoVarsOfCt"></a><span class='hs-comment'>-- | Returns free variables of constraints as a non-deterministic set</span>
<a name="line-1763"></a><span class='hs-definition'>tyCoVarsOfCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyCoVarSet</span>
<a name="line-1764"></a><span class='hs-definition'>tyCoVarsOfCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoFVsOfCt</span>
<a name="line-1765"></a>
<a name="line-1766"></a><a name="tyCoVarsOfCtList"></a><span class='hs-comment'>-- | Returns free variables of constraints as a deterministically ordered.</span>
<a name="line-1767"></a><span class='hs-comment'>-- list. See Note [Deterministic FV] in FV.</span>
<a name="line-1768"></a><span class='hs-definition'>tyCoVarsOfCtList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1769"></a><span class='hs-definition'>tyCoVarsOfCtList</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoFVsOfCt</span>
<a name="line-1770"></a>
<a name="line-1771"></a><a name="tyCoFVsOfCt"></a><span class='hs-comment'>-- | Returns free variables of constraints as a composable FV computation.</span>
<a name="line-1772"></a><span class='hs-comment'>-- See Note [Deterministic FV] in FV.</span>
<a name="line-1773"></a><span class='hs-definition'>tyCoFVsOfCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1774"></a><span class='hs-definition'>tyCoFVsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1775"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>xi</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-conid'>FV</span><span class='hs-varop'>.</span><span class='hs-varid'>unitFV</span> <span class='hs-varid'>tv</span>
<a name="line-1776"></a>                     <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1777"></a><span class='hs-definition'>tyCoFVsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_fsk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsk</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1778"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-conid'>FV</span><span class='hs-varop'>.</span><span class='hs-varid'>unitFV</span> <span class='hs-varid'>fsk</span>
<a name="line-1779"></a>                       <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span>
<a name="line-1780"></a><span class='hs-definition'>tyCoFVsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1781"></a><span class='hs-definition'>tyCoFVsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1782"></a><span class='hs-definition'>tyCoFVsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1783"></a><span class='hs-definition'>tyCoFVsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1784"></a>
<a name="line-1785"></a><a name="tyCoVarsOfCts"></a><span class='hs-comment'>-- | Returns free variables of a bag of constraints as a non-deterministic</span>
<a name="line-1786"></a><span class='hs-comment'>-- set. See Note [Deterministic FV] in FV.</span>
<a name="line-1787"></a><span class='hs-definition'>tyCoVarsOfCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyCoVarSet</span>
<a name="line-1788"></a><span class='hs-definition'>tyCoVarsOfCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoFVsOfCts</span>
<a name="line-1789"></a>
<a name="line-1790"></a><a name="tyCoVarsOfCtsList"></a><span class='hs-comment'>-- | Returns free variables of a bag of constraints as a deterministically</span>
<a name="line-1791"></a><span class='hs-comment'>-- odered list. See Note [Deterministic FV] in FV.</span>
<a name="line-1792"></a><span class='hs-definition'>tyCoVarsOfCtsList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1793"></a><span class='hs-definition'>tyCoVarsOfCtsList</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoFVsOfCts</span>
<a name="line-1794"></a>
<a name="line-1795"></a><a name="tyCoFVsOfCts"></a><span class='hs-comment'>-- | Returns free variables of a bag of constraints as a composable FV</span>
<a name="line-1796"></a><span class='hs-comment'>-- computation. See Note [Deterministic FV] in FV.</span>
<a name="line-1797"></a><span class='hs-definition'>tyCoFVsOfCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1798"></a><span class='hs-definition'>tyCoFVsOfCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionFV</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoFVsOfCt</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyFV</span>
<a name="line-1799"></a>
<a name="line-1800"></a><a name="tyCoVarsOfWC"></a><span class='hs-comment'>-- | Returns free variables of WantedConstraints as a non-deterministic</span>
<a name="line-1801"></a><span class='hs-comment'>-- set. See Note [Deterministic FV] in FV.</span>
<a name="line-1802"></a><span class='hs-definition'>tyCoVarsOfWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1803"></a><span class='hs-comment'>-- Only called on *zonked* things, hence no need to worry about flatten-skolems</span>
<a name="line-1804"></a><span class='hs-definition'>tyCoVarsOfWC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoFVsOfWC</span>
<a name="line-1805"></a>
<a name="line-1806"></a><a name="tyCoVarsOfWCList"></a><span class='hs-comment'>-- | Returns free variables of WantedConstraints as a deterministically</span>
<a name="line-1807"></a><span class='hs-comment'>-- ordered list. See Note [Deterministic FV] in FV.</span>
<a name="line-1808"></a><span class='hs-definition'>tyCoVarsOfWCList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1809"></a><span class='hs-comment'>-- Only called on *zonked* things, hence no need to worry about flatten-skolems</span>
<a name="line-1810"></a><span class='hs-definition'>tyCoVarsOfWCList</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoFVsOfWC</span>
<a name="line-1811"></a>
<a name="line-1812"></a><a name="tyCoFVsOfWC"></a><span class='hs-comment'>-- | Returns free variables of WantedConstraints as a composable FV</span>
<a name="line-1813"></a><span class='hs-comment'>-- computation. See Note [Deterministic FV] in FV.</span>
<a name="line-1814"></a><span class='hs-definition'>tyCoFVsOfWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1815"></a><span class='hs-comment'>-- Only called on *zonked* things, hence no need to worry about flatten-skolems</span>
<a name="line-1816"></a><span class='hs-definition'>tyCoFVsOfWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simple</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insol</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1817"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCts</span> <span class='hs-varid'>simple</span> <span class='hs-varop'>`unionFV`</span>
<a name="line-1818"></a>    <span class='hs-varid'>tyCoFVsOfBag</span> <span class='hs-varid'>tyCoFVsOfImplic</span> <span class='hs-varid'>implic</span> <span class='hs-varop'>`unionFV`</span>
<a name="line-1819"></a>    <span class='hs-varid'>tyCoFVsOfCts</span> <span class='hs-varid'>insol</span>
<a name="line-1820"></a>
<a name="line-1821"></a><a name="tyCoFVsOfImplic"></a><span class='hs-comment'>-- | Returns free variables of Implication as a composable FV computation.</span>
<a name="line-1822"></a><span class='hs-comment'>-- See Note [Deterministic FV] in FV.</span>
<a name="line-1823"></a><span class='hs-definition'>tyCoFVsOfImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1824"></a><span class='hs-comment'>-- Only called on *zonked* things, hence no need to worry about flatten-skolems</span>
<a name="line-1825"></a><span class='hs-definition'>tyCoFVsOfImplic</span> <span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span>
<a name="line-1826"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>givens</span>
<a name="line-1827"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1828"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FV</span><span class='hs-varop'>.</span><span class='hs-varid'>delFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>skols</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span>
<a name="line-1829"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfWC</span> <span class='hs-varid'>wanted</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1830"></a>
<a name="line-1831"></a><a name="tyCoFVsOfBag"></a><span class='hs-definition'>tyCoFVsOfBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1832"></a><span class='hs-definition'>tyCoFVsOfBag</span> <span class='hs-varid'>tvs_of</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionFV</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tvs_of</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyFV</span>
<a name="line-1833"></a>
<a name="line-1834"></a><a name="dropDerivedSimples"></a><span class='hs-comment'>--------------------------</span>
<a name="line-1835"></a><span class='hs-definition'>dropDerivedSimples</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1836"></a><span class='hs-comment'>-- Drop all Derived constraints, but make [W] back into [WD],</span>
<a name="line-1837"></a><span class='hs-comment'>-- so that if we re-simplify these constraints we will get all</span>
<a name="line-1838"></a><span class='hs-comment'>-- the right derived constraints re-generated.  Forgetting this</span>
<a name="line-1839"></a><span class='hs-comment'>-- step led to #12936</span>
<a name="line-1840"></a><span class='hs-definition'>dropDerivedSimples</span> <span class='hs-varid'>simples</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybeBag</span> <span class='hs-varid'>dropDerivedCt</span> <span class='hs-varid'>simples</span>
<a name="line-1841"></a>
<a name="line-1842"></a><a name="dropDerivedCt"></a><span class='hs-definition'>dropDerivedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span>
<a name="line-1843"></a><span class='hs-definition'>dropDerivedCt</span> <span class='hs-varid'>ct</span>
<a name="line-1844"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span> <span class='hs-keyword'>of</span>
<a name="line-1845"></a>      <span class='hs-conid'>Wanted</span> <span class='hs-conid'>WOnly</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_wd</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1846"></a>      <span class='hs-conid'>Wanted</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ct'</span>
<a name="line-1847"></a>      <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isDerivedCt</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-1848"></a>                      <span class='hs-comment'>-- simples are all Wanted or Derived</span>
<a name="line-1849"></a>  <span class='hs-keyword'>where</span>
<a name="line-1850"></a>    <span class='hs-varid'>ev</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-1851"></a>    <span class='hs-varid'>ev_wd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span> <span class='hs-layout'>}</span>
<a name="line-1852"></a>    <span class='hs-varid'>ct'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setPendingScDict</span> <span class='hs-varid'>ct</span> <span class='hs-comment'>-- See Note [Resetting cc_pend_sc]</span>
<a name="line-1853"></a>
<a name="line-1854"></a><span class='hs-comment'>{- Note [Resetting cc_pend_sc]
<a name="line-1855"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1856"></a>When we discard Derived constraints, in dropDerivedSimples, we must
<a name="line-1857"></a>set the cc_pend_sc flag to True, so that if we re-process this
<a name="line-1858"></a>CDictCan we will re-generate its derived superclasses. Otherwise
<a name="line-1859"></a>we might miss some fundeps.  Trac #13662 showed this up.
<a name="line-1860"></a>
<a name="line-1861"></a>See Note [The superclass story] in TcCanonical.
<a name="line-1862"></a>-}</span>
<a name="line-1863"></a>
<a name="line-1864"></a>
<a name="line-1865"></a><a name="dropDerivedInsols"></a><span class='hs-definition'>dropDerivedInsols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1866"></a><span class='hs-comment'>-- See Note [Dropping derived constraints]</span>
<a name="line-1867"></a><span class='hs-definition'>dropDerivedInsols</span> <span class='hs-varid'>insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>keep</span> <span class='hs-varid'>insols</span>
<a name="line-1868"></a>  <span class='hs-keyword'>where</span>                    <span class='hs-comment'>-- insols can include Given</span>
<a name="line-1869"></a>    <span class='hs-varid'>keep</span> <span class='hs-varid'>ct</span>
<a name="line-1870"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDerivedCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDroppableDerivedLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1871"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1872"></a>
<a name="line-1873"></a><a name="isDroppableDerivedLoc"></a><span class='hs-definition'>isDroppableDerivedLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1874"></a><span class='hs-comment'>-- Note [Dropping derived constraints]</span>
<a name="line-1875"></a><span class='hs-definition'>isDroppableDerivedLoc</span> <span class='hs-varid'>loc</span>
<a name="line-1876"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>of</span>
<a name="line-1877"></a>      <span class='hs-conid'>HoleOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1878"></a>      <span class='hs-conid'>KindEqOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1879"></a>      <span class='hs-conid'>GivenOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1880"></a>      <span class='hs-conid'>FunDepOrigin1</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1881"></a>      <span class='hs-conid'>FunDepOrigin2</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1882"></a>      <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1883"></a>
<a name="line-1884"></a><a name="arisesFromGivens"></a><span class='hs-definition'>arisesFromGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1885"></a><span class='hs-definition'>arisesFromGivens</span> <span class='hs-varid'>ct</span>
<a name="line-1886"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-1887"></a>      <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1888"></a>      <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1889"></a>      <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>from_given</span> <span class='hs-varid'>loc</span>
<a name="line-1890"></a>  <span class='hs-keyword'>where</span>
<a name="line-1891"></a>   <span class='hs-varid'>from_given</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1892"></a>   <span class='hs-varid'>from_given</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>from_given_origin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-1893"></a>
<a name="line-1894"></a>   <span class='hs-varid'>from_given_origin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1895"></a>   <span class='hs-varid'>from_given_origin</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1896"></a>   <span class='hs-varid'>from_given_origin</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunDepOrigin1</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>l1</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>from_given</span> <span class='hs-varid'>l1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>from_given</span> <span class='hs-varid'>l2</span>
<a name="line-1897"></a>   <span class='hs-varid'>from_given_origin</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunDepOrigin2</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>o1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>from_given_origin</span> <span class='hs-varid'>o1</span>
<a name="line-1898"></a>   <span class='hs-varid'>from_given_origin</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1899"></a>
<a name="line-1900"></a><span class='hs-comment'>{- Note [Dropping derived constraints]
<a name="line-1901"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1902"></a>In general we discard derived constraints at the end of constraint solving;
<a name="line-1903"></a>see dropDerivedWC.  For example
<a name="line-1904"></a>
<a name="line-1905"></a> * If we have an unsolved [W] (Ord a), we don't want to complain about
<a name="line-1906"></a>   an unsolved [D] (Eq a) as well.
<a name="line-1907"></a>
<a name="line-1908"></a> * If we have [W] a ~ Int, [W] a ~ Bool, improvement will generate
<a name="line-1909"></a>   [D] Int ~ Bool, and we don't want to report that because it's incomprehensible.
<a name="line-1910"></a>   That is why we don't rewrite wanteds with wanteds!
<a name="line-1911"></a>
<a name="line-1912"></a>But (tiresomely) we do keep *some* Derived insolubles:
<a name="line-1913"></a>
<a name="line-1914"></a> * Insoluble kind equalities (e.g. [D] * ~ (* -&gt; *)) may arise from
<a name="line-1915"></a>   a type equality a ~ Int#, say.  In future they'll be Wanted, not Derived,
<a name="line-1916"></a>   but at the moment they are Derived.
<a name="line-1917"></a>
<a name="line-1918"></a> * Insoluble derived equalities (e.g. [D] Int ~ Bool) may arise from
<a name="line-1919"></a>   functional dependency interactions, either between Givens or
<a name="line-1920"></a>   Wanteds.  It seems sensible to retain these:
<a name="line-1921"></a>   - For Givens they reflect unreachable code
<a name="line-1922"></a>   - For Wanteds it is arguably better to get a fundep error than
<a name="line-1923"></a>     a no-instance error (Trac #9612)
<a name="line-1924"></a>
<a name="line-1925"></a> * Type holes are derived constraints because they have no evidence
<a name="line-1926"></a>   and we want to keep them so we get the error report
<a name="line-1927"></a>
<a name="line-1928"></a>Moreover, we keep *all* derived insolubles under some circumstances:
<a name="line-1929"></a>
<a name="line-1930"></a>  * They are looked at by simplifyInfer, to decide whether to
<a name="line-1931"></a>    generalise.  Example: [W] a ~ Int, [W] a ~ Bool
<a name="line-1932"></a>    We get [D] Int ~ Bool, and indeed the constraints are insoluble,
<a name="line-1933"></a>    and we want simplifyInfer to see that, even though we don't
<a name="line-1934"></a>    ultimately want to generate an (inexplicable) error message from
<a name="line-1935"></a>
<a name="line-1936"></a>To distinguish these cases we use the CtOrigin.
<a name="line-1937"></a>
<a name="line-1938"></a>
<a name="line-1939"></a>************************************************************************
<a name="line-1940"></a>*                                                                      *
<a name="line-1941"></a>                    CtEvidence
<a name="line-1942"></a>         The "flavor" of a canonical constraint
<a name="line-1943"></a>*                                                                      *
<a name="line-1944"></a>************************************************************************
<a name="line-1945"></a>-}</span>
<a name="line-1946"></a>
<a name="line-1947"></a><a name="isWantedCt"></a><span class='hs-definition'>isWantedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1948"></a><span class='hs-definition'>isWantedCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isWanted</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-1949"></a>
<a name="line-1950"></a><a name="isGivenCt"></a><span class='hs-definition'>isGivenCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1951"></a><span class='hs-definition'>isGivenCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGiven</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-1952"></a>
<a name="line-1953"></a><a name="isDerivedCt"></a><span class='hs-definition'>isDerivedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1954"></a><span class='hs-definition'>isDerivedCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDerived</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-1955"></a>
<a name="line-1956"></a><a name="isCTyEqCan"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1957"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1958"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1959"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1960"></a>
<a name="line-1961"></a><a name="isCDictCan_Maybe"></a><span class='hs-definition'>isCDictCan_Maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Class</span>
<a name="line-1962"></a><span class='hs-definition'>isCDictCan_Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span><span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span>
<a name="line-1963"></a><span class='hs-definition'>isCDictCan_Maybe</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1964"></a>
<a name="line-1965"></a><a name="isCIrredEvCan"></a><span class='hs-definition'>isCIrredEvCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1966"></a><span class='hs-definition'>isCIrredEvCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1967"></a><span class='hs-definition'>isCIrredEvCan</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1968"></a>
<a name="line-1969"></a><a name="isCFunEqCan_maybe"></a><span class='hs-definition'>isCFunEqCan_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1970"></a><span class='hs-definition'>isCFunEqCan_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>xis</span><span class='hs-layout'>)</span>
<a name="line-1971"></a><span class='hs-definition'>isCFunEqCan_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1972"></a>
<a name="line-1973"></a><a name="isCFunEqCan"></a><span class='hs-definition'>isCFunEqCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1974"></a><span class='hs-definition'>isCFunEqCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1975"></a><span class='hs-definition'>isCFunEqCan</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1976"></a>
<a name="line-1977"></a><a name="isCNonCanonical"></a><span class='hs-definition'>isCNonCanonical</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1978"></a><span class='hs-definition'>isCNonCanonical</span> <span class='hs-layout'>(</span><span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1979"></a><span class='hs-definition'>isCNonCanonical</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1980"></a>
<a name="line-1981"></a><a name="isHoleCt"></a><span class='hs-definition'>isHoleCt</span><span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1982"></a><span class='hs-definition'>isHoleCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1983"></a><span class='hs-definition'>isHoleCt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1984"></a>
<a name="line-1985"></a><a name="isOutOfScopeCt"></a><span class='hs-definition'>isOutOfScopeCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1986"></a><span class='hs-comment'>-- We treat expression holes representing out-of-scope variables a bit</span>
<a name="line-1987"></a><span class='hs-comment'>-- differently when it comes to error reporting</span>
<a name="line-1988"></a><span class='hs-definition'>isOutOfScopeCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_hole</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExprHole</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutOfScope</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1989"></a><span class='hs-definition'>isOutOfScopeCt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1990"></a>
<a name="line-1991"></a><a name="isExprHoleCt"></a><span class='hs-definition'>isExprHoleCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1992"></a><span class='hs-definition'>isExprHoleCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_hole</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExprHole</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1993"></a><span class='hs-definition'>isExprHoleCt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1994"></a>
<a name="line-1995"></a><a name="isTypeHoleCt"></a><span class='hs-definition'>isTypeHoleCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1996"></a><span class='hs-definition'>isTypeHoleCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_hole</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeHole</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1997"></a><span class='hs-definition'>isTypeHoleCt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1998"></a>
<a name="line-1999"></a>
<a name="line-2000"></a><span class='hs-comment'>{- Note [Custom type errors in constraints]
<a name="line-2001"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2002"></a>
<a name="line-2003"></a>When GHC reports a type-error about an unsolved-constraint, we check
<a name="line-2004"></a>to see if the constraint contains any custom-type errors, and if so
<a name="line-2005"></a>we report them.  Here are some examples of constraints containing type
<a name="line-2006"></a>errors:
<a name="line-2007"></a>
<a name="line-2008"></a>TypeError msg           -- The actual constraint is a type error
<a name="line-2009"></a>
<a name="line-2010"></a>TypError msg ~ Int      -- Some type was supposed to be Int, but ended up
<a name="line-2011"></a>                        -- being a type error instead
<a name="line-2012"></a>
<a name="line-2013"></a>Eq (TypeError msg)      -- A class constraint is stuck due to a type error
<a name="line-2014"></a>
<a name="line-2015"></a>F (TypeError msg) ~ a   -- A type function failed to evaluate due to a type err
<a name="line-2016"></a>
<a name="line-2017"></a>It is also possible to have constraints where the type error is nested deeper,
<a name="line-2018"></a>for example see #11990, and also:
<a name="line-2019"></a>
<a name="line-2020"></a>Eq (F (TypeError msg))  -- Here the type error is nested under a type-function
<a name="line-2021"></a>                        -- call, which failed to evaluate because of it,
<a name="line-2022"></a>                        -- and so the `Eq` constraint was unsolved.
<a name="line-2023"></a>                        -- This may happen when one function calls another
<a name="line-2024"></a>                        -- and the called function produced a custom type error.
<a name="line-2025"></a>-}</span>
<a name="line-2026"></a>
<a name="line-2027"></a><a name="getUserTypeErrorMsg"></a><span class='hs-comment'>-- | A constraint is considered to be a custom type error, if it contains</span>
<a name="line-2028"></a><span class='hs-comment'>-- custom type errors anywhere in it.</span>
<a name="line-2029"></a><span class='hs-comment'>-- See Note [Custom type errors in constraints]</span>
<a name="line-2030"></a><span class='hs-definition'>getUserTypeErrorMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-2031"></a><span class='hs-definition'>getUserTypeErrorMsg</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findUserTypeError</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2032"></a>  <span class='hs-keyword'>where</span>
<a name="line-2033"></a>  <span class='hs-varid'>findUserTypeError</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msum</span> <span class='hs-layout'>(</span> <span class='hs-varid'>userTypeError_maybe</span> <span class='hs-varid'>t</span>
<a name="line-2034"></a>                             <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>findUserTypeError</span> <span class='hs-layout'>(</span><span class='hs-varid'>subTys</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-2035"></a>                             <span class='hs-layout'>)</span>
<a name="line-2036"></a>
<a name="line-2037"></a>  <span class='hs-varid'>subTys</span> <span class='hs-varid'>t</span>            <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitAppTys</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>of</span>
<a name="line-2038"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2039"></a>                            <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>of</span>
<a name="line-2040"></a>                              <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-2041"></a>                              <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ts</span>
<a name="line-2042"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>t</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ts</span>
<a name="line-2043"></a>
<a name="line-2044"></a>
<a name="line-2045"></a>
<a name="line-2046"></a>
<a name="line-2047"></a><a name="isUserTypeErrorCt"></a><span class='hs-definition'>isUserTypeErrorCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2048"></a><span class='hs-definition'>isUserTypeErrorCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getUserTypeErrorMsg</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-2049"></a>                         <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-2050"></a>                         <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2051"></a>
<a name="line-2052"></a><a name="isPendingScDict"></a><span class='hs-definition'>isPendingScDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span>
<a name="line-2053"></a><span class='hs-comment'>-- Says whether cc_pend_sc is True, AND if so flips the flag</span>
<a name="line-2054"></a><span class='hs-definition'>isPendingScDict</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_pend_sc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2055"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_pend_sc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2056"></a><span class='hs-definition'>isPendingScDict</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2057"></a>
<a name="line-2058"></a><a name="setPendingScDict"></a><span class='hs-definition'>setPendingScDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-2059"></a><span class='hs-comment'>-- Set the cc_pend_sc flag to True</span>
<a name="line-2060"></a><span class='hs-definition'>setPendingScDict</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_pend_sc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2061"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_pend_sc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-2062"></a><span class='hs-definition'>setPendingScDict</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span>
<a name="line-2063"></a>
<a name="line-2064"></a><a name="superClassesMightHelp"></a><span class='hs-definition'>superClassesMightHelp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2065"></a><span class='hs-comment'>-- ^ True if taking superclasses of givens, or of wanteds (to perhaps</span>
<a name="line-2066"></a><span class='hs-comment'>-- expose more equalities or functional dependencies) might help to</span>
<a name="line-2067"></a><span class='hs-comment'>-- solve this constraint.  See Note [When superclasses help]</span>
<a name="line-2068"></a><span class='hs-definition'>superClassesMightHelp</span> <span class='hs-varid'>ct</span>
<a name="line-2069"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_ip</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2070"></a>  <span class='hs-keyword'>where</span>
<a name="line-2071"></a>    <span class='hs-varid'>is_ip</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isIPClass</span> <span class='hs-varid'>cls</span>
<a name="line-2072"></a>    <span class='hs-varid'>is_ip</span> <span class='hs-keyword'>_</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2073"></a>
<a name="line-2074"></a><span class='hs-comment'>{- Note [When superclasses help]
<a name="line-2075"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2076"></a>First read Note [The superclass story] in TcCanonical.
<a name="line-2077"></a>
<a name="line-2078"></a>We expand superclasses and iterate only if there is at unsolved wanted
<a name="line-2079"></a>for which expansion of superclasses (e.g. from given constraints)
<a name="line-2080"></a>might actually help. The function superClassesMightHelp tells if
<a name="line-2081"></a>doing this superclass expansion might help solve this constraint.
<a name="line-2082"></a>Note that
<a name="line-2083"></a>
<a name="line-2084"></a>  * Superclasses help only for Wanted constraints.  Derived constraints
<a name="line-2085"></a>    are not really "unsolved" and we certainly don't want them to
<a name="line-2086"></a>    trigger superclass expansion. This was a good part of the loop
<a name="line-2087"></a>    in  Trac #11523
<a name="line-2088"></a>
<a name="line-2089"></a>  * Even for Wanted constraints, we say "no" for implicit parameters.
<a name="line-2090"></a>    we have [W] ?x::ty, expanding superclasses won't help:
<a name="line-2091"></a>      - Superclasses can't be implicit parameters
<a name="line-2092"></a>      - If we have a [G] ?x:ty2, then we'll have another unsolved
<a name="line-2093"></a>        [D] ty ~ ty2 (from the functional dependency)
<a name="line-2094"></a>        which will trigger superclass expansion.
<a name="line-2095"></a>
<a name="line-2096"></a>    It's a bit of a special case, but it's easy to do.  The runtime cost
<a name="line-2097"></a>    is low because the unsolved set is usually empty anyway (errors
<a name="line-2098"></a>    aside), and the first non-imlicit-parameter will terminate the search.
<a name="line-2099"></a>
<a name="line-2100"></a>    The special case is worth it (Trac #11480, comment:2) because it
<a name="line-2101"></a>    applies to CallStack constraints, which aren't type errors. If we have
<a name="line-2102"></a>       f :: (C a) =&gt; blah
<a name="line-2103"></a>       f x = ...undefined...
<a name="line-2104"></a>    we'll get a CallStack constraint.  If that's the only unsolved
<a name="line-2105"></a>    constraint it'll eventually be solved by defaulting.  So we don't
<a name="line-2106"></a>    want to emit warnings about hitting the simplifier's iteration
<a name="line-2107"></a>    limit.  A CallStack constraint really isn't an unsolved
<a name="line-2108"></a>    constraint; it can always be solved by defaulting.
<a name="line-2109"></a>-}</span>
<a name="line-2110"></a>
<a name="line-2111"></a><a name="singleCt"></a><span class='hs-definition'>singleCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2112"></a><span class='hs-definition'>singleCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span>
<a name="line-2113"></a>
<a name="line-2114"></a><a name="andCts"></a><span class='hs-definition'>andCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2115"></a><span class='hs-definition'>andCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionBags</span>
<a name="line-2116"></a>
<a name="line-2117"></a><a name="listToCts"></a><span class='hs-definition'>listToCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2118"></a><span class='hs-definition'>listToCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span>
<a name="line-2119"></a>
<a name="line-2120"></a><a name="ctsElts"></a><span class='hs-definition'>ctsElts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-2121"></a><span class='hs-definition'>ctsElts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bagToList</span>
<a name="line-2122"></a>
<a name="line-2123"></a><a name="consCts"></a><span class='hs-definition'>consCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2124"></a><span class='hs-definition'>consCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>consBag</span>
<a name="line-2125"></a>
<a name="line-2126"></a><a name="snocCts"></a><span class='hs-definition'>snocCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2127"></a><span class='hs-definition'>snocCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snocBag</span>
<a name="line-2128"></a>
<a name="line-2129"></a><a name="extendCtsList"></a><span class='hs-definition'>extendCtsList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2130"></a><span class='hs-definition'>extendCtsList</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>xs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-2131"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>xs</span>
<a name="line-2132"></a>
<a name="line-2133"></a><a name="andManyCts"></a><span class='hs-definition'>andManyCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Cts</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2134"></a><span class='hs-definition'>andManyCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionManyBags</span>
<a name="line-2135"></a>
<a name="line-2136"></a><a name="emptyCts"></a><span class='hs-definition'>emptyCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-2137"></a><span class='hs-definition'>emptyCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2138"></a>
<a name="line-2139"></a><a name="isEmptyCts"></a><span class='hs-definition'>isEmptyCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2140"></a><span class='hs-definition'>isEmptyCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span>
<a name="line-2141"></a>
<a name="line-2142"></a><a name="pprCts"></a><span class='hs-definition'>pprCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2143"></a><span class='hs-definition'>pprCts</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2144"></a>
<a name="line-2145"></a><span class='hs-comment'>{-
<a name="line-2146"></a>************************************************************************
<a name="line-2147"></a>*                                                                      *
<a name="line-2148"></a>                Wanted constraints
<a name="line-2149"></a>     These are forced to be in TcRnTypes because
<a name="line-2150"></a>           TcLclEnv mentions WantedConstraints
<a name="line-2151"></a>           WantedConstraint mentions CtLoc
<a name="line-2152"></a>           CtLoc mentions ErrCtxt
<a name="line-2153"></a>           ErrCtxt mentions TcM
<a name="line-2154"></a>*                                                                      *
<a name="line-2155"></a>v%************************************************************************
<a name="line-2156"></a>-}</span>
<a name="line-2157"></a>
<a name="line-2158"></a><a name="WantedConstraints"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>              <span class='hs-comment'>-- Unsolved constraints, all wanted</span>
<a name="line-2160"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>
<a name="line-2161"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>              <span class='hs-comment'>-- Insoluble constraints, can be</span>
<a name="line-2162"></a>                                       <span class='hs-comment'>-- wanted, given, or derived</span>
<a name="line-2163"></a>                                       <span class='hs-comment'>-- See Note [Insoluble constraints]</span>
<a name="line-2164"></a>    <span class='hs-layout'>}</span>
<a name="line-2165"></a>
<a name="line-2166"></a><a name="emptyWC"></a><span class='hs-definition'>emptyWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2167"></a><span class='hs-definition'>emptyWC</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-2168"></a>
<a name="line-2169"></a><a name="mkSimpleWC"></a><span class='hs-definition'>mkSimpleWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2170"></a><span class='hs-definition'>mkSimpleWC</span> <span class='hs-varid'>cts</span>
<a name="line-2171"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-2172"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2173"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-2174"></a>
<a name="line-2175"></a><a name="mkImplicWC"></a><span class='hs-definition'>mkImplicWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2176"></a><span class='hs-definition'>mkImplicWC</span> <span class='hs-varid'>implic</span>
<a name="line-2177"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-2178"></a>
<a name="line-2179"></a><a name="isEmptyWC"></a><span class='hs-definition'>isEmptyWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2180"></a><span class='hs-definition'>isEmptyWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>n</span>
<a name="line-2182"></a>
<a name="line-2183"></a><a name="andWC"></a><span class='hs-definition'>andWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2184"></a><span class='hs-definition'>andWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2185"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>f2</span>
<a name="line-2187"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>i2</span>
<a name="line-2188"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>n2</span> <span class='hs-layout'>}</span>
<a name="line-2189"></a>
<a name="line-2190"></a><a name="unionsWC"></a><span class='hs-definition'>unionsWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WantedConstraints</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2191"></a><span class='hs-definition'>unionsWC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>andWC</span> <span class='hs-varid'>emptyWC</span>
<a name="line-2192"></a>
<a name="line-2193"></a><a name="addSimples"></a><span class='hs-definition'>addSimples</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2194"></a><span class='hs-definition'>addSimples</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>cts</span>
<a name="line-2195"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_simple</span> <span class='hs-varid'>wc</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span>
<a name="line-2196"></a>    <span class='hs-comment'>-- Consider: Put the new constraints at the front, so they get solved first</span>
<a name="line-2197"></a>
<a name="line-2198"></a><a name="addImplics"></a><span class='hs-definition'>addImplics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2199"></a><span class='hs-definition'>addImplics</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_impl</span> <span class='hs-varid'>wc</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>implic</span> <span class='hs-layout'>}</span>
<a name="line-2200"></a>
<a name="line-2201"></a><a name="addInsols"></a><span class='hs-definition'>addInsols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2202"></a><span class='hs-definition'>addInsols</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>cts</span>
<a name="line-2203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_insol</span> <span class='hs-varid'>wc</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span>
<a name="line-2204"></a>
<a name="line-2205"></a><a name="getInsolubles"></a><span class='hs-definition'>getInsolubles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2206"></a><span class='hs-definition'>getInsolubles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_insol</span>
<a name="line-2207"></a>
<a name="line-2208"></a><a name="insolublesOnly"></a><span class='hs-definition'>insolublesOnly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2209"></a><span class='hs-comment'>-- Keep only the insolubles</span>
<a name="line-2210"></a><span class='hs-definition'>insolublesOnly</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2211"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2212"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span>
<a name="line-2213"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBag</span> <span class='hs-varid'>implic_insols_only</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span>
<a name="line-2214"></a>  <span class='hs-keyword'>where</span>
<a name="line-2215"></a>    <span class='hs-varid'>implic_insols_only</span> <span class='hs-varid'>implic</span>
<a name="line-2216"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insolublesOnly</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_wanted</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2217"></a>
<a name="line-2218"></a><a name="dropDerivedWC"></a><span class='hs-definition'>dropDerivedWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-2219"></a><span class='hs-comment'>-- See Note [Dropping derived constraints]</span>
<a name="line-2220"></a><span class='hs-definition'>dropDerivedWC</span> <span class='hs-varid'>wc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2221"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropDerivedSimples</span> <span class='hs-varid'>simples</span>
<a name="line-2222"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropDerivedInsols</span> <span class='hs-varid'>insols</span> <span class='hs-layout'>}</span>
<a name="line-2223"></a>    <span class='hs-comment'>-- The wc_impl implications are already (recursively) filtered</span>
<a name="line-2224"></a>
<a name="line-2225"></a><a name="isSolvedStatus"></a><span class='hs-definition'>isSolvedStatus</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImplicStatus</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2226"></a><span class='hs-definition'>isSolvedStatus</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC_Solved</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2227"></a><span class='hs-definition'>isSolvedStatus</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2228"></a>
<a name="line-2229"></a><a name="isInsolubleStatus"></a><span class='hs-definition'>isInsolubleStatus</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImplicStatus</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2230"></a><span class='hs-definition'>isInsolubleStatus</span> <span class='hs-conid'>IC_Insoluble</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2231"></a><span class='hs-definition'>isInsolubleStatus</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2232"></a>
<a name="line-2233"></a><a name="insolubleImplic"></a><span class='hs-definition'>insolubleImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2234"></a><span class='hs-definition'>insolubleImplic</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isInsolubleStatus</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_status</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span>
<a name="line-2235"></a>
<a name="line-2236"></a><a name="insolubleWC"></a><span class='hs-definition'>insolubleWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2237"></a><span class='hs-definition'>insolubleWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2238"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>anyBag</span> <span class='hs-varid'>trulyInsoluble</span> <span class='hs-varid'>insols</span>
<a name="line-2239"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>anyBag</span> <span class='hs-varid'>insolubleImplic</span> <span class='hs-varid'>implics</span>
<a name="line-2240"></a>
<a name="line-2241"></a><a name="trulyInsoluble"></a><span class='hs-definition'>trulyInsoluble</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2242"></a><span class='hs-comment'>-- Constraints in the wc_insol set which ARE NOT</span>
<a name="line-2243"></a><span class='hs-comment'>-- treated as truly insoluble:</span>
<a name="line-2244"></a><span class='hs-comment'>--   a) type holes, arising from PartialTypeSignatures,</span>
<a name="line-2245"></a><span class='hs-comment'>--   b) "true" expression holes arising from TypedHoles</span>
<a name="line-2246"></a><span class='hs-comment'>--</span>
<a name="line-2247"></a><span class='hs-comment'>-- A "expression hole" or "type hole" constraint isn't really an error</span>
<a name="line-2248"></a><span class='hs-comment'>-- at all; it's a report saying "_ :: Int" here.  But an out-of-scope</span>
<a name="line-2249"></a><span class='hs-comment'>-- variable masquerading as expression holes IS treated as truly</span>
<a name="line-2250"></a><span class='hs-comment'>-- insoluble, so that it trumps other errors during error reporting.</span>
<a name="line-2251"></a><span class='hs-comment'>-- Yuk!</span>
<a name="line-2252"></a><span class='hs-definition'>trulyInsoluble</span> <span class='hs-varid'>insol</span>
<a name="line-2253"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isHoleCt</span> <span class='hs-varid'>insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isOutOfScopeCt</span> <span class='hs-varid'>insol</span>
<a name="line-2254"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>insol</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- See Note [Given insolubles]</span>
<a name="line-2255"></a>
<a name="line-2256"></a><a name="instance%20Outputable%20WantedConstraints"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyword'>where</span>
<a name="line-2257"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span><span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2258"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WC"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span>
<a name="line-2259"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr_bag</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"wc_simple"</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-2260"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_bag</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"wc_insol"</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-2261"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_bag</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"wc_impl"</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2262"></a>
<a name="line-2263"></a><a name="ppr_bag"></a><span class='hs-definition'>ppr_bag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2264"></a><span class='hs-definition'>ppr_bag</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>bag</span>
<a name="line-2265"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>bag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-2266"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>doc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span><span class='hs-layout'>)</span>
<a name="line-2267"></a>                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>$$</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ppr</span><span class='hs-layout'>)</span> <span class='hs-varid'>empty</span> <span class='hs-varid'>bag</span><span class='hs-layout'>)</span>
<a name="line-2268"></a>
<a name="line-2269"></a><span class='hs-comment'>{- Note [Given insolubles]
<a name="line-2270"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2271"></a>Consider (Trac #14325, comment:)
<a name="line-2272"></a>    class (a~b) =&gt; C a b
<a name="line-2273"></a>
<a name="line-2274"></a>    foo :: C a b =&gt; a -&gt; b
<a name="line-2275"></a>    foo x = x
<a name="line-2276"></a>
<a name="line-2277"></a>    hm3 :: C (f b) b =&gt; b -&gt; f b
<a name="line-2278"></a>    hm3 x = foo x
<a name="line-2279"></a>
<a name="line-2280"></a>From the [G] C (f b) b we get the insoluble [G] f b ~# b.  Then we we also
<a name="line-2281"></a>get an unsolved [W] C b (f b).  If trulyInsouble is true of this, we'll
<a name="line-2282"></a>set cec_suppress to True, and suppress reports of the [W] C b (f b).  But we
<a name="line-2283"></a>may not report the insoluble [G] f b ~# b either (see Note [Given errors]
<a name="line-2284"></a>in TcErrors), so we may fail to report anything at all!  Yikes.
<a name="line-2285"></a>
<a name="line-2286"></a>Bottom line: we must be certain to report anything trulyInsoluble.  Easiest
<a name="line-2287"></a>way to guaranteed this is to make truly Insoluble false of Givens.
<a name="line-2288"></a>
<a name="line-2289"></a>
<a name="line-2290"></a>************************************************************************
<a name="line-2291"></a>*                                                                      *
<a name="line-2292"></a>                Implication constraints
<a name="line-2293"></a>*                                                                      *
<a name="line-2294"></a>************************************************************************
<a name="line-2295"></a>-}</span>
<a name="line-2296"></a>
<a name="line-2297"></a><a name="Implication"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Implication</span>
<a name="line-2298"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span>
<a name="line-2299"></a>      <span class='hs-varid'>ic_tclvl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- TcLevel of unification variables</span>
<a name="line-2300"></a>                                 <span class='hs-comment'>-- allocated /inside/ this implication</span>
<a name="line-2301"></a>
<a name="line-2302"></a>      <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Introduced skolems</span>
<a name="line-2303"></a>      <span class='hs-varid'>ic_info</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- See Note [Skolems in an implication]</span>
<a name="line-2304"></a>                                 <span class='hs-comment'>-- See Note [Shadowing in a constraint]</span>
<a name="line-2305"></a>
<a name="line-2306"></a>      <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Given evidence variables</span>
<a name="line-2307"></a>                                 <span class='hs-comment'>--   (order does not matter)</span>
<a name="line-2308"></a>                                 <span class='hs-comment'>-- See Invariant (GivenInv) in TcType</span>
<a name="line-2309"></a>
<a name="line-2310"></a>      <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- True  &lt;=&gt; ic_givens have no equalities, for sure</span>
<a name="line-2311"></a>                                 <span class='hs-comment'>-- False &lt;=&gt; ic_givens might have equalities</span>
<a name="line-2312"></a>
<a name="line-2313"></a>      <span class='hs-varid'>ic_env</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Gives the source location and error context</span>
<a name="line-2314"></a>                                 <span class='hs-comment'>-- for the implication, and hence for all the</span>
<a name="line-2315"></a>                                 <span class='hs-comment'>-- given evidence variables</span>
<a name="line-2316"></a>
<a name="line-2317"></a>      <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- The wanted</span>
<a name="line-2318"></a>
<a name="line-2319"></a>      <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Points to the place to fill in the</span>
<a name="line-2320"></a>                                  <span class='hs-comment'>-- abstraction and bindings.</span>
<a name="line-2321"></a>
<a name="line-2322"></a>      <span class='hs-varid'>ic_needed</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Union of the ics_need fields of any /discarded/</span>
<a name="line-2323"></a>                                  <span class='hs-comment'>-- solved implications in ic_wanted</span>
<a name="line-2324"></a>
<a name="line-2325"></a>      <span class='hs-varid'>ic_status</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImplicStatus</span>
<a name="line-2326"></a>    <span class='hs-layout'>}</span>
<a name="line-2327"></a>
<a name="line-2328"></a><a name="ImplicStatus"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ImplicStatus</span>
<a name="line-2329"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC_Solved</span>     <span class='hs-comment'>-- All wanteds in the tree are solved, all the way down</span>
<a name="line-2330"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>ics_need</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span>     <span class='hs-comment'>-- Evidence variables bound further out,</span>
<a name="line-2331"></a>                                <span class='hs-comment'>-- but needed by this solved implication</span>
<a name="line-2332"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>ics_dead</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>  <span class='hs-comment'>-- Subset of ic_given that are not needed</span>
<a name="line-2333"></a>         <span class='hs-comment'>-- See Note [Tracking redundant constraints] in TcSimplify</span>
<a name="line-2334"></a>
<a name="line-2335"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IC_Insoluble</span>  <span class='hs-comment'>-- At least one insoluble constraint in the tree</span>
<a name="line-2336"></a>
<a name="line-2337"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IC_Unsolved</span>   <span class='hs-comment'>-- Neither of the above; might go either way</span>
<a name="line-2338"></a>
<a name="line-2339"></a><a name="instance%20Outputable%20Implication"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Implication</span> <span class='hs-keyword'>where</span>
<a name="line-2340"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span>
<a name="line-2341"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_eqs</span>
<a name="line-2342"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_status</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>status</span>
<a name="line-2343"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_needed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needed</span> <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2344"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Implic"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>lbrace</span><span class='hs-layout'>)</span>
<a name="line-2345"></a>        <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TcLevel ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span>
<a name="line-2346"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Skolems ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTyVars</span> <span class='hs-varid'>skols</span>
<a name="line-2347"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"No-eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>no_eqs</span>
<a name="line-2348"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Status ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>status</span>
<a name="line-2349"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Given ="</span><span class='hs-layout'>)</span>  <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprEvVars</span> <span class='hs-varid'>given</span><span class='hs-layout'>)</span>
<a name="line-2350"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Wanted ="</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-2351"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Binds ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span>
<a name="line-2352"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Needed ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>needed</span>
<a name="line-2353"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>pprSkolInfo</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>rbrace</span><span class='hs-layout'>)</span>
<a name="line-2354"></a>
<a name="line-2355"></a><a name="instance%20Outputable%20ImplicStatus"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ImplicStatus</span> <span class='hs-keyword'>where</span>
<a name="line-2356"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>IC_Insoluble</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Insoluble"</span>
<a name="line-2357"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>IC_Unsolved</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Unsolved"</span>
<a name="line-2358"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC_Solved</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics_need</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics_dead</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dead</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2359"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Solved"</span>
<a name="line-2360"></a>      <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>braces</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Dead givens ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dead</span>
<a name="line-2361"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Needed ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2362"></a>
<a name="line-2363"></a><span class='hs-comment'>{-
<a name="line-2364"></a>Note [Needed evidence variables]
<a name="line-2365"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2366"></a>Th ic_need_evs field holds the free vars of ic_binds, and all the
<a name="line-2367"></a>ic_binds in nested implications.
<a name="line-2368"></a>
<a name="line-2369"></a>  * Main purpose: if one of the ic_givens is not mentioned in here, it
<a name="line-2370"></a>    is redundant.
<a name="line-2371"></a>
<a name="line-2372"></a>  * solveImplication may drop an implication altogether if it has no
<a name="line-2373"></a>    remaining 'wanteds'. But we still track the free vars of its
<a name="line-2374"></a>    evidence binds, even though it has now disappeared.
<a name="line-2375"></a>
<a name="line-2376"></a>Note [Shadowing in a constraint]
<a name="line-2377"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2378"></a>We assume NO SHADOWING in a constraint.  Specifically
<a name="line-2379"></a> * The unification variables are all implicitly quantified at top
<a name="line-2380"></a>   level, and are all unique
<a name="line-2381"></a> * The skolem variables bound in ic_skols are all freah when the
<a name="line-2382"></a>   implication is created.
<a name="line-2383"></a>So we can safely substitute. For example, if we have
<a name="line-2384"></a>   forall a.  a~Int =&gt; ...(forall b. ...a...)...
<a name="line-2385"></a>we can push the (a~Int) constraint inwards in the "givens" without
<a name="line-2386"></a>worrying that 'b' might clash.
<a name="line-2387"></a>
<a name="line-2388"></a>Note [Skolems in an implication]
<a name="line-2389"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2390"></a>The skolems in an implication are not there to perform a skolem escape
<a name="line-2391"></a>check.  That happens because all the environment variables are in the
<a name="line-2392"></a>untouchables, and therefore cannot be unified with anything at all,
<a name="line-2393"></a>let alone the skolems.
<a name="line-2394"></a>
<a name="line-2395"></a>Instead, ic_skols is used only when considering floating a constraint
<a name="line-2396"></a>outside the implication in TcSimplify.floatEqualities or
<a name="line-2397"></a>TcSimplify.approximateImplications
<a name="line-2398"></a>
<a name="line-2399"></a>Note [Insoluble constraints]
<a name="line-2400"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2401"></a>Some of the errors that we get during canonicalization are best
<a name="line-2402"></a>reported when all constraints have been simplified as much as
<a name="line-2403"></a>possible. For instance, assume that during simplification the
<a name="line-2404"></a>following constraints arise:
<a name="line-2405"></a>
<a name="line-2406"></a> [Wanted]   F alpha ~  uf1
<a name="line-2407"></a> [Wanted]   beta ~ uf1 beta
<a name="line-2408"></a>
<a name="line-2409"></a>When canonicalizing the wanted (beta ~ uf1 beta), if we eagerly fail
<a name="line-2410"></a>we will simply see a message:
<a name="line-2411"></a>    'Can't construct the infinite type  beta ~ uf1 beta'
<a name="line-2412"></a>and the user has no idea what the uf1 variable is.
<a name="line-2413"></a>
<a name="line-2414"></a>Instead our plan is that we will NOT fail immediately, but:
<a name="line-2415"></a>    (1) Record the "frozen" error in the ic_insols field
<a name="line-2416"></a>    (2) Isolate the offending constraint from the rest of the inerts
<a name="line-2417"></a>    (3) Keep on simplifying/canonicalizing
<a name="line-2418"></a>
<a name="line-2419"></a>At the end, we will hopefully have substituted uf1 := F alpha, and we
<a name="line-2420"></a>will be able to report a more informative error:
<a name="line-2421"></a>    'Can't construct the infinite type beta ~ F alpha beta'
<a name="line-2422"></a>
<a name="line-2423"></a>Insoluble constraints *do* include Derived constraints. For example,
<a name="line-2424"></a>a functional dependency might give rise to [D] Int ~ Bool, and we must
<a name="line-2425"></a>report that.  If insolubles did not contain Deriveds, reportErrors would
<a name="line-2426"></a>never see it.
<a name="line-2427"></a>
<a name="line-2428"></a>
<a name="line-2429"></a>************************************************************************
<a name="line-2430"></a>*                                                                      *
<a name="line-2431"></a>            Pretty printing
<a name="line-2432"></a>*                                                                      *
<a name="line-2433"></a>************************************************************************
<a name="line-2434"></a>-}</span>
<a name="line-2435"></a>
<a name="line-2436"></a><a name="pprEvVars"></a><span class='hs-definition'>pprEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>    <span class='hs-comment'>-- Print with their types</span>
<a name="line-2437"></a><span class='hs-definition'>pprEvVars</span> <span class='hs-varid'>ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprEvVarWithType</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>)</span>
<a name="line-2438"></a>
<a name="line-2439"></a><a name="pprEvVarTheta"></a><span class='hs-definition'>pprEvVarTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2440"></a><span class='hs-definition'>pprEvVarTheta</span> <span class='hs-varid'>ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTheta</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>)</span>
<a name="line-2441"></a>
<a name="line-2442"></a><a name="pprEvVarWithType"></a><span class='hs-definition'>pprEvVarWithType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2443"></a><span class='hs-definition'>pprEvVarWithType</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-2444"></a>
<a name="line-2445"></a><span class='hs-comment'>{-
<a name="line-2446"></a>************************************************************************
<a name="line-2447"></a>*                                                                      *
<a name="line-2448"></a>            CtEvidence
<a name="line-2449"></a>*                                                                      *
<a name="line-2450"></a>************************************************************************
<a name="line-2451"></a>
<a name="line-2452"></a>Note [Evidence field of CtEvidence]
<a name="line-2453"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2454"></a>During constraint solving we never look at the type of ctev_evar/ctev_dest;
<a name="line-2455"></a>instead we look at the ctev_pred field.  The evtm/evar field
<a name="line-2456"></a>may be un-zonked.
<a name="line-2457"></a>
<a name="line-2458"></a>Note [Bind new Givens immediately]
<a name="line-2459"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2460"></a>For Givens we make new EvVars and bind them immediately. Two main reasons:
<a name="line-2461"></a>  * Gain sharing.  E.g. suppose we start with g :: C a b, where
<a name="line-2462"></a>       class D a =&gt; C a b
<a name="line-2463"></a>       class (E a, F a) =&gt; D a
<a name="line-2464"></a>    If we generate all g's superclasses as separate EvTerms we might
<a name="line-2465"></a>    get    selD1 (selC1 g) :: E a
<a name="line-2466"></a>           selD2 (selC1 g) :: F a
<a name="line-2467"></a>           selC1 g :: D a
<a name="line-2468"></a>    which we could do more economically as:
<a name="line-2469"></a>           g1 :: D a = selC1 g
<a name="line-2470"></a>           g2 :: E a = selD1 g1
<a name="line-2471"></a>           g3 :: F a = selD2 g1
<a name="line-2472"></a>
<a name="line-2473"></a>  * For *coercion* evidence we *must* bind each given:
<a name="line-2474"></a>      class (a~b) =&gt; C a b where ....
<a name="line-2475"></a>      f :: C a b =&gt; ....
<a name="line-2476"></a>    Then in f's Givens we have g:(C a b) and the superclass sc(g,0):a~b.
<a name="line-2477"></a>    But that superclass selector can't (yet) appear in a coercion
<a name="line-2478"></a>    (see evTermCoercion), so the easy thing is to bind it to an Id.
<a name="line-2479"></a>
<a name="line-2480"></a>So a Given has EvVar inside it rather than (as previously) an EvTerm.
<a name="line-2481"></a>
<a name="line-2482"></a>Note [Given in ctEvCoercion]
<a name="line-2483"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2484"></a>When retrieving the evidence from a Given equality, we update the type of the EvVar
<a name="line-2485"></a>from the ctev_pred field. In Note [Evidence field of CtEvidence], we claim that
<a name="line-2486"></a>the type of the evidence is never looked at -- but this isn't true in the case of
<a name="line-2487"></a>a coercion that is used in a type. (See the comments in Note [Flattening] in TcFlatten
<a name="line-2488"></a>about the FTRNotFollowed case of flattenTyVar.) So, right here where we are retrieving
<a name="line-2489"></a>the coercion from a Given, we update the type to make sure it's zonked.
<a name="line-2490"></a>
<a name="line-2491"></a>-}</span>
<a name="line-2492"></a>
<a name="line-2493"></a><a name="TcEvDest"></a><span class='hs-comment'>-- | A place for type-checking evidence to go after it is generated.</span>
<a name="line-2494"></a><a name="TcEvDest"></a><span class='hs-comment'>-- Wanted equalities are always HoleDest; other wanteds are always</span>
<a name="line-2495"></a><a name="TcEvDest"></a><span class='hs-comment'>-- EvVarDest.</span>
<a name="line-2496"></a><a name="TcEvDest"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcEvDest</span>
<a name="line-2497"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvVarDest</span> <span class='hs-conid'>EvVar</span>         <span class='hs-comment'>-- ^ bind this var to the evidence</span>
<a name="line-2498"></a>              <span class='hs-comment'>-- EvVarDest is always used for non-type-equalities</span>
<a name="line-2499"></a>              <span class='hs-comment'>-- e.g. class constraints</span>
<a name="line-2500"></a>
<a name="line-2501"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HoleDest</span>  <span class='hs-conid'>CoercionHole</span>  <span class='hs-comment'>-- ^ fill in this hole with the evidence</span>
<a name="line-2502"></a>              <span class='hs-comment'>-- HoleDest is always used for type-equalities</span>
<a name="line-2503"></a>              <span class='hs-comment'>-- See Note [Coercion holes] in TyCoRep</span>
<a name="line-2504"></a>
<a name="line-2505"></a><a name="CtEvidence"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-2506"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtGiven</span>    <span class='hs-comment'>-- Truly given, not depending on subgoals</span>
<a name="line-2507"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>      <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-2508"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span>           <span class='hs-comment'>-- See Note [Evidence field of CtEvidence]</span>
<a name="line-2509"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>}</span>
<a name="line-2510"></a>
<a name="line-2511"></a>
<a name="line-2512"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtWanted</span>   <span class='hs-comment'>-- Wanted goal</span>
<a name="line-2513"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>     <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-2514"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvDest</span>
<a name="line-2515"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ShadowInfo</span>     <span class='hs-comment'>-- See Note [Constraint flavours]</span>
<a name="line-2516"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>}</span>
<a name="line-2517"></a>
<a name="line-2518"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtDerived</span>  <span class='hs-comment'>-- A goal that we don't really have to solve and can't</span>
<a name="line-2519"></a>               <span class='hs-comment'>-- immediately rewrite anything other than a derived</span>
<a name="line-2520"></a>               <span class='hs-comment'>-- (there's no evidence!) but if we do manage to solve</span>
<a name="line-2521"></a>               <span class='hs-comment'>-- it may help in solving other goals.</span>
<a name="line-2522"></a>      <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>
<a name="line-2523"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>}</span>
<a name="line-2524"></a>
<a name="line-2525"></a><a name="ctEvPred"></a><span class='hs-definition'>ctEvPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span>
<a name="line-2526"></a><span class='hs-comment'>-- The predicate of a flavor</span>
<a name="line-2527"></a><span class='hs-definition'>ctEvPred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_pred</span>
<a name="line-2528"></a>
<a name="line-2529"></a><a name="ctEvLoc"></a><span class='hs-definition'>ctEvLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2530"></a><span class='hs-definition'>ctEvLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_loc</span>
<a name="line-2531"></a>
<a name="line-2532"></a><a name="ctEvOrigin"></a><span class='hs-definition'>ctEvOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-2533"></a><span class='hs-definition'>ctEvOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvLoc</span>
<a name="line-2534"></a>
<a name="line-2535"></a><a name="ctEvEqRel"></a><span class='hs-comment'>-- | Get the equality relation relevant for a 'CtEvidence'</span>
<a name="line-2536"></a><span class='hs-definition'>ctEvEqRel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqRel</span>
<a name="line-2537"></a><span class='hs-definition'>ctEvEqRel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>predTypeEqRel</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvPred</span>
<a name="line-2538"></a>
<a name="line-2539"></a><a name="ctEvRole"></a><span class='hs-comment'>-- | Get the role relevant for a 'CtEvidence'</span>
<a name="line-2540"></a><span class='hs-definition'>ctEvRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-2541"></a><span class='hs-definition'>ctEvRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqRelRole</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvEqRel</span>
<a name="line-2542"></a>
<a name="line-2543"></a><a name="ctEvTerm"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-2544"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-varid'>ev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleDest</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvCoercion</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ctEvCoercion</span> <span class='hs-varid'>ev</span>
<a name="line-2545"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvId</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-2546"></a>
<a name="line-2547"></a><a name="ctEvCoercion"></a><span class='hs-comment'>-- Always returns a coercion whose type is precisely ctev_pred of the CtEvidence.</span>
<a name="line-2548"></a><span class='hs-comment'>-- See also Note [Given in ctEvCoercion]</span>
<a name="line-2549"></a><span class='hs-definition'>ctEvCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2550"></a><span class='hs-definition'>ctEvCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_id</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2551"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarType</span> <span class='hs-varid'>ev_id</span> <span class='hs-varid'>pred_ty</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [Given in ctEvCoercion]</span>
<a name="line-2552"></a><span class='hs-definition'>ctEvCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dest</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2553"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dest</span>
<a name="line-2554"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-varid'>pred</span>
<a name="line-2555"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- ctEvCoercion is only called on type equalities</span>
<a name="line-2556"></a>    <span class='hs-comment'>-- and they always have HoleDests</span>
<a name="line-2557"></a>    <span class='hs-varid'>mkHoleCo</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2558"></a><span class='hs-definition'>ctEvCoercion</span> <span class='hs-varid'>ev</span>
<a name="line-2559"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ctEvCoercion"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-2560"></a>
<a name="line-2561"></a><a name="ctEvId"></a><span class='hs-definition'>ctEvId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span>
<a name="line-2562"></a><span class='hs-definition'>ctEvId</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span>
<a name="line-2563"></a><span class='hs-definition'>ctEvId</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span>
<a name="line-2564"></a><span class='hs-definition'>ctEvId</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ctEvId:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-2565"></a>
<a name="line-2566"></a><a name="instance%20Outputable%20TcEvDest"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcEvDest</span> <span class='hs-keyword'>where</span>
<a name="line-2567"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleDest</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"hole"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>h</span>
<a name="line-2568"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span>
<a name="line-2569"></a>
<a name="line-2570"></a><a name="instance%20Outputable%20CtEvidence"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyword'>where</span>
<a name="line-2571"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-2572"></a>           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_ev</span>
<a name="line-2573"></a>           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctl_depth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-2574"></a>                  <span class='hs-comment'>-- Show the sub-goal depth too</span>
<a name="line-2575"></a>           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-2576"></a>    <span class='hs-keyword'>where</span>
<a name="line-2577"></a>      <span class='hs-varid'>pp_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ev</span> <span class='hs-keyword'>of</span>
<a name="line-2578"></a>             <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-2579"></a>             <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span>
<a name="line-2580"></a>             <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"_"</span>
<a name="line-2581"></a>
<a name="line-2582"></a><a name="isWanted"></a><span class='hs-definition'>isWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2583"></a><span class='hs-definition'>isWanted</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2584"></a><span class='hs-definition'>isWanted</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2585"></a>
<a name="line-2586"></a><a name="isGiven"></a><span class='hs-definition'>isGiven</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2587"></a><span class='hs-definition'>isGiven</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2588"></a><span class='hs-definition'>isGiven</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2589"></a>
<a name="line-2590"></a><a name="isDerived"></a><span class='hs-definition'>isDerived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2591"></a><span class='hs-definition'>isDerived</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2592"></a><span class='hs-definition'>isDerived</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2593"></a>
<a name="line-2594"></a><span class='hs-comment'>{-
<a name="line-2595"></a>%************************************************************************
<a name="line-2596"></a>%*                                                                      *
<a name="line-2597"></a>            CtFlavour
<a name="line-2598"></a>%*                                                                      *
<a name="line-2599"></a>%************************************************************************
<a name="line-2600"></a>
<a name="line-2601"></a>Note [Constraint flavours]
<a name="line-2602"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2603"></a>Constraints come in four flavours:
<a name="line-2604"></a>
<a name="line-2605"></a>* [G] Given: we have evidence
<a name="line-2606"></a>
<a name="line-2607"></a>* [W] Wanted WOnly: we want evidence
<a name="line-2608"></a>
<a name="line-2609"></a>* [D] Derived: any solution must satisfy this constraint, but
<a name="line-2610"></a>      we don't need evidence for it.  Examples include:
<a name="line-2611"></a>        - superclasses of [W] class constraints
<a name="line-2612"></a>        - equalities arising from functional dependencies
<a name="line-2613"></a>          or injectivity
<a name="line-2614"></a>
<a name="line-2615"></a>* [WD] Wanted WDeriv: a single constraint that represents
<a name="line-2616"></a>                      both [W] and [D]
<a name="line-2617"></a>  We keep them paired as one both for efficiency, and because
<a name="line-2618"></a>  when we have a finite map  F tys -&gt; CFunEqCan, it's inconvenient
<a name="line-2619"></a>  to have two CFunEqCans in the range
<a name="line-2620"></a>
<a name="line-2621"></a>The ctev_nosh field of a Wanted distinguishes between [W] and [WD]
<a name="line-2622"></a>
<a name="line-2623"></a>Wanted constraints are born as [WD], but are split into [W] and its
<a name="line-2624"></a>"shadow" [D] in TcSMonad.maybeEmitShadow.
<a name="line-2625"></a>
<a name="line-2626"></a>See Note [The improvement story and derived shadows] in TcSMonad
<a name="line-2627"></a>-}</span>
<a name="line-2628"></a>
<a name="line-2629"></a><a name="CtFlavour"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtFlavour</span>  <span class='hs-comment'>-- See Note [Constraint flavours]</span>
<a name="line-2630"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Given</span>
<a name="line-2631"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Wanted</span> <span class='hs-conid'>ShadowInfo</span>
<a name="line-2632"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Derived</span>
<a name="line-2633"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-2634"></a>
<a name="line-2635"></a><a name="ShadowInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ShadowInfo</span>
<a name="line-2636"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span>   <span class='hs-comment'>-- [WD] This Wanted constraint has no Derived shadow,</span>
<a name="line-2637"></a>             <span class='hs-comment'>-- so it behaves like a pair of a Wanted and a Derived</span>
<a name="line-2638"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WOnly</span>    <span class='hs-comment'>-- [W] It has a separate derived shadow</span>
<a name="line-2639"></a>             <span class='hs-comment'>-- See Note [Derived shadows]</span>
<a name="line-2640"></a>  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>)</span>
<a name="line-2641"></a>
<a name="line-2642"></a><a name="isGivenOrWDeriv"></a><span class='hs-definition'>isGivenOrWDeriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2643"></a><span class='hs-definition'>isGivenOrWDeriv</span> <span class='hs-conid'>Given</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2644"></a><span class='hs-definition'>isGivenOrWDeriv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WDeriv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2645"></a><span class='hs-definition'>isGivenOrWDeriv</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2646"></a>
<a name="line-2647"></a><a name="instance%20Outputable%20CtFlavour"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyword'>where</span>
<a name="line-2648"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Given</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[G]"</span>
<a name="line-2649"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WDeriv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[WD]"</span>
<a name="line-2650"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WOnly</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[W]"</span>
<a name="line-2651"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Derived</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[D]"</span>
<a name="line-2652"></a>
<a name="line-2653"></a><a name="ctEvFlavour"></a><span class='hs-definition'>ctEvFlavour</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavour</span>
<a name="line-2654"></a><span class='hs-definition'>ctEvFlavour</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nosh</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Wanted</span> <span class='hs-varid'>nosh</span>
<a name="line-2655"></a><span class='hs-definition'>ctEvFlavour</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Given</span>
<a name="line-2656"></a><span class='hs-definition'>ctEvFlavour</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Derived</span>
<a name="line-2657"></a>
<a name="line-2658"></a><a name="CtFlavourRole"></a><span class='hs-comment'>-- | Whether or not one 'Ct' can rewrite another is determined by its</span>
<a name="line-2659"></a><a name="CtFlavourRole"></a><span class='hs-comment'>-- flavour and its equality relation. See also</span>
<a name="line-2660"></a><a name="CtFlavourRole"></a><span class='hs-comment'>-- Note [Flavours with roles] in TcSMonad</span>
<a name="line-2661"></a><a name="CtFlavourRole"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtFlavour</span><span class='hs-layout'>,</span> <span class='hs-conid'>EqRel</span><span class='hs-layout'>)</span>
<a name="line-2662"></a>
<a name="line-2663"></a><a name="ctEvFlavourRole"></a><span class='hs-comment'>-- | Extract the flavour, role, and boxity from a 'CtEvidence'</span>
<a name="line-2664"></a><span class='hs-definition'>ctEvFlavourRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavourRole</span>
<a name="line-2665"></a><span class='hs-definition'>ctEvFlavourRole</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvEqRel</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-2666"></a>
<a name="line-2667"></a><a name="ctFlavourRole"></a><span class='hs-comment'>-- | Extract the flavour, role, and boxity from a 'Ct'</span>
<a name="line-2668"></a><span class='hs-definition'>ctFlavourRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavourRole</span>
<a name="line-2669"></a><span class='hs-definition'>ctFlavourRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvFlavourRole</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-2670"></a>
<a name="line-2671"></a><span class='hs-comment'>{- Note [eqCanRewrite]
<a name="line-2672"></a>~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2673"></a>(eqCanRewrite ct1 ct2) holds if the constraint ct1 (a CTyEqCan of form
<a name="line-2674"></a>tv ~ ty) can be used to rewrite ct2.  It must satisfy the properties of
<a name="line-2675"></a>a can-rewrite relation, see Definition [Can-rewrite relation] in
<a name="line-2676"></a>TcSMonad.
<a name="line-2677"></a>
<a name="line-2678"></a>With the solver handling Coercible constraints like equality constraints,
<a name="line-2679"></a>the rewrite conditions must take role into account, never allowing
<a name="line-2680"></a>a representational equality to rewrite a nominal one.
<a name="line-2681"></a>
<a name="line-2682"></a>Note [Wanteds do not rewrite Wanteds]
<a name="line-2683"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2684"></a>We don't allow Wanteds to rewrite Wanteds, because that can give rise
<a name="line-2685"></a>to very confusing type error messages.  A good example is Trac #8450.
<a name="line-2686"></a>Here's another
<a name="line-2687"></a>   f :: a -&gt; Bool
<a name="line-2688"></a>   f x = ( [x,'c'], [x,True] ) `seq` True
<a name="line-2689"></a>Here we get
<a name="line-2690"></a>  [W] a ~ Char
<a name="line-2691"></a>  [W] a ~ Bool
<a name="line-2692"></a>but we do not want to complain about Bool ~ Char!
<a name="line-2693"></a>
<a name="line-2694"></a>Note [Deriveds do rewrite Deriveds]
<a name="line-2695"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2696"></a>However we DO allow Deriveds to rewrite Deriveds, because that's how
<a name="line-2697"></a>improvement works; see Note [The improvement story] in TcInteract.
<a name="line-2698"></a>
<a name="line-2699"></a>However, for now at least I'm only letting (Derived,NomEq) rewrite
<a name="line-2700"></a>(Derived,NomEq) and not doing anything for ReprEq.  If we have
<a name="line-2701"></a>    eqCanRewriteFR (Derived, NomEq) (Derived, _)  = True
<a name="line-2702"></a>then we lose property R2 of Definition [Can-rewrite relation]
<a name="line-2703"></a>in TcSMonad
<a name="line-2704"></a>  R2.  If f1 &gt;= f, and f2 &gt;= f,
<a name="line-2705"></a>       then either f1 &gt;= f2 or f2 &gt;= f1
<a name="line-2706"></a>Consider f1 = (Given, ReprEq)
<a name="line-2707"></a>         f2 = (Derived, NomEq)
<a name="line-2708"></a>          f = (Derived, ReprEq)
<a name="line-2709"></a>
<a name="line-2710"></a>I thought maybe we could never get Derived ReprEq constraints, but
<a name="line-2711"></a>we can; straight from the Wanteds during improvement. And from a Derived
<a name="line-2712"></a>ReprEq we could conceivably get a Derived NomEq improvement (by decomposing
<a name="line-2713"></a>a type constructor with Nomninal role), and hence unify.
<a name="line-2714"></a>-}</span>
<a name="line-2715"></a>
<a name="line-2716"></a><a name="eqCanRewriteFR"></a><span class='hs-definition'>eqCanRewriteFR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2717"></a><span class='hs-comment'>-- Can fr1 actually rewrite fr2?</span>
<a name="line-2718"></a><span class='hs-comment'>-- Very important function!</span>
<a name="line-2719"></a><span class='hs-comment'>-- See Note [eqCanRewrite]</span>
<a name="line-2720"></a><span class='hs-comment'>-- See Note [Wanteds do not rewrite Wanteds]</span>
<a name="line-2721"></a><span class='hs-comment'>-- See Note [Deriveds do rewrite Deriveds]</span>
<a name="line-2722"></a><span class='hs-definition'>eqCanRewriteFR</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span>         <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2723"></a><span class='hs-definition'>eqCanRewriteFR</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span><span class='hs-layout'>,</span> <span class='hs-conid'>ReprEq</span><span class='hs-layout'>)</span>        <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>ReprEq</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2724"></a><span class='hs-definition'>eqCanRewriteFR</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WDeriv</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2725"></a><span class='hs-definition'>eqCanRewriteFR</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span><span class='hs-layout'>,</span>       <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2726"></a><span class='hs-definition'>eqCanRewriteFR</span> <span class='hs-keyword'>_</span>                      <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2727"></a>
<a name="line-2728"></a><a name="eqMayRewriteFR"></a><span class='hs-definition'>eqMayRewriteFR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2729"></a><span class='hs-comment'>-- Is it /possible/ that fr1 can rewrite fr2?</span>
<a name="line-2730"></a><span class='hs-comment'>-- This is used when deciding which inerts to kick out,</span>
<a name="line-2731"></a><span class='hs-comment'>-- at which time a [WD] inert may be split into [W] and [D]</span>
<a name="line-2732"></a><span class='hs-definition'>eqMayRewriteFR</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WDeriv</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WDeriv</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2733"></a><span class='hs-definition'>eqMayRewriteFR</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span><span class='hs-layout'>,</span>       <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WDeriv</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2734"></a><span class='hs-definition'>eqMayRewriteFR</span> <span class='hs-varid'>fr1</span> <span class='hs-varid'>fr2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqCanRewriteFR</span> <span class='hs-varid'>fr1</span> <span class='hs-varid'>fr2</span>
<a name="line-2735"></a>
<a name="line-2736"></a><span class='hs-comment'>-----------------</span>
<a name="line-2737"></a><span class='hs-comment'>{- Note [funEqCanDischarge]
<a name="line-2738"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2739"></a>Suppose we have two CFunEqCans with the same LHS:
<a name="line-2740"></a>    (x1:F ts ~ f1) `funEqCanDischarge` (x2:F ts ~ f2)
<a name="line-2741"></a>Can we drop x2 in favour of x1, either unifying
<a name="line-2742"></a>f2 (if it's a flatten meta-var) or adding a new Given
<a name="line-2743"></a>(f1 ~ f2), if x2 is a Given?
<a name="line-2744"></a>
<a name="line-2745"></a>Answer: yes if funEqCanDischarge is true.
<a name="line-2746"></a>-}</span>
<a name="line-2747"></a>
<a name="line-2748"></a><a name="funEqCanDischarge"></a><span class='hs-definition'>funEqCanDischarge</span>
<a name="line-2749"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-2750"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-conid'>SwapFlag</span>   <span class='hs-comment'>-- NotSwapped =&gt; lhs can discharge rhs</span>
<a name="line-2751"></a>                  <span class='hs-comment'>-- Swapped    =&gt; rhs can discharge lhs</span>
<a name="line-2752"></a>     <span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- True &lt;=&gt; upgrade non-discharded one</span>
<a name="line-2753"></a>                  <span class='hs-comment'>--          from [W] to [WD]</span>
<a name="line-2754"></a><span class='hs-comment'>-- See Note [funEqCanDischarge]</span>
<a name="line-2755"></a><span class='hs-definition'>funEqCanDischarge</span> <span class='hs-varid'>ev1</span> <span class='hs-varid'>ev2</span>
<a name="line-2756"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>ctEvEqRel</span> <span class='hs-varid'>ev1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev1</span> <span class='hs-layout'>)</span>
<a name="line-2757"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>ctEvEqRel</span> <span class='hs-varid'>ev2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev2</span> <span class='hs-layout'>)</span>
<a name="line-2758"></a>    <span class='hs-comment'>-- CFunEqCans are all Nominal, hence asserts</span>
<a name="line-2759"></a>    <span class='hs-varid'>funEqCanDischargeF</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev2</span><span class='hs-layout'>)</span>
<a name="line-2760"></a>
<a name="line-2761"></a><a name="funEqCanDischargeF"></a><span class='hs-definition'>funEqCanDischargeF</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SwapFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-2762"></a><span class='hs-definition'>funEqCanDischargeF</span> <span class='hs-conid'>Given</span>           <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>NotSwapped</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-2763"></a><span class='hs-definition'>funEqCanDischargeF</span> <span class='hs-keyword'>_</span>               <span class='hs-conid'>Given</span>           <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>IsSwapped</span><span class='hs-layout'>,</span>  <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-2764"></a><span class='hs-definition'>funEqCanDischargeF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WDeriv</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>NotSwapped</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-2765"></a><span class='hs-definition'>funEqCanDischargeF</span> <span class='hs-keyword'>_</span>               <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WDeriv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>IsSwapped</span><span class='hs-layout'>,</span>  <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-2766"></a><span class='hs-definition'>funEqCanDischargeF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WOnly</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WOnly</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>NotSwapped</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-2767"></a><span class='hs-definition'>funEqCanDischargeF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WOnly</span><span class='hs-layout'>)</span>  <span class='hs-conid'>Derived</span>         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>NotSwapped</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-2768"></a><span class='hs-definition'>funEqCanDischargeF</span> <span class='hs-conid'>Derived</span>         <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WOnly</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>IsSwapped</span><span class='hs-layout'>,</span>  <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-2769"></a><span class='hs-definition'>funEqCanDischargeF</span> <span class='hs-conid'>Derived</span>         <span class='hs-conid'>Derived</span>         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>NotSwapped</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-2770"></a>
<a name="line-2771"></a>
<a name="line-2772"></a><span class='hs-comment'>{- Note [eqCanDischarge]
<a name="line-2773"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2774"></a>Suppose we have two identical CTyEqCan equality constraints
<a name="line-2775"></a>(i.e. both LHS and RHS are the same)
<a name="line-2776"></a>      (x1:a~t) `eqCanDischarge` (xs:a~t)
<a name="line-2777"></a>Can we just drop x2 in favour of x1?
<a name="line-2778"></a>
<a name="line-2779"></a>Answer: yes if eqCanDischarge is true.
<a name="line-2780"></a>
<a name="line-2781"></a>Note that we do /not/ allow Wanted to discharge Derived.
<a name="line-2782"></a>We must keep both.  Why?  Because the Derived may rewrite
<a name="line-2783"></a>other Deriveds in the model whereas the Wanted cannot.
<a name="line-2784"></a>
<a name="line-2785"></a>However a Wanted can certainly discharge an identical Wanted.  So
<a name="line-2786"></a>eqCanDischarge does /not/ define a can-rewrite relation in the
<a name="line-2787"></a>sense of Definition [Can-rewrite relation] in TcSMonad.
<a name="line-2788"></a>
<a name="line-2789"></a>We /do/ say that a [W] can discharge a [WD].  In evidence terms it
<a name="line-2790"></a>certainly can, and the /caller/ arranges that the otherwise-lost [D]
<a name="line-2791"></a>is spat out as a new Derived.  -}</span>
<a name="line-2792"></a>
<a name="line-2793"></a><a name="eqCanDischarge"></a><span class='hs-definition'>eqCanDischarge</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2794"></a><span class='hs-comment'>-- See Note [eqCanDischarge]</span>
<a name="line-2795"></a><span class='hs-definition'>eqCanDischarge</span> <span class='hs-varid'>ev1</span> <span class='hs-varid'>ev2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqCanDischargeFR</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavourRole</span> <span class='hs-varid'>ev1</span><span class='hs-layout'>)</span>
<a name="line-2796"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavourRole</span> <span class='hs-varid'>ev2</span><span class='hs-layout'>)</span>
<a name="line-2797"></a>
<a name="line-2798"></a><a name="eqCanDischargeFR"></a><span class='hs-definition'>eqCanDischargeFR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2799"></a><span class='hs-definition'>eqCanDischargeFR</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>ReprEq</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2800"></a><span class='hs-definition'>eqCanDischargeFR</span> <span class='hs-layout'>(</span><span class='hs-varid'>f1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-layout'>(</span><span class='hs-varid'>f2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqCanDischargeF</span> <span class='hs-varid'>f1</span> <span class='hs-varid'>f2</span>
<a name="line-2801"></a>
<a name="line-2802"></a><a name="eqCanDischargeF"></a><span class='hs-definition'>eqCanDischargeF</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2803"></a><span class='hs-definition'>eqCanDischargeF</span> <span class='hs-conid'>Given</span>   <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2804"></a><span class='hs-definition'>eqCanDischargeF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2805"></a><span class='hs-definition'>eqCanDischargeF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-conid'>WDeriv</span><span class='hs-layout'>)</span> <span class='hs-conid'>Derived</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2806"></a><span class='hs-definition'>eqCanDischargeF</span> <span class='hs-conid'>Derived</span>         <span class='hs-conid'>Derived</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2807"></a><span class='hs-definition'>eqCanDischargeF</span> <span class='hs-keyword'>_</span>               <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2808"></a>
<a name="line-2809"></a>
<a name="line-2810"></a><span class='hs-comment'>{-
<a name="line-2811"></a>************************************************************************
<a name="line-2812"></a>*                                                                      *
<a name="line-2813"></a>            SubGoalDepth
<a name="line-2814"></a>*                                                                      *
<a name="line-2815"></a>************************************************************************
<a name="line-2816"></a>
<a name="line-2817"></a>Note [SubGoalDepth]
<a name="line-2818"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-2819"></a>The 'SubGoalDepth' takes care of stopping the constraint solver from looping.
<a name="line-2820"></a>
<a name="line-2821"></a>The counter starts at zero and increases. It includes dictionary constraints,
<a name="line-2822"></a>equality simplification, and type family reduction. (Why combine these? Because
<a name="line-2823"></a>it's actually quite easy to mistake one for another, in sufficiently involved
<a name="line-2824"></a>scenarios, like ConstraintKinds.)
<a name="line-2825"></a>
<a name="line-2826"></a>The flag -fcontext-stack=n (not very well named!) fixes the maximium
<a name="line-2827"></a>level.
<a name="line-2828"></a>
<a name="line-2829"></a>* The counter includes the depth of type class instance declarations.  Example:
<a name="line-2830"></a>     [W] d{7} : Eq [Int]
<a name="line-2831"></a>  That is d's dictionary-constraint depth is 7.  If we use the instance
<a name="line-2832"></a>     $dfEqList :: Eq a =&gt; Eq [a]
<a name="line-2833"></a>  to simplify it, we get
<a name="line-2834"></a>     d{7} = $dfEqList d'{8}
<a name="line-2835"></a>  where d'{8} : Eq Int, and d' has depth 8.
<a name="line-2836"></a>
<a name="line-2837"></a>  For civilised (decidable) instance declarations, each increase of
<a name="line-2838"></a>  depth removes a type constructor from the type, so the depth never
<a name="line-2839"></a>  gets big; i.e. is bounded by the structural depth of the type.
<a name="line-2840"></a>
<a name="line-2841"></a>* The counter also increments when resolving
<a name="line-2842"></a>equalities involving type functions. Example:
<a name="line-2843"></a>  Assume we have a wanted at depth 7:
<a name="line-2844"></a>    [W] d{7} : F () ~ a
<a name="line-2845"></a>  If there is an type function equation "F () = Int", this would be rewritten to
<a name="line-2846"></a>    [W] d{8} : Int ~ a
<a name="line-2847"></a>  and remembered as having depth 8.
<a name="line-2848"></a>
<a name="line-2849"></a>  Again, without UndecidableInstances, this counter is bounded, but without it
<a name="line-2850"></a>  can resolve things ad infinitum. Hence there is a maximum level.
<a name="line-2851"></a>
<a name="line-2852"></a>* Lastly, every time an equality is rewritten, the counter increases. Again,
<a name="line-2853"></a>  rewriting an equality constraint normally makes progress, but it's possible
<a name="line-2854"></a>  the "progress" is just the reduction of an infinitely-reducing type family.
<a name="line-2855"></a>  Hence we need to track the rewrites.
<a name="line-2856"></a>
<a name="line-2857"></a>When compiling a program requires a greater depth, then GHC recommends turning
<a name="line-2858"></a>off this check entirely by setting -freduction-depth=0. This is because the
<a name="line-2859"></a>exact number that works is highly variable, and is likely to change even between
<a name="line-2860"></a>minor releases. Because this check is solely to prevent infinite compilation
<a name="line-2861"></a>times, it seems safe to disable it when a user has ascertained that their program
<a name="line-2862"></a>doesn't loop at the type level.
<a name="line-2863"></a>
<a name="line-2864"></a>-}</span>
<a name="line-2865"></a>
<a name="line-2866"></a><a name="SubGoalDepth"></a><span class='hs-comment'>-- | See Note [SubGoalDepth]</span>
<a name="line-2867"></a><a name="SubGoalDepth"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-conid'>Int</span>
<a name="line-2868"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span><span class='hs-layout'>)</span>
<a name="line-2869"></a>
<a name="line-2870"></a><a name="initialSubGoalDepth"></a><span class='hs-definition'>initialSubGoalDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-2871"></a><span class='hs-definition'>initialSubGoalDepth</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-num'>0</span>
<a name="line-2872"></a>
<a name="line-2873"></a><a name="bumpSubGoalDepth"></a><span class='hs-definition'>bumpSubGoalDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-2874"></a><span class='hs-definition'>bumpSubGoalDepth</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-2875"></a>
<a name="line-2876"></a><a name="maxSubGoalDepth"></a><span class='hs-definition'>maxSubGoalDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-2877"></a><span class='hs-definition'>maxSubGoalDepth</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>`max`</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-2878"></a>
<a name="line-2879"></a><a name="subGoalDepthExceeded"></a><span class='hs-definition'>subGoalDepthExceeded</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2880"></a><span class='hs-definition'>subGoalDepthExceeded</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-2881"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIntWithInf</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>reductionDepth</span> <span class='hs-varid'>dflags</span>
<a name="line-2882"></a>
<a name="line-2883"></a><span class='hs-comment'>{-
<a name="line-2884"></a>************************************************************************
<a name="line-2885"></a>*                                                                      *
<a name="line-2886"></a>            CtLoc
<a name="line-2887"></a>*                                                                      *
<a name="line-2888"></a>************************************************************************
<a name="line-2889"></a>
<a name="line-2890"></a>The 'CtLoc' gives information about where a constraint came from.
<a name="line-2891"></a>This is important for decent error message reporting because
<a name="line-2892"></a>dictionaries don't appear in the original source code.
<a name="line-2893"></a>type will evolve...
<a name="line-2894"></a>-}</span>
<a name="line-2895"></a>
<a name="line-2896"></a><a name="CtLoc"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-2897"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-2898"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_t_or_k</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TypeOrKind</span>  <span class='hs-comment'>-- OK if we're not sure</span>
<a name="line-2899"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_depth</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-layout'>}</span>
<a name="line-2900"></a>  <span class='hs-comment'>-- The TcLclEnv includes particularly</span>
<a name="line-2901"></a>  <span class='hs-comment'>--    source location:  tcl_loc   :: RealSrcSpan</span>
<a name="line-2902"></a>  <span class='hs-comment'>--    context:          tcl_ctxt  :: [ErrCtxt]</span>
<a name="line-2903"></a>  <span class='hs-comment'>--    binder stack:     tcl_bndrs :: TcIdBinderStack</span>
<a name="line-2904"></a>  <span class='hs-comment'>--    level:            tcl_tclvl :: TcLevel</span>
<a name="line-2905"></a>
<a name="line-2906"></a><a name="mkGivenLoc"></a><span class='hs-definition'>mkGivenLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2907"></a><span class='hs-definition'>mkGivenLoc</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>env</span>
<a name="line-2908"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-varid'>skol_info</span>
<a name="line-2909"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span> <span class='hs-layout'>}</span>
<a name="line-2910"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_t_or_k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>    <span class='hs-comment'>-- this only matters for error msgs</span>
<a name="line-2911"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initialSubGoalDepth</span> <span class='hs-layout'>}</span>
<a name="line-2912"></a>
<a name="line-2913"></a><a name="mkKindLoc"></a><span class='hs-definition'>mkKindLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>   <span class='hs-comment'>-- original *types* being compared</span>
<a name="line-2914"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2915"></a><span class='hs-definition'>mkKindLoc</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>toKindLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-2916"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>s1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-2917"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>ctLocTypeOrKind_maybe</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2918"></a>
<a name="line-2919"></a><a name="toKindLoc"></a><span class='hs-comment'>-- | Take a CtLoc and moves it to the kind level</span>
<a name="line-2920"></a><span class='hs-definition'>toKindLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2921"></a><span class='hs-definition'>toKindLoc</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_t_or_k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>KindLevel</span> <span class='hs-layout'>}</span>
<a name="line-2922"></a>
<a name="line-2923"></a><a name="ctLocEnv"></a><span class='hs-definition'>ctLocEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-2924"></a><span class='hs-definition'>ctLocEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_env</span>
<a name="line-2925"></a>
<a name="line-2926"></a><a name="ctLocLevel"></a><span class='hs-definition'>ctLocLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLevel</span>
<a name="line-2927"></a><span class='hs-definition'>ctLocLevel</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcl_tclvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocEnv</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-2928"></a>
<a name="line-2929"></a><a name="ctLocDepth"></a><span class='hs-definition'>ctLocDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-2930"></a><span class='hs-definition'>ctLocDepth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_depth</span>
<a name="line-2931"></a>
<a name="line-2932"></a><a name="ctLocOrigin"></a><span class='hs-definition'>ctLocOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-2933"></a><span class='hs-definition'>ctLocOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_origin</span>
<a name="line-2934"></a>
<a name="line-2935"></a><a name="ctLocSpan"></a><span class='hs-definition'>ctLocSpan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RealSrcSpan</span>
<a name="line-2936"></a><span class='hs-definition'>ctLocSpan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>lcl</span>
<a name="line-2937"></a>
<a name="line-2938"></a><a name="ctLocTypeOrKind_maybe"></a><span class='hs-definition'>ctLocTypeOrKind_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-2939"></a><span class='hs-definition'>ctLocTypeOrKind_maybe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_t_or_k</span>
<a name="line-2940"></a>
<a name="line-2941"></a><a name="setCtLocSpan"></a><span class='hs-definition'>setCtLocSpan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RealSrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2942"></a><span class='hs-definition'>setCtLocSpan</span> <span class='hs-varid'>ctl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLocEnv</span> <span class='hs-varid'>ctl</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2943"></a>
<a name="line-2944"></a><a name="bumpCtLocDepth"></a><span class='hs-definition'>bumpCtLocDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2945"></a><span class='hs-definition'>bumpCtLocDepth</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bumpSubGoalDepth</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-2946"></a>
<a name="line-2947"></a><a name="setCtLocOrigin"></a><span class='hs-definition'>setCtLocOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2948"></a><span class='hs-definition'>setCtLocOrigin</span> <span class='hs-varid'>ctl</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>}</span>
<a name="line-2949"></a>
<a name="line-2950"></a><a name="setCtLocEnv"></a><span class='hs-definition'>setCtLocEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2951"></a><span class='hs-definition'>setCtLocEnv</span> <span class='hs-varid'>ctl</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>}</span>
<a name="line-2952"></a>
<a name="line-2953"></a><a name="pushErrCtxt"></a><span class='hs-definition'>pushErrCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2954"></a><span class='hs-definition'>pushErrCtxt</span> <span class='hs-varid'>o</span> <span class='hs-varid'>err</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2955"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2956"></a>
<a name="line-2957"></a><a name="pushErrCtxtSameOrigin"></a><span class='hs-definition'>pushErrCtxtSameOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-2958"></a><span class='hs-comment'>-- Just add information w/o updating the origin!</span>
<a name="line-2959"></a><span class='hs-definition'>pushErrCtxtSameOrigin</span> <span class='hs-varid'>err</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2960"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2961"></a>
<a name="line-2962"></a><span class='hs-comment'>{-
<a name="line-2963"></a>************************************************************************
<a name="line-2964"></a>*                                                                      *
<a name="line-2965"></a>                SkolemInfo
<a name="line-2966"></a>*                                                                      *
<a name="line-2967"></a>************************************************************************
<a name="line-2968"></a>-}</span>
<a name="line-2969"></a>
<a name="line-2970"></a><a name="SkolemInfo"></a><span class='hs-comment'>-- SkolemInfo gives the origin of *given* constraints</span>
<a name="line-2971"></a><a name="SkolemInfo"></a><span class='hs-comment'>--   a) type variables are skolemised</span>
<a name="line-2972"></a><a name="SkolemInfo"></a><span class='hs-comment'>--   b) an implication constraint is generated</span>
<a name="line-2973"></a><a name="SkolemInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-2974"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigSkol</span> <span class='hs-comment'>-- A skolem that is created by instantiating</span>
<a name="line-2975"></a>            <span class='hs-comment'>-- a programmer-supplied type signature</span>
<a name="line-2976"></a>            <span class='hs-comment'>-- Location of the binding site is on the TyVar</span>
<a name="line-2977"></a>            <span class='hs-comment'>-- See Note [SigSkol SkolemInfo]</span>
<a name="line-2978"></a>       <span class='hs-conid'>UserTypeCtxt</span>        <span class='hs-comment'>-- What sort of signature</span>
<a name="line-2979"></a>       <span class='hs-conid'>TcType</span>              <span class='hs-comment'>-- Original type signature (before skolemisation)</span>
<a name="line-2980"></a>       <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- Maps the original name of the skolemised tyvar</span>
<a name="line-2981"></a>                           <span class='hs-comment'>-- to its instantiated version</span>
<a name="line-2982"></a>
<a name="line-2983"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClsSkol</span> <span class='hs-conid'>Class</span>       <span class='hs-comment'>-- Bound at a class decl</span>
<a name="line-2984"></a>
<a name="line-2985"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivSkol</span> <span class='hs-conid'>Type</span>      <span class='hs-comment'>-- Bound by a 'deriving' clause;</span>
<a name="line-2986"></a>                        <span class='hs-comment'>-- the type is the instance we are trying to derive</span>
<a name="line-2987"></a>
<a name="line-2988"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstSkol</span>            <span class='hs-comment'>-- Bound at an instance decl</span>
<a name="line-2989"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstSC</span> <span class='hs-conid'>TypeSize</span>     <span class='hs-comment'>-- A "given" constraint obtained by superclass selection.</span>
<a name="line-2990"></a>                        <span class='hs-comment'>-- If (C ty1 .. tyn) is the largest class from</span>
<a name="line-2991"></a>                        <span class='hs-comment'>--    which we made a superclass selection in the chain,</span>
<a name="line-2992"></a>                        <span class='hs-comment'>--    then TypeSize = sizeTypes [ty1, .., tyn]</span>
<a name="line-2993"></a>                        <span class='hs-comment'>-- See Note [Solving superclass constraints] in TcInstDcls</span>
<a name="line-2994"></a>
<a name="line-2995"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataSkol</span>            <span class='hs-comment'>-- Bound at a data type declaration</span>
<a name="line-2996"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamInstSkol</span>         <span class='hs-comment'>-- Bound at a family instance decl</span>
<a name="line-2997"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatSkol</span>             <span class='hs-comment'>-- An existential type variable bound by a pattern for</span>
<a name="line-2998"></a>      <span class='hs-conid'>ConLike</span>           <span class='hs-comment'>-- a data constructor with an existential type.</span>
<a name="line-2999"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-3000"></a>             <span class='hs-comment'>-- e.g.   data T = forall a. Eq a =&gt; MkT a</span>
<a name="line-3001"></a>             <span class='hs-comment'>--        f (MkT x) = ...</span>
<a name="line-3002"></a>             <span class='hs-comment'>-- The pattern MkT x will allocate an existential type</span>
<a name="line-3003"></a>             <span class='hs-comment'>-- variable for 'a'.</span>
<a name="line-3004"></a>
<a name="line-3005"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrowSkol</span>           <span class='hs-comment'>-- An arrow form (see TcArrows)</span>
<a name="line-3006"></a>
<a name="line-3007"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IPSkol</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsIPName</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Binding site of an implicit parameter</span>
<a name="line-3008"></a>
<a name="line-3009"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RuleSkol</span> <span class='hs-conid'>RuleName</span>   <span class='hs-comment'>-- The LHS of a RULE</span>
<a name="line-3010"></a>
<a name="line-3011"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InferSkol</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3012"></a>                        <span class='hs-comment'>-- We have inferred a type for these (mutually-recursivive)</span>
<a name="line-3013"></a>                        <span class='hs-comment'>-- polymorphic Ids, and are now checking that their RHS</span>
<a name="line-3014"></a>                        <span class='hs-comment'>-- constraints are satisfied.</span>
<a name="line-3015"></a>
<a name="line-3016"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BracketSkol</span>         <span class='hs-comment'>-- Template Haskell bracket</span>
<a name="line-3017"></a>
<a name="line-3018"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnifyForAllSkol</span>     <span class='hs-comment'>-- We are unifying two for-all types</span>
<a name="line-3019"></a>       <span class='hs-conid'>TcType</span>           <span class='hs-comment'>-- The instantiated type *inside* the forall</span>
<a name="line-3020"></a>
<a name="line-3021"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnkSkol</span>             <span class='hs-comment'>-- Unhelpful info (until I improve it)</span>
<a name="line-3022"></a>
<a name="line-3023"></a><a name="instance%20Outputable%20SkolemInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyword'>where</span>
<a name="line-3024"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprSkolInfo</span>
<a name="line-3025"></a>
<a name="line-3026"></a><a name="termEvidenceAllowed"></a><span class='hs-definition'>termEvidenceAllowed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3027"></a><span class='hs-comment'>-- Whether an implication constraint with this SkolemInfo</span>
<a name="line-3028"></a><span class='hs-comment'>-- is permitted to have term-level evidence.  There is</span>
<a name="line-3029"></a><span class='hs-comment'>-- only one that is not, associated with unifiying</span>
<a name="line-3030"></a><span class='hs-comment'>-- forall-types</span>
<a name="line-3031"></a><span class='hs-definition'>termEvidenceAllowed</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyForAllSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3032"></a><span class='hs-definition'>termEvidenceAllowed</span> <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3033"></a>
<a name="line-3034"></a><a name="pprSkolInfo"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3035"></a><span class='hs-comment'>-- Complete the sentence "is a rigid type variable bound by..."</span>
<a name="line-3036"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprSigSkolInfo</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty</span>
<a name="line-3037"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPSkol</span> <span class='hs-varid'>ips</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the implicit-parameter binding"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>ips</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"for"</span>
<a name="line-3038"></a>                                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ips</span>
<a name="line-3039"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClsSkol</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the class declaration for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-3040"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivSkol</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the deriving clause for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-3041"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>InstSkol</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the instance declaration"</span>
<a name="line-3042"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstSC</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the instance declaration"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3043"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>DataSkol</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a data type declaration"</span>
<a name="line-3044"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>FamInstSkol</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a family instance declaration"</span>
<a name="line-3045"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>BracketSkol</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a Template Haskell bracket"</span>
<a name="line-3046"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleSkol</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the RULE"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprRuleName</span> <span class='hs-varid'>name</span>
<a name="line-3047"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>ArrowSkol</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"an arrow form"</span>
<a name="line-3048"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSkol</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>mc</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprPatSkolInfo</span> <span class='hs-varid'>cl</span>
<a name="line-3049"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"in"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprMatchContext</span> <span class='hs-varid'>mc</span> <span class='hs-keyglyph'>]</span>
<a name="line-3050"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferSkol</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the inferred type of"</span>
<a name="line-3051"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-3052"></a>                                           <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-3053"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyForAllSkol</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-3054"></a>
<a name="line-3055"></a><span class='hs-comment'>-- UnkSkol</span>
<a name="line-3056"></a><span class='hs-comment'>-- For type variables the others are dealt with by pprSkolTvBinding.</span>
<a name="line-3057"></a><span class='hs-comment'>-- For Insts, these cases should not happen</span>
<a name="line-3058"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>UnkSkol</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"pprSkolInfo: UnkSkol"</span> <span class='hs-layout'>)</span> <span class='hs-varid'>text</span> <span class='hs-str'>"UnkSkol"</span>
<a name="line-3059"></a>
<a name="line-3060"></a><a name="pprSigSkolInfo"></a><span class='hs-definition'>pprSigSkolInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3061"></a><span class='hs-comment'>-- The type is already tidied</span>
<a name="line-3062"></a><span class='hs-definition'>pprSigSkolInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-3063"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-3064"></a>       <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the type signature for:"</span>
<a name="line-3065"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-3066"></a>       <span class='hs-conid'>PatSynCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span>  <span class='hs-comment'>-- See Note [Skolem info for pattern synonyms]</span>
<a name="line-3067"></a>       <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-3068"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-3069"></a>
<a name="line-3070"></a><a name="pprPatSkolInfo"></a><span class='hs-definition'>pprPatSkolInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConLike</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3071"></a><span class='hs-definition'>pprPatSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-3072"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a pattern with constructor:"</span>
<a name="line-3073"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-3074"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-keyglyph'>]</span>
<a name="line-3075"></a>          <span class='hs-comment'>-- pprType prints forall's regardless of -fprint-explicit-foralls</span>
<a name="line-3076"></a>          <span class='hs-comment'>-- which is what we want here, since we might be saying</span>
<a name="line-3077"></a>          <span class='hs-comment'>-- type variable 't' is bound by ...</span>
<a name="line-3078"></a>
<a name="line-3079"></a><span class='hs-definition'>pprPatSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-3080"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a pattern with pattern synonym:"</span>
<a name="line-3081"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ps</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-3082"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprPatSynType</span> <span class='hs-varid'>ps</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-keyglyph'>]</span>
<a name="line-3083"></a>
<a name="line-3084"></a><span class='hs-comment'>{- Note [Skolem info for pattern synonyms]
<a name="line-3085"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3086"></a>For pattern synonym SkolemInfo we have
<a name="line-3087"></a>   SigSkol (PatSynCtxt p) ty _
<a name="line-3088"></a>but the type 'ty' is not very helpful.  The full pattern-synonym type
<a name="line-3089"></a>has the provided and required pieces, which it is inconvenient to
<a name="line-3090"></a>record and display here. So we simply don't display the type at all,
<a name="line-3091"></a>contenting outselves with just the name of the pattern synonym, which
<a name="line-3092"></a>is fine.  We could do more, but it doesn't seem worth it.
<a name="line-3093"></a>
<a name="line-3094"></a>Note [SigSkol SkolemInfo]
<a name="line-3095"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3096"></a>Suppose we (deeply) skolemise a type
<a name="line-3097"></a>   f :: forall a. a -&gt; forall b. b -&gt; a
<a name="line-3098"></a>Then we'll instantiate [a :-&gt; a', b :-&gt; b'], and with the instantiated
<a name="line-3099"></a>      a' -&gt; b' -&gt; a.
<a name="line-3100"></a>But when, in an error message, we report that "b is a rigid type
<a name="line-3101"></a>variable bound by the type signature for f", we want to show the foralls
<a name="line-3102"></a>in the right place.  So we proceed as follows:
<a name="line-3103"></a>
<a name="line-3104"></a>* In SigSkol we record
<a name="line-3105"></a>    - the original signature forall a. a -&gt; forall b. b -&gt; a
<a name="line-3106"></a>    - the instantiation mapping [a :-&gt; a', b :-&gt; b']
<a name="line-3107"></a>
<a name="line-3108"></a>* Then when tidying in TcMType.tidySkolemInfo, we first tidy a' to
<a name="line-3109"></a>  whatever it tidies to, say a''; and then we walk over the type
<a name="line-3110"></a>  replacing the binder a by the tidied version a'', to give
<a name="line-3111"></a>       forall a''. a'' -&gt; forall b''. b'' -&gt; a''
<a name="line-3112"></a>  We need to do this under function arrows, to match what deeplySkolemise
<a name="line-3113"></a>  does.
<a name="line-3114"></a>
<a name="line-3115"></a>* Typically a'' will have a nice pretty name like "a", but the point is
<a name="line-3116"></a>  that the foral-bound variables of the signature we report line up with
<a name="line-3117"></a>  the instantiated skolems lying  around in other types.
<a name="line-3118"></a>
<a name="line-3119"></a>
<a name="line-3120"></a>************************************************************************
<a name="line-3121"></a>*                                                                      *
<a name="line-3122"></a>            CtOrigin
<a name="line-3123"></a>*                                                                      *
<a name="line-3124"></a>************************************************************************
<a name="line-3125"></a>-}</span>
<a name="line-3126"></a>
<a name="line-3127"></a><a name="CtOrigin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-3128"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-3129"></a>
<a name="line-3130"></a>  <span class='hs-comment'>-- All the others are for *wanted* constraints</span>
<a name="line-3131"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccurrenceOf</span> <span class='hs-conid'>Name</span>              <span class='hs-comment'>-- Occurrence of an overloaded identifier</span>
<a name="line-3132"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccurrenceOfRecSel</span> <span class='hs-conid'>RdrName</span>     <span class='hs-comment'>-- Occurrence of a record selector</span>
<a name="line-3133"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppOrigin</span>                      <span class='hs-comment'>-- An application of some kind</span>
<a name="line-3134"></a>
<a name="line-3135"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SpecPragOrigin</span> <span class='hs-conid'>UserTypeCtxt</span>    <span class='hs-comment'>-- Specialisation pragma for</span>
<a name="line-3136"></a>                                   <span class='hs-comment'>-- function or instance</span>
<a name="line-3137"></a>
<a name="line-3138"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span>
<a name="line-3139"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span>
<a name="line-3140"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ErrorThing</span>
<a name="line-3141"></a>                                  <span class='hs-comment'>-- ^ The thing that has type "actual"</span>
<a name="line-3142"></a>                 <span class='hs-layout'>}</span>
<a name="line-3143"></a>
<a name="line-3144"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>KindEqOrigin</span>
<a name="line-3145"></a>      <span class='hs-conid'>TcType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- A kind equality arising from unifying these two types</span>
<a name="line-3146"></a>      <span class='hs-conid'>CtOrigin</span>                  <span class='hs-comment'>-- originally arising from this</span>
<a name="line-3147"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TypeOrKind</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- the level of the eq this arises from</span>
<a name="line-3148"></a>
<a name="line-3149"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IPOccOrigin</span>  <span class='hs-conid'>HsIPName</span>       <span class='hs-comment'>-- Occurrence of an implicit parameter</span>
<a name="line-3150"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OverLabelOrigin</span> <span class='hs-conid'>FastString</span>  <span class='hs-comment'>-- Occurrence of an overloaded label</span>
<a name="line-3151"></a>
<a name="line-3152"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LiteralOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Occurrence of a literal</span>
<a name="line-3153"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NegateOrigin</span>                        <span class='hs-comment'>-- Occurrence of syntactic negation</span>
<a name="line-3154"></a>
<a name="line-3155"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- [x..], [x..y] etc</span>
<a name="line-3156"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PArrSeqOrigin</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- [:x..y:] and [:x,y..z:]</span>
<a name="line-3157"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SectionOrigin</span>
<a name="line-3158"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TupleOrigin</span>                        <span class='hs-comment'>-- (..,..)</span>
<a name="line-3159"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ExprSigOrigin</span>       <span class='hs-comment'>-- e :: ty</span>
<a name="line-3160"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatSigOrigin</span>        <span class='hs-comment'>-- p :: ty</span>
<a name="line-3161"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatOrigin</span>           <span class='hs-comment'>-- Instantiating a polytyped pattern at a constructor</span>
<a name="line-3162"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ProvCtxtOrigin</span>      <span class='hs-comment'>-- The "provided" context of a pattern synonym signature</span>
<a name="line-3163"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Information about the pattern synonym, in particular</span>
<a name="line-3164"></a>                               <span class='hs-comment'>-- the name and the right-hand side</span>
<a name="line-3165"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecordUpdOrigin</span>
<a name="line-3166"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ViewPatOrigin</span>
<a name="line-3167"></a>
<a name="line-3168"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ScOrigin</span> <span class='hs-conid'>TypeSize</span>   <span class='hs-comment'>-- Typechecking superclasses of an instance declaration</span>
<a name="line-3169"></a>                        <span class='hs-comment'>-- If the instance head is C ty1 .. tyn</span>
<a name="line-3170"></a>                        <span class='hs-comment'>--    then TypeSize = sizeTypes [ty1, .., tyn]</span>
<a name="line-3171"></a>                        <span class='hs-comment'>-- See Note [Solving superclass constraints] in TcInstDcls</span>
<a name="line-3172"></a>
<a name="line-3173"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOrigin</span>         <span class='hs-comment'>-- Typechecking deriving</span>
<a name="line-3174"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOriginDC</span> <span class='hs-conid'>DataCon</span> <span class='hs-conid'>Int</span>
<a name="line-3175"></a>                        <span class='hs-comment'>-- Checking constraints arising from this data con and field index</span>
<a name="line-3176"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOriginCoerce</span> <span class='hs-conid'>Id</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>
<a name="line-3177"></a>                        <span class='hs-comment'>-- DerivOriginCoerce id ty1 ty2: Trying to coerce class method `id` from</span>
<a name="line-3178"></a>                        <span class='hs-comment'>-- `ty1` to `ty2`.</span>
<a name="line-3179"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StandAloneDerivOrigin</span> <span class='hs-comment'>-- Typechecking stand-alone deriving</span>
<a name="line-3180"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DefaultOrigin</span>       <span class='hs-comment'>-- Typechecking a default decl</span>
<a name="line-3181"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DoOrigin</span>            <span class='hs-comment'>-- Arising from a do expression</span>
<a name="line-3182"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DoPatOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Arising from a failable pattern in</span>
<a name="line-3183"></a>                            <span class='hs-comment'>-- a do expression</span>
<a name="line-3184"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MCompOrigin</span>         <span class='hs-comment'>-- Arising from a monad comprehension</span>
<a name="line-3185"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MCompPatOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Arising from a failable pattern in a</span>
<a name="line-3186"></a>                               <span class='hs-comment'>-- monad comprehension</span>
<a name="line-3187"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfOrigin</span>            <span class='hs-comment'>-- Arising from an if statement</span>
<a name="line-3188"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ProcOrigin</span>          <span class='hs-comment'>-- Arising from a proc expression</span>
<a name="line-3189"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AnnOrigin</span>           <span class='hs-comment'>-- An annotation</span>
<a name="line-3190"></a>
<a name="line-3191"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunDepOrigin1</span>       <span class='hs-comment'>-- A functional dependency from combining</span>
<a name="line-3192"></a>        <span class='hs-conid'>PredType</span> <span class='hs-conid'>CtLoc</span>      <span class='hs-comment'>-- This constraint arising from ...</span>
<a name="line-3193"></a>        <span class='hs-conid'>PredType</span> <span class='hs-conid'>CtLoc</span>      <span class='hs-comment'>-- and this constraint arising from ...</span>
<a name="line-3194"></a>
<a name="line-3195"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunDepOrigin2</span>       <span class='hs-comment'>-- A functional dependency from combining</span>
<a name="line-3196"></a>        <span class='hs-conid'>PredType</span> <span class='hs-conid'>CtOrigin</span>   <span class='hs-comment'>-- This constraint arising from ...</span>
<a name="line-3197"></a>        <span class='hs-conid'>PredType</span> <span class='hs-conid'>SrcSpan</span>    <span class='hs-comment'>-- and this top-level instance</span>
<a name="line-3198"></a>        <span class='hs-comment'>-- We only need a CtOrigin on the first, because the location</span>
<a name="line-3199"></a>        <span class='hs-comment'>-- is pinned on the entire error message</span>
<a name="line-3200"></a>
<a name="line-3201"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HoleOrigin</span>
<a name="line-3202"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnboundOccurrenceOf</span> <span class='hs-conid'>OccName</span>
<a name="line-3203"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ListOrigin</span>          <span class='hs-comment'>-- An overloaded list</span>
<a name="line-3204"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StaticOrigin</span>        <span class='hs-comment'>-- A static form</span>
<a name="line-3205"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FailablePattern</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- A failable pattern in do-notation for the</span>
<a name="line-3206"></a>                                <span class='hs-comment'>-- MonadFail Proposal (MFP). Obsolete when</span>
<a name="line-3207"></a>                                <span class='hs-comment'>-- actual desugaring to MonadFail.fail is live.</span>
<a name="line-3208"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-conid'>String</span>
<a name="line-3209"></a>                            <span class='hs-comment'>-- the user should never see this one,</span>
<a name="line-3210"></a>                            <span class='hs-comment'>-- unless ImpredicativeTypes is on, where all</span>
<a name="line-3211"></a>                            <span class='hs-comment'>-- bets are off</span>
<a name="line-3212"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstProvidedOrigin</span> <span class='hs-conid'>Module</span> <span class='hs-conid'>ClsInst</span>
<a name="line-3213"></a>        <span class='hs-comment'>-- Skolem variable arose when we were testing if an instance</span>
<a name="line-3214"></a>        <span class='hs-comment'>-- is solvable or not.</span>
<a name="line-3215"></a>
<a name="line-3216"></a><a name="ErrorThing"></a><span class='hs-comment'>-- | A thing that can be stored for error message generation only.</span>
<a name="line-3217"></a><a name="ErrorThing"></a><span class='hs-comment'>-- It is stored with a function to zonk and tidy the thing.</span>
<a name="line-3218"></a><a name="ErrorThing"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ErrorThing</span>
<a name="line-3219"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ErrorThing</span> <span class='hs-varid'>a</span>
<a name="line-3220"></a>                                         <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- # of args, if known</span>
<a name="line-3221"></a>                                         <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3222"></a>
<a name="line-3223"></a><a name="TypeOrKind"></a><span class='hs-comment'>-- | Flag to see whether we're type-checking terms or kind-checking types</span>
<a name="line-3224"></a><a name="TypeOrKind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TypeOrKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>KindLevel</span>
<a name="line-3225"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-3226"></a>
<a name="line-3227"></a><a name="instance%20Outputable%20TypeOrKind"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TypeOrKind</span> <span class='hs-keyword'>where</span>
<a name="line-3228"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TypeLevel"</span>
<a name="line-3229"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>KindLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"KindLevel"</span>
<a name="line-3230"></a>
<a name="line-3231"></a><a name="isTypeLevel"></a><span class='hs-definition'>isTypeLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3232"></a><span class='hs-definition'>isTypeLevel</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3233"></a><span class='hs-definition'>isTypeLevel</span> <span class='hs-conid'>KindLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3234"></a>
<a name="line-3235"></a><a name="isKindLevel"></a><span class='hs-definition'>isKindLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3236"></a><span class='hs-definition'>isKindLevel</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3237"></a><span class='hs-definition'>isKindLevel</span> <span class='hs-conid'>KindLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3238"></a>
<a name="line-3239"></a><a name="mkErrorThing"></a><span class='hs-comment'>-- | Make an 'ErrorThing' that doesn't need tidying or zonking</span>
<a name="line-3240"></a><span class='hs-definition'>mkErrorThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrorThing</span>
<a name="line-3241"></a><span class='hs-definition'>mkErrorThing</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ErrorThing</span> <span class='hs-varid'>thing</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3242"></a>
<a name="line-3243"></a><a name="errorThingNumArgs_maybe"></a><span class='hs-comment'>-- | Retrieve the # of arguments in the error thing, if known</span>
<a name="line-3244"></a><span class='hs-definition'>errorThingNumArgs_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ErrorThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Arity</span>
<a name="line-3245"></a><span class='hs-definition'>errorThingNumArgs_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ErrorThing</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span>
<a name="line-3246"></a>
<a name="line-3247"></a><a name="instance%20Outputable%20CtOrigin"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyword'>where</span>
<a name="line-3248"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCtOrigin</span>
<a name="line-3249"></a>
<a name="line-3250"></a><a name="instance%20Outputable%20ErrorThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ErrorThing</span> <span class='hs-keyword'>where</span>
<a name="line-3251"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ErrorThing</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span>
<a name="line-3252"></a>
<a name="line-3253"></a><a name="ctoHerald"></a><span class='hs-definition'>ctoHerald</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-3254"></a><span class='hs-definition'>ctoHerald</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"arising from"</span>
<a name="line-3255"></a>
<a name="line-3256"></a><a name="lexprCtOrigin"></a><span class='hs-comment'>-- | Extract a suitable CtOrigin from a HsExpr</span>
<a name="line-3257"></a><span class='hs-definition'>lexprCtOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-3258"></a><span class='hs-definition'>lexprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3259"></a>
<a name="line-3260"></a><a name="exprCtOrigin"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-3261"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OccurrenceOf</span> <span class='hs-varid'>name</span>
<a name="line-3262"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnboundVar</span> <span class='hs-varid'>uv</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnboundOccurrenceOf</span> <span class='hs-layout'>(</span><span class='hs-varid'>unboundVarOcc</span> <span class='hs-varid'>uv</span><span class='hs-layout'>)</span>
<a name="line-3263"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsConLikeOut</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin HsConLikeOut"</span>
<a name="line-3264"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFld</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OccurrenceOfRecSel</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameAmbiguousFieldOcc</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-3265"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLabel</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OverLabelOrigin</span> <span class='hs-varid'>l</span>
<a name="line-3266"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPVar</span> <span class='hs-varid'>ip</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IPOccOrigin</span> <span class='hs-varid'>ip</span>
<a name="line-3267"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LiteralOrigin</span> <span class='hs-varid'>lit</span>
<a name="line-3268"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"concrete literal"</span>
<a name="line-3269"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchesCtOrigin</span> <span class='hs-varid'>matches</span>
<a name="line-3270"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLamCase</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchesCtOrigin</span> <span class='hs-varid'>ms</span>
<a name="line-3271"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>e1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e1</span>
<a name="line-3272"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppType</span> <span class='hs-varid'>e1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e1</span>
<a name="line-3273"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTypeOut</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin HsAppTypeOut"</span>
<a name="line-3274"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>op</span>
<a name="line-3275"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3276"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3277"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SectionOrigin</span>
<a name="line-3278"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SectionOrigin</span>
<a name="line-3279"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"explicit tuple"</span>
<a name="line-3280"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-conid'>ExplicitSum</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"explicit sum"</span>
<a name="line-3281"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchesCtOrigin</span> <span class='hs-varid'>matches</span>
<a name="line-3282"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>syn</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>syn_expr</span> <span class='hs-varid'>syn</span><span class='hs-layout'>)</span>
<a name="line-3283"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"if expression"</span>
<a name="line-3284"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsMultiIf</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lGRHSCtOrigin</span> <span class='hs-varid'>rhs</span>
<a name="line-3285"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3286"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DoOrigin</span>
<a name="line-3287"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"list"</span>
<a name="line-3288"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"parallel array"</span>
<a name="line-3289"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"record construction"</span>
<a name="line-3290"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"record update"</span>
<a name="line-3291"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExprSigOrigin</span>
<a name="line-3292"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySigOut</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin ExprWithTySigOut"</span>
<a name="line-3293"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"arithmetic sequence"</span>
<a name="line-3294"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"parallel array sequence"</span>
<a name="line-3295"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3296"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3297"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBracket</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"TH bracket"</span>
<a name="line-3298"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRnBracketOut</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"HsRnBracketOut"</span>
<a name="line-3299"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin HsTcBracketOut"</span>
<a name="line-3300"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"TH splice"</span>
<a name="line-3301"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"proc"</span>
<a name="line-3302"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStatic</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"static expression"</span>
<a name="line-3303"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArrApp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin HsArrApp"</span>
<a name="line-3304"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArrForm</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin HsArrForm"</span>
<a name="line-3305"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3306"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBinTick</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3307"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lexprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3308"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-conid'>EWildPat</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin EWildPat"</span>
<a name="line-3309"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAsPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin EAsPat"</span>
<a name="line-3310"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>EViewPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin EViewPat"</span>
<a name="line-3311"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELazyPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin ELazyPat"</span>
<a name="line-3312"></a><span class='hs-definition'>exprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"exprCtOrigin HsWrap"</span>
<a name="line-3313"></a>
<a name="line-3314"></a><a name="matchesCtOrigin"></a><span class='hs-comment'>-- | Extract a suitable CtOrigin from a MatchGroup</span>
<a name="line-3315"></a><span class='hs-definition'>matchesCtOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-3316"></a><span class='hs-definition'>matchesCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3317"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>match</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>alts</span>
<a name="line-3318"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Match</span> <span class='hs-layout'>{</span> <span class='hs-varid'>m_grhss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>match</span>
<a name="line-3319"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhssCtOrigin</span> <span class='hs-varid'>grhss</span>
<a name="line-3320"></a>
<a name="line-3321"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3322"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"multi-way match"</span>
<a name="line-3323"></a>
<a name="line-3324"></a><a name="grhssCtOrigin"></a><span class='hs-comment'>-- | Extract a suitable CtOrigin from guarded RHSs</span>
<a name="line-3325"></a><span class='hs-definition'>grhssCtOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-3326"></a><span class='hs-definition'>grhssCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>grhssGRHSs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lgrhss</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lGRHSCtOrigin</span> <span class='hs-varid'>lgrhss</span>
<a name="line-3327"></a>
<a name="line-3328"></a><a name="lGRHSCtOrigin"></a><span class='hs-comment'>-- | Extract a suitable CtOrigin from a list of guarded RHSs</span>
<a name="line-3329"></a><span class='hs-definition'>lGRHSCtOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LGRHS</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-3330"></a><span class='hs-definition'>lGRHSCtOrigin</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprCtOrigin</span> <span class='hs-varid'>e</span>
<a name="line-3331"></a><span class='hs-definition'>lGRHSCtOrigin</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-str'>"multi-way GRHS"</span>
<a name="line-3332"></a>
<a name="line-3333"></a><a name="pprCtLoc"></a><span class='hs-definition'>pprCtLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3334"></a><span class='hs-comment'>-- "arising from ... at ..."</span>
<a name="line-3335"></a><span class='hs-comment'>-- Not an instance of Outputable because of the "arising from" prefix</span>
<a name="line-3336"></a><span class='hs-definition'>pprCtLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3337"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>o</span>
<a name="line-3338"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"at"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3339"></a>
<a name="line-3340"></a><a name="pprCtOrigin"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3341"></a><span class='hs-comment'>-- "arising from ..."</span>
<a name="line-3342"></a><span class='hs-comment'>-- Not an instance of Outputable because of the "arising from" prefix</span>
<a name="line-3343"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenOrigin</span> <span class='hs-varid'>sk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sk</span>
<a name="line-3344"></a>
<a name="line-3345"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPragOrigin</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-3346"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-3347"></a>       <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a SPECIALISE pragma for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-3348"></a>       <span class='hs-conid'>SpecInstCtxt</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a SPECIALISE INSTANCE pragma"</span>
<a name="line-3349"></a>       <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a SPECIALISE pragma"</span>  <span class='hs-comment'>-- Never happens I think</span>
<a name="line-3350"></a>
<a name="line-3351"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunDepOrigin1</span> <span class='hs-varid'>pred1</span> <span class='hs-varid'>loc1</span> <span class='hs-varid'>pred2</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span>
<a name="line-3352"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a functional dependency between constraints:"</span><span class='hs-layout'>)</span>
<a name="line-3353"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCtLoc</span> <span class='hs-varid'>loc1</span><span class='hs-layout'>)</span>
<a name="line-3354"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCtLoc</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3355"></a>
<a name="line-3356"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunDepOrigin2</span> <span class='hs-varid'>pred1</span> <span class='hs-varid'>orig1</span> <span class='hs-varid'>pred2</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span>
<a name="line-3357"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a functional dependency between:"</span><span class='hs-layout'>)</span>
<a name="line-3358"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"constraint"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3359"></a>                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>orig1</span> <span class='hs-layout'>)</span>
<a name="line-3360"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"instance"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3361"></a>                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"at"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3362"></a>
<a name="line-3363"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-3364"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a kind equality arising from"</span><span class='hs-layout'>)</span>
<a name="line-3365"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3366"></a>
<a name="line-3367"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>t1</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-3368"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a kind equality when matching"</span><span class='hs-layout'>)</span>
<a name="line-3369"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>
<a name="line-3370"></a>
<a name="line-3371"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnboundOccurrenceOf</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-3372"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"an undeclared identifier"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-3373"></a>
<a name="line-3374"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivOriginDC</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-3375"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>n</span>
<a name="line-3376"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"field of"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3377"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3378"></a>  <span class='hs-keyword'>where</span>
<a name="line-3379"></a>    <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConOrigArgTys</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-3380"></a>
<a name="line-3381"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivOriginCoerce</span> <span class='hs-varid'>meth</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-3382"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the coercion of the method"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>meth</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3383"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"from type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-3384"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"to type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3385"></a>
<a name="line-3386"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>DoPatOrigin</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-3387"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a do statement"</span>
<a name="line-3388"></a>      <span class='hs-varop'>$$</span>
<a name="line-3389"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"with the failable pattern"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-3390"></a>
<a name="line-3391"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCompPatOrigin</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-3392"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the failable pattern"</span>
<a name="line-3393"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-3394"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"in a statement in a monad comprehension"</span> <span class='hs-keyglyph'>]</span>
<a name="line-3395"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>FailablePattern</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-3396"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the failable pattern"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-3397"></a>      <span class='hs-varop'>$$</span>
<a name="line-3398"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"(this will become an error in a future GHC release)"</span>
<a name="line-3399"></a>
<a name="line-3400"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>Shouldn'tHappenOrigin</span> <span class='hs-varid'>note</span><span class='hs-layout'>)</span>
<a name="line-3401"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3402"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>ImpredicativeTypes</span> <span class='hs-varid'>dflags</span>
<a name="line-3403"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a situation created by impredicative types"</span>
<a name="line-3404"></a>    <span class='hs-keyword'>else</span>
<a name="line-3405"></a>    <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"&lt;&lt; This should not appear in error messages. If you see this"</span>
<a name="line-3406"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"in an error message, please report a bug mentioning"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>note</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"at"</span>
<a name="line-3407"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"https://ghc.haskell.org/trac/ghc/wiki/ReportABug &gt;&gt;"</span> <span class='hs-keyglyph'>]</span>
<a name="line-3408"></a>
<a name="line-3409"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProvCtxtOrigin</span> <span class='hs-conid'>PSB</span><span class='hs-layout'>{</span> <span class='hs-varid'>psb_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3410"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the \"provided\" constraints claimed by"</span><span class='hs-layout'>)</span>
<a name="line-3411"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"the signature of"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3412"></a>
<a name="line-3413"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstProvidedOrigin</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>cls_inst</span><span class='hs-layout'>)</span>
<a name="line-3414"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"arising when attempting to show that"</span>
<a name="line-3415"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cls_inst</span>
<a name="line-3416"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is provided by"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3417"></a>
<a name="line-3418"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-varid'>simple_origin</span>
<a name="line-3419"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCtO</span> <span class='hs-varid'>simple_origin</span>
<a name="line-3420"></a>
<a name="line-3421"></a><a name="pprCtO"></a><span class='hs-comment'>-- | Short one-liners</span>
<a name="line-3422"></a><span class='hs-definition'>pprCtO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3423"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccurrenceOf</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"a use of"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3424"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccurrenceOfRecSel</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"a use of"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3425"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>AppOrigin</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"an application"</span>
<a name="line-3426"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPOccOrigin</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"a use of implicit parameter"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3427"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>OverLabelOrigin</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"the overloaded label"</span>
<a name="line-3428"></a>                                    <span class='hs-layout'>,</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'#'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3429"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>RecordUpdOrigin</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a record update"</span>
<a name="line-3430"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>ExprSigOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"an expression type signature"</span>
<a name="line-3431"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>PatSigOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a pattern type signature"</span>
<a name="line-3432"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>PatOrigin</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a pattern"</span>
<a name="line-3433"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>ViewPatOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a view pattern"</span>
<a name="line-3434"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>IfOrigin</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"an if expression"</span>
<a name="line-3435"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiteralOrigin</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"the literal"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3436"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"the arithmetic sequence"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3437"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"the parallel array sequence"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3438"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>SectionOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"an operator section"</span>
<a name="line-3439"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>TupleOrigin</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a tuple"</span>
<a name="line-3440"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>NegateOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a use of syntactic negation"</span>
<a name="line-3441"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ScOrigin</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the superclasses of an instance declaration"</span>
<a name="line-3442"></a>                               <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3443"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>DerivOrigin</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the 'deriving' clause of a data type declaration"</span>
<a name="line-3444"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>StandAloneDerivOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a 'deriving' declaration"</span>
<a name="line-3445"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>DefaultOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a 'default' declaration"</span>
<a name="line-3446"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>DoOrigin</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a do statement"</span>
<a name="line-3447"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>MCompOrigin</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a statement in a monad comprehension"</span>
<a name="line-3448"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>ProcOrigin</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a proc expression"</span>
<a name="line-3449"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a type equality"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-3450"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>AnnOrigin</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"an annotation"</span>
<a name="line-3451"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>HoleOrigin</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a use of"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span>
<a name="line-3452"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>ListOrigin</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"an overloaded list"</span>
<a name="line-3453"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>StaticOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"a static form"</span>
<a name="line-3454"></a><span class='hs-definition'>pprCtO</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"pprCtOrigin"</span>
<a name="line-3455"></a>
<a name="line-3456"></a><span class='hs-comment'>{-
<a name="line-3457"></a>Constraint Solver Plugins
<a name="line-3458"></a>-------------------------
<a name="line-3459"></a>-}</span>
<a name="line-3460"></a>
<a name="line-3461"></a><a name="TcPluginSolver"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcPluginSolver</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- given</span>
<a name="line-3462"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- derived</span>
<a name="line-3463"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- wanted</span>
<a name="line-3464"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-conid'>TcPluginResult</span>
<a name="line-3465"></a>
<a name="line-3466"></a><a name="TcPluginM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3467"></a>
<a name="line-3468"></a><a name="instance%20Functor%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-3469"></a>  <span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span>
<a name="line-3470"></a>
<a name="line-3471"></a><a name="instance%20Applicative%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-3472"></a>  <span class='hs-varid'>pure</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-3473"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-3474"></a>
<a name="line-3475"></a><a name="instance%20Monad%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-3476"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-3477"></a>  <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span>
<a name="line-3478"></a>    <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ev</span>
<a name="line-3479"></a>                          <span class='hs-varid'>runTcPluginM</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-3480"></a>
<a name="line-3481"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 710</span>
<a name="line-3482"></a><a name="instance%20MonadFail.MonadFail%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadFail</span><span class='hs-varop'>.</span><span class='hs-conid'>MonadFail</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-3483"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-3484"></a><span class='hs-cpp'>#endif</span>
<a name="line-3485"></a>
<a name="line-3486"></a><a name="runTcPluginM"></a><span class='hs-definition'>runTcPluginM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3487"></a><span class='hs-definition'>runTcPluginM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span>
<a name="line-3488"></a>
<a name="line-3489"></a><a name="unsafeTcPluginTcM"></a><span class='hs-comment'>-- | This function provides an escape for direct access to</span>
<a name="line-3490"></a><span class='hs-comment'>-- the 'TcM` monad.  It should not be used lightly, and</span>
<a name="line-3491"></a><span class='hs-comment'>-- the provided 'TcPluginM' API should be favoured instead.</span>
<a name="line-3492"></a><span class='hs-definition'>unsafeTcPluginTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span>
<a name="line-3493"></a><span class='hs-definition'>unsafeTcPluginTcM</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span>
<a name="line-3494"></a>
<a name="line-3495"></a><a name="getEvBindsTcPluginM"></a><span class='hs-comment'>-- | Access the 'EvBindsVar' carried by the 'TcPluginM' during</span>
<a name="line-3496"></a><span class='hs-comment'>-- constraint solving.  Returns 'Nothing' if invoked during</span>
<a name="line-3497"></a><span class='hs-comment'>-- 'tcPluginInit' or 'tcPluginStop'.</span>
<a name="line-3498"></a><span class='hs-definition'>getEvBindsTcPluginM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3499"></a><span class='hs-definition'>getEvBindsTcPluginM</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>return</span>
<a name="line-3500"></a>
<a name="line-3501"></a>
<a name="line-3502"></a><a name="TcPlugin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcPlugin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>s</span><span class='hs-varop'>.</span> <span class='hs-conid'>TcPlugin</span>
<a name="line-3503"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>tcPluginInit</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>s</span>
<a name="line-3504"></a>    <span class='hs-comment'>-- ^ Initialize plugin, when entering type-checker.</span>
<a name="line-3505"></a>
<a name="line-3506"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tcPluginSolve</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginSolver</span>
<a name="line-3507"></a>    <span class='hs-comment'>-- ^ Solve some constraints.</span>
<a name="line-3508"></a>    <span class='hs-comment'>-- TODO: WRITE MORE DETAILS ON HOW THIS WORKS.</span>
<a name="line-3509"></a>
<a name="line-3510"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tcPluginStop</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-conid'>()</span>
<a name="line-3511"></a>   <span class='hs-comment'>-- ^ Clean up after the plugin, when exiting the type-checker.</span>
<a name="line-3512"></a>  <span class='hs-layout'>}</span>
<a name="line-3513"></a>
<a name="line-3514"></a><a name="TcPluginResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcPluginResult</span>
<a name="line-3515"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginContradiction</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-3516"></a>    <span class='hs-comment'>-- ^ The plugin found a contradiction.</span>
<a name="line-3517"></a>    <span class='hs-comment'>-- The returned constraints are removed from the inert set,</span>
<a name="line-3518"></a>    <span class='hs-comment'>-- and recorded as insoluble.</span>
<a name="line-3519"></a>
<a name="line-3520"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPluginOk</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvTerm</span><span class='hs-layout'>,</span><span class='hs-conid'>Ct</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-3521"></a>    <span class='hs-comment'>-- ^ The first field is for constraints that were solved.</span>
<a name="line-3522"></a>    <span class='hs-comment'>-- These are removed from the inert set,</span>
<a name="line-3523"></a>    <span class='hs-comment'>-- and the evidence for them is recorded.</span>
<a name="line-3524"></a>    <span class='hs-comment'>-- The second field contains new work, that should be processed by</span>
<a name="line-3525"></a>    <span class='hs-comment'>-- the constraint solver.</span>
</pre></body>
</html>
