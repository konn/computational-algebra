<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/TyCoRep.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1998
<a name="line-4"></a>\section[TyCoRep]{Type and Coercion - friends' interface}
<a name="line-5"></a>
<a name="line-6"></a>Note [The Type-related module hierarchy]
<a name="line-7"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-8"></a>  Class
<a name="line-9"></a>  CoAxiom
<a name="line-10"></a>  TyCon    imports Class, CoAxiom
<a name="line-11"></a>  TyCoRep  imports Class, CoAxiom, TyCon
<a name="line-12"></a>  TysPrim  imports TyCoRep ( including mkTyConTy )
<a name="line-13"></a>  Kind     imports TysPrim ( mainly for primitive kinds )
<a name="line-14"></a>  Type     imports Kind
<a name="line-15"></a>  Coercion imports Type
<a name="line-16"></a>-}</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-comment'>-- We expose the relevant stuff from this module via the Type module</span>
<a name="line-19"></a><span class='hs-comment'>{-# OPTIONS_HADDOCK hide #-}</span>
<a name="line-20"></a><span class='hs-comment'>{-# LANGUAGE CPP, DeriveDataTypeable, MultiWayIf #-}</span>
<a name="line-21"></a><span class='hs-comment'>{-# LANGUAGE ImplicitParams #-}</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TyCoRep</span> <span class='hs-layout'>(</span>
<a name="line-24"></a>        <span class='hs-conid'>TyThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprShortTyThing</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-comment'>-- * Types</span>
<a name="line-27"></a>        <span class='hs-conid'>Type</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-conid'>TyLit</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-conid'>KindOrType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-conid'>PredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Synonyms</span>
<a name="line-31"></a>        <span class='hs-conid'>ArgFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-comment'>-- * Coercions</span>
<a name="line-34"></a>        <span class='hs-conid'>Coercion</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-conid'>UnivCoProvenance</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionHole</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionR</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionP</span><span class='hs-layout'>,</span> <span class='hs-conid'>KindCoercion</span><span class='hs-layout'>,</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-comment'>-- * Functions over types</span>
<a name="line-39"></a>        <span class='hs-varid'>mkTyConTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTys</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>mkFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTys</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>mkPiTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPiTys</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>isLiftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedTypeKind</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>isCoercionType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRuntimeRepTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRuntimeRepVar</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>isRuntimeRepKindedTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>dropRuntimeRepArgs</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>sameVis</span><span class='hs-layout'>,</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-comment'>-- * Functions over binders</span>
<a name="line-48"></a>        <span class='hs-conid'>TyBinder</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarBinder</span><span class='hs-layout'>,</span>
<a name="line-49"></a>        <span class='hs-varid'>binderVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderArgFlag</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>delBinderVar</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>isInvisibleArgFlag</span><span class='hs-layout'>,</span> <span class='hs-varid'>isVisibleArgFlag</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-varid'>isInvisibleBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>isVisibleBinder</span><span class='hs-layout'>,</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-comment'>-- * Functions over coercions</span>
<a name="line-55"></a>        <span class='hs-varid'>pickLR</span><span class='hs-layout'>,</span>
<a name="line-56"></a>
<a name="line-57"></a>        <span class='hs-comment'>-- * Pretty-printing</span>
<a name="line-58"></a>        <span class='hs-varid'>pprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTypeApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTvBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTvBndrs</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>pprSigmaType</span><span class='hs-layout'>,</span>
<a name="line-60"></a>        <span class='hs-varid'>pprTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprForAll</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprUserForAll</span><span class='hs-layout'>,</span>
<a name="line-61"></a>        <span class='hs-varid'>pprTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyVars</span><span class='hs-layout'>,</span>
<a name="line-62"></a>        <span class='hs-varid'>pprThetaArrowTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprClassPred</span><span class='hs-layout'>,</span>
<a name="line-63"></a>        <span class='hs-varid'>pprKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyLit</span><span class='hs-layout'>,</span>
<a name="line-64"></a>        <span class='hs-conid'>TyPrec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeParen</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTcAppCo</span><span class='hs-layout'>,</span>
<a name="line-65"></a>        <span class='hs-varid'>pprPrefixApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprArrowChain</span><span class='hs-layout'>,</span>
<a name="line-66"></a>        <span class='hs-varid'>pprDataCons</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppSuggestExplicitKinds</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-comment'>-- * Free variables</span>
<a name="line-69"></a>        <span class='hs-varid'>tyCoVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeDSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesDSet</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-varid'>tyCoFVsBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeList</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>tyCoFVsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesList</span><span class='hs-layout'>,</span>
<a name="line-72"></a>        <span class='hs-varid'>closeOverKindsDSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>closeOverKindsFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>closeOverKindsList</span><span class='hs-layout'>,</span>
<a name="line-73"></a>        <span class='hs-varid'>coVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-74"></a>        <span class='hs-varid'>coVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfCos</span><span class='hs-layout'>,</span>
<a name="line-75"></a>        <span class='hs-varid'>tyCoVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCos</span><span class='hs-layout'>,</span>
<a name="line-76"></a>        <span class='hs-varid'>tyCoVarsOfCoDSet</span><span class='hs-layout'>,</span>
<a name="line-77"></a>        <span class='hs-varid'>tyCoFVsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsOfCos</span><span class='hs-layout'>,</span>
<a name="line-78"></a>        <span class='hs-varid'>tyCoVarsOfCoList</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfProv</span><span class='hs-layout'>,</span>
<a name="line-79"></a>        <span class='hs-varid'>closeOverKinds</span><span class='hs-layout'>,</span>
<a name="line-80"></a>
<a name="line-81"></a>        <span class='hs-varid'>noFreeVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>noFreeVarsOfCo</span><span class='hs-layout'>,</span>
<a name="line-82"></a>
<a name="line-83"></a>        <span class='hs-comment'>-- * Substitutions</span>
<a name="line-84"></a>        <span class='hs-conid'>TCvSubst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-85"></a>        <span class='hs-varid'>emptyTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeTCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>emptyTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEmptyTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-87"></a>        <span class='hs-varid'>mkTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTvSubst</span><span class='hs-layout'>,</span>
<a name="line-88"></a>        <span class='hs-varid'>getTvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-89"></a>        <span class='hs-varid'>getCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTCvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTCvSubstRangeFVs</span><span class='hs-layout'>,</span>
<a name="line-90"></a>        <span class='hs-varid'>isInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>notElemTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-91"></a>        <span class='hs-varid'>setTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-92"></a>        <span class='hs-varid'>extendTCvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTCvInScopeList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTCvInScopeSet</span><span class='hs-layout'>,</span>
<a name="line-93"></a>        <span class='hs-varid'>extendTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-94"></a>        <span class='hs-varid'>extendCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCvSubstWithClone</span><span class='hs-layout'>,</span>
<a name="line-95"></a>        <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstWithClone</span><span class='hs-layout'>,</span>
<a name="line-96"></a>        <span class='hs-varid'>extendTvSubstList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstAndInScope</span><span class='hs-layout'>,</span>
<a name="line-97"></a>        <span class='hs-varid'>unionTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipTyEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipCoEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyCoInScopeSet</span><span class='hs-layout'>,</span>
<a name="line-98"></a>        <span class='hs-varid'>zipTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipCvSubst</span><span class='hs-layout'>,</span>
<a name="line-99"></a>        <span class='hs-varid'>mkTvSubstPrs</span><span class='hs-layout'>,</span>
<a name="line-100"></a>
<a name="line-101"></a>        <span class='hs-varid'>substTyWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWithCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysWithCoVars</span><span class='hs-layout'>,</span>
<a name="line-102"></a>        <span class='hs-varid'>substCoWith</span><span class='hs-layout'>,</span>
<a name="line-103"></a>        <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyAddInScope</span><span class='hs-layout'>,</span>
<a name="line-104"></a>        <span class='hs-varid'>substTyUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substThetaUnchecked</span><span class='hs-layout'>,</span>
<a name="line-105"></a>        <span class='hs-varid'>substTyWithUnchecked</span><span class='hs-layout'>,</span>
<a name="line-106"></a>        <span class='hs-varid'>substCoUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoWithUnchecked</span><span class='hs-layout'>,</span>
<a name="line-107"></a>        <span class='hs-varid'>substTyWithInScope</span><span class='hs-layout'>,</span>
<a name="line-108"></a>        <span class='hs-varid'>substTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTheta</span><span class='hs-layout'>,</span>
<a name="line-109"></a>        <span class='hs-varid'>lookupTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span>
<a name="line-110"></a>        <span class='hs-varid'>substCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupCoVar</span><span class='hs-layout'>,</span>
<a name="line-111"></a>        <span class='hs-varid'>substCoVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneTyVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-112"></a>        <span class='hs-varid'>substTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVars</span><span class='hs-layout'>,</span>
<a name="line-113"></a>        <span class='hs-varid'>substForAllCoBndr</span><span class='hs-layout'>,</span>
<a name="line-114"></a>        <span class='hs-varid'>substTyVarBndrCallback</span><span class='hs-layout'>,</span> <span class='hs-varid'>substForAllCoBndrCallback</span><span class='hs-layout'>,</span>
<a name="line-115"></a>        <span class='hs-varid'>checkValidSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>isValidTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-116"></a>
<a name="line-117"></a>        <span class='hs-comment'>-- * Tidying type related things up for printing</span>
<a name="line-118"></a>        <span class='hs-varid'>tidyType</span><span class='hs-layout'>,</span>      <span class='hs-varid'>tidyTypes</span><span class='hs-layout'>,</span>
<a name="line-119"></a>        <span class='hs-varid'>tidyOpenType</span><span class='hs-layout'>,</span>  <span class='hs-varid'>tidyOpenTypes</span><span class='hs-layout'>,</span>
<a name="line-120"></a>        <span class='hs-varid'>tidyOpenKind</span><span class='hs-layout'>,</span>
<a name="line-121"></a>        <span class='hs-varid'>tidyTyCoVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTyCoVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyFreeTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-122"></a>        <span class='hs-varid'>tidyOpenTyCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyOpenTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-123"></a>        <span class='hs-varid'>tidyTyVarOcc</span><span class='hs-layout'>,</span>
<a name="line-124"></a>        <span class='hs-varid'>tidyTopType</span><span class='hs-layout'>,</span>
<a name="line-125"></a>        <span class='hs-varid'>tidyKind</span><span class='hs-layout'>,</span>
<a name="line-126"></a>        <span class='hs-varid'>tidyCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyCos</span><span class='hs-layout'>,</span>
<a name="line-127"></a>        <span class='hs-varid'>tidyTyVarBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTyVarBinders</span><span class='hs-layout'>,</span>
<a name="line-128"></a>
<a name="line-129"></a>        <span class='hs-comment'>-- * Sizes</span>
<a name="line-130"></a>        <span class='hs-varid'>typeSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>provSize</span>
<a name="line-131"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-132"></a>
<a name="line-133"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>(</span> <span class='hs-varid'>dataConFullSig</span>
<a name="line-136"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>dataConUnivTyVarBinders</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConExTyVarBinders</span>
<a name="line-137"></a>                             <span class='hs-layout'>,</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterEqSpec</span> <span class='hs-layout'>)</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span> <span class='hs-varid'>isPredTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoercionTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCastTy</span>
<a name="line-139"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesWellScoped</span>
<a name="line-140"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeWellScoped</span>
<a name="line-141"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>coreView</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeKind</span> <span class='hs-layout'>)</span>
<a name="line-142"></a>   <span class='hs-comment'>-- Transitively pulls in a LOT of stuff, better to break the loop</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>Coercion</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>ConLike</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ConLike</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>conLikeName</span> <span class='hs-layout'>)</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>ToIface</span><span class='hs-layout'>(</span> <span class='hs-varid'>toIfaceTypeX</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceTyLit</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceForAllBndr</span>
<a name="line-147"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceTcArgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceCoercion</span> <span class='hs-layout'>)</span>
<a name="line-148"></a>
<a name="line-149"></a><span class='hs-comment'>-- friends:</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IfaceType</span>
<a name="line-151"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>)</span>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FV</span>
<a name="line-159"></a>
<a name="line-160"></a><span class='hs-comment'>-- others</span>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-layout'>(</span> <span class='hs-conid'>LeftOrRight</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyPrec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeParen</span><span class='hs-layout'>,</span> <span class='hs-varid'>pickLR</span> <span class='hs-layout'>)</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-163"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-164"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-165"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-167"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-168"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-169"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-170"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-171"></a>
<a name="line-172"></a><span class='hs-comment'>-- libraries</span>
<a name="line-173"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>)</span>
<a name="line-174"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-175"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- for CoercionHole</span>
<a name="line-176"></a>
<a name="line-177"></a><span class='hs-comment'>{-
<a name="line-178"></a>%************************************************************************
<a name="line-179"></a>%*                                                                      *
<a name="line-180"></a>                        TyThing
<a name="line-181"></a>%*                                                                      *
<a name="line-182"></a>%************************************************************************
<a name="line-183"></a>
<a name="line-184"></a>Despite the fact that DataCon has to be imported via a hi-boot route,
<a name="line-185"></a>this module seems the right place for TyThing, because it's needed for
<a name="line-186"></a>funTyCon and all the types in TysPrim.
<a name="line-187"></a>
<a name="line-188"></a>It is also SOURCE-imported into Name.hs
<a name="line-189"></a>
<a name="line-190"></a>
<a name="line-191"></a>Note [ATyCon for classes]
<a name="line-192"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-193"></a>Both classes and type constructors are represented in the type environment
<a name="line-194"></a>as ATyCon.  You can tell the difference, and get to the class, with
<a name="line-195"></a>   isClassTyCon :: TyCon -&gt; Bool
<a name="line-196"></a>   tyConClass_maybe :: TyCon -&gt; Maybe Class
<a name="line-197"></a>The Class and its associated TyCon have the same Name.
<a name="line-198"></a>-}</span>
<a name="line-199"></a>
<a name="line-200"></a><a name="TyThing"></a><span class='hs-comment'>-- | A global typecheckable-thing, essentially anything that has a name.</span>
<a name="line-201"></a><a name="TyThing"></a><span class='hs-comment'>-- Not to be confused with a 'TcTyThing', which is also a typecheckable</span>
<a name="line-202"></a><a name="TyThing"></a><span class='hs-comment'>-- thing but in the *local* context.  See 'TcEnv' for how to retrieve</span>
<a name="line-203"></a><a name="TyThing"></a><span class='hs-comment'>-- a 'TyThing' given a 'Name'.</span>
<a name="line-204"></a><a name="TyThing"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyThing</span>
<a name="line-205"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnId</span>     <span class='hs-conid'>Id</span>
<a name="line-206"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AConLike</span> <span class='hs-conid'>ConLike</span>
<a name="line-207"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyCon</span>   <span class='hs-conid'>TyCon</span>       <span class='hs-comment'>-- TyCons and classes; see Note [ATyCon for classes]</span>
<a name="line-208"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ACoAxiom</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>)</span>
<a name="line-209"></a>
<a name="line-210"></a><a name="instance%20Outputable%20TyThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyword'>where</span>
<a name="line-211"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprShortTyThing</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="instance%20NamedThing%20TyThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NamedThing</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyword'>where</span>       <span class='hs-comment'>-- Can't put this with the type</span>
<a name="line-214"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>id</span>    <span class='hs-comment'>-- decl, because the DataCon instance</span>
<a name="line-215"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tc</span>    <span class='hs-comment'>-- isn't visible there</span>
<a name="line-216"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ACoAxiom</span> <span class='hs-varid'>cc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>cc</span>
<a name="line-217"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-varid'>cl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>conLikeName</span> <span class='hs-varid'>cl</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="pprShortTyThing"></a><span class='hs-definition'>pprShortTyThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-220"></a><span class='hs-comment'>-- c.f. PprTyThing.pprTyThing, which prints all the details</span>
<a name="line-221"></a><span class='hs-definition'>pprShortTyThing</span> <span class='hs-varid'>thing</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyThingCategory</span> <span class='hs-varid'>thing</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-223"></a>
<a name="line-224"></a><a name="pprTyThingCategory"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-225"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-varid'>capitalise</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyThingCategory</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="tyThingCategory"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-228"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-229"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isClassTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"class"</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-str'>"type constructor"</span>
<a name="line-231"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ACoAxiom</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"coercion axiom"</span>
<a name="line-232"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span>   <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-str'>"identifier"</span>
<a name="line-233"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"data constructor"</span>
<a name="line-234"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-str'>"pattern synonym"</span>
<a name="line-235"></a>
<a name="line-236"></a>
<a name="line-237"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-238"></a>*                                                                       *
<a name="line-239"></a>                        Type
<a name="line-240"></a>*                                                                       *
<a name="line-241"></a>********************************************************************** -}</span>
<a name="line-242"></a>
<a name="line-243"></a><span class='hs-comment'>-- | The key representation of types within the compiler</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="KindOrType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>KindOrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- See Note [Arguments to type constructors]</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="Kind"></a><span class='hs-comment'>-- | The key type representing kinds in the compiler.</span>
<a name="line-248"></a><a name="Kind"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="Type"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-251"></a><a name="Type"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span>
<a name="line-252"></a><a name="Type"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Type</span>
<a name="line-253"></a>  <span class='hs-comment'>-- See Note [Non-trivial definitional equality]</span>
<a name="line-254"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-conid'>Var</span> <span class='hs-comment'>-- ^ Vanilla type or kind variable (*never* a coercion variable)</span>
<a name="line-255"></a>
<a name="line-256"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppTy</span>
<a name="line-257"></a>        <span class='hs-conid'>Type</span>
<a name="line-258"></a>        <span class='hs-conid'>Type</span>            <span class='hs-comment'>-- ^ Type application to something other than a 'TyCon'. Parameters:</span>
<a name="line-259"></a>                        <span class='hs-comment'>--</span>
<a name="line-260"></a>                        <span class='hs-comment'>--  1) Function: must /not/ be a 'TyConApp',</span>
<a name="line-261"></a>                        <span class='hs-comment'>--     must be another 'AppTy', or 'TyVarTy'</span>
<a name="line-262"></a>                        <span class='hs-comment'>--</span>
<a name="line-263"></a>                        <span class='hs-comment'>--  2) Argument type</span>
<a name="line-264"></a>
<a name="line-265"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span>
<a name="line-266"></a>        <span class='hs-conid'>TyCon</span>
<a name="line-267"></a>        <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindOrType</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ Application of a 'TyCon', including newtypes /and/ synonyms.</span>
<a name="line-268"></a>                        <span class='hs-comment'>-- Invariant: saturated applications of 'FunTyCon' must</span>
<a name="line-269"></a>                        <span class='hs-comment'>-- use 'FunTy' and saturated synonyms must use their own</span>
<a name="line-270"></a>                        <span class='hs-comment'>-- constructors. However, /unsaturated/ 'FunTyCon's</span>
<a name="line-271"></a>                        <span class='hs-comment'>-- do appear as 'TyConApp's.</span>
<a name="line-272"></a>                        <span class='hs-comment'>-- Parameters:</span>
<a name="line-273"></a>                        <span class='hs-comment'>--</span>
<a name="line-274"></a>                        <span class='hs-comment'>-- 1) Type constructor being applied to.</span>
<a name="line-275"></a>                        <span class='hs-comment'>--</span>
<a name="line-276"></a>                        <span class='hs-comment'>-- 2) Type arguments. Might not have enough type arguments</span>
<a name="line-277"></a>                        <span class='hs-comment'>--    here to saturate the constructor.</span>
<a name="line-278"></a>                        <span class='hs-comment'>--    Even type synonyms are not necessarily saturated;</span>
<a name="line-279"></a>                        <span class='hs-comment'>--    for example unsaturated type synonyms</span>
<a name="line-280"></a>                        <span class='hs-comment'>--    can appear as the right hand side of a type synonym.</span>
<a name="line-281"></a>
<a name="line-282"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span>
<a name="line-283"></a>        <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>TyVarBinder</span>
<a name="line-284"></a>        <span class='hs-conid'>Type</span>            <span class='hs-comment'>-- ^ A Π type.</span>
<a name="line-285"></a>
<a name="line-286"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunTy</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>     <span class='hs-comment'>-- ^ t1 -&gt; t2   Very common, so an important special case</span>
<a name="line-287"></a>
<a name="line-288"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LitTy</span> <span class='hs-conid'>TyLit</span>     <span class='hs-comment'>-- ^ Type literals are similar to type constructors.</span>
<a name="line-289"></a>
<a name="line-290"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CastTy</span>
<a name="line-291"></a>        <span class='hs-conid'>Type</span>
<a name="line-292"></a>        <span class='hs-conid'>KindCoercion</span>  <span class='hs-comment'>-- ^ A kind cast. The coercion is always nominal.</span>
<a name="line-293"></a>                      <span class='hs-comment'>-- INVARIANT: The cast is never refl.</span>
<a name="line-294"></a>                      <span class='hs-comment'>-- INVARIANT: The cast is "pushed down" as far as it</span>
<a name="line-295"></a>                      <span class='hs-comment'>-- can go. See Note [Pushing down casts]</span>
<a name="line-296"></a>
<a name="line-297"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoercionTy</span>
<a name="line-298"></a>        <span class='hs-conid'>Coercion</span>    <span class='hs-comment'>-- ^ Injection of a Coercion into a type</span>
<a name="line-299"></a>                    <span class='hs-comment'>-- This should only ever be used in the RHS of an AppTy,</span>
<a name="line-300"></a>                    <span class='hs-comment'>-- in the list of a TyConApp, when applying a promoted</span>
<a name="line-301"></a>                    <span class='hs-comment'>-- GADT data constructor</span>
<a name="line-302"></a>
<a name="line-303"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-304"></a>
<a name="line-305"></a>
<a name="line-306"></a><a name="TyLit"></a><span class='hs-comment'>-- NOTE:  Other parts of the code assume that type literals do not contain</span>
<a name="line-307"></a><a name="TyLit"></a><span class='hs-comment'>-- types or type variables.</span>
<a name="line-308"></a><a name="TyLit"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyLit</span>
<a name="line-309"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NumTyLit</span> <span class='hs-conid'>Integer</span>
<a name="line-310"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StrTyLit</span> <span class='hs-conid'>FastString</span>
<a name="line-311"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>)</span>
<a name="line-312"></a>
<a name="line-313"></a><span class='hs-comment'>{- Note [Arguments to type constructors]
<a name="line-314"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-315"></a>Because of kind polymorphism, in addition to type application we now
<a name="line-316"></a>have kind instantiation. We reuse the same notations to do so.
<a name="line-317"></a>
<a name="line-318"></a>For example:
<a name="line-319"></a>
<a name="line-320"></a>  Just (* -&gt; *) Maybe
<a name="line-321"></a>  Right * Nat Zero
<a name="line-322"></a>
<a name="line-323"></a>are represented by:
<a name="line-324"></a>
<a name="line-325"></a>  TyConApp (PromotedDataCon Just) [* -&gt; *, Maybe]
<a name="line-326"></a>  TyConApp (PromotedDataCon Right) [*, Nat, (PromotedDataCon Zero)]
<a name="line-327"></a>
<a name="line-328"></a>Important note: Nat is used as a *kind* and not as a type. This can be
<a name="line-329"></a>confusing, since type-level Nat and kind-level Nat are identical. We
<a name="line-330"></a>use the kind of (PromotedDataCon Right) to know if its arguments are
<a name="line-331"></a>kinds or types.
<a name="line-332"></a>
<a name="line-333"></a>This kind instantiation only happens in TyConApp currently.
<a name="line-334"></a>
<a name="line-335"></a>Note [Pushing down casts]
<a name="line-336"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-337"></a>Suppose we have (a :: k1 -&gt; *), (b :: k1), and (co :: * ~ q).
<a name="line-338"></a>The type (a b |&gt; co) is `eqType` to ((a |&gt; co') b), where
<a name="line-339"></a>co' = (-&gt;) &lt;k1&gt; co. Thus, to make this visible to functions
<a name="line-340"></a>that inspect types, we always push down coercions, preferring
<a name="line-341"></a>the second form. Note that this also applies to TyConApps!
<a name="line-342"></a>
<a name="line-343"></a>Note [Non-trivial definitional equality]
<a name="line-344"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-345"></a>Is Int |&gt; &lt;*&gt; the same as Int? YES! In order to reduce headaches,
<a name="line-346"></a>we decide that any reflexive casts in types are just ignored. More
<a name="line-347"></a>generally, the `eqType` function, which defines Core's type equality
<a name="line-348"></a>relation, ignores casts and coercion arguments, as long as the
<a name="line-349"></a>two types have the same kind. This allows us to be a little sloppier
<a name="line-350"></a>in keeping track of coercions, which is a good thing. It also means
<a name="line-351"></a>that eqType does not depend on eqCoercion, which is also a good thing.
<a name="line-352"></a>
<a name="line-353"></a>Why is this sensible? That is, why is something different than α-equivalence
<a name="line-354"></a>appropriate for the implementation of eqType?
<a name="line-355"></a>
<a name="line-356"></a>Anything smaller than ~ and homogeneous is an appropriate definition for
<a name="line-357"></a>equality. The type safety of FC depends only on ~. Let's say η : τ ~ σ. Any
<a name="line-358"></a>expression of type τ can be transmuted to one of type σ at any point by
<a name="line-359"></a>casting. The same is true of types of type τ. So in some sense, τ and σ are
<a name="line-360"></a>interchangeable.
<a name="line-361"></a>
<a name="line-362"></a>But let's be more precise. If we examine the typing rules of FC (say, those in
<a name="line-363"></a><a href="http://www.cis.upenn.edu/~eir/papers/2015/equalities/equalities-extended.pdf)">http://www.cis.upenn.edu/~eir/papers/2015/equalities/equalities-extended.pdf)</a>
<a name="line-364"></a>there are several places where the same metavariable is used in two different
<a name="line-365"></a>premises to a rule. (For example, see Ty_App.) There is an implicit equality
<a name="line-366"></a>check here. What definition of equality should we use? By convention, we use
<a name="line-367"></a>α-equivalence. Take any rule with one (or more) of these implicit equality
<a name="line-368"></a>checks. Then there is an admissible rule that uses ~ instead of the implicit
<a name="line-369"></a>check, adding in casts as appropriate.
<a name="line-370"></a>
<a name="line-371"></a>The only problem here is that ~ is heterogeneous. To make the kinds work out
<a name="line-372"></a>in the admissible rule that uses ~, it is necessary to homogenize the
<a name="line-373"></a>coercions. That is, if we have η : (τ : κ1) ~ (σ : κ2), then we don't use η;
<a name="line-374"></a>we use η |&gt; kind η, which is homogeneous.
<a name="line-375"></a>
<a name="line-376"></a>The effect of this all is that eqType, the implementation of the implicit
<a name="line-377"></a>equality check, can use any homogeneous relation that is smaller than ~, as
<a name="line-378"></a>those rules must also be admissible.
<a name="line-379"></a>
<a name="line-380"></a>What would go wrong if we insisted on the casts matching? See the beginning of
<a name="line-381"></a>Section 8 in the unpublished paper above. Theoretically, nothing at all goes
<a name="line-382"></a>wrong. But in practical terms, getting the coercions right proved to be
<a name="line-383"></a>nightmarish. And types would explode: during kind-checking, we often produce
<a name="line-384"></a>reflexive kind coercions. When we try to cast by these, mkCastTy just discards
<a name="line-385"></a>them. But if we used an eqType that distinguished between Int and Int |&gt; &lt;*&gt;,
<a name="line-386"></a>then we couldn't discard -- the output of kind-checking would be enormous,
<a name="line-387"></a>and we would need enormous casts with lots of CoherenceCo's to straighten
<a name="line-388"></a>them out.
<a name="line-389"></a>
<a name="line-390"></a>Would anything go wrong if eqType respected type families? No, not at all. But
<a name="line-391"></a>that makes eqType rather hard to implement.
<a name="line-392"></a>
<a name="line-393"></a>Thus, the guideline for eqType is that it should be the largest
<a name="line-394"></a>easy-to-implement relation that is still smaller than ~ and homogeneous. The
<a name="line-395"></a>precise choice of relation is somewhat incidental, as long as the smart
<a name="line-396"></a>constructors and destructors in Type respect whatever relation is chosen.
<a name="line-397"></a>
<a name="line-398"></a>Another helpful principle with eqType is this:
<a name="line-399"></a>
<a name="line-400"></a> ** If (t1 eqType t2) then I can replace t1 by t2 anywhere. **
<a name="line-401"></a>
<a name="line-402"></a>This principle also tells us that eqType must relate only types with the
<a name="line-403"></a>same kinds.
<a name="line-404"></a>-}</span>
<a name="line-405"></a>
<a name="line-406"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-407"></a>*                                                                       *
<a name="line-408"></a>                  TyBinder and ArgFlag
<a name="line-409"></a>*                                                                       *
<a name="line-410"></a>********************************************************************** -}</span>
<a name="line-411"></a>
<a name="line-412"></a><a name="TyBinder"></a><span class='hs-comment'>-- | A 'TyBinder' represents an argument to a function. TyBinders can be dependent</span>
<a name="line-413"></a><a name="TyBinder"></a><span class='hs-comment'>-- ('Named') or nondependent ('Anon'). They may also be visible or not.</span>
<a name="line-414"></a><a name="TyBinder"></a><span class='hs-comment'>-- See Note [TyBinders]</span>
<a name="line-415"></a><a name="TyBinder"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyBinder</span>
<a name="line-416"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Named</span> <span class='hs-conid'>TyVarBinder</span>   <span class='hs-comment'>-- A type-lambda binder</span>
<a name="line-417"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Anon</span> <span class='hs-conid'>Type</span>           <span class='hs-comment'>-- A term-lambda binder</span>
<a name="line-418"></a>                        <span class='hs-comment'>-- Visibility is determined by the type (Constraint vs. *)</span>
<a name="line-419"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-420"></a>
<a name="line-421"></a><a name="delBinderVar"></a><span class='hs-comment'>-- | Remove the binder's variable from the set, if the binder has</span>
<a name="line-422"></a><span class='hs-comment'>-- a variable.</span>
<a name="line-423"></a><span class='hs-definition'>delBinderVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-424"></a><span class='hs-definition'>delBinderVar</span> <span class='hs-varid'>vars</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span>
<a name="line-425"></a>
<a name="line-426"></a><a name="isInvisibleBinder"></a><span class='hs-comment'>-- | Does this binder bind an invisible argument?</span>
<a name="line-427"></a><span class='hs-definition'>isInvisibleBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-428"></a><span class='hs-definition'>isInvisibleBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isInvisibleArgFlag</span> <span class='hs-varid'>vis</span>
<a name="line-429"></a><span class='hs-definition'>isInvisibleBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>ty</span>
<a name="line-430"></a>
<a name="line-431"></a><a name="isVisibleBinder"></a><span class='hs-comment'>-- | Does this binder bind a visible argument?</span>
<a name="line-432"></a><span class='hs-definition'>isVisibleBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-433"></a><span class='hs-definition'>isVisibleBinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isInvisibleBinder</span>
<a name="line-434"></a>
<a name="line-435"></a>
<a name="line-436"></a><span class='hs-comment'>{- Note [TyBinders]
<a name="line-437"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-438"></a>A ForAllTy contains a TyVarBinder.  But a type can be decomposed
<a name="line-439"></a>to a telescope consisting of a [TyBinder]
<a name="line-440"></a>
<a name="line-441"></a>A TyBinder represents the type of binders -- that is, the type of an
<a name="line-442"></a>argument to a Pi-type. GHC Core currently supports two different
<a name="line-443"></a>Pi-types:
<a name="line-444"></a>
<a name="line-445"></a> * A non-dependent function type,
<a name="line-446"></a>   written with -&gt;, e.g. ty1 -&gt; ty2
<a name="line-447"></a>   represented as FunTy ty1 ty2. These are
<a name="line-448"></a>   lifted to Coercions with the corresponding FunCo.
<a name="line-449"></a>
<a name="line-450"></a> * A dependent compile-time-only polytype,
<a name="line-451"></a>   written with forall, e.g.  forall (a:*). ty
<a name="line-452"></a>   represented as ForAllTy (TvBndr a v) ty
<a name="line-453"></a>
<a name="line-454"></a>Both Pi-types classify terms/types that take an argument. In other
<a name="line-455"></a>words, if `x` is either a function or a polytype, `x arg` makes sense
<a name="line-456"></a>(for an appropriate `arg`).
<a name="line-457"></a>
<a name="line-458"></a>
<a name="line-459"></a>Note [TyBinders and ArgFlags]
<a name="line-460"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-461"></a>A ForAllTy contains a TyVarBinder.  Each TyVarBinder is equipped
<a name="line-462"></a>with a ArgFlag, which says whether or not arguments for this
<a name="line-463"></a>binder should be visible (explicit) in source Haskell.
<a name="line-464"></a>
<a name="line-465"></a>-----------------------------------------------------------------------
<a name="line-466"></a>                                            Occurrences look like this
<a name="line-467"></a> TyBinder          GHC displays type as     in Haskell souce code
<a name="line-468"></a>-----------------------------------------------------------------------
<a name="line-469"></a>In the type of a term
<a name="line-470"></a> Anon:             f :: type -&gt; type         Arg required:     f x
<a name="line-471"></a> Named Inferred:   f :: forall {a}. type     Arg not allowed:  f
<a name="line-472"></a> Named Specified:  f :: forall a. type       Arg optional:     f  or  f @Int
<a name="line-473"></a> Named Required:         Illegal: See Note [No Required TyBinder in terms]
<a name="line-474"></a>
<a name="line-475"></a>In the kind of a type
<a name="line-476"></a> Anon:             T :: kind -&gt; kind         Required:            T *
<a name="line-477"></a> Named Inferred:   T :: forall {k}. kind     Arg not allowed:     T
<a name="line-478"></a> Named Specified:  T :: forall k. kind       Arg not allowed[1]:  T
<a name="line-479"></a> Named Required:   T :: forall k -&gt; kind     Required:            T *
<a name="line-480"></a>------------------------------------------------------------------------
<a name="line-481"></a>
<a name="line-482"></a>[1] In types, in the Specified case, it would make sense to allow
<a name="line-483"></a>    optional kind applications, thus (T @*), but we have not
<a name="line-484"></a>    yet implemented that
<a name="line-485"></a>
<a name="line-486"></a>---- Examples of where the different visiblities come from -----
<a name="line-487"></a>
<a name="line-488"></a>In term declarations:
<a name="line-489"></a>
<a name="line-490"></a>* Inferred.  Function defn, with no signature:  f1 x = x
<a name="line-491"></a>  We infer f1 :: forall {a}. a -&gt; a, with 'a' Inferred
<a name="line-492"></a>  It's Inferred because it doesn't appear in any
<a name="line-493"></a>  user-written signature for f1
<a name="line-494"></a>
<a name="line-495"></a>* Specified.  Function defn, with signature (implicit forall):
<a name="line-496"></a>     f2 :: a -&gt; a; f2 x = x
<a name="line-497"></a>  So f2 gets the type f2 :: forall a. a-&gt;a, with 'a' Specified
<a name="line-498"></a>  even though 'a' is not bound in the source code by an explicit forall
<a name="line-499"></a>
<a name="line-500"></a>* Specified.  Function defn, with signature (explicit forall):
<a name="line-501"></a>     f3 :: forall a. a -&gt; a; f3 x = x
<a name="line-502"></a>  So f3 gets the type f3 :: forall a. a-&gt;a, with 'a' Specified
<a name="line-503"></a>
<a name="line-504"></a>* Inferred/Specified.  Function signature with inferred kind polymorphism.
<a name="line-505"></a>     f4 :: a b -&gt; Int
<a name="line-506"></a>  So 'f4' gets the type f4 :: forall {k} (a:k-&gt;*) (b:k). a b -&gt; Int
<a name="line-507"></a>  Here 'k' is Inferred (it's not mentioned in the type),
<a name="line-508"></a>  but 'a' and 'b' are Specified.
<a name="line-509"></a>
<a name="line-510"></a>* Specified.  Function signature with explicit kind polymorphism
<a name="line-511"></a>     f5 :: a (b :: k) -&gt; Int
<a name="line-512"></a>  This time 'k' is Specified, because it is mentioned explicitly,
<a name="line-513"></a>  so we get f5 :: forall (k:*) (a:k-&gt;*) (b:k). a b -&gt; Int
<a name="line-514"></a>
<a name="line-515"></a>* Similarly pattern synonyms:
<a name="line-516"></a>  Inferred - from inferred types (e.g. no pattern type signature)
<a name="line-517"></a>           - or from inferred kind polymorphism
<a name="line-518"></a>
<a name="line-519"></a>In type declarations:
<a name="line-520"></a>
<a name="line-521"></a>* Inferred (k)
<a name="line-522"></a>     data T1 a b = MkT1 (a b)
<a name="line-523"></a>  Here T1's kind is  T1 :: forall {k:*}. (k-&gt;*) -&gt; k -&gt; *
<a name="line-524"></a>  The kind variable 'k' is Inferred, since it is not mentioned
<a name="line-525"></a>
<a name="line-526"></a>  Note that 'a' and 'b' correspond to /Anon/ TyBinders in T1's kind,
<a name="line-527"></a>  and Anon binders don't have a visibility flag. (Or you could think
<a name="line-528"></a>  of Anon having an implicit Required flag.)
<a name="line-529"></a>
<a name="line-530"></a>* Specified (k)
<a name="line-531"></a>     data T2 (a::k-&gt;*) b = MkT (a b)
<a name="line-532"></a>  Here T's kind is  T :: forall (k:*). (k-&gt;*) -&gt; k -&gt; *
<a name="line-533"></a>  The kind variable 'k' is Specified, since it is mentioned in
<a name="line-534"></a>  the signature.
<a name="line-535"></a>
<a name="line-536"></a>* Required (k)
<a name="line-537"></a>     data T k (a::k-&gt;*) b = MkT (a b)
<a name="line-538"></a>  Here T's kind is  T :: forall k:* -&gt; (k-&gt;*) -&gt; k -&gt; *
<a name="line-539"></a>  The kind is Required, since it bound in a positional way in T's declaration
<a name="line-540"></a>  Every use of T must be explicitly applied to a kind
<a name="line-541"></a>
<a name="line-542"></a>* Inferred (k1), Specified (k)
<a name="line-543"></a>     data T a b (c :: k) = MkT (a b) (Proxy c)
<a name="line-544"></a>  Here T's kind is  T :: forall {k1:*} (k:*). (k1-&gt;*) -&gt; k1 -&gt; k -&gt; *
<a name="line-545"></a>  So 'k' is Specified, because it appears explicitly,
<a name="line-546"></a>  but 'k1' is Inferred, because it does not
<a name="line-547"></a>
<a name="line-548"></a>---- Printing -----
<a name="line-549"></a>
<a name="line-550"></a> We print forall types with enough syntax to tell you their visiblity
<a name="line-551"></a> flag.  But this is not source Haskell, and these types may not all
<a name="line-552"></a> be parsable.
<a name="line-553"></a>
<a name="line-554"></a> Specified: a list of Specified binders is written between `forall` and `.`:
<a name="line-555"></a>               const :: forall a b. a -&gt; b -&gt; a
<a name="line-556"></a>
<a name="line-557"></a> Inferred:  with -fprint-explicit-foralls, Inferred binders are written
<a name="line-558"></a>            in braces:
<a name="line-559"></a>               f :: forall {k} (a:k). S k a -&gt; Int
<a name="line-560"></a>            Otherwise, they are printed like Specified binders.
<a name="line-561"></a>
<a name="line-562"></a> Required: binders are put between `forall` and `-&gt;`:
<a name="line-563"></a>              T :: forall k -&gt; *
<a name="line-564"></a>
<a name="line-565"></a>---- Other points -----
<a name="line-566"></a>
<a name="line-567"></a>* In classic Haskell, all named binders (that is, the type variables in
<a name="line-568"></a>  a polymorphic function type f :: forall a. a -&gt; a) have been Inferred.
<a name="line-569"></a>
<a name="line-570"></a>* Inferred variables correspond to "generalized" variables from the
<a name="line-571"></a>  Visible Type Applications paper (ESOP'16).
<a name="line-572"></a>
<a name="line-573"></a>Note [No Required TyBinder in terms]
<a name="line-574"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-575"></a>We don't allow Required foralls for term variables, including pattern
<a name="line-576"></a>synonyms and data constructors.  Why?  Because then an application
<a name="line-577"></a>would need a /compulsory/ type argument (possibly without an "@"?),
<a name="line-578"></a>thus (f Int); and we don't have concrete syntax for that.
<a name="line-579"></a>
<a name="line-580"></a>We could change this decision, but Required, Named TyBinders are rare
<a name="line-581"></a>anyway.  (Most are Anons.)
<a name="line-582"></a>-}</span>
<a name="line-583"></a>
<a name="line-584"></a>
<a name="line-585"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-586"></a>*                                                                       *
<a name="line-587"></a>                        PredType
<a name="line-588"></a>*                                                                       *
<a name="line-589"></a>********************************************************************** -}</span>
<a name="line-590"></a>
<a name="line-591"></a>
<a name="line-592"></a><a name="PredType"></a><span class='hs-comment'>-- | A type of the form @p@ of kind @Constraint@ represents a value whose type is</span>
<a name="line-593"></a><a name="PredType"></a><span class='hs-comment'>-- the Haskell predicate @p@, where a predicate is what occurs before</span>
<a name="line-594"></a><a name="PredType"></a><span class='hs-comment'>-- the @=&gt;@ in a Haskell type.</span>
<a name="line-595"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-596"></a><a name="PredType"></a><span class='hs-comment'>-- We use 'PredType' as documentation to mark those types that we guarantee to have</span>
<a name="line-597"></a><a name="PredType"></a><span class='hs-comment'>-- this kind.</span>
<a name="line-598"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-599"></a><a name="PredType"></a><span class='hs-comment'>-- It can be expanded into its representation, but:</span>
<a name="line-600"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-601"></a><a name="PredType"></a><span class='hs-comment'>-- * The type checker must treat it as opaque</span>
<a name="line-602"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-603"></a><a name="PredType"></a><span class='hs-comment'>-- * The rest of the compiler treats it as transparent</span>
<a name="line-604"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-605"></a><a name="PredType"></a><span class='hs-comment'>-- Consider these examples:</span>
<a name="line-606"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-607"></a><a name="PredType"></a><span class='hs-comment'>-- &gt; f :: (Eq a) =&gt; a -&gt; Int</span>
<a name="line-608"></a><a name="PredType"></a><span class='hs-comment'>-- &gt; g :: (?x :: Int -&gt; Int) =&gt; a -&gt; Int</span>
<a name="line-609"></a><a name="PredType"></a><span class='hs-comment'>-- &gt; h :: (r\l) =&gt; {r} =&gt; {l::Int | r}</span>
<a name="line-610"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-611"></a><a name="PredType"></a><span class='hs-comment'>-- Here the @Eq a@ and @?x :: Int -&gt; Int@ and @r\l@ are all called \"predicates\"</span>
<a name="line-612"></a><a name="PredType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>
<a name="line-613"></a>
<a name="line-614"></a><a name="ThetaType"></a><span class='hs-comment'>-- | A collection of 'PredType's</span>
<a name="line-615"></a><a name="ThetaType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-616"></a>
<a name="line-617"></a><span class='hs-comment'>{-
<a name="line-618"></a>(We don't support TREX records yet, but the setup is designed
<a name="line-619"></a>to expand to allow them.)
<a name="line-620"></a>
<a name="line-621"></a>A Haskell qualified type, such as that for f,g,h above, is
<a name="line-622"></a>represented using
<a name="line-623"></a>        * a FunTy for the double arrow
<a name="line-624"></a>        * with a type of kind Constraint as the function argument
<a name="line-625"></a>
<a name="line-626"></a>The predicate really does turn into a real extra argument to the
<a name="line-627"></a>function.  If the argument has type (p :: Constraint) then the predicate p is
<a name="line-628"></a>represented by evidence of type p.
<a name="line-629"></a>
<a name="line-630"></a>
<a name="line-631"></a>%************************************************************************
<a name="line-632"></a>%*                                                                      *
<a name="line-633"></a>            Simple constructors
<a name="line-634"></a>%*                                                                      *
<a name="line-635"></a>%************************************************************************
<a name="line-636"></a>
<a name="line-637"></a>These functions are here so that they can be used by TysPrim,
<a name="line-638"></a>which in turn is imported by Type
<a name="line-639"></a>-}</span>
<a name="line-640"></a>
<a name="line-641"></a><a name="mkTyVarTy"></a><span class='hs-comment'>-- named with "Only" to prevent naive use of mkTyVarTy</span>
<a name="line-642"></a><span class='hs-definition'>mkTyVarTy</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-643"></a><span class='hs-definition'>mkTyVarTy</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-644"></a>                  <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span>
<a name="line-645"></a>
<a name="line-646"></a><a name="mkTyVarTys"></a><span class='hs-definition'>mkTyVarTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-647"></a><span class='hs-definition'>mkTyVarTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-comment'>-- a common use of mkTyVarTy</span>
<a name="line-648"></a>
<a name="line-649"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>3</span> <span class='hs-varop'>`mkFunTy`</span>      <span class='hs-comment'>-- Associates to the right</span>
<a name="line-650"></a><a name="mkFunTy"></a><span class='hs-comment'>-- | Make an arrow type</span>
<a name="line-651"></a><span class='hs-definition'>mkFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-652"></a><span class='hs-definition'>mkFunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span>
<a name="line-653"></a>
<a name="line-654"></a><a name="mkFunTys"></a><span class='hs-comment'>-- | Make nested arrow types</span>
<a name="line-655"></a><span class='hs-definition'>mkFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-656"></a><span class='hs-definition'>mkFunTys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span>
<a name="line-657"></a>
<a name="line-658"></a><a name="mkForAllTy"></a><span class='hs-definition'>mkForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-659"></a><span class='hs-definition'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-660"></a>
<a name="line-661"></a><a name="mkForAllTys"></a><span class='hs-comment'>-- | Wraps foralls over the type using the provided 'TyVar's from left to right</span>
<a name="line-662"></a><span class='hs-definition'>mkForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVarBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-663"></a><span class='hs-definition'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tyvars</span>
<a name="line-664"></a>
<a name="line-665"></a><a name="mkPiTy"></a><span class='hs-definition'>mkPiTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-666"></a><span class='hs-definition'>mkPiTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-667"></a><span class='hs-definition'>mkPiTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>tvb</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tvb</span> <span class='hs-varid'>ty</span>
<a name="line-668"></a>
<a name="line-669"></a><a name="mkPiTys"></a><span class='hs-definition'>mkPiTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-670"></a><span class='hs-definition'>mkPiTys</span> <span class='hs-varid'>tbs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkPiTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tbs</span>
<a name="line-671"></a>
<a name="line-672"></a><a name="isCoercionType"></a><span class='hs-comment'>-- | Does this type classify a core (unlifted) Coercion?</span>
<a name="line-673"></a><span class='hs-comment'>-- At either role nominal or representational</span>
<a name="line-674"></a><span class='hs-comment'>--    (t1 ~# t2) or (t1 ~R# t2)</span>
<a name="line-675"></a><span class='hs-definition'>isCoercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-676"></a><span class='hs-definition'>isCoercionType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-677"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span><span class='hs-layout'>)</span>
<a name="line-678"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>==</span> <span class='hs-num'>4</span>
<a name="line-679"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-680"></a><span class='hs-definition'>isCoercionType</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-681"></a>
<a name="line-682"></a>
<a name="line-683"></a><a name="mkTyConTy"></a><span class='hs-comment'>-- | Create the plain type constructor type which has been applied to no type arguments at all.</span>
<a name="line-684"></a><span class='hs-definition'>mkTyConTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-685"></a><span class='hs-definition'>mkTyConTy</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-conid'>[]</span>
<a name="line-686"></a>
<a name="line-687"></a><span class='hs-comment'>{-
<a name="line-688"></a>Some basic functions, put here to break loops eg with the pretty printer
<a name="line-689"></a>-}</span>
<a name="line-690"></a>
<a name="line-691"></a><a name="is_TYPE"></a><span class='hs-definition'>is_TYPE</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span>   <span class='hs-conid'>Type</span>    <span class='hs-comment'>-- the single argument to TYPE; not a synonym</span>
<a name="line-692"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- what to return</span>
<a name="line-693"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-694"></a><span class='hs-definition'>is_TYPE</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ki'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_TYPE</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ki'</span>
<a name="line-695"></a><span class='hs-definition'>is_TYPE</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-696"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span>
<a name="line-697"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-698"></a>    <span class='hs-keyword'>where</span>
<a name="line-699"></a>      <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-700"></a>      <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ty</span>
<a name="line-701"></a><span class='hs-definition'>is_TYPE</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-702"></a>
<a name="line-703"></a><a name="isLiftedTypeKind"></a><span class='hs-comment'>-- | This version considers Constraint to be distinct from *. Returns True</span>
<a name="line-704"></a><span class='hs-comment'>-- if the argument is equivalent to Type and False otherwise.</span>
<a name="line-705"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-706"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_TYPE</span> <span class='hs-varid'>is_lifted</span>
<a name="line-707"></a>  <span class='hs-keyword'>where</span>
<a name="line-708"></a>    <span class='hs-varid'>is_lifted</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>lifted_rep</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lifted_rep</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>liftedRepDataConKey</span>
<a name="line-709"></a>    <span class='hs-varid'>is_lifted</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-710"></a>
<a name="line-711"></a><a name="isUnliftedTypeKind"></a><span class='hs-comment'>-- | Returns True if the kind classifies unlifted types and False otherwise.</span>
<a name="line-712"></a><span class='hs-comment'>-- Note that this returns False for levity-polymorphic kinds, which may</span>
<a name="line-713"></a><span class='hs-comment'>-- be specialized to a kind that classifies unlifted types.</span>
<a name="line-714"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-715"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_TYPE</span> <span class='hs-varid'>is_unlifted</span>
<a name="line-716"></a>  <span class='hs-keyword'>where</span>
<a name="line-717"></a>    <span class='hs-varid'>is_unlifted</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>rr</span> <span class='hs-sel'>_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>rr</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>liftedRepDataConKey</span><span class='hs-layout'>)</span>
<a name="line-718"></a>    <span class='hs-varid'>is_unlifted</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-719"></a>
<a name="line-720"></a><a name="isRuntimeRepTy"></a><span class='hs-comment'>-- | Is this the type 'RuntimeRep'?</span>
<a name="line-721"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-722"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varid'>ty'</span>
<a name="line-723"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>runtimeRepTyConKey</span>
<a name="line-724"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-725"></a>
<a name="line-726"></a><a name="isRuntimeRepKindedTy"></a><span class='hs-comment'>-- | Is this a type of kind RuntimeRep? (e.g. LiftedRep)</span>
<a name="line-727"></a><span class='hs-definition'>isRuntimeRepKindedTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-728"></a><span class='hs-definition'>isRuntimeRepKindedTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varop'>.</span> <span class='hs-varid'>typeKind</span>
<a name="line-729"></a>
<a name="line-730"></a><a name="isRuntimeRepVar"></a><span class='hs-comment'>-- | Is a tyvar of type 'RuntimeRep'?</span>
<a name="line-731"></a><span class='hs-definition'>isRuntimeRepVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-732"></a><span class='hs-definition'>isRuntimeRepVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span>
<a name="line-733"></a>
<a name="line-734"></a><a name="dropRuntimeRepArgs"></a><span class='hs-comment'>-- | Drops prefix of RuntimeRep constructors in 'TyConApp's. Useful for e.g.</span>
<a name="line-735"></a><span class='hs-comment'>-- dropping 'LiftedRep arguments of unboxed tuple TyCon applications:</span>
<a name="line-736"></a><span class='hs-comment'>--</span>
<a name="line-737"></a><span class='hs-comment'>--   dropRuntimeRepArgs [ 'LiftedRep, 'IntRep</span>
<a name="line-738"></a><span class='hs-comment'>--                      , String, Int# ] == [String, Int#]</span>
<a name="line-739"></a><span class='hs-comment'>--</span>
<a name="line-740"></a><span class='hs-definition'>dropRuntimeRepArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-741"></a><span class='hs-definition'>dropRuntimeRepArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropWhile</span> <span class='hs-varid'>isRuntimeRepKindedTy</span>
<a name="line-742"></a>
<a name="line-743"></a><span class='hs-comment'>{-
<a name="line-744"></a>%************************************************************************
<a name="line-745"></a>%*                                                                      *
<a name="line-746"></a>            Coercions
<a name="line-747"></a>%*                                                                      *
<a name="line-748"></a>%************************************************************************
<a name="line-749"></a>-}</span>
<a name="line-750"></a>
<a name="line-751"></a><span class='hs-comment'>-- | A 'Coercion' is concrete evidence of the equality/convertibility</span>
<a name="line-752"></a><span class='hs-comment'>-- of two types.</span>
<a name="line-753"></a>
<a name="line-754"></a><a name="Coercion"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-755"></a><a name="Coercion"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span>
<a name="line-756"></a><a name="Coercion"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Coercion</span>
<a name="line-757"></a>  <span class='hs-comment'>-- Each constructor has a "role signature", indicating the way roles are</span>
<a name="line-758"></a>  <span class='hs-comment'>-- propagated through coercions.</span>
<a name="line-759"></a>  <span class='hs-comment'>--    -  P, N, and R stand for coercions of the given role</span>
<a name="line-760"></a>  <span class='hs-comment'>--    -  e stands for a coercion of a specific unknown role</span>
<a name="line-761"></a>  <span class='hs-comment'>--           (think "role polymorphism")</span>
<a name="line-762"></a>  <span class='hs-comment'>--    -  "e" stands for an explicit role parameter indicating role e.</span>
<a name="line-763"></a>  <span class='hs-comment'>--    -   _ stands for a parameter that is not a Role or Coercion.</span>
<a name="line-764"></a>
<a name="line-765"></a>  <span class='hs-comment'>-- These ones mirror the shape of types</span>
<a name="line-766"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Refl :: "e" -&gt; _ -&gt; e</span>
<a name="line-767"></a>    <span class='hs-conid'>Refl</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-768"></a>          <span class='hs-comment'>-- Invariant: applications of (Refl T) to a bunch of identity coercions</span>
<a name="line-769"></a>          <span class='hs-comment'>--            always show up as Refl.</span>
<a name="line-770"></a>          <span class='hs-comment'>-- For example  (Refl T) (Refl a) (Refl b) shows up as (Refl (T a b)).</span>
<a name="line-771"></a>
<a name="line-772"></a>          <span class='hs-comment'>-- Applications of (Refl T) to some coercions, at least one of</span>
<a name="line-773"></a>          <span class='hs-comment'>-- which is NOT the identity, show up as TyConAppCo.</span>
<a name="line-774"></a>          <span class='hs-comment'>-- (They may not be fully saturated however.)</span>
<a name="line-775"></a>          <span class='hs-comment'>-- ConAppCo coercions (like all coercions other than Refl)</span>
<a name="line-776"></a>          <span class='hs-comment'>-- are NEVER the identity.</span>
<a name="line-777"></a>
<a name="line-778"></a>          <span class='hs-comment'>-- Use (Refl Representational _), not (SubCo (Refl Nominal _))</span>
<a name="line-779"></a>
<a name="line-780"></a>  <span class='hs-comment'>-- These ones simply lift the correspondingly-named</span>
<a name="line-781"></a>  <span class='hs-comment'>-- Type constructors into Coercions</span>
<a name="line-782"></a>
<a name="line-783"></a>  <span class='hs-comment'>-- TyConAppCo :: "e" -&gt; _ -&gt; ?? -&gt; e</span>
<a name="line-784"></a>  <span class='hs-comment'>-- See Note [TyConAppCo roles]</span>
<a name="line-785"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- lift TyConApp</span>
<a name="line-786"></a>               <span class='hs-comment'>-- The TyCon is never a synonym;</span>
<a name="line-787"></a>               <span class='hs-comment'>-- we expand synonyms eagerly</span>
<a name="line-788"></a>               <span class='hs-comment'>-- But it can be a type function</span>
<a name="line-789"></a>
<a name="line-790"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>CoercionN</span>             <span class='hs-comment'>-- lift AppTy</span>
<a name="line-791"></a>          <span class='hs-comment'>-- AppCo :: e -&gt; N -&gt; e</span>
<a name="line-792"></a>
<a name="line-793"></a>  <span class='hs-comment'>-- See Note [Forall coercions]</span>
<a name="line-794"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>KindCoercion</span> <span class='hs-conid'>Coercion</span>
<a name="line-795"></a>         <span class='hs-comment'>-- ForAllCo :: _ -&gt; N -&gt; e -&gt; e</span>
<a name="line-796"></a>
<a name="line-797"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunCo</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Coercion</span>         <span class='hs-comment'>-- lift FunTy</span>
<a name="line-798"></a>         <span class='hs-comment'>-- FunCo :: "e" -&gt; e -&gt; e -&gt; e</span>
<a name="line-799"></a>
<a name="line-800"></a>  <span class='hs-comment'>-- These are special</span>
<a name="line-801"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-conid'>CoVar</span>      <span class='hs-comment'>-- :: _ -&gt; (N or R)</span>
<a name="line-802"></a>                       <span class='hs-comment'>-- result role depends on the tycon of the variable's type</span>
<a name="line-803"></a>
<a name="line-804"></a>    <span class='hs-comment'>-- AxiomInstCo :: e -&gt; _ -&gt; [N] -&gt; e</span>
<a name="line-805"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>)</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-806"></a>     <span class='hs-comment'>-- See also [CoAxiom index]</span>
<a name="line-807"></a>     <span class='hs-comment'>-- The coercion arguments always *precisely* saturate</span>
<a name="line-808"></a>     <span class='hs-comment'>-- arity of (that branch of) the CoAxiom. If there are</span>
<a name="line-809"></a>     <span class='hs-comment'>-- any left over, we use AppCo.</span>
<a name="line-810"></a>     <span class='hs-comment'>-- See [Coercion axioms applied to coercions]</span>
<a name="line-811"></a>
<a name="line-812"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>
<a name="line-813"></a>      <span class='hs-comment'>-- :: _ -&gt; "e" -&gt; _ -&gt; _ -&gt; e</span>
<a name="line-814"></a>
<a name="line-815"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SymCo</span> <span class='hs-conid'>Coercion</span>             <span class='hs-comment'>-- :: e -&gt; e</span>
<a name="line-816"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TransCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Coercion</span>  <span class='hs-comment'>-- :: e -&gt; e -&gt; e</span>
<a name="line-817"></a>
<a name="line-818"></a>    <span class='hs-comment'>-- The number coercions should match exactly the expectations</span>
<a name="line-819"></a>    <span class='hs-comment'>-- of the CoAxiomRule (i.e., the rule is fully saturated).</span>
<a name="line-820"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-821"></a>
<a name="line-822"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NthCo</span>  <span class='hs-conid'>Int</span>         <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- Zero-indexed; decomposes (T t0 ... tn)</span>
<a name="line-823"></a>    <span class='hs-comment'>-- :: _ -&gt; e -&gt; ?? (inverse of TyConAppCo, see Note [TyConAppCo roles])</span>
<a name="line-824"></a>    <span class='hs-comment'>-- Using NthCo on a ForAllCo gives an N coercion always</span>
<a name="line-825"></a>    <span class='hs-comment'>-- See Note [NthCo and newtypes]</span>
<a name="line-826"></a>
<a name="line-827"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LRCo</span>   <span class='hs-conid'>LeftOrRight</span> <span class='hs-conid'>CoercionN</span>     <span class='hs-comment'>-- Decomposes (t_left t_right)</span>
<a name="line-828"></a>    <span class='hs-comment'>-- :: _ -&gt; N -&gt; N</span>
<a name="line-829"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>CoercionN</span>
<a name="line-830"></a>    <span class='hs-comment'>-- :: e -&gt; N -&gt; e</span>
<a name="line-831"></a>    <span class='hs-comment'>-- See Note [InstCo roles]</span>
<a name="line-832"></a>
<a name="line-833"></a>  <span class='hs-comment'>-- Coherence applies a coercion to the left-hand type of another coercion</span>
<a name="line-834"></a>  <span class='hs-comment'>-- See Note [Coherence]</span>
<a name="line-835"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoherenceCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>KindCoercion</span>
<a name="line-836"></a>     <span class='hs-comment'>-- :: e -&gt; N -&gt; e</span>
<a name="line-837"></a>
<a name="line-838"></a>  <span class='hs-comment'>-- Extract a kind coercion from a (heterogeneous) type coercion</span>
<a name="line-839"></a>  <span class='hs-comment'>-- NB: all kind coercions are Nominal</span>
<a name="line-840"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>KindCo</span> <span class='hs-conid'>Coercion</span>
<a name="line-841"></a>     <span class='hs-comment'>-- :: e -&gt; N</span>
<a name="line-842"></a>
<a name="line-843"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SubCo</span> <span class='hs-conid'>CoercionN</span>                  <span class='hs-comment'>-- Turns a ~N into a ~R</span>
<a name="line-844"></a>    <span class='hs-comment'>-- :: N -&gt; R</span>
<a name="line-845"></a>
<a name="line-846"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-847"></a>
<a name="line-848"></a><a name="CoercionN"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- always nominal</span>
<a name="line-849"></a><a name="CoercionR"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoercionR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- always representational</span>
<a name="line-850"></a><a name="CoercionP"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoercionP</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- always phantom</span>
<a name="line-851"></a><a name="KindCoercion"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>KindCoercion</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionN</span>   <span class='hs-comment'>-- always nominal</span>
<a name="line-852"></a>
<a name="line-853"></a><span class='hs-comment'>{-
<a name="line-854"></a>Note [Refl invariant]
<a name="line-855"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-856"></a>Invariant 1:
<a name="line-857"></a>
<a name="line-858"></a>Coercions have the following invariant
<a name="line-859"></a>     Refl is always lifted as far as possible.
<a name="line-860"></a>
<a name="line-861"></a>You might think that a consequencs is:
<a name="line-862"></a>     Every identity coercions has Refl at the root
<a name="line-863"></a>
<a name="line-864"></a>But that's not quite true because of coercion variables.  Consider
<a name="line-865"></a>     g         where g :: Int~Int
<a name="line-866"></a>     Left h    where h :: Maybe Int ~ Maybe Int
<a name="line-867"></a>etc.  So the consequence is only true of coercions that
<a name="line-868"></a>have no coercion variables.
<a name="line-869"></a>
<a name="line-870"></a>Note [Coercion axioms applied to coercions]
<a name="line-871"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-872"></a>The reason coercion axioms can be applied to coercions and not just
<a name="line-873"></a>types is to allow for better optimization.  There are some cases where
<a name="line-874"></a>we need to be able to "push transitivity inside" an axiom in order to
<a name="line-875"></a>expose further opportunities for optimization.
<a name="line-876"></a>
<a name="line-877"></a>For example, suppose we have
<a name="line-878"></a>
<a name="line-879"></a>  C a : t[a] ~ F a
<a name="line-880"></a>  g   : b ~ c
<a name="line-881"></a>
<a name="line-882"></a>and we want to optimize
<a name="line-883"></a>
<a name="line-884"></a>  sym (C b) ; t[g] ; C c
<a name="line-885"></a>
<a name="line-886"></a>which has the kind
<a name="line-887"></a>
<a name="line-888"></a>  F b ~ F c
<a name="line-889"></a>
<a name="line-890"></a>(stopping through t[b] and t[c] along the way).
<a name="line-891"></a>
<a name="line-892"></a>We'd like to optimize this to just F g -- but how?  The key is
<a name="line-893"></a>that we need to allow axioms to be instantiated by *coercions*,
<a name="line-894"></a>not just by types.  Then we can (in certain cases) push
<a name="line-895"></a>transitivity inside the axiom instantiations, and then react
<a name="line-896"></a>opposite-polarity instantiations of the same axiom.  In this
<a name="line-897"></a>case, e.g., we match t[g] against the LHS of (C c)'s kind, to
<a name="line-898"></a>obtain the substitution  a |-&gt; g  (note this operation is sort
<a name="line-899"></a>of the dual of lifting!) and hence end up with
<a name="line-900"></a>
<a name="line-901"></a>  C g : t[b] ~ F c
<a name="line-902"></a>
<a name="line-903"></a>which indeed has the same kind as  t[g] ; C c.
<a name="line-904"></a>
<a name="line-905"></a>Now we have
<a name="line-906"></a>
<a name="line-907"></a>  sym (C b) ; C g
<a name="line-908"></a>
<a name="line-909"></a>which can be optimized to F g.
<a name="line-910"></a>
<a name="line-911"></a>Note [CoAxiom index]
<a name="line-912"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-913"></a>A CoAxiom has 1 or more branches. Each branch has contains a list
<a name="line-914"></a>of the free type variables in that branch, the LHS type patterns,
<a name="line-915"></a>and the RHS type for that branch. When we apply an axiom to a list
<a name="line-916"></a>of coercions, we must choose which branch of the axiom we wish to
<a name="line-917"></a>use, as the different branches may have different numbers of free
<a name="line-918"></a>type variables. (The number of type patterns is always the same
<a name="line-919"></a>among branches, but that doesn't quite concern us here.)
<a name="line-920"></a>
<a name="line-921"></a>The Int in the AxiomInstCo constructor is the 0-indexed number
<a name="line-922"></a>of the chosen branch.
<a name="line-923"></a>
<a name="line-924"></a>Note [Forall coercions]
<a name="line-925"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-926"></a>Constructing coercions between forall-types can be a bit tricky,
<a name="line-927"></a>because the kinds of the bound tyvars can be different.
<a name="line-928"></a>
<a name="line-929"></a>The typing rule is:
<a name="line-930"></a>
<a name="line-931"></a>
<a name="line-932"></a>  kind_co : k1 ~ k2
<a name="line-933"></a>  tv1:k1 |- co : t1 ~ t2
<a name="line-934"></a>  -------------------------------------------------------------------
<a name="line-935"></a>  ForAllCo tv1 kind_co co : all tv1:k1. t1  ~
<a name="line-936"></a>                            all tv1:k2. (t2[tv1 |-&gt; tv1 |&gt; sym kind_co])
<a name="line-937"></a>
<a name="line-938"></a>First, the TyVar stored in a ForAllCo is really an optimisation: this field
<a name="line-939"></a>should be a Name, as its kind is redundant. Thinking of the field as a Name
<a name="line-940"></a>is helpful in understanding what a ForAllCo means.
<a name="line-941"></a>
<a name="line-942"></a>The idea is that kind_co gives the two kinds of the tyvar. See how, in the
<a name="line-943"></a>conclusion, tv1 is assigned kind k1 on the left but kind k2 on the right.
<a name="line-944"></a>
<a name="line-945"></a>Of course, a type variable can't have different kinds at the same time. So,
<a name="line-946"></a>we arbitrarily prefer the first kind when using tv1 in the inner coercion
<a name="line-947"></a>co, which shows that t1 equals t2.
<a name="line-948"></a>
<a name="line-949"></a>The last wrinkle is that we need to fix the kinds in the conclusion. In
<a name="line-950"></a>t2, tv1 is assumed to have kind k1, but it has kind k2 in the conclusion of
<a name="line-951"></a>the rule. So we do a kind-fixing substitution, replacing (tv1:k1) with
<a name="line-952"></a>(tv1:k2) |&gt; sym kind_co. This substitution is slightly bizarre, because it
<a name="line-953"></a>mentions the same name with different kinds, but it *is* well-kinded, noting
<a name="line-954"></a>that `(tv1:k2) |&gt; sym kind_co` has kind k1.
<a name="line-955"></a>
<a name="line-956"></a>This all really would work storing just a Name in the ForAllCo. But we can't
<a name="line-957"></a>add Names to, e.g., VarSets, and there generally is just an impedance mismatch
<a name="line-958"></a>in a bunch of places. So we use tv1. When we need tv2, we can use
<a name="line-959"></a>setTyVarKind.
<a name="line-960"></a>
<a name="line-961"></a>Note [Coherence]
<a name="line-962"></a>~~~~~~~~~~~~~~~~
<a name="line-963"></a>The Coherence typing rule is thus:
<a name="line-964"></a>
<a name="line-965"></a>  g1 : s ~ t    s : k1    g2 : k1 ~ k2
<a name="line-966"></a>  ------------------------------------
<a name="line-967"></a>  CoherenceCo g1 g2 : (s |&gt; g2) ~ t
<a name="line-968"></a>
<a name="line-969"></a>While this looks (and is) unsymmetric, a combination of other coercion
<a name="line-970"></a>combinators can make the symmetric version.
<a name="line-971"></a>
<a name="line-972"></a>For role information, see Note [Roles and kind coercions].
<a name="line-973"></a>
<a name="line-974"></a>Note [Predicate coercions]
<a name="line-975"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-976"></a>Suppose we have
<a name="line-977"></a>   g :: a~b
<a name="line-978"></a>How can we coerce between types
<a name="line-979"></a>   ([c]~a) =&gt; [a] -&gt; c
<a name="line-980"></a>and
<a name="line-981"></a>   ([c]~b) =&gt; [b] -&gt; c
<a name="line-982"></a>where the equality predicate *itself* differs?
<a name="line-983"></a>
<a name="line-984"></a>Answer: we simply treat (~) as an ordinary type constructor, so these
<a name="line-985"></a>types really look like
<a name="line-986"></a>
<a name="line-987"></a>   ((~) [c] a) -&gt; [a] -&gt; c
<a name="line-988"></a>   ((~) [c] b) -&gt; [b] -&gt; c
<a name="line-989"></a>
<a name="line-990"></a>So the coercion between the two is obviously
<a name="line-991"></a>
<a name="line-992"></a>   ((~) [c] g) -&gt; [g] -&gt; c
<a name="line-993"></a>
<a name="line-994"></a>Another way to see this to say that we simply collapse predicates to
<a name="line-995"></a>their representation type (see Type.coreView and Type.predTypeRep).
<a name="line-996"></a>
<a name="line-997"></a>This collapse is done by mkPredCo; there is no PredCo constructor
<a name="line-998"></a>in Coercion.  This is important because we need Nth to work on
<a name="line-999"></a>predicates too:
<a name="line-1000"></a>    Nth 1 ((~) [c] g) = g
<a name="line-1001"></a>See Simplify.simplCoercionF, which generates such selections.
<a name="line-1002"></a>
<a name="line-1003"></a>Note [Roles]
<a name="line-1004"></a>~~~~~~~~~~~~
<a name="line-1005"></a>Roles are a solution to the GeneralizedNewtypeDeriving problem, articulated
<a name="line-1006"></a>in Trac #1496. The full story is in docs/core-spec/core-spec.pdf. Also, see
<a name="line-1007"></a><a href="http://ghc.haskell.org/trac/ghc/wiki/RolesImplementation">http://ghc.haskell.org/trac/ghc/wiki/RolesImplementation</a>
<a name="line-1008"></a>
<a name="line-1009"></a>Here is one way to phrase the problem:
<a name="line-1010"></a>
<a name="line-1011"></a>Given:
<a name="line-1012"></a>newtype Age = MkAge Int
<a name="line-1013"></a>type family F x
<a name="line-1014"></a>type instance F Age = Bool
<a name="line-1015"></a>type instance F Int = Char
<a name="line-1016"></a>
<a name="line-1017"></a>This compiles down to:
<a name="line-1018"></a>axAge :: Age ~ Int
<a name="line-1019"></a>axF1 :: F Age ~ Bool
<a name="line-1020"></a>axF2 :: F Int ~ Char
<a name="line-1021"></a>
<a name="line-1022"></a>Then, we can make:
<a name="line-1023"></a>(sym (axF1) ; F axAge ; axF2) :: Bool ~ Char
<a name="line-1024"></a>
<a name="line-1025"></a>Yikes!
<a name="line-1026"></a>
<a name="line-1027"></a>The solution is _roles_, as articulated in "Generative Type Abstraction and
<a name="line-1028"></a>Type-level Computation" (POPL 2010), available at
<a name="line-1029"></a><a href="http://www.seas.upenn.edu/~sweirich/papers/popl163af-weirich.pdf">http://www.seas.upenn.edu/~sweirich/papers/popl163af-weirich.pdf</a>
<a name="line-1030"></a>
<a name="line-1031"></a>The specification for roles has evolved somewhat since that paper. For the
<a name="line-1032"></a>current full details, see the documentation in docs/core-spec. Here are some
<a name="line-1033"></a>highlights.
<a name="line-1034"></a>
<a name="line-1035"></a>We label every equality with a notion of type equivalence, of which there are
<a name="line-1036"></a>three options: Nominal, Representational, and Phantom. A ground type is
<a name="line-1037"></a>nominally equivalent only with itself. A newtype (which is considered a ground
<a name="line-1038"></a>type in Haskell) is representationally equivalent to its representation.
<a name="line-1039"></a>Anything is "phantomly" equivalent to anything else. We use "N", "R", and "P"
<a name="line-1040"></a>to denote the equivalences.
<a name="line-1041"></a>
<a name="line-1042"></a>The axioms above would be:
<a name="line-1043"></a>axAge :: Age ~R Int
<a name="line-1044"></a>axF1 :: F Age ~N Bool
<a name="line-1045"></a>axF2 :: F Age ~N Char
<a name="line-1046"></a>
<a name="line-1047"></a>Then, because transitivity applies only to coercions proving the same notion
<a name="line-1048"></a>of equivalence, the above construction is impossible.
<a name="line-1049"></a>
<a name="line-1050"></a>However, there is still an escape hatch: we know that any two types that are
<a name="line-1051"></a>nominally equivalent are representationally equivalent as well. This is what
<a name="line-1052"></a>the form SubCo proves -- it "demotes" a nominal equivalence into a
<a name="line-1053"></a>representational equivalence. So, it would seem the following is possible:
<a name="line-1054"></a>
<a name="line-1055"></a>sub (sym axF1) ; F axAge ; sub axF2 :: Bool ~R Char   -- WRONG
<a name="line-1056"></a>
<a name="line-1057"></a>What saves us here is that the arguments to a type function F, lifted into a
<a name="line-1058"></a>coercion, *must* prove nominal equivalence. So, (F axAge) is ill-formed, and
<a name="line-1059"></a>we are safe.
<a name="line-1060"></a>
<a name="line-1061"></a>Roles are attached to parameters to TyCons. When lifting a TyCon into a
<a name="line-1062"></a>coercion (through TyConAppCo), we need to ensure that the arguments to the
<a name="line-1063"></a>TyCon respect their roles. For example:
<a name="line-1064"></a>
<a name="line-1065"></a>data T a b = MkT a (F b)
<a name="line-1066"></a>
<a name="line-1067"></a>If we know that a1 ~R a2, then we know (T a1 b) ~R (T a2 b). But, if we know
<a name="line-1068"></a>that b1 ~R b2, we know nothing about (T a b1) and (T a b2)! This is because
<a name="line-1069"></a>the type function F branches on b's *name*, not representation. So, we say
<a name="line-1070"></a>that 'a' has role Representational and 'b' has role Nominal. The third role,
<a name="line-1071"></a>Phantom, is for parameters not used in the type's definition. Given the
<a name="line-1072"></a>following definition
<a name="line-1073"></a>
<a name="line-1074"></a>data Q a = MkQ Int
<a name="line-1075"></a>
<a name="line-1076"></a>the Phantom role allows us to say that (Q Bool) ~R (Q Char), because we
<a name="line-1077"></a>can construct the coercion Bool ~P Char (using UnivCo).
<a name="line-1078"></a>
<a name="line-1079"></a>See the paper cited above for more examples and information.
<a name="line-1080"></a>
<a name="line-1081"></a>Note [TyConAppCo roles]
<a name="line-1082"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1083"></a>The TyConAppCo constructor has a role parameter, indicating the role at
<a name="line-1084"></a>which the coercion proves equality. The choice of this parameter affects
<a name="line-1085"></a>the required roles of the arguments of the TyConAppCo. To help explain
<a name="line-1086"></a>it, assume the following definition:
<a name="line-1087"></a>
<a name="line-1088"></a>  type instance F Int = Bool   -- Axiom axF : F Int ~N Bool
<a name="line-1089"></a>  newtype Age = MkAge Int      -- Axiom axAge : Age ~R Int
<a name="line-1090"></a>  data Foo a = MkFoo a         -- Role on Foo's parameter is Representational
<a name="line-1091"></a>
<a name="line-1092"></a>TyConAppCo Nominal Foo axF : Foo (F Int) ~N Foo Bool
<a name="line-1093"></a>  For (TyConAppCo Nominal) all arguments must have role Nominal. Why?
<a name="line-1094"></a>  So that Foo Age ~N Foo Int does *not* hold.
<a name="line-1095"></a>
<a name="line-1096"></a>TyConAppCo Representational Foo (SubCo axF) : Foo (F Int) ~R Foo Bool
<a name="line-1097"></a>TyConAppCo Representational Foo axAge       : Foo Age     ~R Foo Int
<a name="line-1098"></a>  For (TyConAppCo Representational), all arguments must have the roles
<a name="line-1099"></a>  corresponding to the result of tyConRoles on the TyCon. This is the
<a name="line-1100"></a>  whole point of having roles on the TyCon to begin with. So, we can
<a name="line-1101"></a>  have Foo Age ~R Foo Int, if Foo's parameter has role R.
<a name="line-1102"></a>
<a name="line-1103"></a>  If a Representational TyConAppCo is over-saturated (which is otherwise fine),
<a name="line-1104"></a>  the spill-over arguments must all be at Nominal. This corresponds to the
<a name="line-1105"></a>  behavior for AppCo.
<a name="line-1106"></a>
<a name="line-1107"></a>TyConAppCo Phantom Foo (UnivCo Phantom Int Bool) : Foo Int ~P Foo Bool
<a name="line-1108"></a>  All arguments must have role Phantom. This one isn't strictly
<a name="line-1109"></a>  necessary for soundness, but this choice removes ambiguity.
<a name="line-1110"></a>
<a name="line-1111"></a>The rules here dictate the roles of the parameters to mkTyConAppCo
<a name="line-1112"></a>(should be checked by Lint).
<a name="line-1113"></a>
<a name="line-1114"></a>Note [NthCo and newtypes]
<a name="line-1115"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1116"></a>Suppose we have
<a name="line-1117"></a>
<a name="line-1118"></a>  newtype N a = MkN Int
<a name="line-1119"></a>  type role N representational
<a name="line-1120"></a>
<a name="line-1121"></a>This yields axiom
<a name="line-1122"></a>
<a name="line-1123"></a>  NTCo:N :: forall a. N a ~R Int
<a name="line-1124"></a>
<a name="line-1125"></a>We can then build
<a name="line-1126"></a>
<a name="line-1127"></a>  co :: forall a b. N a ~R N b
<a name="line-1128"></a>  co = NTCo:N a ; sym (NTCo:N b)
<a name="line-1129"></a>
<a name="line-1130"></a>for any `a` and `b`. Because of the role annotation on N, if we use
<a name="line-1131"></a>NthCo, we'll get out a representational coercion. That is:
<a name="line-1132"></a>
<a name="line-1133"></a>  NthCo 0 co :: forall a b. a ~R b
<a name="line-1134"></a>
<a name="line-1135"></a>Yikes! Clearly, this is terrible. The solution is simple: forbid
<a name="line-1136"></a>NthCo to be used on newtypes if the internal coercion is representational.
<a name="line-1137"></a>
<a name="line-1138"></a>This is not just some corner case discovered by a segfault somewhere;
<a name="line-1139"></a>it was discovered in the proof of soundness of roles and described
<a name="line-1140"></a>in the "Safe Coercions" paper (ICFP '14).
<a name="line-1141"></a>
<a name="line-1142"></a>Note [InstCo roles]
<a name="line-1143"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-1144"></a>Here is (essentially) the typing rule for InstCo:
<a name="line-1145"></a>
<a name="line-1146"></a>g :: (forall a. t1) ~r (forall a. t2)
<a name="line-1147"></a>w :: s1 ~N s2
<a name="line-1148"></a>------------------------------- InstCo
<a name="line-1149"></a>InstCo g w :: (t1 [a |-&gt; s1]) ~r (t2 [a |-&gt; s2])
<a name="line-1150"></a>
<a name="line-1151"></a>Note that the Coercion w *must* be nominal. This is necessary
<a name="line-1152"></a>because the variable a might be used in a "nominal position"
<a name="line-1153"></a>(that is, a place where role inference would require a nominal
<a name="line-1154"></a>role) in t1 or t2. If we allowed w to be representational, we
<a name="line-1155"></a>could get bogus equalities.
<a name="line-1156"></a>
<a name="line-1157"></a>A more nuanced treatment might be able to relax this condition
<a name="line-1158"></a>somewhat, by checking if t1 and/or t2 use their bound variables
<a name="line-1159"></a>in nominal ways. If not, having w be representational is OK.
<a name="line-1160"></a>
<a name="line-1161"></a>
<a name="line-1162"></a>%************************************************************************
<a name="line-1163"></a>%*                                                                      *
<a name="line-1164"></a>                UnivCoProvenance
<a name="line-1165"></a>%*                                                                      *
<a name="line-1166"></a>%************************************************************************
<a name="line-1167"></a>
<a name="line-1168"></a>A UnivCo is a coercion whose proof does not directly express its role
<a name="line-1169"></a>and kind (indeed for some UnivCos, like UnsafeCoerceProv, there /is/
<a name="line-1170"></a>no proof).
<a name="line-1171"></a>
<a name="line-1172"></a>The different kinds of UnivCo are described by UnivCoProvenance.  Really
<a name="line-1173"></a>each is entirely separate, but they all share the need to represent their
<a name="line-1174"></a>role and kind, which is done in the UnivCo constructor.
<a name="line-1175"></a>
<a name="line-1176"></a>-}</span>
<a name="line-1177"></a>
<a name="line-1178"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- | For simplicity, we have just one UnivCo that represents a coercion from</span>
<a name="line-1179"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- some type to some other type, with (in general) no restrictions on the</span>
<a name="line-1180"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- type. The UnivCoProvenance specifies more exactly what the coercion really</span>
<a name="line-1181"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- is and why a program should (or shouldn't!) trust the coercion.</span>
<a name="line-1182"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- It is reasonable to consider each constructor of 'UnivCoProvenance'</span>
<a name="line-1183"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- as a totally independent coercion form; their only commonality is</span>
<a name="line-1184"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- that they don't tell you what types they coercion between. (That info</span>
<a name="line-1185"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- is in the 'UnivCo' constructor of 'Coercion'.</span>
<a name="line-1186"></a><a name="UnivCoProvenance"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UnivCoProvenance</span>
<a name="line-1187"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnsafeCoerceProv</span>   <span class='hs-comment'>-- ^ From @unsafeCoerce#@. These are unsound.</span>
<a name="line-1188"></a>
<a name="line-1189"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-conid'>KindCoercion</span> <span class='hs-comment'>-- ^ See Note [Phantom coercions]. Only in Phantom</span>
<a name="line-1190"></a>                             <span class='hs-comment'>-- roled coercions</span>
<a name="line-1191"></a>
<a name="line-1192"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-conid'>KindCoercion</span>  <span class='hs-comment'>-- ^ From the fact that any two coercions are</span>
<a name="line-1193"></a>                                 <span class='hs-comment'>--   considered equivalent. See Note [ProofIrrelProv].</span>
<a name="line-1194"></a>                                 <span class='hs-comment'>-- Can be used in Nominal or Representational coercions</span>
<a name="line-1195"></a>
<a name="line-1196"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PluginProv</span> <span class='hs-conid'>String</span>  <span class='hs-comment'>-- ^ From a plugin, which asserts that this coercion</span>
<a name="line-1197"></a>                       <span class='hs-comment'>--   is sound. The string is for the use of the plugin.</span>
<a name="line-1198"></a>
<a name="line-1199"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HoleProv</span> <span class='hs-conid'>CoercionHole</span>  <span class='hs-comment'>-- ^ See Note [Coercion holes]</span>
<a name="line-1200"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-1201"></a>
<a name="line-1202"></a><a name="instance%20Outputable%20UnivCoProvenance"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyword'>where</span>
<a name="line-1203"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>UnsafeCoerceProv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(unsafeCoerce#)"</span>
<a name="line-1204"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(phantom)"</span>
<a name="line-1205"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(proof irrel.)"</span>
<a name="line-1206"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"plugin"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1207"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"hole"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span>
<a name="line-1208"></a>
<a name="line-1209"></a><a name="CoercionHole"></a><span class='hs-comment'>-- | A coercion to be filled in by the type-checker. See Note [Coercion holes]</span>
<a name="line-1210"></a><a name="CoercionHole"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoercionHole</span>
<a name="line-1211"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-layout'>{</span> <span class='hs-varid'>chUnique</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span>   <span class='hs-comment'>-- ^ used only for debugging</span>
<a name="line-1212"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>chCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1213"></a>                 <span class='hs-layout'>}</span>
<a name="line-1214"></a>
<a name="line-1215"></a><a name="instance%20Data.Data%20CoercionHole"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyword'>where</span>
<a name="line-1216"></a>  <span class='hs-comment'>-- don't traverse?</span>
<a name="line-1217"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"CoercionHole"</span>
<a name="line-1218"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-1219"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"CoercionHole"</span>
<a name="line-1220"></a>
<a name="line-1221"></a><a name="instance%20Outputable%20CoercionHole"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyword'>where</span>
<a name="line-1222"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionHole</span> <span class='hs-varid'>u</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-1223"></a>
<a name="line-1224"></a>
<a name="line-1225"></a><span class='hs-comment'>{- Note [Phantom coercions]
<a name="line-1226"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1227"></a>Consider
<a name="line-1228"></a>     data T a = T1 | T2
<a name="line-1229"></a>Then we have
<a name="line-1230"></a>     T s ~R T t
<a name="line-1231"></a>for any old s,t. The witness for this is (TyConAppCo T Rep co),
<a name="line-1232"></a>where (co :: s ~P t) is a phantom coercion built with PhantomProv.
<a name="line-1233"></a>The role of the UnivCo is always Phantom.  The Coercion stored is the
<a name="line-1234"></a>(nominal) kind coercion between the types
<a name="line-1235"></a>   kind(s) ~N kind (t)
<a name="line-1236"></a>
<a name="line-1237"></a>Note [Coercion holes]
<a name="line-1238"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1239"></a>During typechecking, constraint solving for type classes works by
<a name="line-1240"></a>  - Generate an evidence Id,  d7 :: Num a
<a name="line-1241"></a>  - Wrap it in a Wanted constraint, [W] d7 :: Num a
<a name="line-1242"></a>  - Use the evidence Id where the evidence is needed
<a name="line-1243"></a>  - Solve the constraint later
<a name="line-1244"></a>  - When solved, add an enclosing let-binding  let d7 = .... in ....
<a name="line-1245"></a>    which actually binds d7 to the (Num a) evidence
<a name="line-1246"></a>
<a name="line-1247"></a>For equality constraints we use a different strategy.  See Note [The
<a name="line-1248"></a>equality types story] in TysPrim for background on equality constraints.
<a name="line-1249"></a>  - For boxed equality constraints, (t1 ~N t2) and (t1 ~R t2), it's just
<a name="line-1250"></a>    like type classes above. (Indeed, boxed equality constraints *are* classes.)
<a name="line-1251"></a>  - But for /unboxed/ equality constraints (t1 ~R# t2) and (t1 ~N# t2)
<a name="line-1252"></a>    we use a different plan
<a name="line-1253"></a>
<a name="line-1254"></a>For unboxed equalities:
<a name="line-1255"></a>  - Generate a CoercionHole, a mutable variable just like a unification
<a name="line-1256"></a>    variable
<a name="line-1257"></a>  - Wrap the CoercionHole in a Wanted constraint; see TcRnTypes.TcEvDest
<a name="line-1258"></a>  - Use the CoercionHole in a Coercion, via HoleProv
<a name="line-1259"></a>  - Solve the constraint later
<a name="line-1260"></a>  - When solved, fill in the CoercionHole by side effect, instead of
<a name="line-1261"></a>    doing the let-binding thing
<a name="line-1262"></a>
<a name="line-1263"></a>The main reason for all this is that there may be no good place to let-bind
<a name="line-1264"></a>the evidence for unboxed equalities:
<a name="line-1265"></a>  - We emit constraints for kind coercions, to be used
<a name="line-1266"></a>    to cast a type's kind. These coercions then must be used in types. Because
<a name="line-1267"></a>    they might appear in a top-level type, there is no place to bind these
<a name="line-1268"></a>   (unlifted) coercions in the usual way.
<a name="line-1269"></a>
<a name="line-1270"></a>  - A coercion for (forall a. t1) ~ forall a. t2) will look like
<a name="line-1271"></a>       forall a. (coercion for t1~t2)
<a name="line-1272"></a>    But the coercion for (t1~t2) may mention 'a', and we don't have let-bindings
<a name="line-1273"></a>    within coercions.  We could add them, but coercion holes are easier.
<a name="line-1274"></a>
<a name="line-1275"></a>Other notes about HoleCo:
<a name="line-1276"></a>
<a name="line-1277"></a> * INVARIANT: CoercionHole and HoleProv are used only during type checking,
<a name="line-1278"></a>   and should never appear in Core. Just like unification variables; a Type
<a name="line-1279"></a>   can contain a TcTyVar, but only during type checking. If, one day, we
<a name="line-1280"></a>   use type-level information to separate out forms that can appear during
<a name="line-1281"></a>   type-checking vs forms that can appear in core proper, holes in Core will
<a name="line-1282"></a>   be ruled out.
<a name="line-1283"></a>
<a name="line-1284"></a> * The Unique carried with a coercion hole is used solely for debugging.
<a name="line-1285"></a>
<a name="line-1286"></a> * Coercion holes can be compared for equality only like other coercions:
<a name="line-1287"></a>   only by looking at the types coerced.
<a name="line-1288"></a>
<a name="line-1289"></a> * We don't use holes for other evidence because other evidence wants to
<a name="line-1290"></a>   be /shared/. But coercions are entirely erased, so there's little
<a name="line-1291"></a>   benefit to sharing.
<a name="line-1292"></a>
<a name="line-1293"></a>Note [ProofIrrelProv]
<a name="line-1294"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-1295"></a>A ProofIrrelProv is a coercion between coercions. For example:
<a name="line-1296"></a>
<a name="line-1297"></a>  data G a where
<a name="line-1298"></a>    MkG :: G Bool
<a name="line-1299"></a>
<a name="line-1300"></a>In core, we get
<a name="line-1301"></a>
<a name="line-1302"></a>  G :: * -&gt; *
<a name="line-1303"></a>  MkG :: forall (a :: *). (a ~ Bool) -&gt; G a
<a name="line-1304"></a>
<a name="line-1305"></a>Now, consider 'MkG -- that is, MkG used in a type -- and suppose we want
<a name="line-1306"></a>a proof that ('MkG co1 a1) ~ ('MkG co2 a2). This will have to be
<a name="line-1307"></a>
<a name="line-1308"></a>  TyConAppCo Nominal MkG [co3, co4]
<a name="line-1309"></a>  where
<a name="line-1310"></a>    co3 :: co1 ~ co2
<a name="line-1311"></a>    co4 :: a1 ~ a2
<a name="line-1312"></a>
<a name="line-1313"></a>Note that
<a name="line-1314"></a>  co1 :: a1 ~ Bool
<a name="line-1315"></a>  co2 :: a2 ~ Bool
<a name="line-1316"></a>
<a name="line-1317"></a>Here,
<a name="line-1318"></a>  co3 = UnivCo (ProofIrrelProv co5) Nominal (CoercionTy co1) (CoercionTy co2)
<a name="line-1319"></a>  where
<a name="line-1320"></a>    co5 :: (a1 ~ Bool) ~ (a2 ~ Bool)
<a name="line-1321"></a>    co5 = TyConAppCo Nominal (~) [&lt;*&gt;, &lt;*&gt;, co4, &lt;Bool&gt;]
<a name="line-1322"></a>
<a name="line-1323"></a>
<a name="line-1324"></a>%************************************************************************
<a name="line-1325"></a>%*                                                                      *
<a name="line-1326"></a>                 Free variables of types and coercions
<a name="line-1327"></a>%*                                                                      *
<a name="line-1328"></a>%************************************************************************
<a name="line-1329"></a>-}</span>
<a name="line-1330"></a>
<a name="line-1331"></a><span class='hs-comment'>{- Note [Free variables of types]
<a name="line-1332"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1333"></a>The family of functions tyCoVarsOfType, tyCoVarsOfTypes etc, returns
<a name="line-1334"></a>a VarSet that is closed over the types of its variables.  More precisely,
<a name="line-1335"></a>  if    S = tyCoVarsOfType( t )
<a name="line-1336"></a>  and   (a:k) is in S
<a name="line-1337"></a>  then  tyCoVarsOftype( k ) is a subset of S
<a name="line-1338"></a>
<a name="line-1339"></a>Example: The tyCoVars of this ((a:* -&gt; k) Int) is {a, k}.
<a name="line-1340"></a>
<a name="line-1341"></a>We could /not/ close over the kinds of the variable occurrences, and
<a name="line-1342"></a>instead do so at call sites, but it seems that we always want to do
<a name="line-1343"></a>so, so it's easiest to do it here.
<a name="line-1344"></a>-}</span>
<a name="line-1345"></a>
<a name="line-1346"></a>
<a name="line-1347"></a><a name="tyCoVarsOfType"></a><span class='hs-comment'>-- | Returns free variables of a type, including kind variables as</span>
<a name="line-1348"></a><span class='hs-comment'>-- a non-deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-1349"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1350"></a><span class='hs-definition'>tyCoVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1351"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1352"></a><span class='hs-definition'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1353"></a>
<a name="line-1354"></a><a name="tyCoVarsOfTypeDSet"></a><span class='hs-comment'>-- | `tyVarsOfType` that returns free variables of a type in a deterministic</span>
<a name="line-1355"></a><span class='hs-comment'>-- set. For explanation of why using `VarSet` is not deterministic see</span>
<a name="line-1356"></a><span class='hs-comment'>-- Note [Deterministic FV] in FV.</span>
<a name="line-1357"></a><span class='hs-definition'>tyCoVarsOfTypeDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-1358"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1359"></a><span class='hs-definition'>tyCoVarsOfTypeDSet</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1360"></a>
<a name="line-1361"></a><a name="tyCoVarsOfTypeList"></a><span class='hs-comment'>-- | `tyVarsOfType` that returns free variables of a type in deterministic</span>
<a name="line-1362"></a><span class='hs-comment'>-- order. For explanation of why using `VarSet` is not deterministic see</span>
<a name="line-1363"></a><span class='hs-comment'>-- Note [Deterministic FV] in FV.</span>
<a name="line-1364"></a><span class='hs-definition'>tyCoVarsOfTypeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1365"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1366"></a><span class='hs-definition'>tyCoVarsOfTypeList</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1367"></a>
<a name="line-1368"></a><a name="tyCoFVsOfType"></a><span class='hs-comment'>-- | The worker for `tyVarsOfType` and `tyVarsOfTypeList`.</span>
<a name="line-1369"></a><span class='hs-comment'>-- The previous implementation used `unionVarSet` which is O(n+m) and can</span>
<a name="line-1370"></a><span class='hs-comment'>-- make the function quadratic.</span>
<a name="line-1371"></a><span class='hs-comment'>-- It's exported, so that it can be composed with</span>
<a name="line-1372"></a><span class='hs-comment'>-- other functions that compute free variables.</span>
<a name="line-1373"></a><span class='hs-comment'>-- See Note [FV naming conventions] in FV.</span>
<a name="line-1374"></a><span class='hs-comment'>--</span>
<a name="line-1375"></a><span class='hs-comment'>-- Eta-expanded because that makes it run faster (apparently)</span>
<a name="line-1376"></a><span class='hs-comment'>-- See Note [FV eta expansion] in FV for explanation.</span>
<a name="line-1377"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1378"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1379"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>        <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFV</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1380"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>   <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1381"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1382"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>    <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1383"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>    <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1384"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsBndr</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1385"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1386"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-1387"></a>
<a name="line-1388"></a><a name="tyCoFVsBndr"></a><span class='hs-definition'>tyCoFVsBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1389"></a><span class='hs-comment'>-- Free vars of (forall b. &lt;thing with fvs&gt;)</span>
<a name="line-1390"></a><span class='hs-definition'>tyCoFVsBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>delFV</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-1391"></a>                                <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1392"></a>
<a name="line-1393"></a><a name="tyCoVarsOfTypes"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1394"></a><span class='hs-comment'>-- a non-deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-1395"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1396"></a><span class='hs-definition'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1397"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1398"></a><span class='hs-definition'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1399"></a>
<a name="line-1400"></a><a name="tyCoVarsOfTypesSet"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1401"></a><span class='hs-comment'>-- a non-deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-1402"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1403"></a><span class='hs-definition'>tyCoVarsOfTypesSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1404"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1405"></a><span class='hs-definition'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-varid'>tys</span>
<a name="line-1406"></a>  <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here because we immediately forget the</span>
<a name="line-1407"></a>  <span class='hs-comment'>-- ordering by returning a set</span>
<a name="line-1408"></a>
<a name="line-1409"></a><a name="tyCoVarsOfTypesDSet"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1410"></a><span class='hs-comment'>-- a deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-1411"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1412"></a><span class='hs-definition'>tyCoVarsOfTypesDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-1413"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1414"></a><span class='hs-definition'>tyCoVarsOfTypesDSet</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1415"></a>
<a name="line-1416"></a><a name="tyCoVarsOfTypesList"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1417"></a><span class='hs-comment'>-- a deterministically ordered list. For type synonyms it does /not/ expand the</span>
<a name="line-1418"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1419"></a><span class='hs-definition'>tyCoVarsOfTypesList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1420"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1421"></a><span class='hs-definition'>tyCoVarsOfTypesList</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1422"></a>
<a name="line-1423"></a><a name="tyCoFVsOfTypes"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1424"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1425"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1426"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-conid'>[]</span>       <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1427"></a>
<a name="line-1428"></a><a name="tyCoVarsOfCo"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1429"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1430"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1431"></a>
<a name="line-1432"></a><a name="tyCoVarsOfCoDSet"></a><span class='hs-comment'>-- | Get a deterministic set of the vars free in a coercion</span>
<a name="line-1433"></a><span class='hs-definition'>tyCoVarsOfCoDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-1434"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1435"></a><span class='hs-definition'>tyCoVarsOfCoDSet</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1436"></a>
<a name="line-1437"></a><a name="tyCoVarsOfCoList"></a><span class='hs-definition'>tyCoVarsOfCoList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1438"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1439"></a><span class='hs-definition'>tyCoVarsOfCoList</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1440"></a>
<a name="line-1441"></a><a name="tyCoFVsOfCo"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1442"></a><span class='hs-comment'>-- Extracts type and coercion variables from a coercion</span>
<a name="line-1443"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1444"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1445"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1446"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1447"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1448"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1449"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>delFV</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>kind_co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1450"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1451"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1452"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1453"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFV</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1454"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1455"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1456"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>t1</span>
<a name="line-1457"></a>                         <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1458"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1459"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1460"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1461"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1462"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1463"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1464"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1465"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1466"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cs</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1467"></a>
<a name="line-1468"></a><a name="tyCoVarsOfProv"></a><span class='hs-definition'>tyCoVarsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1469"></a><span class='hs-definition'>tyCoVarsOfProv</span> <span class='hs-varid'>prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfProv</span> <span class='hs-varid'>prov</span>
<a name="line-1470"></a>
<a name="line-1471"></a><a name="tyCoFVsOfProv"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1472"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1473"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1474"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1475"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1476"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1477"></a>
<a name="line-1478"></a><a name="tyCoVarsOfCos"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1479"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-1480"></a>
<a name="line-1481"></a><a name="tyCoVarsOfCosSet"></a><span class='hs-definition'>tyCoVarsOfCosSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVarEnv</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1482"></a><span class='hs-definition'>tyCoVarsOfCosSet</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-varid'>cos</span>
<a name="line-1483"></a>  <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here because we immediately forget the</span>
<a name="line-1484"></a>  <span class='hs-comment'>-- ordering by returning a set</span>
<a name="line-1485"></a>
<a name="line-1486"></a><a name="tyCoFVsOfCos"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1487"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-conid'>[]</span>       <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1488"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1489"></a>
<a name="line-1490"></a><a name="coVarsOfType"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1491"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1492"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1493"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1494"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>arg</span>
<a name="line-1495"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>res</span>
<a name="line-1496"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1497"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1498"></a>    <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1499"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1500"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1501"></a>
<a name="line-1502"></a><a name="coVarsOfTypes"></a><span class='hs-definition'>coVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1503"></a><span class='hs-definition'>coVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>tys</span>
<a name="line-1504"></a>
<a name="line-1505"></a><a name="coVarsOfCo"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1506"></a><span class='hs-comment'>-- Extract *coercion* variables only.  Tiresome to repeat the code, but easy.</span>
<a name="line-1507"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1508"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>args</span>
<a name="line-1509"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>arg</span>
<a name="line-1510"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1511"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>kind_co</span>
<a name="line-1512"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-1513"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1514"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>args</span>
<a name="line-1515"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-1516"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1517"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-1518"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1519"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1520"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>arg</span>
<a name="line-1521"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c1</span><span class='hs-layout'>,</span> <span class='hs-varid'>c2</span><span class='hs-keyglyph'>]</span>
<a name="line-1522"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1523"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1524"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>cs</span>
<a name="line-1525"></a>
<a name="line-1526"></a><a name="coVarsOfProv"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1527"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1528"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1529"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1530"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1531"></a><span class='hs-definition'>coVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1532"></a>
<a name="line-1533"></a><a name="coVarsOfCos"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1534"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>cos</span>
<a name="line-1535"></a>
<a name="line-1536"></a><a name="closeOverKinds"></a><span class='hs-comment'>-- | Add the kind variables free in the kinds of the tyvars in the given set.</span>
<a name="line-1537"></a><span class='hs-comment'>-- Returns a non-deterministic set.</span>
<a name="line-1538"></a><span class='hs-definition'>closeOverKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-1539"></a><span class='hs-definition'>closeOverKinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>closeOverKindsFV</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nonDetEltsUniqSet</span>
<a name="line-1540"></a>  <span class='hs-comment'>-- It's OK to use nonDetEltsUniqSet here because we immediately forget</span>
<a name="line-1541"></a>  <span class='hs-comment'>-- about the ordering by returning a set.</span>
<a name="line-1542"></a>
<a name="line-1543"></a><a name="closeOverKindsFV"></a><span class='hs-comment'>-- | Given a list of tyvars returns a deterministic FV computation that</span>
<a name="line-1544"></a><span class='hs-comment'>-- returns the given tyvars with the kind variables free in the kinds of the</span>
<a name="line-1545"></a><span class='hs-comment'>-- given tyvars.</span>
<a name="line-1546"></a><span class='hs-definition'>closeOverKindsFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1547"></a><span class='hs-definition'>closeOverKindsFV</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span>
<a name="line-1548"></a>  <span class='hs-varid'>mapUnionFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>mkFVs</span> <span class='hs-varid'>tvs</span>
<a name="line-1549"></a>
<a name="line-1550"></a><a name="closeOverKindsList"></a><span class='hs-comment'>-- | Add the kind variables free in the kinds of the tyvars in the given set.</span>
<a name="line-1551"></a><span class='hs-comment'>-- Returns a deterministically ordered list.</span>
<a name="line-1552"></a><span class='hs-definition'>closeOverKindsList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1553"></a><span class='hs-definition'>closeOverKindsList</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>closeOverKindsFV</span> <span class='hs-varid'>tvs</span>
<a name="line-1554"></a>
<a name="line-1555"></a><a name="closeOverKindsDSet"></a><span class='hs-comment'>-- | Add the kind variables free in the kinds of the tyvars in the given set.</span>
<a name="line-1556"></a><span class='hs-comment'>-- Returns a deterministic set.</span>
<a name="line-1557"></a><span class='hs-definition'>closeOverKindsDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyVarSet</span>
<a name="line-1558"></a><span class='hs-definition'>closeOverKindsDSet</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>closeOverKindsFV</span> <span class='hs-varop'>.</span> <span class='hs-varid'>dVarSetElems</span>
<a name="line-1559"></a>
<a name="line-1560"></a><a name="noFreeVarsOfType"></a><span class='hs-comment'>-- | Returns True if this type has no free variables. Should be the same as</span>
<a name="line-1561"></a><span class='hs-comment'>-- isEmptyVarSet . tyCoVarsOfType, but faster in the non-forall case.</span>
<a name="line-1562"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1563"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1564"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t2</span>
<a name="line-1565"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>tys</span>
<a name="line-1566"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1567"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t2</span>
<a name="line-1568"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1569"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1570"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1571"></a>
<a name="line-1572"></a><a name="noFreeVarsOfCo"></a><span class='hs-comment'>-- | Returns True if this coercion has no free variables. Should be the same as</span>
<a name="line-1573"></a><span class='hs-comment'>-- isEmptyVarSet . tyCoVarsOfCo, but faster in the non-forall case.</span>
<a name="line-1574"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1575"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1576"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>args</span>
<a name="line-1577"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>c2</span>
<a name="line-1578"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1579"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>c2</span>
<a name="line-1580"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1581"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>args</span>
<a name="line-1582"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-1583"></a>                                        <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-1584"></a>                                        <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t2</span>
<a name="line-1585"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1586"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-1587"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1588"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1589"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-1590"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-1591"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1592"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1593"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>cs</span>
<a name="line-1594"></a>
<a name="line-1595"></a><a name="noFreeVarsOfProv"></a><span class='hs-comment'>-- | Returns True if this UnivCoProv has no free variables. Should be the same as</span>
<a name="line-1596"></a><span class='hs-comment'>-- isEmptyVarSet . tyCoVarsOfProv, but faster in the non-forall case.</span>
<a name="line-1597"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1598"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1599"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1600"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1601"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1602"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-comment'>-- matches with coVarsOfProv, but I'm unsure</span>
<a name="line-1603"></a>
<a name="line-1604"></a><span class='hs-comment'>{-
<a name="line-1605"></a>%************************************************************************
<a name="line-1606"></a>%*                                                                      *
<a name="line-1607"></a>                        Substitutions
<a name="line-1608"></a>      Data type defined here to avoid unnecessary mutual recursion
<a name="line-1609"></a>%*                                                                      *
<a name="line-1610"></a>%************************************************************************
<a name="line-1611"></a>-}</span>
<a name="line-1612"></a>
<a name="line-1613"></a><a name="TCvSubst"></a><span class='hs-comment'>-- | Type &amp; coercion substitution</span>
<a name="line-1614"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-1615"></a><a name="TCvSubst"></a><span class='hs-comment'>-- #tcvsubst_invariant#</span>
<a name="line-1616"></a><a name="TCvSubst"></a><span class='hs-comment'>-- The following invariants must hold of a 'TCvSubst':</span>
<a name="line-1617"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-1618"></a><a name="TCvSubst"></a><span class='hs-comment'>-- 1. The in-scope set is needed /only/ to</span>
<a name="line-1619"></a><a name="TCvSubst"></a><span class='hs-comment'>-- guide the generation of fresh uniques</span>
<a name="line-1620"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-1621"></a><a name="TCvSubst"></a><span class='hs-comment'>-- 2. In particular, the /kind/ of the type variables in</span>
<a name="line-1622"></a><a name="TCvSubst"></a><span class='hs-comment'>-- the in-scope set is not relevant</span>
<a name="line-1623"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-1624"></a><a name="TCvSubst"></a><span class='hs-comment'>-- 3. The substitution is only applied ONCE! This is because</span>
<a name="line-1625"></a><a name="TCvSubst"></a><span class='hs-comment'>-- in general such application will not reach a fixed point.</span>
<a name="line-1626"></a><a name="TCvSubst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1627"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-comment'>-- The in-scope type and kind variables</span>
<a name="line-1628"></a>             <span class='hs-conid'>TvSubstEnv</span> <span class='hs-comment'>-- Substitutes both type and kind variables</span>
<a name="line-1629"></a>             <span class='hs-conid'>CvSubstEnv</span> <span class='hs-comment'>-- Substitutes coercion variables</span>
<a name="line-1630"></a>        <span class='hs-comment'>-- See Note [Apply Once]</span>
<a name="line-1631"></a>        <span class='hs-comment'>-- and Note [Extending the TvSubstEnv]</span>
<a name="line-1632"></a>        <span class='hs-comment'>-- and Note [Substituting types and coercions]</span>
<a name="line-1633"></a>        <span class='hs-comment'>-- and Note [The substitution invariant]</span>
<a name="line-1634"></a>
<a name="line-1635"></a><a name="TvSubstEnv"></a><span class='hs-comment'>-- | A substitution of 'Type's for 'TyVar's</span>
<a name="line-1636"></a><a name="TvSubstEnv"></a><span class='hs-comment'>--                 and 'Kind's for 'KindVar's</span>
<a name="line-1637"></a><a name="TvSubstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>Type</span>
<a name="line-1638"></a>        <span class='hs-comment'>-- A TvSubstEnv is used both inside a TCvSubst (with the apply-once</span>
<a name="line-1639"></a>        <span class='hs-comment'>-- invariant discussed in Note [Apply Once]), and also independently</span>
<a name="line-1640"></a>        <span class='hs-comment'>-- in the middle of matching, and unification (see Types.Unify)</span>
<a name="line-1641"></a>        <span class='hs-comment'>-- So you have to look at the context to know if it's idempotent or</span>
<a name="line-1642"></a>        <span class='hs-comment'>-- apply-once or whatever</span>
<a name="line-1643"></a>
<a name="line-1644"></a><a name="CvSubstEnv"></a><span class='hs-comment'>-- | A substitution of 'Coercion's for 'CoVar's</span>
<a name="line-1645"></a><a name="CvSubstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoVarEnv</span> <span class='hs-conid'>Coercion</span>
<a name="line-1646"></a>
<a name="line-1647"></a><span class='hs-comment'>{-
<a name="line-1648"></a>Note [Apply Once]
<a name="line-1649"></a>~~~~~~~~~~~~~~~~~
<a name="line-1650"></a>We use TCvSubsts to instantiate things, and we might instantiate
<a name="line-1651"></a>        forall a b. ty
<a name="line-1652"></a>\with the types
<a name="line-1653"></a>        [a, b], or [b, a].
<a name="line-1654"></a>So the substitution might go [a-&gt;b, b-&gt;a].  A similar situation arises in Core
<a name="line-1655"></a>when we find a beta redex like
<a name="line-1656"></a>        (/\ a /\ b -&gt; e) b a
<a name="line-1657"></a>Then we also end up with a substitution that permutes type variables. Other
<a name="line-1658"></a>variations happen to; for example [a -&gt; (a, b)].
<a name="line-1659"></a>
<a name="line-1660"></a>        ****************************************************
<a name="line-1661"></a>        *** So a TCvSubst must be applied precisely once ***
<a name="line-1662"></a>        ****************************************************
<a name="line-1663"></a>
<a name="line-1664"></a>A TCvSubst is not idempotent, but, unlike the non-idempotent substitution
<a name="line-1665"></a>we use during unifications, it must not be repeatedly applied.
<a name="line-1666"></a>
<a name="line-1667"></a>Note [Extending the TvSubstEnv]
<a name="line-1668"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1669"></a>See #tcvsubst_invariant# for the invariants that must hold.
<a name="line-1670"></a>
<a name="line-1671"></a>This invariant allows a short-cut when the subst envs are empty:
<a name="line-1672"></a>if the TvSubstEnv and CvSubstEnv are empty --- i.e. (isEmptyTCvSubst subst)
<a name="line-1673"></a>holds --- then (substTy subst ty) does nothing.
<a name="line-1674"></a>
<a name="line-1675"></a>For example, consider:
<a name="line-1676"></a>        (/\a. /\b:(a~Int). ...b..) Int
<a name="line-1677"></a>We substitute Int for 'a'.  The Unique of 'b' does not change, but
<a name="line-1678"></a>nevertheless we add 'b' to the TvSubstEnv, because b's kind does change
<a name="line-1679"></a>
<a name="line-1680"></a>This invariant has several crucial consequences:
<a name="line-1681"></a>
<a name="line-1682"></a>* In substTyVarBndr, we need extend the TvSubstEnv
<a name="line-1683"></a>        - if the unique has changed
<a name="line-1684"></a>        - or if the kind has changed
<a name="line-1685"></a>
<a name="line-1686"></a>* In substTyVar, we do not need to consult the in-scope set;
<a name="line-1687"></a>  the TvSubstEnv is enough
<a name="line-1688"></a>
<a name="line-1689"></a>* In substTy, substTheta, we can short-circuit when the TvSubstEnv is empty
<a name="line-1690"></a>
<a name="line-1691"></a>Note [Substituting types and coercions]
<a name="line-1692"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1693"></a>Types and coercions are mutually recursive, and either may have variables
<a name="line-1694"></a>"belonging" to the other. Thus, every time we wish to substitute in a
<a name="line-1695"></a>type, we may also need to substitute in a coercion, and vice versa.
<a name="line-1696"></a>However, the constructor used to create type variables is distinct from
<a name="line-1697"></a>that of coercion variables, so we carry two VarEnvs in a TCvSubst. Note
<a name="line-1698"></a>that it would be possible to use the CoercionTy constructor to combine
<a name="line-1699"></a>these environments, but that seems like a false economy.
<a name="line-1700"></a>
<a name="line-1701"></a>Note that the TvSubstEnv should *never* map a CoVar (built with the Id
<a name="line-1702"></a>constructor) and the CvSubstEnv should *never* map a TyVar. Furthermore,
<a name="line-1703"></a>the range of the TvSubstEnv should *never* include a type headed with
<a name="line-1704"></a>CoercionTy.
<a name="line-1705"></a>
<a name="line-1706"></a>Note [The substitution invariant]
<a name="line-1707"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1708"></a>When calling (substTy subst ty) it should be the case that
<a name="line-1709"></a>the in-scope set in the substitution is a superset of both:
<a name="line-1710"></a>
<a name="line-1711"></a>  * The free vars of the range of the substitution
<a name="line-1712"></a>  * The free vars of ty minus the domain of the substitution
<a name="line-1713"></a>
<a name="line-1714"></a>If we want to substitute [a -&gt; ty1, b -&gt; ty2] I used to
<a name="line-1715"></a>think it was enough to generate an in-scope set that includes
<a name="line-1716"></a>fv(ty1,ty2).  But that's not enough; we really should also take the
<a name="line-1717"></a>free vars of the type we are substituting into!  Example:
<a name="line-1718"></a>     (forall b. (a,b,x)) [a -&gt; List b]
<a name="line-1719"></a>Then if we use the in-scope set {b}, there is a danger we will rename
<a name="line-1720"></a>the forall'd variable to 'x' by mistake, getting this:
<a name="line-1721"></a>     (forall x. (List b, x, x))
<a name="line-1722"></a>
<a name="line-1723"></a>Breaking this invariant caused the bug from #11371.
<a name="line-1724"></a>-}</span>
<a name="line-1725"></a>
<a name="line-1726"></a><a name="emptyTvSubstEnv"></a><span class='hs-definition'>emptyTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-1727"></a><span class='hs-definition'>emptyTvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1728"></a>
<a name="line-1729"></a><a name="emptyCvSubstEnv"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-1730"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1731"></a>
<a name="line-1732"></a><a name="composeTCvSubstEnv"></a><span class='hs-definition'>composeTCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-1733"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span>
<a name="line-1734"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span>
<a name="line-1735"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span>
<a name="line-1736"></a><span class='hs-comment'>-- ^ @(compose env1 env2)(x)@ is @env1(env2(x))@; i.e. apply @env2@ then @env1@.</span>
<a name="line-1737"></a><span class='hs-comment'>-- It assumes that both are idempotent.</span>
<a name="line-1738"></a><span class='hs-comment'>-- Typically, @env1@ is the refinement to a base substitution @env2@</span>
<a name="line-1739"></a><span class='hs-definition'>composeTCvSubstEnv</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1740"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tenv1</span> <span class='hs-varop'>`plusVarEnv`</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv2</span>
<a name="line-1741"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cenv1</span> <span class='hs-varop'>`plusVarEnv`</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv2</span> <span class='hs-layout'>)</span>
<a name="line-1742"></a>        <span class='hs-comment'>-- First apply env1 to the range of env2</span>
<a name="line-1743"></a>        <span class='hs-comment'>-- Then combine the two, making sure that env1 loses if</span>
<a name="line-1744"></a>        <span class='hs-comment'>-- both bind the same variable; that's why env1 is the</span>
<a name="line-1745"></a>        <span class='hs-comment'>--  *left* argument to plusVarEnv, because the right arg wins</span>
<a name="line-1746"></a>  <span class='hs-keyword'>where</span>
<a name="line-1747"></a>    <span class='hs-varid'>subst1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv1</span> <span class='hs-varid'>cenv1</span>
<a name="line-1748"></a>
<a name="line-1749"></a><a name="composeTCvSubst"></a><span class='hs-comment'>-- | Composes two substitutions, applying the second one provided first,</span>
<a name="line-1750"></a><span class='hs-comment'>-- like in function composition.</span>
<a name="line-1751"></a><span class='hs-definition'>composeTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1752"></a><span class='hs-definition'>composeTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is1</span> <span class='hs-varid'>tenv1</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is2</span> <span class='hs-varid'>tenv2</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1753"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is3</span> <span class='hs-varid'>tenv3</span> <span class='hs-varid'>cenv3</span>
<a name="line-1754"></a>  <span class='hs-keyword'>where</span>
<a name="line-1755"></a>    <span class='hs-varid'>is3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is1</span> <span class='hs-varop'>`unionInScope`</span> <span class='hs-varid'>is2</span>
<a name="line-1756"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tenv3</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>composeTCvSubstEnv</span> <span class='hs-varid'>is3</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1757"></a>
<a name="line-1758"></a><a name="emptyTCvSubst"></a><span class='hs-definition'>emptyTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1759"></a><span class='hs-definition'>emptyTCvSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-1760"></a>
<a name="line-1761"></a><a name="mkEmptyTCvSubst"></a><span class='hs-definition'>mkEmptyTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1762"></a><span class='hs-definition'>mkEmptyTCvSubst</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-1763"></a>
<a name="line-1764"></a><a name="isEmptyTCvSubst"></a><span class='hs-definition'>isEmptyTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1765"></a>         <span class='hs-comment'>-- See Note [Extending the TvSubstEnv]</span>
<a name="line-1766"></a><span class='hs-definition'>isEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>cenv</span>
<a name="line-1767"></a>
<a name="line-1768"></a><a name="mkTCvSubst"></a><span class='hs-definition'>mkTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1769"></a><span class='hs-definition'>mkTCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1770"></a>
<a name="line-1771"></a><a name="mkTvSubst"></a><span class='hs-definition'>mkTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1772"></a><span class='hs-comment'>-- ^ Make a TCvSubst with specified tyvar subst and empty covar subst</span>
<a name="line-1773"></a><span class='hs-definition'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-1774"></a>
<a name="line-1775"></a><a name="getTvSubstEnv"></a><span class='hs-definition'>getTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-1776"></a><span class='hs-definition'>getTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-1777"></a>
<a name="line-1778"></a><a name="getCvSubstEnv"></a><span class='hs-definition'>getCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-1779"></a><span class='hs-definition'>getCvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-1780"></a>
<a name="line-1781"></a><a name="getTCvInScope"></a><span class='hs-definition'>getTCvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-1782"></a><span class='hs-definition'>getTCvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_scope</span>
<a name="line-1783"></a>
<a name="line-1784"></a><a name="getTCvSubstRangeFVs"></a><span class='hs-comment'>-- | Returns the free variables of the types in the range of a substitution as</span>
<a name="line-1785"></a><span class='hs-comment'>-- a non-deterministic set.</span>
<a name="line-1786"></a><span class='hs-definition'>getTCvSubstRangeFVs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-1787"></a><span class='hs-definition'>getTCvSubstRangeFVs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1788"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionVarSet</span> <span class='hs-varid'>tenvFVs</span> <span class='hs-varid'>cenvFVs</span>
<a name="line-1789"></a>  <span class='hs-keyword'>where</span>
<a name="line-1790"></a>    <span class='hs-varid'>tenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tenv</span>
<a name="line-1791"></a>    <span class='hs-varid'>cenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCosSet</span> <span class='hs-varid'>cenv</span>
<a name="line-1792"></a>
<a name="line-1793"></a><a name="isInScope"></a><span class='hs-definition'>isInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1794"></a><span class='hs-definition'>isInScope</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemInScopeSet`</span> <span class='hs-varid'>in_scope</span>
<a name="line-1795"></a>
<a name="line-1796"></a><a name="notElemTCvSubst"></a><span class='hs-definition'>notElemTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1797"></a><span class='hs-definition'>notElemTCvSubst</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1798"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span>
<a name="line-1799"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span>
<a name="line-1800"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1801"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1802"></a>
<a name="line-1803"></a><a name="setTvSubstEnv"></a><span class='hs-definition'>setTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1804"></a><span class='hs-definition'>setTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1805"></a>
<a name="line-1806"></a><a name="setCvSubstEnv"></a><span class='hs-definition'>setCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1807"></a><span class='hs-definition'>setCvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1808"></a>
<a name="line-1809"></a><a name="zapTCvSubst"></a><span class='hs-definition'>zapTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1810"></a><span class='hs-definition'>zapTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1811"></a>
<a name="line-1812"></a><a name="extendTCvInScope"></a><span class='hs-definition'>extendTCvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1813"></a><span class='hs-definition'>extendTCvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>var</span>
<a name="line-1814"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1815"></a>
<a name="line-1816"></a><a name="extendTCvInScopeList"></a><span class='hs-definition'>extendTCvInScopeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1817"></a><span class='hs-definition'>extendTCvInScopeList</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span>
<a name="line-1818"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetList</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1819"></a>
<a name="line-1820"></a><a name="extendTCvInScopeSet"></a><span class='hs-definition'>extendTCvInScopeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1821"></a><span class='hs-definition'>extendTCvInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span>
<a name="line-1822"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-1823"></a>
<a name="line-1824"></a><a name="extendTCvSubst"></a><span class='hs-definition'>extendTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1825"></a><span class='hs-definition'>extendTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span>
<a name="line-1826"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span>
<a name="line-1827"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span>
<a name="line-1828"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-1829"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span>
<a name="line-1830"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1831"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"extendTCvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"|-&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1832"></a>
<a name="line-1833"></a><a name="extendTvSubst"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1834"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1835"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span>
<a name="line-1836"></a>
<a name="line-1837"></a><a name="extendTvSubstBinder"></a><span class='hs-definition'>extendTvSubstBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1838"></a><span class='hs-definition'>extendTvSubstBinder</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1839"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderVar</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1840"></a><span class='hs-definition'>extendTvSubstBinder</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyword'>_</span>
<a name="line-1841"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst</span>
<a name="line-1842"></a>
<a name="line-1843"></a><a name="extendTvSubstWithClone"></a><span class='hs-definition'>extendTvSubstWithClone</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1844"></a><span class='hs-comment'>-- Adds a new tv -&gt; tv mapping, /and/ extends the in-scope set</span>
<a name="line-1845"></a><span class='hs-definition'>extendTvSubstWithClone</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>tv'</span>
<a name="line-1846"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>new_in_scope</span><span class='hs-layout'>)</span>
<a name="line-1847"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1848"></a>             <span class='hs-varid'>cenv</span>
<a name="line-1849"></a>  <span class='hs-keyword'>where</span>
<a name="line-1850"></a>    <span class='hs-varid'>new_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>tv'</span>
<a name="line-1851"></a>
<a name="line-1852"></a><a name="extendCvSubst"></a><span class='hs-definition'>extendCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1853"></a><span class='hs-definition'>extendCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span>
<a name="line-1854"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1855"></a>
<a name="line-1856"></a><a name="extendCvSubstWithClone"></a><span class='hs-definition'>extendCvSubstWithClone</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1857"></a><span class='hs-definition'>extendCvSubstWithClone</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>cv'</span>
<a name="line-1858"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>new_in_scope</span><span class='hs-layout'>)</span>
<a name="line-1859"></a>             <span class='hs-varid'>tenv</span>
<a name="line-1860"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>cv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1861"></a>  <span class='hs-keyword'>where</span>
<a name="line-1862"></a>    <span class='hs-varid'>new_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv'</span><span class='hs-layout'>)</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>cv'</span>
<a name="line-1863"></a>
<a name="line-1864"></a><a name="extendTvSubstAndInScope"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1865"></a><span class='hs-comment'>-- Also extends the in-scope set</span>
<a name="line-1866"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1867"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1868"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1869"></a>             <span class='hs-varid'>cenv</span>
<a name="line-1870"></a>
<a name="line-1871"></a><a name="extendTvSubstList"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1872"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1873"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl2</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1874"></a>
<a name="line-1875"></a><a name="unionTCvSubst"></a><span class='hs-definition'>unionTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1876"></a><span class='hs-comment'>-- Works when the ranges are disjoint</span>
<a name="line-1877"></a><span class='hs-definition'>unionTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope1</span> <span class='hs-varid'>tenv1</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope2</span> <span class='hs-varid'>tenv2</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1878"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span> <span class='hs-varop'>`intersectsVarEnv`</span> <span class='hs-varid'>tenv2</span><span class='hs-layout'>)</span>
<a name="line-1879"></a>         <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>cenv1</span> <span class='hs-varop'>`intersectsVarEnv`</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1880"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope1</span> <span class='hs-varop'>`unionInScope`</span> <span class='hs-varid'>in_scope2</span><span class='hs-layout'>)</span>
<a name="line-1881"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span>     <span class='hs-varop'>`plusVarEnv`</span>   <span class='hs-varid'>tenv2</span><span class='hs-layout'>)</span>
<a name="line-1882"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>cenv1</span>     <span class='hs-varop'>`plusVarEnv`</span>   <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-1883"></a>
<a name="line-1884"></a><span class='hs-comment'>-- mkTvSubstPrs and zipTvSubst generate the in-scope set from</span>
<a name="line-1885"></a><span class='hs-comment'>-- the types given; but it's just a thunk so with a bit of luck</span>
<a name="line-1886"></a><span class='hs-comment'>-- it'll never be evaluated</span>
<a name="line-1887"></a>
<a name="line-1888"></a><a name="mkTyCoInScopeSet"></a><span class='hs-comment'>-- | Generates an in-scope set from the free variables in a list of types</span>
<a name="line-1889"></a><span class='hs-comment'>-- and a list of coercions</span>
<a name="line-1890"></a><span class='hs-definition'>mkTyCoInScopeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-1891"></a><span class='hs-definition'>mkTyCoInScopeSet</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-1892"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1893"></a>
<a name="line-1894"></a><a name="zipTvSubst"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TCvSubst' from the types in the incoming</span>
<a name="line-1895"></a><span class='hs-comment'>-- environment. No CoVars, please!</span>
<a name="line-1896"></a><span class='hs-definition'>zipTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1897"></a><span class='hs-definition'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1898"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span>
<a name="line-1899"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-1900"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"zipTvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTCvSubst</span>
<a name="line-1901"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1902"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span>
<a name="line-1903"></a>  <span class='hs-keyword'>where</span>
<a name="line-1904"></a>    <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1905"></a>
<a name="line-1906"></a><a name="zipCvSubst"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TCvSubst' from the types in the incoming</span>
<a name="line-1907"></a><span class='hs-comment'>-- environment.  No TyVars, please!</span>
<a name="line-1908"></a><span class='hs-definition'>zipCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1909"></a><span class='hs-definition'>zipCvSubst</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span>
<a name="line-1910"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span>
<a name="line-1911"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cvs</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos</span>
<a name="line-1912"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"zipCvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTCvSubst</span>
<a name="line-1913"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1914"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>cenv</span>
<a name="line-1915"></a>  <span class='hs-keyword'>where</span>
<a name="line-1916"></a>    <span class='hs-varid'>cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipCoEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span>
<a name="line-1917"></a>
<a name="line-1918"></a><a name="mkTvSubstPrs"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TCvSubst' from the types in the</span>
<a name="line-1919"></a><span class='hs-comment'>-- incoming environment. No CoVars, please!</span>
<a name="line-1920"></a><span class='hs-definition'>mkTvSubstPrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1921"></a><span class='hs-definition'>mkTvSubstPrs</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span>
<a name="line-1922"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>onlyTyVarsAndNoCoercionTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"prs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prs</span> <span class='hs-layout'>)</span>
<a name="line-1923"></a>    <span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span>
<a name="line-1924"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>prs</span>
<a name="line-1925"></a>        <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>prs</span>
<a name="line-1926"></a>        <span class='hs-varid'>onlyTyVarsAndNoCoercionTy</span> <span class='hs-keyglyph'>=</span>
<a name="line-1927"></a>          <span class='hs-varid'>and</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoercionTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1928"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>]</span>
<a name="line-1929"></a>
<a name="line-1930"></a><a name="zipTyEnv"></a><span class='hs-definition'>zipTyEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-1931"></a><span class='hs-definition'>zipTyEnv</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span>
<a name="line-1932"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isCoercionTy</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1933"></a>    <span class='hs-varid'>mkVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"zipTyEnv"</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1934"></a>        <span class='hs-comment'>-- There used to be a special case for when</span>
<a name="line-1935"></a>        <span class='hs-comment'>--      ty == TyVarTy tv</span>
<a name="line-1936"></a>        <span class='hs-comment'>-- (a not-uncommon case) in which case the substitution was dropped.</span>
<a name="line-1937"></a>        <span class='hs-comment'>-- But the type-tidier changes the print-name of a type variable without</span>
<a name="line-1938"></a>        <span class='hs-comment'>-- changing the unique, and that led to a bug.   Why?  Pre-tidying, we had</span>
<a name="line-1939"></a>        <span class='hs-comment'>-- a type {Foo t}, where Foo is a one-method class.  So Foo is really a newtype.</span>
<a name="line-1940"></a>        <span class='hs-comment'>-- And it happened that t was the type variable of the class.  Post-tiding,</span>
<a name="line-1941"></a>        <span class='hs-comment'>-- it got turned into {Foo t2}.  The ext-core printer expanded this using</span>
<a name="line-1942"></a>        <span class='hs-comment'>-- sourceTypeRep, but that said "Oh, t == t2" because they have the same unique,</span>
<a name="line-1943"></a>        <span class='hs-comment'>-- and so generated a rep type mentioning t not t2.</span>
<a name="line-1944"></a>        <span class='hs-comment'>--</span>
<a name="line-1945"></a>        <span class='hs-comment'>-- Simplest fix is to nuke the "optimisation"</span>
<a name="line-1946"></a>
<a name="line-1947"></a><a name="zipCoEnv"></a><span class='hs-definition'>zipCoEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-1948"></a><span class='hs-definition'>zipCoEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"zipCoEnv"</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1949"></a>
<a name="line-1950"></a><a name="instance%20Outputable%20TCvSubst"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>where</span>
<a name="line-1951"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>ins</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1952"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span><span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TCvSubst"</span><span class='hs-layout'>,</span>
<a name="line-1953"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In scope:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1954"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Type env:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1955"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Co env:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1956"></a>
<a name="line-1957"></a><span class='hs-comment'>{-
<a name="line-1958"></a>%************************************************************************
<a name="line-1959"></a>%*                                                                      *
<a name="line-1960"></a>                Performing type or kind substitutions
<a name="line-1961"></a>%*                                                                      *
<a name="line-1962"></a>%************************************************************************
<a name="line-1963"></a>
<a name="line-1964"></a>Note [Sym and ForAllCo]
<a name="line-1965"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1966"></a>In OptCoercion, we try to push "sym" out to the leaves of a coercion. But,
<a name="line-1967"></a>how do we push sym into a ForAllCo? It's a little ugly.
<a name="line-1968"></a>
<a name="line-1969"></a>Here is the typing rule:
<a name="line-1970"></a>
<a name="line-1971"></a>h : k1 ~# k2
<a name="line-1972"></a>(tv : k1) |- g : ty1 ~# ty2
<a name="line-1973"></a>----------------------------
<a name="line-1974"></a>ForAllCo tv h g : (ForAllTy (tv : k1) ty1) ~#
<a name="line-1975"></a>                  (ForAllTy (tv : k2) (ty2[tv |-&gt; tv |&gt; sym h]))
<a name="line-1976"></a>
<a name="line-1977"></a>Here is what we want:
<a name="line-1978"></a>
<a name="line-1979"></a>ForAllCo tv h' g' : (ForAllTy (tv : k2) (ty2[tv |-&gt; tv |&gt; sym h])) ~#
<a name="line-1980"></a>                    (ForAllTy (tv : k1) ty1)
<a name="line-1981"></a>
<a name="line-1982"></a>
<a name="line-1983"></a>Because the kinds of the type variables to the right of the colon are the kinds
<a name="line-1984"></a>coerced by h', we know (h' : k2 ~# k1). Thus, (h' = sym h).
<a name="line-1985"></a>
<a name="line-1986"></a>Now, we can rewrite ty1 to be (ty1[tv |-&gt; tv |&gt; sym h' |&gt; h']). We thus want
<a name="line-1987"></a>
<a name="line-1988"></a>ForAllCo tv h' g' :
<a name="line-1989"></a>  (ForAllTy (tv : k2) (ty2[tv |-&gt; tv |&gt; h'])) ~#
<a name="line-1990"></a>  (ForAllTy (tv : k1) (ty1[tv |-&gt; tv |&gt; h'][tv |-&gt; tv |&gt; sym h']))
<a name="line-1991"></a>
<a name="line-1992"></a>We thus see that we want
<a name="line-1993"></a>
<a name="line-1994"></a>g' : ty2[tv |-&gt; tv |&gt; h'] ~# ty1[tv |-&gt; tv |&gt; h']
<a name="line-1995"></a>
<a name="line-1996"></a>and thus g' = sym (g[tv |-&gt; tv |&gt; h']).
<a name="line-1997"></a>
<a name="line-1998"></a>Putting it all together, we get this:
<a name="line-1999"></a>
<a name="line-2000"></a>sym (ForAllCo tv h g)
<a name="line-2001"></a>==&gt;
<a name="line-2002"></a>ForAllCo tv (sym h) (sym g[tv |-&gt; tv |&gt; sym h])
<a name="line-2003"></a>
<a name="line-2004"></a>-}</span>
<a name="line-2005"></a>
<a name="line-2006"></a><a name="substTyWith"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'</span>
<a name="line-2007"></a><span class='hs-definition'>substTyWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2008"></a><span class='hs-comment'>-- Works only if the domain of the substitution is a</span>
<a name="line-2009"></a><span class='hs-comment'>-- superset of the type being substituted into</span>
<a name="line-2010"></a><span class='hs-definition'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2011"></a>                      <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2012"></a>
<a name="line-2013"></a><a name="substTyWithUnchecked"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'. Disables sanity checks.</span>
<a name="line-2014"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-2015"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2016"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-2017"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-2018"></a><span class='hs-definition'>substTyWithUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2019"></a><span class='hs-definition'>substTyWithUnchecked</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2020"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2021"></a>    <span class='hs-varid'>substTyUnchecked</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2022"></a>
<a name="line-2023"></a><a name="substTyWithInScope"></a><span class='hs-comment'>-- | Substitute tyvars within a type using a known 'InScopeSet'.</span>
<a name="line-2024"></a><span class='hs-comment'>-- Pre-condition: the 'in_scope' set should satisfy Note [The substitution</span>
<a name="line-2025"></a><span class='hs-comment'>-- invariant]; specifically it should include the free vars of 'tys',</span>
<a name="line-2026"></a><span class='hs-comment'>-- and of 'ty' minus the domain of the subst.</span>
<a name="line-2027"></a><span class='hs-definition'>substTyWithInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2028"></a><span class='hs-definition'>substTyWithInScope</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-2029"></a>  <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2030"></a>  <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2031"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2032"></a>
<a name="line-2033"></a><a name="substCoWith"></a><span class='hs-comment'>-- | Coercion substitution, see 'zipTvSubst'</span>
<a name="line-2034"></a><span class='hs-definition'>substCoWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2035"></a><span class='hs-definition'>substCoWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2036"></a>                      <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2037"></a>
<a name="line-2038"></a><a name="substCoWithUnchecked"></a><span class='hs-comment'>-- | Coercion substitution, see 'zipTvSubst'. Disables sanity checks.</span>
<a name="line-2039"></a><span class='hs-comment'>-- The problems that the sanity checks in substCo catch are described in</span>
<a name="line-2040"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2041"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substCoUnchecked to</span>
<a name="line-2042"></a><span class='hs-comment'>-- substCo and remove this function. Please don't use in new code.</span>
<a name="line-2043"></a><span class='hs-definition'>substCoWithUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2044"></a><span class='hs-definition'>substCoWithUnchecked</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2045"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2046"></a>    <span class='hs-varid'>substCoUnchecked</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2047"></a>
<a name="line-2048"></a>
<a name="line-2049"></a>
<a name="line-2050"></a><a name="substTyWithCoVars"></a><span class='hs-comment'>-- | Substitute covars within a type</span>
<a name="line-2051"></a><span class='hs-definition'>substTyWithCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2052"></a><span class='hs-definition'>substTyWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipCvSubst</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2053"></a>
<a name="line-2054"></a><a name="substTysWith"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'</span>
<a name="line-2055"></a><span class='hs-definition'>substTysWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2056"></a><span class='hs-definition'>substTysWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2057"></a>                       <span class='hs-varid'>substTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2058"></a>
<a name="line-2059"></a><a name="substTysWithCoVars"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'</span>
<a name="line-2060"></a><span class='hs-definition'>substTysWithCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2061"></a><span class='hs-definition'>substTysWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>)</span>
<a name="line-2062"></a>                             <span class='hs-varid'>substTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipCvSubst</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2063"></a>
<a name="line-2064"></a><a name="substTyAddInScope"></a><span class='hs-comment'>-- | Substitute within a 'Type' after adding the free variables of the type</span>
<a name="line-2065"></a><span class='hs-comment'>-- to the in-scope set. This is useful for the case when the free variables</span>
<a name="line-2066"></a><span class='hs-comment'>-- aren't already in the in-scope set or easily available.</span>
<a name="line-2067"></a><span class='hs-comment'>-- See also Note [The substitution invariant].</span>
<a name="line-2068"></a><span class='hs-definition'>substTyAddInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2069"></a><span class='hs-definition'>substTyAddInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-2070"></a>  <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvInScopeSet</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2071"></a>
<a name="line-2072"></a><a name="isValidTCvSubst"></a><span class='hs-comment'>-- | When calling `substTy` it should be the case that the in-scope set in</span>
<a name="line-2073"></a><span class='hs-comment'>-- the substitution is a superset of the free vars of the range of the</span>
<a name="line-2074"></a><span class='hs-comment'>-- substitution.</span>
<a name="line-2075"></a><span class='hs-comment'>-- See also Note [The substitution invariant].</span>
<a name="line-2076"></a><span class='hs-definition'>isValidTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2077"></a><span class='hs-definition'>isValidTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2078"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>tenvFVs</span> <span class='hs-varop'>`varSetInScope`</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2079"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>cenvFVs</span> <span class='hs-varop'>`varSetInScope`</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span>
<a name="line-2080"></a>  <span class='hs-keyword'>where</span>
<a name="line-2081"></a>  <span class='hs-varid'>tenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tenv</span>
<a name="line-2082"></a>  <span class='hs-varid'>cenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCosSet</span> <span class='hs-varid'>cenv</span>
<a name="line-2083"></a>
<a name="line-2084"></a><a name="checkValidSubst"></a><span class='hs-comment'>-- | This checks if the substitution satisfies the invariant from</span>
<a name="line-2085"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2086"></a><span class='hs-definition'>checkValidSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-2087"></a><span class='hs-definition'>checkValidSubst</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>a</span>
<a name="line-2088"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isValidTCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>,</span>
<a name="line-2089"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"in_scope"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$$</span>
<a name="line-2090"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>$$</span>
<a name="line-2091"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tenvFVs"</span>
<a name="line-2092"></a>               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-2093"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span> <span class='hs-varop'>$$</span>
<a name="line-2094"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cenvFVs"</span>
<a name="line-2095"></a>               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCosSet</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-2096"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tys"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>$$</span>
<a name="line-2097"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cos"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>)</span>
<a name="line-2098"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tysCosFVsInScope</span><span class='hs-layout'>,</span>
<a name="line-2099"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"in_scope"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$$</span>
<a name="line-2100"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>$$</span>
<a name="line-2101"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span> <span class='hs-varop'>$$</span>
<a name="line-2102"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tys"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>$$</span>
<a name="line-2103"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cos"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$$</span>
<a name="line-2104"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"needInScope"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>needInScope</span> <span class='hs-layout'>)</span>
<a name="line-2105"></a>    <span class='hs-varid'>a</span>
<a name="line-2106"></a>  <span class='hs-keyword'>where</span>
<a name="line-2107"></a>  <span class='hs-varid'>substDomain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetKeysUFM</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nonDetKeysUFM</span> <span class='hs-varid'>cenv</span>
<a name="line-2108"></a>    <span class='hs-comment'>-- It's OK to use nonDetKeysUFM here, because we only use this list to</span>
<a name="line-2109"></a>    <span class='hs-comment'>-- remove some elements from a set</span>
<a name="line-2110"></a>  <span class='hs-varid'>needInScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2111"></a>                  <span class='hs-varop'>`delListFromUniqSet_Directly`</span> <span class='hs-varid'>substDomain</span>
<a name="line-2112"></a>  <span class='hs-varid'>tysCosFVsInScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needInScope</span> <span class='hs-varop'>`varSetInScope`</span> <span class='hs-varid'>in_scope</span>
<a name="line-2113"></a>
<a name="line-2114"></a>
<a name="line-2115"></a><a name="substTy"></a><span class='hs-comment'>-- | Substitute within a 'Type'</span>
<a name="line-2116"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2117"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2118"></a><span class='hs-definition'>substTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2119"></a><span class='hs-definition'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2120"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-2121"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span>
<a name="line-2122"></a>                            <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2123"></a>
<a name="line-2124"></a><a name="substTyUnchecked"></a><span class='hs-comment'>-- | Substitute within a 'Type' disabling the sanity checks.</span>
<a name="line-2125"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-2126"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2127"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-2128"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-2129"></a><span class='hs-definition'>substTyUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2130"></a><span class='hs-definition'>substTyUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2131"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-2132"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2133"></a>
<a name="line-2134"></a><a name="substTys"></a><span class='hs-comment'>-- | Substitute within several 'Type's</span>
<a name="line-2135"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2136"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2137"></a><span class='hs-definition'>substTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2138"></a><span class='hs-definition'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span>
<a name="line-2139"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-2140"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2141"></a>
<a name="line-2142"></a><a name="substTysUnchecked"></a><span class='hs-comment'>-- | Substitute within several 'Type's disabling the sanity checks.</span>
<a name="line-2143"></a><span class='hs-comment'>-- The problems that the sanity checks in substTys catch are described in</span>
<a name="line-2144"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2145"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTysUnchecked to</span>
<a name="line-2146"></a><span class='hs-comment'>-- substTys and remove this function. Please don't use in new code.</span>
<a name="line-2147"></a><span class='hs-definition'>substTysUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2148"></a><span class='hs-definition'>substTysUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span>
<a name="line-2149"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-2150"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2151"></a>
<a name="line-2152"></a><a name="substTheta"></a><span class='hs-comment'>-- | Substitute within a 'ThetaType'</span>
<a name="line-2153"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2154"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2155"></a><span class='hs-definition'>substTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-2156"></a><span class='hs-definition'>substTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span>
<a name="line-2157"></a>
<a name="line-2158"></a><a name="substThetaUnchecked"></a><span class='hs-comment'>-- | Substitute within a 'ThetaType' disabling the sanity checks.</span>
<a name="line-2159"></a><span class='hs-comment'>-- The problems that the sanity checks in substTys catch are described in</span>
<a name="line-2160"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2161"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substThetaUnchecked to</span>
<a name="line-2162"></a><span class='hs-comment'>-- substTheta and remove this function. Please don't use in new code.</span>
<a name="line-2163"></a><span class='hs-definition'>substThetaUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-2164"></a><span class='hs-definition'>substThetaUnchecked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTysUnchecked</span>
<a name="line-2165"></a>
<a name="line-2166"></a>
<a name="line-2167"></a><a name="subst_ty"></a><span class='hs-definition'>subst_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2168"></a><span class='hs-comment'>-- subst_ty is the main workhorse for type substitution</span>
<a name="line-2169"></a><span class='hs-comment'>--</span>
<a name="line-2170"></a><span class='hs-comment'>-- Note that the in_scope set is poked only if we hit a forall</span>
<a name="line-2171"></a><span class='hs-comment'>-- so it may often never be fully computed</span>
<a name="line-2172"></a><span class='hs-definition'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-2173"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2174"></a>  <span class='hs-keyword'>where</span>
<a name="line-2175"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-2176"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-2177"></a>                <span class='hs-comment'>-- The mkAppTy smart constructor is important</span>
<a name="line-2178"></a>                <span class='hs-comment'>-- we might be replacing (a Int), represented with App</span>
<a name="line-2179"></a>                <span class='hs-comment'>-- by [Int], represented with TyConApp</span>
<a name="line-2180"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-2181"></a>                           <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-2182"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-2183"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2184"></a>                         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substTyVarBndrUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-2185"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2186"></a>                               <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span>
<a name="line-2187"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2188"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>n</span>
<a name="line-2189"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCastTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2190"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2191"></a>
<a name="line-2192"></a><a name="substTyVar"></a><span class='hs-definition'>substTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2193"></a><span class='hs-definition'>substTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-2194"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-2195"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-2196"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span>
<a name="line-2197"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span>
<a name="line-2198"></a>
<a name="line-2199"></a><a name="substTyVars"></a><span class='hs-definition'>substTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2200"></a><span class='hs-definition'>substTyVars</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varop'>$</span> <span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span>
<a name="line-2201"></a>
<a name="line-2202"></a><a name="lookupTyVar"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-2203"></a>        <span class='hs-comment'>-- See Note [Extending the TCvSubst]</span>
<a name="line-2204"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-2205"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-2206"></a>    <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span>
<a name="line-2207"></a>
<a name="line-2208"></a><a name="substCo"></a><span class='hs-comment'>-- | Substitute within a 'Coercion'</span>
<a name="line-2209"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2210"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2211"></a><span class='hs-definition'>substCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2212"></a><span class='hs-definition'>substCo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2213"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-2214"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2215"></a>
<a name="line-2216"></a><a name="substCoUnchecked"></a><span class='hs-comment'>-- | Substitute within a 'Coercion' disabling sanity checks.</span>
<a name="line-2217"></a><span class='hs-comment'>-- The problems that the sanity checks in substCo catch are described in</span>
<a name="line-2218"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2219"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substCoUnchecked to</span>
<a name="line-2220"></a><span class='hs-comment'>-- substCo and remove this function. Please don't use in new code.</span>
<a name="line-2221"></a><span class='hs-definition'>substCoUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2222"></a><span class='hs-definition'>substCoUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2223"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-2224"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2225"></a>
<a name="line-2226"></a><a name="substCos"></a><span class='hs-comment'>-- | Substitute within several 'Coercion's</span>
<a name="line-2227"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-2228"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2229"></a><span class='hs-definition'>substCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-2230"></a><span class='hs-definition'>substCos</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cos</span>
<a name="line-2231"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cos</span>
<a name="line-2232"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-2233"></a>
<a name="line-2234"></a><a name="subst_co"></a><span class='hs-definition'>subst_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2235"></a><span class='hs-definition'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-2236"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2237"></a>  <span class='hs-keyword'>where</span>
<a name="line-2238"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2239"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span>
<a name="line-2240"></a>
<a name="line-2241"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2242"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty</span>
<a name="line-2243"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>args</span>
<a name="line-2244"></a>                               <span class='hs-keyword'>in</span>  <span class='hs-varid'>args'</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args'</span>
<a name="line-2245"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-2246"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2247"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substForAllCoBndrUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind_co'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2248"></a>          <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>mkForAllCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>kind_co'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-2249"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-2250"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span>
<a name="line-2251"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-2252"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>mkUnivCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span>
<a name="line-2253"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2254"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2255"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTransCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2256"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>d</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2257"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2258"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInstCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-2259"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoherenceCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2260"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2261"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2262"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>c</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cs</span>
<a name="line-2263"></a>                                <span class='hs-keyword'>in</span> <span class='hs-varid'>cs1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>c</span> <span class='hs-varid'>cs1</span>
<a name="line-2264"></a>
<a name="line-2265"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-conid'>UnsafeCoerceProv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnsafeCoerceProv</span>
<a name="line-2266"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>
<a name="line-2267"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>
<a name="line-2268"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-2269"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-2270"></a>      <span class='hs-comment'>-- NB: this last case is a little suspicious, but we need it. Originally,</span>
<a name="line-2271"></a>      <span class='hs-comment'>-- there was a panic here, but it triggered from deeplySkolemise. Because</span>
<a name="line-2272"></a>      <span class='hs-comment'>-- we only skolemise tyvars that are manually bound, this operation makes</span>
<a name="line-2273"></a>      <span class='hs-comment'>-- sense, even over a coercion with holes.</span>
<a name="line-2274"></a>
<a name="line-2275"></a><a name="substForAllCoBndr"></a><span class='hs-definition'>substForAllCoBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2276"></a><span class='hs-definition'>substForAllCoBndr</span> <span class='hs-varid'>subst</span>
<a name="line-2277"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoBndrCallback</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-2278"></a>
<a name="line-2279"></a><a name="substForAllCoBndrUnchecked"></a><span class='hs-comment'>-- | Like 'substForAllCoBndr', but disables sanity checks.</span>
<a name="line-2280"></a><span class='hs-comment'>-- The problems that the sanity checks in substCo catch are described in</span>
<a name="line-2281"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2282"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substCoUnchecked to</span>
<a name="line-2283"></a><span class='hs-comment'>-- substCo and remove this function. Please don't use in new code.</span>
<a name="line-2284"></a><span class='hs-definition'>substForAllCoBndrUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2285"></a><span class='hs-definition'>substForAllCoBndrUnchecked</span> <span class='hs-varid'>subst</span>
<a name="line-2286"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoBndrCallback</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCoUnchecked</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-2287"></a>
<a name="line-2288"></a><a name="substForAllCoBndrCallback"></a><span class='hs-comment'>-- See Note [Sym and ForAllCo]</span>
<a name="line-2289"></a><span class='hs-definition'>substForAllCoBndrCallback</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- apply sym to binder?</span>
<a name="line-2290"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- transformation to kind co</span>
<a name="line-2291"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2292"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2293"></a><span class='hs-definition'>substForAllCoBndrCallback</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-2294"></a>                          <span class='hs-varid'>old_var</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-2295"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>cenv</span>
<a name="line-2296"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_kind_co</span> <span class='hs-layout'>)</span>
<a name="line-2297"></a>  <span class='hs-keyword'>where</span>
<a name="line-2298"></a>    <span class='hs-varid'>new_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>sym</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span>
<a name="line-2299"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sym</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>$</span>
<a name="line-2300"></a>                            <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>`CastTy`</span> <span class='hs-varid'>new_kind_co</span>
<a name="line-2301"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-2302"></a>
<a name="line-2303"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-2304"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-2305"></a>
<a name="line-2306"></a>    <span class='hs-varid'>new_kind_co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-2307"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sco</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-2308"></a>
<a name="line-2309"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>new_ki1</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>new_kind_co</span>
<a name="line-2310"></a>
<a name="line-2311"></a>    <span class='hs-varid'>new_var</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>new_ki1</span><span class='hs-layout'>)</span>
<a name="line-2312"></a>
<a name="line-2313"></a><a name="substCoVar"></a><span class='hs-definition'>substCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2314"></a><span class='hs-definition'>substCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2315"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span> <span class='hs-keyword'>of</span>
<a name="line-2316"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co</span>
<a name="line-2317"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-2318"></a>
<a name="line-2319"></a><a name="substCoVars"></a><span class='hs-definition'>substCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-2320"></a><span class='hs-definition'>substCoVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cvs</span>
<a name="line-2321"></a>
<a name="line-2322"></a><a name="lookupCoVar"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-2323"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>v</span>
<a name="line-2324"></a>
<a name="line-2325"></a><a name="substTyVarBndr"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2326"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndrCallback</span> <span class='hs-varid'>substTy</span>
<a name="line-2327"></a>
<a name="line-2328"></a><a name="substTyVarBndrUnchecked"></a><span class='hs-comment'>-- | Like 'substTyVarBndr' but disables sanity checks.</span>
<a name="line-2329"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-2330"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2331"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-2332"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-2333"></a><span class='hs-definition'>substTyVarBndrUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2334"></a><span class='hs-definition'>substTyVarBndrUnchecked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndrCallback</span> <span class='hs-varid'>substTyUnchecked</span>
<a name="line-2335"></a>
<a name="line-2336"></a><a name="substTyVarBndrCallback"></a><span class='hs-comment'>-- | Substitute a tyvar in a binding position, returning an</span>
<a name="line-2337"></a><span class='hs-comment'>-- extended subst and a new tyvar.</span>
<a name="line-2338"></a><span class='hs-definition'>substTyVarBndrCallback</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ the subst function</span>
<a name="line-2339"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2340"></a><span class='hs-definition'>substTyVarBndrCallback</span> <span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-2341"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-sel'>_no_capture</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyVar</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprTyVar</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>)</span>
<a name="line-2342"></a>    <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-2343"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-2344"></a>  <span class='hs-keyword'>where</span>
<a name="line-2345"></a>    <span class='hs-varid'>new_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span>
<a name="line-2346"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-2347"></a>
<a name="line-2348"></a>    <span class='hs-sel'>_no_capture</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span>
<a name="line-2349"></a>    <span class='hs-comment'>-- Assertion check that we are not capturing something in the substitution</span>
<a name="line-2350"></a>
<a name="line-2351"></a>    <span class='hs-varid'>old_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>old_var</span>
<a name="line-2352"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>old_ki</span> <span class='hs-comment'>-- verify that kind is closed</span>
<a name="line-2353"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-2354"></a>        <span class='hs-comment'>-- no_change means that the new_var is identical in</span>
<a name="line-2355"></a>        <span class='hs-comment'>-- all respects to the old_var (same unique, same kind)</span>
<a name="line-2356"></a>        <span class='hs-comment'>-- See Note [Extending the TCvSubst]</span>
<a name="line-2357"></a>        <span class='hs-comment'>--</span>
<a name="line-2358"></a>        <span class='hs-comment'>-- In that case we don't need to extend the substitution</span>
<a name="line-2359"></a>        <span class='hs-comment'>-- to map old to new.  But instead we must zap any</span>
<a name="line-2360"></a>        <span class='hs-comment'>-- current substitution for the variable. For example:</span>
<a name="line-2361"></a>        <span class='hs-comment'>--      (\x.e) with id_subst = [x |-&gt; e']</span>
<a name="line-2362"></a>        <span class='hs-comment'>-- Here we must simply zap the substitution for x</span>
<a name="line-2363"></a>
<a name="line-2364"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>old_var</span>
<a name="line-2365"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$</span>
<a name="line-2366"></a>                          <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-2367"></a>        <span class='hs-comment'>-- The uniqAway part makes sure the new variable is not already in scope</span>
<a name="line-2368"></a>
<a name="line-2369"></a><a name="substCoVarBndr"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>)</span>
<a name="line-2370"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-2371"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-2372"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>new_cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-2373"></a>  <span class='hs-keyword'>where</span>
<a name="line-2374"></a>    <span class='hs-varid'>new_co</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>new_var</span>
<a name="line-2375"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-2376"></a>    <span class='hs-varid'>no_change</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>no_kind_change</span>
<a name="line-2377"></a>
<a name="line-2378"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span>
<a name="line-2379"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>new_co</span>
<a name="line-2380"></a>
<a name="line-2381"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>subst_old_var</span>
<a name="line-2382"></a>    <span class='hs-varid'>subst_old_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_var_type</span>
<a name="line-2383"></a>
<a name="line-2384"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarKindsTypesRole</span> <span class='hs-varid'>old_var</span>
<a name="line-2385"></a>    <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t1</span>
<a name="line-2386"></a>    <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t2</span>
<a name="line-2387"></a>    <span class='hs-varid'>new_var_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoercionType</span> <span class='hs-varid'>role</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>t2'</span>
<a name="line-2388"></a>                  <span class='hs-comment'>-- It's important to do the substitution for coercions,</span>
<a name="line-2389"></a>                  <span class='hs-comment'>-- because they can have free type variables</span>
<a name="line-2390"></a>
<a name="line-2391"></a><a name="cloneTyVarBndr"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2392"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>uniq</span>
<a name="line-2393"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- I think it's only called on TyVars</span>
<a name="line-2394"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-2395"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-2396"></a>  <span class='hs-keyword'>where</span>
<a name="line-2397"></a>    <span class='hs-varid'>old_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-2398"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>old_ki</span> <span class='hs-comment'>-- verify that kind is closed</span>
<a name="line-2399"></a>
<a name="line-2400"></a>    <span class='hs-varid'>tv1</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span>
<a name="line-2401"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-2402"></a>
<a name="line-2403"></a>    <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarUnique</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>uniq</span>
<a name="line-2404"></a>
<a name="line-2405"></a><a name="cloneTyVarBndrs"></a><span class='hs-definition'>cloneTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2406"></a><span class='hs-definition'>cloneTyVarBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span>     <span class='hs-sel'>_usupply</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-2407"></a><span class='hs-definition'>cloneTyVarBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span>  <span class='hs-varid'>usupply</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst''</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2408"></a>  <span class='hs-keyword'>where</span>
<a name="line-2409"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-layout'>,</span> <span class='hs-varid'>usupply'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeUniqFromSupply</span> <span class='hs-varid'>usupply</span>
<a name="line-2410"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span> <span class='hs-layout'>,</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cloneTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t</span> <span class='hs-varid'>uniq</span>
<a name="line-2411"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst''</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cloneTyVarBndrs</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>usupply'</span>
<a name="line-2412"></a>
<a name="line-2413"></a><span class='hs-comment'>{-
<a name="line-2414"></a>%************************************************************************
<a name="line-2415"></a>%*                                                                      *
<a name="line-2416"></a>                   Pretty-printing types
<a name="line-2417"></a>
<a name="line-2418"></a>       Defined very early because of debug printing in assertions
<a name="line-2419"></a>%*                                                                      *
<a name="line-2420"></a>%************************************************************************
<a name="line-2421"></a>
<a name="line-2422"></a>@pprType@ is the standard @Type@ printer; the overloaded @ppr@ function is
<a name="line-2423"></a>defined to use this.  @pprParendType@ is the same, except it puts
<a name="line-2424"></a>parens around the type, except for the atomic cases.  @pprParendType@
<a name="line-2425"></a>works just by setting the initial context precedence very high.
<a name="line-2426"></a>
<a name="line-2427"></a>Note [Precedence in types]
<a name="line-2428"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2429"></a>We don't keep the fixity of type operators in the operator. So the pretty printer
<a name="line-2430"></a>follows the following precedence order:
<a name="line-2431"></a>   Type constructor application   binds more tightly than
<a name="line-2432"></a>   Operator applications          which bind more tightly than
<a name="line-2433"></a>   Function arrow
<a name="line-2434"></a>
<a name="line-2435"></a>So we might see  a :+: T b -&gt; c
<a name="line-2436"></a>meaning          (a :+: (T b)) -&gt; c
<a name="line-2437"></a>
<a name="line-2438"></a>Maybe operator applications should bind a bit less tightly?
<a name="line-2439"></a>
<a name="line-2440"></a>Anyway, that's the current story; it is used consistently for Type and HsType.
<a name="line-2441"></a>-}</span>
<a name="line-2442"></a>
<a name="line-2443"></a><span class='hs-comment'>------------------</span>
<a name="line-2444"></a>
<a name="line-2445"></a><a name="pprType"></a><span class='hs-definition'>pprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2446"></a><span class='hs-definition'>pprType</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceType</span>       <span class='hs-varop'>.</span> <span class='hs-varid'>tidyToIfaceType</span>
<a name="line-2447"></a><a name="pprParendType"></a><span class='hs-definition'>pprParendType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendIfaceType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tidyToIfaceType</span>
<a name="line-2448"></a>
<a name="line-2449"></a><a name="pprTyLit"></a><span class='hs-definition'>pprTyLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2450"></a><span class='hs-definition'>pprTyLit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceTyLit</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toIfaceTyLit</span>
<a name="line-2451"></a>
<a name="line-2452"></a><a name="pprKind"></a><span class='hs-definition'>pprKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2453"></a><span class='hs-definition'>pprKind</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprType</span>
<a name="line-2454"></a><a name="pprParendKind"></a><span class='hs-definition'>pprParendKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendType</span>
<a name="line-2455"></a>
<a name="line-2456"></a><a name="tidyToIfaceType"></a><span class='hs-definition'>tidyToIfaceType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceType</span>
<a name="line-2457"></a><span class='hs-comment'>-- It's vital to tidy before converting to an IfaceType</span>
<a name="line-2458"></a><span class='hs-comment'>-- or nested binders will become indistinguishable!</span>
<a name="line-2459"></a><span class='hs-comment'>--</span>
<a name="line-2460"></a><span class='hs-comment'>-- Also for the free type variables, tell toIfaceTypeX to</span>
<a name="line-2461"></a><span class='hs-comment'>-- leave them as IfaceFreeTyVar.  This is super-important</span>
<a name="line-2462"></a><span class='hs-comment'>-- for debug printing.</span>
<a name="line-2463"></a><span class='hs-definition'>tidyToIfaceType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTypeX</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>free_tcvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2464"></a>  <span class='hs-keyword'>where</span>
<a name="line-2465"></a>    <span class='hs-varid'>env</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyCoVars</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>free_tcvs</span>
<a name="line-2466"></a>    <span class='hs-varid'>free_tcvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypeWellScoped</span> <span class='hs-varid'>ty</span>
<a name="line-2467"></a>
<a name="line-2468"></a><a name="pprClassPred"></a><span class='hs-comment'>------------</span>
<a name="line-2469"></a><span class='hs-definition'>pprClassPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2470"></a><span class='hs-definition'>pprClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTypeApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2471"></a>
<a name="line-2472"></a><a name="pprTheta"></a><span class='hs-comment'>------------</span>
<a name="line-2473"></a><span class='hs-definition'>pprTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2474"></a><span class='hs-definition'>pprTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceContext</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tidyToIfaceType</span>
<a name="line-2475"></a>
<a name="line-2476"></a><a name="pprThetaArrowTy"></a><span class='hs-definition'>pprThetaArrowTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2477"></a><span class='hs-definition'>pprThetaArrowTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceContextArr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tidyToIfaceType</span>
<a name="line-2478"></a>
<a name="line-2479"></a><a name="instance%20Outputable%20Type"></a><span class='hs-comment'>------------------</span>
<a name="line-2480"></a><a name="instance%20Outputable%20Type"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Type</span> <span class='hs-keyword'>where</span>
<a name="line-2481"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span>
<a name="line-2482"></a>
<a name="line-2483"></a><a name="instance%20Outputable%20TyLit"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyword'>where</span>
<a name="line-2484"></a>   <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyLit</span>
<a name="line-2485"></a>
<a name="line-2486"></a><span class='hs-comment'>------------------</span>
<a name="line-2487"></a>
<a name="line-2488"></a><a name="pprSigmaType"></a><span class='hs-definition'>pprSigmaType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2489"></a><span class='hs-definition'>pprSigmaType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceSigmaType</span> <span class='hs-conid'>ShowForAllWhen</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tidyToIfaceType</span>
<a name="line-2490"></a>
<a name="line-2491"></a><a name="pprForAll"></a><span class='hs-definition'>pprForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVarBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2492"></a><span class='hs-definition'>pprForAll</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceForAll</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceForAllBndr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2493"></a>
<a name="line-2494"></a><a name="pprUserForAll"></a><span class='hs-comment'>-- | Print a user-level forall; see Note [When to print foralls]</span>
<a name="line-2495"></a><span class='hs-definition'>pprUserForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVarBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2496"></a><span class='hs-definition'>pprUserForAll</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprUserIfaceForAll</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceForAllBndr</span>
<a name="line-2497"></a>
<a name="line-2498"></a><a name="pprTvBndrs"></a><span class='hs-definition'>pprTvBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVarBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2499"></a><span class='hs-definition'>pprTvBndrs</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprTvBndr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2500"></a>
<a name="line-2501"></a><a name="pprTvBndr"></a><span class='hs-definition'>pprTvBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2502"></a><span class='hs-definition'>pprTvBndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyVar</span> <span class='hs-varop'>.</span> <span class='hs-varid'>binderVar</span>
<a name="line-2503"></a>
<a name="line-2504"></a><a name="pprTyVars"></a><span class='hs-definition'>pprTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2505"></a><span class='hs-definition'>pprTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprTyVar</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2506"></a>
<a name="line-2507"></a><a name="pprTyVar"></a><span class='hs-definition'>pprTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2508"></a><span class='hs-comment'>-- Print a type variable binder with its kind (but not if *)</span>
<a name="line-2509"></a><span class='hs-comment'>-- Here we do not go via IfaceType, because the duplication with</span>
<a name="line-2510"></a><span class='hs-comment'>-- pprIfaceTvBndr is minimal, and the loss of uniques etc in</span>
<a name="line-2511"></a><span class='hs-comment'>-- debug printing is disastrous</span>
<a name="line-2512"></a><span class='hs-definition'>pprTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-2513"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span>
<a name="line-2514"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-2515"></a>  <span class='hs-keyword'>where</span>
<a name="line-2516"></a>    <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-2517"></a>
<a name="line-2518"></a><a name="instance%20Outputable%20TyBinder"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyword'>where</span>
<a name="line-2519"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[anon]"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-2520"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Required</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-2521"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Specified</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-2522"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Inferred</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-2523"></a>
<a name="line-2524"></a><a name="instance%20Outputable%20Coercion"></a><span class='hs-comment'>-----------------</span>
<a name="line-2525"></a><a name="instance%20Outputable%20Coercion"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyword'>where</span> <span class='hs-comment'>-- defined here to avoid orphans</span>
<a name="line-2526"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCo</span>
<a name="line-2527"></a>
<a name="line-2528"></a><span class='hs-comment'>{-
<a name="line-2529"></a>Note [When to print foralls]
<a name="line-2530"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2531"></a>Mostly we want to print top-level foralls when (and only when) the user specifies
<a name="line-2532"></a>-fprint-explicit-foralls.  But when kind polymorphism is at work, that suppresses
<a name="line-2533"></a>too much information; see Trac #9018.
<a name="line-2534"></a>
<a name="line-2535"></a>So I'm trying out this rule: print explicit foralls if
<a name="line-2536"></a>  a) User specifies -fprint-explicit-foralls, or
<a name="line-2537"></a>  b) Any of the quantified type variables has a kind
<a name="line-2538"></a>     that mentions a kind variable
<a name="line-2539"></a>
<a name="line-2540"></a>This catches common situations, such as a type siguature
<a name="line-2541"></a>     f :: m a
<a name="line-2542"></a>which means
<a name="line-2543"></a>      f :: forall k. forall (m :: k-&gt;*) (a :: k). m a
<a name="line-2544"></a>We really want to see both the "forall k" and the kind signatures
<a name="line-2545"></a>on m and a.  The latter comes from pprTvBndr.
<a name="line-2546"></a>
<a name="line-2547"></a>Note [Infix type variables]
<a name="line-2548"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2549"></a>With TypeOperators you can say
<a name="line-2550"></a>
<a name="line-2551"></a>   f :: (a ~&gt; b) -&gt; b
<a name="line-2552"></a>
<a name="line-2553"></a>and the (~&gt;) is considered a type variable.  However, the type
<a name="line-2554"></a>pretty-printer in this module will just see (a ~&gt; b) as
<a name="line-2555"></a>
<a name="line-2556"></a>   App (App (TyVarTy "~&gt;") (TyVarTy "a")) (TyVarTy "b")
<a name="line-2557"></a>
<a name="line-2558"></a>So it'll print the type in prefix form.  To avoid confusion we must
<a name="line-2559"></a>remember to parenthesise the operator, thus
<a name="line-2560"></a>
<a name="line-2561"></a>   (~&gt;) a b -&gt; b
<a name="line-2562"></a>
<a name="line-2563"></a>See Trac #2766.
<a name="line-2564"></a>-}</span>
<a name="line-2565"></a>
<a name="line-2566"></a><a name="pprDataCons"></a><span class='hs-definition'>pprDataCons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2567"></a><span class='hs-definition'>pprDataCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sepWithVBars</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>pprDataConWithArgs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyConDataCons</span>
<a name="line-2568"></a>  <span class='hs-keyword'>where</span>
<a name="line-2569"></a>    <span class='hs-varid'>sepWithVBars</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-2570"></a>    <span class='hs-varid'>sepWithVBars</span> <span class='hs-varid'>docs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-layout'>(</span><span class='hs-varid'>space</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>vbar</span><span class='hs-layout'>)</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-2571"></a>
<a name="line-2572"></a><a name="pprDataConWithArgs"></a><span class='hs-definition'>pprDataConWithArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2573"></a><span class='hs-definition'>pprDataConWithArgs</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>forAllDoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>thetaDoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>argsDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-2574"></a>  <span class='hs-keyword'>where</span>
<a name="line-2575"></a>    <span class='hs-layout'>(</span><span class='hs-sel'>_univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>dc</span>
<a name="line-2576"></a>    <span class='hs-varid'>univ_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUnivTyVarBinders</span> <span class='hs-varid'>dc</span>
<a name="line-2577"></a>    <span class='hs-varid'>ex_bndrs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConExTyVarBinders</span> <span class='hs-varid'>dc</span>
<a name="line-2578"></a>    <span class='hs-varid'>forAllDoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprUserForAll</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterEqSpec</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varid'>univ_bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ex_bndrs</span><span class='hs-layout'>)</span>
<a name="line-2579"></a>    <span class='hs-varid'>thetaDoc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprThetaArrowTy</span> <span class='hs-varid'>theta</span>
<a name="line-2580"></a>    <span class='hs-varid'>argsDoc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-2581"></a>
<a name="line-2582"></a>
<a name="line-2583"></a><a name="pprTypeApp"></a><span class='hs-definition'>pprTypeApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2584"></a><span class='hs-definition'>pprTypeApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2585"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceTypeApp</span> <span class='hs-conid'>TopPrec</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2586"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTcArgs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2587"></a>    <span class='hs-comment'>-- TODO: toIfaceTcArgs seems rather wasteful here</span>
<a name="line-2588"></a>
<a name="line-2589"></a><a name="pprTcAppCo"></a><span class='hs-definition'>pprTcAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-2590"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2591"></a><span class='hs-definition'>pprTcAppCo</span> <span class='hs-varid'>p</span> <span class='hs-sel'>_pp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-2592"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceCoTcApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceCoercion</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2593"></a>
<a name="line-2594"></a><span class='hs-comment'>------------------</span>
<a name="line-2595"></a>
<a name="line-2596"></a><a name="pprPrefixApp"></a><span class='hs-definition'>pprPrefixApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2597"></a><span class='hs-definition'>pprPrefixApp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfacePrefixApp</span>
<a name="line-2598"></a>
<a name="line-2599"></a><a name="pprArrowChain"></a><span class='hs-comment'>----------------</span>
<a name="line-2600"></a><span class='hs-definition'>pprArrowChain</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2601"></a><span class='hs-comment'>-- pprArrowChain p [a,b,c]  generates   a -&gt; b -&gt; c</span>
<a name="line-2602"></a><span class='hs-definition'>pprArrowChain</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-2603"></a><span class='hs-definition'>pprArrowChain</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-2604"></a>                             <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>arrow</span> <span class='hs-varop'>&lt;+&gt;</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2605"></a>
<a name="line-2606"></a><a name="ppSuggestExplicitKinds"></a><span class='hs-definition'>ppSuggestExplicitKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-2607"></a><span class='hs-comment'>-- Print a helpful suggstion about -fprint-explicit-kinds,</span>
<a name="line-2608"></a><span class='hs-comment'>-- if it is not already on</span>
<a name="line-2609"></a><span class='hs-definition'>ppSuggestExplicitKinds</span>
<a name="line-2610"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2611"></a>    <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_PrintExplicitKinds</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2612"></a>    <span class='hs-varid'>text</span> <span class='hs-str'>"Use -fprint-explicit-kinds to see the kind arguments"</span>
<a name="line-2613"></a>
<a name="line-2614"></a><span class='hs-comment'>{-
<a name="line-2615"></a>%************************************************************************
<a name="line-2616"></a>%*                                                                      *
<a name="line-2617"></a>\subsection{TidyType}
<a name="line-2618"></a>%*                                                                      *
<a name="line-2619"></a>%************************************************************************
<a name="line-2620"></a>-}</span>
<a name="line-2621"></a>
<a name="line-2622"></a><a name="tidyTyCoVarBndrs"></a><span class='hs-comment'>-- | This tidies up a type for printing in an error message, or in</span>
<a name="line-2623"></a><span class='hs-comment'>-- an interface file.</span>
<a name="line-2624"></a><span class='hs-comment'>--</span>
<a name="line-2625"></a><span class='hs-comment'>-- It doesn't change the uniques at all, just the print names.</span>
<a name="line-2626"></a><span class='hs-definition'>tidyTyCoVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2627"></a><span class='hs-definition'>tidyTyCoVarBndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-2628"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyTyCoVarBndr</span> <span class='hs-varid'>tidy_env'</span> <span class='hs-varid'>tvs</span>
<a name="line-2629"></a>  <span class='hs-keyword'>where</span>
<a name="line-2630"></a>    <span class='hs-comment'>-- Seed the occ_env with clashes among the names, see</span>
<a name="line-2631"></a>    <span class='hs-comment'>-- Node [Tidying multiple names at once] in OccName</span>
<a name="line-2632"></a>    <span class='hs-comment'>-- Se still go through tidyTyCoVarBndr so that each kind variable is tidied</span>
<a name="line-2633"></a>    <span class='hs-comment'>-- with the correct tidy_env</span>
<a name="line-2634"></a>    <span class='hs-varid'>occs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getHelpfulOccName</span> <span class='hs-varid'>tvs</span>
<a name="line-2635"></a>    <span class='hs-varid'>tidy_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>avoidClashesOccEnv</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>occs</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-2636"></a>
<a name="line-2637"></a><a name="tidyTyCoVarBndr"></a><span class='hs-definition'>tidyTyCoVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-2638"></a><span class='hs-definition'>tidyTyCoVarBndr</span> <span class='hs-varid'>tidy_env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvar</span>
<a name="line-2639"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tidyOccName</span> <span class='hs-varid'>occ_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>getHelpfulOccName</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-2640"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>occ_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>occ_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar'</span><span class='hs-layout'>)</span>
<a name="line-2641"></a>        <span class='hs-keyword'>where</span>
<a name="line-2642"></a>          <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>tyvar'</span>
<a name="line-2643"></a>          <span class='hs-varid'>tyvar'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>setTyVarName</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>name'</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind'</span>
<a name="line-2644"></a>          <span class='hs-varid'>kind'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyKind</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-2645"></a>          <span class='hs-varid'>name'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyNameOcc</span> <span class='hs-varid'>name</span> <span class='hs-varid'>occ'</span>
<a name="line-2646"></a>          <span class='hs-varid'>name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tyvar</span>
<a name="line-2647"></a>
<a name="line-2648"></a><a name="getHelpfulOccName"></a><span class='hs-definition'>getHelpfulOccName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-2649"></a><span class='hs-definition'>getHelpfulOccName</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ1</span>
<a name="line-2650"></a>  <span class='hs-keyword'>where</span>
<a name="line-2651"></a>    <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tyvar</span>
<a name="line-2652"></a>    <span class='hs-varid'>occ</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>name</span>
<a name="line-2653"></a>    <span class='hs-comment'>-- A TcTyVar with a System Name is probably a unification variable;</span>
<a name="line-2654"></a>    <span class='hs-comment'>-- when we tidy them we give them a trailing "0" (or 1 etc)</span>
<a name="line-2655"></a>    <span class='hs-comment'>-- so that they don't take precedence for the un-modified name</span>
<a name="line-2656"></a>    <span class='hs-comment'>-- Plus, indicating a unification variable in this way is a</span>
<a name="line-2657"></a>    <span class='hs-comment'>-- helpful clue for users</span>
<a name="line-2658"></a>    <span class='hs-varid'>occ1</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSystemName</span> <span class='hs-varid'>name</span>
<a name="line-2659"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tyvar</span>
<a name="line-2660"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>occNameString</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>++</span> <span class='hs-str'>"0"</span><span class='hs-layout'>)</span>
<a name="line-2661"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2662"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span>
<a name="line-2663"></a>
<a name="line-2664"></a><a name="tidyTyVarBinder"></a><span class='hs-definition'>tidyTyVarBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarBndr</span> <span class='hs-conid'>TyVar</span> <span class='hs-varid'>vis</span>
<a name="line-2665"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarBndr</span> <span class='hs-conid'>TyVar</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-2666"></a><span class='hs-definition'>tidyTyVarBinder</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-2667"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>TvBndr</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-2668"></a>  <span class='hs-keyword'>where</span>
<a name="line-2669"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyCoVarBndr</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>tv</span>
<a name="line-2670"></a>
<a name="line-2671"></a><a name="tidyTyVarBinders"></a><span class='hs-definition'>tidyTyVarBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVarBndr</span> <span class='hs-conid'>TyVar</span> <span class='hs-varid'>vis</span><span class='hs-keyglyph'>]</span>
<a name="line-2672"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVarBndr</span> <span class='hs-conid'>TyVar</span> <span class='hs-varid'>vis</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2673"></a><span class='hs-definition'>tidyTyVarBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyTyVarBinder</span>
<a name="line-2674"></a>
<a name="line-2675"></a><a name="tidyFreeTyCoVars"></a><span class='hs-comment'>---------------</span>
<a name="line-2676"></a><span class='hs-definition'>tidyFreeTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-2677"></a><span class='hs-comment'>-- ^ Add the free 'TyVar's to the env in tidy form,</span>
<a name="line-2678"></a><span class='hs-comment'>-- so that we can tidy the type they are free in</span>
<a name="line-2679"></a><span class='hs-definition'>tidyFreeTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>full_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvars</span>
<a name="line-2680"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyOpenTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>full_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-2681"></a>
<a name="line-2682"></a>        <span class='hs-comment'>---------------</span>
<a name="line-2683"></a><a name="tidyOpenTyCoVars"></a><span class='hs-definition'>tidyOpenTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2684"></a><span class='hs-definition'>tidyOpenTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyOpenTyCoVar</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tyvars</span>
<a name="line-2685"></a>
<a name="line-2686"></a><a name="tidyOpenTyCoVar"></a><span class='hs-comment'>---------------</span>
<a name="line-2687"></a><span class='hs-definition'>tidyOpenTyCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-2688"></a><span class='hs-comment'>-- ^ Treat a new 'TyCoVar' as a binder, and give it a fresh tidy name</span>
<a name="line-2689"></a><span class='hs-comment'>-- using the environment if one has not already been allocated. See</span>
<a name="line-2690"></a><span class='hs-comment'>-- also 'tidyTyCoVarBndr'</span>
<a name="line-2691"></a><span class='hs-definition'>tidyOpenTyCoVar</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvar</span>
<a name="line-2692"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyword'>of</span>
<a name="line-2693"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>tyvar'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar'</span><span class='hs-layout'>)</span>              <span class='hs-comment'>-- Already substituted</span>
<a name="line-2694"></a>        <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2695"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypeList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2696"></a>          <span class='hs-keyword'>in</span> <span class='hs-varid'>tidyTyCoVarBndr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>tyvar</span>  <span class='hs-comment'>-- Treat it as a binder</span>
<a name="line-2697"></a>
<a name="line-2698"></a><a name="tidyTyVarOcc"></a><span class='hs-comment'>---------------</span>
<a name="line-2699"></a><span class='hs-definition'>tidyTyVarOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-2700"></a><span class='hs-definition'>tidyTyVarOcc</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-2701"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-2702"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateTyVarKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-2703"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tv'</span>
<a name="line-2704"></a>
<a name="line-2705"></a><a name="tidyTypes"></a><span class='hs-comment'>---------------</span>
<a name="line-2706"></a><span class='hs-definition'>tidyTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2707"></a><span class='hs-definition'>tidyTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2708"></a>
<a name="line-2709"></a><a name="tidyType"></a><span class='hs-comment'>---------------</span>
<a name="line-2710"></a><span class='hs-definition'>tidyType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2711"></a><span class='hs-definition'>tidyType</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span>
<a name="line-2712"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyVarOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2713"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span>
<a name="line-2714"></a>                                    <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-2715"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-2716"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-2717"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys'</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>body_ty</span>
<a name="line-2718"></a>  <span class='hs-keyword'>where</span>
<a name="line-2719"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>vis</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys'</span> <span class='hs-varid'>ty</span>
<a name="line-2720"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyCoVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tvs</span>
<a name="line-2721"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2722"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2723"></a>
<a name="line-2724"></a>
<a name="line-2725"></a><a name="mkForAllTys'"></a><span class='hs-comment'>-- The following two functions differ from mkForAllTys and splitForAllTys in that</span>
<a name="line-2726"></a><span class='hs-comment'>-- they expect/preserve the ArgFlag argument. Thes belong to types/Type.hs, but</span>
<a name="line-2727"></a><span class='hs-comment'>-- how should they be named?</span>
<a name="line-2728"></a><span class='hs-definition'>mkForAllTys'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgFlag</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2729"></a><span class='hs-definition'>mkForAllTys'</span> <span class='hs-varid'>tvvs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>strictMkForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvvs</span>
<a name="line-2730"></a>  <span class='hs-keyword'>where</span>
<a name="line-2731"></a>    <span class='hs-varid'>strictMkForAllTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>ty</span>
<a name="line-2732"></a>
<a name="line-2733"></a><a name="splitForAllTys'"></a><span class='hs-definition'>splitForAllTys'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgFlag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-2734"></a><span class='hs-definition'>splitForAllTys'</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-2735"></a>  <span class='hs-keyword'>where</span>
<a name="line-2736"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>viss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>vis</span><span class='hs-conop'>:</span><span class='hs-varid'>viss</span><span class='hs-layout'>)</span>
<a name="line-2737"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>                            <span class='hs-varid'>tvs</span> <span class='hs-varid'>viss</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>viss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2738"></a>
<a name="line-2739"></a>
<a name="line-2740"></a><a name="tidyOpenTypes"></a><span class='hs-comment'>---------------</span>
<a name="line-2741"></a><span class='hs-comment'>-- | Grabs the free type variables, tidies them</span>
<a name="line-2742"></a><span class='hs-comment'>-- and then uses 'tidyType' to work over the type itself</span>
<a name="line-2743"></a><span class='hs-definition'>tidyOpenTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2744"></a><span class='hs-definition'>tidyOpenTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span>
<a name="line-2745"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>trimmed_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2746"></a>  <span class='hs-keyword'>where</span>
<a name="line-2747"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-varop'>$</span>
<a name="line-2748"></a>                                <span class='hs-varid'>tyCoVarsOfTypesWellScoped</span> <span class='hs-varid'>tys</span>
<a name="line-2749"></a>    <span class='hs-varid'>trimmed_occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initTidyOccEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span>
<a name="line-2750"></a>      <span class='hs-comment'>-- The idea here was that we restrict the new TidyEnv to the</span>
<a name="line-2751"></a>      <span class='hs-comment'>-- _free_ vars of the types, so that we don't gratuitously rename</span>
<a name="line-2752"></a>      <span class='hs-comment'>-- the _bound_ variables of the types.</span>
<a name="line-2753"></a>
<a name="line-2754"></a><a name="tidyOpenType"></a><span class='hs-comment'>---------------</span>
<a name="line-2755"></a><span class='hs-definition'>tidyOpenType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-2756"></a><span class='hs-definition'>tidyOpenType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTypes</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>in</span>
<a name="line-2757"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-2758"></a>
<a name="line-2759"></a><a name="tidyTopType"></a><span class='hs-comment'>---------------</span>
<a name="line-2760"></a><span class='hs-comment'>-- | Calls 'tidyType' on a top-level type (i.e. with an empty tidying environment)</span>
<a name="line-2761"></a><span class='hs-definition'>tidyTopType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2762"></a><span class='hs-definition'>tidyTopType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>ty</span>
<a name="line-2763"></a>
<a name="line-2764"></a><a name="tidyOpenKind"></a><span class='hs-comment'>---------------</span>
<a name="line-2765"></a><span class='hs-definition'>tidyOpenKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-2766"></a><span class='hs-definition'>tidyOpenKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span>
<a name="line-2767"></a>
<a name="line-2768"></a><a name="tidyKind"></a><span class='hs-definition'>tidyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-2769"></a><span class='hs-definition'>tidyKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span>
<a name="line-2770"></a>
<a name="line-2771"></a><a name="tidyCo"></a><span class='hs-comment'>----------------</span>
<a name="line-2772"></a><span class='hs-definition'>tidyCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2773"></a><span class='hs-definition'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-2774"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2775"></a>  <span class='hs-keyword'>where</span>
<a name="line-2776"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2777"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-2778"></a>                               <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-2779"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-2780"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>h</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>envp</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2781"></a>                               <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>envp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyCoVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-2782"></a>            <span class='hs-comment'>-- the case above duplicates a bit of work in tidying h and the kind</span>
<a name="line-2783"></a>            <span class='hs-comment'>-- of tv. But the alternative is to use coercionKind, which seems worse.</span>
<a name="line-2784"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-2785"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span> <span class='hs-keyword'>of</span>
<a name="line-2786"></a>                                 <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-2787"></a>                                 <span class='hs-conid'>Just</span> <span class='hs-varid'>cv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv'</span>
<a name="line-2788"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-2789"></a>                               <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span>
<a name="line-2790"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span>
<a name="line-2791"></a>                                <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t2</span>
<a name="line-2792"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2793"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-2794"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2795"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2796"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2797"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-2798"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2799"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2800"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cos1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-2801"></a>                               <span class='hs-keyword'>in</span> <span class='hs-varid'>cos1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cos1</span>
<a name="line-2802"></a>
<a name="line-2803"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnsafeCoerceProv</span>
<a name="line-2804"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2805"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2806"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-2807"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-2808"></a>
<a name="line-2809"></a><a name="tidyCos"></a><span class='hs-definition'>tidyCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-2810"></a><span class='hs-definition'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-2811"></a>
<a name="line-2812"></a>
<a name="line-2813"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2814"></a>*                                                                      *
<a name="line-2815"></a>                   typeSize, coercionSize
<a name="line-2816"></a>*                                                                      *
<a name="line-2817"></a>********************************************************************* -}</span>
<a name="line-2818"></a>
<a name="line-2819"></a><span class='hs-comment'>-- NB: We put typeSize/coercionSize here because they are mutually</span>
<a name="line-2820"></a><span class='hs-comment'>--     recursive, and have the CPR property.  If we have mutual</span>
<a name="line-2821"></a><span class='hs-comment'>--     recursion across a hi-boot file, we don't get the CPR property</span>
<a name="line-2822"></a><span class='hs-comment'>--     and these functions allocate a tremendous amount of rubbish.</span>
<a name="line-2823"></a><span class='hs-comment'>--     It's not critical (because typeSize is really only used in</span>
<a name="line-2824"></a><span class='hs-comment'>--     debug mode, but I tripped over an example (T5642) in which</span>
<a name="line-2825"></a><span class='hs-comment'>--     typeSize was one of the biggest single allocators in all of GHC.</span>
<a name="line-2826"></a><span class='hs-comment'>--     And it's easy to fix, so I did.</span>
<a name="line-2827"></a>
<a name="line-2828"></a><span class='hs-comment'>-- NB: typeSize does not respect `eqType`, in that two types that</span>
<a name="line-2829"></a><span class='hs-comment'>--     are `eqType` may return different sizes. This is OK, because this</span>
<a name="line-2830"></a><span class='hs-comment'>--     function is used only in reporting, not decision-making.</span>
<a name="line-2831"></a>
<a name="line-2832"></a><a name="typeSize"></a><span class='hs-definition'>typeSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-2833"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-2834"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-2835"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t2</span>
<a name="line-2836"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t2</span>
<a name="line-2837"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvBndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t</span>
<a name="line-2838"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-2839"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-2840"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-2841"></a>
<a name="line-2842"></a><a name="coercionSize"></a><span class='hs-definition'>coercionSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-2843"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span>
<a name="line-2844"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2845"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>arg</span>
<a name="line-2846"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>h</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>h</span>
<a name="line-2847"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co2</span>
<a name="line-2848"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-2849"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2850"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>provSize</span> <span class='hs-varid'>p</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t2</span>
<a name="line-2851"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-2852"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co2</span>
<a name="line-2853"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-2854"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-2855"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>arg</span>
<a name="line-2856"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoherenceCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>c2</span>
<a name="line-2857"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-2858"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-2859"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-2860"></a>
<a name="line-2861"></a><a name="provSize"></a><span class='hs-definition'>provSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-2862"></a><span class='hs-definition'>provSize</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-2863"></a><span class='hs-definition'>provSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-2864"></a><span class='hs-definition'>provSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-2865"></a><span class='hs-definition'>provSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-2866"></a><span class='hs-definition'>provSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleProv</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"provSize hits a hole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
</pre></body>
</html>
