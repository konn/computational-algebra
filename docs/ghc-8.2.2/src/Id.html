<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>basicTypes/Id.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-4"></a>
<a name="line-5"></a>\section[Id]{@Ids@: Value and constructor identifiers}
<a name="line-6"></a>-}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE ImplicitParams, CPP #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>-- |</span>
<a name="line-11"></a><span class='hs-comment'>-- #name_types#</span>
<a name="line-12"></a><span class='hs-comment'>-- GHC uses several kinds of name internally:</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-comment'>-- * 'OccName.OccName': see "OccName#name_types"</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-- * 'RdrName.RdrName': see "RdrName#name_types"</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>-- * 'Name.Name': see "Name#name_types"</span>
<a name="line-19"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><span class='hs-comment'>-- * 'Id.Id' represents names that not only have a 'Name.Name' but also a 'TyCoRep.Type' and some additional</span>
<a name="line-21"></a><span class='hs-comment'>--   details (a 'IdInfo.IdInfo' and one of 'Var.LocalIdDetails' or 'IdInfo.GlobalIdDetails') that</span>
<a name="line-22"></a><span class='hs-comment'>--   are added, modified and inspected by various compiler passes. These 'Var.Var' names may either</span>
<a name="line-23"></a><span class='hs-comment'>--   be global or local, see "Var#globalvslocal"</span>
<a name="line-24"></a><span class='hs-comment'>--</span>
<a name="line-25"></a><span class='hs-comment'>-- * 'Var.Var': see "Var#name_types"</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Id</span> <span class='hs-layout'>(</span>
<a name="line-28"></a>        <span class='hs-comment'>-- * The main types</span>
<a name="line-29"></a>        <span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-varid'>isId</span><span class='hs-layout'>,</span>
<a name="line-30"></a>
<a name="line-31"></a>        <span class='hs-comment'>-- * In and Out variants</span>
<a name="line-32"></a>        <span class='hs-conid'>InVar</span><span class='hs-layout'>,</span>  <span class='hs-conid'>InId</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-conid'>OutVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutId</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-comment'>-- ** Simple construction</span>
<a name="line-36"></a>        <span class='hs-varid'>mkGlobalId</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVanillaGlobal</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVanillaGlobalWithInfo</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>mkLocalId</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLocalCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLocalIdOrCoVar</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>mkLocalIdOrCoVarWithInfo</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>mkLocalIdWithInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkExportedLocalId</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkExportedVanillaId</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>mkSysLocal</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSysLocalM</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSysLocalOrCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSysLocalOrCoVarM</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>mkUserLocal</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUserLocalOrCoVar</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>mkTemplateLocals</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTemplateLocalsNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTemplateLocal</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>mkWorkerId</span><span class='hs-layout'>,</span>
<a name="line-44"></a>
<a name="line-45"></a>        <span class='hs-comment'>-- ** Taking an Id apart</span>
<a name="line-46"></a>        <span class='hs-varid'>idName</span><span class='hs-layout'>,</span> <span class='hs-varid'>idType</span><span class='hs-layout'>,</span> <span class='hs-varid'>idUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>idInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>idDetails</span><span class='hs-layout'>,</span>
<a name="line-47"></a>        <span class='hs-varid'>recordSelectorTyCon</span><span class='hs-layout'>,</span>
<a name="line-48"></a>
<a name="line-49"></a>        <span class='hs-comment'>-- ** Modifying an Id</span>
<a name="line-50"></a>        <span class='hs-varid'>setIdName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setIdUnique</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>setIdType</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>setIdExported</span><span class='hs-layout'>,</span> <span class='hs-varid'>setIdNotExported</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-varid'>globaliseId</span><span class='hs-layout'>,</span> <span class='hs-varid'>localiseId</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-varid'>setIdInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazySetIdInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>modifyIdInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeModifyIdInfo</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-varid'>zapLamIdInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapIdDemandInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapIdUsageInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapIdUsageEnvInfo</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>zapIdUsedOnceInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapIdTailCallInfo</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>zapFragileIdInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapIdStrictness</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>transferPolyIdInfo</span><span class='hs-layout'>,</span>
<a name="line-58"></a>
<a name="line-59"></a>        <span class='hs-comment'>-- ** Predicates on Ids</span>
<a name="line-60"></a>        <span class='hs-varid'>isImplicitId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDeadBinder</span><span class='hs-layout'>,</span>
<a name="line-61"></a>        <span class='hs-varid'>isStrictId</span><span class='hs-layout'>,</span>
<a name="line-62"></a>        <span class='hs-varid'>isExportedId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isLocalId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGlobalId</span><span class='hs-layout'>,</span>
<a name="line-63"></a>        <span class='hs-varid'>isRecordSelector</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNaughtyRecordSelector</span><span class='hs-layout'>,</span>
<a name="line-64"></a>        <span class='hs-varid'>isPatSynRecordSelector</span><span class='hs-layout'>,</span>
<a name="line-65"></a>        <span class='hs-varid'>isDataConRecordSelector</span><span class='hs-layout'>,</span>
<a name="line-66"></a>        <span class='hs-varid'>isClassOpId_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDFunId</span><span class='hs-layout'>,</span>
<a name="line-67"></a>        <span class='hs-varid'>isPrimOpId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPrimOpId_maybe</span><span class='hs-layout'>,</span>
<a name="line-68"></a>        <span class='hs-varid'>isFCallId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFCallId_maybe</span><span class='hs-layout'>,</span>
<a name="line-69"></a>        <span class='hs-varid'>isDataConWorkId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDataConWorkId_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDataConId_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>idDataCon</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-varid'>isConLikeId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBottomingId</span><span class='hs-layout'>,</span> <span class='hs-varid'>idIsFrom</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>hasNoBinding</span><span class='hs-layout'>,</span>
<a name="line-72"></a>
<a name="line-73"></a>        <span class='hs-comment'>-- ** Evidence variables</span>
<a name="line-74"></a>        <span class='hs-conid'>DictId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDictId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEvVar</span><span class='hs-layout'>,</span>
<a name="line-75"></a>
<a name="line-76"></a>        <span class='hs-comment'>-- ** Join variables</span>
<a name="line-77"></a>        <span class='hs-conid'>JoinId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isJoinId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isJoinId_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>idJoinArity</span><span class='hs-layout'>,</span>
<a name="line-78"></a>        <span class='hs-varid'>asJoinId</span><span class='hs-layout'>,</span> <span class='hs-varid'>asJoinId_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapJoinId</span><span class='hs-layout'>,</span>
<a name="line-79"></a>
<a name="line-80"></a>        <span class='hs-comment'>-- ** Inline pragma stuff</span>
<a name="line-81"></a>        <span class='hs-varid'>idInlinePragma</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInlinePragma</span><span class='hs-layout'>,</span> <span class='hs-varid'>modifyInlinePragma</span><span class='hs-layout'>,</span>
<a name="line-82"></a>        <span class='hs-varid'>idInlineActivation</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInlineActivation</span><span class='hs-layout'>,</span> <span class='hs-varid'>idRuleMatchInfo</span><span class='hs-layout'>,</span>
<a name="line-83"></a>
<a name="line-84"></a>        <span class='hs-comment'>-- ** One-shot lambdas</span>
<a name="line-85"></a>        <span class='hs-varid'>isOneShotBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>isProbablyOneShotLambda</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>setOneShotLambda</span><span class='hs-layout'>,</span> <span class='hs-varid'>clearOneShotLambda</span><span class='hs-layout'>,</span>
<a name="line-87"></a>        <span class='hs-varid'>updOneShotInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>setIdOneShotInfo</span><span class='hs-layout'>,</span>
<a name="line-88"></a>        <span class='hs-varid'>isStateHackType</span><span class='hs-layout'>,</span> <span class='hs-varid'>stateHackOneShot</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeOneShot</span><span class='hs-layout'>,</span>
<a name="line-89"></a>
<a name="line-90"></a>        <span class='hs-comment'>-- ** Reading 'IdInfo' fields</span>
<a name="line-91"></a>        <span class='hs-varid'>idArity</span><span class='hs-layout'>,</span>
<a name="line-92"></a>        <span class='hs-varid'>idCallArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>idFunRepArity</span><span class='hs-layout'>,</span>
<a name="line-93"></a>        <span class='hs-varid'>idUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>realIdUnfolding</span><span class='hs-layout'>,</span>
<a name="line-94"></a>        <span class='hs-varid'>idSpecialisation</span><span class='hs-layout'>,</span> <span class='hs-varid'>idCoreRules</span><span class='hs-layout'>,</span> <span class='hs-varid'>idHasRules</span><span class='hs-layout'>,</span>
<a name="line-95"></a>        <span class='hs-varid'>idCafInfo</span><span class='hs-layout'>,</span>
<a name="line-96"></a>        <span class='hs-varid'>idOneShotInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>idStateHackOneShotInfo</span><span class='hs-layout'>,</span>
<a name="line-97"></a>        <span class='hs-varid'>idOccInfo</span><span class='hs-layout'>,</span>
<a name="line-98"></a>        <span class='hs-varid'>isNeverLevPolyId</span><span class='hs-layout'>,</span>
<a name="line-99"></a>
<a name="line-100"></a>        <span class='hs-comment'>-- ** Writing 'IdInfo' fields</span>
<a name="line-101"></a>        <span class='hs-varid'>setIdUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCaseBndrEvald</span><span class='hs-layout'>,</span>
<a name="line-102"></a>        <span class='hs-varid'>setIdArity</span><span class='hs-layout'>,</span>
<a name="line-103"></a>        <span class='hs-varid'>setIdCallArity</span><span class='hs-layout'>,</span>
<a name="line-104"></a>
<a name="line-105"></a>        <span class='hs-varid'>setIdSpecialisation</span><span class='hs-layout'>,</span>
<a name="line-106"></a>        <span class='hs-varid'>setIdCafInfo</span><span class='hs-layout'>,</span>
<a name="line-107"></a>        <span class='hs-varid'>setIdOccInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapIdOccInfo</span><span class='hs-layout'>,</span>
<a name="line-108"></a>
<a name="line-109"></a>        <span class='hs-varid'>setIdDemandInfo</span><span class='hs-layout'>,</span>
<a name="line-110"></a>        <span class='hs-varid'>setIdStrictness</span><span class='hs-layout'>,</span>
<a name="line-111"></a>
<a name="line-112"></a>        <span class='hs-varid'>idDemandInfo</span><span class='hs-layout'>,</span>
<a name="line-113"></a>        <span class='hs-varid'>idStrictness</span><span class='hs-layout'>,</span>
<a name="line-114"></a>
<a name="line-115"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-116"></a>
<a name="line-117"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span> <span class='hs-layout'>(</span> <span class='hs-conid'>CoreRule</span><span class='hs-layout'>,</span> <span class='hs-varid'>evaldUnfolding</span><span class='hs-layout'>,</span> <span class='hs-conid'>Unfolding</span><span class='hs-layout'>(</span> <span class='hs-conid'>NoUnfolding</span> <span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-124"></a>
<a name="line-125"></a><span class='hs-comment'>-- Imported and re-exported</span>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span><span class='hs-layout'>(</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>DictId</span><span class='hs-layout'>,</span> <span class='hs-conid'>JoinId</span><span class='hs-layout'>,</span>
<a name="line-127"></a>            <span class='hs-conid'>InId</span><span class='hs-layout'>,</span>  <span class='hs-conid'>InVar</span><span class='hs-layout'>,</span>
<a name="line-128"></a>            <span class='hs-conid'>OutId</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutVar</span><span class='hs-layout'>,</span>
<a name="line-129"></a>            <span class='hs-varid'>idInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>idDetails</span><span class='hs-layout'>,</span> <span class='hs-varid'>setIdDetails</span><span class='hs-layout'>,</span> <span class='hs-varid'>globaliseId</span><span class='hs-layout'>,</span> <span class='hs-varid'>varType</span><span class='hs-layout'>,</span>
<a name="line-130"></a>            <span class='hs-varid'>isId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isLocalId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGlobalId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isExportedId</span> <span class='hs-layout'>)</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Var</span>
<a name="line-132"></a>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RepType</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>PrimOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimOp</span><span class='hs-layout'>)</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-150"></a>
<a name="line-151"></a><span class='hs-comment'>-- infixl so you can say (id `set` a `set` b)</span>
<a name="line-152"></a><span class='hs-keyword'>infixl</span>  <span class='hs-num'>1</span> <span class='hs-varop'>`setIdUnfolding`</span><span class='hs-layout'>,</span>
<a name="line-153"></a>          <span class='hs-varop'>`setIdArity`</span><span class='hs-layout'>,</span>
<a name="line-154"></a>          <span class='hs-varop'>`setIdCallArity`</span><span class='hs-layout'>,</span>
<a name="line-155"></a>          <span class='hs-varop'>`setIdOccInfo`</span><span class='hs-layout'>,</span>
<a name="line-156"></a>          <span class='hs-varop'>`setIdOneShotInfo`</span><span class='hs-layout'>,</span>
<a name="line-157"></a>
<a name="line-158"></a>          <span class='hs-varop'>`setIdSpecialisation`</span><span class='hs-layout'>,</span>
<a name="line-159"></a>          <span class='hs-varop'>`setInlinePragma`</span><span class='hs-layout'>,</span>
<a name="line-160"></a>          <span class='hs-varop'>`setInlineActivation`</span><span class='hs-layout'>,</span>
<a name="line-161"></a>          <span class='hs-varop'>`idCafInfo`</span><span class='hs-layout'>,</span>
<a name="line-162"></a>
<a name="line-163"></a>          <span class='hs-varop'>`setIdDemandInfo`</span><span class='hs-layout'>,</span>
<a name="line-164"></a>          <span class='hs-varop'>`setIdStrictness`</span><span class='hs-layout'>,</span>
<a name="line-165"></a>
<a name="line-166"></a>          <span class='hs-varop'>`asJoinId`</span><span class='hs-layout'>,</span>
<a name="line-167"></a>          <span class='hs-varop'>`asJoinId_maybe`</span>
<a name="line-168"></a>
<a name="line-169"></a><span class='hs-comment'>{-
<a name="line-170"></a>************************************************************************
<a name="line-171"></a>*                                                                      *
<a name="line-172"></a>\subsection{Basic Id manipulation}
<a name="line-173"></a>*                                                                      *
<a name="line-174"></a>************************************************************************
<a name="line-175"></a>-}</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="idName"></a><span class='hs-definition'>idName</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-178"></a><span class='hs-definition'>idName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span>
<a name="line-179"></a>
<a name="line-180"></a><a name="idUnique"></a><span class='hs-definition'>idUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>
<a name="line-181"></a><span class='hs-definition'>idUnique</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varUnique</span>
<a name="line-182"></a>
<a name="line-183"></a><a name="idType"></a><span class='hs-definition'>idType</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-184"></a><span class='hs-definition'>idType</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varType</span>
<a name="line-185"></a>
<a name="line-186"></a><a name="setIdName"></a><span class='hs-definition'>setIdName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-187"></a><span class='hs-definition'>setIdName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>setVarName</span>
<a name="line-188"></a>
<a name="line-189"></a><a name="setIdUnique"></a><span class='hs-definition'>setIdUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-190"></a><span class='hs-definition'>setIdUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>setVarUnique</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="setIdType"></a><span class='hs-comment'>-- | Not only does this set the 'Id' 'Type', it also evaluates the type to try and</span>
<a name="line-193"></a><span class='hs-comment'>-- reduce space usage</span>
<a name="line-194"></a><span class='hs-definition'>setIdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-195"></a><span class='hs-definition'>setIdType</span> <span class='hs-varid'>id</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>setVarType</span> <span class='hs-varid'>id</span> <span class='hs-varid'>ty</span>
<a name="line-196"></a>
<a name="line-197"></a><a name="setIdExported"></a><span class='hs-definition'>setIdExported</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-198"></a><span class='hs-definition'>setIdExported</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>setIdExported</span>
<a name="line-199"></a>
<a name="line-200"></a><a name="setIdNotExported"></a><span class='hs-definition'>setIdNotExported</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-201"></a><span class='hs-definition'>setIdNotExported</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>setIdNotExported</span>
<a name="line-202"></a>
<a name="line-203"></a><a name="localiseId"></a><span class='hs-definition'>localiseId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-204"></a><span class='hs-comment'>-- Make an with the same unique and type as the</span>
<a name="line-205"></a><span class='hs-comment'>-- incoming Id, but with an *Internal* Name and *LocalId* flavour</span>
<a name="line-206"></a><span class='hs-definition'>localiseId</span> <span class='hs-varid'>id</span>
<a name="line-207"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>id</span> <span class='hs-layout'>)</span> <span class='hs-varid'>isLocalId</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isInternalName</span> <span class='hs-varid'>name</span>
<a name="line-208"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-209"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-210"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>mkLocalVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>localiseName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-211"></a>  <span class='hs-keyword'>where</span>
<a name="line-212"></a>    <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="lazySetIdInfo"></a><span class='hs-definition'>lazySetIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-215"></a><span class='hs-definition'>lazySetIdInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>lazySetIdInfo</span>
<a name="line-216"></a>
<a name="line-217"></a><a name="setIdInfo"></a><span class='hs-definition'>setIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-218"></a><span class='hs-definition'>setIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-varop'>`seq`</span> <span class='hs-layout'>(</span><span class='hs-varid'>lazySetIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-219"></a>        <span class='hs-comment'>-- Try to avoid spack leaks by seq'ing</span>
<a name="line-220"></a>
<a name="line-221"></a><a name="modifyIdInfo"></a><span class='hs-definition'>modifyIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-222"></a><span class='hs-definition'>modifyIdInfo</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-223"></a>
<a name="line-224"></a><a name="maybeModifyIdInfo"></a><span class='hs-comment'>-- maybeModifyIdInfo tries to avoid unnecessary thrashing</span>
<a name="line-225"></a><span class='hs-definition'>maybeModifyIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-226"></a><span class='hs-definition'>maybeModifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>new_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lazySetIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>new_info</span>
<a name="line-227"></a><span class='hs-definition'>maybeModifyIdInfo</span> <span class='hs-conid'>Nothing</span>         <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-228"></a>
<a name="line-229"></a><span class='hs-comment'>{-
<a name="line-230"></a>************************************************************************
<a name="line-231"></a>*                                                                      *
<a name="line-232"></a>\subsection{Simple Id construction}
<a name="line-233"></a>*                                                                      *
<a name="line-234"></a>************************************************************************
<a name="line-235"></a>
<a name="line-236"></a>Absolutely all Ids are made by mkId.  It is just like Var.mkId,
<a name="line-237"></a>but in addition it pins free-tyvar-info onto the Id's type,
<a name="line-238"></a>where it can easily be found.
<a name="line-239"></a>
<a name="line-240"></a>Note [Free type variables]
<a name="line-241"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-242"></a>At one time we cached the free type variables of the type of an Id
<a name="line-243"></a>at the root of the type in a TyNote.  The idea was to avoid repeating
<a name="line-244"></a>the free-type-variable calculation.  But it turned out to slow down
<a name="line-245"></a>the compiler overall. I don't quite know why; perhaps finding free
<a name="line-246"></a>type variables of an Id isn't all that common whereas applying a
<a name="line-247"></a>substitution (which changes the free type variables) is more common.
<a name="line-248"></a>Anyway, we removed it in March 2008.
<a name="line-249"></a>-}</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="mkGlobalId"></a><span class='hs-comment'>-- | For an explanation of global vs. local 'Id's, see "Var#globalvslocal"</span>
<a name="line-252"></a><span class='hs-definition'>mkGlobalId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-253"></a><span class='hs-definition'>mkGlobalId</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>mkGlobalVar</span>
<a name="line-254"></a>
<a name="line-255"></a><a name="mkVanillaGlobal"></a><span class='hs-comment'>-- | Make a global 'Id' without any extra information at all</span>
<a name="line-256"></a><span class='hs-definition'>mkVanillaGlobal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-257"></a><span class='hs-definition'>mkVanillaGlobal</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVanillaGlobalWithInfo</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>vanillaIdInfo</span>
<a name="line-258"></a>
<a name="line-259"></a><a name="mkVanillaGlobalWithInfo"></a><span class='hs-comment'>-- | Make a global 'Id' with no global information but some generic 'IdInfo'</span>
<a name="line-260"></a><span class='hs-definition'>mkVanillaGlobalWithInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-261"></a><span class='hs-definition'>mkVanillaGlobalWithInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGlobalId</span> <span class='hs-conid'>VanillaId</span>
<a name="line-262"></a>
<a name="line-263"></a>
<a name="line-264"></a><a name="mkLocalId"></a><span class='hs-comment'>-- | For an explanation of global vs. local 'Id's, see "Var#globalvslocal"</span>
<a name="line-265"></a><span class='hs-definition'>mkLocalId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-266"></a><span class='hs-definition'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalIdWithInfo</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>vanillaIdInfo</span>
<a name="line-267"></a> <span class='hs-comment'>-- It's tempting to ASSERT( not (isCoercionType ty) ), but don't. Sometimes,</span>
<a name="line-268"></a> <span class='hs-comment'>-- the type is a panic. (Search invented_id)</span>
<a name="line-269"></a>
<a name="line-270"></a><a name="mkLocalCoVar"></a><span class='hs-comment'>-- | Make a local CoVar</span>
<a name="line-271"></a><span class='hs-definition'>mkLocalCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-272"></a><span class='hs-definition'>mkLocalCoVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span>
<a name="line-273"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoercionType</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>)</span>
<a name="line-274"></a>    <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>mkLocalVar</span> <span class='hs-conid'>CoVarId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>vanillaIdInfo</span>
<a name="line-275"></a>
<a name="line-276"></a><a name="mkLocalIdOrCoVar"></a><span class='hs-comment'>-- | Like 'mkLocalId', but checks the type to see if it should make a covar</span>
<a name="line-277"></a><span class='hs-definition'>mkLocalIdOrCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-278"></a><span class='hs-definition'>mkLocalIdOrCoVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span>
<a name="line-279"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoercionType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalCoVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span>
<a name="line-280"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span>    <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span>
<a name="line-281"></a>
<a name="line-282"></a><a name="mkLocalIdOrCoVarWithInfo"></a><span class='hs-comment'>-- | Make a local id, with the IdDetails set to CoVarId if the type indicates</span>
<a name="line-283"></a><span class='hs-comment'>-- so.</span>
<a name="line-284"></a><span class='hs-definition'>mkLocalIdOrCoVarWithInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-285"></a><span class='hs-definition'>mkLocalIdOrCoVarWithInfo</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-286"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>mkLocalVar</span> <span class='hs-varid'>details</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-287"></a>  <span class='hs-keyword'>where</span>
<a name="line-288"></a>    <span class='hs-varid'>details</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoercionType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoVarId</span>
<a name="line-289"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VanillaId</span>
<a name="line-290"></a>
<a name="line-291"></a>    <span class='hs-comment'>-- proper ids only; no covars!</span>
<a name="line-292"></a><a name="mkLocalIdWithInfo"></a><span class='hs-definition'>mkLocalIdWithInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-293"></a><span class='hs-definition'>mkLocalIdWithInfo</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>mkLocalVar</span> <span class='hs-conid'>VanillaId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-294"></a>        <span class='hs-comment'>-- Note [Free type variables]</span>
<a name="line-295"></a>
<a name="line-296"></a><a name="mkExportedLocalId"></a><span class='hs-comment'>-- | Create a local 'Id' that is marked as exported.</span>
<a name="line-297"></a><span class='hs-comment'>-- This prevents things attached to it from being removed as dead code.</span>
<a name="line-298"></a><span class='hs-comment'>-- See Note [Exported LocalIds]</span>
<a name="line-299"></a><span class='hs-definition'>mkExportedLocalId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-300"></a><span class='hs-definition'>mkExportedLocalId</span> <span class='hs-varid'>details</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>mkExportedLocalVar</span> <span class='hs-varid'>details</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>vanillaIdInfo</span>
<a name="line-301"></a>        <span class='hs-comment'>-- Note [Free type variables]</span>
<a name="line-302"></a>
<a name="line-303"></a><a name="mkExportedVanillaId"></a><span class='hs-definition'>mkExportedVanillaId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-304"></a><span class='hs-definition'>mkExportedVanillaId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>mkExportedLocalVar</span> <span class='hs-conid'>VanillaId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>vanillaIdInfo</span>
<a name="line-305"></a>        <span class='hs-comment'>-- Note [Free type variables]</span>
<a name="line-306"></a>
<a name="line-307"></a>
<a name="line-308"></a><a name="mkSysLocal"></a><span class='hs-comment'>-- | Create a system local 'Id'. These are local 'Id's (see "Var#globalvslocal")</span>
<a name="line-309"></a><span class='hs-comment'>-- that are created by the compiler out of thin air</span>
<a name="line-310"></a><span class='hs-definition'>mkSysLocal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-311"></a><span class='hs-definition'>mkSysLocal</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoercionType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-312"></a>                        <span class='hs-varid'>mkLocalId</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSystemVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-313"></a>
<a name="line-314"></a><a name="mkSysLocalOrCoVar"></a><span class='hs-comment'>-- | Like 'mkSysLocal', but checks to see if we have a covar type</span>
<a name="line-315"></a><span class='hs-definition'>mkSysLocalOrCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-316"></a><span class='hs-definition'>mkSysLocalOrCoVar</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span>
<a name="line-317"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalIdOrCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSystemVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-318"></a>
<a name="line-319"></a><a name="mkSysLocalM"></a><span class='hs-definition'>mkSysLocalM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Id</span>
<a name="line-320"></a><span class='hs-definition'>mkSysLocalM</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUniqueM</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSysLocal</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-321"></a>
<a name="line-322"></a><a name="mkSysLocalOrCoVarM"></a><span class='hs-definition'>mkSysLocalOrCoVarM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Id</span>
<a name="line-323"></a><span class='hs-definition'>mkSysLocalOrCoVarM</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>ty</span>
<a name="line-324"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUniqueM</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSysLocalOrCoVar</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="mkUserLocal"></a><span class='hs-comment'>-- | Create a user local 'Id'. These are local 'Id's (see "Var#globalvslocal") with a name and location that the user might recognize</span>
<a name="line-327"></a><span class='hs-definition'>mkUserLocal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-328"></a><span class='hs-definition'>mkUserLocal</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoercionType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-329"></a>                              <span class='hs-varid'>mkLocalId</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-330"></a>
<a name="line-331"></a><a name="mkUserLocalOrCoVar"></a><span class='hs-comment'>-- | Like 'mkUserLocal', but checks if we have a coercion type</span>
<a name="line-332"></a><span class='hs-definition'>mkUserLocalOrCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-333"></a><span class='hs-definition'>mkUserLocalOrCoVar</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>loc</span>
<a name="line-334"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalIdOrCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-335"></a>
<a name="line-336"></a><span class='hs-comment'>{-
<a name="line-337"></a>Make some local @Ids@ for a template @CoreExpr@.  These have bogus
<a name="line-338"></a>@Uniques@, but that's OK because the templates are supposed to be
<a name="line-339"></a>instantiated before use.
<a name="line-340"></a>-}</span>
<a name="line-341"></a>
<a name="line-342"></a><a name="mkWorkerId"></a><span class='hs-comment'>-- | Workers get local names. "CoreTidy" will externalise these if necessary</span>
<a name="line-343"></a><span class='hs-definition'>mkWorkerId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-344"></a><span class='hs-definition'>mkWorkerId</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>unwrkr</span> <span class='hs-varid'>ty</span>
<a name="line-345"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalIdOrCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDerivedInternalName</span> <span class='hs-varid'>mkWorkerOcc</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>unwrkr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-346"></a>
<a name="line-347"></a><a name="mkTemplateLocal"></a><span class='hs-comment'>-- | Create a /template local/: a family of system local 'Id's in bijection with @Int@s, typically used in unfoldings</span>
<a name="line-348"></a><span class='hs-definition'>mkTemplateLocal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-349"></a><span class='hs-definition'>mkTemplateLocal</span> <span class='hs-varid'>i</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSysLocalOrCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"v"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBuiltinUnique</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-350"></a>
<a name="line-351"></a><a name="mkTemplateLocals"></a><span class='hs-comment'>-- | Create a template local for a series of types</span>
<a name="line-352"></a><span class='hs-definition'>mkTemplateLocals</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-353"></a><span class='hs-definition'>mkTemplateLocals</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTemplateLocalsNum</span> <span class='hs-num'>1</span>
<a name="line-354"></a>
<a name="line-355"></a><a name="mkTemplateLocalsNum"></a><span class='hs-comment'>-- | Create a template local for a series of type, but start from a specified template local</span>
<a name="line-356"></a><span class='hs-definition'>mkTemplateLocalsNum</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-357"></a><span class='hs-definition'>mkTemplateLocalsNum</span> <span class='hs-varid'>n</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkTemplateLocal</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>tys</span>
<a name="line-358"></a>
<a name="line-359"></a><span class='hs-comment'>{- Note [Exported LocalIds]
<a name="line-360"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-361"></a>We use mkExportedLocalId for things like
<a name="line-362"></a> - Dictionary functions (DFunId)
<a name="line-363"></a> - Wrapper and matcher Ids for pattern synonyms
<a name="line-364"></a> - Default methods for classes
<a name="line-365"></a> - Pattern-synonym matcher and builder Ids
<a name="line-366"></a> - etc
<a name="line-367"></a>
<a name="line-368"></a>They marked as "exported" in the sense that they should be kept alive
<a name="line-369"></a>even if apparently unused in other bindings, and not dropped as dead
<a name="line-370"></a>code by the occurrence analyser.  (But "exported" here does not mean
<a name="line-371"></a>"brought into lexical scope by an import declaration". Indeed these
<a name="line-372"></a>things are always internal Ids that the user never sees.)
<a name="line-373"></a>
<a name="line-374"></a>It's very important that they are *LocalIds*, not GlobalIds, for lots
<a name="line-375"></a>of reasons:
<a name="line-376"></a>
<a name="line-377"></a> * We want to treat them as free variables for the purpose of
<a name="line-378"></a>   dependency analysis (e.g. CoreFVs.exprFreeVars).
<a name="line-379"></a>
<a name="line-380"></a> * Look them up in the current substitution when we come across
<a name="line-381"></a>   occurrences of them (in Subst.lookupIdSubst). Lacking this we
<a name="line-382"></a>   can get an out-of-date unfolding, which can in turn make the
<a name="line-383"></a>   simplifier go into an infinite loop (Trac #9857)
<a name="line-384"></a>
<a name="line-385"></a> * Ensure that for dfuns that the specialiser does not float dict uses
<a name="line-386"></a>   above their defns, which would prevent good simplifications happening.
<a name="line-387"></a>
<a name="line-388"></a> * The strictness analyser treats a occurrence of a GlobalId as
<a name="line-389"></a>   imported and assumes it contains strictness in its IdInfo, which
<a name="line-390"></a>   isn't true if the thing is bound in the same module as the
<a name="line-391"></a>   occurrence.
<a name="line-392"></a>
<a name="line-393"></a>In CoreTidy we must make all these LocalIds into GlobalIds, so that in
<a name="line-394"></a>importing modules (in --make mode) we treat them as properly global.
<a name="line-395"></a>That is what is happening in, say tidy_insts in TidyPgm.
<a name="line-396"></a>
<a name="line-397"></a>************************************************************************
<a name="line-398"></a>*                                                                      *
<a name="line-399"></a>\subsection{Special Ids}
<a name="line-400"></a>*                                                                      *
<a name="line-401"></a>************************************************************************
<a name="line-402"></a>-}</span>
<a name="line-403"></a>
<a name="line-404"></a><a name="recordSelectorTyCon"></a><span class='hs-comment'>-- | If the 'Id' is that for a record selector, extract the 'sel_tycon'. Panic otherwise.</span>
<a name="line-405"></a><span class='hs-definition'>recordSelectorTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecSelParent</span>
<a name="line-406"></a><span class='hs-definition'>recordSelectorTyCon</span> <span class='hs-varid'>id</span>
<a name="line-407"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-408"></a>        <span class='hs-conid'>RecSelId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sel_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parent</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>parent</span>
<a name="line-409"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"recordSelectorTyCon"</span>
<a name="line-410"></a>
<a name="line-411"></a>
<a name="line-412"></a><a name="isRecordSelector"></a><span class='hs-definition'>isRecordSelector</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-413"></a><a name="isNaughtyRecordSelector"></a><span class='hs-definition'>isNaughtyRecordSelector</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-414"></a><a name="isPatSynRecordSelector"></a><span class='hs-definition'>isPatSynRecordSelector</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-415"></a><a name="isDataConRecordSelector"></a><span class='hs-definition'>isDataConRecordSelector</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-416"></a><a name="isPrimOpId"></a><span class='hs-definition'>isPrimOpId</span>              <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-417"></a><a name="isFCallId"></a><span class='hs-definition'>isFCallId</span>               <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-418"></a><a name="isDataConWorkId"></a><span class='hs-definition'>isDataConWorkId</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-419"></a><a name="isDFunId"></a><span class='hs-definition'>isDFunId</span>                <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-420"></a>
<a name="line-421"></a><a name="isClassOpId_maybe"></a><span class='hs-definition'>isClassOpId_maybe</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Class</span>
<a name="line-422"></a><a name="isPrimOpId_maybe"></a><span class='hs-definition'>isPrimOpId_maybe</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PrimOp</span>
<a name="line-423"></a><a name="isFCallId_maybe"></a><span class='hs-definition'>isFCallId_maybe</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-424"></a><a name="isDataConWorkId_maybe"></a><span class='hs-definition'>isDataConWorkId_maybe</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DataCon</span>
<a name="line-425"></a>
<a name="line-426"></a><span class='hs-definition'>isRecordSelector</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-427"></a>                        <span class='hs-conid'>RecSelId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-428"></a>                        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-429"></a>
<a name="line-430"></a><span class='hs-definition'>isDataConRecordSelector</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-431"></a>                        <span class='hs-conid'>RecSelId</span> <span class='hs-layout'>{</span><span class='hs-varid'>sel_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecSelData</span> <span class='hs-keyword'>_</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-432"></a>                        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-433"></a>
<a name="line-434"></a><span class='hs-definition'>isPatSynRecordSelector</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-435"></a>                        <span class='hs-conid'>RecSelId</span> <span class='hs-layout'>{</span><span class='hs-varid'>sel_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecSelPatSyn</span> <span class='hs-keyword'>_</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-436"></a>                        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-437"></a>
<a name="line-438"></a><span class='hs-definition'>isNaughtyRecordSelector</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-439"></a>                        <span class='hs-conid'>RecSelId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sel_naughty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span>
<a name="line-440"></a>                        <span class='hs-keyword'>_</span>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-441"></a>
<a name="line-442"></a><span class='hs-definition'>isClassOpId_maybe</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-443"></a>                        <span class='hs-conid'>ClassOpId</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span>
<a name="line-444"></a>                        <span class='hs-sel'>_other</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-445"></a>
<a name="line-446"></a><span class='hs-definition'>isPrimOpId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-447"></a>                        <span class='hs-conid'>PrimOpId</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-448"></a>                        <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-449"></a>
<a name="line-450"></a><span class='hs-definition'>isDFunId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-451"></a>                        <span class='hs-conid'>DFunId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-452"></a>                        <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-453"></a>
<a name="line-454"></a><span class='hs-definition'>isPrimOpId_maybe</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-455"></a>                        <span class='hs-conid'>PrimOpId</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>op</span>
<a name="line-456"></a>                        <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-457"></a>
<a name="line-458"></a><span class='hs-definition'>isFCallId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-459"></a>                        <span class='hs-conid'>FCallId</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-460"></a>                        <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-461"></a>
<a name="line-462"></a><span class='hs-definition'>isFCallId_maybe</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-463"></a>                        <span class='hs-conid'>FCallId</span> <span class='hs-varid'>call</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>call</span>
<a name="line-464"></a>                        <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-465"></a>
<a name="line-466"></a><span class='hs-definition'>isDataConWorkId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-467"></a>                        <span class='hs-conid'>DataConWorkId</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-468"></a>                        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-469"></a>
<a name="line-470"></a><span class='hs-definition'>isDataConWorkId_maybe</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-471"></a>                        <span class='hs-conid'>DataConWorkId</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span>
<a name="line-472"></a>                        <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-473"></a>
<a name="line-474"></a><a name="isDataConId_maybe"></a><span class='hs-definition'>isDataConId_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DataCon</span>
<a name="line-475"></a><span class='hs-definition'>isDataConId_maybe</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-476"></a>                         <span class='hs-conid'>DataConWorkId</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span>
<a name="line-477"></a>                         <span class='hs-conid'>DataConWrapId</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span>
<a name="line-478"></a>                         <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-479"></a>
<a name="line-480"></a><a name="isJoinId"></a><span class='hs-definition'>isJoinId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-481"></a><span class='hs-comment'>-- It is convenient in SetLevels.lvlMFE to apply isJoinId</span>
<a name="line-482"></a><span class='hs-comment'>-- to the free vars of an expression, so it's convenient</span>
<a name="line-483"></a><span class='hs-comment'>-- if it returns False for type variables</span>
<a name="line-484"></a><span class='hs-definition'>isJoinId</span> <span class='hs-varid'>id</span>
<a name="line-485"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-486"></a>                <span class='hs-conid'>JoinId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-487"></a>                <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-488"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-489"></a>
<a name="line-490"></a><a name="isJoinId_maybe"></a><span class='hs-definition'>isJoinId_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>JoinArity</span>
<a name="line-491"></a><span class='hs-definition'>isJoinId_maybe</span> <span class='hs-varid'>id</span>
<a name="line-492"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>id</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-layout'>)</span>
<a name="line-493"></a>              <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-494"></a>                <span class='hs-conid'>JoinId</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arity</span>
<a name="line-495"></a>                <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-496"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-497"></a>
<a name="line-498"></a><a name="idDataCon"></a><span class='hs-definition'>idDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span>
<a name="line-499"></a><span class='hs-comment'>-- ^ Get from either the worker or the wrapper 'Id' to the 'DataCon'. Currently used only in the desugarer.</span>
<a name="line-500"></a><span class='hs-comment'>--</span>
<a name="line-501"></a><span class='hs-comment'>-- INVARIANT: @idDataCon (dataConWrapId d) = d@: remember, 'dataConWrapId' can return either the wrapper or the worker</span>
<a name="line-502"></a><span class='hs-definition'>idDataCon</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDataConId_maybe</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"idDataCon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-503"></a>
<a name="line-504"></a><a name="hasNoBinding"></a><span class='hs-definition'>hasNoBinding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-505"></a><span class='hs-comment'>-- ^ Returns @True@ of an 'Id' which may not have a</span>
<a name="line-506"></a><span class='hs-comment'>-- binding, even though it is defined in this module.</span>
<a name="line-507"></a>
<a name="line-508"></a><span class='hs-comment'>-- Data constructor workers used to be things of this kind, but</span>
<a name="line-509"></a><span class='hs-comment'>-- they aren't any more.  Instead, we inject a binding for</span>
<a name="line-510"></a><span class='hs-comment'>-- them at the CorePrep stage.</span>
<a name="line-511"></a><span class='hs-comment'>-- EXCEPT: unboxed tuples, which definitely have no binding</span>
<a name="line-512"></a><span class='hs-definition'>hasNoBinding</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-513"></a>                        <span class='hs-conid'>PrimOpId</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>        <span class='hs-comment'>-- See Note [Primop wrappers]</span>
<a name="line-514"></a>                        <span class='hs-conid'>FCallId</span> <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-515"></a>                        <span class='hs-conid'>DataConWorkId</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isUnboxedTupleCon</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isUnboxedSumCon</span> <span class='hs-varid'>dc</span>
<a name="line-516"></a>                        <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-517"></a>
<a name="line-518"></a><a name="isImplicitId"></a><span class='hs-definition'>isImplicitId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-519"></a><span class='hs-comment'>-- ^ 'isImplicitId' tells whether an 'Id's info is implied by other</span>
<a name="line-520"></a><span class='hs-comment'>-- declarations, so we don't need to put its signature in an interface</span>
<a name="line-521"></a><span class='hs-comment'>-- file, even if it's mentioned in some other interface unfolding.</span>
<a name="line-522"></a><span class='hs-definition'>isImplicitId</span> <span class='hs-varid'>id</span>
<a name="line-523"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-524"></a>        <span class='hs-conid'>FCallId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-525"></a>        <span class='hs-conid'>ClassOpId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-526"></a>        <span class='hs-conid'>PrimOpId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-527"></a>        <span class='hs-conid'>DataConWorkId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-528"></a>        <span class='hs-conid'>DataConWrapId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-529"></a>                <span class='hs-comment'>-- These are implied by their type or class decl;</span>
<a name="line-530"></a>                <span class='hs-comment'>-- remember that all type and class decls appear in the interface file.</span>
<a name="line-531"></a>                <span class='hs-comment'>-- The dfun id is not an implicit Id; it must *not* be omitted, because</span>
<a name="line-532"></a>                <span class='hs-comment'>-- it carries version info for the instance decl</span>
<a name="line-533"></a>        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-534"></a>
<a name="line-535"></a><a name="idIsFrom"></a><span class='hs-definition'>idIsFrom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-536"></a><span class='hs-definition'>idIsFrom</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-537"></a>
<a name="line-538"></a><span class='hs-comment'>{-
<a name="line-539"></a>Note [Primop wrappers]
<a name="line-540"></a>~~~~~~~~~~~~~~~~~~~~~~
<a name="line-541"></a>Currently hasNoBinding claims that PrimOpIds don't have a curried
<a name="line-542"></a>function definition.  But actually they do, in GHC.PrimopWrappers,
<a name="line-543"></a>which is auto-generated from prelude/primops.txt.pp.  So actually, hasNoBinding
<a name="line-544"></a>could return 'False' for PrimOpIds.
<a name="line-545"></a>
<a name="line-546"></a>But we'd need to add something in CoreToStg to swizzle any unsaturated
<a name="line-547"></a>applications of GHC.Prim.plusInt# to GHC.PrimopWrappers.plusInt#.
<a name="line-548"></a>
<a name="line-549"></a>Nota Bene: GHC.PrimopWrappers is needed *regardless*, because it's
<a name="line-550"></a>used by GHCi, which does not implement primops direct at all.
<a name="line-551"></a>-}</span>
<a name="line-552"></a>
<a name="line-553"></a><a name="isDeadBinder"></a><span class='hs-definition'>isDeadBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-554"></a><span class='hs-definition'>isDeadBinder</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDeadOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>idOccInfo</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-555"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>   <span class='hs-comment'>-- TyVars count as not dead</span>
<a name="line-556"></a>
<a name="line-557"></a><span class='hs-comment'>{-
<a name="line-558"></a>************************************************************************
<a name="line-559"></a>*                                                                      *
<a name="line-560"></a>              Evidence variables
<a name="line-561"></a>*                                                                      *
<a name="line-562"></a>************************************************************************
<a name="line-563"></a>-}</span>
<a name="line-564"></a>
<a name="line-565"></a><a name="isEvVar"></a><span class='hs-definition'>isEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-566"></a><span class='hs-definition'>isEvVar</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isPredTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-567"></a>
<a name="line-568"></a><a name="isDictId"></a><span class='hs-definition'>isDictId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-569"></a><span class='hs-definition'>isDictId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDictTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-570"></a>
<a name="line-571"></a><span class='hs-comment'>{-
<a name="line-572"></a>************************************************************************
<a name="line-573"></a>*                                                                      *
<a name="line-574"></a>              Join variables
<a name="line-575"></a>*                                                                      *
<a name="line-576"></a>************************************************************************
<a name="line-577"></a>-}</span>
<a name="line-578"></a>
<a name="line-579"></a><a name="idJoinArity"></a><span class='hs-definition'>idJoinArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JoinId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JoinArity</span>
<a name="line-580"></a><span class='hs-definition'>idJoinArity</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJoinId_maybe</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"idJoinArity"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-581"></a>
<a name="line-582"></a><a name="asJoinId"></a><span class='hs-definition'>asJoinId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JoinArity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JoinId</span>
<a name="line-583"></a><span class='hs-definition'>asJoinId</span> <span class='hs-varid'>id</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLocalId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-584"></a>                         <span class='hs-varid'>text</span> <span class='hs-str'>"global id being marked as join var:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-585"></a>                    <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_vanilla_or_join</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-586"></a>                         <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprIdDetails</span> <span class='hs-layout'>(</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-587"></a>                    <span class='hs-varid'>id</span> <span class='hs-varop'>`setIdDetails`</span> <span class='hs-conid'>JoinId</span> <span class='hs-varid'>arity</span>
<a name="line-588"></a>  <span class='hs-keyword'>where</span>
<a name="line-589"></a>    <span class='hs-varid'>is_vanilla_or_join</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-590"></a>                              <span class='hs-conid'>VanillaId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-591"></a>                              <span class='hs-conid'>JoinId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-592"></a>                              <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-593"></a>
<a name="line-594"></a><a name="zapJoinId"></a><span class='hs-definition'>zapJoinId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-595"></a><span class='hs-comment'>-- May be a regular id already</span>
<a name="line-596"></a><span class='hs-definition'>zapJoinId</span> <span class='hs-varid'>jid</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isJoinId</span> <span class='hs-varid'>jid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapIdTailCallInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>jid</span> <span class='hs-varop'>`setIdDetails`</span> <span class='hs-conid'>VanillaId</span><span class='hs-layout'>)</span>
<a name="line-597"></a>                                 <span class='hs-comment'>-- Core Lint may complain if still marked</span>
<a name="line-598"></a>                                 <span class='hs-comment'>-- as AlwaysTailCalled</span>
<a name="line-599"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>jid</span>
<a name="line-600"></a>
<a name="line-601"></a><a name="asJoinId_maybe"></a><span class='hs-definition'>asJoinId_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>JoinArity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-602"></a><span class='hs-definition'>asJoinId_maybe</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>asJoinId</span> <span class='hs-varid'>id</span> <span class='hs-varid'>arity</span>
<a name="line-603"></a><span class='hs-definition'>asJoinId_maybe</span> <span class='hs-varid'>id</span> <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapJoinId</span> <span class='hs-varid'>id</span>
<a name="line-604"></a>
<a name="line-605"></a><span class='hs-comment'>{-
<a name="line-606"></a>************************************************************************
<a name="line-607"></a>*                                                                      *
<a name="line-608"></a>\subsection{IdInfo stuff}
<a name="line-609"></a>*                                                                      *
<a name="line-610"></a>************************************************************************
<a name="line-611"></a>-}</span>
<a name="line-612"></a>
<a name="line-613"></a>        <span class='hs-comment'>---------------------------------</span>
<a name="line-614"></a>        <span class='hs-comment'>-- ARITY</span>
<a name="line-615"></a><a name="idArity"></a><span class='hs-definition'>idArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-616"></a><span class='hs-definition'>idArity</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-617"></a>
<a name="line-618"></a><a name="setIdArity"></a><span class='hs-definition'>setIdArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-619"></a><span class='hs-definition'>setIdArity</span> <span class='hs-varid'>id</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setArityInfo`</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-620"></a>
<a name="line-621"></a><a name="idCallArity"></a><span class='hs-definition'>idCallArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-622"></a><span class='hs-definition'>idCallArity</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callArityInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-623"></a>
<a name="line-624"></a><a name="setIdCallArity"></a><span class='hs-definition'>setIdCallArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-625"></a><span class='hs-definition'>setIdCallArity</span> <span class='hs-varid'>id</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setCallArityInfo`</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-626"></a>
<a name="line-627"></a><a name="idFunRepArity"></a><span class='hs-definition'>idFunRepArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RepArity</span>
<a name="line-628"></a><span class='hs-definition'>idFunRepArity</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>countFunRepArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idArity</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-629"></a>
<a name="line-630"></a><a name="isBottomingId"></a><span class='hs-comment'>-- | Returns true if an application to n args would diverge</span>
<a name="line-631"></a><span class='hs-definition'>isBottomingId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-632"></a><span class='hs-definition'>isBottomingId</span> <span class='hs-varid'>v</span>
<a name="line-633"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>v</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBottomingSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>idStrictness</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-634"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-635"></a>
<a name="line-636"></a><a name="idStrictness"></a><span class='hs-definition'>idStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-637"></a><span class='hs-definition'>idStrictness</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strictnessInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-638"></a>
<a name="line-639"></a><a name="setIdStrictness"></a><span class='hs-definition'>setIdStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-640"></a><span class='hs-definition'>setIdStrictness</span> <span class='hs-varid'>id</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setStrictnessInfo`</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-641"></a>
<a name="line-642"></a><a name="zapIdStrictness"></a><span class='hs-definition'>zapIdStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-643"></a><span class='hs-definition'>zapIdStrictness</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setStrictnessInfo`</span> <span class='hs-varid'>nopSig</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-644"></a>
<a name="line-645"></a><a name="isStrictId"></a><span class='hs-comment'>-- | This predicate says whether the 'Id' has a strict demand placed on it or</span>
<a name="line-646"></a><span class='hs-comment'>-- has a type such that it can always be evaluated strictly (i.e an</span>
<a name="line-647"></a><span class='hs-comment'>-- unlifted type, as of GHC 7.6).  We need to</span>
<a name="line-648"></a><span class='hs-comment'>-- check separately whether the 'Id' has a so-called \"strict type\" because if</span>
<a name="line-649"></a><span class='hs-comment'>-- the demand for the given @id@ hasn't been computed yet but @id@ has a strict</span>
<a name="line-650"></a><span class='hs-comment'>-- type, we still want @isStrictId id@ to be @True@.</span>
<a name="line-651"></a><span class='hs-definition'>isStrictId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-652"></a><span class='hs-definition'>isStrictId</span> <span class='hs-varid'>id</span>
<a name="line-653"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"isStrictId: not an id: "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-layout'>)</span>
<a name="line-654"></a>         <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJoinId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span>
<a name="line-655"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>isStrictType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-656"></a>           <span class='hs-comment'>-- Take the best of both strictnesses - old and new</span>
<a name="line-657"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>isStrictDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>idDemandInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-658"></a>         <span class='hs-layout'>)</span>
<a name="line-659"></a>
<a name="line-660"></a>        <span class='hs-comment'>---------------------------------</span>
<a name="line-661"></a>        <span class='hs-comment'>-- UNFOLDING</span>
<a name="line-662"></a><a name="idUnfolding"></a><span class='hs-definition'>idUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-663"></a><span class='hs-comment'>-- Do not expose the unfolding of a loop breaker!</span>
<a name="line-664"></a><span class='hs-definition'>idUnfolding</span> <span class='hs-varid'>id</span>
<a name="line-665"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStrongLoopBreaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>occInfo</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoUnfolding</span>
<a name="line-666"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>info</span>
<a name="line-667"></a>  <span class='hs-keyword'>where</span>
<a name="line-668"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span>
<a name="line-669"></a>
<a name="line-670"></a><a name="realIdUnfolding"></a><span class='hs-definition'>realIdUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-671"></a><span class='hs-comment'>-- Expose the unfolding if there is one, including for loop breakers</span>
<a name="line-672"></a><span class='hs-definition'>realIdUnfolding</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldingInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-673"></a>
<a name="line-674"></a><a name="setIdUnfolding"></a><span class='hs-definition'>setIdUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-675"></a><span class='hs-definition'>setIdUnfolding</span> <span class='hs-varid'>id</span> <span class='hs-varid'>unfolding</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setUnfoldingInfo`</span> <span class='hs-varid'>unfolding</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-676"></a>
<a name="line-677"></a><a name="idDemandInfo"></a><span class='hs-definition'>idDemandInfo</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-678"></a><span class='hs-definition'>idDemandInfo</span>       <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>demandInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-679"></a>
<a name="line-680"></a><a name="setIdDemandInfo"></a><span class='hs-definition'>setIdDemandInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-681"></a><span class='hs-definition'>setIdDemandInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setDemandInfo`</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-682"></a>
<a name="line-683"></a><a name="setCaseBndrEvald"></a><span class='hs-definition'>setCaseBndrEvald</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictnessMark</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-684"></a><span class='hs-comment'>-- Used for variables bound by a case expressions, both the case-binder</span>
<a name="line-685"></a><span class='hs-comment'>-- itself, and any pattern-bound variables that are argument of a</span>
<a name="line-686"></a><span class='hs-comment'>-- strict constructor.  It just marks the variable as already-evaluated,</span>
<a name="line-687"></a><span class='hs-comment'>-- so that (for example) a subsequent 'seq' can be dropped</span>
<a name="line-688"></a><span class='hs-definition'>setCaseBndrEvald</span> <span class='hs-varid'>str</span> <span class='hs-varid'>id</span>
<a name="line-689"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMarkedStrict</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>evaldUnfolding</span>
<a name="line-690"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-691"></a>
<a name="line-692"></a>        <span class='hs-comment'>---------------------------------</span>
<a name="line-693"></a>        <span class='hs-comment'>-- SPECIALISATION</span>
<a name="line-694"></a>
<a name="line-695"></a><span class='hs-comment'>-- See Note [Specialisations and RULES in IdInfo] in IdInfo.hs</span>
<a name="line-696"></a>
<a name="line-697"></a><a name="idSpecialisation"></a><span class='hs-definition'>idSpecialisation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RuleInfo</span>
<a name="line-698"></a><span class='hs-definition'>idSpecialisation</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ruleInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-699"></a>
<a name="line-700"></a><a name="idCoreRules"></a><span class='hs-definition'>idCoreRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span>
<a name="line-701"></a><span class='hs-definition'>idCoreRules</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ruleInfoRules</span> <span class='hs-layout'>(</span><span class='hs-varid'>idSpecialisation</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-702"></a>
<a name="line-703"></a><a name="idHasRules"></a><span class='hs-definition'>idHasRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-704"></a><span class='hs-definition'>idHasRules</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyRuleInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idSpecialisation</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-705"></a>
<a name="line-706"></a><a name="setIdSpecialisation"></a><span class='hs-definition'>setIdSpecialisation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RuleInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-707"></a><span class='hs-definition'>setIdSpecialisation</span> <span class='hs-varid'>id</span> <span class='hs-varid'>spec_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setRuleInfo`</span> <span class='hs-varid'>spec_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-708"></a>
<a name="line-709"></a>        <span class='hs-comment'>---------------------------------</span>
<a name="line-710"></a>        <span class='hs-comment'>-- CAF INFO</span>
<a name="line-711"></a><a name="idCafInfo"></a><span class='hs-definition'>idCafInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CafInfo</span>
<a name="line-712"></a><span class='hs-definition'>idCafInfo</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cafInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-713"></a>
<a name="line-714"></a><a name="setIdCafInfo"></a><span class='hs-definition'>setIdCafInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CafInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-715"></a><span class='hs-definition'>setIdCafInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>caf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setCafInfo`</span> <span class='hs-varid'>caf_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-716"></a>
<a name="line-717"></a>        <span class='hs-comment'>---------------------------------</span>
<a name="line-718"></a>        <span class='hs-comment'>-- Occcurrence INFO</span>
<a name="line-719"></a><a name="idOccInfo"></a><span class='hs-definition'>idOccInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccInfo</span>
<a name="line-720"></a><span class='hs-definition'>idOccInfo</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-721"></a>
<a name="line-722"></a><a name="setIdOccInfo"></a><span class='hs-definition'>setIdOccInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-723"></a><span class='hs-definition'>setIdOccInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>occ_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setOccInfo`</span> <span class='hs-varid'>occ_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-724"></a>
<a name="line-725"></a><a name="zapIdOccInfo"></a><span class='hs-definition'>zapIdOccInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-726"></a><span class='hs-definition'>zapIdOccInfo</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>`setIdOccInfo`</span> <span class='hs-varid'>noOccInfo</span>
<a name="line-727"></a>
<a name="line-728"></a><span class='hs-comment'>{-
<a name="line-729"></a>        ---------------------------------
<a name="line-730"></a>        -- INLINING
<a name="line-731"></a>The inline pragma tells us to be very keen to inline this Id, but it's still
<a name="line-732"></a>OK not to if optimisation is switched off.
<a name="line-733"></a>-}</span>
<a name="line-734"></a>
<a name="line-735"></a><a name="idInlinePragma"></a><span class='hs-definition'>idInlinePragma</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InlinePragma</span>
<a name="line-736"></a><span class='hs-definition'>idInlinePragma</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlinePragInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-737"></a>
<a name="line-738"></a><a name="setInlinePragma"></a><span class='hs-definition'>setInlinePragma</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InlinePragma</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-739"></a><span class='hs-definition'>setInlinePragma</span> <span class='hs-varid'>id</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-740"></a>
<a name="line-741"></a><a name="modifyInlinePragma"></a><span class='hs-definition'>modifyInlinePragma</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlinePragma</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InlinePragma</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-742"></a><span class='hs-definition'>modifyInlinePragma</span> <span class='hs-varid'>id</span> <span class='hs-varid'>fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>info</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>info</span> <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-743"></a>
<a name="line-744"></a><a name="idInlineActivation"></a><span class='hs-definition'>idInlineActivation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Activation</span>
<a name="line-745"></a><span class='hs-definition'>idInlineActivation</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlinePragmaActivation</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInlinePragma</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-746"></a>
<a name="line-747"></a><a name="setInlineActivation"></a><span class='hs-definition'>setInlineActivation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Activation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-748"></a><span class='hs-definition'>setInlineActivation</span> <span class='hs-varid'>id</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyInlinePragma</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>prag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setInlinePragmaActivation</span> <span class='hs-varid'>prag</span> <span class='hs-varid'>act</span><span class='hs-layout'>)</span>
<a name="line-749"></a>
<a name="line-750"></a><a name="idRuleMatchInfo"></a><span class='hs-definition'>idRuleMatchInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RuleMatchInfo</span>
<a name="line-751"></a><span class='hs-definition'>idRuleMatchInfo</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlinePragmaRuleMatchInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInlinePragma</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-752"></a>
<a name="line-753"></a><a name="isConLikeId"></a><span class='hs-definition'>isConLikeId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-754"></a><span class='hs-definition'>isConLikeId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDataConWorkId</span> <span class='hs-varid'>id</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isConLike</span> <span class='hs-layout'>(</span><span class='hs-varid'>idRuleMatchInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-755"></a>
<a name="line-756"></a><span class='hs-comment'>{-
<a name="line-757"></a>        ---------------------------------
<a name="line-758"></a>        -- ONE-SHOT LAMBDAS
<a name="line-759"></a>-}</span>
<a name="line-760"></a>
<a name="line-761"></a><a name="idOneShotInfo"></a><span class='hs-definition'>idOneShotInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OneShotInfo</span>
<a name="line-762"></a><span class='hs-definition'>idOneShotInfo</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oneShotInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-763"></a>
<a name="line-764"></a><a name="idStateHackOneShotInfo"></a><span class='hs-comment'>-- | Like 'idOneShotInfo', but taking the Horrible State Hack in to account</span>
<a name="line-765"></a><span class='hs-comment'>-- See Note [The state-transformer hack] in CoreArity</span>
<a name="line-766"></a><span class='hs-definition'>idStateHackOneShotInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OneShotInfo</span>
<a name="line-767"></a><span class='hs-definition'>idStateHackOneShotInfo</span> <span class='hs-varid'>id</span>
<a name="line-768"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStateHackType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stateHackOneShot</span>
<a name="line-769"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idOneShotInfo</span> <span class='hs-varid'>id</span>
<a name="line-770"></a>
<a name="line-771"></a><a name="isOneShotBndr"></a><span class='hs-comment'>-- | Returns whether the lambda associated with the 'Id' is certainly applied at most once</span>
<a name="line-772"></a><span class='hs-comment'>-- This one is the "business end", called externally.</span>
<a name="line-773"></a><span class='hs-comment'>-- It works on type variables as well as Ids, returning True</span>
<a name="line-774"></a><span class='hs-comment'>-- Its main purpose is to encapsulate the Horrible State Hack</span>
<a name="line-775"></a><span class='hs-comment'>-- See Note [The state-transformer hack] in CoreArity</span>
<a name="line-776"></a><span class='hs-definition'>isOneShotBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-777"></a><span class='hs-definition'>isOneShotBndr</span> <span class='hs-varid'>var</span>
<a name="line-778"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>var</span>                              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-779"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OneShotLam</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idStateHackOneShotInfo</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-780"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-781"></a>
<a name="line-782"></a><a name="stateHackOneShot"></a><span class='hs-comment'>-- | Should we apply the state hack to values of this 'Type'?</span>
<a name="line-783"></a><span class='hs-definition'>stateHackOneShot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OneShotInfo</span>
<a name="line-784"></a><span class='hs-definition'>stateHackOneShot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OneShotLam</span>
<a name="line-785"></a>
<a name="line-786"></a><a name="typeOneShot"></a><span class='hs-definition'>typeOneShot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OneShotInfo</span>
<a name="line-787"></a><span class='hs-definition'>typeOneShot</span> <span class='hs-varid'>ty</span>
<a name="line-788"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStateHackType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stateHackOneShot</span>
<a name="line-789"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoOneShotInfo</span>
<a name="line-790"></a>
<a name="line-791"></a><a name="isStateHackType"></a><span class='hs-definition'>isStateHackType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-792"></a><span class='hs-definition'>isStateHackType</span> <span class='hs-varid'>ty</span>
<a name="line-793"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hasNoStateHack</span> <span class='hs-varid'>unsafeGlobalDynFlags</span>
<a name="line-794"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-795"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-796"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-797"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>statePrimTyCon</span>
<a name="line-798"></a>        <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-799"></a>        <span class='hs-comment'>-- This is a gross hack.  It claims that</span>
<a name="line-800"></a>        <span class='hs-comment'>-- every function over realWorldStatePrimTy is a one-shot</span>
<a name="line-801"></a>        <span class='hs-comment'>-- function.  This is pretty true in practice, and makes a big</span>
<a name="line-802"></a>        <span class='hs-comment'>-- difference.  For example, consider</span>
<a name="line-803"></a>        <span class='hs-comment'>--      a `thenST` \ r -&gt; ...E...</span>
<a name="line-804"></a>        <span class='hs-comment'>-- The early full laziness pass, if it doesn't know that r is one-shot</span>
<a name="line-805"></a>        <span class='hs-comment'>-- will pull out E (let's say it doesn't mention r) to give</span>
<a name="line-806"></a>        <span class='hs-comment'>--      let lvl = E in a `thenST` \ r -&gt; ...lvl...</span>
<a name="line-807"></a>        <span class='hs-comment'>-- When `thenST` gets inlined, we end up with</span>
<a name="line-808"></a>        <span class='hs-comment'>--      let lvl = E in \s -&gt; case a s of (r, s') -&gt; ...lvl...</span>
<a name="line-809"></a>        <span class='hs-comment'>-- and we don't re-inline E.</span>
<a name="line-810"></a>        <span class='hs-comment'>--</span>
<a name="line-811"></a>        <span class='hs-comment'>-- It would be better to spot that r was one-shot to start with, but</span>
<a name="line-812"></a>        <span class='hs-comment'>-- I don't want to rely on that.</span>
<a name="line-813"></a>        <span class='hs-comment'>--</span>
<a name="line-814"></a>        <span class='hs-comment'>-- Another good example is in fill_in in PrelPack.hs.  We should be able to</span>
<a name="line-815"></a>        <span class='hs-comment'>-- spot that fill_in has arity 2 (and when Keith is done, we will) but we can't yet.</span>
<a name="line-816"></a>
<a name="line-817"></a><a name="isProbablyOneShotLambda"></a><span class='hs-definition'>isProbablyOneShotLambda</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-818"></a><span class='hs-definition'>isProbablyOneShotLambda</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idStateHackOneShotInfo</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-819"></a>                               <span class='hs-conid'>OneShotLam</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-820"></a>                               <span class='hs-conid'>NoOneShotInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-821"></a>
<a name="line-822"></a><a name="setOneShotLambda"></a><span class='hs-definition'>setOneShotLambda</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-823"></a><span class='hs-definition'>setOneShotLambda</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setOneShotInfo`</span> <span class='hs-conid'>OneShotLam</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-824"></a>
<a name="line-825"></a><a name="clearOneShotLambda"></a><span class='hs-definition'>clearOneShotLambda</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-826"></a><span class='hs-definition'>clearOneShotLambda</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setOneShotInfo`</span> <span class='hs-conid'>NoOneShotInfo</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-827"></a>
<a name="line-828"></a><a name="setIdOneShotInfo"></a><span class='hs-definition'>setIdOneShotInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OneShotInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-829"></a><span class='hs-definition'>setIdOneShotInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>one_shot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setOneShotInfo`</span> <span class='hs-varid'>one_shot</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-830"></a>
<a name="line-831"></a><a name="updOneShotInfo"></a><span class='hs-definition'>updOneShotInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OneShotInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-832"></a><span class='hs-comment'>-- Combine the info in the Id with new info</span>
<a name="line-833"></a><span class='hs-definition'>updOneShotInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>one_shot</span>
<a name="line-834"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>do_upd</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setIdOneShotInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>one_shot</span>
<a name="line-835"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-836"></a>  <span class='hs-keyword'>where</span>
<a name="line-837"></a>    <span class='hs-varid'>do_upd</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>idOneShotInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>one_shot</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-838"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>NoOneShotInfo</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-839"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>OneShotLam</span><span class='hs-layout'>,</span>    <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-840"></a>
<a name="line-841"></a><span class='hs-comment'>-- The OneShotLambda functions simply fiddle with the IdInfo flag</span>
<a name="line-842"></a><span class='hs-comment'>-- But watch out: this may change the type of something else</span>
<a name="line-843"></a><span class='hs-comment'>--      f = \x -&gt; e</span>
<a name="line-844"></a><span class='hs-comment'>-- If we change the one-shot-ness of x, f's type changes</span>
<a name="line-845"></a>
<a name="line-846"></a><a name="zapInfo"></a><span class='hs-definition'>zapInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>IdInfo</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-847"></a><span class='hs-definition'>zapInfo</span> <span class='hs-varid'>zapper</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeModifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapper</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-848"></a>
<a name="line-849"></a><a name="zapLamIdInfo"></a><span class='hs-definition'>zapLamIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-850"></a><span class='hs-definition'>zapLamIdInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapInfo</span> <span class='hs-varid'>zapLamInfo</span>
<a name="line-851"></a>
<a name="line-852"></a><a name="zapFragileIdInfo"></a><span class='hs-definition'>zapFragileIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-853"></a><span class='hs-definition'>zapFragileIdInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapInfo</span> <span class='hs-varid'>zapFragileInfo</span>
<a name="line-854"></a>
<a name="line-855"></a><a name="zapIdDemandInfo"></a><span class='hs-definition'>zapIdDemandInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-856"></a><span class='hs-definition'>zapIdDemandInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapInfo</span> <span class='hs-varid'>zapDemandInfo</span>
<a name="line-857"></a>
<a name="line-858"></a><a name="zapIdUsageInfo"></a><span class='hs-definition'>zapIdUsageInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-859"></a><span class='hs-definition'>zapIdUsageInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapInfo</span> <span class='hs-varid'>zapUsageInfo</span>
<a name="line-860"></a>
<a name="line-861"></a><a name="zapIdUsageEnvInfo"></a><span class='hs-definition'>zapIdUsageEnvInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-862"></a><span class='hs-definition'>zapIdUsageEnvInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapInfo</span> <span class='hs-varid'>zapUsageEnvInfo</span>
<a name="line-863"></a>
<a name="line-864"></a><a name="zapIdUsedOnceInfo"></a><span class='hs-definition'>zapIdUsedOnceInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-865"></a><span class='hs-definition'>zapIdUsedOnceInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapInfo</span> <span class='hs-varid'>zapUsedOnceInfo</span>
<a name="line-866"></a>
<a name="line-867"></a><a name="zapIdTailCallInfo"></a><span class='hs-definition'>zapIdTailCallInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-868"></a><span class='hs-definition'>zapIdTailCallInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapInfo</span> <span class='hs-varid'>zapTailCallInfo</span>
<a name="line-869"></a>
<a name="line-870"></a><span class='hs-comment'>{-
<a name="line-871"></a>Note [transferPolyIdInfo]
<a name="line-872"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-873"></a>This transfer is used in two places:
<a name="line-874"></a>        FloatOut (long-distance let-floating)
<a name="line-875"></a>        SimplUtils.abstractFloats (short-distance let-floating)
<a name="line-876"></a>
<a name="line-877"></a>Consider the short-distance let-floating:
<a name="line-878"></a>
<a name="line-879"></a>   f = /\a. let g = rhs in ...
<a name="line-880"></a>
<a name="line-881"></a>Then if we float thus
<a name="line-882"></a>
<a name="line-883"></a>   g' = /\a. rhs
<a name="line-884"></a>   f = /\a. ...[g' a/g]....
<a name="line-885"></a>
<a name="line-886"></a>we *do not* want to lose g's
<a name="line-887"></a>  * strictness information
<a name="line-888"></a>  * arity
<a name="line-889"></a>  * inline pragma (though that is bit more debatable)
<a name="line-890"></a>  * occurrence info
<a name="line-891"></a>
<a name="line-892"></a>Mostly this is just an optimisation, but it's *vital* to
<a name="line-893"></a>transfer the occurrence info.  Consider
<a name="line-894"></a>
<a name="line-895"></a>   NonRec { f = /\a. let Rec { g* = ..g.. } in ... }
<a name="line-896"></a>
<a name="line-897"></a>where the '*' means 'LoopBreaker'.  Then if we float we must get
<a name="line-898"></a>
<a name="line-899"></a>   Rec { g'* = /\a. ...(g' a)... }
<a name="line-900"></a>   NonRec { f = /\a. ...[g' a/g]....}
<a name="line-901"></a>
<a name="line-902"></a>where g' is also marked as LoopBreaker.  If not, terrible things
<a name="line-903"></a>can happen if we re-simplify the binding (and the Simplifier does
<a name="line-904"></a>sometimes simplify a term twice); see Trac #4345.
<a name="line-905"></a>
<a name="line-906"></a>It's not so simple to retain
<a name="line-907"></a>  * worker info
<a name="line-908"></a>  * rules
<a name="line-909"></a>so we simply discard those.  Sooner or later this may bite us.
<a name="line-910"></a>
<a name="line-911"></a>If we abstract wrt one or more *value* binders, we must modify the
<a name="line-912"></a>arity and strictness info before transferring it.  E.g.
<a name="line-913"></a>      f = \x. e
<a name="line-914"></a>--&gt;
<a name="line-915"></a>      g' = \y. \x. e
<a name="line-916"></a>      + substitute (g' y) for g
<a name="line-917"></a>Notice that g' has an arity one more than the original g
<a name="line-918"></a>-}</span>
<a name="line-919"></a>
<a name="line-920"></a><a name="transferPolyIdInfo"></a><span class='hs-definition'>transferPolyIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>        <span class='hs-comment'>-- Original Id</span>
<a name="line-921"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Abstract wrt these variables</span>
<a name="line-922"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>        <span class='hs-comment'>-- New Id</span>
<a name="line-923"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-924"></a><span class='hs-definition'>transferPolyIdInfo</span> <span class='hs-varid'>old_id</span> <span class='hs-varid'>abstract_wrt</span> <span class='hs-varid'>new_id</span>
<a name="line-925"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-varid'>transfer</span> <span class='hs-varid'>new_id</span>
<a name="line-926"></a>  <span class='hs-keyword'>where</span>
<a name="line-927"></a>    <span class='hs-varid'>arity_increase</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>abstract_wrt</span>    <span class='hs-comment'>-- Arity increases by the</span>
<a name="line-928"></a>                                                <span class='hs-comment'>-- number of value binders</span>
<a name="line-929"></a>
<a name="line-930"></a>    <span class='hs-varid'>old_info</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>old_id</span>
<a name="line-931"></a>    <span class='hs-varid'>old_arity</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-932"></a>    <span class='hs-varid'>old_inline_prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-933"></a>    <span class='hs-varid'>old_occ_info</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-934"></a>    <span class='hs-varid'>new_arity</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_arity</span> <span class='hs-varop'>+</span> <span class='hs-varid'>arity_increase</span>
<a name="line-935"></a>    <span class='hs-varid'>new_occ_info</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapOccTailCallInfo</span> <span class='hs-varid'>old_occ_info</span>
<a name="line-936"></a>
<a name="line-937"></a>    <span class='hs-varid'>old_strictness</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strictnessInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-938"></a>    <span class='hs-varid'>new_strictness</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>increaseStrictSigArity</span> <span class='hs-varid'>arity_increase</span> <span class='hs-varid'>old_strictness</span>
<a name="line-939"></a>
<a name="line-940"></a>    <span class='hs-varid'>transfer</span> <span class='hs-varid'>new_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_info</span> <span class='hs-varop'>`setArityInfo`</span> <span class='hs-varid'>new_arity</span>
<a name="line-941"></a>                                 <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>old_inline_prag</span>
<a name="line-942"></a>                                 <span class='hs-varop'>`setOccInfo`</span> <span class='hs-varid'>new_occ_info</span>
<a name="line-943"></a>                                 <span class='hs-varop'>`setStrictnessInfo`</span> <span class='hs-varid'>new_strictness</span>
<a name="line-944"></a>
<a name="line-945"></a><a name="isNeverLevPolyId"></a><span class='hs-definition'>isNeverLevPolyId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-946"></a><span class='hs-definition'>isNeverLevPolyId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNeverLevPolyIdInfo</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idInfo</span>
</pre></body>
</html>
