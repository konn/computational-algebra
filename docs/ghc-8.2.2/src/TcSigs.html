<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcSigs.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006-2012
<a name="line-3"></a>(c) The GRASP Project, Glasgow University, 1992-2002
<a name="line-4"></a>
<a name="line-5"></a>-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcSigs</span><span class='hs-layout'>(</span>
<a name="line-10"></a>       <span class='hs-conid'>TcSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-11"></a>       <span class='hs-conid'>TcIdSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdSigInst</span><span class='hs-layout'>,</span>
<a name="line-12"></a>       <span class='hs-conid'>TcPatSynInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-13"></a>       <span class='hs-conid'>TcSigFun</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>       <span class='hs-varid'>isPartialSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasCompleteSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIdSigName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSigInfoName</span><span class='hs-layout'>,</span>
<a name="line-16"></a>       <span class='hs-varid'>completeSigPolyId_maybe</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>       <span class='hs-varid'>tcTySigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcUserTypeSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>completeSigFromId</span><span class='hs-layout'>,</span>
<a name="line-19"></a>       <span class='hs-varid'>tcInstSig</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>       <span class='hs-conid'>TcPragEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyPragEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupPragEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendPragEnv</span><span class='hs-layout'>,</span>
<a name="line-22"></a>       <span class='hs-varid'>mkPragEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSpecPrags</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSpecWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcImpPrags</span><span class='hs-layout'>,</span> <span class='hs-varid'>addInlinePrags</span>
<a name="line-23"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcValidity</span> <span class='hs-layout'>(</span> <span class='hs-varid'>checkValidType</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcSkolemise</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyType</span><span class='hs-layout'>,</span> <span class='hs-varid'>noThing</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span><span class='hs-layout'>(</span> <span class='hs-varid'>topInstantiate</span> <span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span><span class='hs-layout'>(</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span> <span class='hs-varid'>mkTyVarBinders</span> <span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-varid'>idName</span><span class='hs-layout'>,</span> <span class='hs-varid'>idType</span><span class='hs-layout'>,</span> <span class='hs-varid'>idInlinePragma</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInlinePragma</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span><span class='hs-layout'>(</span> <span class='hs-varid'>mkUnboundName</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span><span class='hs-layout'>(</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span><span class='hs-layout'>(</span> <span class='hs-varid'>getModule</span> <span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span><span class='hs-layout'>(</span> <span class='hs-varid'>singleton</span> <span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span><span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span><span class='hs-layout'>(</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-layout'>(</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-comment'>{- -------------------------------------------------------------
<a name="line-59"></a>          Note [Overview of type signatures]
<a name="line-60"></a>----------------------------------------------------------------
<a name="line-61"></a>Type signatures, including partial signatures, are jolly tricky,
<a name="line-62"></a>especially on value bindings.  Here's an overview.
<a name="line-63"></a>
<a name="line-64"></a>    f :: forall a. [a] -&gt; [a]
<a name="line-65"></a>    g :: forall b. _ -&gt; b
<a name="line-66"></a>
<a name="line-67"></a>    f = ...g...
<a name="line-68"></a>    g = ...f...
<a name="line-69"></a>
<a name="line-70"></a>* HsSyn: a signature in a binding starts of as a TypeSig, in
<a name="line-71"></a>  type HsBinds.Sig
<a name="line-72"></a>
<a name="line-73"></a>* When starting a mutually recursive group, like f/g above, we
<a name="line-74"></a>  call tcTySig on each signature in the group.
<a name="line-75"></a>
<a name="line-76"></a>* tcTySig: Sig -&gt; TcIdSigInfo
<a name="line-77"></a>  - For a /complete/ signature, like 'f' above, tcTySig kind-checks
<a name="line-78"></a>    the HsType, producing a Type, and wraps it in a CompleteSig, and
<a name="line-79"></a>    extend the type environment with this polymorphic 'f'.
<a name="line-80"></a>
<a name="line-81"></a>  - For a /partial/signature, like 'g' above, tcTySig does nothing
<a name="line-82"></a>    Instead it just wraps the pieces in a PartialSig, to be handled
<a name="line-83"></a>    later.
<a name="line-84"></a>
<a name="line-85"></a>* tcInstSig: TcIdSigInfo -&gt; TcIdSigInst
<a name="line-86"></a>  In tcMonoBinds, when looking at an individual binding, we use
<a name="line-87"></a>  tcInstSig to instantiate the signature forall's in the signature,
<a name="line-88"></a>  and attribute that instantiated (monomorphic) type to the
<a name="line-89"></a>  binder.  You can see this in TcBinds.tcLhsId.
<a name="line-90"></a>
<a name="line-91"></a>  The instantiation does the obvious thing for complete signatures,
<a name="line-92"></a>  but for /partial/ signatures it starts from the HsSyn, so it
<a name="line-93"></a>  has to kind-check it etc: tcHsPartialSigType.  It's convenient
<a name="line-94"></a>  to do this at the same time as instantiation, because we can
<a name="line-95"></a>  make the wildcards into unification variables right away, raather
<a name="line-96"></a>  than somehow quantifying over them.  And the "TcLevel" of those
<a name="line-97"></a>  unification variables is correct because we are in tcMonoBinds.
<a name="line-98"></a>
<a name="line-99"></a>
<a name="line-100"></a>Note [Scoped tyvars]
<a name="line-101"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-102"></a>The -XScopedTypeVariables flag brings lexically-scoped type variables
<a name="line-103"></a>into scope for any explicitly forall-quantified type variables:
<a name="line-104"></a>        f :: forall a. a -&gt; a
<a name="line-105"></a>        f x = e
<a name="line-106"></a>Then 'a' is in scope inside 'e'.
<a name="line-107"></a>
<a name="line-108"></a>However, we do *not* support this
<a name="line-109"></a>  - For pattern bindings e.g
<a name="line-110"></a>        f :: forall a. a-&gt;a
<a name="line-111"></a>        (f,g) = e
<a name="line-112"></a>
<a name="line-113"></a>Note [Binding scoped type variables]
<a name="line-114"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-115"></a>The type variables *brought into lexical scope* by a type signature
<a name="line-116"></a>may be a subset of the *quantified type variables* of the signatures,
<a name="line-117"></a>for two reasons:
<a name="line-118"></a>
<a name="line-119"></a>* With kind polymorphism a signature like
<a name="line-120"></a>    f :: forall f a. f a -&gt; f a
<a name="line-121"></a>  may actually give rise to
<a name="line-122"></a>    f :: forall k. forall (f::k -&gt; *) (a:k). f a -&gt; f a
<a name="line-123"></a>  So the sig_tvs will be [k,f,a], but only f,a are scoped.
<a name="line-124"></a>  NB: the scoped ones are not necessarily the *inital* ones!
<a name="line-125"></a>
<a name="line-126"></a>* Even aside from kind polymorphism, there may be more instantiated
<a name="line-127"></a>  type variables than lexically-scoped ones.  For example:
<a name="line-128"></a>        type T a = forall b. b -&gt; (a,b)
<a name="line-129"></a>        f :: forall c. T c
<a name="line-130"></a>  Here, the signature for f will have one scoped type variable, c,
<a name="line-131"></a>  but two instantiated type variables, c' and b'.
<a name="line-132"></a>
<a name="line-133"></a>However, all of this only applies to the renamer.  The typechecker
<a name="line-134"></a>just puts all of them into the type environment; any lexical-scope
<a name="line-135"></a>errors were dealt with by the renamer.
<a name="line-136"></a>
<a name="line-137"></a>-}</span>
<a name="line-138"></a>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-141"></a>*                                                                      *
<a name="line-142"></a>             Utility functions for TcSigInfo
<a name="line-143"></a>*                                                                      *
<a name="line-144"></a>********************************************************************* -}</span>
<a name="line-145"></a>
<a name="line-146"></a><a name="tcIdSigName"></a><span class='hs-definition'>tcIdSigName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdSigInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-147"></a><span class='hs-definition'>tcIdSigName</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span>
<a name="line-148"></a><span class='hs-definition'>tcIdSigName</span> <span class='hs-layout'>(</span><span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="tcSigInfoName"></a><span class='hs-definition'>tcSigInfoName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-151"></a><span class='hs-definition'>tcSigInfoName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdSig</span>     <span class='hs-varid'>idsi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcIdSigName</span> <span class='hs-varid'>idsi</span>
<a name="line-152"></a><span class='hs-definition'>tcSigInfoName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPatSynSig</span> <span class='hs-varid'>tpsi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patsig_name</span> <span class='hs-varid'>tpsi</span>
<a name="line-153"></a>
<a name="line-154"></a><a name="completeSigPolyId_maybe"></a><span class='hs-definition'>completeSigPolyId_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcId</span>
<a name="line-155"></a><span class='hs-definition'>completeSigPolyId_maybe</span> <span class='hs-varid'>sig</span>
<a name="line-156"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcIdSig</span> <span class='hs-varid'>sig_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig</span>
<a name="line-157"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>id</span>
<a name="line-158"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-159"></a>
<a name="line-160"></a>
<a name="line-161"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-162"></a>*                                                                      *
<a name="line-163"></a>               Typechecking user signatures
<a name="line-164"></a>*                                                                      *
<a name="line-165"></a>********************************************************************* -}</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="tcTySigs"></a><span class='hs-definition'>tcTySigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigFun</span><span class='hs-layout'>)</span>
<a name="line-168"></a><span class='hs-definition'>tcTySigs</span> <span class='hs-varid'>hs_sigs</span>
<a name="line-169"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>   <span class='hs-comment'>-- See Note [Fail eagerly on bad signatures]</span>
<a name="line-170"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty_sigs_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-varid'>tcTySig</span> <span class='hs-varid'>hs_sigs</span>
<a name="line-171"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty_sigs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>ty_sigs_s</span>
<a name="line-172"></a>             <span class='hs-varid'>poly_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>completeSigPolyId_maybe</span> <span class='hs-varid'>ty_sigs</span>
<a name="line-173"></a>                        <span class='hs-comment'>-- The returned [TcId] are the ones for which we have</span>
<a name="line-174"></a>                        <span class='hs-comment'>-- a complete type signature.</span>
<a name="line-175"></a>                        <span class='hs-comment'>-- See Note [Complete and partial type signatures]</span>
<a name="line-176"></a>             <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>tcSigInfoName</span> <span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty_sigs</span><span class='hs-keyglyph'>]</span>
<a name="line-177"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-178"></a>
<a name="line-179"></a><a name="tcTySig"></a><span class='hs-definition'>tcTySig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-180"></a><span class='hs-definition'>tcTySig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span>
<a name="line-182"></a>                    <span class='hs-comment'>-- False: do not report redundant constraints</span>
<a name="line-183"></a>                    <span class='hs-comment'>-- The user has no control over the signature!</span>
<a name="line-184"></a>             <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>completeSigFromId</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>id</span>
<a name="line-185"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdSig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-186"></a>
<a name="line-187"></a><span class='hs-definition'>tcTySig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-188"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-189"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sigs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tcUserTypeSig</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sig_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-190"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>]</span>
<a name="line-191"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>TcIdSig</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-192"></a>
<a name="line-193"></a><span class='hs-definition'>tcTySig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-194"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-195"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tpsigs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tcPatSynSig</span> <span class='hs-varid'>name</span> <span class='hs-varid'>sig_ty</span>
<a name="line-196"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>]</span>
<a name="line-197"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>TcPatSynSig</span> <span class='hs-varid'>tpsigs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-198"></a>
<a name="line-199"></a><span class='hs-definition'>tcTySig</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-200"></a>
<a name="line-201"></a>
<a name="line-202"></a><a name="tcUserTypeSig"></a><span class='hs-definition'>tcUserTypeSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcIdSigInfo</span>
<a name="line-203"></a><span class='hs-comment'>-- A function or expression type signature</span>
<a name="line-204"></a><span class='hs-comment'>-- Returns a fully quantified type signature; even the wildcards</span>
<a name="line-205"></a><span class='hs-comment'>-- are quantified with ordinary skolems that should be instantiated</span>
<a name="line-206"></a><span class='hs-comment'>--</span>
<a name="line-207"></a><span class='hs-comment'>-- The SrcSpan is what to declare as the binding site of the</span>
<a name="line-208"></a><span class='hs-comment'>-- any skolems in the signature. For function signatures we</span>
<a name="line-209"></a><span class='hs-comment'>-- use the whole `f :: ty' signature; for expression signatures</span>
<a name="line-210"></a><span class='hs-comment'>-- just the type part.</span>
<a name="line-211"></a><span class='hs-comment'>--</span>
<a name="line-212"></a><span class='hs-comment'>-- Just n  =&gt; Function type signature       name :: type</span>
<a name="line-213"></a><span class='hs-comment'>-- Nothing =&gt; Expression type signature   &lt;expr&gt; :: type</span>
<a name="line-214"></a><span class='hs-definition'>tcUserTypeSig</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_sig_ty</span> <span class='hs-varid'>mb_name</span>
<a name="line-215"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCompleteHsSig</span> <span class='hs-varid'>hs_sig_ty</span>
<a name="line-216"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sigma_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsSigWcType</span> <span class='hs-varid'>ctxt_F</span> <span class='hs-varid'>hs_sig_ty</span>
<a name="line-217"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-218"></a>         <span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>sigma_ty</span>
<a name="line-219"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_T</span>
<a name="line-220"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-221"></a>                       <span class='hs-comment'>-- Location of the &lt;type&gt; in   f :: &lt;type&gt;</span>
<a name="line-222"></a>
<a name="line-223"></a>  <span class='hs-comment'>-- Partial sig with wildcards</span>
<a name="line-224"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-225"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>psig_hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_sig_ty</span>
<a name="line-226"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_F</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-227"></a>  <span class='hs-keyword'>where</span>
<a name="line-228"></a>    <span class='hs-varid'>name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span>
<a name="line-229"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span>
<a name="line-230"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkUnboundName</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOcc</span> <span class='hs-str'>"&lt;expression&gt;"</span><span class='hs-layout'>)</span>
<a name="line-231"></a>    <span class='hs-varid'>ctxt_F</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span>
<a name="line-232"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>n</span> <span class='hs-conid'>False</span>
<a name="line-233"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSigCtxt</span>
<a name="line-234"></a>    <span class='hs-varid'>ctxt_T</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span>
<a name="line-235"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>n</span> <span class='hs-conid'>True</span>
<a name="line-236"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSigCtxt</span>
<a name="line-237"></a>
<a name="line-238"></a>
<a name="line-239"></a>
<a name="line-240"></a><a name="completeSigFromId"></a><span class='hs-definition'>completeSigFromId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcIdSigInfo</span>
<a name="line-241"></a><span class='hs-comment'>-- Used for instance methods and record selectors</span>
<a name="line-242"></a><span class='hs-definition'>completeSigFromId</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>id</span>
<a name="line-243"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-244"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span>
<a name="line-245"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="isCompleteHsSig"></a><span class='hs-definition'>isCompleteHsSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-248"></a><span class='hs-comment'>-- ^ If there are no wildcards, return a LHsSigType</span>
<a name="line-249"></a><span class='hs-definition'>isCompleteHsSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_wcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wcs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>wcs</span>
<a name="line-250"></a>
<a name="line-251"></a><span class='hs-comment'>{- Note [Fail eagerly on bad signatures]
<a name="line-252"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-253"></a>If a type signature is wrong, fail immediately:
<a name="line-254"></a>
<a name="line-255"></a> * the type sigs may bind type variables, so proceeding without them
<a name="line-256"></a>   can lead to a cascade of errors
<a name="line-257"></a>
<a name="line-258"></a> * the type signature might be ambiguous, in which case checking
<a name="line-259"></a>   the code against the signature will give a very similar error
<a name="line-260"></a>   to the ambiguity error.
<a name="line-261"></a>
<a name="line-262"></a>ToDo: this means we fall over if any type sig
<a name="line-263"></a>is wrong (eg at the top level of the module),
<a name="line-264"></a>which is over-conservative
<a name="line-265"></a>-}</span>
<a name="line-266"></a>
<a name="line-267"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-268"></a>*                                                                      *
<a name="line-269"></a>        Type checking a pattern synonym signature
<a name="line-270"></a>*                                                                      *
<a name="line-271"></a>************************************************************************
<a name="line-272"></a>
<a name="line-273"></a>Note [Pattern synonym signatures]
<a name="line-274"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-275"></a>Pattern synonym signatures are surprisingly tricky (see Trac #11224 for example).
<a name="line-276"></a>In general they look like this:
<a name="line-277"></a>
<a name="line-278"></a>   pattern P :: forall univ_tvs. req_theta
<a name="line-279"></a>             =&gt; forall ex_tvs. prov_theta
<a name="line-280"></a>             =&gt; arg1 -&gt; .. -&gt; argn -&gt; res_ty
<a name="line-281"></a>
<a name="line-282"></a>For parsing and renaming we treat the signature as an ordinary LHsSigType.
<a name="line-283"></a>
<a name="line-284"></a>Once we get to type checking, we decompose it into its parts, in tcPatSynSig.
<a name="line-285"></a>
<a name="line-286"></a>* Note that 'forall univ_tvs' and 'req_theta =&gt;'
<a name="line-287"></a>        and 'forall ex_tvs'   and 'prov_theta =&gt;'
<a name="line-288"></a>  are all optional.  We gather the pieces at the the top of tcPatSynSig
<a name="line-289"></a>
<a name="line-290"></a>* Initially the implicitly-bound tyvars (added by the renamer) include both
<a name="line-291"></a>  universal and existential vars.
<a name="line-292"></a>
<a name="line-293"></a>* After we kind-check the pieces and convert to Types, we do kind generalisation.
<a name="line-294"></a>
<a name="line-295"></a>Note [The pattern-synonym signature splitting rule]
<a name="line-296"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-297"></a>Given a pattern signature, we must split
<a name="line-298"></a>     the kind-generalised variables, and
<a name="line-299"></a>     the implicitly-bound variables
<a name="line-300"></a>into universal and existential.  The rule is this
<a name="line-301"></a>(see discussion on Trac #11224):
<a name="line-302"></a>
<a name="line-303"></a>     The universal tyvars are the ones mentioned in
<a name="line-304"></a>          - univ_tvs: the user-specified (forall'd) universals
<a name="line-305"></a>          - req_theta
<a name="line-306"></a>          - res_ty
<a name="line-307"></a>     The existential tyvars are all the rest
<a name="line-308"></a>
<a name="line-309"></a>For example
<a name="line-310"></a>
<a name="line-311"></a>   pattern P :: () =&gt; b -&gt; T a
<a name="line-312"></a>   pattern P x = ...
<a name="line-313"></a>
<a name="line-314"></a>Here 'a' is universal, and 'b' is existential.  But there is a wrinkle:
<a name="line-315"></a>how do we split the arg_tys from req_ty?  Consider
<a name="line-316"></a>
<a name="line-317"></a>   pattern Q :: () =&gt; b -&gt; S c -&gt; T a
<a name="line-318"></a>   pattern Q x = ...
<a name="line-319"></a>
<a name="line-320"></a>This is an odd example because Q has only one syntactic argument, and
<a name="line-321"></a>so presumably is defined by a view pattern matching a function.  But
<a name="line-322"></a>it can happen (Trac #11977, #12108).
<a name="line-323"></a>
<a name="line-324"></a>We don't know Q's arity from the pattern signature, so we have to wait
<a name="line-325"></a>until we see the pattern declaration itself before deciding res_ty is,
<a name="line-326"></a>and hence which variables are existential and which are universal.
<a name="line-327"></a>
<a name="line-328"></a>And that in turn is why TcPatSynInfo has a separate field,
<a name="line-329"></a>patsig_implicit_bndrs, to capture the implicitly bound type variables,
<a name="line-330"></a>because we don't yet know how to split them up.
<a name="line-331"></a>
<a name="line-332"></a>It's a slight compromise, because it means we don't really know the
<a name="line-333"></a>pattern synonym's real signature until we see its declaration.  So,
<a name="line-334"></a>for example, in hs-boot file, we may need to think what to do...
<a name="line-335"></a>(eg don't have any implicitly-bound variables).
<a name="line-336"></a>-}</span>
<a name="line-337"></a>
<a name="line-338"></a><a name="tcPatSynSig"></a><span class='hs-definition'>tcPatSynSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcPatSynInfo</span>
<a name="line-339"></a><span class='hs-definition'>tcPatSynSig</span> <span class='hs-varid'>name</span> <span class='hs-varid'>sig_ty</span>
<a name="line-340"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_hs_tvs</span>
<a name="line-341"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>hsib_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_ty</span>
<a name="line-342"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_hs_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_req</span><span class='hs-layout'>,</span>  <span class='hs-varid'>hs_ty1</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsSigmaTy</span> <span class='hs-varid'>hs_ty</span>
<a name="line-343"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ex_hs_tvs</span><span class='hs-layout'>,</span>   <span class='hs-varid'>hs_prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_body_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsSigmaTy</span> <span class='hs-varid'>hs_ty1</span>
<a name="line-344"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>implicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>req</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-345"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveEqualities</span> <span class='hs-varop'>$</span>
<a name="line-346"></a>              <span class='hs-varid'>tcImplicitTKBndrs</span> <span class='hs-varid'>implicit_hs_tvs</span> <span class='hs-varop'>$</span>
<a name="line-347"></a>              <span class='hs-varid'>tcExplicitTKBndrs</span> <span class='hs-varid'>univ_hs_tvs</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-348"></a>              <span class='hs-varid'>tcExplicitTKBndrs</span> <span class='hs-varid'>ex_hs_tvs</span>    <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ex_tvs</span>   <span class='hs-keyglyph'>-&gt;</span>
<a name="line-349"></a>              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>req</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsContext</span> <span class='hs-varid'>hs_req</span>
<a name="line-350"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>prov</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsContext</span> <span class='hs-varid'>hs_prov</span>
<a name="line-351"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>body_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsOpenType</span> <span class='hs-varid'>hs_body_ty</span>
<a name="line-352"></a>                     <span class='hs-comment'>-- A (literal) pattern can be unlifted;</span>
<a name="line-353"></a>                     <span class='hs-comment'>-- e.g. pattern Zero &lt;- 0#   (Trac #12094)</span>
<a name="line-354"></a>                 <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bound_tvs</span>
<a name="line-355"></a>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionVarSets</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>allBoundVariabless</span> <span class='hs-varid'>req</span>
<a name="line-356"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>allBoundVariabless</span> <span class='hs-varid'>prov</span>
<a name="line-357"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>allBoundVariables</span> <span class='hs-varid'>body_ty</span>
<a name="line-358"></a>                                        <span class='hs-keyglyph'>]</span>
<a name="line-359"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>req</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span>
<a name="line-360"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>bound_tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-361"></a>
<a name="line-362"></a>       <span class='hs-comment'>-- Kind generalisation</span>
<a name="line-363"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralize</span> <span class='hs-varop'>$</span>
<a name="line-364"></a>                <span class='hs-varid'>build_patsyn_type</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>implicit_tvs</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>req</span>
<a name="line-365"></a>                                  <span class='hs-varid'>ex_tvs</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>body_ty</span>
<a name="line-366"></a>
<a name="line-367"></a>       <span class='hs-comment'>-- These are /signatures/ so we zonk to squeeze out any kind</span>
<a name="line-368"></a>       <span class='hs-comment'>-- unification variables.  Do this after quantifyTyVars which may</span>
<a name="line-369"></a>       <span class='hs-comment'>-- default kind variables to *.</span>
<a name="line-370"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"about zonk"</span> <span class='hs-varid'>empty</span>
<a name="line-371"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>implicit_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyCoVarBndr</span> <span class='hs-varid'>implicit_tvs</span>
<a name="line-372"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>univ_tvs</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyCoVarBndr</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-373"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ex_tvs</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyCoVarBndr</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-374"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>req</span>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypes</span> <span class='hs-varid'>req</span>
<a name="line-375"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>prov</span>         <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypes</span> <span class='hs-varid'>prov</span>
<a name="line-376"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>body_ty</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span>  <span class='hs-varid'>body_ty</span>
<a name="line-377"></a>
<a name="line-378"></a>       <span class='hs-comment'>-- Now do validity checking</span>
<a name="line-379"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span>
<a name="line-380"></a>         <span class='hs-varid'>build_patsyn_type</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>implicit_tvs</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>req</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>body_ty</span>
<a name="line-381"></a>
<a name="line-382"></a>       <span class='hs-comment'>-- arguments become the types of binders. We thus cannot allow</span>
<a name="line-383"></a>       <span class='hs-comment'>-- levity polymorphism here</span>
<a name="line-384"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-varid'>body_ty</span>
<a name="line-385"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkForLevPoly</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-386"></a>
<a name="line-387"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTySig }"</span> <span class='hs-varop'>$</span>
<a name="line-388"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"implicit_tvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_tvs</span> <span class='hs-varid'>implicit_tvs</span>
<a name="line-389"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_tvs</span> <span class='hs-varid'>kvs</span>
<a name="line-390"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"univ_tvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_tvs</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-391"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"req"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>req</span>
<a name="line-392"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ex_tvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_tvs</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-393"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"prov"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prov</span>
<a name="line-394"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"body_ty"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>body_ty</span> <span class='hs-keyglyph'>]</span>
<a name="line-395"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TPSI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>patsig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-396"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_implicit_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarBinders</span> <span class='hs-conid'>Inferred</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>++</span>
<a name="line-397"></a>                                                <span class='hs-varid'>mkTyVarBinders</span> <span class='hs-conid'>Specified</span> <span class='hs-varid'>implicit_tvs</span>
<a name="line-398"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_univ_bndrs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-399"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_req</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>req</span>
<a name="line-400"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_ex_bndrs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-401"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_prov</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prov</span>
<a name="line-402"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsig_body_ty</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-403"></a>  <span class='hs-keyword'>where</span>
<a name="line-404"></a>    <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PatSynCtxt</span> <span class='hs-varid'>name</span>
<a name="line-405"></a>
<a name="line-406"></a>    <span class='hs-varid'>build_patsyn_type</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>imp</span> <span class='hs-varid'>univ</span> <span class='hs-varid'>req</span> <span class='hs-varid'>ex</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>body</span>
<a name="line-407"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInvForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>$</span>
<a name="line-408"></a>        <span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp</span> <span class='hs-varop'>++</span> <span class='hs-varid'>univ</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-409"></a>        <span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>req</span> <span class='hs-varop'>$</span>
<a name="line-410"></a>        <span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-varid'>ex</span> <span class='hs-varop'>$</span>
<a name="line-411"></a>        <span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>prov</span> <span class='hs-varop'>$</span>
<a name="line-412"></a>        <span class='hs-varid'>body</span>
<a name="line-413"></a>
<a name="line-414"></a><a name="ppr_tvs"></a><span class='hs-definition'>ppr_tvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-415"></a><span class='hs-definition'>ppr_tvs</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-416"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-417"></a>
<a name="line-418"></a>
<a name="line-419"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-420"></a>*                                                                      *
<a name="line-421"></a>               Instantiating user signatures
<a name="line-422"></a>*                                                                      *
<a name="line-423"></a>********************************************************************* -}</span>
<a name="line-424"></a>
<a name="line-425"></a>
<a name="line-426"></a><a name="tcInstSig"></a><span class='hs-definition'>tcInstSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdSigInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcIdSigInst</span>
<a name="line-427"></a><span class='hs-comment'>-- Instantiate a type signature; only used with plan InferGen</span>
<a name="line-428"></a><span class='hs-definition'>tcInstSig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CompleteSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-429"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- Set the binding site of the tyvars</span>
<a name="line-430"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstType</span> <span class='hs-varid'>newMetaSigTyVars</span> <span class='hs-varid'>poly_id</span>
<a name="line-431"></a>              <span class='hs-comment'>-- See Note [Pattern bindings and complete signatures]</span>
<a name="line-432"></a>
<a name="line-433"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span>
<a name="line-434"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_prs</span>
<a name="line-435"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-436"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcx</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-437"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span>
<a name="line-438"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_tau</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-439"></a>
<a name="line-440"></a><span class='hs-definition'>tcInstSig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psig_hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span>
<a name="line-441"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span>
<a name="line-442"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-443"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- Set the binding site of the tyvars</span>
<a name="line-444"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsPartialSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-445"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_inst_sig</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span>
<a name="line-446"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-447"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wcs</span>
<a name="line-448"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_wcx</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wcx</span>
<a name="line-449"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span>
<a name="line-450"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>sig_inst_tau</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-451"></a>
<a name="line-452"></a>
<a name="line-453"></a><span class='hs-comment'>{- Note [Pattern bindings and complete signatures]
<a name="line-454"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-455"></a>Consider
<a name="line-456"></a>      data T a = MkT a a
<a name="line-457"></a>      f :: forall a. a-&gt;a
<a name="line-458"></a>      g :: forall b. b-&gt;b
<a name="line-459"></a>      MkT f g = MkT (\x-&gt;x) (\y-&gt;y)
<a name="line-460"></a>Here we'll infer a type from the pattern of 'T a', but if we feed in
<a name="line-461"></a>the signature types for f and g, we'll end up unifying 'a' and 'b'
<a name="line-462"></a>
<a name="line-463"></a>So we instantiate f and g's signature with SigTv skolems
<a name="line-464"></a>(newMetaSigTyVars) that can unify with each other.  If too much
<a name="line-465"></a>unification takes place, we'll find out when we do the final
<a name="line-466"></a>impedance-matching check in TcBinds.mkExport
<a name="line-467"></a>
<a name="line-468"></a>See Note [Signature skolems] in TcType
<a name="line-469"></a>
<a name="line-470"></a>None of this applies to a function binding with a complete
<a name="line-471"></a>signature, which doesn't use tcInstSig.  See TcBinds.tcPolyCheck.
<a name="line-472"></a>-}</span>
<a name="line-473"></a>
<a name="line-474"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-475"></a>*                                                                      *
<a name="line-476"></a>                   Pragmas and PragEnv
<a name="line-477"></a>*                                                                      *
<a name="line-478"></a>********************************************************************* -}</span>
<a name="line-479"></a>
<a name="line-480"></a><a name="TcPragEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcPragEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-481"></a>
<a name="line-482"></a><a name="emptyPragEnv"></a><span class='hs-definition'>emptyPragEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPragEnv</span>
<a name="line-483"></a><span class='hs-definition'>emptyPragEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameEnv</span>
<a name="line-484"></a>
<a name="line-485"></a><a name="lookupPragEnv"></a><span class='hs-definition'>lookupPragEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPragEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-486"></a><span class='hs-definition'>lookupPragEnv</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-487"></a>
<a name="line-488"></a><a name="extendPragEnv"></a><span class='hs-definition'>extendPragEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPragEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPragEnv</span>
<a name="line-489"></a><span class='hs-definition'>extendPragEnv</span> <span class='hs-varid'>prag_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv_Acc</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>singleton</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>n</span> <span class='hs-varid'>sig</span>
<a name="line-490"></a>
<a name="line-491"></a><a name="mkPragEnv"></a><span class='hs-comment'>---------------</span>
<a name="line-492"></a><span class='hs-definition'>mkPragEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPragEnv</span>
<a name="line-493"></a><span class='hs-definition'>mkPragEnv</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>binds</span>
<a name="line-494"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>extendPragEnv</span> <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>prs</span>
<a name="line-495"></a>  <span class='hs-keyword'>where</span>
<a name="line-496"></a>    <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>get_sig</span> <span class='hs-varid'>sigs</span>
<a name="line-497"></a>
<a name="line-498"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-499"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-varid'>lnm</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SpecSig</span>   <span class='hs-varid'>lnm</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_arity</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-500"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-varid'>lnm</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-conid'>InlineSig</span> <span class='hs-varid'>lnm</span>    <span class='hs-layout'>(</span><span class='hs-varid'>add_arity</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-501"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCCFunSig</span> <span class='hs-varid'>st</span> <span class='hs-varid'>lnm</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SCCFunSig</span> <span class='hs-varid'>st</span> <span class='hs-varid'>lnm</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>
<a name="line-502"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-keyword'>_</span>                                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-503"></a>
<a name="line-504"></a>    <span class='hs-varid'>add_arity</span> <span class='hs-varid'>n</span> <span class='hs-varid'>inl_prag</span>   <span class='hs-comment'>-- Adjust inl_sat field to match visible arity of function</span>
<a name="line-505"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Inline</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inl_inline</span> <span class='hs-varid'>inl_prag</span>
<a name="line-506"></a>        <span class='hs-comment'>-- add arity only for real INLINE pragmas, not INLINABLE</span>
<a name="line-507"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>ar_env</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>of</span>
<a name="line-508"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>ar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inl_prag</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inl_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ar</span> <span class='hs-layout'>}</span>
<a name="line-509"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"mkPragEnv no arity"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-layout'>)</span>
<a name="line-510"></a>                     <span class='hs-comment'>-- There really should be a binding for every INLINE pragma</span>
<a name="line-511"></a>                     <span class='hs-varid'>inl_prag</span>
<a name="line-512"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-513"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inl_prag</span>
<a name="line-514"></a>
<a name="line-515"></a>    <span class='hs-comment'>-- ar_env maps a local to the arity of its definition</span>
<a name="line-516"></a>    <span class='hs-varid'>ar_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Arity</span>
<a name="line-517"></a>    <span class='hs-varid'>ar_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>lhsBindArity</span> <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>binds</span>
<a name="line-518"></a>
<a name="line-519"></a><a name="lhsBindArity"></a><span class='hs-definition'>lhsBindArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Arity</span>
<a name="line-520"></a><span class='hs-definition'>lhsBindArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-521"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>matchGroupArity</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-522"></a><span class='hs-definition'>lhsBindArity</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>        <span class='hs-comment'>-- PatBind/VarBind</span>
<a name="line-523"></a>
<a name="line-524"></a>
<a name="line-525"></a><a name="addInlinePrags"></a><span class='hs-comment'>-----------------</span>
<a name="line-526"></a><span class='hs-definition'>addInlinePrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcId</span>
<a name="line-527"></a><span class='hs-definition'>addInlinePrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prags_for_me</span>
<a name="line-528"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>inls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inl_prags</span>
<a name="line-529"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"addInlinePrag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-530"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>inls</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>warn_multiple_inlines</span> <span class='hs-varid'>inl</span> <span class='hs-varid'>inls</span><span class='hs-layout'>)</span>
<a name="line-531"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_id</span> <span class='hs-varop'>`setInlinePragma`</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-532"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-533"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>poly_id</span>
<a name="line-534"></a>  <span class='hs-keyword'>where</span>
<a name="line-535"></a>    <span class='hs-varid'>inl_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prags_for_me</span><span class='hs-keyglyph'>]</span>
<a name="line-536"></a>
<a name="line-537"></a>    <span class='hs-varid'>warn_multiple_inlines</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-538"></a>
<a name="line-539"></a>    <span class='hs-varid'>warn_multiple_inlines</span> <span class='hs-varid'>inl1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>prag1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inl2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag2</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>inls</span><span class='hs-layout'>)</span>
<a name="line-540"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inlinePragmaActivation</span> <span class='hs-varid'>prag1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>inlinePragmaActivation</span> <span class='hs-varid'>prag2</span>
<a name="line-541"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyInlineSpec</span> <span class='hs-layout'>(</span><span class='hs-varid'>inlinePragmaSpec</span> <span class='hs-varid'>prag1</span><span class='hs-layout'>)</span>
<a name="line-542"></a>       <span class='hs-keyglyph'>=</span>    <span class='hs-comment'>-- Tiresome: inl1 is put there by virtue of being in a hs-boot loop</span>
<a name="line-543"></a>            <span class='hs-comment'>-- and inl2 is a user NOINLINE pragma; we don't want to complain</span>
<a name="line-544"></a>         <span class='hs-varid'>warn_multiple_inlines</span> <span class='hs-varid'>inl2</span> <span class='hs-varid'>inls</span>
<a name="line-545"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-546"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-547"></a>         <span class='hs-varid'>addWarnTc</span> <span class='hs-conid'>NoReason</span>
<a name="line-548"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Multiple INLINE pragmas for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-549"></a>                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Ignoring all but the first"</span>
<a name="line-550"></a>                                <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>pp_inl</span> <span class='hs-layout'>(</span><span class='hs-varid'>inl1</span><span class='hs-conop'>:</span><span class='hs-varid'>inl2</span><span class='hs-conop'>:</span><span class='hs-varid'>inls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-551"></a>
<a name="line-552"></a>    <span class='hs-varid'>pp_inl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-553"></a>
<a name="line-554"></a>
<a name="line-555"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-556"></a>*                                                                      *
<a name="line-557"></a>                   SPECIALISE pragmas
<a name="line-558"></a>*                                                                      *
<a name="line-559"></a>************************************************************************
<a name="line-560"></a>
<a name="line-561"></a>Note [Handling SPECIALISE pragmas]
<a name="line-562"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-563"></a>The basic idea is this:
<a name="line-564"></a>
<a name="line-565"></a>   foo :: Num a =&gt; a -&gt; b -&gt; a
<a name="line-566"></a>   {-# SPECIALISE foo :: Int -&gt; b -&gt; Int #-}
<a name="line-567"></a>
<a name="line-568"></a>We check that
<a name="line-569"></a>   (forall a b. Num a =&gt; a -&gt; b -&gt; a)
<a name="line-570"></a>      is more polymorphic than
<a name="line-571"></a>   forall b. Int -&gt; b -&gt; Int
<a name="line-572"></a>(for which we could use tcSubType, but see below), generating a HsWrapper
<a name="line-573"></a>to connect the two, something like
<a name="line-574"></a>      wrap = /\b. &lt;hole&gt; Int b dNumInt
<a name="line-575"></a>This wrapper is put in the TcSpecPrag, in the ABExport record of
<a name="line-576"></a>the AbsBinds.
<a name="line-577"></a>
<a name="line-578"></a>
<a name="line-579"></a>        f :: (Eq a, Ix b) =&gt; a -&gt; b -&gt; Bool
<a name="line-580"></a>        {-# SPECIALISE f :: (Ix p, Ix q) =&gt; Int -&gt; (p,q) -&gt; Bool #-}
<a name="line-581"></a>        f = &lt;poly_rhs&gt;
<a name="line-582"></a>
<a name="line-583"></a>From this the typechecker generates
<a name="line-584"></a>
<a name="line-585"></a>    AbsBinds [ab] [d1,d2] [([ab], f, f_mono, prags)] binds
<a name="line-586"></a>
<a name="line-587"></a>    SpecPrag (wrap_fn :: forall a b. (Eq a, Ix b) =&gt; XXX
<a name="line-588"></a>                      -&gt; forall p q. (Ix p, Ix q) =&gt; XXX[ Int/a, (p,q)/b ])
<a name="line-589"></a>
<a name="line-590"></a>From these we generate:
<a name="line-591"></a>
<a name="line-592"></a>    Rule:       forall p, q, (dp:Ix p), (dq:Ix q).
<a name="line-593"></a>                    f Int (p,q) dInt ($dfInPair dp dq) = f_spec p q dp dq
<a name="line-594"></a>
<a name="line-595"></a>    Spec bind:  f_spec = wrap_fn &lt;poly_rhs&gt;
<a name="line-596"></a>
<a name="line-597"></a>Note that
<a name="line-598"></a>
<a name="line-599"></a>  * The LHS of the rule may mention dictionary *expressions* (eg
<a name="line-600"></a>    $dfIxPair dp dq), and that is essential because the dp, dq are
<a name="line-601"></a>    needed on the RHS.
<a name="line-602"></a>
<a name="line-603"></a>  * The RHS of f_spec, &lt;poly_rhs&gt; has a *copy* of 'binds', so that it
<a name="line-604"></a>    can fully specialise it.
<a name="line-605"></a>
<a name="line-606"></a>
<a name="line-607"></a>
<a name="line-608"></a>From the TcSpecPrag, in DsBinds we generate a binding for f_spec and a RULE:
<a name="line-609"></a>
<a name="line-610"></a>   f_spec :: Int -&gt; b -&gt; Int
<a name="line-611"></a>   f_spec = wrap&lt;f rhs&gt;
<a name="line-612"></a>
<a name="line-613"></a>   RULE: forall b (d:Num b). f b d = f_spec b
<a name="line-614"></a>
<a name="line-615"></a>The RULE is generated by taking apart the HsWrapper, which is a little
<a name="line-616"></a>delicate, but works.
<a name="line-617"></a>
<a name="line-618"></a>Some wrinkles
<a name="line-619"></a>
<a name="line-620"></a>1. We don't use full-on tcSubType, because that does co and contra
<a name="line-621"></a>   variance and that in turn will generate too complex a LHS for the
<a name="line-622"></a>   RULE.  So we use a single invocation of skolemise /
<a name="line-623"></a>   topInstantiate in tcSpecWrapper.  (Actually I think that even
<a name="line-624"></a>   the "deeply" stuff may be too much, because it introduces lambdas,
<a name="line-625"></a>   though I think it can be made to work without too much trouble.)
<a name="line-626"></a>
<a name="line-627"></a>2. We need to take care with type families (Trac #5821).  Consider
<a name="line-628"></a>      type instance F Int = Bool
<a name="line-629"></a>      f :: Num a =&gt; a -&gt; F a
<a name="line-630"></a>      {-# SPECIALISE foo :: Int -&gt; Bool #-}
<a name="line-631"></a>
<a name="line-632"></a>  We *could* try to generate an f_spec with precisely the declared type:
<a name="line-633"></a>      f_spec :: Int -&gt; Bool
<a name="line-634"></a>      f_spec = &lt;f rhs&gt; Int dNumInt |&gt; co
<a name="line-635"></a>
<a name="line-636"></a>      RULE: forall d. f Int d = f_spec |&gt; sym co
<a name="line-637"></a>
<a name="line-638"></a>  but the 'co' and 'sym co' are (a) playing no useful role, and (b) are
<a name="line-639"></a>  hard to generate.  At all costs we must avoid this:
<a name="line-640"></a>      RULE: forall d. f Int d |&gt; co = f_spec
<a name="line-641"></a>  because the LHS will never match (indeed it's rejected in
<a name="line-642"></a>  decomposeRuleLhs).
<a name="line-643"></a>
<a name="line-644"></a>  So we simply do this:
<a name="line-645"></a>    - Generate a constraint to check that the specialised type (after
<a name="line-646"></a>      skolemiseation) is equal to the instantiated function type.
<a name="line-647"></a>    - But *discard* the evidence (coercion) for that constraint,
<a name="line-648"></a>      so that we ultimately generate the simpler code
<a name="line-649"></a>          f_spec :: Int -&gt; F Int
<a name="line-650"></a>          f_spec = &lt;f rhs&gt; Int dNumInt
<a name="line-651"></a>
<a name="line-652"></a>          RULE: forall d. f Int d = f_spec
<a name="line-653"></a>      You can see this discarding happening in
<a name="line-654"></a>
<a name="line-655"></a>3. Note that the HsWrapper can transform *any* function with the right
<a name="line-656"></a>   type prefix
<a name="line-657"></a>       forall ab. (Eq a, Ix b) =&gt; XXX
<a name="line-658"></a>   regardless of XXX.  It's sort of polymorphic in XXX.  This is
<a name="line-659"></a>   useful: we use the same wrapper to transform each of the class ops, as
<a name="line-660"></a>   well as the dict.  That's what goes on in TcInstDcls.mk_meth_spec_prags
<a name="line-661"></a>-}</span>
<a name="line-662"></a>
<a name="line-663"></a><a name="tcSpecPrags"></a><span class='hs-definition'>tcSpecPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-664"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-665"></a><span class='hs-comment'>-- Add INLINE and SPECIALSE pragmas</span>
<a name="line-666"></a><span class='hs-comment'>--    INLINE prags are added to the (polymorphic) Id directly</span>
<a name="line-667"></a><span class='hs-comment'>--    SPECIALISE prags are passed to the desugarer via TcSpecPrags</span>
<a name="line-668"></a><span class='hs-comment'>-- Pre-condition: the poly_id is zonked</span>
<a name="line-669"></a><span class='hs-comment'>-- Reason: required by tcSubExp</span>
<a name="line-670"></a><span class='hs-definition'>tcSpecPrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-671"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSpecPrags"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>spec_sigs</span><span class='hs-layout'>)</span>
<a name="line-672"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_sigs</span><span class='hs-layout'>)</span> <span class='hs-varid'>warn_discarded_sigs</span>
<a name="line-673"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>pss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSpecPrag</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>spec_sigs</span>
<a name="line-674"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>pss</span> <span class='hs-layout'>}</span>
<a name="line-675"></a>  <span class='hs-keyword'>where</span>
<a name="line-676"></a>    <span class='hs-varid'>spec_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isSpecLSig</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-677"></a>    <span class='hs-varid'>bad_sigs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>is_bad_sig</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-678"></a>    <span class='hs-varid'>is_bad_sig</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSpecLSig</span> <span class='hs-varid'>s</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isInlineLSig</span> <span class='hs-varid'>s</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isSCCFunSig</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-679"></a>
<a name="line-680"></a>    <span class='hs-varid'>warn_discarded_sigs</span>
<a name="line-681"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnTc</span> <span class='hs-conid'>NoReason</span>
<a name="line-682"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Discarding unexpected pragmas for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-683"></a>                      <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>bad_sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-684"></a>
<a name="line-685"></a><a name="tcSpecPrag"></a><span class='hs-comment'>--------------</span>
<a name="line-686"></a><span class='hs-definition'>tcSpecPrag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-687"></a><span class='hs-definition'>tcSpecPrag</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-varid'>fun_name</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span>
<a name="line-688"></a><span class='hs-comment'>-- See Note [Handling SPECIALISE pragmas]</span>
<a name="line-689"></a><span class='hs-comment'>--</span>
<a name="line-690"></a><span class='hs-comment'>-- The Name fun_name in the SpecSig may not be the same as that of the poly_id</span>
<a name="line-691"></a><span class='hs-comment'>-- Example: SPECIALISE for a class method: the Name in the SpecSig is</span>
<a name="line-692"></a><span class='hs-comment'>--          for the selector Id, but the poly_id is something like $cop</span>
<a name="line-693"></a><span class='hs-comment'>-- However we want to use fun_name in the error message, since that is</span>
<a name="line-694"></a><span class='hs-comment'>-- what the user wrote (Trac #8537)</span>
<a name="line-695"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_ctxt</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-696"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>warnIf</span> <span class='hs-conid'>NoReason</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isOverloadedTy</span> <span class='hs-varid'>poly_ty</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isInlinePragma</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-697"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"SPECIALISE pragma for non-overloaded function"</span>
<a name="line-698"></a>                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-699"></a>                  <span class='hs-comment'>-- Note [SPECIALISE pragmas]</span>
<a name="line-700"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>spec_prags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_one</span> <span class='hs-varid'>hs_tys</span>
<a name="line-701"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcSpecPrag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>spec_prags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-702"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>spec_prags</span> <span class='hs-layout'>}</span>
<a name="line-703"></a>  <span class='hs-keyword'>where</span>
<a name="line-704"></a>    <span class='hs-varid'>name</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>poly_id</span>
<a name="line-705"></a>    <span class='hs-varid'>poly_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>poly_id</span>
<a name="line-706"></a>    <span class='hs-varid'>spec_ctxt</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the SPECIALISE pragma"</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-707"></a>
<a name="line-708"></a>    <span class='hs-varid'>tc_one</span> <span class='hs-varid'>hs_ty</span>
<a name="line-709"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>spec_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsSigType</span>   <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_ty</span>
<a name="line-710"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSpecWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>  <span class='hs-varid'>poly_ty</span> <span class='hs-varid'>spec_ty</span>
<a name="line-711"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrag</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-712"></a>
<a name="line-713"></a><span class='hs-definition'>tcSpecPrag</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcSpecPrag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-714"></a>
<a name="line-715"></a><a name="tcSpecWrapper"></a><span class='hs-comment'>--------------</span>
<a name="line-716"></a><span class='hs-definition'>tcSpecWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-717"></a><span class='hs-comment'>-- A simpler variant of tcSubType, used for SPECIALISE pragmas</span>
<a name="line-718"></a><span class='hs-comment'>-- See Note [Handling SPECIALISE pragmas], wrinkle 1</span>
<a name="line-719"></a><span class='hs-definition'>tcSpecWrapper</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>poly_ty</span> <span class='hs-varid'>spec_ty</span>
<a name="line-720"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_wrap</span><span class='hs-layout'>)</span>
<a name="line-721"></a>               <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSkolemise</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>spec_ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>spec_tau</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-722"></a>                  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>topInstantiate</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>poly_ty</span>
<a name="line-723"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>noThing</span> <span class='hs-varid'>spec_tau</span> <span class='hs-varid'>tau</span>
<a name="line-724"></a>                            <span class='hs-comment'>-- Deliberately ignore the evidence</span>
<a name="line-725"></a>                            <span class='hs-comment'>-- See Note [Handling SPECIALISE pragmas],</span>
<a name="line-726"></a>                            <span class='hs-comment'>--   wrinkle (2)</span>
<a name="line-727"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>inst_wrap</span> <span class='hs-layout'>}</span>
<a name="line-728"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>inst_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-729"></a>  <span class='hs-keyword'>where</span>
<a name="line-730"></a>    <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpecPragOrigin</span> <span class='hs-varid'>ctxt</span>
<a name="line-731"></a>
<a name="line-732"></a><a name="tcImpPrags"></a><span class='hs-comment'>--------------</span>
<a name="line-733"></a><span class='hs-definition'>tcImpPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-734"></a><span class='hs-comment'>-- SPECIALISE pragmas for imported things</span>
<a name="line-735"></a><span class='hs-definition'>tcImpPrags</span> <span class='hs-varid'>prags</span>
<a name="line-736"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-737"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-738"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>not_specialising</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>
<a name="line-739"></a>            <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-740"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-741"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>pss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>tcImpSpec</span><span class='hs-layout'>)</span>
<a name="line-742"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-743"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>prag</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prags</span>
<a name="line-744"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-745"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>pss</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-746"></a>  <span class='hs-keyword'>where</span>
<a name="line-747"></a>    <span class='hs-comment'>-- Ignore SPECIALISE pragmas for imported things</span>
<a name="line-748"></a>    <span class='hs-comment'>-- when we aren't specialising, or when we aren't generating</span>
<a name="line-749"></a>    <span class='hs-comment'>-- code.  The latter happens when Haddocking the base library;</span>
<a name="line-750"></a>    <span class='hs-comment'>-- we don't wnat complaints about lack of INLINABLE pragmas</span>
<a name="line-751"></a>    <span class='hs-varid'>not_specialising</span> <span class='hs-varid'>dflags</span>
<a name="line-752"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Specialise</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-753"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hscTarget</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-754"></a>                      <span class='hs-conid'>HscNothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-755"></a>                      <span class='hs-conid'>HscInterpreted</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-756"></a>                      <span class='hs-sel'>_other</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-757"></a>
<a name="line-758"></a><a name="tcImpSpec"></a><span class='hs-definition'>tcImpSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-759"></a><span class='hs-definition'>tcImpSpec</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-760"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>name</span>
<a name="line-761"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isAnyInlinePragma</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInlinePragma</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-762"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>addWarnTc</span> <span class='hs-conid'>NoReason</span> <span class='hs-layout'>(</span><span class='hs-varid'>impSpecErr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-763"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>tcSpecPrag</span> <span class='hs-varid'>id</span> <span class='hs-varid'>prag</span> <span class='hs-layout'>}</span>
<a name="line-764"></a>
<a name="line-765"></a><a name="impSpecErr"></a><span class='hs-definition'>impSpecErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-766"></a><span class='hs-definition'>impSpecErr</span> <span class='hs-varid'>name</span>
<a name="line-767"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"You cannot SPECIALISE"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-768"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"because its definition has no INLINE/INLINABLE pragma"</span>
<a name="line-769"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span>
<a name="line-770"></a>                   <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"or its defining module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-771"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"was compiled without -O"</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-772"></a>  <span class='hs-keyword'>where</span>
<a name="line-773"></a>    <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
</pre></body>
</html>
