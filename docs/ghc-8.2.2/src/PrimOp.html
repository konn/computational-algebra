<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>prelude/PrimOp.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-3"></a>
<a name="line-4"></a>\section[PrimOp]{Primitive operations (machine-level)}
<a name="line-5"></a>-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>-- The default is a bit too low for the quite large primOpInfo definition</span>
<a name="line-10"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt;= 801</span>
<a name="line-11"></a><span class='hs-comment'>{-# OPTIONS_GHC -fmax-pmcheck-iterations=10000000 #-}</span>
<a name="line-12"></a><span class='hs-cpp'>#endif</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>PrimOp</span> <span class='hs-layout'>(</span>
<a name="line-15"></a>        <span class='hs-conid'>PrimOp</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimOpVecCat</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>allThePrimOps</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>primOpType</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpSig</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>primOpTag</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxPrimOpTag</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpOcc</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-varid'>tagToEnumKey</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>        <span class='hs-varid'>primOpOutOfLine</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpCodeSize</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>primOpOkForSpeculation</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpOkForSideEffects</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>primOpIsCheap</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpFixity</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-varid'>getPrimOpResultInfo</span><span class='hs-layout'>,</span>  <span class='hs-conid'>PrimOpResultInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-conid'>PrimCall</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-28"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmType</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>OccName</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprOccName</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>            <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPrimTyCon</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimRep</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RepType</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>typePrimRep1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConPrimRep1</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FixityDirection</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Boxity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-42"></a>                          <span class='hs-conid'>SourceText</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>CLabelString</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPrimOpIdUnique</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>UnitId</span> <span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-comment'>{-
<a name="line-50"></a>************************************************************************
<a name="line-51"></a>*                                                                      *
<a name="line-52"></a>\subsection[PrimOp-datatype]{Datatype for @PrimOp@ (an enumeration)}
<a name="line-53"></a>*                                                                      *
<a name="line-54"></a>************************************************************************
<a name="line-55"></a>
<a name="line-56"></a>These are in \tr{state-interface.verb} order.
<a name="line-57"></a>-}</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-comment'>-- supplies:</span>
<a name="line-60"></a><span class='hs-comment'>-- data PrimOp = ...</span>
<a name="line-61"></a><span class='hs-cpp'>#include "primop-data-decl.hs-incl"</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-comment'>-- supplies</span>
<a name="line-64"></a><span class='hs-comment'>-- primOpTag :: PrimOp -&gt; Int</span>
<a name="line-65"></a><span class='hs-cpp'>#include "primop-tag.hs-incl"</span>
<a name="line-66"></a><a name="primOpTag"></a><span class='hs-definition'>primOpTag</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"primOpTag: unknown primop"</span>
<a name="line-67"></a>
<a name="line-68"></a>
<a name="line-69"></a><a name="instance%20Eq%20PrimOp"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyword'>where</span>
<a name="line-70"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="instance%20Ord%20PrimOp"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyword'>where</span>
<a name="line-73"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;</span>  <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-74"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-75"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-76"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;</span>  <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>primOpTag</span> <span class='hs-varid'>op2</span>
<a name="line-77"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>op2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-78"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-79"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="instance%20Outputable%20PrimOp"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyword'>where</span>
<a name="line-82"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrimOp</span> <span class='hs-varid'>op</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="PrimOpVecCat"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimOpVecCat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IntVec</span>
<a name="line-85"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WordVec</span>
<a name="line-86"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FloatVec</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-comment'>-- An @Enum@-derived list would be better; meanwhile... (ToDo)</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="allThePrimOps"></a><span class='hs-definition'>allThePrimOps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PrimOp</span><span class='hs-keyglyph'>]</span>
<a name="line-91"></a><span class='hs-definition'>allThePrimOps</span> <span class='hs-keyglyph'>=</span>
<a name="line-92"></a><span class='hs-cpp'>#include "primop-list.hs-incl"</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="tagToEnumKey"></a><span class='hs-definition'>tagToEnumKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span>
<a name="line-95"></a><span class='hs-definition'>tagToEnumKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimOpIdUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpTag</span> <span class='hs-conid'>TagToEnumOp</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-comment'>{-
<a name="line-98"></a>************************************************************************
<a name="line-99"></a>*                                                                      *
<a name="line-100"></a>\subsection[PrimOp-info]{The essential info about each @PrimOp@}
<a name="line-101"></a>*                                                                      *
<a name="line-102"></a>************************************************************************
<a name="line-103"></a>
<a name="line-104"></a>The @String@ in the @PrimOpInfos@ is the ``base name'' by which the user may
<a name="line-105"></a>refer to the primitive operation.  The conventional \tr{#}-for-
<a name="line-106"></a>unboxed ops is added on later.
<a name="line-107"></a>
<a name="line-108"></a>The reason for the funny characters in the names is so we do not
<a name="line-109"></a>interfere with the programmer's Haskell name spaces.
<a name="line-110"></a>
<a name="line-111"></a>We use @PrimKinds@ for the ``type'' information, because they're
<a name="line-112"></a>(slightly) more convenient to use than @TyCons@.
<a name="line-113"></a>-}</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="PrimOpInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dyadic</span>      <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: T -&gt; T -&gt; T</span>
<a name="line-117"></a>                <span class='hs-conid'>Type</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Monadic</span>     <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: T -&gt; T</span>
<a name="line-119"></a>                <span class='hs-conid'>Type</span>
<a name="line-120"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Compare</span>     <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: T -&gt; T -&gt; Int#</span>
<a name="line-121"></a>                <span class='hs-conid'>Type</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>GenPrimOp</span>   <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: \/a1..an . T1 -&gt; .. -&gt; Tk -&gt; T</span>
<a name="line-123"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-124"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-125"></a>                <span class='hs-conid'>Type</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="mkDyadic"></a><span class='hs-definition'>mkDyadic</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkMonadic</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCompare</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-128"></a><span class='hs-definition'>mkDyadic</span> <span class='hs-varid'>str</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dyadic</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-129"></a><a name="mkMonadic"></a><span class='hs-definition'>mkMonadic</span> <span class='hs-varid'>str</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Monadic</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-130"></a><a name="mkCompare"></a><span class='hs-definition'>mkCompare</span> <span class='hs-varid'>str</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="mkGenPrimOp"></a><span class='hs-definition'>mkGenPrimOp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-133"></a><span class='hs-definition'>mkGenPrimOp</span> <span class='hs-varid'>str</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenPrimOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-comment'>{-
<a name="line-136"></a>************************************************************************
<a name="line-137"></a>*                                                                      *
<a name="line-138"></a>\subsubsection{Strictness}
<a name="line-139"></a>*                                                                      *
<a name="line-140"></a>************************************************************************
<a name="line-141"></a>
<a name="line-142"></a>Not all primops are strict!
<a name="line-143"></a>-}</span>
<a name="line-144"></a>
<a name="line-145"></a><a name="primOpStrictness"></a><span class='hs-definition'>primOpStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-146"></a>        <span class='hs-comment'>-- See Demand.StrictnessInfo for discussion of what the results</span>
<a name="line-147"></a>        <span class='hs-comment'>-- The arity should be the arity of the primop; that's why</span>
<a name="line-148"></a>        <span class='hs-comment'>-- this function isn't exported.</span>
<a name="line-149"></a><span class='hs-cpp'>#include "primop-strictness.hs-incl"</span>
<a name="line-150"></a>
<a name="line-151"></a><span class='hs-comment'>{-
<a name="line-152"></a>************************************************************************
<a name="line-153"></a>*                                                                      *
<a name="line-154"></a>\subsubsection{Fixity}
<a name="line-155"></a>*                                                                      *
<a name="line-156"></a>************************************************************************
<a name="line-157"></a>-}</span>
<a name="line-158"></a>
<a name="line-159"></a><a name="primOpFixity"></a><span class='hs-definition'>primOpFixity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fixity</span>
<a name="line-160"></a><span class='hs-cpp'>#include "primop-fixity.hs-incl"</span>
<a name="line-161"></a>
<a name="line-162"></a><span class='hs-comment'>{-
<a name="line-163"></a>************************************************************************
<a name="line-164"></a>*                                                                      *
<a name="line-165"></a>\subsubsection[PrimOp-comparison]{PrimOpInfo basic comparison ops}
<a name="line-166"></a>*                                                                      *
<a name="line-167"></a>************************************************************************
<a name="line-168"></a>
<a name="line-169"></a>@primOpInfo@ gives all essential information (from which everything
<a name="line-170"></a>else, notably a type, can be constructed) for each @PrimOp@.
<a name="line-171"></a>-}</span>
<a name="line-172"></a>
<a name="line-173"></a><a name="primOpInfo"></a><span class='hs-definition'>primOpInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-174"></a><span class='hs-cpp'>#include "primop-primop-info.hs-incl"</span>
<a name="line-175"></a><span class='hs-definition'>primOpInfo</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"primOpInfo: unknown primop"</span>
<a name="line-176"></a>
<a name="line-177"></a><span class='hs-comment'>{-
<a name="line-178"></a>Here are a load of comments from the old primOp info:
<a name="line-179"></a>
<a name="line-180"></a>A @Word#@ is an unsigned @Int#@.
<a name="line-181"></a>
<a name="line-182"></a>@decodeFloat#@ is given w/ Integer-stuff (it's similar).
<a name="line-183"></a>
<a name="line-184"></a>@decodeDouble#@ is given w/ Integer-stuff (it's similar).
<a name="line-185"></a>
<a name="line-186"></a>Decoding of floating-point numbers is sorta Integer-related.  Encoding
<a name="line-187"></a>is done with plain ccalls now (see PrelNumExtra.hs).
<a name="line-188"></a>
<a name="line-189"></a>A @Weak@ Pointer is created by the @mkWeak#@ primitive:
<a name="line-190"></a>
<a name="line-191"></a>        mkWeak# :: k -&gt; v -&gt; f -&gt; State# RealWorld
<a name="line-192"></a>                        -&gt; (# State# RealWorld, Weak# v #)
<a name="line-193"></a>
<a name="line-194"></a>In practice, you'll use the higher-level
<a name="line-195"></a>
<a name="line-196"></a>        data Weak v = Weak# v
<a name="line-197"></a>        mkWeak :: k -&gt; v -&gt; IO () -&gt; IO (Weak v)
<a name="line-198"></a>
<a name="line-199"></a>The following operation dereferences a weak pointer.  The weak pointer
<a name="line-200"></a>may have been finalized, so the operation returns a result code which
<a name="line-201"></a>must be inspected before looking at the dereferenced value.
<a name="line-202"></a>
<a name="line-203"></a>        deRefWeak# :: Weak# v -&gt; State# RealWorld -&gt;
<a name="line-204"></a>                        (# State# RealWorld, v, Int# #)
<a name="line-205"></a>
<a name="line-206"></a>Only look at v if the Int# returned is /= 0 !!
<a name="line-207"></a>
<a name="line-208"></a>The higher-level op is
<a name="line-209"></a>
<a name="line-210"></a>        deRefWeak :: Weak v -&gt; IO (Maybe v)
<a name="line-211"></a>
<a name="line-212"></a>Weak pointers can be finalized early by using the finalize# operation:
<a name="line-213"></a>
<a name="line-214"></a>        finalizeWeak# :: Weak# v -&gt; State# RealWorld -&gt;
<a name="line-215"></a>                           (# State# RealWorld, Int#, IO () #)
<a name="line-216"></a>
<a name="line-217"></a>The Int# returned is either
<a name="line-218"></a>
<a name="line-219"></a>        0 if the weak pointer has already been finalized, or it has no
<a name="line-220"></a>          finalizer (the third component is then invalid).
<a name="line-221"></a>
<a name="line-222"></a>        1 if the weak pointer is still alive, with the finalizer returned
<a name="line-223"></a>          as the third component.
<a name="line-224"></a>
<a name="line-225"></a>A {\em stable name/pointer} is an index into a table of stable name
<a name="line-226"></a>entries.  Since the garbage collector is told about stable pointers,
<a name="line-227"></a>it is safe to pass a stable pointer to external systems such as C
<a name="line-228"></a>routines.
<a name="line-229"></a>
<a name="line-230"></a>\begin{verbatim}
<a name="line-231"></a>makeStablePtr#  :: a -&gt; State# RealWorld -&gt; (# State# RealWorld, StablePtr# a #)
<a name="line-232"></a>freeStablePtr   :: StablePtr# a -&gt; State# RealWorld -&gt; State# RealWorld
<a name="line-233"></a>deRefStablePtr# :: StablePtr# a -&gt; State# RealWorld -&gt; (# State# RealWorld, a #)
<a name="line-234"></a>eqStablePtr#    :: StablePtr# a -&gt; StablePtr# a -&gt; Int#
<a name="line-235"></a>\end{verbatim}
<a name="line-236"></a>
<a name="line-237"></a>It may seem a bit surprising that @makeStablePtr#@ is a @IO@
<a name="line-238"></a>operation since it doesn't (directly) involve IO operations.  The
<a name="line-239"></a>reason is that if some optimisation pass decided to duplicate calls to
<a name="line-240"></a>@makeStablePtr#@ and we only pass one of the stable pointers over, a
<a name="line-241"></a>massive space leak can result.  Putting it into the IO monad
<a name="line-242"></a>prevents this.  (Another reason for putting them in a monad is to
<a name="line-243"></a>ensure correct sequencing wrt the side-effecting @freeStablePtr@
<a name="line-244"></a>operation.)
<a name="line-245"></a>
<a name="line-246"></a>An important property of stable pointers is that if you call
<a name="line-247"></a>makeStablePtr# twice on the same object you get the same stable
<a name="line-248"></a>pointer back.
<a name="line-249"></a>
<a name="line-250"></a>Note that we can implement @freeStablePtr#@ using @_ccall_@ (and,
<a name="line-251"></a>besides, it's not likely to be used from Haskell) so it's not a
<a name="line-252"></a>primop.
<a name="line-253"></a>
<a name="line-254"></a>Question: Why @RealWorld@ - won't any instance of @_ST@ do the job? [ADR]
<a name="line-255"></a>
<a name="line-256"></a>Stable Names
<a name="line-257"></a>~~~~~~~~~~~~
<a name="line-258"></a>
<a name="line-259"></a>A stable name is like a stable pointer, but with three important differences:
<a name="line-260"></a>
<a name="line-261"></a>        (a) You can't deRef one to get back to the original object.
<a name="line-262"></a>        (b) You can convert one to an Int.
<a name="line-263"></a>        (c) You don't need to 'freeStableName'
<a name="line-264"></a>
<a name="line-265"></a>The existence of a stable name doesn't guarantee to keep the object it
<a name="line-266"></a>points to alive (unlike a stable pointer), hence (a).
<a name="line-267"></a>
<a name="line-268"></a>Invariants:
<a name="line-269"></a>
<a name="line-270"></a>        (a) makeStableName always returns the same value for a given
<a name="line-271"></a>            object (same as stable pointers).
<a name="line-272"></a>
<a name="line-273"></a>        (b) if two stable names are equal, it implies that the objects
<a name="line-274"></a>            from which they were created were the same.
<a name="line-275"></a>
<a name="line-276"></a>        (c) stableNameToInt always returns the same Int for a given
<a name="line-277"></a>            stable name.
<a name="line-278"></a>
<a name="line-279"></a>
<a name="line-280"></a>These primops are pretty weird.
<a name="line-281"></a>
<a name="line-282"></a>        dataToTag# :: a -&gt; Int    (arg must be an evaluated data type)
<a name="line-283"></a>        tagToEnum# :: Int -&gt; a    (result type must be an enumerated type)
<a name="line-284"></a>
<a name="line-285"></a>The constraints aren't currently checked by the front end, but the
<a name="line-286"></a>code generator will fall over if they aren't satisfied.
<a name="line-287"></a>
<a name="line-288"></a>************************************************************************
<a name="line-289"></a>*                                                                      *
<a name="line-290"></a>            Which PrimOps are out-of-line
<a name="line-291"></a>*                                                                      *
<a name="line-292"></a>************************************************************************
<a name="line-293"></a>
<a name="line-294"></a>Some PrimOps need to be called out-of-line because they either need to
<a name="line-295"></a>perform a heap check or they block.
<a name="line-296"></a>-}</span>
<a name="line-297"></a>
<a name="line-298"></a><a name="primOpOutOfLine"></a><span class='hs-definition'>primOpOutOfLine</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-299"></a><span class='hs-cpp'>#include "primop-out-of-line.hs-incl"</span>
<a name="line-300"></a>
<a name="line-301"></a><span class='hs-comment'>{-
<a name="line-302"></a>************************************************************************
<a name="line-303"></a>*                                                                      *
<a name="line-304"></a>            Failure and side effects
<a name="line-305"></a>*                                                                      *
<a name="line-306"></a>************************************************************************
<a name="line-307"></a>
<a name="line-308"></a>Note [PrimOp can_fail and has_side_effects]
<a name="line-309"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-310"></a>Both can_fail and has_side_effects mean that the primop has
<a name="line-311"></a>some effect that is not captured entirely by its result value.
<a name="line-312"></a>
<a name="line-313"></a>----------  has_side_effects ---------------------
<a name="line-314"></a>A primop "has_side_effects" if it has some *write* effect, visible
<a name="line-315"></a>elsewhere
<a name="line-316"></a>    - writing to the world (I/O)
<a name="line-317"></a>    - writing to a mutable data structure (writeIORef)
<a name="line-318"></a>    - throwing a synchronous Haskell exception
<a name="line-319"></a>
<a name="line-320"></a>Often such primops have a type like
<a name="line-321"></a>   State -&gt; input -&gt; (State, output)
<a name="line-322"></a>so the state token guarantees ordering.  In general we rely *only* on
<a name="line-323"></a>data dependencies of the state token to enforce write-effect ordering
<a name="line-324"></a>
<a name="line-325"></a> * NB1: if you inline unsafePerformIO, you may end up with
<a name="line-326"></a>   side-effecting ops whose 'state' output is discarded.
<a name="line-327"></a>   And programmers may do that by hand; see Trac #9390.
<a name="line-328"></a>   That is why we (conservatively) do not discard write-effecting
<a name="line-329"></a>   primops even if both their state and result is discarded.
<a name="line-330"></a>
<a name="line-331"></a> * NB2: We consider primops, such as raiseIO#, that can raise a
<a name="line-332"></a>   (Haskell) synchronous exception to "have_side_effects" but not
<a name="line-333"></a>   "can_fail".  We must be careful about not discarding such things;
<a name="line-334"></a>   see the paper "A semantics for imprecise exceptions".
<a name="line-335"></a>
<a name="line-336"></a> * NB3: *Read* effects (like reading an IORef) don't count here,
<a name="line-337"></a>   because it doesn't matter if we don't do them, or do them more than
<a name="line-338"></a>   once.  *Sequencing* is maintained by the data dependency of the state
<a name="line-339"></a>   token.
<a name="line-340"></a>
<a name="line-341"></a>----------  can_fail ----------------------------
<a name="line-342"></a>A primop "can_fail" if it can fail with an *unchecked* exception on
<a name="line-343"></a>some elements of its input domain. Main examples:
<a name="line-344"></a>   division (fails on zero demoninator)
<a name="line-345"></a>   array indexing (fails if the index is out of bounds)
<a name="line-346"></a>
<a name="line-347"></a>An "unchecked exception" is one that is an outright error, (not
<a name="line-348"></a>turned into a Haskell exception,) such as seg-fault or
<a name="line-349"></a>divide-by-zero error.  Such can_fail primops are ALWAYS surrounded
<a name="line-350"></a>with a test that checks for the bad cases, but we need to be
<a name="line-351"></a>very careful about code motion that might move it out of
<a name="line-352"></a>the scope of the test.
<a name="line-353"></a>
<a name="line-354"></a>Note [Transformations affected by can_fail and has_side_effects]
<a name="line-355"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-356"></a>The can_fail and has_side_effects properties have the following effect
<a name="line-357"></a>on program transformations.  Summary table is followed by details.
<a name="line-358"></a>
<a name="line-359"></a>            can_fail     has_side_effects
<a name="line-360"></a>Discard        YES           NO
<a name="line-361"></a>Float in       YES           YES
<a name="line-362"></a>Float out      NO            NO
<a name="line-363"></a>Duplicate      YES           NO
<a name="line-364"></a>
<a name="line-365"></a>* Discarding.   case (a `op` b) of _ -&gt; rhs  ===&gt;   rhs
<a name="line-366"></a>  You should not discard a has_side_effects primop; e.g.
<a name="line-367"></a>     case (writeIntArray# a i v s of (# _, _ #) -&gt; True
<a name="line-368"></a>  Arguably you should be able to discard this, since the
<a name="line-369"></a>  returned stat token is not used, but that relies on NEVER
<a name="line-370"></a>  inlining unsafePerformIO, and programmers sometimes write
<a name="line-371"></a>  this kind of stuff by hand (Trac #9390).  So we (conservatively)
<a name="line-372"></a>  never discard a has_side_effects primop.
<a name="line-373"></a>
<a name="line-374"></a>  However, it's fine to discard a can_fail primop.  For example
<a name="line-375"></a>     case (indexIntArray# a i) of _ -&gt; True
<a name="line-376"></a>  We can discard indexIntArray#; it has can_fail, but not
<a name="line-377"></a>  has_side_effects; see Trac #5658 which was all about this.
<a name="line-378"></a>  Notice that indexIntArray# is (in a more general handling of
<a name="line-379"></a>  effects) read effect, but we don't care about that here, and
<a name="line-380"></a>  treat read effects as *not* has_side_effects.
<a name="line-381"></a>
<a name="line-382"></a>  Similarly (a `/#` b) can be discarded.  It can seg-fault or
<a name="line-383"></a>  cause a hardware exception, but not a synchronous Haskell
<a name="line-384"></a>  exception.
<a name="line-385"></a>
<a name="line-386"></a>
<a name="line-387"></a>
<a name="line-388"></a>  Synchronous Haskell exceptions, e.g. from raiseIO#, are treated
<a name="line-389"></a>  as has_side_effects and hence are not discarded.
<a name="line-390"></a>
<a name="line-391"></a>* Float in.  You can float a can_fail or has_side_effects primop
<a name="line-392"></a>  *inwards*, but not inside a lambda (see Duplication below).
<a name="line-393"></a>
<a name="line-394"></a>* Float out.  You must not float a can_fail primop *outwards* lest
<a name="line-395"></a>  you escape the dynamic scope of the test.  Example:
<a name="line-396"></a>      case d &gt;# 0# of
<a name="line-397"></a>        True  -&gt; case x /# d of r -&gt; r +# 1
<a name="line-398"></a>        False -&gt; 0
<a name="line-399"></a>  Here we must not float the case outwards to give
<a name="line-400"></a>      case x/# d of r -&gt;
<a name="line-401"></a>      case d &gt;# 0# of
<a name="line-402"></a>        True  -&gt; r +# 1
<a name="line-403"></a>        False -&gt; 0
<a name="line-404"></a>
<a name="line-405"></a>  Nor can you float out a has_side_effects primop.  For example:
<a name="line-406"></a>       if blah then case writeMutVar# v True s0 of (# s1 #) -&gt; s1
<a name="line-407"></a>               else s0
<a name="line-408"></a>  Notice that s0 is mentioned in both branches of the 'if', but
<a name="line-409"></a>  only one of these two will actually be consumed.  But if we
<a name="line-410"></a>  float out to
<a name="line-411"></a>      case writeMutVar# v True s0 of (# s1 #) -&gt;
<a name="line-412"></a>      if blah then s1 else s0
<a name="line-413"></a>  the writeMutVar will be performed in both branches, which is
<a name="line-414"></a>  utterly wrong.
<a name="line-415"></a>
<a name="line-416"></a>* Duplication.  You cannot duplicate a has_side_effect primop.  You
<a name="line-417"></a>  might wonder how this can occur given the state token threading, but
<a name="line-418"></a>  just look at Control.Monad.ST.Lazy.Imp.strictToLazy!  We get
<a name="line-419"></a>  something like this
<a name="line-420"></a>        p = case readMutVar# s v of
<a name="line-421"></a>              (# s', r #) -&gt; (S# s', r)
<a name="line-422"></a>        s' = case p of (s', r) -&gt; s'
<a name="line-423"></a>        r  = case p of (s', r) -&gt; r
<a name="line-424"></a>
<a name="line-425"></a>  (All these bindings are boxed.)  If we inline p at its two call
<a name="line-426"></a>  sites, we get a catastrophe: because the read is performed once when
<a name="line-427"></a>  s' is demanded, and once when 'r' is demanded, which may be much
<a name="line-428"></a>  later.  Utterly wrong.  Trac #3207 is real example of this happening.
<a name="line-429"></a>
<a name="line-430"></a>  However, it's fine to duplicate a can_fail primop.  That is really
<a name="line-431"></a>  the only difference between can_fail and has_side_effects.
<a name="line-432"></a>
<a name="line-433"></a>Note [Implementation: how can_fail/has_side_effects affect transformations]
<a name="line-434"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-435"></a>How do we ensure that that floating/duplication/discarding are done right
<a name="line-436"></a>in the simplifier?
<a name="line-437"></a>
<a name="line-438"></a>Two main predicates on primpops test these flags:
<a name="line-439"></a>  primOpOkForSideEffects &lt;=&gt; not has_side_effects
<a name="line-440"></a>  primOpOkForSpeculation &lt;=&gt; not (has_side_effects || can_fail)
<a name="line-441"></a>
<a name="line-442"></a>  * The "no-float-out" thing is achieved by ensuring that we never
<a name="line-443"></a>    let-bind a can_fail or has_side_effects primop.  The RHS of a
<a name="line-444"></a>    let-binding (which can float in and out freely) satisfies
<a name="line-445"></a>    exprOkForSpeculation; this is the let/app invariant.  And
<a name="line-446"></a>    exprOkForSpeculation is false of can_fail and has_side_effects.
<a name="line-447"></a>
<a name="line-448"></a>  * So can_fail and has_side_effects primops will appear only as the
<a name="line-449"></a>    scrutinees of cases, and that's why the FloatIn pass is capable
<a name="line-450"></a>    of floating case bindings inwards.
<a name="line-451"></a>
<a name="line-452"></a>  * The no-duplicate thing is done via primOpIsCheap, by making
<a name="line-453"></a>    has_side_effects things (very very very) not-cheap!
<a name="line-454"></a>-}</span>
<a name="line-455"></a>
<a name="line-456"></a><a name="primOpHasSideEffects"></a><span class='hs-definition'>primOpHasSideEffects</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-457"></a><span class='hs-cpp'>#include "primop-has-side-effects.hs-incl"</span>
<a name="line-458"></a>
<a name="line-459"></a><a name="primOpCanFail"></a><span class='hs-definition'>primOpCanFail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-460"></a><span class='hs-cpp'>#include "primop-can-fail.hs-incl"</span>
<a name="line-461"></a>
<a name="line-462"></a><a name="primOpOkForSpeculation"></a><span class='hs-definition'>primOpOkForSpeculation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-463"></a>  <span class='hs-comment'>-- See Note [PrimOp can_fail and has_side_effects]</span>
<a name="line-464"></a>  <span class='hs-comment'>-- See comments with CoreUtils.exprOkForSpeculation</span>
<a name="line-465"></a>  <span class='hs-comment'>-- primOpOkForSpeculation =&gt; primOpOkForSideEffects</span>
<a name="line-466"></a><span class='hs-definition'>primOpOkForSpeculation</span> <span class='hs-varid'>op</span>
<a name="line-467"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>primOpOkForSideEffects</span> <span class='hs-varid'>op</span>
<a name="line-468"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOutOfLine</span> <span class='hs-varid'>op</span> <span class='hs-varop'>||</span> <span class='hs-varid'>primOpCanFail</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-469"></a>    <span class='hs-comment'>-- I think the "out of line" test is because out of line things can</span>
<a name="line-470"></a>    <span class='hs-comment'>-- be expensive (eg sine, cosine), and so we may not want to speculate them</span>
<a name="line-471"></a>
<a name="line-472"></a><a name="primOpOkForSideEffects"></a><span class='hs-definition'>primOpOkForSideEffects</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-473"></a><span class='hs-definition'>primOpOkForSideEffects</span> <span class='hs-varid'>op</span>
<a name="line-474"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpHasSideEffects</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-475"></a>
<a name="line-476"></a><span class='hs-comment'>{-
<a name="line-477"></a>Note [primOpIsCheap]
<a name="line-478"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-479"></a>@primOpIsCheap@, as used in \tr{SimplUtils.hs}.  For now (HACK
<a name="line-480"></a>WARNING), we just borrow some other predicates for a
<a name="line-481"></a>what-should-be-good-enough test.  "Cheap" means willing to call it more
<a name="line-482"></a>than once, and/or push it inside a lambda.  The latter could change the
<a name="line-483"></a>behaviour of 'seq' for primops that can fail, so we don't treat them as cheap.
<a name="line-484"></a>-}</span>
<a name="line-485"></a>
<a name="line-486"></a><a name="primOpIsCheap"></a><span class='hs-definition'>primOpIsCheap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-487"></a><span class='hs-comment'>-- See Note [PrimOp can_fail and has_side_effects]</span>
<a name="line-488"></a><span class='hs-definition'>primOpIsCheap</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primOpOkForSpeculation</span> <span class='hs-varid'>op</span>
<a name="line-489"></a><span class='hs-comment'>-- In March 2001, we changed this to</span>
<a name="line-490"></a><span class='hs-comment'>--      primOpIsCheap op = False</span>
<a name="line-491"></a><span class='hs-comment'>-- thereby making *no* primops seem cheap.  But this killed eta</span>
<a name="line-492"></a><span class='hs-comment'>-- expansion on case (x ==# y) of True -&gt; \s -&gt; ...</span>
<a name="line-493"></a><span class='hs-comment'>-- which is bad.  In particular a loop like</span>
<a name="line-494"></a><span class='hs-comment'>--      doLoop n = loop 0</span>
<a name="line-495"></a><span class='hs-comment'>--     where</span>
<a name="line-496"></a><span class='hs-comment'>--         loop i | i == n    = return ()</span>
<a name="line-497"></a><span class='hs-comment'>--                | otherwise = bar i &gt;&gt; loop (i+1)</span>
<a name="line-498"></a><span class='hs-comment'>-- allocated a closure every time round because it doesn't eta expand.</span>
<a name="line-499"></a><span class='hs-comment'>--</span>
<a name="line-500"></a><span class='hs-comment'>-- The problem that originally gave rise to the change was</span>
<a name="line-501"></a><span class='hs-comment'>--      let x = a +# b *# c in x +# x</span>
<a name="line-502"></a><span class='hs-comment'>-- were we don't want to inline x. But primopIsCheap doesn't control</span>
<a name="line-503"></a><span class='hs-comment'>-- that (it's exprIsDupable that does) so the problem doesn't occur</span>
<a name="line-504"></a><span class='hs-comment'>-- even if primOpIsCheap sometimes says 'True'.</span>
<a name="line-505"></a>
<a name="line-506"></a><span class='hs-comment'>{-
<a name="line-507"></a>************************************************************************
<a name="line-508"></a>*                                                                      *
<a name="line-509"></a>               PrimOp code size
<a name="line-510"></a>*                                                                      *
<a name="line-511"></a>************************************************************************
<a name="line-512"></a>
<a name="line-513"></a>primOpCodeSize
<a name="line-514"></a>~~~~~~~~~~~~~~
<a name="line-515"></a>Gives an indication of the code size of a primop, for the purposes of
<a name="line-516"></a>calculating unfolding sizes; see CoreUnfold.sizeExpr.
<a name="line-517"></a>-}</span>
<a name="line-518"></a>
<a name="line-519"></a><a name="primOpCodeSize"></a><span class='hs-definition'>primOpCodeSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-520"></a><span class='hs-cpp'>#include "primop-code-size.hs-incl"</span>
<a name="line-521"></a>
<a name="line-522"></a><a name="primOpCodeSizeDefault"></a><span class='hs-definition'>primOpCodeSizeDefault</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-523"></a><span class='hs-definition'>primOpCodeSizeDefault</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-524"></a>  <span class='hs-comment'>-- CoreUnfold.primOpSize already takes into account primOpOutOfLine</span>
<a name="line-525"></a>  <span class='hs-comment'>-- and adds some further costs for the args in that case.</span>
<a name="line-526"></a>
<a name="line-527"></a><a name="primOpCodeSizeForeignCall"></a><span class='hs-definition'>primOpCodeSizeForeignCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-528"></a><span class='hs-definition'>primOpCodeSizeForeignCall</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>4</span>
<a name="line-529"></a>
<a name="line-530"></a><span class='hs-comment'>{-
<a name="line-531"></a>************************************************************************
<a name="line-532"></a>*                                                                      *
<a name="line-533"></a>               PrimOp types
<a name="line-534"></a>*                                                                      *
<a name="line-535"></a>************************************************************************
<a name="line-536"></a>-}</span>
<a name="line-537"></a>
<a name="line-538"></a><a name="primOpType"></a><span class='hs-definition'>primOpType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>  <span class='hs-comment'>-- you may want to use primOpSig instead</span>
<a name="line-539"></a><span class='hs-definition'>primOpType</span> <span class='hs-varid'>op</span>
<a name="line-540"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-541"></a>    <span class='hs-conid'>Dyadic</span>  <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dyadic_fun_ty</span> <span class='hs-varid'>ty</span>
<a name="line-542"></a>    <span class='hs-conid'>Monadic</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>monadic_fun_ty</span> <span class='hs-varid'>ty</span>
<a name="line-543"></a>    <span class='hs-conid'>Compare</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>compare_fun_ty</span> <span class='hs-varid'>ty</span>
<a name="line-544"></a>
<a name="line-545"></a>    <span class='hs-conid'>GenPrimOp</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-546"></a>        <span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-547"></a>
<a name="line-548"></a><a name="primOpOcc"></a><span class='hs-definition'>primOpOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-549"></a><span class='hs-definition'>primOpOcc</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-550"></a>               <span class='hs-conid'>Dyadic</span>    <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-551"></a>               <span class='hs-conid'>Monadic</span>   <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-552"></a>               <span class='hs-conid'>Compare</span>   <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-553"></a>               <span class='hs-conid'>GenPrimOp</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-554"></a>
<a name="line-555"></a><span class='hs-comment'>-- primOpSig is like primOpType but gives the result split apart:</span>
<a name="line-556"></a><span class='hs-comment'>-- (type variables, argument types, result type)</span>
<a name="line-557"></a><span class='hs-comment'>-- It also gives arity, strictness info</span>
<a name="line-558"></a>
<a name="line-559"></a><a name="primOpSig"></a><span class='hs-definition'>primOpSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>StrictSig</span><span class='hs-layout'>)</span>
<a name="line-560"></a><span class='hs-definition'>primOpSig</span> <span class='hs-varid'>op</span>
<a name="line-561"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arity</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpStrictness</span> <span class='hs-varid'>op</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-562"></a>  <span class='hs-keyword'>where</span>
<a name="line-563"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span>
<a name="line-564"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-565"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-566"></a>        <span class='hs-conid'>Monadic</span>   <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    <span class='hs-varid'>ty</span>       <span class='hs-layout'>)</span>
<a name="line-567"></a>        <span class='hs-conid'>Dyadic</span>    <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span>       <span class='hs-layout'>)</span>
<a name="line-568"></a>        <span class='hs-conid'>Compare</span>   <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>intPrimTy</span><span class='hs-layout'>)</span>
<a name="line-569"></a>        <span class='hs-conid'>GenPrimOp</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span>   <span class='hs-layout'>)</span>
<a name="line-570"></a>
<a name="line-571"></a><a name="PrimOpResultInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimOpResultInfo</span>
<a name="line-572"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReturnsPrim</span>     <span class='hs-conid'>PrimRep</span>
<a name="line-573"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ReturnsAlg</span>      <span class='hs-conid'>TyCon</span>
<a name="line-574"></a>
<a name="line-575"></a><span class='hs-comment'>-- Some PrimOps need not return a manifest primitive or algebraic value</span>
<a name="line-576"></a><span class='hs-comment'>-- (i.e. they might return a polymorphic value).  These PrimOps *must*</span>
<a name="line-577"></a><span class='hs-comment'>-- be out of line, or the code generator won't work.</span>
<a name="line-578"></a>
<a name="line-579"></a><a name="getPrimOpResultInfo"></a><span class='hs-definition'>getPrimOpResultInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpResultInfo</span>
<a name="line-580"></a><span class='hs-definition'>getPrimOpResultInfo</span> <span class='hs-varid'>op</span>
<a name="line-581"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-582"></a>      <span class='hs-conid'>Dyadic</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>typePrimRep1</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-583"></a>      <span class='hs-conid'>Monadic</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>typePrimRep1</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-584"></a>      <span class='hs-conid'>Compare</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConPrimRep1</span> <span class='hs-varid'>intPrimTyCon</span><span class='hs-layout'>)</span>
<a name="line-585"></a>      <span class='hs-conid'>GenPrimOp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConPrimRep1</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-586"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsAlg</span> <span class='hs-varid'>tc</span>
<a name="line-587"></a>                         <span class='hs-keyword'>where</span>
<a name="line-588"></a>                           <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-varid'>ty</span>
<a name="line-589"></a>                        <span class='hs-comment'>-- All primops return a tycon-app result</span>
<a name="line-590"></a>                        <span class='hs-comment'>-- The tycon can be an unboxed tuple or sum, though,</span>
<a name="line-591"></a>                        <span class='hs-comment'>-- which gives rise to a ReturnAlg</span>
<a name="line-592"></a>
<a name="line-593"></a><span class='hs-comment'>{-
<a name="line-594"></a>We do not currently make use of whether primops are commutable.
<a name="line-595"></a>
<a name="line-596"></a>We used to try to move constants to the right hand side for strength
<a name="line-597"></a>reduction.
<a name="line-598"></a>-}</span>
<a name="line-599"></a>
<a name="line-600"></a><span class='hs-comment'>{-
<a name="line-601"></a>commutableOp :: PrimOp -&gt; Bool
<a name="line-602"></a>#include "primop-commutable.hs-incl"
<a name="line-603"></a>-}</span>
<a name="line-604"></a>
<a name="line-605"></a><span class='hs-comment'>-- Utils:</span>
<a name="line-606"></a>
<a name="line-607"></a><a name="dyadic_fun_ty"></a><span class='hs-definition'>dyadic_fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>monadic_fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>compare_fun_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-608"></a><span class='hs-definition'>dyadic_fun_ty</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ty</span>
<a name="line-609"></a><a name="monadic_fun_ty"></a><span class='hs-definition'>monadic_fun_ty</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTy</span>  <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-610"></a><a name="compare_fun_ty"></a><span class='hs-definition'>compare_fun_ty</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>intPrimTy</span>
<a name="line-611"></a>
<a name="line-612"></a><span class='hs-comment'>-- Output stuff:</span>
<a name="line-613"></a>
<a name="line-614"></a><a name="pprPrimOp"></a><span class='hs-definition'>pprPrimOp</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-615"></a><span class='hs-definition'>pprPrimOp</span> <span class='hs-varid'>other_op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOcc</span> <span class='hs-varid'>other_op</span><span class='hs-layout'>)</span>
<a name="line-616"></a>
<a name="line-617"></a><span class='hs-comment'>{-
<a name="line-618"></a>************************************************************************
<a name="line-619"></a>*                                                                      *
<a name="line-620"></a>\subsubsection[PrimCall]{User-imported primitive calls}
<a name="line-621"></a>*                                                                      *
<a name="line-622"></a>************************************************************************
<a name="line-623"></a>-}</span>
<a name="line-624"></a>
<a name="line-625"></a><a name="PrimCall"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimCall</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PrimCall</span> <span class='hs-conid'>CLabelString</span> <span class='hs-conid'>UnitId</span>
<a name="line-626"></a>
<a name="line-627"></a><a name="instance%20Outputable%20PrimCall"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PrimCall</span> <span class='hs-keyword'>where</span>
<a name="line-628"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimCall</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>pkgId</span><span class='hs-layout'>)</span>
<a name="line-629"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"__primcall"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pkgId</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>lbl</span>
</pre></body>
</html>
